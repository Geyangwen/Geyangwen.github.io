<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="标签: Linux, 小文同学">
    <meta name="description" content="你的征途是星辰大海，怎么能被眼前的挫折打败。">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>标签: Linux | 小文同学</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="小文同学" type="application/atom+xml">
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="./images/loading.gif" data-original="https://blog-accelerated.oss-cn-hangzhou.aliyuncs.com/source/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">小文同学</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">

      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a target="_blank" rel="noopener" href="https://www.kugou.com/">
          
          <i class="fas fa-music" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>酷狗音乐</span>
        </a>
      </li>
      
      <li>
        <a target="_blank" rel="noopener" href="https://search.bilibili.com/">
          
          <i class="fas fa-film" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>哔哩哔哩</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="./images/loading.gif" data-original="https://blog-accelerated.oss-cn-hangzhou.aliyuncs.com/source/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">小文同学</div>
        <div class="logo-desc">
            
            你的征途是星辰大海，怎么能被眼前的挫折打败。
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-address-book"></i>
			
			友情链接
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a target="_blank" rel="noopener" href="https://www.kugou.com/ " style="margin-left:75px">
				  
				   <i class="fa fas fa-music" style="position: absolute;left:50px" ></i>
			      
		          <span>酷狗音乐</span>
                  </a>
                </li>
              
                <li>

                  <a target="_blank" rel="noopener" href="https://search.bilibili.com/ " style="margin-left:75px">
				  
				   <i class="fa fas fa-film" style="position: absolute;left:50px" ></i>
			      
		          <span>哔哩哔哩</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/Geyangwen/Geyangwen.github.io" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/Geyangwen/Geyangwen.github.io" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('https://blog-accelerated.oss-cn-hangzhou.aliyuncs.com/source/medias/featureimages/13.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">WebServer学习笔记</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Linux%E6%9C%8D%E5%8A%A1%E5%99%A8/">
                                <span class="chip bg-color">Linux服务器</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Linux/" class="post-category">
                                Linux
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2023-02-10
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    36.9k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    146 分
                </div>
                

                
                    <span id="busuanzi_container_site_pv" style='display:none'></span>
                    <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                    <span id="busuanzi_value_page_pv" ></span>
            
            
            
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <blockquote>
<p>Linux下C++轻量级Web服务器配套详解。<br>原文链接：<br><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzAxNzU2MzcwMw==&amp;action=getalbum&amp;album_id=1339230165934882817&amp;scene=173&amp;from_msgid=2649274431&amp;from_itemidx=1&amp;count=3&amp;nolastread=1#wechat_redirect">https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzAxNzU2MzcwMw==&amp;action=getalbum&amp;album_id=1339230165934882817&amp;scene=173&amp;from_msgid=2649274431&amp;from_itemidx=1&amp;count=3&amp;nolastread=1#wechat_redirect</a></p>
</blockquote>
<h1 id="WebServer学习笔记"><a href="#WebServer学习笔记" class="headerlink" title="WebServer学习笔记"></a>WebServer学习笔记</h1><h2 id="00-改进"><a href="#00-改进" class="headerlink" title="00 改进"></a>00 改进</h2><ul>
<li>1.配置文件的解析改用json文件，相比于原来更加简单方便。</li>
<li>2.write文件的操作由mmap改用sendfile实现真正的零拷贝。</li>
<li>3.定时器容器设计为最小堆。</li>
<li>4.如果数据库太大怎么办（使用布隆过滤器，使用多级哈希）</li>
</ul>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2023/cpp/image-20230412112513276.png" alt="image-20230412112513276"></p>
<h3 id="服务器编程基本框架"><a href="#服务器编程基本框架" class="headerlink" title="服务器编程基本框架"></a>服务器编程基本框架</h3><p><a target="_blank" rel="noopener" href="https://huixxi.github.io/2020/06/02/%E5%B0%8F%E7%99%BD%E8%A7%86%E8%A7%92%EF%BC%9A%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%E7%A4%BE%E9%95%BF%E7%9A%84TinyWebServer/#more">https://huixxi.github.io/2020/06/02/%E5%B0%8F%E7%99%BD%E8%A7%86%E8%A7%92%EF%BC%9A%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82%E7%A4%BE%E9%95%BF%E7%9A%84TinyWebServer/#more</a></p>
<p>虽然服务器程序种类繁多，但其基本框架都一样，不同之处在于逻辑处理。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2023/cpp/image-20230221105308819.png" alt="image-20230221105308819"></p>
<table>
<thead>
<tr>
<th>模块</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>I/O 处理单元</td>
<td>处理客户连接，读写网络数据</td>
</tr>
<tr>
<td>逻辑单元</td>
<td>业务进程或线程（一般一个线程去处理一个客户的请求）</td>
</tr>
<tr>
<td>网络存储单元</td>
<td>数据库、文件或缓存</td>
</tr>
<tr>
<td>请求队列</td>
<td>各单元之间的通信方式</td>
</tr>
</tbody></table>
<p><strong>I/O 处理单元是服务器管理客户连接的模块</strong>。它通常要完成以下工作：<strong>等待并接受新的客户连接，接收客户数据，将服务器响应数据返回给客户端</strong>。但是数据的收发不一定在 I/O 处理单元中执行，也可能在逻辑单元中执行，具体在何处执行取决于事件处理模式。</p>
<p><strong>一个逻辑单元通常是一个进程或线程</strong>。它分析并处理客户数据，然后将结果传递给 I/O 处理单元或者直接发送给客户端（具体使用哪种方式取决于事件处理模式）。服务器通常拥有多个逻辑单元，以实现对多个客户任务的并发处理。</p>
<p><strong>网络存储单元可以是数据库、缓存和文件，但不是必须的</strong>。</p>
<p><strong>请求队列是各单元之间的通信方式的抽象</strong>。I/O 处理单元接收到客户请求时，需要以某种方式通知一个逻辑单元来处理该请求。同样，<strong>多个逻辑单元同时访问一个存储单元时，也需要采用某种机制来协调处理竞态条件。请求队列通常被实现为池的一部分</strong>。</p>
<h2 id="01-线程同步机制封装类"><a href="#01-线程同步机制封装类" class="headerlink" title="01 线程同步机制封装类"></a>01 线程同步机制封装类</h2><h3 id="1-1-RAII"><a href="#1-1-RAII" class="headerlink" title="1.1 RAII"></a>1.1 RAII</h3><ul>
<li>RAII全称是“Resource Acquisition is Initialization”，直译过来是“<strong>资源获取即初始化</strong>”.</li>
<li>在构造函数中申请分配资源，在析构函数中释放资源。因为C++的语言机制保证了，<strong>当一个对象创建的时候，自动调用构造函数，当对象超出作用域的时候会自动调用析构函数</strong>。所以，在RAII的指导下，我们应该使用类来管理资源，将资源和对象的生命周期绑定</li>
<li>RAII的核心思想是<strong>将资源或者状态与对象的生命周期绑定</strong>，通过C++的语言机制，实现资源和状态的安全管理,<strong>智能指针是RAII最好的例子</strong></li>
</ul>
<h3 id="1-2-信号量"><a href="#1-2-信号量" class="headerlink" title="1.2 信号量"></a>1.2 信号量</h3><p>信号量是一种特殊的变量，它只能取自然数值并且只支持两种操作：等待(P)和信号(V).假设有信号量SV，对其的P、V操作如下：</p>
<p>信号量的取值可以是任何自然数，最常用的，最简单的信号量是二进制信号量，只有0和1两个值.</p>
<blockquote>
<ul>
<li><code>sem_init</code>函数用于初始化一个未命名的信号量</li>
<li><code>sem_destory</code>函数用于销毁信号量</li>
<li><code>sem_wait</code>函数将以<strong>原子操作方式将信号量减一</strong>,信号量为0时,<code>sem_wait</code>阻塞</li>
<li><code>sem_post</code>函数以<strong>原子操作方式将信号量加一</strong>,信号量大于0时,唤醒调用<code>sem_post</code>的线程</li>
</ul>
</blockquote>
<p>以上，成功返回0，失败返回errno</p>
<h3 id="1-3-条件变量"><a href="#1-3-条件变量" class="headerlink" title="1.3 条件变量"></a>1.3 条件变量</h3><p>条件变量提供了一种线程间的通知机制,当某个共享数据达到某个值时,唤醒等待这个共享数据的线程.</p>
<blockquote>
<ul>
<li><code>pthread_cond_init</code>函数用于初始化条件变量</li>
<li><code>pthread_cond_destory</code>函数销毁条件变量</li>
<li><code>pthread_cond_broadcast</code>函数以广播的方式唤醒<strong>所有</strong>等待目标条件变量的线程</li>
<li><code>pthread_cond_wait</code>函数用于等待目标条件变量.该函数调用时需要传入 <strong>mutex参数(加锁的互斥锁)</strong> ,函数执行时,先把调用线程放入条件变量的请求队列,然后将互斥锁mutex解锁,当函数成功返回为0时,互斥锁会再次被锁上. <strong>也就是说函数内部会有一次解锁和加锁操作</strong>.</li>
</ul>
</blockquote>
<h3 id="1-4-锁机制"><a href="#1-4-锁机制" class="headerlink" title="1.4 锁机制"></a>1.4 锁机制</h3><ul>
<li>实现多线程同步，通过锁机制，确保任一时刻只能有一个线程能进入关键代码段.</li>
</ul>
<h3 id="1-5-封装"><a href="#1-5-封装" class="headerlink" title="1.5 封装"></a>1.5 封装</h3><ul>
<li>类中主要是Linux下三种锁进行封装，将锁的创建于销毁函数封装在类的构造与析构函数中，实现RAII机制</li>
</ul>
<h3 id="1-6-locker-h代码"><a href="#1-6-locker-h代码" class="headerlink" title="1.6 locker.h代码"></a>1.6 locker.h代码</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">LOCKER_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LOCKER_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;exception&gt;</span>	<span class="token comment">//异常</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span>	<span class="token comment">//线程，锁</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;semaphore.h&gt;</span>	<span class="token comment">//信号量</span></span>

<span class="token comment">//信号量类</span>
<span class="token keyword">class</span> <span class="token class-name">sem</span><span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">sem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>          <span class="token comment">//默认构造函数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sem_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_sem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> std<span class="token double-colon punctuation">::</span><span class="token function">exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">sem</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span><span class="token punctuation">{</span>   <span class="token comment">//含参构造函数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sem_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_sem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> std<span class="token double-colon punctuation">::</span><span class="token function">exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">sem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>         <span class="token comment">//析构函数</span>
        <span class="token function">sem_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">bool</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">//从信号量的值减去一个“1”，但它永远会先等待该信号量为一个非零值（大于0）才开始做减法。</span>
        <span class="token keyword">return</span> <span class="token function">sem_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_sem<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">bool</span> <span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">//功能：它的作用来增加信号量的值。给信号量加1</span>
        <span class="token keyword">return</span> <span class="token function">sem_post</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_sem<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    sem_t m_sem<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//互斥锁类</span>
<span class="token keyword">class</span> <span class="token class-name">locker</span><span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">locker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>   <span class="token comment">//默认构造函数，初始化互斥锁</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_mutex<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> std<span class="token double-colon punctuation">::</span><span class="token function">exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">locker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment">//默认析构函数，释放互斥锁</span>
        <span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">bool</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//加锁</span>
        <span class="token keyword">return</span> <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_mutex<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">bool</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//解锁</span>
        <span class="token keyword">return</span> <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_mutex<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    pthread_mutex_t <span class="token operator">*</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//获取指向该锁地址的指针</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>m_mutex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    pthread_mutex_t m_mutex<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//条件变量类. 条件变量不是锁，可以由某个条件阻塞/解除阻塞线程</span>
<span class="token keyword">class</span> <span class="token class-name">cond</span><span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">cond</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pthread_cond_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_cond<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//pthread_mutex_destroy(&amp;m_mutex);</span>
            <span class="token keyword">throw</span> std<span class="token double-colon punctuation">::</span><span class="token function">exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token operator">~</span><span class="token function">cond</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">pthread_cond_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_cond<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">bool</span> <span class="token function">wait</span><span class="token punctuation">(</span>pthread_mutex_t <span class="token operator">*</span>m_mutex<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//等待，调用了该函数，线程会阻塞.调用线程必须锁定mutex，否则会产生未定义行为。</span>
        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">//pthread_mutex_lock(&amp;m_mutex);</span>
        ret <span class="token operator">=</span> <span class="token function">pthread_cond_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_cond<span class="token punctuation">,</span> m_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//当这个函数调用阻塞的时候，会对互斥锁进行解锁，当不阻塞的，继续向下执行，会重新加锁。</span>
        <span class="token comment">//pthread_mutex_unlock(&amp;m_mutex);</span>
        <span class="token keyword">return</span> ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//等待多长时间，调用了该函数，线程会阻塞.调用线程必须锁定mutex，否则会产生未定义行为。</span>
    <span class="token keyword">bool</span> <span class="token function">timewait</span><span class="token punctuation">(</span>pthread_mutex_t <span class="token operator">*</span>m_mutex<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">timespec</span> t<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">//pthread_mutex_lock(&amp;m_mutex);</span>
        ret <span class="token operator">=</span> <span class="token function">pthread_cond_timedwait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_cond<span class="token punctuation">,</span> m_mutex<span class="token punctuation">,</span> <span class="token operator">&amp;</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//pthread_mutex_unlock(&amp;m_mutex);</span>
        <span class="token keyword">return</span> ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">bool</span> <span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//唤醒一个或者多个等待的线程</span>
        <span class="token keyword">return</span> <span class="token function">pthread_cond_signal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_cond<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">bool</span> <span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//唤醒所有的等待的线程</span>
        <span class="token keyword">return</span> <span class="token function">pthread_cond_broadcast</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_cond<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token comment">//static pthread_mutex_t m_mutex;</span>
    pthread_cond_t m_cond<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="02-半同步-x2F-半反应堆线程池"><a href="#02-半同步-x2F-半反应堆线程池" class="headerlink" title="02 半同步/半反应堆线程池"></a>02 半同步/半反应堆线程池</h2><h3 id="2-1-五种I-x2F-O模型"><a href="#2-1-五种I-x2F-O模型" class="headerlink" title="2.1 五种I/O模型"></a>2.1 五种I/O模型</h3><ul>
<li><strong>阻塞IO</strong>:调用者调用了某个函数，等待这个函数返回，期间什么也不做，不停的去检查这个函数有没有返回，必须等这个函数返回才能进行下一步动作</li>
<li><strong>非阻塞IO</strong>:非阻塞等待，每隔一段时间就去检测IO事件是否就绪。没有就绪就可以做其他事。非阻塞I/O执行系统调用总是立即返回，不管时间是否已经发生，若时间没有发生，则返回-1，此时可以根据errno区分这两种情况，对于accept，recv和send，事件未发生时，errno通常被设置成eagain</li>
<li><strong>信号驱动IO</strong>:linux用套接口进行信号驱动IO，安装一个信号处理函数，进程继续运行并不阻塞，当IO时间就绪，进程收到SIGIO信号。然后处理IO事件。</li>
<li><strong>IO复用</strong>:linux用select/poll函数实现IO复用模型，这两个函数也会使进程阻塞，但是和阻塞IO所不同的是这两个函数可以同时阻塞多个IO操作。而且可以同时对多个读操作、写操作的IO函数进行检测。知道有数据可读或可写时，才真正调用IO操作函数</li>
<li><strong>异步IO</strong>:linux中，可以调用aio_read函数告诉内核描述字缓冲区指针和缓冲区的大小、文件偏移及通知的方式，然后立即返回，当内核将数据拷贝到缓冲区后，再通知应用程序。</li>
</ul>
<p><strong>注意：阻塞I/O，非阻塞I/O，信号驱动I/O和I/O复用都是同步I/O。同步I/O指内核向应用程序通知的是就绪事件，比如只通知有客户端连接，要求用户代码自行执行I/O操作，异步I/O是指内核向应用程序通知的是完成事件，比如读取客户端的数据后才通知应用程序，由内核完成I/O操作。</strong></p>
<h3 id="2-2-事件处理模式"><a href="#2-2-事件处理模式" class="headerlink" title="2.2 事件处理模式"></a>2.2 事件处理模式</h3><ul>
<li><p><strong>reactor模式中</strong>，主线程(<strong>I/O处理单元</strong>)只负责监听文件描述符上是否有事件发生，有的话立即通知工作线程(<strong>逻辑单元</strong> )，读写数据、接受新连接及处理客户请求均在工作线程中完成。通常由<strong>同步I/O</strong>实现。</p>
</li>
<li><p><strong>proactor模式中</strong>，主线程和内核负责处理读写数据、接受新连接等I/O操作，工作线程仅负责业务逻辑，如处理客户请求。通常由<strong>异步I/O</strong>实现。</p>
</li>
<li><p><strong>同步I/O模拟proactor模式</strong></p>
<p>  由于异步I/O并不成熟，实际中使用较少，这里将使用同步I/O模拟实现proactor模式。</p>
<p>  同步I/O模型的工作流程如下（epoll_wait为例）：</p>
<blockquote>
<ul>
<li>主线程往epoll内核事件表注册socket上的读就绪事件。</li>
<li>主线程调用epoll_wait等待socket上有数据可读</li>
<li>当socket上有数据可读，epoll_wait通知主线程,主线程从socket循环读取数据，直到没有更多数据可读，然后将读取到的数据封装成一个请求对象并插入请求队列。</li>
<li>睡眠在请求队列上某个工作线程被唤醒，它获得请求对象并处理客户请求，然后往epoll内核事件表中注册该socket上的写就绪事件</li>
<li>主线程调用epoll_wait等待socket可写。</li>
<li>当socket上有数据可写，epoll_wait通知主线程。主线程往socket上写入服务器处理客户请求的结果。</li>
</ul>
</blockquote>
</li>
</ul>
<h3 id="2-3-并发编程模式"><a href="#2-3-并发编程模式" class="headerlink" title="2.3 并发编程模式"></a>2.3 并发编程模式</h3><p>并发编程方法的实现有<strong>多线程和多进程</strong>两种，但这里涉及的<strong>并发模式指I/O处理单元与逻辑单元的协同完成任务的方法</strong>。</p>
<ul>
<li>半同步/半异步模式</li>
<li>领导者/追随者模式</li>
</ul>
<h3 id="2-4-半同步-x2F-半反应堆"><a href="#2-4-半同步-x2F-半反应堆" class="headerlink" title="2.4 半同步/半反应堆"></a>2.4 半同步/半反应堆</h3><p>半同步/半反应堆并发模式是半同步/半异步的变体，将半异步具体化为某种事件处理模式.</p>
<p>并发模式中的同步和异步</p>
<blockquote>
<ul>
<li>同步指的是程序完全按照代码序列的顺序执行</li>
<li>异步指的是程序的执行需要由系统事件驱动</li>
</ul>
</blockquote>
<p>半同步/半异步模式工作流程</p>
<blockquote>
<ul>
<li>同步线程用于处理客户逻辑</li>
<li>异步线程用于处理I/O事件</li>
<li>异步线程监听到客户请求后，就将其封装成请求对象并插入请求队列中</li>
<li>请求队列将通知某个工作在<strong>同步模式的工作线程</strong>来读取并处理该请求对象</li>
</ul>
</blockquote>
<p>半同步/半反应堆工作流程（以Proactor模式为例）</p>
<blockquote>
<ul>
<li>主线程充当异步线程，负责监听所有socket上的事件</li>
<li>若有新请求到来，主线程接收之以得到新的连接socket，然后往epoll内核事件表中注册该socket上的读写事件</li>
<li>如果连接socket上有读写事件发生，主线程从socket上接收数据，并将数据封装成请求对象插入到请求队列中</li>
<li>所有工作线程睡眠在请求队列上，当有任务到来时，通过竞争（如互斥锁）获得任务的接管权</li>
</ul>
</blockquote>
<h3 id="2-4-线程池"><a href="#2-4-线程池" class="headerlink" title="2.4 线程池"></a>2.4 线程池</h3><ul>
<li>空间换时间,浪费服务器的硬件资源,换取运行效率.</li>
<li>池是一组资源的集合,这组资源在服务器启动之初就被完全创建好并初始化,这称为静态资源.</li>
<li>当服务器进入正式运行阶段,开始处理客户请求的时候,如果它需要相关的资源,可以直接从池中获取,无需动态分配.</li>
<li>当服务器处理完一个客户连接后,可以把相关的资源放回池中,无需执行系统调用释放资源.</li>
</ul>
<h3 id="2-5-基础知识"><a href="#2-5-基础知识" class="headerlink" title="2.5 基础知识"></a>2.5 基础知识</h3><h4 id="2-5-1-静态成员变量"><a href="#2-5-1-静态成员变量" class="headerlink" title="2.5.1 静态成员变量"></a>2.5.1 静态成员变量</h4><p>将类成员变量声明为static，则为静态成员变量，与一般的成员变量不同，<strong>无论建立多少对象，都只有一个静态成员变量的拷贝</strong>，<strong>静态成员变量属于一个类，所有对象共享</strong>。</p>
<p>静态变量在编译阶段就分配了空间，对象还没创建时就已经分配了空间，放到全局静态区。</p>
<ul>
<li><p>静态成员变量</p>
</li>
<li><ul>
<li>最好是类内声明，类外初始化（以免类名访问静态成员访问不到）。<ul>
<li>无论公有，私有，静态成员都可以在类外定义，但私有成员仍有访问权限。</li>
<li>非静态成员类外不能初始化。</li>
<li>静态成员数据是共享的。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="2-5-2-静态成员函数"><a href="#2-5-2-静态成员函数" class="headerlink" title="2.5.2 静态成员函数"></a>2.5.2 静态成员函数</h4><p>将类成员函数声明为static，则为静态成员函数。</p>
<ul>
<li><p>静态成员函数</p>
</li>
<li><ul>
<li>静态成员函数可以直接访问静态成员变量，不能直接访问普通成员变量，但可以通过参数传递的方式访问。<ul>
<li>普通成员函数可以访问普通成员变量，也可以访问静态成员变量。</li>
<li>静态成员函数没有this指针。非静态数据成员为对象单独维护，但静态成员函数为共享函数，无法区分是哪个对象，因此不能直接访问普通变量成员，也没有this指针。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="2-5-3-pthread-create陷阱"><a href="#2-5-3-pthread-create陷阱" class="headerlink" title="2.5.3 pthread_create陷阱"></a>2.5.3 pthread_create陷阱</h4><p>首先看一下该函数的函数原型。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token number">1</span>#include <span class="token operator">&lt;</span>pthread<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
<span class="token number">2</span>int <span class="token function">pthread_create</span> <span class="token punctuation">(</span>pthread_t <span class="token operator">*</span>thread_tid<span class="token punctuation">,</span>                 <span class="token comment">//返回新生成的线程的id</span>
<span class="token number">3</span>                    <span class="token keyword">const</span> pthread_attr_t <span class="token operator">*</span>attr<span class="token punctuation">,</span>         <span class="token comment">//指向线程属性的指针,通常设置为NULL</span>
<span class="token number">4</span>                    <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span>start_routine<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">//处理线程函数的地址</span>
<span class="token number">5</span>                    <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token comment">//start_routine()中的参数</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>函数原型中的第三个参数，为函数指针，指向处理线程函数的地址。该函数，要求为静态函数。如果处理线程函数为类成员函数时，需要将其设置为<strong>静态成员函数</strong>。</p>
<h4 id="2-5-4-this指针的锅"><a href="#2-5-4-this指针的锅" class="headerlink" title="2.5.4 this指针的锅"></a>2.5.4 this指针的锅</h4><p>pthread_create的函数原型中第三个参数的类型为函数指针，指向的线程处理函数参数类型为<code>(void *)</code>,若线程函数为<strong>类成员函数</strong>，则<strong>this指针会作为默认的参数</strong>被传进函数中，从而和线程函数参数<code>(void*)</code>不能匹配，不能通过编译。</p>
<p>静态成员函数就没有这个问题，里面没有this指针。</p>
<h3 id="2-6-线程池分析"><a href="#2-6-线程池分析" class="headerlink" title="2.6 线程池分析"></a>2.6 线程池分析</h3><p>线程池的设计模式为半同步/半反应堆，其中反应堆具体为Proactor事件处理模式。</p>
<p>具体的，主线程为异步线程，负责监听文件描述符，接收socket新连接，若当前监听的socket发生了读写事件，然后将任务插入到请求队列。工作线程从请求队列中取出任务，完成读写数据的处理。</p>
<h4 id="2-6-1-线程池类定义"><a href="#2-6-1-线程池类定义" class="headerlink" title="2.6.1 线程池类定义"></a>2.6.1 线程池类定义</h4><p>具体定义可以看代码。需要注意，线程处理函数和运行函数设置为私有属性。</p>
<h4 id="2-6-2-线程池创建与回收"><a href="#2-6-2-线程池创建与回收" class="headerlink" title="2.6.2 线程池创建与回收"></a>2.6.2 线程池创建与回收</h4><p>构造函数中创建线程池,pthread_create函数中将类的对象作为参数传递给静态函数(worker),在静态函数中引用这个对象,并调用其动态方法(run)。</p>
<p>具体的，类对象传递时用this指针，传递给静态函数后，将其转换为线程池类，并调用私有成员函数run。</p>
<h4 id="2-6-3-向请求队列中添加任务"><a href="#2-6-3-向请求队列中添加任务" class="headerlink" title="2.6.3 向请求队列中添加任务"></a>2.6.3 向请求队列中添加任务</h4><p>通过list容器创建请求队列，向队列中添加时，通过互斥锁保证线程安全，添加完成后通过信号量提醒有任务要处理，最后注意线程同步。</p>
<h4 id="2-6-4-线程处理函数"><a href="#2-6-4-线程处理函数" class="headerlink" title="2.6.4 线程处理函数"></a>2.6.4 线程处理函数</h4><p>内部访问私有成员函数run，完成线程处理要求。</p>
<h4 id="2-6-5run执行任务"><a href="#2-6-5run执行任务" class="headerlink" title="2.6.5run执行任务"></a>2.6.5run执行任务</h4><p>主要实现，工作线程从请求队列中取出某个任务进行处理，注意线程同步。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token class-name">threadpool</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>m_stop<span class="token punctuation">)</span><span class="token punctuation">{</span>    
        <span class="token comment">//信号量等待</span>
        m_queuestat<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//被唤醒后先加互斥锁</span>
        m_queuelocker<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>m_workqueue<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            m_queuelocker<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//从请求队列中取出第一个任务</span>
        <span class="token comment">//将任务从请求队列删除</span>
        T<span class="token operator">*</span> request<span class="token operator">=</span>m_workqueue<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        m_workqueue<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        m_queuelocker<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>request<span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>

        <span class="token comment">//从连接池中取出一个数据库连接</span>
        request<span class="token operator">-&gt;</span>mysql <span class="token operator">=</span> m_connPool<span class="token operator">-&gt;</span><span class="token function">GetConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//process(模板类中的方法,这里是http类)进行处理</span>
        request<span class="token operator">-&gt;</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//将数据库连接放回连接池</span>
        m_connPool<span class="token operator">-&gt;</span><span class="token function">ReleaseConnection</span><span class="token punctuation">(</span>request<span class="token operator">-&gt;</span>mysql<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="2-6-6-线程池概述"><a href="#2-6-6-线程池概述" class="headerlink" title="2.6.6 线程池概述"></a>2.6.6 线程池概述</h4><p>使用一个<strong>链表实现的工作队列</strong>完全解除了主线程和工作线程的耦合关系：主线程往工作队列中插入任务，工作线程通过竞争来取得任务并执行它。</p>
<ul>
<li>同步I/O模拟proactor模式</li>
<li>半同步/半反应堆</li>
</ul>
<p>该项目使用线程池（<strong>半同步半反应堆模式</strong>）并发处理用户请求，<strong>主线程负责读写</strong>，工作线程（线程池中的线程）负责处理逻辑（HTTP请求报文的解析等等）。通过之前的代码，我们将<code>listenfd</code>上到达的<code>connection</code>通过 <code>accept()</code>接收，并返回一个新的socket文件描述符<code>connfd</code>用于和用户通信，并对用户请求返回响应，同时将这个<code>connfd</code>注册到内核事件表中，等用户发来请求报文。这个过程是：</p>
<p>通过<code>epoll_wait</code>发现这个<code>connfd</code>上有可读事件了（<code>EPOLLIN</code>），主线程就将这个HTTP的请求报文读进这个连接socket的读缓存中<code>users[sockfd].read()</code>，然后将该任务对象（指针）插入线程池的请求队列中<code>pool-&gt;append(users + sockfd);</code>，线程池的实现还需要依靠<strong>锁机制</strong>以及<strong>信号量</strong>机制来实现线程同步，保证操作的原子性。</p>
<p><strong>在线程池部分做几点解释</strong>，然后大家去看代码的时候就更容易看懂了：  </p>
<ul>
<li>所谓线程池，就是一个<code>pthread_t</code>类型的普通数组，通过<code>pthread_create()</code>函数创建<code>m_thread_number</code>个<strong>线程</strong>，用来执行<code>worker()</code>函数以执行每个请求处理函数（HTTP请求的<code>process</code>函数），通过<code>pthread_detach()</code>将线程设置成脱离态（detached）后，当这一线程运行结束时，它的资源会被系统自动回收，而不再需要在其它线程中对其进行 <code>pthread_join()</code> 操作。  </li>
<li>操作工作队列一定要加锁（<code>locker</code>），因为它被所有线程共享。</li>
<li>我们用信号量来标识请求队列中的请求数，通过<code>m_queuestat.wait();</code>来等待一个请求队列中待处理的HTTP请求，然后交给线程池中的空闲线程来处理。</li>
</ul>
<p><strong>为什么要使用线程池？</strong><br>当你需要限制你应用程序中同时运行的线程数时，线程池非常有用。因为启动一个新线程会带来性能开销，每个线程也会为其堆栈分配一些内存等。为了任务的并发执行，我们可以将这些任务任务传递到线程池，而不是为每个任务动态开启一个新的线程。</p>
<p><strong><span class="github-emoji"><span>⭐</span><img src="./images/loading.gif" data-original="https://github.githubassets.com/images/icons/emoji/unicode/2b50.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>线程池中的线程数量是依据什么确定的？</strong>  </p>
<p>线程池中的线程数量最直接的限制因素是中央处理器(CPU)的处理器(processors/cores)的数量<code>N</code>：如果你的CPU是4-cores的，对于CPU密集型的任务(如视频剪辑等消耗CPU计算资源的任务)来说，那线程池中的线程数量最好也设置为4（或者+1防止其他因素造成的线程阻塞）；对于IO密集型的任务，一般要多于CPU的核数，因为线程间竞争的不是CPU的计算资源而是IO，IO的处理一般较慢，多于cores数的线程将为CPU争取更多的任务，不至在线程处理IO的过程造成CPU空闲导致资源浪费，公式：<code>最佳线程数 = CPU当前可使用的Cores数 * 当前CPU的利用率 * (1 + CPU等待时间 / CPU处理时间)</code>（还有回答里面提到的Amdahl准则可以了解一下）</p>
<h3 id="2-7-threadpool-h代码"><a href="#2-7-threadpool-h代码" class="headerlink" title="2.7 threadpool.h代码"></a>2.7 threadpool.h代码</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">THREADPOOL_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">THREADPOOL_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;list&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdio&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;exception&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"../lock/locker.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"../CGImysql/sql_connection_pool.h"</span></span>

<span class="token comment">// 线程池类，将它定义为模板类是为了代码复用，模板参数T是任务类</span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">class</span> <span class="token class-name">threadpool</span><span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token comment">/*thread_number是线程池中线程的数量，max_requests是请求队列中最多允许的、等待处理的请求的数量*/</span>
    <span class="token function">threadpool</span><span class="token punctuation">(</span><span class="token keyword">int</span> actor_model<span class="token punctuation">,</span> connection_pool <span class="token operator">*</span>connPool<span class="token punctuation">,</span> <span class="token keyword">int</span> thread_number <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token keyword">int</span> max_request <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">~</span><span class="token function">threadpool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">append</span><span class="token punctuation">(</span>T <span class="token operator">*</span>request<span class="token punctuation">,</span> <span class="token keyword">int</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//往工作队列添加任务</span>
    <span class="token keyword">bool</span> <span class="token function">append_p</span><span class="token punctuation">(</span>T <span class="token operator">*</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token comment">/*工作线程运行的函数，它不断从工作队列中取出任务并执行之*/</span>
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">worker</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//worker——线程执行的函数（必须是静态的函数），主要就是启动run()函数用的</span>
    <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">int</span> m_thread_number<span class="token punctuation">;</span>        <span class="token comment">//线程池中的线程数量</span>
    <span class="token keyword">int</span> m_max_requests<span class="token punctuation">;</span>         <span class="token comment">//请求队列中允许的最大请求数</span>
    pthread_t <span class="token operator">*</span>m_threads<span class="token punctuation">;</span>       <span class="token comment">//描述线程池的数组，其大小为m_thread_number</span>
    std<span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>T <span class="token operator">*</span><span class="token operator">&gt;</span> m_workqueue<span class="token punctuation">;</span> <span class="token comment">//请求队列</span>
    locker m_queuelocker<span class="token punctuation">;</span>       <span class="token comment">//保护请求队列的互斥锁</span>
    sem m_queuestat<span class="token punctuation">;</span>            <span class="token comment">//是否有任务需要处理</span>
    connection_pool <span class="token operator">*</span>m_connPool<span class="token punctuation">;</span><span class="token comment">//数据库</span>
    <span class="token keyword">int</span> m_actor_model<span class="token punctuation">;</span>          <span class="token comment">//线程工作模式</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token comment">//构造函数初始化。actor_model工作模式，connPool数据库连接池，thread_number线程数量，max_requests请求队列中允许的最大请求数</span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token class-name">threadpool</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">threadpool</span><span class="token punctuation">(</span> <span class="token keyword">int</span> actor_model<span class="token punctuation">,</span> connection_pool <span class="token operator">*</span>connPool<span class="token punctuation">,</span> <span class="token keyword">int</span> thread_number<span class="token punctuation">,</span> <span class="token keyword">int</span> max_requests<span class="token punctuation">)</span> <span class="token operator">:</span> 
            <span class="token function">m_actor_model</span><span class="token punctuation">(</span>actor_model<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">m_thread_number</span><span class="token punctuation">(</span>thread_number<span class="token punctuation">)</span><span class="token punctuation">,</span> 
            <span class="token function">m_max_requests</span><span class="token punctuation">(</span>max_requests<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">m_threads</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">m_connPool</span><span class="token punctuation">(</span>connPool<span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>thread_number <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span> max_requests <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> std<span class="token double-colon punctuation">::</span><span class="token function">exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_threads <span class="token operator">=</span> <span class="token keyword">new</span> pthread_t<span class="token punctuation">[</span>m_thread_number<span class="token punctuation">]</span><span class="token punctuation">;</span>     <span class="token comment">//new创建的线程池的数组，到时候析构的时候要记得释放资源</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_threads<span class="token punctuation">)</span>
        <span class="token keyword">throw</span> std<span class="token double-colon punctuation">::</span><span class="token function">exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建thread_number 个线程，并将他们设置为脱离线程。m_threads+i指针表示线程号</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> thread_number<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pthread_create</span><span class="token punctuation">(</span>m_threads <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> worker<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">//worker线程执行的函数必须是静态的函数，this是传给work的参数</span>
            <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> m_threads<span class="token punctuation">;</span>
            <span class="token keyword">throw</span> std<span class="token double-colon punctuation">::</span><span class="token function">exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pthread_detach</span><span class="token punctuation">(</span>m_threads<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> m_threads<span class="token punctuation">;</span>
            <span class="token keyword">throw</span> std<span class="token double-colon punctuation">::</span><span class="token function">exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//析构函数释放资源</span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
threadpool<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token operator">~</span><span class="token function">threadpool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> m_threads<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//往队列中添加任务，request需要添加的任务，state该任务的状态</span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">bool</span> <span class="token class-name">threadpool</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">append</span><span class="token punctuation">(</span>T <span class="token operator">*</span>request<span class="token punctuation">,</span> <span class="token keyword">int</span> state<span class="token punctuation">)</span><span class="token punctuation">{</span>
    m_queuelocker<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_workqueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> m_max_requests<span class="token punctuation">)</span><span class="token punctuation">{</span>
        m_queuelocker<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    request<span class="token operator">-&gt;</span>m_state <span class="token operator">=</span> state<span class="token punctuation">;</span>
    m_workqueue<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_queuelocker<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_queuestat<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">//信号量加1</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">bool</span> <span class="token class-name">threadpool</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">append_p</span><span class="token punctuation">(</span>T <span class="token operator">*</span>request<span class="token punctuation">)</span><span class="token punctuation">{</span>
    m_queuelocker<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_workqueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> m_max_requests<span class="token punctuation">)</span><span class="token punctuation">{</span>
        m_queuelocker<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    m_workqueue<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_queuelocker<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_queuestat<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">//信号量加1</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token class-name">threadpool</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">worker</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>
    threadpool <span class="token operator">*</span>pool <span class="token operator">=</span> <span class="token punctuation">(</span>threadpool <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>   <span class="token comment">//拿到这个threadpool类，可以操作里面的所有成员</span>
    pool<span class="token operator">-&gt;</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        	<span class="token comment">//去执行任务</span>
    <span class="token keyword">return</span> pool<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token class-name">threadpool</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        m_queuestat<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">//如果这个值大于0，说明有任务可执行，取出一个任务，信号量减1。如果值为0就会阻塞等待。</span>
        
        m_queuelocker<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//被唤醒后先加互斥锁</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m_workqueue<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>   <span class="token comment">//没有数据解锁 continue</span>
            m_queuelocker<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        T <span class="token operator">*</span>request <span class="token operator">=</span> m_workqueue<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取任务</span>
        m_workqueue<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//删除队列中这个以获取的任务</span>
        m_queuelocker<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>request<span class="token punctuation">)</span>     <span class="token comment">//如果这个取出的任务为空，就continue，request就是http_conn这个类</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> m_actor_model<span class="token punctuation">)</span><span class="token punctuation">{</span>            
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> request<span class="token operator">-&gt;</span>m_state<span class="token punctuation">)</span><span class="token punctuation">{</span>     <span class="token comment">//m_state=0表示需要读入数据</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token operator">-&gt;</span><span class="token function">read_once</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    request<span class="token operator">-&gt;</span>improv <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    connectionRAII <span class="token function">mysqlcon</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>request<span class="token operator">-&gt;</span>mysql<span class="token punctuation">,</span> m_connPool<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//从连接池中取出一个数据库连接到if{}结束就会放回去和智能指针管理类似</span>
                    request<span class="token operator">-&gt;</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//由线程池中的工作线程调用，这是处理HTTP请求的入口函数</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span><span class="token punctuation">{</span>
                    request<span class="token operator">-&gt;</span>improv <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    request<span class="token operator">-&gt;</span>timer_flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span><span class="token punctuation">{</span>                           <span class="token comment">//m_state=1表示需要写入数据</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token operator">-&gt;</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    request<span class="token operator">-&gt;</span>improv <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span><span class="token punctuation">{</span>
                    request<span class="token operator">-&gt;</span>improv <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    request<span class="token operator">-&gt;</span>timer_flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token punctuation">{</span>               
            connectionRAII <span class="token function">mysqlcon</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>request<span class="token operator">-&gt;</span>mysql<span class="token punctuation">,</span> m_connPool<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//从连接池中取出一个数据库连接,将数据库连接放回连接池</span>
            request<span class="token operator">-&gt;</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="04-http连接处理（上）"><a href="#04-http连接处理（上）" class="headerlink" title="04 http连接处理（上）"></a>04 http连接处理（上）</h2><h3 id="4-1-epoll"><a href="#4-1-epoll" class="headerlink" title="4.1 epoll"></a>4.1 epoll</h3><p>epoll涉及的知识较多，这里仅对API和基础知识作介绍。更多资料请查阅资料，或查阅<code>游双的Linux高性能服务器编程 第9章 I/O复用</code></p>
<p><strong>epoll_create函数</strong></p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">-</span> 参数：
    size <span class="token operator">:</span> 目前没有意义了。为了兼容之前的版本。现在随便写一个数，必须大于<span class="token number">0</span>
    <span class="token operator">-</span> 返回值：
        <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">:</span> 失败
        <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">:</span> 文件描述符，操作epoll实例的<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>epoll_ctl函数</strong></p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// 对epoll实例进行管理：添加文件描述符信息，删除信息，修改信息</span>
<span class="token keyword">int</span> <span class="token function">epoll_ctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> epfd<span class="token punctuation">,</span> <span class="token keyword">int</span> op<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token operator">*</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">-</span> 参数：
    <span class="token operator">-</span> epfd <span class="token operator">:</span> epoll实例对应的文件描述符（就是这个epoll_create（）的返回值）
    <span class="token operator">-</span> op <span class="token operator">:</span> 要进行什么操作		（就是对底层的红黑树进行修改）
        EPOLL_CTL_ADD<span class="token operator">:</span> 添加
        EPOLL_CTL_MOD<span class="token operator">:</span> 修改
        EPOLL_CTL_DEL<span class="token operator">:</span> 删除
    <span class="token operator">-</span> fd <span class="token operator">:</span> 要检测的文件描述符
    <span class="token operator">-</span> event <span class="token operator">:</span> 告诉内核检测文件描述符什么事情
        
<span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token punctuation">{</span>
    <span class="token keyword">uint32_t</span> events<span class="token punctuation">;</span> 	<span class="token comment">/* Epoll events */</span>
    epoll_data_t data<span class="token punctuation">;</span> 	<span class="token comment">/* User data variable */</span>  <span class="token comment">//用户的数据信息</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
    events描述事件类型，其中epoll事件类型有以下几种
        EPOLLIN：表示对应的文件描述符可以读（包括对端SOCKET正常关闭）
        EPOLLOUT：表示对应的文件描述符可以写
        EPOLLPRI：表示对应的文件描述符有紧急的数据可读（这里应该表示有带外数据到来）
        EPOLLERR：表示对应的文件描述符发生错误
        EPOLLHUP：表示对应的文件描述符被挂断；
        EPOLLET：将EPOLL设为边缘触发<span class="token punctuation">(</span>Edge Triggered<span class="token punctuation">)</span>模式，这是相对于水平触发<span class="token punctuation">(</span>Level Triggered<span class="token punctuation">)</span>而言的
        EPOLLONESHOT：只监听一次事件，当监听完这次事件之后，如果还需要继续监听这个socket的话，需要再次把这个socket加入到EPOLL队列里<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>epoll_wait函数</strong>     该函数用于等待所监控文件描述符上有事件的产生，返回就绪的文件描述符个数</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// 检测函数</span>
<span class="token keyword">int</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span><span class="token keyword">int</span> epfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token operator">*</span>events<span class="token punctuation">,</span> <span class="token keyword">int</span> maxevents<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">-</span> 参数：
    <span class="token operator">-</span> epfd <span class="token operator">:</span> epoll实例对应的文件描述符
    <span class="token operator">-</span> events <span class="token operator">:</span> 传出参数，保存了发送了变化的文件描述符的信息（返回的那个双向链表，一般用数组保存）
    <span class="token operator">-</span> maxevents <span class="token operator">:</span> 第二个参数结构体数组的大小
    <span class="token operator">-</span> timeout <span class="token operator">:</span> 阻塞时间
        <span class="token operator">-</span>   <span class="token number">0</span> <span class="token operator">:</span> 不阻塞
        <span class="token operator">-</span>  <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">:</span> 阻塞，直到检测到fd数据发生变化，解除阻塞
        <span class="token operator">-</span>  <span class="token operator">&gt;</span><span class="token number">0</span> <span class="token operator">:</span> 阻塞的时长（毫秒）
    <span class="token operator">-</span> 返回值：
        <span class="token operator">-</span> 成功，返回发送变化的文件描述符的个数 <span class="token operator">&gt;</span> <span class="token number">0</span>
        <span class="token operator">-</span> 失败 <span class="token operator">-</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="4-1-1-select-x2F-poll-x2F-epoll"><a href="#4-1-1-select-x2F-poll-x2F-epoll" class="headerlink" title="4.1.1 select/poll/epoll"></a>4.1.1 select/poll/epoll</h4><ul>
<li><p>调用函数</p>
</li>
<li><ul>
<li>select和poll都是一个函数，epoll是一组函数</li>
</ul>
</li>
<li><p>文件描述符数量</p>
</li>
<li><ul>
<li>select通过线性表描述文件描述符集合，文件描述符有上限，一般是1024，但可以修改源码，重新编译内核，不推荐<ul>
<li>poll是链表描述，突破了文件描述符上限，最大可以打开文件的数目</li>
<li>epoll通过红黑树描述，最大可以打开文件的数目，可以通过命令ulimit -n number修改，仅对当前终端有效</li>
</ul>
</li>
</ul>
</li>
<li><p>将文件描述符从用户传给内核</p>
</li>
<li><ul>
<li>select和poll通过将所有文件描述符拷贝到内核态，每次调用都需要拷贝<ul>
<li>epoll通过epoll_create建立一棵红黑树，通过epoll_ctl将要监听的文件描述符注册到红黑树上</li>
</ul>
</li>
</ul>
</li>
<li><p>内核判断就绪的文件描述符</p>
</li>
<li><ul>
<li><strong>select和poll通过遍历文件描述符集合，判断哪个文件描述符上有事件发生</strong><ul>
<li>epoll_create时，内核除了帮我们在epoll文件系统里建了个红黑树用于存储以后epoll_ctl传来的fd外，还会再建立一个list链表，用于存储准备就绪的事件，当epoll_wait调用时，仅仅观察这个list链表里有没有数据即可。</li>
<li>epoll是根据每个fd上面的回调函数(中断函数)判断，只有发生了事件的socket才会主动的去调用 callback函数，其他空闲状态socket则不会，若是就绪事件，插入list</li>
</ul>
</li>
</ul>
</li>
<li><p>应用程序索引就绪文件描述符</p>
</li>
<li><ul>
<li>select/poll只返回发生了事件的文件描述符的个数，若知道是哪个发生了事件，同样需要遍历<ul>
<li>epoll返回的发生了事件的个数和结构体数组，结构体包含socket的信息，因此直接处理返回的数组即可</li>
</ul>
</li>
</ul>
</li>
<li><p>工作模式</p>
</li>
<li><ul>
<li>select和poll都只能工作在相对低效的LT模式下<ul>
<li>epoll则可以工作在ET高效模式，并且epoll还支持EPOLLONESHOT事件，该事件能进一步减少可读、可写和异常事件被触发的次数。</li>
</ul>
</li>
</ul>
</li>
<li><p>应用场景</p>
</li>
<li><ul>
<li>当所有的fd都是活跃连接，使用epoll，需要建立文件系统，红黑书和链表对于此来说，效率反而不高，不如selece和poll<ul>
<li>当<strong>监测的fd数目较小，且各个fd都比较活跃，建议使用select或者poll</strong></li>
<li>当监测的fd数目非常大，成千上万，且单位时间只有其中的一部分fd处于就绪状态，这个时候使用epoll能够明显提升性能</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="4-1-2-ET、LT、EPOLLONESHOT"><a href="#4-1-2-ET、LT、EPOLLONESHOT" class="headerlink" title="4.1.2 ET、LT、EPOLLONESHOT"></a>4.1.2 ET、LT、EPOLLONESHOT</h4><ul>
<li><p><strong>LT水平触发模式</strong></p>
</li>
<li><ul>
<li>epoll_wait检测到文件描述符有事件发生，则将其通知给应用程序，应用程序可以不立即处理该事件。<ul>
<li>当下一次调用epoll_wait时，epoll_wait还会再次向应用程序报告此事件，直至被处理</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>ET边缘触发模式</strong></p>
</li>
<li><ul>
<li>epoll_wait检测到文件描述符有事件发生，则将其通知给应用程序，应用程序必须立即处理该事件<ul>
<li>必须要一次性将数据读取完，使用非阻塞I/O，读取到出现eagain</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>EPOLLONESHOT</strong></p>
</li>
<li><ul>
<li>一个线程读取某个socket上的数据后开始处理数据，在处理过程中该socket上又有新数据可读，此时另一个线程被唤醒读取，此时出现两个线程处理同一个socket<ul>
<li>我们期望的是一个socket连接在任一时刻都只被一个线程处理，通过epoll_ctl对该文件描述符注册epolloneshot事件，一个线程处理socket时，其他线程将无法处理，<strong>当该线程处理完后，需要通过epoll_ctl重置epolloneshot事件</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="4-2-HTTP报文格式"><a href="#4-2-HTTP报文格式" class="headerlink" title="4.2 HTTP报文格式"></a>4.2 HTTP报文格式</h3><p>HTTP报文分为请求报文和响应报文两种，每种报文必须按照特有格式生成，才能被浏览器端识别。</p>
<p>其中，浏览器端向服务器发送的为请求报文，服务器处理后返回给浏览器端的为响应报文。</p>
<h4 id="4-2-1-请求报文"><a href="#4-2-1-请求报文" class="headerlink" title="4.2.1 请求报文"></a>4.2.1 请求报文</h4><p>HTTP请求报文由请求行（request line）、请求头部（header）、空行和请求数据四个部分组成。</p>
<p>其中，请求分为两种，GET和POST，具体的：</p>
<ul>
<li><strong>GET</strong></li>
</ul>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">GET</span> <span class="token request-target url">/562f25980001b1b106000338.jpg</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span><span class="token header-value">img.mukewang.com</span></span>
<span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span><span class="token header-value">Mozilla/5.0 (Windows NT10.0; WOw64)</span></span>
ApplewebKit/537.36(KHTML,like Gecko) Chrome/51.0.2704.106 Safari/537.36
Accept :image/webp,image/*,*/*;q=0.8
<span class="token header"><span class="token header-name keyword">Referer</span><span class="token punctuation">:</span><span class="token header-value">http:// www .imooc.com/</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Encoding</span><span class="token punctuation">:</span><span class="token header-value">gzip, deflate,sdchAccept-Language: zh-CN, zh;q=0.8</span></span>
空行
请求数据为空<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><strong>POST</strong></li>
</ul>
<pre class="line-numbers language-http" data-language="http"><code class="language-http">POST / HTTP1.1
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span><span class="token header-value">www.wrox.com</span></span>
<span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span><span class="token header-value">Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 2.0.50727; .NET CLR 3.0.04506.648; .NET CLR 3.5.21022)</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span><span class="token header-value">application/x-www-form-urlencoded</span></span>
<span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span><span class="token header-value">40</span></span>
<span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">Keep-Alive</span></span>
空行
name=Professional%20Ajax&amp;publisher=Wiley<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<ul>
<li><p><strong>请求行</strong>，用来说明请求类型,要访问的资源以及所使用的HTTP版本。<br>  GET说明请求类型为GET，/562f25980001b1b106000338.jpg(URL)为要访问的资源，该行的最后一部分说明使用的是HTTP1.1版本。</p>
</li>
<li><p><strong>请求头部</strong>，紧接着请求行（即第一行）之后的部分，用来说明服务器要使用的附加信息。</p>
</li>
<li><ul>
<li>HOST，给出请求资源所在服务器的域名。<ul>
<li>User-Agent，HTTP客户端程序的信息，该信息由你发出请求使用的浏览器来定义,并且在每个请求中自动发送等。</li>
<li>Accept，说明用户代理可处理的媒体类型。</li>
<li>Accept-Encoding，说明用户代理支持的内容编码。</li>
<li>Accept-Language，说明用户代理能够处理的自然语言集。</li>
<li>Content-Type，说明实现主体的媒体类型。</li>
<li>Content-Length，说明实现主体的大小。</li>
<li>Connection，连接管理，可以是Keep-Alive或close。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>空行</strong>，请求头部后面的空行是必须的即使第四部分的请求数据为空，也必须有空行。</p>
</li>
<li><p><strong>请求数据</strong>也叫主体，可以添加任意的其他数据。</p>
</li>
</ul>
</blockquote>
<h4 id="4-2-2-响应报文"><a href="#4-2-2-响应报文" class="headerlink" title="4.2.2 响应报文"></a>4.2.2 响应报文</h4><p>HTTP响应也由四个部分组成，分别是：状态行、消息报头、空行和响应正文。</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token response-status"><span class="token http-version property">HTTP/1.1</span> <span class="token status-code number">200</span> <span class="token reason-phrase string">OK</span></span>
<span class="token header"><span class="token header-name keyword">Date</span><span class="token punctuation">:</span> <span class="token header-value">Fri, 22 May 2009 06:07:21 GMT</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">text/html; charset=UTF-8</span></span>
空行
&lt;html&gt;
      &lt;head&gt;&lt;/head&gt;
      &lt;body&gt;
            &lt;!--body goes here--&gt;
      &lt;/body&gt;
&lt;/html&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<ul>
<li>状态行，由HTTP协议版本号， 状态码， 状态消息 三部分组成。<br>  第一行为状态行，（HTTP/1.1）表明HTTP版本为1.1版本，状态码为200，状态消息为OK。</li>
<li>消息报头，用来说明客户端要使用的一些附加信息。<br>  第二行和第三行为消息报头，Date:生成响应的日期和时间；Content-Type:指定了MIME类型的HTML(text/html),编码类型是UTF-8。</li>
<li>空行，消息报头后面的空行是必须的。</li>
<li>响应正文，服务器返回给客户端的文本信息。空行后面的html部分为响应正文。</li>
</ul>
</blockquote>
<h3 id="4-3-HTTP状态码"><a href="#4-3-HTTP状态码" class="headerlink" title="4.3 HTTP状态码"></a>4.3 HTTP状态码</h3><p>HTTP有5种类型的状态码，具体的：</p>
<ul>
<li><p>1xx：指示信息–表示请求已接收，继续处理。</p>
</li>
<li><p>2xx：成功–表示请求正常处理完毕。</p>
</li>
<li><ul>
<li>200 OK：客户端请求被正常处理。<ul>
<li>206 Partial content：客户端进行了范围请求。</li>
</ul>
</li>
</ul>
</li>
<li><p>3xx：重定向–要完成请求必须进行更进一步的操作。</p>
</li>
<li><ul>
<li>301 Moved Permanently：永久重定向，该资源已被永久移动到新位置，将来任何对该资源的访问都要使用本响应返回的若干个URI之一。<ul>
<li>302 Found：临时重定向，请求的资源现在临时从不同的URI中获得。</li>
</ul>
</li>
</ul>
</li>
<li><p>4xx：客户端错误–请求有语法错误，服务器无法处理请求。</p>
</li>
<li><ul>
<li>400 Bad Request：请求报文存在语法错误。<ul>
<li>403 Forbidden：请求被服务器拒绝。</li>
<li>404 Not Found：请求不存在，服务器上找不到请求的资源。</li>
</ul>
</li>
</ul>
</li>
<li><p>5xx：服务器端错误–服务器处理请求出错。</p>
</li>
<li><ul>
<li>500 Internal Server Error：服务器在执行请求时出现错误。</li>
</ul>
</li>
</ul>
<h3 id="4-4-有限状态机"><a href="#4-4-有限状态机" class="headerlink" title="4.4 有限状态机"></a>4.4 有限状态机</h3><p>有限状态机，是一种抽象的理论模型，它能够把有限个变量描述的状态变化过程，以可构造可验证的方式呈现出来。比如，封闭的有向图。</p>
<p>有限状态机可以通过if-else,switch-case和函数指针来实现，从软件工程的角度看，主要是为了封装逻辑。</p>
<p>带有状态转移的有限状态机示例代码。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">STATE_MACHINE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    State cur_State <span class="token operator">=</span> type_A<span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>cur_State <span class="token operator">!=</span> type_C<span class="token punctuation">)</span><span class="token punctuation">{</span>
        Package _pack <span class="token operator">=</span> <span class="token function">getNewPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">case</span> type_A<span class="token operator">:</span>
                <span class="token function">process_pkg_state_A</span><span class="token punctuation">(</span>_pack<span class="token punctuation">)</span><span class="token punctuation">;</span>
                cur_State <span class="token operator">=</span> type_B<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> type_B<span class="token operator">:</span>
                <span class="token function">process_pkg_state_B</span><span class="token punctuation">(</span>_pack<span class="token punctuation">)</span><span class="token punctuation">;</span>
                cur_State <span class="token operator">=</span> type_C<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该状态机包含三种状态：type_A，type_B和type_C。其中，type_A是初始状态，type_C是结束状态。</p>
<p>状态机的当前状态记录在cur_State变量中，逻辑处理时，状态机先通过getNewPackage获取数据包，然后根据当前状态对数据进行处理，处理完后，状态机通过改变cur_State完成状态转移。</p>
<p>有限状态机一种逻辑单元内部的一种高效编程方法，在服务器编程中，服务器可以根据不同状态或者消息类型进行相应的处理逻辑，使得程序逻辑清晰易懂。</p>
<h3 id="4-5-http处理流程"><a href="#4-5-http处理流程" class="headerlink" title="4.5 http处理流程"></a>4.5 http处理流程</h3><p>首先对http报文处理的流程进行简要介绍，然后具体介绍http类的定义和服务器接收http请求的具体过程。</p>
<h4 id="4-5-1-http报文处理流程"><a href="#4-5-1-http报文处理流程" class="headerlink" title="4.5.1 http报文处理流程"></a>4.5.1 http报文处理流程</h4><ul>
<li>浏览器端发出http连接请求，主线程创建http对象接收请求并将所有数据读入对应buffer，将该对象插入任务队列，工作线程从任务队列中取出一个任务进行处理。(<strong>本篇讲</strong>)</li>
<li>工作线程取出任务后，调用process_read函数，通过主、从状态机对请求报文进行解析。(<strong>中篇讲</strong>)</li>
<li>解析完之后，跳转do_request函数生成响应报文，通过process_write写入buffer，返回给浏览器端。(<strong>下篇讲</strong>)</li>
</ul>
<h4 id="4-5-2-http类"><a href="#4-5-2-http类" class="headerlink" title="4.5.2 http类"></a>4.5.2 http类</h4><p>这一部分代码在TinyWebServer/http/http_conn.h中，主要是http类的定义。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">http_conn</span><span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> FILENAME_LEN <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>         <span class="token comment">//设置读取文件的名称m_real_file大小</span>
    <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> READ_BUFFER_SIZE <span class="token operator">=</span> <span class="token number">2048</span><span class="token punctuation">;</span>    <span class="token comment">//设置读缓冲区m_read_buf大小</span>
    <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> WRITE_BUFFER_SIZE <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">;</span>   <span class="token comment">//设置写缓冲区m_write_buf大小</span>
    
    <span class="token keyword">enum</span> <span class="token class-name">METHOD</span><span class="token punctuation">{</span>GET <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>POST<span class="token punctuation">,</span>HEAD<span class="token punctuation">,</span>PUT<span class="token punctuation">,</span>DELETE<span class="token punctuation">,</span>TRACE<span class="token punctuation">,</span>OPTIONS<span class="token punctuation">,</span>CONNECT<span class="token punctuation">,</span>PATH<span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//报文的请求方法，本项目只用到GET和POST</span>
    <span class="token keyword">enum</span> <span class="token class-name">CHECK_STATE</span><span class="token punctuation">{</span>                           <span class="token comment">//主状态机的状态</span>
        CHECK_STATE_REQUESTLINE <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>    <span class="token comment">//请求行</span>
        CHECK_STATE_HEADER<span class="token punctuation">,</span>             <span class="token comment">//请求头</span>
        CHECK_STATE_CONTENT             <span class="token comment">//消息体</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">enum</span> <span class="token class-name">HTTP_CODE</span><span class="token punctuation">{</span>                             <span class="token comment">//报文解析的结果</span>
        NO_REQUEST<span class="token punctuation">,</span>
        GET_REQUEST<span class="token punctuation">,</span>
        BAD_REQUEST<span class="token punctuation">,</span>
        NO_RESOURCE<span class="token punctuation">,</span>
        FORBIDDEN_REQUEST<span class="token punctuation">,</span>
        FILE_REQUEST<span class="token punctuation">,</span>
        INTERNAL_ERROR<span class="token punctuation">,</span>
        CLOSED_CONNECTION
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">enum</span> <span class="token class-name">LINE_STATUS</span> <span class="token punctuation">{</span>                          <span class="token comment">//从状态机的状态</span>
        LINE_OK <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        LINE_BAD<span class="token punctuation">,</span>
        LINE_OPEN
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">http_conn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">http_conn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token comment">//初始化套接字地址，函数内部会调用私有方法init</span>
    <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> sockaddr_in <span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> string user<span class="token punctuation">,</span> string passwd<span class="token punctuation">,</span> string sqlname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//关闭http连接</span>
    <span class="token keyword">void</span> <span class="token function">close_conn</span><span class="token punctuation">(</span><span class="token keyword">bool</span> real_close <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//各子线程通过process函数对任务进行处理，调用process_read函数和process_write函数分别完成报文解析与报文响应两个任务。</span>
    <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//读取浏览器端发来的全部数据</span>
    <span class="token keyword">bool</span> <span class="token function">read_once</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//响应报文写入函数</span>
    <span class="token keyword">bool</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sockaddr_in <span class="token operator">*</span><span class="token function">get_address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">&amp;</span>m_address<span class="token punctuation">;</span>    <span class="token punctuation">}</span>   <span class="token comment">//返回客户端的地址（inline）</span>

    <span class="token keyword">void</span> <span class="token function">initmysql_result</span><span class="token punctuation">(</span>connection_pool <span class="token operator">*</span>connPool<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//同步线程初始化数据库读取表</span>
    <span class="token keyword">int</span> timer_flag<span class="token punctuation">;</span>
    <span class="token keyword">int</span> improv<span class="token punctuation">;</span>


<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    HTTP_CODE <span class="token function">process_read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token comment">//从m_read_buf读取，并处理请求报文</span>
    <span class="token keyword">bool</span> <span class="token function">process_write</span><span class="token punctuation">(</span>HTTP_CODE ret<span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">//向m_write_buf写入响应报文数据</span>
    HTTP_CODE <span class="token function">parse_request_line</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">//主状态机解析报文中的请求行数据</span>
    HTTP_CODE <span class="token function">parse_headers</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//主状态机解析报文中的请求头数据</span>
    HTTP_CODE <span class="token function">parse_content</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//主状态机解析报文中的请求内容</span>
    HTTP_CODE <span class="token function">do_request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                             <span class="token comment">//生成响应报文</span>
    
    <span class="token comment">//m_start_line是已经解析的字符</span>
    <span class="token comment">//get_line用于将指针向后偏移，指向未处理的字符</span>
    <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">get_line</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> m_read_buf <span class="token operator">+</span> m_start_line<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    <span class="token comment">//从状态机读取一行，分析是请求报文的哪一部分</span>
    LINE_STATUS <span class="token function">parse_line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">unmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//根据响应报文格式，生成对应8个部分，以下函数均由do_request调用</span>
    <span class="token keyword">bool</span> <span class="token function">add_response</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">add_content</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">add_status_line</span><span class="token punctuation">(</span><span class="token keyword">int</span> status<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>title<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">add_headers</span><span class="token punctuation">(</span><span class="token keyword">int</span> content_length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">add_content_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">add_content_length</span><span class="token punctuation">(</span><span class="token keyword">int</span> content_length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">add_linger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">add_blank_line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> m_epollfd<span class="token punctuation">;</span>       <span class="token comment">//epoll_creat()生成的epollfd</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> m_user_count<span class="token punctuation">;</span>    <span class="token comment">//用户数量</span>
    MYSQL <span class="token operator">*</span>mysql<span class="token punctuation">;</span>
    <span class="token keyword">int</span> m_state<span class="token punctuation">;</span>  <span class="token comment">//读为0, 写为1</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">int</span> m_sockfd<span class="token punctuation">;</span>
    sockaddr_in m_address<span class="token punctuation">;</span>

    <span class="token keyword">char</span> m_read_buf<span class="token punctuation">[</span>READ_BUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token comment">//存储读取的请求报文数据</span>
    <span class="token keyword">int</span> m_read_idx<span class="token punctuation">;</span>                         <span class="token comment">//缓冲区中m_read_buf中数据的最后一个字节的下一个位置</span>
    <span class="token keyword">int</span> m_checked_idx<span class="token punctuation">;</span>                      <span class="token comment">//m_read_buf解析的位置m_checked_idx</span>
    <span class="token keyword">int</span> m_start_line<span class="token punctuation">;</span>                       <span class="token comment">//m_read_buf中已经解析的字符个数</span>
    
    <span class="token keyword">char</span> m_write_buf<span class="token punctuation">[</span>WRITE_BUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">//存储发出的响应报文数据</span>
    <span class="token keyword">int</span> m_write_idx<span class="token punctuation">;</span>                        <span class="token comment">//指示buffer中实际使用的长度</span>
    
    CHECK_STATE m_check_state<span class="token punctuation">;</span>              <span class="token comment">//主状态机的状态</span>
    METHOD m_method<span class="token punctuation">;</span>                        <span class="token comment">//请求方法</span>

    <span class="token comment">//以下为解析请求报文中对应的6个变量</span>
    <span class="token keyword">char</span> m_real_file<span class="token punctuation">[</span>FILENAME_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>         <span class="token comment">//存储读取文件的名称</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>m_url<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>m_version<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>m_host<span class="token punctuation">;</span>
    <span class="token keyword">int</span> m_content_length<span class="token punctuation">;</span>
    <span class="token keyword">bool</span> m_linger<span class="token punctuation">;</span>

    <span class="token keyword">char</span> <span class="token operator">*</span>m_file_address<span class="token punctuation">;</span>                   <span class="token comment">//读取服务器上的文件地址</span>
    <span class="token keyword">struct</span> <span class="token class-name">stat</span> m_file_stat<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">iovec</span> m_iv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                   <span class="token comment">//io向量机制iovec</span>
    <span class="token keyword">int</span> m_iv_count<span class="token punctuation">;</span>
    <span class="token keyword">int</span> cgi<span class="token punctuation">;</span>                                <span class="token comment">//是否启用的POST</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>m_string<span class="token punctuation">;</span>                         <span class="token comment">//存储请求头数据</span>
    <span class="token keyword">int</span> bytes_to_send<span class="token punctuation">;</span>                      <span class="token comment">//剩余发送字节数</span>
    <span class="token keyword">int</span> bytes_have_send<span class="token punctuation">;</span>                    <span class="token comment">//已发送字节数</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>doc_root<span class="token punctuation">;</span>

    map<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> string<span class="token operator">&gt;</span> m_users<span class="token punctuation">;</span>
    <span class="token keyword">int</span> m_TRIGMode<span class="token punctuation">;</span>                     <span class="token comment">//0代表LT读取数据，1代表ET读取数据</span>
    <span class="token keyword">int</span> m_close_log<span class="token punctuation">;</span>                    <span class="token comment">//是否关闭日志</span>

    <span class="token keyword">char</span> sql_user<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                 <span class="token comment">//连接数据库的参数</span>
    <span class="token keyword">char</span> sql_passwd<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> sql_name<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在http请求接收部分，会涉及到init和read_once函数，但init仅仅是对私有成员变量进行初始化，不用过多讲解。</p>
<p>这里，对read_once进行介绍。read_once读取浏览器端发送来的请求报文，直到无数据可读或对方关闭连接，读取到m_read_buffer中，并更新m_read_idx。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2023/cpp/image-20230313104536665.png" alt="image-20230313104536665"></p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//循环读取客户数据，直到无数据可读或对方关闭连接</span>
<span class="token comment">//非阻塞ET工作模式下，需要一次性将数据读完</span>
<span class="token keyword">bool</span> http_conn<span class="token double-colon punctuation">::</span><span class="token function">read_once</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_read_idx <span class="token operator">&gt;=</span> READ_BUFFER_SIZE<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> bytes_read <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">//LT读取数据，Lt模式下，读一次就好了</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> m_TRIGMode<span class="token punctuation">)</span><span class="token punctuation">{</span>
        bytes_read <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>m_sockfd<span class="token punctuation">,</span> m_read_buf <span class="token operator">+</span> m_read_idx<span class="token punctuation">,</span> READ_BUFFER_SIZE <span class="token operator">-</span> m_read_idx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        m_read_idx <span class="token operator">+=</span> bytes_read<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>bytes_read <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//ET读数据</span>
    <span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            bytes_read <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>m_sockfd<span class="token punctuation">,</span> m_read_buf <span class="token operator">+</span> m_read_idx<span class="token punctuation">,</span> READ_BUFFER_SIZE <span class="token operator">-</span> m_read_idx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bytes_read <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EAGAIN <span class="token operator">||</span> errno <span class="token operator">==</span> EWOULDBLOCK<span class="token punctuation">)</span>    <span class="token comment">//数据读完了</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>       <span class="token comment">//信号为EINTR被中断</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>bytes_read <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//客户端断开</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            m_read_idx <span class="token operator">+=</span> bytes_read<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="4-5-3-epoll相关代码"><a href="#4-5-3-epoll相关代码" class="headerlink" title="4.5.3 epoll相关代码"></a>4.5.3 epoll相关代码</h4><p>项目中epoll相关代码部分包括非阻塞模式、内核事件表注册事件、删除事件、重置EPOLLONESHOT事件四种。</p>
<ul>
<li>非阻塞模式</li>
</ul>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//对文件描述符设置非阻塞</span>
<span class="token keyword">int</span> <span class="token function">setnonblocking</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> old_option <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_GETFL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> new_option <span class="token operator">=</span> old_option <span class="token operator">|</span> O_NONBLOCK<span class="token punctuation">;</span>
    <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> new_option<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> old_option<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>内核事件表注册新事件，开启EPOLLONESHOT，针对客户端连接的描述符，listenfd不用开启</li>
</ul>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//将内核事件表注册读事件，fd通信的文件描述符，选择开启EPOLLONESHOT，（TRIGMode=1 ET模式）/LT模式</span>
<span class="token keyword">void</span> <span class="token function">addfd</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">bool</span> one_shot<span class="token punctuation">,</span> <span class="token keyword">int</span> TRIGMode<span class="token punctuation">)</span><span class="token punctuation">{</span>
    epoll_event event<span class="token punctuation">;</span>
    event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> fd<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> TRIGMode<span class="token punctuation">)</span>  <span class="token comment">//边沿触发，接收到数据就触发</span>
        event<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN <span class="token operator">|</span> EPOLLET <span class="token operator">|</span> EPOLLRDHUP<span class="token punctuation">;</span>
    <span class="token keyword">else</span>                <span class="token comment">//水平触发：有数据就触发</span>
        event<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN <span class="token operator">|</span> EPOLLRDHUP<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>one_shot<span class="token punctuation">)</span>                       <span class="token comment">//只触发一次</span>
        event<span class="token punctuation">.</span>events <span class="token operator">|=</span> EPOLLONESHOT<span class="token punctuation">;</span>
    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setnonblocking</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>内核事件表删除事件</li>
</ul>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//从内核事件表删除描述符</span>
<span class="token keyword">void</span> <span class="token function">removefd</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> EPOLL_CTL_DEL<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>重置EPOLLONESHOT事件</li>
</ul>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//将事件重置为EPOLLONESHOT</span>
<span class="token keyword">void</span> <span class="token function">modfd</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> ev<span class="token punctuation">,</span> <span class="token keyword">int</span> TRIGMode<span class="token punctuation">)</span><span class="token punctuation">{</span>
    epoll_event event<span class="token punctuation">;</span>
    event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> fd<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> TRIGMode<span class="token punctuation">)</span>
        event<span class="token punctuation">.</span>events <span class="token operator">=</span> ev <span class="token operator">|</span> EPOLLET <span class="token operator">|</span> EPOLLONESHOT <span class="token operator">|</span> EPOLLRDHUP<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        event<span class="token punctuation">.</span>events <span class="token operator">=</span> ev <span class="token operator">|</span> EPOLLONESHOT <span class="token operator">|</span> EPOLLRDHUP<span class="token punctuation">;</span>  <span class="token comment">//EPOLLHUP：表示对应的读事件文件描述符被挂断；</span>

    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> EPOLL_CTL_MOD<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="4-5-4-服务器接收http请求"><a href="#4-5-4-服务器接收http请求" class="headerlink" title="4.5.4 服务器接收http请求"></a>4.5.4 服务器接收http请求</h4><p>浏览器端发出http连接请求，主线程创建http对象接收请求并将所有数据读入对应buffer，将该对象插入任务队列，工作线程从任务队列中取出一个任务进行处理。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//创建MAX_FD个http类对象</span>
http_conn<span class="token operator">*</span> users<span class="token operator">=</span><span class="token keyword">new</span> http_conn<span class="token punctuation">[</span>MAX_FD<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">//创建内核事件表</span>
epoll_event events<span class="token punctuation">[</span>MAX_EVENT_NUMBER<span class="token punctuation">]</span><span class="token punctuation">;</span>		<span class="token comment">//一次最大的监听数量：传出参数</span>
epollfd <span class="token operator">=</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">assert</span><span class="token punctuation">(</span>epollfd <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//将listenfd放在epoll树上</span>
<span class="token function">addfd</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> listenfd<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//将上述epollfd赋值给http类对象的m_epollfd属性</span>
http_conn<span class="token double-colon punctuation">::</span>m_epollfd <span class="token operator">=</span> epollfd<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token double-colon punctuation">::</span><span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">bool</span> timeout <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> stop_server <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stop_server<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">int</span> number <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> MAX_EVENT_NUMBER<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//等待所监控文件描述符上有事件的产生</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>number <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> errno <span class="token operator">!=</span> EINTR<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"epoll failure"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> number<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">int</span> sockfd <span class="token operator">=</span> events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">;</span>

            <span class="token comment">//处理新到的客户连接</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> m_listenfd<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">bool</span> flag <span class="token operator">=</span> <span class="token function">dealclinetdata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> flag<span class="token punctuation">)</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//处理异常事件</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> <span class="token punctuation">(</span>EPOLLRDHUP <span class="token operator">|</span> EPOLLHUP <span class="token operator">|</span> EPOLLERR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//服务器端关闭连接，移除对应的定时器</span>
                util_timer <span class="token operator">*</span>timer <span class="token operator">=</span> users_timer<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer<span class="token punctuation">;</span>
                <span class="token function">deal_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//处理信号</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sockfd <span class="token operator">==</span> m_pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">bool</span> flag <span class="token operator">=</span> <span class="token function">dealwithsignal</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> stop_server<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> flag<span class="token punctuation">)</span>
                    <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"dealclientdata failure"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//处理客户连接上接收到的数据</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span><span class="token punctuation">{</span>		<span class="token comment">//读事件</span>
                <span class="token function">dealwithread</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLOUT<span class="token punctuation">)</span><span class="token punctuation">{</span>		<span class="token comment">//写事件</span>
                <span class="token function">dealwithwrite</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">{</span>
            utils<span class="token punctuation">.</span><span class="token function">timer_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"timer tick"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            timeout <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="05-http连接处理（中）"><a href="#05-http连接处理（中）" class="headerlink" title="05 http连接处理（中）"></a>05 http连接处理（中）</h2><p>上篇，我们对http连接的基础知识、服务器接收请求的处理流程进行了介绍，本篇将结合流程图和代码分别对状态机和服务器解析请求报文进行详解。</p>
<p><strong>流程图部分</strong>，描述主、从状态机调用关系与状态转移过程。</p>
<p><strong>代码部分</strong>，结合代码对http请求报文的解析进行详解。</p>
<h3 id="5-1-流程图与状态机"><a href="#5-1-流程图与状态机" class="headerlink" title="5.1 流程图与状态机"></a>5.1 流程图与状态机</h3><p><strong>从状态机负责读取报文的一行，主状态机负责对该行数据进行解析</strong>，主状态机内部调用从状态机，从状态机驱动主状态机。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2023/cpp/image-20230314103855099.png" alt="image-20230314103855099"></p>
<h4 id="5-1-1-主状态机"><a href="#5-1-1-主状态机" class="headerlink" title="5.1.1 主状态机"></a>5.1.1 主状态机</h4><p>三种状态，标识解析位置。</p>
<ul>
<li><code>CHECK_STATE_REQUESTLINE</code>，解析请求行</li>
<li><code>CHECK_STATE_HEADER</code>，解析请求头</li>
<li><code>CHECK_STATE_CONTENT</code>，解析消息体，仅用于解析POST请求</li>
</ul>
<h4 id="5-1-2-从状态机"><a href="#5-1-2-从状态机" class="headerlink" title="5.1.2 从状态机"></a>5.1.2 从状态机</h4><p>三种状态，标识解析一行的读取状态。</p>
<ul>
<li><code>LINE_OK</code>，完整读取一行</li>
<li><code>LINE_BAD</code>，报文语法有误</li>
<li><code>LINE_OPEN</code>，读取的行不完整</li>
</ul>
<h3 id="5-2-代码分析-http报文解析"><a href="#5-2-代码分析-http报文解析" class="headerlink" title="5.2 代码分析-http报文解析"></a>5.2 代码分析-http报文解析</h3><p>上篇中介绍了服务器接收http请求的流程与细节，简单来讲，<strong>浏览器端发出http连接请求，服务器端主线程创建http对象接收请求并将所有数据读入对应buffer，将该对象插入任务队列后，工作线程从任务队列中取出一个任务进行处理</strong>。</p>
<p><strong>各子线程通过process函数对任务进行处理，调用process_read函数和process_write函数分别完成报文解析与报文响应两个任务</strong>。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//各子线程通过process函数对任务进行处理，调用process_read函数和process_write函数分别完成报文解析与报文响应两个任务。</span>
<span class="token keyword">void</span> http_conn<span class="token double-colon punctuation">::</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    HTTP_CODE read_ret <span class="token operator">=</span> <span class="token function">process_read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>read_ret <span class="token operator">==</span> NO_REQUEST<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//NO_REQUEST，表示请求不完整，需要继续接收请求数据</span>
        <span class="token function">modfd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span> m_sockfd<span class="token punctuation">,</span> EPOLLIN<span class="token punctuation">,</span> m_TRIGMode<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//注册并监听读事件</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">bool</span> write_ret <span class="token operator">=</span> <span class="token function">process_write</span><span class="token punctuation">(</span>read_ret<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//调用process_write完成报文响应</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>write_ret<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">close_conn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">modfd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span> m_sockfd<span class="token punctuation">,</span> EPOLLOUT<span class="token punctuation">,</span> m_TRIGMode<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//注册并监听写事件</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>本篇将对<strong>报文解析的流程和process_read函数细节</strong>进行详细介绍。</p>
<h4 id="5-2-1-HTTP-CODE含义"><a href="#5-2-1-HTTP-CODE含义" class="headerlink" title="5.2.1 HTTP_CODE含义"></a>5.2.1 HTTP_CODE含义</h4><p>表示HTTP请求的处理结果，在头文件中初始化了八种情形，在报文解析时只涉及到四种。</p>
<ul>
<li>NO_REQUEST——请求不完整，需要继续读取请求报文数据</li>
<li>GET_REQUEST——获得了完整的HTTP请求</li>
<li>BAD_REQUEST——HTTP请求报文有语法错误</li>
<li>INTERNAL_ERROR——服务器内部错误，该结果在主状态机逻辑switch的default下，一般不会触发</li>
</ul>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">enum</span> <span class="token class-name">HTTP_CODE</span><span class="token punctuation">{</span>                             <span class="token comment">//报文解析的结果</span>
    NO_REQUEST<span class="token punctuation">,</span>             <span class="token comment">//请求不完整，需要继续读取请求报文数据</span>
    GET_REQUEST<span class="token punctuation">,</span>            <span class="token comment">//获得了完整的HTTP请求</span>
    BAD_REQUEST<span class="token punctuation">,</span>            <span class="token comment">//HTTP请求报文有语法错误</span>
    NO_RESOURCE<span class="token punctuation">,</span>            <span class="token comment">//没有相应的资源</span>
    FORBIDDEN_REQUEST<span class="token punctuation">,</span>      <span class="token comment">//禁止访问</span>
    FILE_REQUEST<span class="token punctuation">,</span>           <span class="token comment">//文件请求</span>
    INTERNAL_ERROR<span class="token punctuation">,</span>         <span class="token comment">//服务器内部错误，该结果在主状态机逻辑switch的default下，一般不会触发</span>
    CLOSED_CONNECTION       <span class="token comment">//请求不完整，需要继续读取请求报文数据</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="5-2-2-解析报文整体流程"><a href="#5-2-2-解析报文整体流程" class="headerlink" title="5.2.2 解析报文整体流程"></a>5.2.2 解析报文整体流程</h4><p>process_read通过while循环，将主从状态机进行封装，对报文的每一行进行循环处理。</p>
<ul>
<li><p>判断条件</p>
</li>
<li><ul>
<li>主状态机转移到CHECK_STATE_CONTENT，该条件涉及解析消息体<ul>
<li>从状态机转移到LINE_OK，该条件涉及解析请求行和请求头部</li>
<li>两者为或关系，当条件为真则继续循环，否则退出</li>
</ul>
</li>
</ul>
</li>
<li><p>循环体</p>
</li>
<li><ul>
<li>从状态机读取数据<ul>
<li>调用get_line函数，通过m_start_line将从状态机读取数据间接赋给text</li>
<li>主状态机解析text</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//m_start_line是已经解析的字符  //m_start_line是行在buffer中的起始位置，将该位置后面的数据赋给text</span>
<span class="token comment">//此时从状态机已提前将一行的末尾字符\r\n变为\0\0，所以text可以直接取出完整的行进行解析</span>
<span class="token comment">//get_line用于将指针向后偏移，指向未处理的字符</span>
<span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">get_line</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> m_read_buf <span class="token operator">+</span> m_start_line<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

http_conn<span class="token double-colon punctuation">::</span>HTTP_CODE http_conn<span class="token double-colon punctuation">::</span><span class="token function">process_read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//初始化从状态机状态、HTTP请求解析结果</span>
    LINE_STATUS line_status <span class="token operator">=</span> LINE_OK<span class="token punctuation">;</span>
    HTTP_CODE ret <span class="token operator">=</span> NO_REQUEST<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>text <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">//这里为什么要写两个判断条件？第一个判断条件为什么这样写？</span>
    <span class="token comment">//具体的在主状态机逻辑中会讲解。</span>
    <span class="token comment">//parse_line为从状态机的具体实现</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m_check_state <span class="token operator">==</span> CHECK_STATE_CONTENT <span class="token operator">&amp;&amp;</span> line_status <span class="token operator">==</span> LINE_OK<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>line_status <span class="token operator">=</span> <span class="token function">parse_line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> LINE_OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        text <span class="token operator">=</span> <span class="token function">get_line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//m_start_line是每一个数据行在m_read_buf中的起始位置</span>
        <span class="token comment">//m_checked_idx表示从状态机在m_read_buf中读取的位置</span>
        m_start_line <span class="token operator">=</span> m_checked_idx<span class="token punctuation">;</span>
        <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//主状态机的三种状态转移逻辑</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>m_check_state<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">case</span> CHECK_STATE_REQUESTLINE<span class="token operator">:</span>
            <span class="token punctuation">{</span>
                ret <span class="token operator">=</span> <span class="token function">parse_request_line</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//解析请求行</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> BAD_REQUEST<span class="token punctuation">)</span>
                    <span class="token keyword">return</span> BAD_REQUEST<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">case</span> CHECK_STATE_HEADER<span class="token operator">:</span>
            <span class="token punctuation">{</span>
                ret <span class="token operator">=</span> <span class="token function">parse_headers</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//解析请求头</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> BAD_REQUEST<span class="token punctuation">)</span>
                    <span class="token keyword">return</span> BAD_REQUEST<span class="token punctuation">;</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> GET_REQUEST<span class="token punctuation">)</span><span class="token punctuation">{</span>   <span class="token comment">//完整解析GET请求后，跳转到报文响应函数</span>
                    <span class="token keyword">return</span> <span class="token function">do_request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">case</span> CHECK_STATE_CONTENT<span class="token operator">:</span>
            <span class="token punctuation">{</span>
                ret <span class="token operator">=</span> <span class="token function">parse_content</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//解析消息体</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> GET_REQUEST<span class="token punctuation">)</span>     <span class="token comment">//完整解析POST请求后，跳转到报文响应函数</span>
                    <span class="token keyword">return</span> <span class="token function">do_request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                line_status <span class="token operator">=</span> LINE_OPEN<span class="token punctuation">;</span>    <span class="token comment">//解析完消息体即完成报文解析，避免再次进入循环，更新line_status</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">return</span> INTERNAL_ERROR<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> NO_REQUEST<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="5-2-3-从状态机逻辑"><a href="#5-2-3-从状态机逻辑" class="headerlink" title="5.2.3 从状态机逻辑"></a>5.2.3 从状态机逻辑</h4><p>上一篇的基础知识讲解中，对于HTTP报文的讲解遗漏了一点细节，在这里作为补充。</p>
<p><strong>在HTTP报文中，每一行的数据由\r\n作为结束字符，空行则是仅仅是字符\r\n。因此，可以通过查找\r\n将报文拆解成单独的行进行解析，项目中便是利用了这一点。</strong></p>
<p>从状态机负责读取buffer中的数据，将每行数据末尾的\r\n置为\0\0，并更新从状态机在buffer中读取的位置m_checked_idx，以此来驱动主状态机解析。</p>
<ul>
<li><p>从状态机从m_read_buf中逐字节读取，判断当前字节是否为\r</p>
</li>
<li><ul>
<li>接下来的字符是\n，将\r\n修改成\0\0，将<strong>m_checked_idx指向下一行的开头</strong>，则返回LINE_OK<ul>
<li>接下来达到了buffer末尾，表示buffer还需要继续接收，返回LINE_OPEN</li>
<li>否则，表示语法错误，返回LINE_BAD</li>
</ul>
</li>
</ul>
</li>
<li><p>当前字节不是\r，判断是否是\n（<strong>一般是上次读取到\r就到了buffer末尾，没有接收完整，再次接收时会出现这种情况</strong>）</p>
</li>
<li><ul>
<li>如果前一个字符是\r，则将\r\n修改成\0\0，将m_checked_idx指向下一行的开头，则返回LINE_OK</li>
</ul>
</li>
<li><p>当前字节既不是\r，也不是\n</p>
</li>
<li><ul>
<li>表示接收不完整，需要继续接收，返回LINE_OPEN</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//从状态机，用于分析出一行内容</span>
<span class="token comment">//返回值为行的读取状态，有LINE_OK,LINE_BAD,LINE_OPEN</span>
http_conn<span class="token double-colon punctuation">::</span>LINE_STATUS http_conn<span class="token double-colon punctuation">::</span><span class="token function">parse_line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//m_read_idx指向缓冲区m_read_buf的数据末尾的下一个字节</span>
    <span class="token comment">//m_checked_idx指向从状态机当前正在分析的字节</span>
    <span class="token keyword">char</span> temp<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> m_checked_idx <span class="token operator">&lt;</span> m_read_idx<span class="token punctuation">;</span> <span class="token operator">++</span>m_checked_idx<span class="token punctuation">)</span>    <span class="token punctuation">{</span>
        temp <span class="token operator">=</span> m_read_buf<span class="token punctuation">[</span>m_checked_idx<span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">//temp为将要分析的字节</span>
        
        <span class="token comment">//如果当前是\r字符，则有可能会读取到完整行</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token char">'\r'</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//从状态机 LINE_OK-完整读取一行  LINE_BAD-报文语法有误  LINE_OPEN-读取的行不完整</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m_checked_idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> m_read_idx<span class="token punctuation">)</span>  <span class="token comment">//下一个字符达到了buffer结尾，则接收不完整，需要继续接收</span>
                <span class="token keyword">return</span> LINE_OPEN<span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>m_read_buf<span class="token punctuation">[</span>m_checked_idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//下一个字符是\n，将\r\n改为\0\0</span>
                m_read_buf<span class="token punctuation">[</span>m_checked_idx<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
                m_read_buf<span class="token punctuation">[</span>m_checked_idx<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> LINE_OK<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> LINE_BAD<span class="token punctuation">;</span><span class="token comment">//如果都不符合，则返回语法错误</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//如果当前字符是\n，也有可能读取到完整行</span>
        <span class="token comment">//一般是上次读取到\r就到buffer末尾了，没有接收完整，再次接收时会出现这种情况</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token char">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>m_checked_idx <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> m_read_buf<span class="token punctuation">[</span>m_checked_idx <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'\r'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment">//前一个字符是\r，则接收完整</span>
                m_read_buf<span class="token punctuation">[</span>m_checked_idx <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
                m_read_buf<span class="token punctuation">[</span>m_checked_idx<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> LINE_OK<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> LINE_BAD<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> LINE_OPEN<span class="token punctuation">;</span>   <span class="token comment">//并没有找到\r\n，需要继续接收</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="5-2-4-主状态机逻辑"><a href="#5-2-4-主状态机逻辑" class="headerlink" title="5.2.4 主状态机逻辑"></a>5.2.4 主状态机逻辑</h4><p>主状态机初始状态是<code>CHECK_STATE_REQUESTLINE</code>，通过调用从状态机来驱动主状态机，在主状态机进行解析前，从状态机已经将每一行的末尾\r\n符号改为\0\0，以便于主状态机直接取出对应字符串进行处理。</p>
<ul>
<li><p><code>CHECK_STATE_REQUESTLINE</code></p>
</li>
<li><ul>
<li>主状态机的初始状态，调用parse_request_line函数解析请求行<ul>
<li>解析函数从m_read_buf中解析HTTP请求行，获得请求方法、目标URL及HTTP版本号</li>
<li>解析完成后主状态机的状态变为<code>CHECK_STATE_HEADER</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//解析http请求行，获得请求方法，目标url及http版本号  </span>
http_conn<span class="token double-colon punctuation">::</span>HTTP_CODE http_conn<span class="token double-colon punctuation">::</span><span class="token function">parse_request_line</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>text<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//在HTTP报文中，请求行用来说明请求类型,要访问的资源以及所使用的HTTP版本，其中各个部分之间通过\t或空格分隔。</span>
    <span class="token comment">//请求行中最先含有空格和\t任一字符的位置并返回</span>
    m_url <span class="token operator">=</span> <span class="token function">strpbrk</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token string">" \t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_url<span class="token punctuation">)</span> <span class="token keyword">return</span> BAD_REQUEST<span class="token punctuation">;</span><span class="token comment">//如果没有空格或\t，则报文格式有误</span>
    <span class="token operator">*</span>m_url<span class="token operator">++</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>                <span class="token comment">//将该位置改为\0，用于将前面数据取出</span>
    
    <span class="token comment">//取出数据，并通过与GET和POST比较，以确定请求方式</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>method <span class="token operator">=</span> text<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcasecmp</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token string">"GET"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        m_method <span class="token operator">=</span> GET<span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcasecmp</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token string">"POST"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        m_method <span class="token operator">=</span> POST<span class="token punctuation">;</span>
        cgi <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
        <span class="token keyword">return</span> BAD_REQUEST<span class="token punctuation">;</span>

    <span class="token comment">//m_url此时跳过了第一个空格或\t字符，但不知道之后是否还有</span>
    <span class="token comment">//将m_url向后偏移，通过查找，继续跳过空格和\t字符，指向请求资源的第一个字符</span>
    m_url <span class="token operator">+=</span> <span class="token function">strspn</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span> <span class="token string">" \t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//使用与判断请求方式的相同逻辑，判断HTTP版本号</span>
    m_version <span class="token operator">=</span> <span class="token function">strpbrk</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span> <span class="token string">" \t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_version<span class="token punctuation">)</span>
        <span class="token keyword">return</span> BAD_REQUEST<span class="token punctuation">;</span>
    <span class="token operator">*</span>m_version<span class="token operator">++</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
    m_version <span class="token operator">+=</span> <span class="token function">strspn</span><span class="token punctuation">(</span>m_version<span class="token punctuation">,</span> <span class="token string">" \t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcasecmp</span><span class="token punctuation">(</span>m_version<span class="token punctuation">,</span> <span class="token string">"HTTP/1.1"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//仅支持HTTP/1.1</span>
        <span class="token keyword">return</span> BAD_REQUEST<span class="token punctuation">;</span>

    <span class="token comment">//对请求资源前7个字符进行判断</span>
    <span class="token comment">//这里主要是有些报文的请求资源中会带有http://，这里需要对这种情况进行单独处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncasecmp</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span> <span class="token string">"http://"</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        m_url <span class="token operator">+=</span> <span class="token number">7</span><span class="token punctuation">;</span>
        m_url <span class="token operator">=</span> <span class="token function">strchr</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span> <span class="token char">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncasecmp</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span> <span class="token string">"https://"</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//同样增加https情况</span>
        m_url <span class="token operator">+=</span> <span class="token number">8</span><span class="token punctuation">;</span>
        m_url <span class="token operator">=</span> <span class="token function">strchr</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span> <span class="token char">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//一般的不会带有上述两种符号，直接是单独的/或/后面带访问资源</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_url <span class="token operator">||</span> m_url<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token char">'/'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> BAD_REQUEST<span class="token punctuation">;</span>
    <span class="token comment">//当url为/时，显示判断界面</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>m_url<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">strcat</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span> <span class="token string">"judge.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//请求行处理完毕，将主状态机转移处理请求头</span>
    m_check_state <span class="token operator">=</span> CHECK_STATE_HEADER<span class="token punctuation">;</span>
    <span class="token keyword">return</span> NO_REQUEST<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>解析完请求行后，主状态机继续分析请求头。在报文中，请求头和空行的处理使用的同一个函数，这里通过判断当前的text首位是不是\0字符，若是，则表示当前处理的是空行，若不是，则表示当前处理的是请求头。</p>
<ul>
<li><p>CHECK_STATE_HEADER</p>
</li>
<li><ul>
<li>调用parse_headers函数解析请求头部信息<ul>
<li>判断是空行还是请求头，若是空行，进而判断content-length是否为0，如果不是0，表明是POST请求，则状态转移到CHECK_STATE_CONTENT，否则说明是GET请求，则报文解析结束。</li>
<li>若解析的是请求头部字段，则主要分析connection字段，content-length字段，其他字段可以直接跳过，各位也可以根据需求继续分析。</li>
<li>connection字段判断是keep-alive还是close，决定是长连接还是短连接</li>
<li>content-length字段，这里用于读取post请求的消息体长度</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//解析http请求的一个头部信息</span>
http_conn<span class="token double-colon punctuation">::</span>HTTP_CODE http_conn<span class="token double-colon punctuation">::</span><span class="token function">parse_headers</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>text<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>text<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>           <span class="token comment">//判断是空行还是请求头</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m_content_length <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//判断是GET还是POST请求</span>
            
            <span class="token comment">//判断是GET还是POST请求</span>
            m_check_state <span class="token operator">=</span> CHECK_STATE_CONTENT<span class="token punctuation">;</span>    <span class="token comment">//POST需要跳转到消息体处理状态</span>
            <span class="token keyword">return</span> NO_REQUEST<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> GET_REQUEST<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//解析请求头部连接字段</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncasecmp</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token string">"Connection:"</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        text <span class="token operator">+=</span> <span class="token number">11</span><span class="token punctuation">;</span>
        text <span class="token operator">+=</span> <span class="token function">strspn</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token string">" \t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcasecmp</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token string">"keep-alive"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            m_linger <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//解析请求头部内容长度字段</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncasecmp</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token string">"Content-length:"</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        text <span class="token operator">+=</span> <span class="token number">15</span><span class="token punctuation">;</span>
        text <span class="token operator">+=</span> <span class="token function">strspn</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token string">" \t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        m_content_length <span class="token operator">=</span> <span class="token function">atol</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//解析请求头部HOST字段</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncasecmp</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token string">"Host:"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        text <span class="token operator">+=</span> <span class="token number">5</span><span class="token punctuation">;</span>
        text <span class="token operator">+=</span> <span class="token function">strspn</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token string">" \t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        m_host <span class="token operator">=</span> text<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"oop!unknow header: %s"</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> NO_REQUEST<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果仅仅是GET请求，如项目中的欢迎界面，那么主状态机只设置之前的两个状态足矣。</p>
<p>因为在上篇推文中我们曾说道，GET和POST请求报文的区别之一是有无消息体部分，GET请求没有消息体，当解析完空行之后，便完成了报文的解析。</p>
<p>但后续的登录和注册功能，为了避免将用户名和密码直接暴露在URL中，我们在项目中改用了POST请求，将用户名和密码添加在报文中作为消息体进行了封装。</p>
<p>为此，我们需要在解析报文的部分添加解析消息体的模块。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m_check_state <span class="token operator">==</span> CHECK_STATE_CONTENT <span class="token operator">&amp;&amp;</span> line_status <span class="token operator">==</span> LINE_OK<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>line_status <span class="token operator">=</span> <span class="token function">parse_line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> LINE_OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>那么，这里的判断条件为什么要写成这样呢？</strong></p>
<p>在GET请求报文中，每一行都是\r\n作为结束，所以对报文进行拆解时，仅用从状态机的状态<code>line_status=parse_line())==LINE_OK</code>语句即可。</p>
<p>但，在POST请求报文中，消息体的末尾没有任何字符，所以不能使用从状态机的状态，这里转而使用主状态机的状态作为循环入口条件。</p>
<p><strong>那后面的<code>&amp;&amp; line_status==LINE_OK</code>又是为什么？</strong></p>
<p>解析完消息体后，报文的完整解析就完成了，但此时主状态机的状态还是<code>CHECK_STATE_CONTENT</code>，也就是说，符合循环入口条件，还会再次进入循环，这并不是我们所希望的。</p>
<p>为此，增加了该语句，并在完成消息体解析后，将line_status变量更改为LINE_OPEN，此时可以跳出循环，完成报文解析任务。</p>
<ul>
<li><p><code>CHECK_STATE_CONTENT</code></p>
</li>
<li><ul>
<li>仅用于解析POST请求，调用parse_content函数解析消息体<ul>
<li>用于保存post请求消息体，为后面的登录和注册做准备</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//判断http请求是否被完整读入</span>
http_conn<span class="token double-colon punctuation">::</span>HTTP_CODE http_conn<span class="token double-colon punctuation">::</span><span class="token function">parse_content</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>text<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_read_idx <span class="token operator">&gt;=</span> <span class="token punctuation">(</span>m_content_length <span class="token operator">+</span> m_checked_idx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">//判断buffer中是否读取了消息体</span>
        text<span class="token punctuation">[</span>m_content_length<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
        <span class="token comment">//POST请求中最后为输入的用户名和密码</span>
        m_string <span class="token operator">=</span> text<span class="token punctuation">;</span>
        <span class="token keyword">return</span> GET_REQUEST<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> NO_REQUEST<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="06-http连接处理（下）"><a href="#06-http连接处理（下）" class="headerlink" title="06 http连接处理（下）"></a>06 http连接处理（下）</h2><p>上一篇详解中，我们对状态机和服务器解析请求报文进行了介绍。</p>
<p>本篇，我们将介绍服务器如何响应请求报文，并将该报文发送给浏览器端。首先介绍一些基础API，然后结合流程图和代码对服务器响应请求报文进行详解。</p>
<p><strong>基础API部分</strong>，介绍<code>stat</code>、<code>mmap</code>、<code>iovec</code>、<code>writev</code>。</p>
<p><strong>流程图部分</strong>，描述服务器端响应请求报文的逻辑，各模块间的关系。</p>
<p><strong>代码部分</strong>，结合代码对服务器响应请求报文进行详解。</p>
<h3 id="6-1-基础API"><a href="#6-1-基础API" class="headerlink" title="6.1 基础API"></a>6.1 基础API</h3><p>为了更好的源码阅读体验，这里提前对代码中使用的一些API进行简要介绍，更丰富的用法可以自行查阅资料。</p>
<h4 id="6-1-1-stat"><a href="#6-1-1-stat" class="headerlink" title="6.1.1 stat"></a>6.1.1 stat</h4><p>stat函数用于取得指定文件的文件属性，并将文件属性存储在结构体stat里，这里仅对其中用到的成员进行介绍。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token comment">//获取文件属性，存储在statbuf中</span>
<span class="token keyword">int</span> <span class="token function">stat</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">stat</span> <span class="token operator">*</span>statbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        作用：获取一个文件相关的一些信息
        参数<span class="token operator">:</span>
            <span class="token operator">-</span> pathname：操作的文件的路径
            <span class="token operator">-</span> statbuf：结构体变量，传出参数，用于保存获取到的文件的信息
        返回值：
            成功：返回<span class="token number">0</span>
            失败：返回<span class="token operator">-</span><span class="token number">1</span> 设置errno
                
<span class="token comment">//作用：获取一个软连接文件（不包含链接的文件）相关的一些信息</span>
    <span class="token keyword">int</span> <span class="token function">lstat</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">stat</span> <span class="token operator">*</span>statbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>	
        参数<span class="token operator">:</span>
            <span class="token operator">-</span> pathname：操作的文件的路径
            <span class="token operator">-</span> statbuf：结构体变量，传出参数，用于保存获取到的文件的信息
        返回值：
            成功：返回<span class="token number">0</span>
            失败：返回<span class="token operator">-</span><span class="token number">1</span> 设置errno

<span class="token keyword">struct</span> <span class="token class-name">stat</span> <span class="token punctuation">{</span>
    mode_t    st_mode<span class="token punctuation">;</span>        <span class="token comment">/* 文件类型和权限 */</span>
    off_t     st_size<span class="token punctuation">;</span>        <span class="token comment">/* 文件大小，字节数*/</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="6-1-2-mmap"><a href="#6-1-2-mmap" class="headerlink" title="6.1.2 mmap"></a>6.1.2 mmap</h4><p>用于将一个文件或其他对象映射到内存，提高文件的访问速度。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h&gt;</span></span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> size_t length<span class="token punctuation">,</span> <span class="token keyword">int</span> prot<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> off_t offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">-</span> 功能：将一个文件或者设备的数据映射到内存中
    <span class="token operator">-</span> 参数：
    	<span class="token operator">-</span> addr<span class="token operator">:</span> 映射区的开始地址   指定<span class="token constant">NULL</span><span class="token punctuation">,</span> 由内核指定
        <span class="token operator">-</span> length <span class="token operator">:</span> 要映射的数据的长度，这个值不能为<span class="token number">0</span>。建议使用文件的长度。
            		获取文件的长度：stat lseek（如果文件太小，其大小会是分页的整数倍）
        <span class="token operator">-</span> prot <span class="token operator">:</span> 对申请的内存映射区的操作权限
                <span class="token operator">-</span>PROT_EXEC ：可执行的权限
                <span class="token operator">-</span>PROT_READ ：读权限
                <span class="token operator">-</span>PROT_WRITE ：写权限
                <span class="token operator">-</span>PROT_NONE ：没有权限
                要操作映射内存，必须要有读的权限。PROT_READ、PROT_READ<span class="token operator">|</span>PROT_WRITE
         <span class="token operator">-</span> flags <span class="token operator">:</span>
			<span class="token operator">-</span> MAP_SHARED <span class="token operator">:</span> 映射区的数据会自动和磁盘文件进行同步，进程间通信，必须要设置这个选项
    		<span class="token operator">-</span> MAP_PRIVATE ：不同步，内存映射区的数据改变了，对原来的文件不会修改，会重新创建一个新的文件。（copy on write）
    	<span class="token operator">-</span> fd<span class="token operator">:</span> 需要映射的那个文件的文件描述符
        	<span class="token operator">-</span> 通过open得到，open的是一个磁盘文件
        	<span class="token operator">-</span> 注意：文件的大小不能为<span class="token number">0</span>，open指定的权限不能和prot参数有冲突。
        		prot<span class="token operator">:</span> PROT_READ               open<span class="token operator">:</span>只读<span class="token operator">/</span>读写 
            	prot<span class="token operator">:</span> PROT_READ <span class="token operator">|</span> PROT_WRITE   open<span class="token operator">:</span>读写
         <span class="token operator">-</span> offset：偏移量，一般不用。必须指定的是<span class="token number">4</span>k的整数倍，<span class="token number">0</span>表示不偏移。
         <span class="token operator">-</span> 返回值：返回创建的内存的首地址
           失败返回MAP_FAILED，<span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token number">1</span>   ——一个宏

<span class="token keyword">int</span> <span class="token function">munmap</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> size_t length<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">-</span> 功能：释放内存映射
    <span class="token operator">-</span> 参数：
    	<span class="token operator">-</span> addr <span class="token operator">:</span> 要释放的内存的首地址
        <span class="token operator">-</span> length <span class="token operator">:</span> 要释放的内存的大小，要和mmap函数中的length参数的值一样。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="6-1-3-iovec"><a href="#6-1-3-iovec" class="headerlink" title="6.1.3 iovec"></a>6.1.3 iovec</h4><p>定义了一个向量元素，通常，这个结构用作一个多元素的数组。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">iovec</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span>      <span class="token operator">*</span>iov_base<span class="token punctuation">;</span>      <span class="token comment">/* iov_base指向数据的地址*/</span>
    size_t    iov_len<span class="token punctuation">;</span>        <span class="token comment">/* iov_len表示数据的长度*/</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="6-1-4-writev"><a href="#6-1-4-writev" class="headerlink" title="6.1.4 writev"></a>6.1.4 writev</h4><p>writev函数用于在一次函数调用中写多个非连续缓冲区，有时也将这该函数称为聚集写。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/uio.h&gt;</span></span>
ssize_t <span class="token function">writev</span><span class="token punctuation">(</span><span class="token keyword">int</span> filedes<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">iovec</span> <span class="token operator">*</span>iov<span class="token punctuation">,</span> <span class="token keyword">int</span> iovcnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">-</span> filedes表示文件描述符
    <span class="token operator">-</span> iov为前述io向量机制结构体iovec
    <span class="token operator">-</span> iovcnt为结构体的个数
    若成功则返回已写的字节数，
    若出错则返回<span class="token operator">-</span><span class="token number">1</span>。
`writev`以顺序`iov<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>`，`iov<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>`至`iov<span class="token punctuation">[</span>iovcnt<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>`从缓冲区中聚集输出数据到文件描述符filedes。`writev`返回输出的字节总数，通常，它应等于所有缓冲区长度之和。（）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>特别注意：</strong>  <strong>循环调用writev时，需要重新处理iovec中的指针和长度，该函数不会对这两个成员做任何处理</strong>。writev的返回值为已写的字节数，但这个返回值“实用性”并不高，因为参数传入的是iovec数组，计量单位是iovcnt，而不是字节数，我们仍然需要通过遍历iovec来计算新的基址，另外写入数据的“结束点”可能位于一个iovec的中间某个位置，因此需要调整临界iovec的io_base和io_len。</p>
<h4 id="6-1-5-vsnprintf"><a href="#6-1-5-vsnprintf" class="headerlink" title="6.1.5 vsnprintf"></a>6.1.5 vsnprintf</h4><p>vsnprintf用来将可变参数格式化输出到一个字符数组，常和<a target="_blank" rel="noopener" href="https://blog.csdn.net/qlexcel/article/details/119033824">va_start和va_end</a>一起使用。</p>
<p>函数功能：将可变参数格式化输出到一个字符数组。</p>
<blockquote>
<p>注意：<br>在linux环境下是:vsnprintf<br>但在VC6环境下是:_vsnprintf</p>
</blockquote>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdarg.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">vsnprintf</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>str<span class="token punctuation">,</span> size_t size<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>format<span class="token punctuation">,</span> va_list ap<span class="token punctuation">)</span><span class="token punctuation">;</span>
参数：
    str<span class="token operator">-</span>保存输出字符数组的存储区。
    size<span class="token operator">-</span>存储区的大小。
    format<span class="token operator">-</span>包含格式字符串的C字符串，其格式字符串与printf中的格式相同
    arg<span class="token operator">-</span>变量参数列表，用va_list 定义。
    返回值：
    	执行成功，返回最终生成字符串的长度，若生成字符串的长度大于size，则将字符串的前size个字符复制到str，同时将原串的长度返回（不包含终止符）；执行失败，返回负值，并置errno<span class="token punctuation">.</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdarg.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAXLEN</span> <span class="token expression"><span class="token number">20</span></span></span>
<span class="token keyword">char</span> buffer<span class="token punctuation">[</span>MAXLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">mon_log</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

    va_list vArgList<span class="token punctuation">;</span>                           
    <span class="token function">va_start</span> <span class="token punctuation">(</span>vArgList<span class="token punctuation">,</span> format<span class="token punctuation">)</span><span class="token punctuation">;</span>      	
    i<span class="token operator">=</span><span class="token function">_vsnprintf</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> MAXLEN<span class="token punctuation">,</span> format<span class="token punctuation">,</span> vArgList<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/*把可变参数表中的数据转成字符存到buffer中，每个参数间用','隔开 */</span> 
    <span class="token function">va_end</span><span class="token punctuation">(</span>vArgList<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\r\n"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>   
    <span class="token keyword">for</span><span class="token punctuation">(</span>j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span>MAXLEN<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>  <span class="token comment">/*打印buffer中每个字符的值 */</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d  "</span><span class="token punctuation">,</span> buffer<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> i<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>   
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>MAXLEN<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
        buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">;</span>
    i<span class="token operator">=</span><span class="token function">mon_log</span><span class="token punctuation">(</span><span class="token string">"%s,%d,%d,%c"</span><span class="token punctuation">,</span><span class="token string">"abc"</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token char">'4'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"return value1=%d\r\n\r\n"</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>

    i<span class="token operator">=</span><span class="token function">mon_log</span><span class="token punctuation">(</span><span class="token string">"para1:%s,%d,%d,%c"</span><span class="token punctuation">,</span><span class="token string">"123"</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token char">'4'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"return value2=%d\r\n\r\n"</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>

    i<span class="token operator">=</span><span class="token function">mon_log</span><span class="token punctuation">(</span><span class="token string">"%s,%d,%d,last=%c\r\n"</span><span class="token punctuation">,</span><span class="token string">"abc"</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token char">'4'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"return value3=%d\r\n\r\n"</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token comment">//输出</span>
abc<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span>
<span class="token number">97</span>  <span class="token number">98</span>  <span class="token number">99</span>  <span class="token number">44</span>  <span class="token number">50</span>  <span class="token number">44</span>  <span class="token number">51</span>  <span class="token number">44</span>  <span class="token number">52</span>  <span class="token number">0</span>  <span class="token number">100</span>  <span class="token number">100</span>  <span class="token number">100</span>  <span class="token number">100</span>  <span class="token number">100</span>  <span class="token number">100</span>  <span class="token number">100</span>  <span class="token number">100</span>  <span class="token number">100</span>  <span class="token number">100</span>
<span class="token keyword">return</span> value1<span class="token operator">=</span><span class="token number">9</span>

para1<span class="token operator">:</span><span class="token number">123</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span>
<span class="token number">112</span>  <span class="token number">97</span>  <span class="token number">114</span>  <span class="token number">97</span>  <span class="token number">49</span>  <span class="token number">58</span>  <span class="token number">49</span>  <span class="token number">50</span>  <span class="token number">51</span>  <span class="token number">44</span>  <span class="token number">50</span>  <span class="token number">44</span>  <span class="token number">51</span>  <span class="token number">44</span>  <span class="token number">52</span>  <span class="token number">0</span>  <span class="token number">100</span>  <span class="token number">100</span>  <span class="token number">100</span>  <span class="token number">100</span>
<span class="token keyword">return</span> value2<span class="token operator">=</span><span class="token number">15</span>

abc<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>last<span class="token operator">=</span><span class="token number">4</span>

<span class="token number">97</span>  <span class="token number">98</span>  <span class="token number">99</span>  <span class="token number">44</span>  <span class="token number">50</span>  <span class="token number">44</span>  <span class="token number">51</span>  <span class="token number">44</span>  <span class="token number">108</span>  <span class="token number">97</span>  <span class="token number">115</span>  <span class="token number">116</span>  <span class="token number">61</span>  <span class="token number">52</span>  <span class="token number">13</span>  <span class="token number">10</span>  <span class="token number">0</span>  <span class="token number">100</span>  <span class="token number">100</span>  <span class="token number">100</span>
<span class="token keyword">return</span> value3<span class="token operator">=</span><span class="token number">16</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="6-1-6-sendfile"><a href="#6-1-6-sendfile" class="headerlink" title="6.1.6 sendfile"></a>6.1.6 sendfile</h4><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/sendfile.h&gt;</span></span>
ssize_t <span class="token function">sendfile</span><span class="token punctuation">(</span><span class="token keyword">int</span> out_fd<span class="token punctuation">,</span> <span class="token keyword">int</span> in_fd<span class="token punctuation">,</span> off_t <span class="token operator">*</span>offset<span class="token punctuation">,</span> size_t count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    out_fd是需要输出数据的fd；
    in_fd是需要获取数据的fd；
    offset是拷贝数据的起始点，如果是<span class="token constant">NULL</span>，则从头开始拷贝；
    count是拷贝的字节数。

  <span class="token keyword">int</span> readfd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> writefd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CREAT<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sendfile</span><span class="token punctuation">(</span>writefd<span class="token punctuation">,</span> readfd<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"sendfile() error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="6-2-流程图"><a href="#6-2-流程图" class="headerlink" title="6.2 流程图"></a>6.2 流程图</h3><p>浏览器端发出HTTP请求报文，服务器端接收该报文并调用<code>process_read</code>对其进行解析，根据解析结果<code>HTTP_CODE</code>，进入相应的逻辑和模块。</p>
<p>其中，服务器子线程完成报文的解析与响应；主线程监测读写事件，调用<code>read_once</code>和<code>http_conn::write</code>完成数据的读取与发送。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2023/cpp/image-20230315112234144.png" alt="image-20230315112234144"></p>
<h4 id="6-2-1-HTTP-CODE含义"><a href="#6-2-1-HTTP-CODE含义" class="headerlink" title="6.2.1 HTTP_CODE含义"></a>6.2.1 HTTP_CODE含义</h4><p>表示HTTP请求的处理结果，在头文件中初始化了八种情形，在报文解析与响应中只用到了七种。</p>
<ul>
<li><p>NO_REQUEST</p>
</li>
<li><ul>
<li>请求不完整，需要继续读取请求报文数据<ul>
<li>跳转主线程继续监测读事件</li>
</ul>
</li>
</ul>
</li>
<li><p>GET_REQUEST</p>
</li>
<li><ul>
<li>获得了完整的HTTP请求<ul>
<li>调用do_request完成请求资源映射</li>
</ul>
</li>
</ul>
</li>
<li><p>NO_RESOURCE</p>
</li>
<li><ul>
<li>请求资源不存在<ul>
<li>跳转process_write完成响应报文</li>
</ul>
</li>
</ul>
</li>
<li><p>BAD_REQUEST</p>
</li>
<li><ul>
<li>HTTP请求报文有语法错误或请求资源为目录<ul>
<li>跳转process_write完成响应报文</li>
</ul>
</li>
</ul>
</li>
<li><p>FORBIDDEN_REQUEST</p>
</li>
<li><ul>
<li>请求资源禁止访问，没有读取权限<ul>
<li>跳转process_write完成响应报文</li>
</ul>
</li>
</ul>
</li>
<li><p>FILE_REQUEST</p>
</li>
<li><ul>
<li>请求资源可以正常访问<ul>
<li>跳转process_write完成响应报文</li>
</ul>
</li>
</ul>
</li>
<li><p>INTERNAL_ERROR</p>
</li>
<li><ul>
<li>服务器内部错误，该结果在主状态机逻辑switch的default下，一般不会触发</li>
</ul>
</li>
</ul>
<h3 id="6-3-代码分析"><a href="#6-3-代码分析" class="headerlink" title="6.3 代码分析"></a>6.3 代码分析</h3><h4 id="6-3-1-do-request"><a href="#6-3-1-do-request" class="headerlink" title="6.3.1 do_request"></a>6.3.1 do_request</h4><p><code>process_read</code>函数的返回值是对请求的文件分析后的结果，一部分是语法错误导致的<code>BAD_REQUEST</code>，一部分是<code>do_request</code>的返回结果.该函数将网站根目录和<code>url</code>文件拼接，然后通过stat判断该文件属性。另外，为了提高访问速度，通过mmap进行映射，将普通文件映射到内存逻辑地址。</p>
<p>为了更好的理解请求资源的访问流程，这里对各种各页面跳转机制进行简要介绍。其中，浏览器网址栏中的字符，即<code>url</code>，可以将其抽象成<code>ip:port/xxx</code>，<code>xxx</code>通过<code>html</code>文件的<code>action</code>属性进行设置。</p>
<p>m_url为请求报文中解析出的请求资源，以/开头，也就是<code>/xxx</code>，项目中解析后的m_url有8种情况。</p>
<ul>
<li><p>/</p>
</li>
<li><ul>
<li>GET请求，跳转到judge.html，即欢迎访问页面</li>
</ul>
</li>
<li><p>/0</p>
</li>
<li><ul>
<li>POST请求，跳转到register.html，即注册页面</li>
</ul>
</li>
<li><p>/1</p>
</li>
<li><ul>
<li>POST请求，跳转到log.html，即登录页面</li>
</ul>
</li>
<li><p>/2CGISQL.cgi</p>
</li>
<li><ul>
<li>POST请求，进行登录校验<ul>
<li>验证成功跳转到welcome.html，即资源请求成功页面</li>
<li>验证失败跳转到logError.html，即登录失败页面</li>
</ul>
</li>
</ul>
</li>
<li><p>/3CGISQL.cgi</p>
</li>
<li><ul>
<li>POST请求，进行注册校验<ul>
<li>注册成功跳转到log.html，即登录页面</li>
<li>注册失败跳转到registerError.html，即注册失败页面</li>
</ul>
</li>
</ul>
</li>
<li><p>/5</p>
</li>
<li><ul>
<li>POST请求，跳转到picture.html，即图片请求页面</li>
</ul>
</li>
<li><p>/6</p>
</li>
<li><ul>
<li>POST请求，跳转到video.html，即视频请求页面</li>
</ul>
</li>
<li><p>/7</p>
</li>
<li><ul>
<li>POST请求，跳转到fans.html，即关注页面</li>
</ul>
</li>
</ul>
<p>如果大家对上述设置方式不理解，不用担心。具体的登录和注册校验功能会在第12节进行详解，到时候还会针对html进行介绍。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//root文件夹路径, //网站根目录，文件夹内存放请求的资源和跳转的html文件</span>
<span class="token keyword">char</span> server_path<span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">getcwd</span><span class="token punctuation">(</span>server_path<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//获取当前工作目录</span>
<span class="token keyword">char</span> root<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/root"</span><span class="token punctuation">;</span>
m_root <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>server_path<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">strlen</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">strcpy</span><span class="token punctuation">(</span>m_root<span class="token punctuation">,</span> server_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">strcat</span><span class="token punctuation">(</span>m_root<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>

http_conn<span class="token double-colon punctuation">::</span>HTTP_CODE http_conn<span class="token double-colon punctuation">::</span><span class="token function">do_request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//将初始化的m_real_file赋值为网站根目录</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>m_real_file<span class="token punctuation">,</span> doc_root<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>doc_root<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//printf("m_url:%s\n", m_url);</span>
    <span class="token comment">//找到m_url中/的位置</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span> <span class="token char">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//处理cgi</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cgi <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token char">'2'</span> <span class="token operator">||</span> <span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token char">'3'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token comment">//根据标志判断是登录检测还是注册检测</span>
        <span class="token keyword">char</span> flag <span class="token operator">=</span> m_url<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">char</span> <span class="token operator">*</span>m_url_real <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strcat</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">,</span> m_url <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strncpy</span><span class="token punctuation">(</span>m_real_file <span class="token operator">+</span> len<span class="token punctuation">,</span> m_url_real<span class="token punctuation">,</span> FILENAME_LEN <span class="token operator">-</span> len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//将用户名和密码提取出来</span>
        <span class="token comment">//user=123&amp;passwd=123</span>
        <span class="token keyword">char</span> name<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">,</span> password<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span> m_string<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token char">'&amp;'</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
            name<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> m_string<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        name<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span> m_string<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">,</span> <span class="token operator">++</span>j<span class="token punctuation">)</span>
            password<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> m_string<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        password<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token char">'3'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//如果是注册，先检测数据库中是否有重名的</span>
            <span class="token comment">//没有重名的，进行增加数据</span>
            <span class="token keyword">char</span> <span class="token operator">*</span>sql_insert <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">strcpy</span><span class="token punctuation">(</span>sql_insert<span class="token punctuation">,</span> <span class="token string">"INSERT INTO user(username, passwd) VALUES("</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">strcat</span><span class="token punctuation">(</span>sql_insert<span class="token punctuation">,</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">strcat</span><span class="token punctuation">(</span>sql_insert<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">strcat</span><span class="token punctuation">(</span>sql_insert<span class="token punctuation">,</span> <span class="token string">"', '"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">strcat</span><span class="token punctuation">(</span>sql_insert<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">strcat</span><span class="token punctuation">(</span>sql_insert<span class="token punctuation">,</span> <span class="token string">"')"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>users<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">==</span> users<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                m_lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">mysql_query</span><span class="token punctuation">(</span>mysql<span class="token punctuation">,</span> sql_insert<span class="token punctuation">)</span><span class="token punctuation">;</span>
                users<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">pair</span><span class="token generic class-name"><span class="token operator">&lt;</span>string<span class="token punctuation">,</span> string<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//在程序中存储用户名和密码</span>
                m_lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span>
                    <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span> <span class="token string">"/log.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span>
                    <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span> <span class="token string">"/registerError.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
                <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span> <span class="token string">"/registerError.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//如果是登录，直接判断</span>
        <span class="token comment">//若浏览器端输入的用户名和密码在表中可以查找到，返回1，否则返回0</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token char">'2'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>users<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">!=</span> users<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> users<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">==</span> password<span class="token punctuation">)</span>
                <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span> <span class="token string">"/welcome.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span> <span class="token string">"/logError.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
	
    <span class="token comment">//如果请求资源为/0，表示跳转注册界面</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token char">'0'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>m_url_real <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">,</span> <span class="token string">"/register.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">//将网站目录和/register.html进行拼接，更新到m_real_file中</span>
        <span class="token function">strncpy</span><span class="token punctuation">(</span>m_real_file <span class="token operator">+</span> len<span class="token punctuation">,</span> m_url_real<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//如果请求资源为/1，表示跳转登录界面</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token char">'1'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>m_url_real <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">,</span> <span class="token string">"/log.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//将网站目录和/log.html进行拼接，更新到m_real_file中</span>
        <span class="token function">strncpy</span><span class="token punctuation">(</span>m_real_file <span class="token operator">+</span> len<span class="token punctuation">,</span> m_url_real<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//如果请求资源为/5，表示访问图片界面</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token char">'5'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>m_url_real <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">,</span> <span class="token string">"/picture.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strncpy</span><span class="token punctuation">(</span>m_real_file <span class="token operator">+</span> len<span class="token punctuation">,</span> m_url_real<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token char">'6'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>m_url_real <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">,</span> <span class="token string">"/video.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strncpy</span><span class="token punctuation">(</span>m_real_file <span class="token operator">+</span> len<span class="token punctuation">,</span> m_url_real<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token char">'7'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>m_url_real <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">,</span> <span class="token string">"/fans.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strncpy</span><span class="token punctuation">(</span>m_real_file <span class="token operator">+</span> len<span class="token punctuation">,</span> m_url_real<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
        <span class="token comment">//如果以上均不符合，即不是登录和注册，直接将url与网站目录拼接</span>
        <span class="token comment">//这里的情况是welcome界面，请求服务器上的一个图片</span>
        <span class="token function">strncpy</span><span class="token punctuation">(</span>m_real_file <span class="token operator">+</span> len<span class="token punctuation">,</span> m_url<span class="token punctuation">,</span> FILENAME_LEN <span class="token operator">-</span> len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//通过stat获取请求资源文件信息，成功则将信息更新到m_file_stat结构体</span>
    <span class="token comment">//失败返回NO_RESOURCE状态，表示资源不存在</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stat</span><span class="token punctuation">(</span>m_real_file<span class="token punctuation">,</span> <span class="token operator">&amp;</span>m_file_stat<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>	<span class="token comment">//m_file_stat是输出参数</span>
        <span class="token keyword">return</span> NO_RESOURCE<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>m_file_stat<span class="token punctuation">.</span>st_mode <span class="token operator">&amp;</span> S_IROTH<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//判断文件的权限，是否可读，不可读则返回FORBIDDEN_REQUEST状态</span>
        <span class="token keyword">return</span> FORBIDDEN_REQUEST<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">S_ISDIR</span><span class="token punctuation">(</span>m_file_stat<span class="token punctuation">.</span>st_mode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//判断文件类型，如果是目录，则返回BAD_REQUEST，表示请求报文有误</span>
        <span class="token keyword">return</span> BAD_REQUEST<span class="token punctuation">;</span>

    <span class="token comment">//以只读方式获取文件描述符，通过mmap将该文件映射到内存中</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>m_real_file<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_file_address <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> m_file_stat<span class="token punctuation">.</span>st_size<span class="token punctuation">,</span> PROT_READ<span class="token punctuation">,</span> MAP_PRIVATE<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//避免文件描述符的浪费和占用</span>
    <span class="token keyword">return</span> FILE_REQUEST<span class="token punctuation">;</span>	<span class="token comment">//表示请求文件存在，且可以访问</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="6-3-2-process-write"><a href="#6-3-2-process-write" class="headerlink" title="6.3.2 process_write"></a>6.3.2 process_write</h4><p>根据<code>do_request</code>的返回状态，服务器子线程调用<code>process_write</code>向<code>m_write_buf</code>中写入响应报文。</p>
<ul>
<li><p>add_status_line函数，添加状态行：http/1.1 状态码 状态消息</p>
</li>
<li><p>add_headers函数添加消息报头，内部调用add_content_length和add_linger函数</p>
</li>
<li><ul>
<li>content-length记录响应报文长度，用于浏览器端判断服务器是否发送完数据<ul>
<li>connection记录连接状态，用于告诉浏览器端保持长连接</li>
</ul>
</li>
</ul>
</li>
<li><p>add_blank_line添加空行</p>
</li>
</ul>
<p>上述涉及的5个函数，均是内部调用<code>add_response</code>函数更新<code>m_write_idx</code>指针和缓冲区<code>m_write_buf</code>中的内容。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">bool</span> http_conn<span class="token double-colon punctuation">::</span><span class="token function">add_response</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_write_idx <span class="token operator">&gt;=</span> WRITE_BUFFER_SIZE<span class="token punctuation">)</span>   <span class="token comment">//如果写入内容超出m_write_buf大小则报错</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    va_list arg_list<span class="token punctuation">;</span>               <span class="token comment">//定义可变参数列表</span>
    <span class="token function">va_start</span><span class="token punctuation">(</span>arg_list<span class="token punctuation">,</span> format<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//将变量arg_list初始化为传入参数</span>
    <span class="token comment">//将数据format从可变参数列表写入缓冲区写，返回写入数据的长度</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">vsnprintf</span><span class="token punctuation">(</span>m_write_buf <span class="token operator">+</span> m_write_idx<span class="token punctuation">,</span> WRITE_BUFFER_SIZE <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> m_write_idx<span class="token punctuation">,</span> format<span class="token punctuation">,</span> arg_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果写入的数据长度超过缓冲区剩余空间，则报错</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&gt;=</span> <span class="token punctuation">(</span>WRITE_BUFFER_SIZE <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> m_write_idx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">va_end</span><span class="token punctuation">(</span>arg_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    m_write_idx <span class="token operator">+=</span> len<span class="token punctuation">;</span><span class="token comment">//更新m_write_idx位置</span>
    <span class="token function">va_end</span><span class="token punctuation">(</span>arg_list<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//清空可变参列表</span>

    <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"request:%s"</span><span class="token punctuation">,</span> m_write_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">bool</span> http_conn<span class="token double-colon punctuation">::</span><span class="token function">add_status_line</span><span class="token punctuation">(</span><span class="token keyword">int</span> status<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>title<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//添加消息报头，具体的添加文本长度、连接状态和空行</span>
    <span class="token keyword">return</span> <span class="token function">add_response</span><span class="token punctuation">(</span><span class="token string">"%s %d %s\r\n"</span><span class="token punctuation">,</span> <span class="token string">"HTTP/1.1"</span><span class="token punctuation">,</span> status<span class="token punctuation">,</span> title<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">bool</span> http_conn<span class="token double-colon punctuation">::</span><span class="token function">add_headers</span><span class="token punctuation">(</span><span class="token keyword">int</span> content_len<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//添加Content-Length，表示响应报文的长度</span>
    <span class="token keyword">return</span> <span class="token function">add_content_length</span><span class="token punctuation">(</span>content_len<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">add_linger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">add_blank_line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">bool</span> http_conn<span class="token double-colon punctuation">::</span><span class="token function">add_content_length</span><span class="token punctuation">(</span><span class="token keyword">int</span> content_len<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//添加文本类型，这里是html</span>
    <span class="token keyword">return</span> <span class="token function">add_response</span><span class="token punctuation">(</span><span class="token string">"Content-Length:%d\r\n"</span><span class="token punctuation">,</span> content_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">bool</span> http_conn<span class="token double-colon punctuation">::</span><span class="token function">add_content_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//添加文本类型，这里是html</span>
    <span class="token keyword">return</span> <span class="token function">add_response</span><span class="token punctuation">(</span><span class="token string">"Content-Type:%s\r\n"</span><span class="token punctuation">,</span> <span class="token string">"text/html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">bool</span> http_conn<span class="token double-colon punctuation">::</span><span class="token function">add_linger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//添加连接状态，通知浏览器端是保持连接还是关闭</span>
    <span class="token keyword">return</span> <span class="token function">add_response</span><span class="token punctuation">(</span><span class="token string">"Connection:%s\r\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>m_linger <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"keep-alive"</span> <span class="token operator">:</span> <span class="token string">"close"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">bool</span> http_conn<span class="token double-colon punctuation">::</span><span class="token function">add_blank_line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//添加空行</span>
    <span class="token keyword">return</span> <span class="token function">add_response</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">bool</span> http_conn<span class="token double-colon punctuation">::</span><span class="token function">add_content</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>content<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//添加文本content</span>
    <span class="token keyword">return</span> <span class="token function">add_response</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>响应报文分为两种，一种是请求文件的存在，通过<code>io</code>向量机制<code>iovec</code>，声明两个<code>iovec</code>，第一个指向<code>m_write_buf</code>，第二个指向<code>mmap</code>的地址<code>m_file_address</code>；一种是请求出错，这时候只申请一个<code>iovec</code>，指向<code>m_write_buf</code>。</p>
<ul>
<li>iovec是一个结构体，里面有两个元素，指针成员iov_base指向一个缓冲区，这个缓冲区是存放的是writev将要发送的数据。</li>
<li>成员iov_len表示实际写入的长度</li>
</ul>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">bool</span> http_conn<span class="token double-colon punctuation">::</span><span class="token function">process_write</span><span class="token punctuation">(</span>HTTP_CODE ret<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>    <span class="token punctuation">{</span>
        <span class="token keyword">case</span> INTERNAL_ERROR<span class="token operator">:</span><span class="token comment">//内部错误，500</span>
        <span class="token punctuation">{</span>
            <span class="token function">add_status_line</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> error_500_title<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//状态行</span>
            <span class="token function">add_headers</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>error_500_form<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//消息报头</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">add_content</span><span class="token punctuation">(</span>error_500_form<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">case</span> BAD_REQUEST<span class="token operator">:</span><span class="token comment">//报文语法有误，404</span>
        <span class="token punctuation">{</span>
            <span class="token function">add_status_line</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> error_404_title<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">add_headers</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>error_404_form<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">add_content</span><span class="token punctuation">(</span>error_404_form<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">case</span> FORBIDDEN_REQUEST<span class="token operator">:</span><span class="token comment">//资源没有访问权限，403</span>
        <span class="token punctuation">{</span>
            <span class="token function">add_status_line</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">,</span> error_403_title<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">add_headers</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>error_403_form<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">add_content</span><span class="token punctuation">(</span>error_403_form<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">case</span> FILE_REQUEST<span class="token operator">:</span><span class="token comment">//文件存在，200</span>
        <span class="token punctuation">{</span>
            <span class="token function">add_status_line</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> ok_200_title<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>m_file_stat<span class="token punctuation">.</span>st_size <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//如果请求的资源存在</span>
                <span class="token function">add_headers</span><span class="token punctuation">(</span>m_file_stat<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
                m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base <span class="token operator">=</span> m_write_buf<span class="token punctuation">;</span><span class="token comment">//第一个iovec指针指向响应报文缓冲区，长度指向m_write_idx</span>
                m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">=</span> m_write_idx<span class="token punctuation">;</span>
                m_iv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base <span class="token operator">=</span> m_file_address<span class="token punctuation">;</span><span class="token comment">//第二个iovec指针指向mmap返回的文件指针，长度指向文件大小</span>
                m_iv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">=</span> m_file_stat<span class="token punctuation">.</span>st_size<span class="token punctuation">;</span>
                m_iv_count <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
                bytes_to_send <span class="token operator">=</span> m_write_idx <span class="token operator">+</span> m_file_stat<span class="token punctuation">.</span>st_size<span class="token punctuation">;</span><span class="token comment">//发送的全部数据为响应报文头部信息和文件大小</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>                <span class="token comment">//如果请求的资源大小为0，则返回空白html文件</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>ok_string <span class="token operator">=</span> <span class="token string">"&lt;html&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;"</span><span class="token punctuation">;</span>
                <span class="token function">add_headers</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>ok_string<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">add_content</span><span class="token punctuation">(</span>ok_string<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//除FILE_REQUEST状态外，其余状态只申请一个iovec，指向响应报文缓冲区</span>
    m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base <span class="token operator">=</span> m_write_buf<span class="token punctuation">;</span>
    m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">=</span> m_write_idx<span class="token punctuation">;</span>
    m_iv_count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    bytes_to_send <span class="token operator">=</span> m_write_idx<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="6-3-3-http-conn-write（可更新sendfile）"><a href="#6-3-3-http-conn-write（可更新sendfile）" class="headerlink" title="6.3.3 http_conn::write（可更新sendfile）"></a>6.3.3 http_conn::write（可更新sendfile）</h4><p>服务器<strong>子线程调用<code>process_write</code>完成响应报文，随后注册<code>epollout</code>事件</strong>。服务器<strong>主线程检测写事件</strong>，<strong>并调用<code>http_conn::write</code>函数将响应报文发送给浏览器端</strong>。</p>
<p>该函数具体逻辑如下：</p>
<p>在生成响应报文时初始化byte_to_send，包括头部信息和文件数据大小。通过writev函数循环发送响应报文数据，根据返回值更新byte_have_send和iovec结构体的指针和长度，并判断响应报文整体是否发送成功。</p>
<ul>
<li><p>若writev单次发送成功，更新byte_to_send和byte_have_send的大小，若响应报文整体发送成功,则取消mmap映射,并判断是否是长连接.</p>
</li>
<li><ul>
<li>长连接重置http类实例，注册读事件，不关闭连接，<ul>
<li>短连接直接关闭连接</li>
</ul>
</li>
</ul>
</li>
<li><p>若writev单次发送不成功，判断是否是写缓冲区满了。</p>
</li>
<li><ul>
<li>若不是因为缓冲区满了而失败，取消mmap映射，关闭连接<ul>
<li>若eagain则满了，更新iovec结构体的指针和长度，并注册写事件，等待下一次写事件触发（当写缓冲区从不可写变为可写，触发epollout），因此在此期间无法立即接收到同一用户的下一请求，但可以保证连接的完整性。</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">bool</span> http_conn<span class="token double-colon punctuation">::</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token comment">//若要发送的数据长度为0</span>
    <span class="token comment">//表示响应报文为空，一般不会出现这种情况</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bytes_to_send <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
        <span class="token function">modfd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span> m_sockfd<span class="token punctuation">,</span> EPOLLIN<span class="token punctuation">,</span> m_TRIGMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//将响应报文的状态行、消息头、空行和响应正文发送给浏览器端</span>
        temp <span class="token operator">=</span> <span class="token function">writev</span><span class="token punctuation">(</span>m_sockfd<span class="token punctuation">,</span> m_iv<span class="token punctuation">,</span> m_iv_count<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>temp <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//发送失败</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EAGAIN<span class="token punctuation">)</span><span class="token punctuation">{</span>   <span class="token comment">//判断缓冲区是否满了</span>
                <span class="token function">modfd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span> m_sockfd<span class="token punctuation">,</span> EPOLLOUT<span class="token punctuation">,</span> m_TRIGMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">unmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//如果发送失败，但不是缓冲区问题，取消映射</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        bytes_have_send <span class="token operator">+=</span> temp<span class="token punctuation">;</span>    <span class="token comment">//更新已发送字节数</span>
        bytes_to_send <span class="token operator">-=</span> temp<span class="token punctuation">;</span>      <span class="token comment">//更新剩余发送字节数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bytes_have_send <span class="token operator">&gt;=</span> m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//第一个iovec头部信息的数据已发送完，发送第二个iovec数据</span>
            m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            m_iv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base <span class="token operator">=</span> m_file_address <span class="token operator">+</span> <span class="token punctuation">(</span>bytes_have_send <span class="token operator">-</span> m_write_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            m_iv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">=</span> bytes_to_send<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token comment">//继续发送第一个iovec头部信息的数据</span>
            m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base <span class="token operator">=</span> m_write_buf <span class="token operator">+</span> bytes_have_send<span class="token punctuation">;</span>
            m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">=</span> m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">-</span> bytes_have_send<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>bytes_to_send <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//判断条件，数据已全部发送完</span>
            <span class="token function">unmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">modfd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span> m_sockfd<span class="token punctuation">,</span> EPOLLIN<span class="token punctuation">,</span> m_TRIGMode<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//在epoll树上重置EPOLLONESHOT事件</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>m_linger<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//浏览器的请求为长连接</span>
                <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//重新初始化HTTP对象</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="07-定时器处理非活动连接（上）"><a href="#07-定时器处理非活动连接（上）" class="headerlink" title="07 定时器处理非活动连接（上）"></a>07 定时器处理非活动连接（上）</h2><h3 id="7-1-基础知识"><a href="#7-1-基础知识" class="headerlink" title="7.1 基础知识"></a>7.1 基础知识</h3><ul>
<li><code>非活跃</code>，是指客户端（这里是浏览器）与服务器端建立连接后，长时间不交换数据，一直占用服务器端的文件描述符，导致连接资源的浪费。</li>
<li><code>定时事件</code>，是指固定一段时间之后触发某段代码，由该段代码处理一个事件，如从内核事件表删除事件，并关闭文件描述符，释放连接资源。</li>
<li><code>定时器</code>，是指利用结构体或其他形式，将多种定时事件进行封装起来。具体的，这里只涉及一种定时事件，即定期检测非活跃连接，这里将该定时事件与连接资源封装为一个结构体定时器。</li>
<li><code>定时器容器</code>，是指使用某种容器类数据结构，将上述多个定时器组合起来，便于对定时事件统一管理。具体的，项目中使用升序链表将所有定时器串联组织起来。</li>
</ul>
<h3 id="7-2-整体概述"><a href="#7-2-整体概述" class="headerlink" title="7.2 整体概述"></a>7.2 整体概述</h3><p>本项目中，服务器主循环为每一个连接创建一个定时器，并对每个连接进行定时。另外，利用<strong>升序时间链表容器将所有定时器串联起来</strong>，若主循环接收到定时通知，则在链表中依次执行定时任务。</p>
<p><code>Linux</code>下提供了三种定时的方法:</p>
<ul>
<li>socket选项<code>SO_RECVTIMEO</code>和<code>SO_SNDTIMEO</code></li>
<li><code>SIGALRM</code>信号</li>
<li>I/O复用系统调用的超时参数</li>
</ul>
<p>三种方法没有一劳永逸的应用场景，也没有绝对的优劣。由于项目中使用的是<code>SIGALRM</code>信号，这里仅对其进行介绍，另外两种方法可以查阅游双的<code>Linux高性能服务器编程 第11章 定时器</code>。</p>
<p>具体的，<strong>利用<code>alarm</code>函数周期性地触发<code>SIGALRM</code>信号，信号处理函数利用管道通知主循环</strong>，主循环接收到该信号后对升序链表上所有定时器进行处理，若该段时间内没有交换数据，则将该连接关闭，释放所占用的资源。</p>
<p>从上面的简要描述中，可以看出定时器处理非活动连接模块，主要分为两部分，其一为定时方法与信号通知流程，其二为定时器及其容器设计与定时任务的处理。</p>
<h3 id="7-3-本文内容"><a href="#7-3-本文内容" class="headerlink" title="7.3 本文内容"></a>7.3 本文内容</h3><p>本篇将介绍定时方法与信号通知流程，具体的涉及到基础API、信号通知流程和代码实现。</p>
<p><strong>基础API</strong>，描述<code>sigaction</code>结构体、<code>sigaction</code>函数、<code>sigfillset</code>函数、<code>SIGALRM</code>信号、<code>SIGTERM</code>信号、<code>alarm</code>函数、<code>socketpair</code>函数、<code>send</code>函数。</p>
<p><strong>信号通知流程</strong>，介绍统一事件源和信号处理机制。</p>
<p><strong>代码实现</strong>，结合代码对信号处理函数的设计与使用进行详解。</p>
<h3 id="7-4-基础API"><a href="#7-4-基础API" class="headerlink" title="7.4 基础API"></a>7.4 基础API</h3><p>为了更好的源码阅读体验，这里提前对代码中使用的一些API进行简要介绍，更丰富的用法可以自行查阅资料。</p>
<h4 id="7-4-1-sigaction结构体"><a href="#7-4-1-sigaction结构体" class="headerlink" title="7.4.1 sigaction结构体"></a>7.4.1 sigaction结构体</h4><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">sigaction</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>sa_handler<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>sa_sigaction<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> siginfo_t <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sigset_t sa_mask<span class="token punctuation">;</span>
    <span class="token keyword">int</span> sa_flags<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>sa_restorer<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>sa_handler是一个函数指针，指向信号处理函数</p>
</li>
<li><p>sa_sigaction同样是信号处理函数，有三个参数，可以获得关于信号更详细的信息</p>
</li>
<li><p>sa_mask用来指定在信号处理函数执行期间需要被屏蔽的信号</p>
</li>
<li><p>sa_flags用于指定信号处理的行为</p>
</li>
<li><ul>
<li>SA_RESTART，使被信号打断的系统调用自动重新发起<ul>
<li>SA_NOCLDSTOP，使父进程在它的子进程暂停或继续运行时不会收到 SIGCHLD 信号</li>
<li>SA_NOCLDWAIT，使父进程在它的子进程退出时不会收到 SIGCHLD 信号，这时子进程如果退出也不会成为僵尸进程</li>
<li>SA_NODEFER，使对信号的屏蔽无效，即在信号处理函数执行期间仍能发出这个信号</li>
<li>SA_RESETHAND，信号处理之后重新设置为默认的处理方式</li>
<li>SA_SIGINFO，使用 sa_sigaction 成员而不是 sa_handler 作为信号处理函数</li>
</ul>
</li>
</ul>
</li>
<li><p>sa_restorer一般不使用</p>
</li>
</ul>
<h4 id="7-4-2-sigaction函数"><a href="#7-4-2-sigaction函数" class="headerlink" title="7.4.2 sigaction函数"></a>7.4.2 sigaction函数</h4><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">sigaction</span><span class="token punctuation">(</span><span class="token keyword">int</span> signum<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> <span class="token operator">*</span>act<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> <span class="token operator">*</span>oldact<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li>signum表示操作的信号。</li>
<li>act表示对信号设置新的处理方式。</li>
<li>oldact表示信号原来的处理方式。一般不使用，传递NULL</li>
<li>返回值，0 表示成功，-1 表示有错误发生。</li>
</ul>
<h4 id="7-4-3-sigfillset函数"><a href="#7-4-3-sigfillset函数" class="headerlink" title="7.4.3 sigfillset函数"></a>7.4.3 sigfillset函数</h4><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">sigfillset</span><span class="token punctuation">(</span>sigset_t <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>用来将参数set信号集初始化，然后把所有的信号加入到此信号集里。</p>
<h4 id="7-4-4-SIGALRM、SIGTERM信号"><a href="#7-4-4-SIGALRM、SIGTERM信号" class="headerlink" title="7.4.4 SIGALRM、SIGTERM信号"></a>7.4.4 SIGALRM、SIGTERM信号</h4><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SIGALRM</span>  <span class="token expression"><span class="token number">14</span>     </span><span class="token comment">//由alarm系统调用产生timer时钟信号</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SIGTERM</span>  <span class="token expression"><span class="token number">15</span>     </span><span class="token comment">//终端发送的终止信号</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="7-4-5-alarm函数"><a href="#7-4-5-alarm函数" class="headerlink" title="7.4.5 alarm函数"></a>7.4.5 alarm函数</h4><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span><span class="token expression"><span class="token punctuation">;</span></span></span>
<span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">alarm</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> seconds<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>设置信号传送闹钟，即用来设置信号SIGALRM在经过参数seconds秒数后发送给目前的进程。如果未设置信号SIGALRM的处理函数，那么alarm()默认处理终止进程.</p>
<h4 id="7-4-6-socketpair函数"><a href="#7-4-6-socketpair函数" class="headerlink" title="7.4.6 socketpair函数"></a>7.4.6 socketpair函数</h4><p>在linux下，使用socketpair函数能够创建一对套接字进行通信，项目中使用管道通信。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">socketpair</span><span class="token punctuation">(</span><span class="token keyword">int</span> domain<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> protocol<span class="token punctuation">,</span> <span class="token keyword">int</span> sv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li>domain表示协议族，PF_UNIX或者AF_UNIX</li>
<li>type表示协议，可以是SOCK_STREAM或者SOCK_DGRAM，SOCK_STREAM基于TCP，SOCK_DGRAM基于UDP</li>
<li>protocol表示类型，只能为0</li>
<li>sv[2]表示套节字柄对，该两个句柄作用相同，均能进行读写双向操作</li>
<li>返回结果， 0为创建成功，-1为创建失败</li>
</ul>
<h4 id="7-4-7-send函数"><a href="#7-4-7-send函数" class="headerlink" title="7.4.7 send函数"></a>7.4.7 send函数</h4><pre class="line-numbers language-none"><code class="language-none">#include &lt;sys/types.h&gt;
#include &lt;sys/socket.h&gt;

ssize_t send(int sockfd, const void *buf, size_t len, int flags);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>当套接字发送缓冲区变满时，send通常会阻塞，除非套接字设置为非阻塞模式，当缓冲区变满时，返回EAGAIN或者EWOULDBLOCK错误，此时可以调用select函数来监视何时可以发送数据。</p>
<h3 id="7-5-信号通知流程"><a href="#7-5-信号通知流程" class="headerlink" title="7.5 信号通知流程"></a>7.5 信号通知流程</h3><p><strong>Linux下的信号采用的异步处理机制</strong>，信号处理函数和当前进程是两条不同的执行路线。具体的，<strong>当进程收到信号时，操作系统会中断进程当前的正常流程，转而进入信号处理函数执行操作，完成后再返回中断的地方继续执行</strong>。</p>
<p>为<strong>避免信号竞态现象发生，信号处理期间系统不会再次触发它</strong>。所以，为确保该信号不被屏蔽太久，信号处理函数需要尽可能快地执行完毕。</p>
<p>一般的信号处理函数需要处理该信号对应的逻辑，当该逻辑比较复杂时，信号处理函数执行时间过长，会导致信号屏蔽太久。</p>
<p>这里的解决方案是，信号处理函数仅仅发送信号通知程序主循环，将信号对应的处理逻辑放在程序主循环中，由主循环执行信号对应的逻辑代码。</p>
<h4 id="7-5-1-统一事件源"><a href="#7-5-1-统一事件源" class="headerlink" title="7.5.1 统一事件源"></a>7.5.1 统一事件源</h4><p>统一事件源，是指将信号事件与其他事件一样被处理。</p>
<p>具体的，信号处理函数使用管道将信号传递给主循环，<strong>信号处理函数往管道的写端写入信号值，主循环则从管道的读端读出信号值</strong>，使用I/O复用系统调用来监听管道读端的可读事件，这样信号事件与其他文件描述符都可以通过epoll来监测，从而实现统一处理。</p>
<h4 id="7-5-2-信号处理机制"><a href="#7-5-2-信号处理机制" class="headerlink" title="7.5.2 信号处理机制"></a>7.5.2 信号处理机制</h4><p>每个进程之中，都有存着一个表，里面存着每种信号所代表的含义，内核通过设置表项中每一个位来标识对应的信号类型。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2023/cpp/image-20230317105118282.png" alt="image-20230317105118282"></p>
<ul>
<li><p>信号的接收</p>
</li>
<li><ul>
<li><strong>接收信号的任务是由内核代理的</strong>，当内核接收到信号后，会将其放到对应进程的信号队列中，同时<strong>向进程发送一个中断</strong>，使其陷入内核态。注意，此时信号还只是在队列中，对进程来说暂时是不知道有信号到来的。</li>
</ul>
</li>
<li><p>信号的检测</p>
</li>
<li><ul>
<li>进程从内核态返回到用户态前进行信号检测<ul>
<li>进程在内核态中，从睡眠状态被唤醒的时候进行信号检测</li>
<li>进程陷入内核态后，有两种场景会对信号进行检测：</li>
<li>当发现有新信号时，便会进入下一步，信号的处理。</li>
</ul>
</li>
</ul>
</li>
<li><p>信号的处理</p>
</li>
<li><ul>
<li>( <strong>内核</strong> )信号处理函数是运行在用户态的，调用处理函数前，内核会将当前内核栈的内容备份拷贝到用户栈上，并且修改指令寄存器（eip）将其指向信号处理函数。<ul>
<li>( <strong>用户</strong> )接下来进程返回到用户态中，执行相应的信号处理函数。</li>
<li>( <strong>内核</strong> )信号处理函数执行完成后，还需要返回内核态，检查是否还有其它信号未处理。</li>
<li>( <strong>用户</strong> )如果所有信号都处理完成，就会将内核栈恢复（从用户栈的备份拷贝回来），同时恢复指令寄存器（eip）将其指向中断前的运行位置，最后回到用户态继续执行进程。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>至此，一个完整的信号处理流程便结束了，如果同时有多个信号到达，上面的处理流程会在第2步和第3步骤间重复进行。</p>
<h3 id="7-6-代码分析"><a href="#7-6-代码分析" class="headerlink" title="7.6 代码分析"></a>7.6 代码分析</h3><h4 id="7-6-1-信号处理函数"><a href="#7-6-1-信号处理函数" class="headerlink" title="7.6.1 信号处理函数"></a>7.6.1 信号处理函数</h4><p>自定义信号处理函数，创建sigaction结构体变量，设置信号函数。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//信号处理函数</span>
<span class="token keyword">void</span> <span class="token class-name">Utils</span><span class="token double-colon punctuation">::</span><span class="token function">sig_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//为保证函数的可重入性，保留原来的errno</span>
    <span class="token comment">//可重入性表示中断后再次进入该函数，环境变量与之前相同，不会丢失数据</span>
    <span class="token keyword">int</span> save_errno <span class="token operator">=</span> errno<span class="token punctuation">;</span>
    <span class="token keyword">int</span> msg <span class="token operator">=</span> sig<span class="token punctuation">;</span>

    <span class="token comment">//将信号值从管道写端写入，传输字符类型，而非整型</span>
    <span class="token function">send</span><span class="token punctuation">(</span>u_pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    errno <span class="token operator">=</span> save_errno<span class="token punctuation">;</span>     <span class="token comment">//将原来的errno赋值为当前的errno</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>信号处理函数中仅仅通过管道发送信号值，不处理信号对应的逻辑，缩短异步执行时间，减少对主程序的影响。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//设置信号函数</span>
<span class="token keyword">void</span> <span class="token class-name">Utils</span><span class="token double-colon punctuation">::</span><span class="token function">addsig</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">bool</span> restart<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> sa<span class="token punctuation">;</span>    <span class="token comment">//创建sigaction结构体变量</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token char">'\0'</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sa<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sa<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> handler<span class="token punctuation">;</span>    <span class="token comment">//信号处理函数中仅仅发送信号值，不做对应逻辑处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>restart<span class="token punctuation">)</span>
        sa<span class="token punctuation">.</span>sa_flags <span class="token operator">|=</span> SA_RESTART<span class="token punctuation">;</span>
    <span class="token function">sigfillset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sa<span class="token punctuation">.</span>sa_mask<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将所有信号添加到信号集中</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">sigaction</span><span class="token punctuation">(</span>sig<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//执行sigaction函数</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>项目中设置信号函数，仅关注SIGTERM和SIGALRM两个信号。</p>
<h4 id="7-6-2-信号通知逻辑"><a href="#7-6-2-信号通知逻辑" class="headerlink" title="7.6.2 信号通知逻辑"></a>7.6.2 信号通知逻辑</h4><ul>
<li><p>创建管道，其中管道写端写入信号值，管道读端通过I/O复用系统监测读事件</p>
</li>
<li><p>设置信号处理函数SIGALRM（时间到了触发）和SIGTERM（kill会触发，Ctrl+C）</p>
</li>
<li><ul>
<li>通过struct sigaction结构体和sigaction函数注册信号捕捉函数<ul>
<li>在结构体的handler参数设置信号处理函数，具体的，从管道写端写入信号的名字</li>
</ul>
</li>
</ul>
</li>
<li><p>利用I/O复用系统监听管道读端文件描述符的可读事件</p>
</li>
<li><p>信息值传递给主循环，主循环再根据接收到的信号值执行目标信号对应的逻辑代码</p>
</li>
</ul>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">utils<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>TIMESLOT<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//定时器开关初始化</span>
<span class="token comment">//epoll创建内核事件表</span>
epoll_event events<span class="token punctuation">[</span>MAX_EVENT_NUMBER<span class="token punctuation">]</span><span class="token punctuation">;</span>
m_epollfd <span class="token operator">=</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">assert</span><span class="token punctuation">(</span>m_epollfd <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

utils<span class="token punctuation">.</span><span class="token function">addfd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span> m_listenfd<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> m_LISTENTrigmode<span class="token punctuation">)</span><span class="token punctuation">;</span>
http_conn<span class="token double-colon punctuation">::</span>m_epollfd <span class="token operator">=</span> m_epollfd<span class="token punctuation">;</span>

<span class="token comment">//创建管道套接字</span>
ret <span class="token operator">=</span> <span class="token function">socketpair</span><span class="token punctuation">(</span>PF_UNIX<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> m_pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//设置管道写端为非阻塞，为啥？管道默认是阻塞的：如果管道中没有数据，read阻塞，如果管道满了，write阻塞</span>
utils<span class="token punctuation">.</span><span class="token function">setnonblocking</span><span class="token punctuation">(</span>m_pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//设置管道读端为ET非阻塞</span>
utils<span class="token punctuation">.</span><span class="token function">addfd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span> m_pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//传递给主循环的信号值，这里只关注SIGALRM （定时器）、SIGTERM （ctrl+c）和SIGPIPE（忽略管道错误）</span>
utils<span class="token punctuation">.</span><span class="token function">addsig</span><span class="token punctuation">(</span>SIGPIPE<span class="token punctuation">,</span> SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span>
utils<span class="token punctuation">.</span><span class="token function">addsig</span><span class="token punctuation">(</span>SIGALRM<span class="token punctuation">,</span> utils<span class="token punctuation">.</span>sig_handler<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
utils<span class="token punctuation">.</span><span class="token function">addsig</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">,</span> utils<span class="token punctuation">.</span>sig_handler<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">alarm</span><span class="token punctuation">(</span>TIMESLOT<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//每隔TIMESLOT时间触发SIGALRM信号</span>

<span class="token comment">//工具类,信号和描述符基础操作</span>
Utils<span class="token double-colon punctuation">::</span>u_pipefd <span class="token operator">=</span> m_pipefd<span class="token punctuation">;</span>
Utils<span class="token double-colon punctuation">::</span>u_epollfd <span class="token operator">=</span> m_epollfd<span class="token punctuation">;</span>


<span class="token comment">//服务器接收http请求,以及处理的流程函数</span>
<span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token double-colon punctuation">::</span><span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">bool</span> timeout <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token comment">//超时标志</span>
    <span class="token keyword">bool</span> stop_server <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token comment">//循环条件</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stop_server<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">int</span> number <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> MAX_EVENT_NUMBER<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//等待所监控文件描述符上有事件的产生</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>number <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> errno <span class="token operator">!=</span> EINTR<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"epoll failure"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> number<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//轮询文件描述符</span>
            <span class="token keyword">int</span> sockfd <span class="token operator">=</span> events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">;</span>

            <span class="token comment">//处理新到的客户连接</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> m_listenfd<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">bool</span> flag <span class="token operator">=</span> <span class="token function">dealclinetdata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> flag<span class="token punctuation">)</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> <span class="token punctuation">(</span>EPOLLRDHUP <span class="token operator">|</span> EPOLLHUP <span class="token operator">|</span> EPOLLERR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//服务器端关闭连接，移除对应的定时器</span>
                util_timer <span class="token operator">*</span>timer <span class="token operator">=</span> users_timer<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer<span class="token punctuation">;</span>
                <span class="token function">deal_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//处理信号  //管道读端对应文件描述符发生读事件</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sockfd <span class="token operator">==</span> m_pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">bool</span> flag <span class="token operator">=</span> <span class="token function">dealwithsignal</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> stop_server<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//在下面</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> flag<span class="token punctuation">)</span>
                    <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"dealclientdata failure"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//处理客户连接上接收到的数据</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token function">dealwithread</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLOUT<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token function">dealwithwrite</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">{</span>
            utils<span class="token punctuation">.</span><span class="token function">timer_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"timer tick"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            timeout <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">bool</span> <span class="token class-name">WebServer</span><span class="token double-colon punctuation">::</span><span class="token function">dealwithsignal</span><span class="token punctuation">(</span><span class="token keyword">bool</span> <span class="token operator">&amp;</span>timeout<span class="token punctuation">,</span> <span class="token keyword">bool</span> <span class="token operator">&amp;</span>stop_server<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> sig<span class="token punctuation">;</span>
    <span class="token keyword">char</span> signals<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">//从管道读端读出信号值，成功返回字节数，失败返回-1</span>
    <span class="token comment">//正常情况下，这里的ret返回值总是1，只有14和15两个ASCII码对应的字符</span>
    ret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>m_pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> signals<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>signals<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//处理异常</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ret<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>signals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">//这里面是字符</span>
                <span class="token keyword">case</span> SIGALRM<span class="token operator">:</span>   <span class="token comment">//这里是整型（14号信号）</span>
                <span class="token punctuation">{</span>
                    timeout <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">case</span> SIGTERM<span class="token operator">:</span>   <span class="token comment">//这里是整型（15号信号 Ctrl+c）</span>
                <span class="token punctuation">{</span>
                    stop_server <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>为什么管道写端要非阻塞？</strong></p>
<p>send是将信息发送给套接字缓冲区，如果缓冲区满了，则会阻塞，这时候会进一步增加信号处理函数的执行时间，为此，将其修改为非阻塞。</p>
<p><strong>没有对非阻塞返回值处理，如果阻塞是不是意味着这一次定时事件失效了？</strong></p>
<p>是的，但定时事件是非必须立即处理的事件，可以允许这样的情况发生。</p>
<p><strong>管道传递的是什么类型？switch-case的变量冲突？</strong></p>
<p>信号本身是整型数值，管道中传递的是ASCII码表中整型数值对应的字符。</p>
<p>switch的变量一般为字符或整型，当switch的变量为字符时，case中可以是字符，也可以是字符对应的ASCII码。</p>
<h2 id="08-定时器处理非活动连接（下）"><a href="#08-定时器处理非活动连接（下）" class="headerlink" title="08 定时器处理非活动连接（下）"></a>08 定时器处理非活动连接（下）</h2><p>定时器处理非活动连接模块，主要分为两部分，<strong>其一为定时方法与信号通知流程，其二为定时器及其容器设计、定时任务的处理</strong>。</p>
<p>本篇对第二部分进行介绍，具体的涉及到定时器设计、容器设计、定时任务处理函数和使用定时器。</p>
<ul>
<li><code>定时器设计</code>，将连接资源和定时事件等封装起来，具体包括连接资源、超时时间和回调函数，这里的回调函数指向定时事件。</li>
<li><code>定时器容器设计</code>，将多个定时器串联组织起来统一处理，具体包括<strong>升序链表</strong>设计。</li>
<li><code>定时任务处理函数</code>，该函数封装在容器类中，具体的，函数遍历升序链表容器，根据超时时间，处理对应的定时器。</li>
<li><code>代码分析-使用定时器</code>，通过代码分析，如何在项目中使用定时器。</li>
</ul>
<h3 id="8-1-定时器设计"><a href="#8-1-定时器设计" class="headerlink" title="8.1 定时器设计"></a>8.1 定时器设计</h3><p>项目中将连接资源、定时事件和超时时间封装为定时器类，具体的，</p>
<ul>
<li>连接资源包括客户端套接字地址、文件描述符和定时器</li>
<li>定时事件为回调函数，将其封装起来由用户自定义，这里是删除非活动socket上的注册事件，并关闭</li>
<li><strong>定时器超时时间 = 浏览器和服务器连接时刻 + 固定时间(TIMESLOT)<strong>，可以看出，定时器使用绝对时间作为超时值，这里alarm设置为5秒，</strong>连接超时为15秒</strong>。</li>
</ul>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//连接资源结构体成员需要用到定时器类</span>
<span class="token comment">//需要前向声明</span>
<span class="token keyword">class</span> <span class="token class-name">util_timer</span><span class="token punctuation">;</span>

<span class="token comment">//连接资源</span>
<span class="token keyword">struct</span> <span class="token class-name">client_data</span><span class="token punctuation">{</span>
    sockaddr_in address<span class="token punctuation">;</span>    <span class="token comment">//客户端socket地址</span>
    <span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>             <span class="token comment">//客户端socket地址</span>
    util_timer <span class="token operator">*</span>timer<span class="token punctuation">;</span>      <span class="token comment">//定时器</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//定时器类</span>
<span class="token keyword">class</span> <span class="token class-name">util_timer</span><span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">util_timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">prev</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token comment">//构造函数，做双向链表</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    time_t expire<span class="token punctuation">;</span>  				   <span class="token comment">//超时时间</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span> cb_func<span class="token punctuation">)</span><span class="token punctuation">(</span>client_data <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//回调函数</span>
    client_data <span class="token operator">*</span>user_data<span class="token punctuation">;</span>         	<span class="token comment">//连接资源</span>
    util_timer <span class="token operator">*</span>prev<span class="token punctuation">;</span>               	<span class="token comment">//前向定时器</span>
    util_timer <span class="token operator">*</span>next<span class="token punctuation">;</span>               	<span class="token comment">//后继定时器</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>定时事件，具体的，从内核事件表删除事件，关闭文件描述符，释放连接资源。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//定时器回调函数</span>
<span class="token keyword">void</span> <span class="token function">cb_func</span><span class="token punctuation">(</span>client_data <span class="token operator">*</span>user_data<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//删除非活动连接在socket上的注册事件</span>
    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>Utils<span class="token double-colon punctuation">::</span>u_epollfd<span class="token punctuation">,</span> EPOLL_CTL_DEL<span class="token punctuation">,</span> user_data<span class="token operator">-&gt;</span>sockfd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>user_data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//关闭文件描述符</span>
    <span class="token function">close</span><span class="token punctuation">(</span>user_data<span class="token operator">-&gt;</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//关闭文件描述符</span>
    http_conn<span class="token double-colon punctuation">::</span>m_user_count<span class="token operator">--</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="8-2-定时器容器设计"><a href="#8-2-定时器容器设计" class="headerlink" title="8.2 定时器容器设计"></a>8.2 定时器容器设计</h3><p>项目中的<strong>定时器容器为带头尾结点的升序双向链表</strong>，具体的为<strong>每个连接创建一个定时器</strong>，将其添加到链表中，并按照<strong>超时时间升序排列</strong>。执行定时任务时，将到期的定时器从链表中删除。</p>
<p>从实现上看，主要涉及双向链表的插入，删除操作，**其中添加定时器的事件复杂度是O(n),删除定时器的事件复杂度是O(1)**。</p>
<p>升序双向链表主要逻辑如下，具体的，</p>
<ul>
<li><p>创建头尾节点，其中头尾节点没有意义，仅仅统一方便调整</p>
</li>
<li><p>add_timer函数，将目标定时器添加到链表中，添加时按照<strong>升序添加</strong></p>
</li>
<li><ul>
<li>若当前链表中只有头尾节点，直接插入<ul>
<li>否则，将定时器按升序插入</li>
</ul>
</li>
</ul>
</li>
<li><p>adjust_timer函数，当定时任务发生变化,调整对应定时器在链表中的位置</p>
</li>
<li><ul>
<li>客户端在设定时间内有数据收发,则当前时刻对该定时器重新设定时间，这里只是往后延长超时时间<ul>
<li>被调整的目标定时器在尾部，或定时器新的超时值仍然小于下一个定时器的超时，不用调整</li>
<li>否则先将定时器从链表取出，重新插入链表</li>
</ul>
</li>
</ul>
</li>
<li><p>del_timer函数将超时的定时器从链表中删除</p>
</li>
<li><ul>
<li>常规双向链表删除结点</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//定时器容器类</span>
<span class="token keyword">class</span> <span class="token class-name">sort_timer_lst</span><span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">sort_timer_lst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">head</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">tail</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">//常规销毁链表</span>
    <span class="token operator">~</span><span class="token function">sort_timer_lst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//添加定时器，内部调用私有成员add_timer</span>
    <span class="token keyword">void</span> <span class="token function">add_timer</span><span class="token punctuation">(</span>util_timer <span class="token operator">*</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//调整定时器，任务发生变化时，调整定时器在链表中的位置</span>
    <span class="token keyword">void</span> <span class="token function">adjust_timer</span><span class="token punctuation">(</span>util_timer <span class="token operator">*</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//删除定时器</span>
    <span class="token keyword">void</span> <span class="token function">del_timer</span><span class="token punctuation">(</span>util_timer <span class="token operator">*</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">void</span> <span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token comment">//私有成员，被公有成员add_timer和adjust_time调用</span>
    <span class="token comment">//主要用于调整链表内部结点</span>
    <span class="token keyword">void</span> <span class="token function">add_timer</span><span class="token punctuation">(</span>util_timer <span class="token operator">*</span>timer<span class="token punctuation">,</span> util_timer <span class="token operator">*</span>lst_head<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//头尾结点</span>
    util_timer <span class="token operator">*</span>head<span class="token punctuation">;</span>
    util_timer <span class="token operator">*</span>tail<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token comment">//常规销毁链表</span>
<span class="token class-name">sort_timer_lst</span><span class="token double-colon punctuation">::</span><span class="token operator">~</span><span class="token function">sort_timer_lst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    util_timer <span class="token operator">*</span>tmp <span class="token operator">=</span> head<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">{</span>
        head <span class="token operator">=</span> tmp<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
        <span class="token keyword">delete</span> tmp<span class="token punctuation">;</span>
        tmp <span class="token operator">=</span> head<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//添加定时器，内部调用私有成员add_timer</span>
<span class="token keyword">void</span> sort_timer_lst<span class="token double-colon punctuation">::</span><span class="token function">add_timer</span><span class="token punctuation">(</span>util_timer <span class="token operator">*</span>timer<span class="token punctuation">)</span><span class="token punctuation">{</span>      <span class="token comment">//添加一个节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timer<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment">//添加的节点为空</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>head<span class="token punctuation">)</span><span class="token punctuation">{</span>         <span class="token comment">//头节点为空，容器内没有节点，让头和尾都指向新加入的这个节点</span>
        head <span class="token operator">=</span> tail <span class="token operator">=</span> timer<span class="token punctuation">;</span>    
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token operator">-&gt;</span>expire <span class="token operator">&lt;</span> head<span class="token operator">-&gt;</span>expire<span class="token punctuation">)</span><span class="token punctuation">{</span>      <span class="token comment">//添加的节点截止时间还在头节点的前面，就把它放在头结点位置</span>
        timer<span class="token operator">-&gt;</span>next <span class="token operator">=</span> head<span class="token punctuation">;</span>
        head<span class="token operator">-&gt;</span>prev <span class="token operator">=</span> timer<span class="token punctuation">;</span>
        head <span class="token operator">=</span> timer<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">add_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span> head<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//函数重写</span>
<span class="token punctuation">}</span>

<span class="token comment">//调整定时器，任务发生变化时，调整定时器在链表中的位置</span>
<span class="token keyword">void</span> sort_timer_lst<span class="token double-colon punctuation">::</span><span class="token function">adjust_timer</span><span class="token punctuation">(</span>util_timer <span class="token operator">*</span>timer<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timer<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    util_timer <span class="token operator">*</span>tmp <span class="token operator">=</span> timer<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>

    <span class="token comment">//被调整的定时器在链表尾部</span>
    <span class="token comment">//定时器超时值仍然小于下一个定时器超时值，不调整</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tmp <span class="token operator">||</span> <span class="token punctuation">(</span>timer<span class="token operator">-&gt;</span>expire <span class="token operator">&lt;</span> tmp<span class="token operator">-&gt;</span>expire<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//被调整定时器是链表头结点，将定时器取出，重新插入</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer <span class="token operator">==</span> head<span class="token punctuation">)</span><span class="token punctuation">{</span>
        head <span class="token operator">=</span> head<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
        head<span class="token operator">-&gt;</span>prev <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        timer<span class="token operator">-&gt;</span>next <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token function">add_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span> head<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token punctuation">{</span> <span class="token comment">//被调整定时器在内部，将定时器取出，重新插入</span>
        timer<span class="token operator">-&gt;</span>prev<span class="token operator">-&gt;</span>next <span class="token operator">=</span> timer<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
        timer<span class="token operator">-&gt;</span>next<span class="token operator">-&gt;</span>prev <span class="token operator">=</span> timer<span class="token operator">-&gt;</span>prev<span class="token punctuation">;</span>
        <span class="token function">add_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span> timer<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//删除定时器</span>
<span class="token keyword">void</span> sort_timer_lst<span class="token double-colon punctuation">::</span><span class="token function">del_timer</span><span class="token punctuation">(</span>util_timer <span class="token operator">*</span>timer<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timer<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//链表中只有一个定时器，需要删除该定时器</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>timer <span class="token operator">==</span> head<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>timer <span class="token operator">==</span> tail<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">delete</span> timer<span class="token punctuation">;</span>
        head <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        tail <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer <span class="token operator">==</span> head<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//被删除的定时器为头结点</span>
        head <span class="token operator">=</span> head<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
        head<span class="token operator">-&gt;</span>prev <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">delete</span> timer<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer <span class="token operator">==</span> tail<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//被删除的定时器为尾结点</span>
        tail <span class="token operator">=</span> tail<span class="token operator">-&gt;</span>prev<span class="token punctuation">;</span>
        tail<span class="token operator">-&gt;</span>next <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">delete</span> timer<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//被删除的定时器在链表内部，常规链表结点删除</span>
    timer<span class="token operator">-&gt;</span>prev<span class="token operator">-&gt;</span>next <span class="token operator">=</span> timer<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
    timer<span class="token operator">-&gt;</span>next<span class="token operator">-&gt;</span>prev <span class="token operator">=</span> timer<span class="token operator">-&gt;</span>prev<span class="token punctuation">;</span>
    <span class="token keyword">delete</span> timer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//私有成员，被公有成员add_timer和adjust_time调用   //主要用于调整链表内部结点</span>
<span class="token keyword">void</span> sort_timer_lst<span class="token double-colon punctuation">::</span><span class="token function">add_timer</span><span class="token punctuation">(</span>util_timer <span class="token operator">*</span>timer<span class="token punctuation">,</span> util_timer <span class="token operator">*</span>lst_head<span class="token punctuation">)</span><span class="token punctuation">{</span>
    util_timer <span class="token operator">*</span>prev <span class="token operator">=</span> lst_head<span class="token punctuation">;</span>
    util_timer <span class="token operator">*</span>tmp <span class="token operator">=</span> prev<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
    <span class="token comment">//遍历当前结点之后的链表，按照超时时间找到目标定时器对应的位置，常规双向链表插入</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token operator">-&gt;</span>expire <span class="token operator">&lt;</span> tmp<span class="token operator">-&gt;</span>expire<span class="token punctuation">)</span><span class="token punctuation">{</span>
            prev<span class="token operator">-&gt;</span>next <span class="token operator">=</span> timer<span class="token punctuation">;</span>
            timer<span class="token operator">-&gt;</span>next <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
            tmp<span class="token operator">-&gt;</span>prev <span class="token operator">=</span> timer<span class="token punctuation">;</span>
            timer<span class="token operator">-&gt;</span>prev <span class="token operator">=</span> prev<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        prev <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
        tmp <span class="token operator">=</span> tmp<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tmp<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//遍历完发现，目标定时器需要放到尾结点处</span>
        prev<span class="token operator">-&gt;</span>next <span class="token operator">=</span> timer<span class="token punctuation">;</span>
        timer<span class="token operator">-&gt;</span>prev <span class="token operator">=</span> prev<span class="token punctuation">;</span>
        timer<span class="token operator">-&gt;</span>next <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        tail <span class="token operator">=</span> timer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="8-3-定时任务处理函数"><a href="#8-3-定时任务处理函数" class="headerlink" title="8.3 定时任务处理函数"></a>8.3 定时任务处理函数</h3><p>使用统一事件源，<code>SIGALRM</code>信号每次被触发，主循环中调用一次定时任务处理函数，处理链表容器中到期的定时器。</p>
<p>具体的逻辑如下，</p>
<ul>
<li>遍历定时器升序链表容器，从头结点开始依次处理每个定时器，直到遇到尚未到期的定时器</li>
<li>若当前时间小于定时器超时时间，跳出循环，即未找到到期的定时器</li>
<li>若当前时间大于定时器超时时间，即找到了到期的定时器，执行回调函数，然后将它从链表中删除，然后继续遍历</li>
</ul>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//定时任务处理函数</span>
<span class="token keyword">void</span> sort_timer_lst<span class="token double-colon punctuation">::</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>head<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//获取当前时间</span>
    time_t cur <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    util_timer <span class="token operator">*</span>tmp <span class="token operator">=</span> head<span class="token punctuation">;</span>
    
    <span class="token comment">//遍历定时器链表</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//链表容器为升序排列</span>
        <span class="token comment">//当前时间小于定时器的超时时间，后面的定时器也没有到期</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cur <span class="token operator">&lt;</span> tmp<span class="token operator">-&gt;</span>expire<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//当前定时器到期，则调用回调函数，执行定时事件</span>
        tmp<span class="token operator">-&gt;</span><span class="token function">cb_func</span><span class="token punctuation">(</span>tmp<span class="token operator">-&gt;</span>user_data<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//将处理后的定时器从链表容器中删除，并重置头结点</span>
        head <span class="token operator">=</span> tmp<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">{</span>
            head<span class="token operator">-&gt;</span>prev <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">delete</span> tmp<span class="token punctuation">;</span>
        tmp <span class="token operator">=</span> head<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="8-4-代码分析-如何使用定时器"><a href="#8-4-代码分析-如何使用定时器" class="headerlink" title="8.4 代码分析-如何使用定时器"></a>8.4 代码分析-如何使用定时器</h3><p>服务器首先创建定时器容器链表，然后用统一事件源将异常事件，读写事件和信号事件统一处理，根据不同事件的对应逻辑使用定时器。</p>
<p>具体的，</p>
<ul>
<li>浏览器与服务器连接时，创建该连接对应的定时器，并将该定时器添加到链表上</li>
<li>处理异常事件时，执行定时事件，服务器关闭连接，从链表上移除对应定时器</li>
<li>处理定时信号时，将定时标志设置为true</li>
<li>处理读事件时，若某连接上发生读事件，将对应定时器向后移动，否则，执行定时事件</li>
<li>处理写事件时，若服务器通过某连接给浏览器发送数据，将对应定时器向后移动，否则，执行定时事件</li>
</ul>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//定时处理任务，重新定时以不断触发SIGALRM信号</span>
<span class="token keyword">void</span> <span class="token class-name">Utils</span><span class="token double-colon punctuation">::</span><span class="token function">timer_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    m_timer_lst<span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">alarm</span><span class="token punctuation">(</span>m_TIMESLOT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
sort_timer_lst m_timer_lst<span class="token punctuation">;</span> <span class="token comment">//创建定时器容器链表  Utils类中</span>

users_timer <span class="token operator">=</span> <span class="token keyword">new</span> client_data<span class="token punctuation">[</span>MAX_FD<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//定时器  //创建连接资源数组  WebServer::WebServer()中构造函数	</span>

<span class="token keyword">bool</span> timeout <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token comment">//超时标志  WebServer::eventLoop()实现函数中</span>

<span class="token function">alarm</span><span class="token punctuation">(</span>TIMESLOT<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//每隔TIMESLOT时间触发SIGALRM信号     WebServer::eventListen()实现函数中</span>
Utils<span class="token double-colon punctuation">::</span>u_pipefd <span class="token operator">=</span> m_pipefd<span class="token punctuation">;</span><span class="token comment">//工具类,信号和描述符基础操作</span>
Utils<span class="token double-colon punctuation">::</span>u_epollfd <span class="token operator">=</span> m_epollfd<span class="token punctuation">;</span>

<span class="token comment">//服务器接收http请求,以及处理的流程函数</span>
<span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token double-colon punctuation">::</span><span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">bool</span> timeout <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token comment">//超时标志</span>
    <span class="token keyword">bool</span> stop_server <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token comment">//循环条件</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stop_server<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">int</span> number <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> MAX_EVENT_NUMBER<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//等待所监控文件描述符上有事件的产生</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>number <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> errno <span class="token operator">!=</span> EINTR<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"epoll failure"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> number<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//轮询文件描述符</span>
            <span class="token keyword">int</span> sockfd <span class="token operator">=</span> events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">;</span>

            <span class="token comment">//处理新到的客户连接</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> m_listenfd<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">bool</span> flag <span class="token operator">=</span> <span class="token function">dealclinetdata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> flag<span class="token punctuation">)</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> <span class="token punctuation">(</span>EPOLLRDHUP <span class="token operator">|</span> EPOLLHUP <span class="token operator">|</span> EPOLLERR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//服务器端关闭连接，移除对应的定时器</span>
                util_timer <span class="token operator">*</span>timer <span class="token operator">=</span> users_timer<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer<span class="token punctuation">;</span>
                <span class="token function">deal_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//处理信号  //管道读端对应文件描述符发生读事件</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sockfd <span class="token operator">==</span> m_pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">bool</span> flag <span class="token operator">=</span> <span class="token function">dealwithsignal</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> stop_server<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//接收到SIGALRM信号，timeout设置为True</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> flag<span class="token punctuation">)</span>
                    <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"dealclientdata failure"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//处理客户连接上接收到的数据</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token function">dealwithread</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLOUT<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token function">dealwithwrite</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//处理定时器为非必须事件，收到信号并不是立马处理  //完成读写事件后，再进行处理</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">{</span>
            utils<span class="token punctuation">.</span><span class="token function">timer_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"timer tick"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            timeout <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token double-colon punctuation">::</span><span class="token function">timer</span><span class="token punctuation">(</span><span class="token keyword">int</span> connfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> client_address<span class="token punctuation">)</span><span class="token punctuation">{</span>
	
    users<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span> client_address<span class="token punctuation">,</span> m_root<span class="token punctuation">,</span> m_CONNTrigmode<span class="token punctuation">,</span> m_close_log<span class="token punctuation">,</span> m_user<span class="token punctuation">,</span> m_passWord<span class="token punctuation">,</span> m_databaseName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//初始化client_data数据</span>
    <span class="token comment">//创建定时器，设置回调函数和超时时间，绑定用户数据，将定时器添加到链表中</span>
    users_timer<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span>address <span class="token operator">=</span> client_address<span class="token punctuation">;</span><span class="token comment">//初始化该连接对应的连接资源</span>
    users_timer<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span>sockfd <span class="token operator">=</span> connfd<span class="token punctuation">;</span>

    util_timer <span class="token operator">*</span>timer <span class="token operator">=</span> <span class="token keyword">new</span> util_timer<span class="token punctuation">;</span>     <span class="token comment">//创建定时器临时变量</span>
    timer<span class="token operator">-&gt;</span>user_data <span class="token operator">=</span> <span class="token operator">&amp;</span>users_timer<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//设置定时器对应的连接资源</span>
    timer<span class="token operator">-&gt;</span>cb_func <span class="token operator">=</span> cb_func<span class="token punctuation">;</span>               <span class="token comment">//设置回调函数</span>
    time_t cur <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//记录当前时间</span>
    timer<span class="token operator">-&gt;</span>expire <span class="token operator">=</span> cur <span class="token operator">+</span> <span class="token number">3</span> <span class="token operator">*</span> TIMESLOT<span class="token punctuation">;</span>     <span class="token comment">//设置绝对超时时间</span>
    users_timer<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> timer<span class="token punctuation">;</span>      <span class="token comment">//创建该连接对应的定时器，初始化为前述临时变量</span>
    utils<span class="token punctuation">.</span>m_timer_lst<span class="token punctuation">.</span><span class="token function">add_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//将该定时器添加到链表中</span>
<span class="token punctuation">}</span>

<span class="token comment">//若有数据传输，则将定时器往后延迟3个单位</span>
<span class="token comment">//并对新的定时器在链表上的位置进行调整</span>
<span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token double-colon punctuation">::</span><span class="token function">adjust_timer</span><span class="token punctuation">(</span>util_timer <span class="token operator">*</span>timer<span class="token punctuation">)</span><span class="token punctuation">{</span>
    time_t cur <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    timer<span class="token operator">-&gt;</span>expire <span class="token operator">=</span> cur <span class="token operator">+</span> <span class="token number">3</span> <span class="token operator">*</span> TIMESLOT<span class="token punctuation">;</span>
    utils<span class="token punctuation">.</span>m_timer_lst<span class="token punctuation">.</span><span class="token function">adjust_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"adjust timer once"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//删除定时器释放资源</span>
<span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token double-colon punctuation">::</span><span class="token function">deal_timer</span><span class="token punctuation">(</span>util_timer <span class="token operator">*</span>timer<span class="token punctuation">,</span> <span class="token keyword">int</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">{</span>
    timer<span class="token operator">-&gt;</span><span class="token function">cb_func</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users_timer<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">{</span>
        utils<span class="token punctuation">.</span>m_timer_lst<span class="token punctuation">.</span><span class="token function">del_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"close fd %d"</span><span class="token punctuation">,</span> users_timer<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//处理链接请求</span>
<span class="token keyword">bool</span> <span class="token class-name">WebServer</span><span class="token double-colon punctuation">::</span><span class="token function">dealclinetdata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//初始化客户端连接地址</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> client_address<span class="token punctuation">;</span>
    socklen_t client_addrlength <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>client_address<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> m_LISTENTrigmode<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//该连接分配的文件描述符</span>
        <span class="token keyword">int</span> connfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>m_listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>client_address<span class="token punctuation">,</span> <span class="token operator">&amp;</span>client_addrlength<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>connfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"%s:errno is:%d"</span><span class="token punctuation">,</span> <span class="token string">"accept error"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>http_conn<span class="token double-colon punctuation">::</span>m_user_count <span class="token operator">&gt;=</span> MAX_FD<span class="token punctuation">)</span><span class="token punctuation">{</span>
            utils<span class="token punctuation">.</span><span class="token function">show_error</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span> <span class="token string">"Internal server busy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"Internal server busy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">timer</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span> client_address<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">int</span> connfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>m_listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>client_address<span class="token punctuation">,</span> <span class="token operator">&amp;</span>client_addrlength<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>connfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"%s:errno is:%d"</span><span class="token punctuation">,</span> <span class="token string">"accept error"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>http_conn<span class="token double-colon punctuation">::</span>m_user_count <span class="token operator">&gt;=</span> MAX_FD<span class="token punctuation">)</span><span class="token punctuation">{</span>
                utils<span class="token punctuation">.</span><span class="token function">show_error</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span> <span class="token string">"Internal server busy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"Internal server busy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">timer</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span> client_address<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token class-name">WebServer</span><span class="token double-colon punctuation">::</span><span class="token function">dealwithsignal</span><span class="token punctuation">(</span><span class="token keyword">bool</span> <span class="token operator">&amp;</span>timeout<span class="token punctuation">,</span> <span class="token keyword">bool</span> <span class="token operator">&amp;</span>stop_server<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> sig<span class="token punctuation">;</span>
    <span class="token keyword">char</span> signals<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">//从管道读端读出信号值，成功返回字节数，失败返回-1</span>
    <span class="token comment">//正常情况下，这里的ret返回值总是1，只有14和15两个ASCII码对应的字符</span>
    ret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>m_pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> signals<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>signals<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//处理异常</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ret<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>signals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">//这里面是字符</span>
                <span class="token keyword">case</span> SIGALRM<span class="token operator">:</span>   <span class="token comment">//这里是整型（14号信号）</span>
                <span class="token punctuation">{</span>
                    timeout <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">case</span> SIGTERM<span class="token operator">:</span>   <span class="token comment">//这里是整型（15号信号）</span>
                <span class="token punctuation">{</span>
                    stop_server <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//处理客户连接上接收到的数据</span>
<span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token double-colon punctuation">::</span><span class="token function">dealwithread</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//创建定时器临时变量，将该连接对应的定时器取出来</span>
    util_timer <span class="token operator">*</span>timer <span class="token operator">=</span> users_timer<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer<span class="token punctuation">;</span>

    <span class="token comment">//reactor</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> m_actormodel<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//若有数据传输，则将定时器往后延迟3个单位  //对其在链表上的位置进行调整</span>
            <span class="token function">adjust_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//调整定时器</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//若监测到读事件，将该事件放入请求队列</span>
        m_pool<span class="token operator">-&gt;</span><span class="token function">append</span><span class="token punctuation">(</span>users <span class="token operator">+</span> sockfd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>improv<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment">//是否处理该非活动链接</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer_flag<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token function">deal_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>improv <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token punctuation">{</span>        <span class="token comment">//proactor</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">read_once</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"deal with the client(%s)"</span><span class="token punctuation">,</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">get_address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//若监测到读事件，将该事件放入请求队列</span>
            m_pool<span class="token operator">-&gt;</span><span class="token function">append_p</span><span class="token punctuation">(</span>users <span class="token operator">+</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token function">adjust_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token punctuation">{</span><span class="token comment">//服务器端关闭连接，移除对应的定时器</span>
            <span class="token function">deal_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//处理定时器</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token double-colon punctuation">::</span><span class="token function">dealwithwrite</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">{</span>
    util_timer <span class="token operator">*</span>timer <span class="token operator">=</span> users_timer<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer<span class="token punctuation">;</span>
    <span class="token comment">//reactor</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> m_actormodel<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">adjust_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        m_pool<span class="token operator">-&gt;</span><span class="token function">append</span><span class="token punctuation">(</span>users <span class="token operator">+</span> sockfd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>improv<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer_flag<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token function">deal_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>improv <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//proactor</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"send data to the client(%s)"</span><span class="token punctuation">,</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">get_address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span>    <span class="token punctuation">{</span>
                <span class="token function">adjust_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">deal_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="09-日志系统（上）"><a href="#09-日志系统（上）" class="headerlink" title="09 日志系统（上）"></a>09 日志系统（上）</h2><h3 id="9-1-基础知识"><a href="#9-1-基础知识" class="headerlink" title="9.1 基础知识"></a>9.1 基础知识</h3><ul>
<li>**<code>日志</code>**，由服务器自动创建，并记录运行状态，错误信息，访问数据的文件。</li>
<li>**<code>同步日志</code>**，日志写入函数与工作线程串行执行，由于涉及到I/O操作，当单条日志比较大的时候，同步模式会阻塞整个处理流程，服务器所能处理的并发能力将有所下降，尤其是在峰值的时候，写日志可能成为系统的瓶颈。</li>
<li>**<code>生产者-消费者模型</code>**，并发编程中的经典模型。以多线程为例，为了实现线程间数据同步，生产者线程与消费者线程共享一个缓冲区，其中生产者线程往缓冲区中push消息，消费者线程从缓冲区中pop消息。</li>
<li>**<code>阻塞队列</code>**，将生产者-消费者模型进行封装，使用循环数组实现队列，作为两者共享的缓冲区。</li>
<li>**<code>异步日志</code>**，将所写的日志内容先存入阻塞队列，写线程从阻塞队列中取出内容，写入日志。</li>
<li>**<code>单例模式</code>**，最简单也是被问到最多的设计模式之一，保证一个类只创建一个实例，同时提供全局访问的方法。</li>
</ul>
<h3 id="9-2-整体概述"><a href="#9-2-整体概述" class="headerlink" title="9.2 整体概述"></a>9.2 整体概述</h3><p>本项目中，<strong>使用单例模式创建日志系统，对服务器运行状态、错误信息和访问数据进行记录，该系统可以实现按天分类，超行分类功能，可以根据实际情况分别使用同步和异步写入两种方式</strong>。</p>
<p>其中异步写入方式，将生产者-消费者模型封装为阻塞队列，创建一个写线程，工作线程将要写的内容push进队列，写线程从队列中取出内容，写入日志文件。</p>
<p>日志系统大致可以分成两部分，其一是单例模式与阻塞队列的定义，其二是日志类的定义与使用。</p>
<h3 id="9-3-本文内容"><a href="#9-3-本文内容" class="headerlink" title="9.3 本文内容"></a>9.3 本文内容</h3><p>本篇将介绍单例模式与阻塞队列的定义，具体的涉及到单例模式、生产者-消费者模型，阻塞队列的代码实现。</p>
<ul>
<li><strong>单例模式</strong>，描述懒汉与饿汉两种单例模式，并结合线程安全进行讨论。</li>
<li><strong>生产者-消费者模型</strong>，描述条件变量，基于该同步机制实现简单的生产者-消费者模型。</li>
<li><strong>代码实现</strong>，结合代码对阻塞队列的设计进行详解。</li>
</ul>
<h3 id="9-4-单例模式"><a href="#9-4-单例模式" class="headerlink" title="9.4 单例模式"></a>9.4 单例模式</h3><p>单例模式作为最常用的设计模式之一，保证一个类仅有一个实例，并提供一个访问它的全局访问点，该实例被所有程序模块共享。</p>
<p>实现思路：私有化它的构造函数，以防止外界创建单例类的对象；使用类的私有静态指针变量指向类的唯一实例，并用一个公有的静态方法获取该实例。</p>
<p>单例模式有两种实现方法，分别是懒汉和饿汉模式。顾名思义，懒汉模式，即非常懒，不用的时候不去初始化，所以在第一次被使用时才进行初始化；饿汉模式，即迫不及待，在程序运行时立即初始化。</p>
<h4 id="9-4-1-经典的线程安全懒汉模式"><a href="#9-4-1-经典的线程安全懒汉模式" class="headerlink" title="9.4.1 经典的线程安全懒汉模式"></a>9.4.1 经典的线程安全懒汉模式</h4><p>单例模式的实现思路如前述所示，其中，经典的线程安全懒汉模式，使用双检测锁模式。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">single</span><span class="token punctuation">{</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token comment">//私有静态指针变量指向唯一实例</span>
    <span class="token keyword">static</span> single <span class="token operator">*</span>p<span class="token punctuation">;</span>
    
    <span class="token comment">//静态锁，是由于静态函数只能访问静态成员</span>
    <span class="token keyword">static</span> pthread_mutex_t lock<span class="token punctuation">;</span>
    
    <span class="token comment">//私有化构造函数</span>
    <span class="token function">single</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock，<span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">single</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token comment">//公有静态方法获取实例</span>
    <span class="token keyword">static</span> single<span class="token operator">*</span><span class="token function">getinstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

pthread_mutex_t single<span class="token double-colon punctuation">::</span> lock<span class="token punctuation">;</span>
single<span class="token operator">*</span> single<span class="token double-colon punctuation">::</span>p <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
single<span class="token operator">*</span> single<span class="token double-colon punctuation">::</span><span class="token function">getinstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> p<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> p<span class="token punctuation">)</span><span class="token punctuation">{</span>
            p <span class="token operator">=</span> <span class="token keyword">new</span> single<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> p<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong><code>为什么要用双检测，只检测一次不行吗？</code></strong></p>
<p>如果只检测一次，在每次调用获取实例的方法时，都需要加锁，这将严重影响程序性能。双层检测可以有效避免这种情况，仅在第一次创建单例的时候加锁，其他时候都不再符合<code>NULL == p</code>的情况，直接返回已创建好的实例。</p>
<h4 id="9-4-2-局部静态变量之线程安全懒汉模式"><a href="#9-4-2-局部静态变量之线程安全懒汉模式" class="headerlink" title="9.4.2 局部静态变量之线程安全懒汉模式"></a>9.4.2 局部静态变量之线程安全懒汉模式</h4><p>前面的双检测锁模式，写起来不太优雅，《Effective C++》（Item 04）中的提出另一种更优雅的单例模式实现，使用函数内的局部静态对象，这种方法不用加锁和解锁操作。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">single</span><span class="token punctuation">{</span>
 <span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token function">single</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">single</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">static</span> single<span class="token operator">*</span> <span class="token function">getinstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

single<span class="token operator">*</span> single<span class="token double-colon punctuation">::</span><span class="token function">getinstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">static</span> single obj<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>obj<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong><code>这时候有人说了，这种方法不加锁会不会造成线程安全问题？</code></strong></p>
<p>其实，C++0X以后，要求编译器保证内部静态变量的线程安全性，故C++0x之后该实现是线程安全的，C++0x之前仍需加锁，其中C++0x是C++11标准成为正式标准之前的草案临时名字。</p>
<p>所以，如果使用C++11之前的标准，还是需要加锁，这里同样给出加锁的版本。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">single</span><span class="token punctuation">{</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">static</span> pthread_mutex_t lock<span class="token punctuation">;</span>
    <span class="token function">single</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">pthread_mutex_init</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>lock，<span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">single</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">}</span>
<span class="token keyword">public</span><span class="token operator">:</span>
   <span class="token keyword">static</span> single<span class="token operator">*</span> <span class="token function">getinstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
              
pthread_mutex_t single<span class="token double-colon punctuation">::</span> lock<span class="token punctuation">;</span>

single<span class="token operator">*</span> single<span class="token double-colon punctuation">::</span><span class="token function">getinstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">static</span> single obj<span class="token punctuation">;</span>
     <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> <span class="token operator">&amp;</span>obj<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="9-4-3-饿汉模式"><a href="#9-4-3-饿汉模式" class="headerlink" title="9.4.3 饿汉模式"></a>9.4.3 饿汉模式</h4><p>饿汉模式不需要用锁，就可以实现线程安全。原因在于，在程序运行时就定义了对象，并对其初始化。之后，不管哪个线程调用成员函数getinstance()，都只不过是返回一个对象的指针而已。所以是线程安全的，不需要在获取实例的成员函数中加锁。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">single</span><span class="token punctuation">{</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">static</span> single<span class="token operator">*</span> p<span class="token punctuation">;</span>
    <span class="token function">single</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">single</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">static</span> single<span class="token operator">*</span> <span class="token function">getinstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//加载时实例化</span>
single<span class="token operator">*</span> single<span class="token double-colon punctuation">::</span>p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">single</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
single<span class="token operator">*</span> single<span class="token double-colon punctuation">::</span><span class="token function">getinstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> p<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//测试方法</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    single <span class="token operator">*</span>p1 <span class="token operator">=</span> single<span class="token double-colon punctuation">::</span><span class="token function">getinstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    single <span class="token operator">*</span>p2 <span class="token operator">=</span> single<span class="token double-colon punctuation">::</span><span class="token function">getinstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>p1 <span class="token operator">==</span> p2<span class="token punctuation">)</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"same"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"pause"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>饿汉模式虽好，但其存在隐藏的问题，在于非静态对象（函数外的static对象）在不同编译单元中的初始化顺序是未定义的。如果在初始化完成之前调用 getInstance() 方法会返回一个未定义的实例。</p>
<h3 id="9-5-条件变量与生产者-消费者模型"><a href="#9-5-条件变量与生产者-消费者模型" class="headerlink" title="9.5 条件变量与生产者-消费者模型"></a>9.5 条件变量与生产者-消费者模型</h3><h4 id="9-5-1-条件变量API与陷阱"><a href="#9-5-1-条件变量API与陷阱" class="headerlink" title="9.5.1 条件变量API与陷阱"></a>9.5.1 条件变量API与陷阱</h4><p>条件变量提供了一种线程间的通知机制，当某个共享数据达到某个值时,唤醒等待这个共享数据的线程。</p>
<h5 id="基础API"><a href="#基础API" class="headerlink" title="基础API"></a>基础API</h5><ul>
<li><code>pthread_cond_init</code>函数，用于初始化条件变量</li>
<li><code>pthread_cond_destory</code>函数，销毁条件变量</li>
<li><code>pthread_cond_broadcast</code>函数，以广播的方式唤醒<strong>所有</strong>等待目标条件变量的线程</li>
<li><code>pthread_cond_wait</code>函数，用于等待目标条件变量。该函数调用时需要传入 <strong>mutex参数(加锁的互斥锁)</strong> ，函数执行时，先把调用线程放入条件变量的请求队列，然后将互斥锁mutex解锁，当函数成功返回为0时，表示重新抢到了互斥锁，互斥锁会再次被锁上， <strong>也就是说函数内部会有一次解锁和加锁操作</strong>.</li>
</ul>
<p>使用pthread_cond_wait方式如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">pthread <span class="token function">_mutex_lock</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span>
<span class="token keyword">while</span><span class="token punctuation">(</span>线程执行的条件是否成立<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">pthread_cond_wait</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>cond<span class="token punctuation">,</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>pthread_cond_wait</code>执行后的内部操作分为以下几步：</p>
<ul>
<li>将线程放在条件变量的请求队列后，内部解锁</li>
<li>线程等待被<code>pthread_cond_broadcast</code>信号唤醒或者<code>pthread_cond_signal</code>信号唤醒，唤醒后去竞争锁</li>
<li>若竞争到互斥锁，内部再次加锁</li>
</ul>
<h5 id="陷阱一"><a href="#陷阱一" class="headerlink" title="陷阱一"></a>陷阱一</h5><p><strong><code>使用前要加锁，为什么要加锁？</code></strong></p>
<p>多线程访问，为了避免资源竞争，所以要加锁，使得每个线程互斥的访问公有资源。</p>
<p><strong><code>pthread_cond_wait内部为什么要解锁？</code></strong></p>
<p>如果while或者if判断的时候，满足执行条件，线程便会调用<code>pthread_cond_wait</code>阻塞自己，此时它还在持有锁，如果他不解锁，那么其他线程将会无法访问公有资源。</p>
<p>具体到<code>pthread_cond_wait</code>的内部实现，当<code>pthread_cond_wait</code>被调用线程阻塞的时候，pthread_cond_wait会自动释放互斥锁。</p>
<p><strong><code>为什么要把调用线程放入条件变量的请求队列后再解锁？</code></strong></p>
<p>线程是并发执行的，如果在把调用线程A放在等待队列之前，就释放了互斥锁，这就意味着其他线程比如线程B可以获得互斥锁去访问公有资源，这时候线程A所等待的条件改变了，但是它没有被放在等待队列上，导致A忽略了等待条件被满足的信号。</p>
<p>倘若在线程A调用pthread_cond_wait开始，到把A放在等待队列的过程中，都持有互斥锁，其他线程无法得到互斥锁，就不能改变公有资源。</p>
<p><strong><code>为什么最后还要加锁？</code></strong></p>
<p>将线程放在条件变量的请求队列后，将其解锁，此时等待被唤醒，若成功竞争到互斥锁，再次加锁。</p>
<h5 id="陷阱二"><a href="#陷阱二" class="headerlink" title="陷阱二"></a>陷阱二</h5><p><strong><code>为什么判断线程执行的条件用while而不是if？</code></strong></p>
<p>一般来说，在多线程资源竞争的时候，在一个使用资源的线程里面（消费者）判断资源是否可用，不可用，便调用pthread_cond_wait，在另一个线程里面（生产者）如果判断资源可用的话，则调用pthread_cond_signal发送一个资源可用信号。</p>
<p>在wait成功之后，资源就一定可以被使用么？答案是否定的，如果同时有两个或者两个以上的线程正在等待此资源，wait返回后，资源可能已经被使用了。</p>
<p>再具体点，有可能多个线程都在等待这个资源可用的信号，信号发出后只有一个资源可用，但是有A，B两个线程都在等待，B比较速度快，获得互斥锁，然后加锁，消耗资源，然后解锁，之后A获得互斥锁，但A回去发现资源已经被使用了，它便有两个选择，一个是去访问不存在的资源，另一个就是继续等待，那么继续等待下去的条件就是使用while，要不然使用if的话<code>pthread_cond_wait</code>返回后，就会顺序执行下去。</p>
<p>所以，在这种情况下，应该使用while而不是if:</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">while</span><span class="token punctuation">(</span>resource <span class="token operator">==</span> FALSE<span class="token punctuation">)</span>
    <span class="token function">pthread_cond_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cond<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>如果只有一个消费者，那么使用if是可以的。</p>
<h4 id="9-5-2-生产者-消费者模型"><a href="#9-5-2-生产者-消费者模型" class="headerlink" title="9.5.2 生产者-消费者模型"></a>9.5.2 生产者-消费者模型</h4><p>这里摘抄《Unix 环境高级编程》中第11章线程关于pthread_cond_wait的介绍中有一个生产者-消费者的例子P311，其中，process_msg相当于消费者，enqueue_msg相当于生产者，struct msg* workq作为缓冲队列。</p>
<p>生产者和消费者是互斥关系，两者对缓冲区访问互斥，同时生产者和消费者又是一个相互协作与同步的关系，只有生产者生产之后，消费者才能消费。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token keyword">struct</span> <span class="token class-name">msg</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">msg</span> <span class="token operator">*</span>m_next<span class="token punctuation">;</span>
    <span class="token comment">/*value. . .*/</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">msg</span><span class="token operator">*</span> workq<span class="token punctuation">;</span>
pthread_cond_t qready <span class="token operator">=</span> PTHREAD_COND_INITIALIZER<span class="token punctuation">;</span>
pthread_mutex_t qlock <span class="token operator">=</span> PTHREAD_MUTEX_INITIALIZER<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">process_msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">msg</span><span class="token operator">*</span> mp<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>qlock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//这里需要用while，而不是if</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>workq <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">pthread_cond_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>qread<span class="token punctuation">,</span><span class="token operator">&amp;</span>qlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    mq<span class="token operator">=</span> workq<span class="token punctuation">;</span>
    workq <span class="token operator">=</span> mp<span class="token operator">-&gt;</span>m_next<span class="token punctuation">;</span>
    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>qlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*now process the message mp */</span>
<span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">enqueue_msg</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">msg</span><span class="token operator">*</span> mp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>qlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mp<span class="token operator">-&gt;</span>m_next <span class="token operator">=</span> workq<span class="token punctuation">;</span>
        workq <span class="token operator">=</span> mp<span class="token punctuation">;</span>
        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>qlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/**此时另外一个线程在signal之前，执行了process_msg，刚好把mp元素拿走*/</span>
        pthread_ <span class="token function">cond_signal</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>qready<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/**此时执行signal，在pthread_cond_wait等待的线程被唤醒，
但是mp元素已经被另外一个线程拿走，所以，workq还是NULL ,因此需要继续等待*/</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="9-6-阻塞队列代码分析"><a href="#9-6-阻塞队列代码分析" class="headerlink" title="9.6 阻塞队列代码分析"></a>9.6 阻塞队列代码分析</h3><p>阻塞队列类中封装了生产者-消费者模型，其中push成员是生产者，pop成员是消费者。</p>
<p>阻塞队列中，使用了循环数组实现了队列，作为两者共享缓冲区，当然了，队列也可以使用STL中的queue。</p>
<h4 id="9-6-1-自定义队列"><a href="#9-6-1-自定义队列" class="headerlink" title="9.6.1 自定义队列"></a>9.6.1 自定义队列</h4><p>当队列为空时，从队列中获取元素的线程将会被挂起；当队列是满时，往队列里添加元素的线程将会挂起。</p>
<p>阻塞队列类中，有些代码比较简单，这里仅对push和pop成员进行详解。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/*************************************************************
*循环数组实现的阻塞队列，m_back = (m_back + 1) % m_max_size;  
*线程安全，每个操作前都要先加互斥锁，操作完后，再解锁
**************************************************************/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">BLOCK_QUEUE_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BLOCK_QUEUE_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"../lock/locker.h"</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">class</span> <span class="token class-name">block_queue</span><span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token comment">//初始化私有成员</span>
    <span class="token function">block_queue</span><span class="token punctuation">(</span><span class="token keyword">int</span> max_size <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>max_size <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//构造函数创建循环数组</span>
        m_max_size <span class="token operator">=</span> max_size<span class="token punctuation">;</span>
        m_array <span class="token operator">=</span> <span class="token keyword">new</span> T<span class="token punctuation">[</span>max_size<span class="token punctuation">]</span><span class="token punctuation">;</span>
        m_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        m_front <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        m_back <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>       <span class="token comment">//清除队列</span>
        m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        m_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        m_front <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        m_back <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">~</span><span class="token function">block_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>     <span class="token comment">//析构</span>
        m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m_array <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
            <span class="token keyword">delete</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> m_array<span class="token punctuation">;</span>

        m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">//判断队列是否满了</span>
    <span class="token keyword">bool</span> <span class="token function">full</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m_size <span class="token operator">&gt;=</span> m_max_size<span class="token punctuation">)</span><span class="token punctuation">{</span>
            m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//判断队列是否为空</span>
    <span class="token keyword">bool</span> <span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> m_size<span class="token punctuation">)</span><span class="token punctuation">{</span>
            m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//返回队首元素</span>
    <span class="token keyword">bool</span> <span class="token function">front</span><span class="token punctuation">(</span>T <span class="token operator">&amp;</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> m_size<span class="token punctuation">)</span><span class="token punctuation">{</span>
            m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        value <span class="token operator">=</span> m_array<span class="token punctuation">[</span>m_front<span class="token punctuation">]</span><span class="token punctuation">;</span>
        m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//返回队尾元素</span>
    <span class="token keyword">bool</span> <span class="token function">back</span><span class="token punctuation">(</span>T <span class="token operator">&amp;</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> m_size<span class="token punctuation">)</span><span class="token punctuation">{</span>
            m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        value <span class="token operator">=</span> m_array<span class="token punctuation">[</span>m_back<span class="token punctuation">]</span><span class="token punctuation">;</span>
        m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//返回队列大小</span>
    <span class="token keyword">int</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> tmp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tmp <span class="token operator">=</span> m_size<span class="token punctuation">;</span>

        m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> tmp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//返回队列容量</span>
    <span class="token keyword">int</span> <span class="token function">max_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">int</span> tmp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tmp <span class="token operator">=</span> m_max_size<span class="token punctuation">;</span>

        m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> tmp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">//往队列添加元素，需要将所有使用队列的线程先唤醒</span>
    <span class="token comment">//当有元素push进队列,相当于生产者生产了一个元素</span>
    <span class="token comment">//若当前没有线程等待条件变量,则唤醒无意义</span>
    <span class="token keyword">bool</span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">const</span> T <span class="token operator">&amp;</span>item<span class="token punctuation">)</span><span class="token punctuation">{</span>

        m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m_size <span class="token operator">&gt;=</span> m_max_size<span class="token punctuation">)</span><span class="token punctuation">{</span>
            m_cond<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//将新增数据放在循环数组的对应位置</span>
        m_back <span class="token operator">=</span> <span class="token punctuation">(</span>m_back <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> m_max_size<span class="token punctuation">;</span>
        m_array<span class="token punctuation">[</span>m_back<span class="token punctuation">]</span> <span class="token operator">=</span> item<span class="token punctuation">;</span>
        m_size<span class="token operator">++</span><span class="token punctuation">;</span>
        m_cond<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//pop时,如果当前队列没有元素,将会等待条件变量</span>
    <span class="token keyword">bool</span> <span class="token function">pop</span><span class="token punctuation">(</span>T <span class="token operator">&amp;</span>item<span class="token punctuation">)</span><span class="token punctuation">{</span>
        m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//多个消费者的时候，这里要是用while而不是if</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>m_size <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//当重新抢到互斥锁，pthread_cond_wait返回为0</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_cond<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>m_mutex<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//取出队列首的元素，这里需要理解一下，使用循环数组模拟的队列 </span>
        m_front <span class="token operator">=</span> <span class="token punctuation">(</span>m_front <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> m_max_size<span class="token punctuation">;</span>
        item <span class="token operator">=</span> m_array<span class="token punctuation">[</span>m_front<span class="token punctuation">]</span><span class="token punctuation">;</span>
        m_size<span class="token operator">--</span><span class="token punctuation">;</span>
        m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//增加了超时处理，在项目中没有使用到</span>
    <span class="token comment">//在pthread_cond_wait基础上增加了等待的时间，只指定时间内能抢到互斥锁即可</span>
    <span class="token comment">//其他逻辑不变</span>
    <span class="token keyword">bool</span> <span class="token function">pop</span><span class="token punctuation">(</span>T <span class="token operator">&amp;</span>item<span class="token punctuation">,</span> <span class="token keyword">int</span> ms_timeout<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">timespec</span> t <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">timeval</span> now <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>now<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m_size <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            t<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> now<span class="token punctuation">.</span>tv_sec <span class="token operator">+</span> ms_timeout <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>
            t<span class="token punctuation">.</span>tv_nsec <span class="token operator">=</span> <span class="token punctuation">(</span>ms_timeout <span class="token operator">%</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_cond<span class="token punctuation">.</span><span class="token function">timewait</span><span class="token punctuation">(</span>m_mutex<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>m_size <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        m_front <span class="token operator">=</span> <span class="token punctuation">(</span>m_front <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> m_max_size<span class="token punctuation">;</span>
        item <span class="token operator">=</span> m_array<span class="token punctuation">[</span>m_front<span class="token punctuation">]</span><span class="token punctuation">;</span>
        m_size<span class="token operator">--</span><span class="token punctuation">;</span>
        m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    locker m_mutex<span class="token punctuation">;</span>     <span class="token comment">//锁</span>
    cond m_cond<span class="token punctuation">;</span>        <span class="token comment">//条件变量</span>

    T <span class="token operator">*</span>m_array<span class="token punctuation">;</span>         <span class="token comment">//用数组实现阻塞队列</span>
    <span class="token keyword">int</span> m_size<span class="token punctuation">;</span>         <span class="token comment">//阻塞队列目前的大小</span>
    <span class="token keyword">int</span> m_max_size<span class="token punctuation">;</span>     <span class="token comment">//阻塞队列的容量</span>
    <span class="token keyword">int</span> m_front<span class="token punctuation">;</span>        <span class="token comment">//阻塞队列的队头</span>
    <span class="token keyword">int</span> m_back<span class="token punctuation">;</span>         <span class="token comment">//阻塞队列的队尾</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="10-日志系统（下）"><a href="#10-日志系统（下）" class="headerlink" title="10 日志系统（下）"></a>10 日志系统（下）</h2><h3 id="10-1-本文内容"><a href="#10-1-本文内容" class="headerlink" title="10.1 本文内容"></a>10.1 本文内容</h3><p>日志系统分为两部分，其一是单例模式与阻塞队列的定义，其二是日志类的定义与使用。</p>
<p>本篇将介绍日志类的定义与使用，具体的涉及到基础API，流程图与日志类定义，功能实现。</p>
<p><strong>基础API</strong>，描述fputs，可变参数宏__VA_ARGS__，fflush</p>
<p><strong>流程图与日志类定义</strong>，描述日志系统整体运行流程，介绍日志类的具体定义</p>
<p><strong>功能实现</strong>，结合代码分析同步、异步写文件逻辑，分析超行、按天分文件和日志分级的具体实现</p>
<h3 id="10-2-基础API"><a href="#10-2-基础API" class="headerlink" title="10.2 基础API"></a>10.2 基础API</h3><p>为了更好的源码阅读体验，这里对一些API用法进行介绍。</p>
<h4 id="fputs"><a href="#fputs" class="headerlink" title="fputs"></a>fputs</h4><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">fputs</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>str<span class="token punctuation">,</span> FILE <span class="token operator">*</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>str，一个数组，包含了要写入的以空字符终止的字符序列。</li>
<li>stream，指向FILE对象的指针，该FILE对象标识了要被写入字符串的流。</li>
</ul>
<h4 id="可变参数宏-VA-ARGS"><a href="#可变参数宏-VA-ARGS" class="headerlink" title="可变参数宏__VA_ARGS__"></a>可变参数宏__VA_ARGS__</h4><p>__VA_ARGS__是一个可变参数的宏，定义时宏定义中参数列表的最后一个参数为省略号，在实际使用时会发现有时会加##，有时又不加。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//最简单的定义</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">my_print1</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>  <span class="token function">printf</span><span class="token punctuation">(</span>__VA_ARGS__<span class="token punctuation">)</span></span></span>

<span class="token comment">//搭配va_list的format使用</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">my_print2</span><span class="token expression"><span class="token punctuation">(</span>format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span>format<span class="token punctuation">,</span> __VA_ARGS__<span class="token punctuation">)</span>  </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">my_print3</span><span class="token expression"><span class="token punctuation">(</span>format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span>format<span class="token punctuation">,</span> </span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>__VA_ARGS__宏前面加上##的作用在于，当可变参数的个数为0时，这里printf参数列表中的的##会把前面多余的”,”去掉，否则会编译出错，建议使用后面这种，使得程序更加健壮。</p>
<h4 id="fflush"><a href="#fflush" class="headerlink" title="fflush"></a>fflush</h4><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">fflush</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>fflush()会强迫将缓冲区内的数据写回参数stream 指定的文件中，如果参数stream 为NULL，fflush()会将所有打开的文件数据更新。</p>
<p>在使用多个输出函数连续进行多次输出到控制台时，有可能下一个数据再上一个数据还没输出完毕，还在输出缓冲区中时，下一个printf就把另一个数据加入输出缓冲区，结果冲掉了原来的数据，出现输出错误。</p>
<p>在prinf()后加上fflush(stdout); 强制马上输出到控制台，可以避免出现上述错误。</p>
<h3 id="10-3-流程图与日志类定义"><a href="#10-3-流程图与日志类定义" class="headerlink" title="10.3 流程图与日志类定义"></a>10.3 流程图与日志类定义</h3><h4 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h4><ul>
<li><p>日志文件</p>
</li>
<li><ul>
<li>局部变量的懒汉模式获取实例<ul>
<li>生成日志文件，并判断同步和异步写入方式</li>
</ul>
</li>
</ul>
</li>
<li><p>同步</p>
</li>
<li><ul>
<li>判断是否分文件<ul>
<li>直接格式化输出内容，将信息写入日志文件</li>
</ul>
</li>
</ul>
</li>
<li><p>异步</p>
</li>
<li><ul>
<li>判断是否分文件<ul>
<li>格式化输出内容，将内容写入阻塞队列，创建一个写线程，从阻塞队列取出内容写入日志文件</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2023/cpp/image-20230321105417349.png" alt="image-20230321105417349"></p>
<h4 id="日志类定义"><a href="#日志类定义" class="headerlink" title="日志类定义"></a>日志类定义</h4><p>通过局部变量的懒汉单例模式创建日志实例，对其进行初始化生成日志文件后，格式化输出内容，并根据不同的写入方式，完成对应逻辑，写入日志文件。</p>
<p>日志类包括但不限于如下方法，</p>
<ul>
<li>公有的实例获取方法</li>
<li>初始化日志文件方法</li>
<li>异步日志写入方法，内部调用私有异步方法</li>
<li>内容格式化方法</li>
<li>刷新缓冲区</li>
<li>…</li>
</ul>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">LOG_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LOG_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdarg.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"block_queue.h"</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Log</span><span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token comment">//C++11以后,使用局部变量懒汉不用加锁</span>
    <span class="token keyword">static</span> Log <span class="token operator">*</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">static</span> Log instance<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>instance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//异步写日志公有方法，调用私有方法async_write_log</span>
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">flush_log_thread</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Log</span><span class="token double-colon punctuation">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">async_write_log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//可选择的参数有日志文件、日志缓冲区大小、最大行数以及最长日志条队列</span>
    <span class="token keyword">bool</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>file_name<span class="token punctuation">,</span> <span class="token keyword">int</span> close_log<span class="token punctuation">,</span> <span class="token keyword">int</span> log_buf_size <span class="token operator">=</span> <span class="token number">8192</span><span class="token punctuation">,</span> <span class="token keyword">int</span> split_lines <span class="token operator">=</span> <span class="token number">5000000</span><span class="token punctuation">,</span> <span class="token keyword">int</span> max_queue_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//将输出内容按照标准格式整理</span>
    <span class="token keyword">void</span> <span class="token function">write_log</span><span class="token punctuation">(</span><span class="token keyword">int</span> level<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//强制刷新缓冲区</span>
    <span class="token keyword">void</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//异步写日志方法</span>
    <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">async_write_log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        string single_log<span class="token punctuation">;</span>
        <span class="token comment">//从阻塞队列中取出一个日志string，写入文件</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>m_log_queue<span class="token operator">-&gt;</span><span class="token function">pop</span><span class="token punctuation">(</span>single_log<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">fputs</span><span class="token punctuation">(</span>single_log<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> m_fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">char</span> dir_name<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//路径名</span>
    <span class="token keyword">char</span> log_name<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//log文件名</span>
    <span class="token keyword">int</span> m_split_lines<span class="token punctuation">;</span>  <span class="token comment">//日志最大行数</span>
    <span class="token keyword">int</span> m_log_buf_size<span class="token punctuation">;</span> <span class="token comment">//日志缓冲区大小</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> m_count<span class="token punctuation">;</span>  <span class="token comment">//日志行数记录</span>
    <span class="token keyword">int</span> m_today<span class="token punctuation">;</span>        <span class="token comment">//因为按天分类,记录当前时间是那一天</span>
    FILE <span class="token operator">*</span>m_fp<span class="token punctuation">;</span>         <span class="token comment">//打开log的文件指针</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>m_buf<span class="token punctuation">;</span>        <span class="token comment">//要输出的内容</span>
    block_queue<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token operator">*</span>m_log_queue<span class="token punctuation">;</span> <span class="token comment">//阻塞队列</span>
    <span class="token keyword">bool</span> m_is_async<span class="token punctuation">;</span>                  <span class="token comment">//是否异步标志位</span>
    locker m_mutex<span class="token punctuation">;</span>
    <span class="token keyword">int</span> m_close_log<span class="token punctuation">;</span> <span class="token comment">//关闭日志</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//这四个宏定义在其他文件中使用，主要用于不同类型的日志输出</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOG_DEBUG</span><span class="token expression"><span class="token punctuation">(</span>format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> m_close_log<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token class-name">Log</span><span class="token double-colon punctuation">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">write_log</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> format<span class="token punctuation">,</span> </span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token class-name">Log</span><span class="token double-colon punctuation">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOG_INFO</span><span class="token expression"><span class="token punctuation">(</span>format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> m_close_log<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token class-name">Log</span><span class="token double-colon punctuation">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">write_log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> format<span class="token punctuation">,</span> </span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token class-name">Log</span><span class="token double-colon punctuation">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOG_WARN</span><span class="token expression"><span class="token punctuation">(</span>format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> m_close_log<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token class-name">Log</span><span class="token double-colon punctuation">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">write_log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> format<span class="token punctuation">,</span> </span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token class-name">Log</span><span class="token double-colon punctuation">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOG_ERROR</span><span class="token expression"><span class="token punctuation">(</span>format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> m_close_log<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token class-name">Log</span><span class="token double-colon punctuation">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">write_log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> format<span class="token punctuation">,</span> </span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token class-name">Log</span><span class="token double-colon punctuation">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>日志类中的方法都不会被其他程序直接调用，末尾的四个可变参数宏提供了其他程序的调用方法。</p>
<p>前述方法对日志等级进行分类，包括DEBUG，INFO，WARN和ERROR四种级别的日志。</p>
<h3 id="10-4-功能实现"><a href="#10-4-功能实现" class="headerlink" title="10.4 功能实现"></a>10.4 功能实现</h3><p>init函数实现日志创建、写入方式的判断。</p>
<p>write_log函数完成写入日志文件中的具体内容，主要实现日志分级、分文件、格式化输出内容。</p>
<h4 id="生成日志文件-amp-amp-判断写入方式"><a href="#生成日志文件-amp-amp-判断写入方式" class="headerlink" title="生成日志文件 &amp;&amp; 判断写入方式"></a>生成日志文件 &amp;&amp; 判断写入方式</h4><p>通过单例模式获取唯一的日志类，调用init方法，初始化生成日志文件，服务器启动按当前时刻创建日志，前缀为时间，后缀为自定义log文件名，并记录创建日志的时间day和行数count。</p>
<p>写入方式通过初始化时<strong>是否设置队列大小</strong>（表示在队列中可以放几条数据）来判断，若队列大小为0，则为同步，否则为异步。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//异步需要设置阻塞队列的长度，同步不需要设置</span>
<span class="token keyword">bool</span> <span class="token class-name">Log</span><span class="token double-colon punctuation">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>file_name<span class="token punctuation">,</span> <span class="token keyword">int</span> close_log<span class="token punctuation">,</span> <span class="token keyword">int</span> log_buf_size<span class="token punctuation">,</span> <span class="token keyword">int</span> split_lines<span class="token punctuation">,</span> <span class="token keyword">int</span> max_queue_size<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//如果设置了max_queue_size,则设置为异步</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>max_queue_size <span class="token operator">&gt;=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        m_is_async <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment">//设置写入方式flag</span>
        m_log_queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token generic-function"><span class="token function">block_queue</span><span class="token generic class-name"><span class="token operator">&lt;</span>string<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>max_queue_size<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建并设置阻塞队列长度</span>
        pthread_t tid<span class="token punctuation">;</span>
        <span class="token comment">//flush_log_thread为回调函数,这里表示创建线程异步写日志</span>
        <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> flush_log_thread<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//输出内容的长度</span>
    m_close_log <span class="token operator">=</span> close_log<span class="token punctuation">;</span>
    m_log_buf_size <span class="token operator">=</span> log_buf_size<span class="token punctuation">;</span>
    m_buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span>m_log_buf_size<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>m_buf<span class="token punctuation">,</span> <span class="token char">'\0'</span><span class="token punctuation">,</span> m_log_buf_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//日志的最大行数</span>
    m_split_lines <span class="token operator">=</span> split_lines<span class="token punctuation">;</span>

    time_t t <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">tm</span> <span class="token operator">*</span>sys_tm <span class="token operator">=</span> <span class="token function">localtime</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">tm</span> my_tm <span class="token operator">=</span> <span class="token operator">*</span>sys_tm<span class="token punctuation">;</span>

    <span class="token comment">//从后往前找到第一个/的位置</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span>file_name<span class="token punctuation">,</span> <span class="token char">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> log_full_name<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    <span class="token comment">//相当于自定义日志名</span>
    <span class="token comment">//若输入的文件名没有/，则直接将时间+文件名作为日志名</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">snprintf</span><span class="token punctuation">(</span>log_full_name<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token string">"%d_%02d_%02d_%s"</span><span class="token punctuation">,</span> my_tm<span class="token punctuation">.</span>tm_year <span class="token operator">+</span> <span class="token number">1900</span><span class="token punctuation">,</span> my_tm<span class="token punctuation">.</span>tm_mon <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> my_tm<span class="token punctuation">.</span>tm_mday<span class="token punctuation">,</span> file_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token comment">//将/的位置向后移动一个位置，然后复制到logname中</span>
        <span class="token comment">//p - file_name + 1是文件所在路径文件夹的长度</span>
        <span class="token comment">//dirname相当于./</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>log_name<span class="token punctuation">,</span> p <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strncpy</span><span class="token punctuation">(</span>dir_name<span class="token punctuation">,</span> file_name<span class="token punctuation">,</span> p <span class="token operator">-</span> file_name <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//后面的参数跟format有关</span>
        <span class="token function">snprintf</span><span class="token punctuation">(</span>log_full_name<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token string">"%s%d_%02d_%02d_%s"</span><span class="token punctuation">,</span> dir_name<span class="token punctuation">,</span> my_tm<span class="token punctuation">.</span>tm_year <span class="token operator">+</span> <span class="token number">1900</span><span class="token punctuation">,</span> my_tm<span class="token punctuation">.</span>tm_mon <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> my_tm<span class="token punctuation">.</span>tm_mday<span class="token punctuation">,</span> log_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    m_today <span class="token operator">=</span> my_tm<span class="token punctuation">.</span>tm_mday<span class="token punctuation">;</span>
    
    m_fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>log_full_name<span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_fp <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="日志分级与分文件"><a href="#日志分级与分文件" class="headerlink" title="日志分级与分文件"></a><strong>日志分级与分文件</strong></h4><p>日志分级的实现大同小异，一般的会提供五种级别，具体的，</p>
<ul>
<li>Debug，调试代码时的输出，在系统实际运行时，一般不使用。</li>
<li>Warn，这种警告与调试时终端的warning类似，同样是调试代码时使用。</li>
<li>Info，报告系统当前的状态，当前执行的流程或接收的信息等。</li>
<li>Error和Fatal，输出系统的错误信息。</li>
</ul>
<p>上述的使用方法仅仅是个人理解，在开发中具体如何选择等级因人而异。项目中给出了除Fatal外的四种分级，实际使用了Debug，Info和Error三种。</p>
<p>超行、按天分文件逻辑，具体的，</p>
<ul>
<li><p>日志写入前会判断当前day是否为创建日志的时间，行数是否超过最大行限制</p>
</li>
<li><ul>
<li>若为创建日志时间，写入日志，否则按当前时间创建新log，更新创建时间和行数<ul>
<li>若行数超过最大行限制，在当前日志的末尾加count/max_lines为后缀创建新log</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>将系统信息格式化后输出，具体为：格式化时间 + 格式化内容</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//将系统信息格式化后输出，具体为：格式化时间 + 格式化内容</span>
<span class="token keyword">void</span> <span class="token class-name">Log</span><span class="token double-colon punctuation">::</span><span class="token function">write_log</span><span class="token punctuation">(</span><span class="token keyword">int</span> level<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">timeval</span> now <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>now<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    time_t t <span class="token operator">=</span> now<span class="token punctuation">.</span>tv_sec<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">tm</span> <span class="token operator">*</span>sys_tm <span class="token operator">=</span> <span class="token function">localtime</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">tm</span> my_tm <span class="token operator">=</span> <span class="token operator">*</span>sys_tm<span class="token punctuation">;</span>
    <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">//日志分级</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>level<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"[debug]:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"[info]:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"[warn]:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"[erro]:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"[info]:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//写入一个log，对m_count++, m_split_lines最大行数</span>
    m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_count<span class="token operator">++</span><span class="token punctuation">;</span>

    <span class="token comment">//日志不是今天或写入的日志行数是最大行的倍数</span>
    <span class="token comment">//m_split_lines为最大行数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_today <span class="token operator">!=</span> my_tm<span class="token punctuation">.</span>tm_mday <span class="token operator">||</span> m_count <span class="token operator">%</span> m_split_lines <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>      <span class="token comment">//everyday log</span>
        <span class="token keyword">char</span> new_log<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token function">fflush</span><span class="token punctuation">(</span>m_fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fclose</span><span class="token punctuation">(</span>m_fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> tail<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
       <span class="token comment">//格式化日志名中的时间部分</span>
        <span class="token function">snprintf</span><span class="token punctuation">(</span>tail<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">"%d_%02d_%02d_"</span><span class="token punctuation">,</span> my_tm<span class="token punctuation">.</span>tm_year <span class="token operator">+</span> <span class="token number">1900</span><span class="token punctuation">,</span> my_tm<span class="token punctuation">.</span>tm_mon <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> my_tm<span class="token punctuation">.</span>tm_mday<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//如果是时间不是今天,则创建今天的日志，更新m_today和m_count</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m_today <span class="token operator">!=</span> my_tm<span class="token punctuation">.</span>tm_mday<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">snprintf</span><span class="token punctuation">(</span>new_log<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token string">"%s%s%s"</span><span class="token punctuation">,</span> dir_name<span class="token punctuation">,</span> tail<span class="token punctuation">,</span> log_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            m_today <span class="token operator">=</span> my_tm<span class="token punctuation">.</span>tm_mday<span class="token punctuation">;</span>
            m_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token comment">//超过了最大行，在之前的日志名基础上加后缀, m_count/m_split_lines</span>
            <span class="token function">snprintf</span><span class="token punctuation">(</span>new_log<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token string">"%s%s%s.%lld"</span><span class="token punctuation">,</span> dir_name<span class="token punctuation">,</span> tail<span class="token punctuation">,</span> log_name<span class="token punctuation">,</span> m_count <span class="token operator">/</span> m_split_lines<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        m_fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>new_log<span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    va_list valst<span class="token punctuation">;</span>
    <span class="token function">va_start</span><span class="token punctuation">(</span>valst<span class="token punctuation">,</span> format<span class="token punctuation">)</span><span class="token punctuation">;</span>

    string log_str<span class="token punctuation">;</span>
    m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//写入的具体时间内容格式  //时间格式化，snprintf成功返回写字符的总数，其中不包括结尾的null字符</span>
    <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token function">snprintf</span><span class="token punctuation">(</span>m_buf<span class="token punctuation">,</span> <span class="token number">48</span><span class="token punctuation">,</span> <span class="token string">"%d-%02d-%02d %02d:%02d:%02d.%06ld %s "</span><span class="token punctuation">,</span>
                     my_tm<span class="token punctuation">.</span>tm_year <span class="token operator">+</span> <span class="token number">1900</span><span class="token punctuation">,</span> my_tm<span class="token punctuation">.</span>tm_mon <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> my_tm<span class="token punctuation">.</span>tm_mday<span class="token punctuation">,</span>
                     my_tm<span class="token punctuation">.</span>tm_hour<span class="token punctuation">,</span> my_tm<span class="token punctuation">.</span>tm_min<span class="token punctuation">,</span> my_tm<span class="token punctuation">.</span>tm_sec<span class="token punctuation">,</span> now<span class="token punctuation">.</span>tv_usec<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//内容格式化，用于向字符串中打印数据、数据格式用户自定义，返回写入到字符数组str中的字符个数(不包含终止符)</span>
    <span class="token keyword">int</span> m <span class="token operator">=</span> <span class="token function">vsnprintf</span><span class="token punctuation">(</span>m_buf <span class="token operator">+</span> n<span class="token punctuation">,</span> m_log_buf_size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> format<span class="token punctuation">,</span> valst<span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_buf<span class="token punctuation">[</span>n <span class="token operator">+</span> m<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\n'</span><span class="token punctuation">;</span>
    m_buf<span class="token punctuation">[</span>n <span class="token operator">+</span> m <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
    log_str <span class="token operator">=</span> m_buf<span class="token punctuation">;</span>

    m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//若m_is_async为true表示异步，默认为同步</span>
    <span class="token comment">//若异步,则将日志信息加入阻塞队列,同步则加锁向文件中写</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_is_async <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>m_log_queue<span class="token operator">-&gt;</span><span class="token function">full</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        m_log_queue<span class="token operator">-&gt;</span><span class="token function">push</span><span class="token punctuation">(</span>log_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token punctuation">{</span>
        m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fputs</span><span class="token punctuation">(</span>log_str<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> m_fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">va_end</span><span class="token punctuation">(</span>valst<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">Log</span><span class="token double-colon punctuation">::</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//强制刷新写入流缓冲区</span>
    <span class="token function">fflush</span><span class="token punctuation">(</span>m_fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="11-数据库连接池"><a href="#11-数据库连接池" class="headerlink" title="11 数据库连接池"></a>11 数据库连接池</h2><h3 id="11-1-基础知识"><a href="#11-1-基础知识" class="headerlink" title="11.1 基础知识"></a>11.1 基础知识</h3><p><code>什么是数据库连接池？</code></p>
<p>池是一组资源的集合，这组资源在服务器启动之初就被完全创建好并初始化。通俗来说，池是资源的容器，本质上是对资源的复用。</p>
<p>顾名思义，连接池中的资源为一组数据库连接，由程序动态地对池中的连接进行使用，释放。</p>
<p>当系统开始处理客户请求的时候，如果它需要相关的资源，可以直接从池中获取，无需动态分配；当服务器处理完一个客户连接后,可以把相关的资源放回池中，无需执行系统调用释放资源。</p>
<p><code>数据库访问的一般流程是什么？</code></p>
<p>当系统需要访问数据库时，先系统创建数据库连接，完成数据库操作，然后系统断开数据库连接。</p>
<p><code>为什么要创建连接池？</code></p>
<p>从一般流程中可以看出，若系统需要频繁访问数据库，则需要频繁创建和断开数据库连接，而创建数据库连接是一个很耗时的操作，也容易对数据库造成安全隐患。</p>
<p>在程序初始化的时候，集中创建多个数据库连接，并把他们集中管理，供程序使用，可以保证较快的数据库读写速度，更加安全可靠。</p>
<h3 id="11-2-整体概述"><a href="#11-2-整体概述" class="headerlink" title="11.2 整体概述"></a>11.2 整体概述</h3><p>池可以看做资源的容器，所以多种实现方法，比如数组、链表、队列等。这里，使用单例模式和链表创建数据库连接池，实现对数据库连接资源的复用。</p>
<p>项目中的数据库模块分为两部分，其一是数据库连接池的定义，其二是利用连接池完成登录和注册的校验功能。具体的，工作线程从数据库连接池取得一个连接，访问数据库中的数据，访问完毕后将连接交还连接池。</p>
<h3 id="11-3-本文内容"><a href="#11-3-本文内容" class="headerlink" title="11.3 本文内容"></a>11.3 本文内容</h3><p>本篇将介绍数据库连接池的定义，具体的涉及到单例模式创建、连接池代码实现、RAII机制释放数据库连接。</p>
<p><strong>单例模式创建</strong>，结合代码描述连接池的单例实现。</p>
<p><strong>连接池代码实现</strong>，结合代码对连接池的外部访问接口进行详解。</p>
<p><strong>RAII机制释放数据库连接</strong>，描述连接释放的封装逻辑。</p>
<h3 id="11-4-单例模式创建"><a href="#11-4-单例模式创建" class="headerlink" title="11.4 单例模式创建"></a>11.4 单例模式创建</h3><p>使用局部静态变量懒汉模式创建连接池。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">connection_pool</span><span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token comment">//局部静态变量单例模式</span>
    <span class="token keyword">static</span> connection_pool <span class="token operator">*</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token function">connection_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">~</span><span class="token function">connection_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
connection _pool <span class="token operator">*</span>connection_pool<span class="token operator">:</span> <span class="token operator">:</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">static</span> connection_pool connPool<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>connPool<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="11-5-连接池代码实现"><a href="#11-5-连接池代码实现" class="headerlink" title="11.5 连接池代码实现"></a>11.5 连接池代码实现</h3><p>连接池的定义中注释比较详细，这里仅对其实现进行解析。</p>
<p>连接池的功能主要有：初始化，获取连接、释放连接，销毁连接池。</p>
<h4 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h4><p>值得注意的是，销毁连接池没有直接被外部调用，而是通过RAII机制来完成自动释放；使用信号量实现多线程争夺连接的同步机制，这里将信号量初始化为数据库的连接总数。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">connection_pool<span class="token double-colon punctuation">::</span><span class="token function">connection_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	m_CurConn <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	m_FreeConn <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//RAII机制销毁连接池</span>
<span class="token class-name">connectionRAII</span><span class="token double-colon punctuation">::</span><span class="token operator">~</span><span class="token function">connectionRAII</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	poolRAII<span class="token operator">-&gt;</span><span class="token function">ReleaseConnection</span><span class="token punctuation">(</span>conRAII<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//构造初始化</span>
<span class="token keyword">void</span> connection_pool<span class="token double-colon punctuation">::</span><span class="token function">init</span><span class="token punctuation">(</span>string url<span class="token punctuation">,</span> string User<span class="token punctuation">,</span> string PassWord<span class="token punctuation">,</span> string DBName<span class="token punctuation">,</span> <span class="token keyword">int</span> Port<span class="token punctuation">,</span> <span class="token keyword">int</span> MaxConn<span class="token punctuation">,</span> <span class="token keyword">int</span> close_log<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">//初始化数据库信息</span>
	m_url <span class="token operator">=</span> url<span class="token punctuation">;</span>
	m_Port <span class="token operator">=</span> Port<span class="token punctuation">;</span>
	m_User <span class="token operator">=</span> User<span class="token punctuation">;</span>
	m_PassWord <span class="token operator">=</span> PassWord<span class="token punctuation">;</span>
	m_DatabaseName <span class="token operator">=</span> DBName<span class="token punctuation">;</span>
	m_close_log <span class="token operator">=</span> close_log<span class="token punctuation">;</span>

	<span class="token comment">//创建MaxConn条数据库连接</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MaxConn<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

		MYSQL <span class="token operator">*</span>con <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
		con <span class="token operator">=</span> <span class="token function">mysql_init</span><span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>con <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"MySQL Error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		con <span class="token operator">=</span> <span class="token function">mysql_real_connect</span><span class="token punctuation">(</span>con<span class="token punctuation">,</span> url<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> User<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> PassWord<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> DBName<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Port<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>con <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"MySQL Error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//更新连接池和空闲连接数量</span>
		connList<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token operator">++</span>m_FreeConn<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//将信号量初始化为最大连接次数</span>
	reserve <span class="token operator">=</span> <span class="token function">sem</span><span class="token punctuation">(</span>m_FreeConn<span class="token punctuation">)</span><span class="token punctuation">;</span>
	m_MaxConn <span class="token operator">=</span> m_FreeConn<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="获取、释放连接"><a href="#获取、释放连接" class="headerlink" title="获取、释放连接"></a><strong>获取、释放连接</strong></h4><p>当线程数量大于数据库连接数量时，使用信号量进行同步，每次取出连接，信号量原子减1，释放连接原子加1，若连接池内没有连接了，则阻塞等待。</p>
<p>另外，由于多线程操作连接池，会造成竞争，这里使用互斥锁完成同步，具体的同步机制均使用lock.h中封装好的类。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//当有请求时，从数据库连接池中返回一个可用连接，更新使用和空闲连接数</span>
MYSQL <span class="token operator">*</span>connection_pool<span class="token double-colon punctuation">::</span><span class="token function">GetConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	MYSQL <span class="token operator">*</span>con <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> connList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token comment">//取出连接，信号量原子减1，为0则等待</span>
	reserve<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	con <span class="token operator">=</span> connList<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	connList<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//这里的两个变量，并没有用到，非常鸡肋...</span>
	<span class="token operator">--</span>m_FreeConn<span class="token punctuation">;</span>
	<span class="token operator">++</span>m_CurConn<span class="token punctuation">;</span>
	lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> con<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//释放当前使用的连接	//把该链接重新放到队列中  //释放连接原子加1</span>
<span class="token keyword">bool</span> connection_pool<span class="token double-colon punctuation">::</span><span class="token function">ReleaseConnection</span><span class="token punctuation">(</span>MYSQL <span class="token operator">*</span>con<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> con<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

	lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	connList<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">++</span>m_FreeConn<span class="token punctuation">;</span>
	<span class="token operator">--</span>m_CurConn<span class="token punctuation">;</span>
	lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	reserve<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//释放连接原子加1</span>
	<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="销毁连接池"><a href="#销毁连接池" class="headerlink" title="销毁连接池"></a><strong>销毁连接池</strong></h4><p>通过迭代器遍历连接池链表，关闭对应数据库连接，清空链表并重置空闲连接和现有连接数量。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//销毁数据库连接池</span>
<span class="token keyword">void</span> connection_pool<span class="token double-colon punctuation">::</span><span class="token function">DestroyPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>connList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">//通过迭代器遍历，关闭数据库连接</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>list<span class="token operator">&lt;</span>MYSQL <span class="token operator">*</span><span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>iterator it <span class="token operator">=</span> connList<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> connList<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>it<span class="token punctuation">)</span><span class="token punctuation">{</span>
			MYSQL <span class="token operator">*</span>con <span class="token operator">=</span> <span class="token operator">*</span>it<span class="token punctuation">;</span>
			<span class="token function">mysql_close</span><span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//mysql的API,关闭这个链接</span>
		<span class="token punctuation">}</span>
		m_CurConn <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		m_FreeConn <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		connList<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//清空连接池的队列</span>
	<span class="token punctuation">}</span>
	lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="11-6-RAII机制释放数据库连接"><a href="#11-6-RAII机制释放数据库连接" class="headerlink" title="11.6 RAII机制释放数据库连接"></a>11.6 RAII机制释放数据库连接</h3><p>将数据库连接的获取与释放通过RAII机制封装，避免手动释放。</p>
<h4 id="定义"><a href="#定义" class="headerlink" title="定义"></a><strong>定义</strong></h4><p>这里需要注意的是，在获取连接时，通过有参构造对传入的参数进行修改。其中数据库连接本身是指针类型，所以参数需要通过双指针才能对其进行修改。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">connectionRAII</span><span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token comment">//双指针对MYSQL *con修改</span>
	<span class="token function">connectionRAII</span><span class="token punctuation">(</span>MYSQL <span class="token operator">*</span><span class="token operator">*</span>con<span class="token punctuation">,</span> connection_pool <span class="token operator">*</span>connPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">~</span><span class="token function">connectionRAII</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
<span class="token keyword">private</span><span class="token operator">:</span>
	MYSQL <span class="token operator">*</span>conRAII<span class="token punctuation">;</span>				<span class="token comment">//MySQL连接的指针</span>
	connection_pool <span class="token operator">*</span>poolRAII<span class="token punctuation">;</span>	<span class="token comment">//连接池的指针</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a><strong>实现</strong></h4><p>不直接调用获取和释放连接的接口，将其封装起来，通过RAII机制进行获取和释放。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//双指针对MYSQL *con修改</span>
connectionRAII<span class="token double-colon punctuation">::</span><span class="token function">connectionRAII</span><span class="token punctuation">(</span>MYSQL <span class="token operator">*</span><span class="token operator">*</span>SQL<span class="token punctuation">,</span> connection_pool <span class="token operator">*</span>connPool<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token operator">*</span>SQL <span class="token operator">=</span> connPool<span class="token operator">-&gt;</span><span class="token function">GetConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	conRAII <span class="token operator">=</span> <span class="token operator">*</span>SQL<span class="token punctuation">;</span>
	poolRAII <span class="token operator">=</span> connPool<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//RAII机制释放当前使用的连接</span>
<span class="token class-name">connectionRAII</span><span class="token double-colon punctuation">::</span><span class="token operator">~</span><span class="token function">connectionRAII</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	poolRAII<span class="token operator">-&gt;</span><span class="token function">ReleaseConnection</span><span class="token punctuation">(</span>conRAII<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//释放当前使用的连接	//把该链接重新放到队列中  //释放连接原子加1</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="12-注册登录"><a href="#12-注册登录" class="headerlink" title="12 注册登录"></a>12 注册登录</h2><h3 id="整体概述"><a href="#整体概述" class="headerlink" title="整体概述"></a>整体概述</h3><p>本项目中，使用数据库连接池实现服务器访问数据库的功能，使用POST请求完成注册和登录的校验工作。</p>
<h3 id="本文内容"><a href="#本文内容" class="headerlink" title="本文内容"></a>本文内容</h3><p>本篇将介绍同步实现注册登录功能，具体的涉及到流程图，载入数据库表，提取用户名和密码，注册登录流程与页面跳转的的代码实现。</p>
<p><strong>流程图</strong>，描述服务器从报文中提取出用户名密码，并完成注册和登录校验后，实现页面跳转的逻辑。</p>
<p><strong>载入数据库表</strong>，结合代码将数据库中的数据载入到服务器中。</p>
<p><strong>提取用户名和密码</strong>，结合代码对报文进行解析，提取用户名和密码。</p>
<p><strong>注册登录流程</strong>，结合代码对描述服务器进行注册和登录校验的流程。</p>
<p><strong>页面跳转</strong>，结合代码对页面跳转机制进行详解。</p>
<h3 id="流程图-1"><a href="#流程图-1" class="headerlink" title="流程图"></a>流程图</h3><p>具体的，描述了GET和POST请求下的页面跳转流程。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2023/cpp/image-20230322102926973.png" alt="image-20230322102926973"></p>
<h3 id="载入数据库表"><a href="#载入数据库表" class="headerlink" title="载入数据库表"></a>载入数据库表</h3><p>将数据库中的用户名和密码载入到服务器的map中来，map中的key为用户名，value为密码。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">map<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> string<span class="token operator">&gt;</span> m_users<span class="token punctuation">;</span>

<span class="token comment">//执行SELECT username,passwd FROM user，把结果放在map&lt;string, string&gt; m_users中</span>
<span class="token keyword">void</span> http_conn<span class="token double-colon punctuation">::</span><span class="token function">initmysql_result</span><span class="token punctuation">(</span>connection_pool <span class="token operator">*</span>connPool<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//先从连接池中取一个连接</span>
    MYSQL <span class="token operator">*</span>mysql <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    connectionRAII <span class="token function">mysqlcon</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mysql<span class="token punctuation">,</span> connPool<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//在user表中检索username，passwd数据，浏览器端输入</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mysql_query</span><span class="token punctuation">(</span>mysql<span class="token punctuation">,</span> <span class="token string">"SELECT username,passwd FROM user"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"SELECT error:%s\n"</span><span class="token punctuation">,</span> <span class="token function">mysql_error</span><span class="token punctuation">(</span>mysql<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//从表中检索完整的结果集</span>
    MYSQL_RES <span class="token operator">*</span>result <span class="token operator">=</span> <span class="token function">mysql_store_result</span><span class="token punctuation">(</span>mysql<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//返回结果集中的列数</span>
    <span class="token keyword">int</span> num_fields <span class="token operator">=</span> <span class="token function">mysql_num_fields</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//返回所有字段结构的数组</span>
    MYSQL_FIELD <span class="token operator">*</span>fields <span class="token operator">=</span> <span class="token function">mysql_fetch_fields</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//从结果集中获取下一行，将对应的用户名和密码，存入map中</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>MYSQL_ROW row <span class="token operator">=</span> <span class="token function">mysql_fetch_row</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        string <span class="token function">temp1</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        string <span class="token function">temp2</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        users<span class="token punctuation">[</span>temp1<span class="token punctuation">]</span> <span class="token operator">=</span> temp2<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="提取用户名和密码"><a href="#提取用户名和密码" class="headerlink" title="提取用户名和密码"></a>提取用户名和密码</h4><p>服务器端解析浏览器的请求报文，当解析为POST请求时，cgi标志位设置为1，并将请求报文的消息体赋值给m_string，进而提取出用户名和密码。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//判断http请求是否被完整读入</span>
http_conn<span class="token double-colon punctuation">::</span>HTTP_CODE http_conn<span class="token double-colon punctuation">::</span><span class="token function">parse_content</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>text<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_read_idx <span class="token operator">&gt;=</span> <span class="token punctuation">(</span>m_content_length <span class="token operator">+</span> m_checked_idx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        text<span class="token punctuation">[</span>m_content_length<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
        <span class="token comment">//POST请求中最后为输入的用户名和密码</span>
        m_string <span class="token operator">=</span> text<span class="token punctuation">;</span>
        <span class="token keyword">return</span> GET_REQUEST<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> NO_REQUEST<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//根据标志判断是登录检测还是注册检测</span>
<span class="token keyword">char</span> flag <span class="token operator">=</span> m_url<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">char</span> <span class="token operator">*</span>m_url_real <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">strcpy</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">strcat</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">,</span> m_url <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">strncpy</span><span class="token punctuation">(</span>m_real_file <span class="token operator">+</span> len<span class="token punctuation">,</span> m_url_real<span class="token punctuation">,</span> FILENAME_LEN <span class="token operator">-</span> len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">free</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//将用户名和密码提取出来</span>
<span class="token comment">//user=123&amp;password=123</span>
<span class="token keyword">char</span> name<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">,</span> password<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> i<span class="token punctuation">;</span>

<span class="token comment">//以&amp;为分隔符，前面的为用户名</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span> m_string<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token char">'&amp;'</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    name<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> m_string<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
name<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>

<span class="token comment">//以&amp;为分隔符，后面的是密码</span>
<span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span> m_string<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">,</span> <span class="token operator">++</span>j<span class="token punctuation">)</span>
    password<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> m_string<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
password<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="同步线程登录注册"><a href="#同步线程登录注册" class="headerlink" title="同步线程登录注册"></a>同步线程登录注册</h3><p>通过m_url定位/所在位置，根据/后的第一个字符判断是登录还是注册校验。</p>
<ul>
<li><p>2</p>
</li>
<li><ul>
<li>登录校验</li>
</ul>
</li>
<li><p>3</p>
</li>
<li><ul>
<li>注册校验</li>
</ul>
</li>
</ul>
<p>根据校验结果，跳转对应页面。另外，对数据库进行操作时，需要通过锁来同步。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//处理cgi</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token char">'3'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//如果是注册，先检测数据库中是否有重名的</span>
    <span class="token comment">//没有重名的，进行增加数据</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>sql_insert <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>sql_insert<span class="token punctuation">,</span> <span class="token string">"INSERT INTO user(username, passwd) VALUES("</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcat</span><span class="token punctuation">(</span>sql_insert<span class="token punctuation">,</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcat</span><span class="token punctuation">(</span>sql_insert<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcat</span><span class="token punctuation">(</span>sql_insert<span class="token punctuation">,</span> <span class="token string">"', '"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcat</span><span class="token punctuation">(</span>sql_insert<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcat</span><span class="token punctuation">(</span>sql_insert<span class="token punctuation">,</span> <span class="token string">"')"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//判断map中能否找到重复的用户名</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>users<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">==</span> users<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//向数据库中插入数据时，需要通过锁来同步数据</span>
        m_lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">mysql_query</span><span class="token punctuation">(</span>mysql<span class="token punctuation">,</span> sql_insert<span class="token punctuation">)</span><span class="token punctuation">;</span>
        users<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">pair</span><span class="token generic class-name"><span class="token operator">&lt;</span>string<span class="token punctuation">,</span> string<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//在程序中存储用户名和密码</span>
        m_lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//校验成功，跳转登录页面</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span>
            <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span> <span class="token string">"/log.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>    <span class="token comment">//校验失败，跳转注册失败页面</span>
            <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span> <span class="token string">"/registerError.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span> <span class="token string">"/registerError.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//如果是登录，直接判断</span>
<span class="token comment">//若浏览器端输入的用户名和密码在表中可以查找到，返回1，否则返回0</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token char">'2'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>users<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">!=</span> users<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> users<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">==</span> password<span class="token punctuation">)</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span> <span class="token string">"/welcome.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span> <span class="token string">"/logError.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="页面跳转"><a href="#页面跳转" class="headerlink" title="页面跳转"></a>页面跳转</h3><p>通过m_url定位/所在位置，根据/后的第一个字符，使用分支语句实现页面跳转。具体的，</p>
<ul>
<li><p>0</p>
</li>
<li><ul>
<li>跳转注册页面，GET</li>
</ul>
</li>
<li><p>1</p>
</li>
<li><ul>
<li>跳转登录页面，GET</li>
</ul>
</li>
<li><p>5</p>
</li>
<li><ul>
<li>显示图片页面，POST</li>
</ul>
</li>
<li><p>6</p>
</li>
<li><ul>
<li>显示视频页面，POST</li>
</ul>
</li>
<li><p>7</p>
</li>
<li><ul>
<li>显示关注页面，POST</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token char">'0'</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//如果请求资源为/0，表示跳转注册界面</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>m_url_real <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">,</span> <span class="token string">"/register.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strncpy</span><span class="token punctuation">(</span>m_real_file <span class="token operator">+</span> len<span class="token punctuation">,</span> m_url_real<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token char">'1'</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//如果请求资源为/1，表示跳转登录界面</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>m_url_real <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">,</span> <span class="token string">"/log.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strncpy</span><span class="token punctuation">(</span>m_real_file <span class="token operator">+</span> len<span class="token punctuation">,</span> m_url_real<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token char">'5'</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//如果请求资源为/5，表示访问图片界面</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>m_url_real <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">,</span> <span class="token string">"/picture.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strncpy</span><span class="token punctuation">(</span>m_real_file <span class="token operator">+</span> len<span class="token punctuation">,</span> m_url_real<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token char">'6'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>m_url_real <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">,</span> <span class="token string">"/video.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strncpy</span><span class="token punctuation">(</span>m_real_file <span class="token operator">+</span> len<span class="token punctuation">,</span> m_url_real<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token char">'7'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>m_url_real <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">,</span> <span class="token string">"/fans.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strncpy</span><span class="token punctuation">(</span>m_real_file <span class="token operator">+</span> len<span class="token punctuation">,</span> m_url_real<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token comment">//如果以上均不符合，即不是登录和注册，直接将url与网站目录拼接</span>
    <span class="token comment">//这里的情况是welcome界面，请求服务器上的一个图片</span>
        <span class="token function">strncpy</span><span class="token punctuation">(</span>m_real_file <span class="token operator">+</span> len<span class="token punctuation">,</span> m_url<span class="token punctuation">,</span> FILENAME_LEN <span class="token operator">-</span> len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="13-踩坑和面试题"><a href="#13-踩坑和面试题" class="headerlink" title="13 踩坑和面试题"></a>13 踩坑和面试题</h2><h3 id="本文内容-1"><a href="#本文内容-1" class="headerlink" title="本文内容"></a>本文内容</h3><p>本篇是项目的最终篇，将介绍踩坑与面试题两部分。</p>
<p><strong>踩坑</strong>，描述做项目过程中遇到的问题与解决方案。</p>
<p><strong>面试题</strong>，介绍项目相关的知识点变种和真实面试题，<strong>这里不会给出答案</strong>，具体的，可以在项目微信群中讨论。</p>
<h3 id="踩坑"><a href="#踩坑" class="headerlink" title="踩坑"></a>踩坑</h3><p>做项目过程中，肯定会遇到形形色色、大大小小的问题，但并不是所有问题都值得列出来探讨，这里仅列出个人认为有意义的问题。</p>
<p>具体的，包括大文件传输。</p>
<h4 id="大文件传输"><a href="#大文件传输" class="headerlink" title="大文件传输"></a><strong>大文件传输</strong></h4><p>先看下之前的大文件传输，也就是游双书上的代码，发送数据只调用了writev函数，并对其返回值是否异常做了处理。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">bool</span> http_conn<span class="token double-colon punctuation">::</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">int</span> temp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
     <span class="token keyword">int</span> bytes_have_send<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
     <span class="token keyword">int</span> bytes_to_send<span class="token operator">=</span>m_write_idx<span class="token punctuation">;</span>
     <span class="token keyword">if</span><span class="token punctuation">(</span>bytes_to_send<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">modfd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span>m_sockfd<span class="token punctuation">,</span>EPOLLIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        temp<span class="token operator">=</span><span class="token function">writev</span><span class="token punctuation">(</span>m_sockfd<span class="token punctuation">,</span>m_iv<span class="token punctuation">,</span>m_iv_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>temp<span class="token operator">&lt;=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>errno<span class="token operator">==</span>EAGAIN<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token function">modfd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span>m_sockfd<span class="token punctuation">,</span>EPOLLOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">unmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        bytes_to_send<span class="token operator">-=</span>temp<span class="token punctuation">;</span>
        bytes_have_send<span class="token operator">+=</span>temp<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>bytes_to_send<span class="token operator">&lt;=</span>bytes_have_send<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">unmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>m_linger<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">modfd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span>m_sockfd<span class="token punctuation">,</span>EPOLLIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>    <span class="token punctuation">{</span>
                <span class="token function">modfd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span>m_sockfd<span class="token punctuation">,</span>EPOLLIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在实际测试中发现，当请求小文件，也就是调用一次writev函数就可以将数据全部发送出去的时候，不会报错，此时不会再次进入while循环。</p>
<p>一旦请求服务器文件较大文件时，需要多次调用writev函数，便会出现问题，不是文件显示不全，就是无法显示。</p>
<p>对数据传输过程分析后，定位到writev的m_iv结构体成员有问题，每次传输后不会自动偏移文件指针和传输长度，还会按照原有指针和原有长度发送数据。</p>
<p>根据前面的基础API分析，我们知道writev以顺序iov[0]，iov[1]至iov[iovcnt-1]从缓冲区中聚集输出数据。项目中，申请了2个iov，其中iov[0]为存储报文状态行的缓冲区，iov[1]指向资源文件指针。</p>
<p>对上述代码做了修改如下：</p>
<ul>
<li>由于报文消息报头较小，第一次传输后，需要更新m_iv[1].iov_base和iov_len，m_iv[0].iov_len置成0，只传输文件，不用传输响应消息头</li>
<li>每次传输后都要更新下次传输的文件起始位置和长度</li>
</ul>
<p>更新后，大文件传输得到了解决。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">bool</span> http_conn<span class="token double-colon punctuation">::</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> newadd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>bytes_to_send <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">modfd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span> m_sockfd<span class="token punctuation">,</span> EPOLLIN<span class="token punctuation">,</span> m_TRIGMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        temp <span class="token operator">=</span> <span class="token function">writev</span><span class="token punctuation">(</span>m_sockfd<span class="token punctuation">,</span> m_iv<span class="token punctuation">,</span> m_iv_count<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>temp <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            bytes_have_send <span class="token operator">+=</span> temp<span class="token punctuation">;</span>
            newadd <span class="token operator">=</span> bytes_have_send <span class="token operator">-</span> m_write_idx<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EAGAIN<span class="token punctuation">)</span>  <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>bytes_have_send <span class="token operator">&gt;=</span> m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    m_iv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base <span class="token operator">=</span> m_file_address <span class="token operator">+</span> newadd<span class="token punctuation">;</span>
                    m_iv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">=</span> bytes_to_send<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base <span class="token operator">=</span> m_write_buf <span class="token operator">+</span> bytes_have_send<span class="token punctuation">;</span>
                    m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">=</span> m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">-</span> bytes_have_send<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">modfd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span> m_sockfd<span class="token punctuation">,</span> EPOLLOUT<span class="token punctuation">,</span> m_TRIGMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">unmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        bytes_to_send <span class="token operator">-=</span> temp<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bytes_to_send <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">unmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">modfd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span> m_sockfd<span class="token punctuation">,</span> EPOLLIN<span class="token punctuation">,</span> m_TRIGMode<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>m_linger<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="面试题"><a href="#面试题" class="headerlink" title="面试题"></a>面试题</h3><p>包括项目介绍，线程池相关，并发模型相关，HTTP报文解析相关，定时器相关，日志相关，压测相关，综合能力等。</p>
<h4 id="项目介绍"><a href="#项目介绍" class="headerlink" title="项目介绍"></a><strong>项目介绍</strong></h4><ul>
<li>为什么要做这样一个项目？</li>
<li>介绍下你的项目</li>
</ul>
<h4 id="线程池相关"><a href="#线程池相关" class="headerlink" title="线程池相关"></a><strong>线程池相关</strong></h4><ul>
<li>手写线程池</li>
<li>线程的同步机制有哪些？</li>
<li>线程池中的工作线程是一直等待吗？</li>
<li>你的线程池工作线程处理完一个任务后的状态是什么？</li>
<li>如果同时1000个客户端进行访问请求，线程数不多，怎么能及时响应处理每一个呢？</li>
<li>如果一个客户请求需要占用线程很久的时间，会不会影响接下来的客户请求呢，有什么好的策略呢?</li>
</ul>
<h4 id="并发模型相关"><a href="#并发模型相关" class="headerlink" title="并发模型相关"></a><strong>并发模型相关</strong></h4><ul>
<li>简单说一下服务器使用的并发模型？</li>
<li>reactor、proactor、主从reactor模型的区别？</li>
<li>你用了epoll，说一下为什么用epoll，还有其他复用方式吗？区别是什么？</li>
</ul>
<h4 id="HTTP报文解析相关"><a href="#HTTP报文解析相关" class="headerlink" title="HTTP报文解析相关"></a><strong>HTTP报文解析相关</strong></h4><ul>
<li>用了状态机啊，为什么要用状态机？</li>
<li>状态机的转移图画一下</li>
<li>https协议为什么安全？</li>
<li>https的ssl连接过程</li>
<li>GET和POST的区别</li>
</ul>
<h4 id="数据库登录注册相关"><a href="#数据库登录注册相关" class="headerlink" title="数据库登录注册相关"></a><strong>数据库登录注册相关</strong></h4><ul>
<li>登录说一下？</li>
<li>你这个保存状态了吗？如果要保存，你会怎么做？（cookie和session）</li>
<li>登录中的用户名和密码你是load到本地，然后使用map匹配的，如果有10亿数据，即使load到本地后hash，也是很耗时的，你要怎么优化？</li>
<li>用的mysql啊，redis了解吗？用过吗？</li>
</ul>
<h4 id="定时器相关"><a href="#定时器相关" class="headerlink" title="定时器相关"></a><strong>定时器相关</strong></h4><ul>
<li>为什么要用定时器？</li>
<li>说一下定时器的工作原理</li>
<li>双向链表啊，删除和添加的时间复杂度说一下？还可以优化吗？</li>
<li>最小堆优化？说一下时间复杂度和工作原理</li>
</ul>
<h4 id="日志相关"><a href="#日志相关" class="headerlink" title="日志相关"></a><strong>日志相关</strong></h4><ul>
<li>说下你的日志系统的运行机制？</li>
<li>为什么要异步？和同步的区别是什么？</li>
<li>现在你要监控一台服务器的状态，输出监控日志，请问如何将该日志分发到不同的机器上？（消息队列）</li>
</ul>
<h4 id="压测相关"><a href="#压测相关" class="headerlink" title="压测相关"></a><strong>压测相关</strong></h4><ul>
<li>服务器并发量测试过吗？怎么测试的？</li>
<li>webbench是什么？介绍一下原理</li>
<li>测试的时候有没有遇到问题？</li>
</ul>
<h4 id="综合能力"><a href="#综合能力" class="headerlink" title="综合能力"></a><strong>综合能力</strong></h4><ul>
<li>你的项目解决了哪些其他同类项目没有解决的问题？</li>
<li>说一下前端发送请求后，服务器处理的过程，中间涉及哪些协议？</li>
</ul>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">葛杨文</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://gitee.com/ge-yangwen/geyangwen.gitee.io/2023/021053067.html">https://gitee.com/ge-yangwen/geyangwen.gitee.io/2023/021053067.html</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">葛杨文</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Linux%E6%9C%8D%E5%8A%A1%E5%99%A8/">
                                    <span class="chip bg-color">Linux服务器</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="./images/loading.gif" data-original="https://blog-accelerated.oss-cn-hangzhou.aliyuncs.com/source/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="./images/loading.gif" data-original="https://blog-accelerated.oss-cn-hangzhou.aliyuncs.com/source/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: '2GHAwHTGn8XLUAd7QB3o7e4c-gzGzoHsz',
        appKey: '4EmLXaoemlw5MQWjAC60IbU8',
        notify: '' === 'true',
        verify: '' === 'true',
        visitor: '' === 'true',
        avatar: 'monsterid',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '昵称填写qq可以显示qq头像和昵称哦~'
    });
</script>

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2023/031053067.html">
                    <div class="card-image">
                        
                        
                        <img src="./images/loading.gif" data-original="https://blog-accelerated.oss-cn-hangzhou.aliyuncs.com/source/medias/featureimages/16.jpg" class="responsive-img" alt="面试记录">
                        
                        <span class="card-title">面试记录</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2023-03-10
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E9%9D%A2%E8%AF%95/" class="post-category">
                                    面试
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E9%9D%A2%E8%AF%95%E8%AE%B0%E5%BD%95/">
                        <span class="chip bg-color">面试记录</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2023/02107112.html">
                    <div class="card-image">
                        
                        
                        <img src="./images/loading.gif" data-original="https://blog-accelerated.oss-cn-hangzhou.aliyuncs.com/source/medias/featureimages/18.jpg" class="responsive-img" alt="linux高并发服务器开发">
                        
                        <span class="card-title">linux高并发服务器开发</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2023-02-10
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Linux/" class="post-category">
                                    Linux
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Linux%E6%9C%8D%E5%8A%A1%E5%99%A8/">
                        <span class="chip bg-color">Linux服务器</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h1,h2, h3, h4,h5'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1,h2, h3, h4,h5').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2022-2024</span>
            
            <span id="year">2022</span>
            <a href="/about" target="_blank">葛杨文</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">446.8k</span>&nbsp;字
            
            
            
            
            
            <!-- 修改不蒜子初始化计数 -->
                  
                <span id="busuanzi_container_site_pv" style='display:none'></span>
                    <i class="fa fa-heart-o"></i>
                    本站总访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>
            
            
            
            
                <span id="busuanzi_container_site_uv" style='display:none'></span>
                    人次,&nbsp;访客数 <span id="busuanzi_value_site_uv" class="white-color"></span> 人.
                
                                    
            <br>
            <!-- 增加建站时间（下面这句话） -->
            <span id="sitetime"></span>

            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/Geyangwen" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:3057318483@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=3057318483" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 3057318483" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







</div>
    </div>
</footer>

<div class="progress-bar"></div>

<!-- 增加建站时间 -->
<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */
        var t1 = Date.UTC(2022, 10, 25, 00, 00, 00); //北京时间2018-2-13 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "小破站已运行 " +diffYears+" 年 "+diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
    }/*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
</script>

<!-- 修改不蒜子初始化计数 -->
<script>
    $(document).ready(function () {

        var int = setInterval(fixCount, 50);  // 50ms周期检测函数
        var pvcountOffset = 80000;  // 初始化首次数据
        var uvcountOffset = 20000;

        function fixCount() {
            if (document.getElementById("busuanzi_container_site_pv").style.display != "none") {
                $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + pvcountOffset);
                clearInterval(int);
            }
            if ($("#busuanzi_container_site_pv").css("display") != "none") {
                $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + uvcountOffset); // 加上初始数据 
                clearInterval(int); // 停止检测
            }
        }
    });
</script>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    
        <!-- 添加死鬼你来了的小顽皮 -->
    <script type="text/javascript">
        var OriginTitile = document.title,
            st;
        document.addEventListener("visibilitychange", function () {
            document.hidden ? (document.title = "客官别走呀！", clearTimeout(st)) : (document.title =
                "(๑•̀ㅂ•́)死鬼你来了", st = setTimeout(function () {
                    document.title = OriginTitile
                }, 3e3))
        })
    </script>
    <!-- 樱花特效 -->
    <!-- <script type="text/javascript">
        //只在桌面版网页启用特效
        var windowWidth = $(window).width();
        if (windowWidth > 768) {
            document.write('<script type="text/javascript" src="/js/sakura.js"><\/script>');
        }
    </script> -->
    

    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="/libs/background/canvas-nest.js"></script>
    

    

    
    <script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async="async"></script>
    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/haruto.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script>
        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(r){r.imageLazyLoadSetting.processImages=t;var e=r.imageLazyLoadSetting.isSPA,c=(r.imageLazyLoadSetting.preloadRatio,n());function n(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(){e&&(c=n());for(var t,o=0;o<c.length;o++)0<=(t=(t=c[o]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(r.innerHeight+240||document.documentElement.clientHeight+240)&&function(){var t,e,n,a,i=c[o];e=function(){c=c.filter(function(t){return i!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(i)},(t=i).hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(n=new Image,a=t.getAttribute("data-original"),n.onload=function(){t.src=a,t.removeAttribute("data-original"),e&&e()},t.src!==a&&(n.src=a))}()}function a(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",a),r.addEventListener("resize",a),r.addEventListener("orientationchange",a)}(this);</script></body>

</html>
