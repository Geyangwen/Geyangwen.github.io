<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="标签: Android, 小文同学">
    <meta name="description" content="你的征途是星辰大海，怎么能被眼前的挫折打败。">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>标签: Android | 小文同学</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="小文同学" type="application/atom+xml">
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="./images/loading.gif" data-original="https://blog-accelerated.oss-cn-hangzhou.aliyuncs.com/source/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">小文同学</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">

      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a target="_blank" rel="noopener" href="https://www.kugou.com/">
          
          <i class="fas fa-music" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>酷狗音乐</span>
        </a>
      </li>
      
      <li>
        <a target="_blank" rel="noopener" href="https://search.bilibili.com/">
          
          <i class="fas fa-film" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>哔哩哔哩</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="./images/loading.gif" data-original="https://blog-accelerated.oss-cn-hangzhou.aliyuncs.com/source/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">小文同学</div>
        <div class="logo-desc">
            
            你的征途是星辰大海，怎么能被眼前的挫折打败。
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-address-book"></i>
			
			友情链接
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a target="_blank" rel="noopener" href="https://www.kugou.com/ " style="margin-left:75px">
				  
				   <i class="fa fas fa-music" style="position: absolute;left:50px" ></i>
			      
		          <span>酷狗音乐</span>
                  </a>
                </li>
              
                <li>

                  <a target="_blank" rel="noopener" href="https://search.bilibili.com/ " style="margin-left:75px">
				  
				   <i class="fa fas fa-film" style="position: absolute;left:50px" ></i>
			      
		          <span>哔哩哔哩</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/Geyangwen/Geyangwen.github.io" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/Geyangwen/Geyangwen.github.io" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('https://blog-accelerated.oss-cn-hangzhou.aliyuncs.com/source/medias/featureimages/12.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Android驱动的系统笔记2</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android%E9%A9%B1%E5%8A%A8/">
                                <span class="chip bg-color">Android驱动</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Android/" class="post-category">
                                Android
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2024-08-21
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    171.7k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    694 分
                </div>
                

                
                    <span id="busuanzi_container_site_pv" style='display:none'></span>
                    <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                    <span id="busuanzi_value_page_pv" ></span>
            
            
            
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <blockquote>
<p>注意：本网站所有内容为自己学习期间记录的笔记，基本都是原作者那边摘抄过来的，不作商业用途也不插播广告。（如有侵权，请联系我删除，15909440083）</p>
<p><a target="_blank" rel="noopener" href="https://space.bilibili.com/33785640/channel/seriesdetail?sid=2726018">北京迅为电子</a></p>
<p><a target="_blank" rel="noopener" href="https://item.taobao.com/item.htm?spm=a1z10.5-c-s.w4002-22452452613.11.2fec74a6elWNeA&amp;id=669939423234">同款开发板购买链接</a></p>
<p>【第16期的 最新驱动资料（文档+例程）】<br>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1Qf5d5_e2u_VklJWJK9wzNQ">https://pan.baidu.com/s/1Qf5d5_e2u_VklJWJK9wzNQ</a>      提取码：n4q6</p>
</blockquote>
<h1 id="第七篇设备树"><a href="#第七篇设备树" class="headerlink" title="第七篇设备树"></a>第七篇设备树</h1><p>教程规划，思维导图</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408220939544.png" alt="image-20240822093927402"></p>
<h2 id="第55-章初识设备树"><a href="#第55-章初识设备树" class="headerlink" title="第55 章初识设备树"></a>第55 章初识设备树</h2><h3 id="55-1-设备树的由来"><a href="#55-1-设备树的由来" class="headerlink" title="55.1 设备树的由来"></a>55.1 设备树的由来</h3><p>设备树（Device Tree）是一种硬件描述机制，用于在嵌入式系统和操作系统中描述硬件设备的特性、连接关系和配置信息。它提供了一种与平台无关的方式来描述硬件，使得内核与硬件之间的耦合度降低，提高了系统的可移植性和可维护性。</p>
<p>在上一篇平台总线内容的学习中，我们使用platform_device 结构体来对硬件设备进行描述，这是一种传统的平台总线设备描述方式。每个platform_device 结构表示一个特定的硬件设备，并通过注册到平台总线上来使得内核能够与该设备进行通信和交互。该结构包含设备的名称、资源（如内存地址、中断号等）、设备驱动程序等信息。</p>
<p>然而，随着时间的推移，Linux 内核中的ARM 部分存在着大量的平台相关配置代码，这些代码通常是杂乱而重复的，导致了维护的困难和工作量的增加。在2011 年3 月17 日，Linux的创始人Linus Torvalds 在ARM Linux 邮件列表中发表了一封帖子，他表达了对ARM 架构配置方式的不满，并宣称”Gaah. Guys, this whole ARM thing is a f*cking pain in the ass”。这引起了广泛的讨论和反思。ARM 社区中的开发者们开始认识到，传统的平台相关配置方式已经变得不可持续，需要一种更加先进和可扩展的方法来解决这个问题。</p>
<p>为了应对这一挑战，ARM 社区开始探索新的硬件描述机制，并逐渐形成了设备树的概念。设备树提供了一种更加灵活和可移植的描述硬件的机制，将设备的描述信息转移到设备树中。设备树使用一种结构化的数据格式，通过描述设备节点、属性和连接关系等信息，使得硬件的描述与具体的平台无关，同时允许多个平台共享相同的设备树描述。</p>
<p>设备树的引入为ARM 架构上的Linux 内核带来了革命性的变化。它提供了一种统一的硬件描述方式，使得不同芯片和板级的支持更加简单和灵活。此外，设备树还提供了硬件配置的可视化和可读性，方便开发者理解和调试硬件。</p>
<p>随着时间的推移，设备树逐渐成为了嵌入式系统和Linux 内核中描述硬件的标准方式。它不仅在ARM 架构上得到了广泛应用，也被扩展到其他架构和平台上。</p>
<h3 id="55-2-设备树基础知识"><a href="#55-2-设备树基础知识" class="headerlink" title="55.2 设备树基础知识"></a>55.2 设备树基础知识</h3><p>当描述设备树（Device Tree）时，通常会涉及到以下几个关键术语：DTS、DTSI、DTB 和DTC。下面来对每个术语进行介绍。</p>
<ul>
<li><strong>DTS（Device Tree Source）</strong>：DTS 是设备树的源文件，采用一种类似于文本的语法来描述硬件设备的结构、属性和连接关系。DTS 文件以.dts 为扩展名，通常由开发人员编写。它是人类可读的形式，用于描述设备树的层次结构和属性信息。</li>
<li><strong>DTSI（Device Tree Source Include）</strong>：DTSI 文件是设备树源文件的包含文件。它扩展了DTS文件的功能，用于定义可重用的设备树片段。DTSI 文件以.dtsi 为扩展名，可以在多个DTS 文件中包含和共享。通过使用DTSI，可以提高设备树的可重用性和可维护性（和C 语言中头文件的作用相同）。</li>
<li><strong>DTB（Device Tree Blob）</strong>：DTB 是设备树的二进制表示形式。DTB 文件是通过将DTS 或DTSI文件编译而成的二进制文件，以.dtb 为扩展名。DTB 文件包含了设备树的结构、属性和连接信息，被操作系统加载和解析。在运行时，操作系统使用DTB 文件来动态识别和管理硬件设备。</li>
<li><strong>DTC（Device Tree Compiler）</strong>：DTC 是设备树的编译器。它是一个命令行工具，用于将DTS和DTSI 文件编译成DTB 文件。DTC 将文本格式的设备树源代码转换为二进制的设备树表示形式，以便操作系统能够加载和解析。DTC 是设备树开发中一个重要的工具。</li>
</ul>
<p>DTS、DTSI、DTB 和DTC 之间的关系：</p>
<ul>
<li>（1）开发人员使用文本编辑器编写DTS 和DTSI 文件，描述硬件设备的层次结构、属性和连接关系。</li>
<li>（2）DTSI 文件可以在多个DTS 文件中包含和共享，以提高设备树的可重用性和可维护性。</li>
<li>（3）使用DTC 编译器，开发人员将DTS 和DTSI 文件编译成二进制的DTB 文件，如下图（图55- 1）所示：</li>
</ul>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408220940932.png" alt="image-20240822094029902"></p>
<ul>
<li>（4）操作系统在启动过程中加载和解析DTB 文件，以识别和管理硬件设备。</li>
</ul>
<p><strong>设备树文件存放路径：</strong></p>
<p><strong>ARM 体系结构：</strong></p>
<p>ARM 体系结构下的设备树源文件通常存放在<code>arch/arm/boot/dts/</code>目录中。该目录是设备树源文件的根目录。如下图（图55- 2）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408220942936.png" alt="image-20240822094226866"></p>
<p><strong>ARM64 体系结构：</strong></p>
<p>设备树源文件路径：ARM64 体系结构下的设备树源文件通常存放在<code>arch/arm64/boot/dts/</code>目录及其子目录中。该目录也是设备树源文件的根目录，并包含了针对不同ARM64 平台和设备的子目录，如下图（图55- 3）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408220942573.png" alt="image-20240822094249535"></p>
<p>子目录结构：在ARM64 的子目录中，同样会按照硬件平台、设备类型或制造商进行组织和分类。这些子目录的命名可能与特定芯片厂商（如Qualcomm、NVIDIA、Samsung）有关，由于我们本手册使用的soc 是瑞芯微的rk3568 ， 所以匹配的设备树目录为<code>arch/arm64/boot/dts/rockchip</code>。每个子目录中可能包含多个设备树文件，用于描述不同的硬件配置和设备类型，这里以rockchip 目录内容如下图（图55- 4）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408220943273.png" alt="image-20240822094323207"></p>
<h3 id="55-3-设备树的编译"><a href="#55-3-设备树的编译" class="headerlink" title="55.3 设备树的编译"></a>55.3 设备树的编译</h3><p>设备树的编译是将设备树源文件（如上述的.dts 文件）转换为二进制的设备树表示形式（.dtb文件）的过程。编译器通常被称为<code>DTC（Device Tree Compiler）</code>。<br>在Linux 内核源码中，DTC（Device Tree Compiler）的源代码和相关工具通常存放在<code>scripts/dtc/</code>目录中，如下图（图55- 5）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408220944469.png" alt="image-20240822094414414"></p>
<p>在编译完源码之后dtc 设备树编译器会默认生成，如果没有生成相应的dtc 可执行文件，可以查看在内核默认配置文件中CONFIG_DTC 是否使能。</p>
<p><strong>设备树的编译：</strong></p>
<p>在Linux 环境中，可以使用以下命令将设备树源文件编译为二进制设备树文件：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">dtc <span class="token parameter variable">-I</span> dts <span class="token parameter variable">-O</span> dtb <span class="token parameter variable">-o</span> output.dtb input.dts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>其中，<code>input.dts</code>是输入的设备树源文件，<code>output.dtb</code>是编译后的二进制设备树文件。<br>编译器会验证设备树源文件的语法和语义，生成与硬件描述相对应的设备树表示形式。</p>
<p><strong>设备树的反编译：</strong></p>
<p>设备树的反编译是将二进制设备树文件转换回设备树源文件的过程，以便进行查看、编辑或修改。反编译器通常也是DTC。<br>在Linux 环境中，可以使用以下命令将二进制设备树文件反编译为设备树源文件：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">dtc <span class="token parameter variable">-I</span> dtb <span class="token parameter variable">-O</span> dts <span class="token parameter variable">-o</span> output.dts input.dtb<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>其中，input.dtb 是输入的二进制设备树文件，output.dts 是反编译后的设备树源文件。</p>
<p>反编译器会将二进制设备树文件解析并还原为文本形式的设备树源文件，使其可读性更好。</p>
<p>下面来进行一下实际的设备树编译和反编译的演示，首先创建一个名为test.dts 的设备树文件，文件内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token operator">/</span>dts<span class="token operator">-</span>v1<span class="token operator">/</span><span class="token punctuation">;</span>
<span class="token operator">/</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>创建完成如下图（图55- 6）所示：<br><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408220946891.png" alt="image-20240822094646859"></p>
<p>这个设备树很简单，只包含了根节点/，而根节点中没有任何子节点或属性。这个示例并没有描述任何具体的硬件设备或连接关系，它只是一个最基本的设备树框架，在本小节只是为了测试设备树的编译和反编译。</p>
<p>然后使用以下命令进行设备树的编译，编译完成如下图（图55- 7）所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/home/topeet/Linux/linux_sdk/kernel/scripts/dtc/dtc <span class="token parameter variable">-I</span> dts <span class="token parameter variable">-O</span> dtb <span class="token parameter variable">-o</span> test.dtb test.dts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408220947064.png" alt="image-20240822094736031"></p>
<p>可以看到test.dtb 就生成了，然后继续使用以下命令对test.dtb 进行反编译，反编译完成如下图（图55- 8）所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/home/topeet/Linux/linux_sdk/kernel/scripts/dtc/dtc <span class="token parameter variable">-I</span> dtb <span class="token parameter variable">-O</span> dts <span class="token parameter variable">-o</span> <span class="token number">1</span>.dts test.dtb<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408220948283.png" alt="image-20240822094800246"></p>
<p>可以看到反编译出的1.dts 跟之前的test.dts 内容相同。</p>
<h2 id="第56-章设备树基本语法"><a href="#第56-章设备树基本语法" class="headerlink" title="第56 章设备树基本语法"></a>第56 章设备树基本语法</h2><h3 id="56-1-设备树语法讲解1"><a href="#56-1-设备树语法讲解1" class="headerlink" title="56.1 设备树语法讲解1"></a>56.1 设备树语法讲解1</h3><h4 id="56-1-1-根节点"><a href="#56-1-1-根节点" class="headerlink" title="56.1.1 根节点"></a>56.1.1 根节点</h4><p>设备树使用一种层次结构，其中的根节点（Root Node）是整个设备树的起始点和顶层节点。根节点由一个以<code>/</code>开头的标识符来表示，然后使用<code>{}</code>来包含根节点所在的内容，一个最简单的根节点示例如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token operator">/</span>dts<span class="token operator">-</span>v1<span class="token operator">/</span><span class="token punctuation">;</span> 			<span class="token comment">// 设备树版本信息</span>
<span class="token operator">/</span> <span class="token punctuation">{</span>
    <span class="token comment">// 根节点开始</span>
    <span class="token comment">/*
    在这里可以添加注释，描述根节点的属性和配置
    */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中第一行的设备树中的版本信息行dts-v1 是可选的，可以根据需要选择是否保留。这行注释通常用于指定设备树的语法版本。如果您不需要在设备树中指定版本信息，可以将其删除。</p>
<h4 id="56-1-2-子节点"><a href="#56-1-2-子节点" class="headerlink" title="56.1.2 子节点"></a>56.1.2 子节点</h4><p>设备树中的子节点是根节点的直接子项，用于描述具体的硬件设备或设备集合。子节点采用以下特定的格式来表示:</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">[</span>label<span class="token operator">:</span><span class="token punctuation">]</span> node<span class="token operator">-</span>name@<span class="token punctuation">[</span>unit<span class="token operator">-</span>address<span class="token punctuation">]</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>properties definitions<span class="token punctuation">]</span>
    <span class="token punctuation">[</span>child nodes<span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>以下是对这些部分的详细介绍：</p>
<ul>
<li>（1）节点标签（Label）（可选）：节点标签是一个可选的标识符，用于在设备树中引用该节点。标签允许其他节点直接引用此节点，以便在设备树中建立引用关系。</li>
<li>（2）节点名称（Node Name）：节点名称是一个字符串，用于唯一标识该节点在设备树中的位置。节点名称通常是硬件设备的名称，但必须在设备树中是唯一的。</li>
<li>（3）单元地址（Unit Address）（可选）：单元地址用于标识设备的实例。它可以是一个整数、一个十六进制值或一个字符串，具体取决于设备的要求。单元地址的目的是区分相同类型的设备的不同实例，例如在下图（55-6）中名为cpu 的节点通过它们的单元地址值0 和1 来区分，名称为ethernet 的节点通过其单元地址值fe002000 和fe003000 来区分。</li>
</ul>
<img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408221004177.png" alt="image-20240822100423138" style="zoom: 67%;">

<p>（4）属性定义（Properties Definitions）：属性定义是一组键值对，用于描述设备的配置和特性。属性可以根据设备的需求进行定义，例如寄存器地址、中断号、时钟频率等，关于这些属性会在后面的小节中进行讲解<br>（5）子节点（Child Nodes）：子节点是当前节点的子项，用于进一步描述硬件设备的子组件或配置。子节点可以包含自己的属性定义和更深层次的子节点，形成设备树的层次结构。</p>
<h4 id="56-1-3-reg-属性"><a href="#56-1-3-reg-属性" class="headerlink" title="56.1.3 reg 属性"></a>56.1.3 reg 属性</h4><p>reg 属性用于在设备树中指定设备的寄存器地址和大小，提供了与设备树中的物理设备之间的寄存器映射关系。</p>
<p>reg 属性可以在设备节点中有单个值格式和列表值格式这两种常见格式，接下来将对这两种格式进行介绍：</p>
<p><strong>（1）单个值格式如下所示：</strong></p>
<pre class="line-numbers language-none"><code class="language-none">reg = &lt;address size&gt;;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这种格式适用于描述单个寄存器的情况。其中，<code>address</code> 是<strong>设备的起始寄存器地址</strong>，可以是一个整数或十六进制值。<code>size</code> 表示<strong>寄存器的大小</strong>，即占用的字节数。</p>
<p>例如，假设有一个设备节点<code>my_device</code>，使用单个值格式的<code>reg</code> 属性来描述一个4 字节寄存器的地址和大小，可以这样定义：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">my_device <span class="token punctuation">{</span>
    compatible <span class="token operator">=</span> <span class="token string">"vendor,device"</span><span class="token punctuation">;</span>
    reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x1000</span> <span class="token number">0x4</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token comment">// 其他属性和子节点的定义</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在这个示例中，<code>my_device</code> 设备节点的<code>reg</code> 属性值为<code>&lt;0x1000 0x4&gt;</code>，表示从地址<code>0x1000</code> 开始的4 字节寄存器区域。</p>
<p><strong>（2）列表值格式如下所示：</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">reg <span class="token operator">=</span> <span class="token operator">&lt;</span>address1 size1 address2 size2 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&gt;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>当设备具有多个寄存器区域时，可以使用列表值格式的reg 属性来描述每个寄存器区域的地址和大小。通过这种方式，可以指定多个寄存器的位置和大小，以描述设备的完整寄存器映射。</p>
<p>例如，考虑一个设备节点<code>my_device</code>，它具有两个寄存器区域，分别是8 字节和4 字节大小的寄存器。可以使用列表值格式的reg 属性来描述这种情况：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">my_device <span class="token punctuation">{</span>
    compatible <span class="token operator">=</span> <span class="token string">"vendor,device"</span><span class="token punctuation">;</span>
    reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x1000</span> <span class="token number">0x8</span> <span class="token number">0x2000</span> <span class="token number">0x4</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token comment">// 其他属性和子节点的定义</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在这个示例中，my_device 设备节点的reg 属性值为&lt;0x1000 0x8 0x2000 0x4&gt;，<strong>表示设备有两个寄存器区域</strong>。第一个寄存器区域从地址0x1000 开始，大小为8 字节；第二个寄存器区域从地址0x2000 开始，大小为4 字节。</p>
<p>通过使用<code>reg</code> 属性，<strong>设备树可以提供有关设备寄存器布局和寄存器访问方式的信息</strong>。这对于操作系统的设备驱动程序很重要，因为它们需要了解设备的寄存器映射以正确地与设备进行交互和配置。</p>
<h4 id="56-1-4-address-cells-和size-cells-属性"><a href="#56-1-4-address-cells-和size-cells-属性" class="headerlink" title="56.1.4 address-cells 和size-cells 属性"></a>56.1.4 address-cells 和size-cells 属性</h4><p><code>#address-cells</code> 和<code>#size-cells</code> 属性<strong>用于指定在上个小节中要设置的设备树中地址单元和大小单元的位数</strong>。它们提供了设备树解析所需的元数据，以正确解释设备的地址和大小信息。下面对两个属性分别进行介绍：</p>
<p><strong>（1）#address-cells 属性：</strong></p>
<p><code>#address-cells</code> 属性是一个位于<strong>设备树根节点的特殊属性</strong>，<strong>它指定了设备树中地址单元的位数</strong>。地址单元是设备树中用于表示设备地址的单个单位。它通常是一个整数，可以是十进制或十六进制值。</p>
<p><code>#address-cells</code> 属性的值告诉解析设备树的软件在解释设备地址时应该使用多少位来表示一个地址单元。</p>
<p>默认情况下，<code>#address-cells</code> 的值为2，<strong>表示使用两个单元来表示一个设备地址</strong>。这意味着设备的地址将由两个整数（每个整数使用指定位数的位）组成。</p>
<p>例如，对于一个使用两个32 位（4 字节）整数表示地址的设备，可以在设备树的根节点中设置<code>#address-cells</code> 属性为&lt;2&gt;。</p>
<p><strong>（2）#size-cells 属性：</strong></p>
<p><code>#size-cells</code> 属性也是一个<strong>位于设备树根节点的特殊属性</strong>，<strong>它指定了设备树中大小单元的位数</strong>。大小单元是设备树中用于表示设备大小的单个单位。它通常是一个整数，可以是十进制或十六进制值。</p>
<p><code>#size-cells</code> 属性的值<strong>告诉解析设备树的软件在解释设备大小时应该使用多少位来表示一个大小单元</strong>。</p>
<p>默认情况下，<code>#size-cells</code> 的值为1，表示使用一个单元来表示一个设备的大小。这意味着设备的大小将由一个整数（使用指定位数的位）表示。</p>
<p>例如，对于一个使用一个32 位（4 字节）整数表示大小的设备，可以在设备树的根节点中设置#size-cells 属性为&lt;1&gt;。</p>
<p>这两个属性的存在是为了使设备树能够灵活地描述各种设备的地址和大小表示方式。通过在设备树的根节点中设置适当的<code>#address-cells</code> 和<code>#size-cells</code> 值，设备树解析软件能够正确地解释设备节点中的地址和大小信息。</p>
<p>以下是两个个示例，展示了根节点中#address-cells 和#size-cells 属性的使用：</p>
<p>示例1：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">node1 <span class="token punctuation">{</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    node1<span class="token operator">-</span>child <span class="token punctuation">{</span>
        reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x02200000</span> <span class="token number">0x4000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        <span class="token comment">// 其他属性和子节点的定义</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在这个示例中，<code>node1-child</code> 节点的reg 属性使用了&lt;0x02200000 0x4000&gt; 表示地址和大小。由于<code>#address-cells</code> 的值为&lt;1&gt;，表示使用一个单元来表示地址。<code>#size-cells</code> 的值也为&lt;1&gt;，表示使用一个单元来表示大小。</p>
<p>解释后的地址和大小值如下：<br>地址部分：0x02200000 被解释为一个地址单元，地址为0x02200000。<br>大小部分：0x4000 被解释为一个大小单元，大小为0x4000。</p>
<p>示例2：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">node1 <span class="token punctuation">{</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    node1<span class="token operator">-</span>child <span class="token punctuation">{</span>
        reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x0000</span> <span class="token number">0x0001</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        <span class="token comment">// 其他属性和子节点的定义</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在这个示例中，<code>node1-child</code> 节点的<code>reg</code> 属性使用了&lt;0x0000 0x0001&gt; 表示地址。由于<code>#address-cells</code> 的值为&lt;2&gt;，表示使用两个单元来表示地址。#size-cells 的值为&lt;0&gt;，表示不使用单元来表示大小。</p>
<p>解释后的地址值如下：<br>地址部分：0x0000 0x0001 被解释为两个地址单元，其中第一个地址单元为0x0000，第二个地址单元为0x0001。</p>
<p>这种使用<code>#address-cells</code> 和<code>#size-cells</code> 属性的方式使得设备树可以适应不同设备的寄存器映射和大小表示方式，并确保设备树解析软件能够正确解释设备的地址和大小信息。</p>
<h4 id="56-1-5-model-属性"><a href="#56-1-5-model-属性" class="headerlink" title="56.1.5 model 属性"></a>56.1.5 model 属性</h4><p>在设备树中，model 属性用于描述设备的型号或者名称。它通常作为设备节点的一个属性，用来提供关于设备的标识信息。model 属性是可选的，但在实际应用中经常被使用。</p>
<p>model 属性的值是一个字符串，可以是设备的型号、名称、或者其他标识符，用来识别设备。该值通常由设备的厂商定义，并且在设备树中使用。</p>
<p>以下是一个示例，展示了如何在设备树中使用model 属性：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">my_device <span class="token punctuation">{</span>
    compatible <span class="token operator">=</span> <span class="token string">"vendor,device"</span><span class="token punctuation">;</span>
    model <span class="token operator">=</span> <span class="token string">"My Device XYZ"</span><span class="token punctuation">;</span>
    <span class="token comment">// 其他属性和子节点的定义</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在这个示例中，my_device 节点具有model 属性，其值为”My Device XYZ”。这个值描述了设备的型号或名称为”My Device XYZ”。</p>
<p>model 属性通常用于标识和区分不同的设备，特别是当设备节点的compatible 属性相同或相似时。通过使用不同的model 属性值，可以更加准确地确定所使用的设备类型。</p>
<h4 id="56-1-6-status-属性"><a href="#56-1-6-status-属性" class="headerlink" title="56.1.6 status 属性"></a>56.1.6 status 属性</h4><p>在设备树中，status 属性用于描述设备或节点的状态。它是设备树中常见的属性之一，用于表示设备或节点的可用性或操作状态。<br>status 属性的值可以是以下几种：</p>
<ul>
<li>“okay”：表示设备或节点正常工作，可用。</li>
<li>“disabled”：表示设备或节点被禁用，不可用。</li>
<li>“reserved”：表示设备或节点已被保留，暂时不可用。</li>
<li>“fail”：表示设备或节点初始化或操作失败，不可用。</li>
</ul>
<p>以下是一个示例，展示了如何在设备树中使用status 属性：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">my_device <span class="token punctuation">{</span>
    compatible <span class="token operator">=</span> <span class="token string">"vendor,device"</span><span class="token punctuation">;</span>
    status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
    <span class="token comment">// 其他属性和子节点的定义</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在这个示例中，my_device 节点具有status 属性，其值为”okay”。这表示设备处于正常工作状态，可用。</p>
<p>通过使用status 属性，设备树可以动态地控制设备的启用和禁用状态。这对于在系统启动过程中选择性地启用或禁用设备，或者在运行时根据特定条件调整设备状态非常有用。</p>
<h4 id="56-1-7-compatible-属性"><a href="#56-1-7-compatible-属性" class="headerlink" title="56.1.7 compatible 属性"></a>56.1.7 compatible 属性</h4><p>在设备树中，compatible 属性用于描述设备的兼容性信息。它是设备树中重要的属性之一，用于识别设备节点与驱动程序之间的匹配关系。<br>compatible 属性的值是一个字符串或字符串列表，用于指定设备节点与相应的驱动程序或设备描述符兼容的规则。通常，compatible 属性的值由设备的厂商定义，并且在设备树中使用。</p>
<p>以下是一些常见的compatible 属性值的示例：</p>
<ul>
<li>（1）单个字符串值：例如”vendor,device”，用于指定设备节点与特定厂商的特定设备兼容。</li>
<li>（2）字符串列表：例如[“vendor,device1”, “vendor,device2”]，用于指定设备节点与多个设备兼容，通常用于设备节点具有多种变体或配置。</li>
<li>（3）通配符匹配：例如<code>"vendor,*"</code>，用于指定设备节点与特定厂商的所有设备兼容，不考虑具体的设备标识。</li>
</ul>
<p>以下是一个示例，展示了如何在设备树中使用compatible 属性：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">my_device <span class="token punctuation">{</span>
    compatible <span class="token operator">=</span> <span class="token string">"vendor,device"</span><span class="token punctuation">;</span>
    <span class="token comment">// 其他属性和子节点的定义</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>在这个示例中，my_device 节点具有compatible 属性，其值为”vendor,device”。这个值用于标识设备节点与特定厂商的特定设备兼容。</p>
<p><code>compatible</code> 属性也可以具有多个匹配值，用于指定设备节点与多个设备或驱动程序的兼容性规则。这种情况下，<code>compatible</code> 属性的值是一个字符串列表，每个字符串表示一个匹配值。</p>
<p>以下是一个示例，展示了具有多个匹配值的compatible 属性的用法：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">my_device <span class="token punctuation">{</span>
    compatible <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"vendor,device1"</span><span class="token punctuation">,</span> <span class="token string">"vendor,device2"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 其他属性和子节点的定义</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>在这个示例中， my_device 节点具有compatible 属性， 其值为[“vendor,device1”,”vendor,device2”]。这表示设备节点与厂商的device1 和device2 兼容。</p>
<p>通过使用compatible 属性，设备树可以<strong>提供设备和驱动程序之间的匹配信息</strong>。当设备树被操作系统或设备管理软件解析时，会根据<strong>设备节点的compatible 属性值来选择适合的驱动程序进行设备的初始化和配置</strong>。</p>
<h3 id="56-2-设备树语法讲解2"><a href="#56-2-设备树语法讲解2" class="headerlink" title="56.2 设备树语法讲解2"></a>56.2 设备树语法讲解2</h3><h4 id="56-2-1-aliases-节点"><a href="#56-2-1-aliases-节点" class="headerlink" title="56.2.1 aliases 节点"></a>56.2.1 aliases 节点</h4><p><code>aliases</code> 节点是一个特殊的节点，用于定义设备别名。该节点位于设备树的根部，并具有节点路径/aliases。</p>
<p>aliases 节点是一个容器节点，包含一组属性，每个属性都代表一个设备别名。每个属性的名称是别名的标识符，而属性的值是被引用设备节点的路径或设备树中其他节点的路径。</p>
<p>以下是一个示例，演示了如何在设备树中使用aliases 节点：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">aliases <span class="token punctuation">{</span>
    mmc0 <span class="token operator">=</span> <span class="token operator">&amp;</span>sdmmc0<span class="token punctuation">;</span>
    mmc1 <span class="token operator">=</span> <span class="token operator">&amp;</span>sdmmc1<span class="token punctuation">;</span>
    mmc2 <span class="token operator">=</span> <span class="token operator">&amp;</span>sdhci<span class="token punctuation">;</span>
    serial0 <span class="token operator">=</span> <span class="token string">"/simple@fe000000/seria1@11c500"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在给定的例子中，有四个别名的定义：</p>
<ul>
<li>（1）mmc0 别名与设备树中的sdmmc0 节点相关联。通过使用别名mmc0，其他设备节点或客户端程序可以更方便地引用sdmmc0 节点，而不必直接使用其完整路径。</li>
<li>（2）mmc1 别名与设备树中的sdmmc1 节点相关联。通过使用别名mmc1，其他设备节点或客户端程序可以更方便地引用sdmmc1 节点，而不必直接使用其完整路径。</li>
<li>（3）mmc2 别名与设备树中的sdhci 节点相关联。通过使用别名mmc2，其他设备节点或客户端程序可以更方便地引用sdhci 节点，而不必直接使用其完整路径。</li>
<li>（4）serial0 别名与设备树中的路径/simple@fe000000/seria1@11c500 相关联。通过使用别名serial0，其他设备节点或客户端程序可以更方便地引用该路径，而不必记住整个路径字符串。</li>
</ul>
<p>在别名的定义中，&amp; 符号用于引用设备树中的节点。别名的目的是提供可读性更高的名称，使设备树更易于理解和维护。通过使用别名，可以简化设备节点之间的关联，并减少重复输入设备节点的路径。</p>
<p>客户端程序可以使用别名属性名称来引用完整的设备路径或部分路径。当客户端程序将别名字符串视为设备路径时，应检测并使用别名。这样，设备树的使用者可以更方便地引用设备节点，而不必记住复杂的路径结构。</p>
<p>需要注意的是，**<code>aliases</code> 节点中定义的别名只在设备树内部可见，不能在设备树之外引用。它们主要用于设备树的内部组织和引用，以提高可读性和可维护性。**</p>
<h4 id="56-2-2-chosen-节点"><a href="#56-2-2-chosen-节点" class="headerlink" title="56.2.2 chosen 节点"></a>56.2.2 chosen 节点</h4><p>chosen 节点是设备树中的一个特殊节点，<strong>用于传递和存储系统引导和配置的相关信息</strong>。它位于设备树的根部，并具有路径/chosen。</p>
<p>chosen 节点通常包含以下子节点和属性：</p>
<ul>
<li>（1）bootargs：用于存储引导内核时传递的命令行参数。它可以包含诸如内核参数、设备树参数等信息。在引导过程中，操作系统或引导加载程序可以读取该属性来获取启动参数。</li>
<li>（2）stdout-path：用于指定用于标准输出的设备路径。在引导过程中，操作系统可以使用该属性来确定将控制台输出发送到哪个设备，例如串口或显示屏。</li>
<li>（3）firmware-name：用于指定系统固件的名称。它可以用于标识所使用的引导加载程序或固件的类型和版本。</li>
<li>（4）linux,initrd-start 和linux,initrd-end：这些属性用于指定Linux 内核初始化RAM 磁盘（initrd）的起始地址和结束地址。这些信息在引导过程中被引导加载程序使用，以将initrd 加载到内存中供内核使用。</li>
<li>（5）其他自定义属性：chosen 节点还可以包含其他自定义属性，用于存储特定于系统引导和配置的信息。这些属性的具体含义和用法取决于设备树的使用和上下文。关于chosen 节点的实际例子如下所示：</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">chosen <span class="token punctuation">{</span>
    bootargs <span class="token operator">=</span> <span class="token string">"root=/dev/nfs rw nfsroot=192.168.1.1 console=ttyS0,115200"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>在这个示例中， chosen 节点具有一个属性bootargs ， 其值为<code>"root=/dev/nfs rwnfsroot=192.168.1.1 console=ttyS0,115200"</code>。<br>通过这些命令行参数，操作系统或引导加载程序可以配置内核在引导过程中正确地加载NFS 根文件系统，并将控制台输出发送到指定的串口设备。</p>
<p>通过使用chosen 节点，系统引导过程中的相关信息可以方便地传递给操作系统或引导加载程序。这样，系统引导和配置的各个组件可以共享和访问这些信息，从而实现更灵活和可配置的系统引导流程。chosen 节点提供了一种通用的机制，使得不同的设备树和引导系统可以在传递信息方面保持一致性，并且可以根据具体需求扩展和自定义。</p>
<h4 id="56-2-3-device-type-节点"><a href="#56-2-3-device-type-节点" class="headerlink" title="56.2.3 device_type 节点"></a>56.2.3 device_type 节点</h4><p>在设备树中，<code>device_type</code> 节点是用于描述设备类型的节点。它通常作为设备节点的一个属性存在。<code>device_type</code> 属性的值是一个字符串，用于标识设备的类型。</p>
<p><code>device_type</code> 节点的存在有助于操作系统或其他软件识别和处理设备。它提供了设备的基本分类信息，使得驱动程序、设备树解析器或其他系统组件能够根据设备的类型执行相应的操作。</p>
<p>常见的设备类型包括但不限于：</p>
<ul>
<li>（1）cpu：表示中央处理器。</li>
<li>（2）memory：表示内存设备。</li>
<li>（3）display：表示显示设备，如液晶显示屏。</li>
<li>（4）serial：表示串行通信设备，如串口。</li>
<li>（5）ethernet：表示以太网设备。</li>
<li>（6）usb：表示通用串行总线设备。</li>
<li>（7）i2c：表示使用I2C (Inter-Integrated Circuit) 总线通信的设备。</li>
<li>（8）spi：表示使用SPI (Serial Peripheral Interface) 总线通信的设备。</li>
<li>（9）gpio：表示通用输入/输出设备。</li>
<li>（10）pwm：表示脉宽调制设备。</li>
</ul>
<p>这些只是一些常见的设备类型示例，实际上，设备类型可以根据具体的硬件和设备树的使用情况进行自定义和扩展。根据设备类型，操作系统或其他软件可以加载适当的驱动程序、配置设备资源、建立设备之间的连接等。</p>
<h4 id="56-2-4-自定义属性"><a href="#56-2-4-自定义属性" class="headerlink" title="56.2.4 自定义属性"></a>56.2.4 自定义属性</h4><p>设备树中的自定义属性是用户根据特定需求添加的属性。这些属性可以用于提供额外的信息、配置参数或元数据，以满足设备或系统的特定要求。</p>
<p>在设备树中添加自定义属性时，可以在设备节点或其他适当的节点下定义新的属性。自定义属性可以是整数、字符串、布尔值或其他数据类型。它们的命名应遵循设备树的命名约定，并且应该与已有的属性名称避免冲突。</p>
<p>例如可以在设备树中自定义一个管脚标号的属性pinnum，添加好的设备树源码如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">my_device <span class="token punctuation">{</span>
    compatible <span class="token operator">=</span> <span class="token string">"my_device"</span><span class="token punctuation">;</span>
    pinnum <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>在上述示例中，my_device 是一个自定义设备节点，并添加了一个自定义属性pinnum。该属性的值&lt;0 1 2 3 4&gt; 是一个整数数组，表示管脚的标号（PIN number）。</p>
<p>通过这样定义pinnum 属性，您可以在设备树中为特定设备指定管教标号，以便操作系统、驱动程序或其他软件组件使用。这可以用于在设备初始化或配置过程中对特定管教进行操作或控制。</p>
<h2 id="第57-章实例分析：中断"><a href="#第57-章实例分析：中断" class="headerlink" title="第57 章实例分析：中断"></a>第57 章实例分析：中断</h2><h3 id="57-1-中断相关属性"><a href="#57-1-中断相关属性" class="headerlink" title="57.1 中断相关属性"></a>57.1 中断相关属性</h3><h4 id="57-1-1-RK-ft5x06-设备树节点"><a href="#57-1-1-RK-ft5x06-设备树节点" class="headerlink" title="57.1.1 RK ft5x06 设备树节点"></a>57.1.1 RK ft5x06 设备树节点</h4><p>下面展示的是iTOP-RK3568 开发板SDK 源码中的ft5x06 设备树，其中蓝色字体部分就是关于中断相关的描述，包括了<code>interrupts</code>、<code>interrupt-controller</code>、<code>#interrupt-cells</code>、<code>interrupt-parent</code>四种常见属性：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">gpio0<span class="token operator">:</span> gpio@fdd60000 <span class="token punctuation">{</span>
    compatible <span class="token operator">=</span> <span class="token string">"rockchip,gpio-bank"</span><span class="token punctuation">;</span>
    reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x0</span> <span class="token number">0xfdd60000</span> <span class="token number">0x0</span> <span class="token number">0x100</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span>GIC_SPI <span class="token number">33</span> IRQ_TYPE_LEVEL_HIGH<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    clocks <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>pmucru PCLK_GPI00<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>pmucru DBCLK_GPI00<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    gpio<span class="token operator">-</span>controller<span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">gpio</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    gpio<span class="token operator">-</span>ranges <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>pinctrl <span class="token number">0</span> <span class="token number">0</span> <span class="token number">32</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    interrupt<span class="token operator">-</span>controller<span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">interrupt</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

ft5x06<span class="token operator">:</span> ft5x06@<span class="token number">38</span> <span class="token punctuation">{</span>
    status <span class="token operator">=</span> <span class="token string">"disabled"</span><span class="token punctuation">;</span>
    compatible <span class="token operator">=</span> <span class="token string">"edt,edt-ft5306"</span><span class="token punctuation">;</span>
    reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x38</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    touch<span class="token operator">-</span>gpio <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio0 RK_PB5 IRQ_TYPE_EDGE_RISING<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    interrupt<span class="token operator">-</span>parent <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio0<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span>RK_PB5 IRQ_TYPE_LEVEL_LOW<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    reset<span class="token operator">-</span>gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio0 RK_PB6 GPIO_ACTIVE_LOW<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    touchscreen<span class="token operator">-</span>size<span class="token operator">-</span>x <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">800</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    touchscreen<span class="token operator">-</span>size<span class="token operator">-</span>y <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1280</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    touch_type <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中<code>gpio0</code> 节点是在内核源码的“<code>/arch/arm64/boot/dts/rockchip/rk3568.dtsi</code>”设备树的<code>3549-3560</code> 行定义的， 而<code>ft5x06: ft5x06@38</code> 触摸芯片节点是在内核源码的<code>“/arch/arm64/boot/dts/rockchip/topeet_rk3568_lcds.dtsi</code>”设备树的<code>301-313</code> 行定义的。接下来将会对设备树常见的四个中断属性进行介绍。</p>
<h4 id="57-1-2-interrupts"><a href="#57-1-2-interrupts" class="headerlink" title="57.1.2 interrupts"></a>57.1.2 <code>interrupts</code></h4><p><code>interrupts</code> 属性用于指定设备的中断相关信息。<strong>它描述了中断控制器的类型、中断号以及中断触发类型</strong>。下面将对interrupts 属性的各个方面进行介绍。<br>在第一小节中列举的设备树源码中的gpio0 节点和ft5x06 节点都涉及到了interrupts 属性，如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">gpio0<span class="token operator">:</span> gpio@fdd60000 <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span>GIC_SPI <span class="token number">33</span> IRQ_TYPE_LEVEL_HIGH<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

ft5x06<span class="token operator">:</span> ft5x06@<span class="token number">38</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span>RK_PB5 IRQ_TYPE_LEVEL_LOW<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>gpio0 节点的interrupts 具有三个参数，分别表示<strong>中断控制器类型</strong>、<strong>中断号</strong>和<strong>中断触发类型</strong>，每个参数的具体描述如下所示：</p>
<p><strong>（1）中断控制器类型：</strong><br><code>interrupts</code> 属性的第一个参数指定了中断控制器的类型。常见的类型包括<code>GIC (GenericInterrupt Controller)</code>、<code>IRQ (Basic Interrupt Handling)</code> 等。例如，在给定的代码片段中，GIC_SPI 表示中断控制器的类型为GIC SPI 中断。</p>
<p>中断控制器负责管理系统中的中断信号，它可以是硬件中的专用中断控制器，也可以是处理器内部的中断控制器。</p>
<p><strong>（2）中断号：</strong><br><code>interrupts</code> 属性的第二个参数指定了设备所使用的中断号。中断号是一个唯一标识符，用于区分不同的中断信号源。系统使用中断号来识别中断源并进行相应的中断处理。</p>
<p><strong>中断号可以是一个整数值，也可以是一个宏定义或符号引用</strong>。在给定的代码片段中，33 表示该设备使用的中断号为33。</p>
<p><strong>（3）中断触发类型：</strong><br><code>interrupts</code> 属性的第三个参数指定了中断的触发类型，即中断信号的触发条件。常见的触发类型包括边沿触发和电平触发。</p>
<ul>
<li><strong>边沿触发</strong>表示中断信号在从低电平到高电平或从高电平到低电平的变化时触发。触发类型可以是<strong>上升沿触发、下降沿触发或双边沿触发</strong>。</li>
<li>电平触发表示中断信号在保持特定电平状态时触发，可以是高电平触发或低电平触发。</li>
</ul>
<p>在给定的代码片段中，<code>IRQ_TYPE_LEVEL_HIGH</code> 表示中断的触发类型为高电平触发。触发类型的宏定义在内核源码“<code>include/dt-bindings/interrupt-controller/irq.h</code>”目录下，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRQ_TYPE_NONE</span> <span class="token expression"><span class="token number">0</span> </span><span class="token comment">// 无中断触发类型</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRQ_TYPE_EDGE_RISING</span> <span class="token expression"><span class="token number">1</span> </span><span class="token comment">// 上升沿触发</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRQ_TYPE_EDGE_FALLING</span> <span class="token expression"><span class="token number">2</span> </span><span class="token comment">// 下降沿触发</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRQ_TYPE_EDGE_BOTH</span> <span class="token expression"><span class="token punctuation">(</span>IRQ_TYPE_EDGE_FALLING <span class="token operator">|</span> IRQ_TYPE_EDGE_RISING<span class="token punctuation">)</span>	</span><span class="token comment">// 双边沿触发</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRQ_TYPE_LEVEL_HIGH</span> <span class="token expression"><span class="token number">4</span> </span><span class="token comment">// 高电平触发</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRQ_TYPE_LEVEL_LOW</span> <span class="token expression"><span class="token number">8</span> </span><span class="token comment">// 低电平触发</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>而在ft5x06 节点中只有中断号和中断触发类型两个参数，这是为什么呢，带着疑问我们继续学习下面的几个属性。</p>
<h4 id="57-1-3-interrupt-controller"><a href="#57-1-3-interrupt-controller" class="headerlink" title="57.1.3 interrupt-controller"></a>57.1.3 <code>interrupt-controller</code></h4><p><code>interrupt-controller</code> 属性是设备树中用于描述中断控制器的属性之一。它提供了关于中断控制器的相关信息，以便操作系统和其他设备能够正确配置和使用中断系统。</p>
<p><code>interrupt-controller</code> 属性用于标识当前节点所描述的设备是一个中断控制器。中断控制器是硬件或软件模块，负责管理和分发中断信号。它接收来自各种设备的中断请求，并根据优先级和配置规则分发中断给相应的处理器或设备。</p>
<p><code>interrupt-controller</code> 属性本身没有特定的属性值，只需出现在节点的属性列表中即可。出现该属性的存在即表示该节点描述的设备是中断控制器。</p>
<h4 id="57-1-4-interrupt-parent"><a href="#57-1-4-interrupt-parent" class="headerlink" title="57.1.4 interrupt-parent"></a>57.1.4 <code>interrupt-parent</code></h4><p><code>interrupt-parent</code> 属性是设备树中用于建立中断信号源与中断控制器之间关联的属性。它指定了中断信号源所属的中断控制器节点，以确保正确的中断处理和分发。</p>
<p><code>interrupt-parent</code> 属性用于指定中断信号源所属的中断控制器。中断信号源是产生中断的设备或其他中断源节点。通过指定中断控制器，操作系统可以正确地将中断请求传递给相应的中断控制器节点进行处理和分发。</p>
<p><code>interrupt-parent</code> 属性值是一个引用，它指向中断控制器节点的路径或标签。可以使用路径来引用中断控制器节点，如/interrupt-controller-node，或使用标签来引用中断控制器节点，如&amp;interrupt-controller-label，在第一小节例子中的ft5x06 就是通过中断控制器节点和gpio0 中断控制器建立了联系，如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">ft5x06<span class="token operator">:</span> ft5x06@<span class="token number">38</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    interrupt<span class="token operator">-</span>parent <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio0<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>中断信号源节点（例如设备节点或其他中断源节点）中的<code>interrupt-parent</code> 属性用于指定中断信号源所属的中断控制器节点。这样，中断信号源就可以将中断请求传递给正确的中断控制器进行处理。中断信号源节点的interrupts 属性中的中断号和其他相关信息将与指定的中断控制器关联起来。</p>
<p>在某些情况下，中断控制器可以形成多级结构，其中一个中断控制器节点可能是另一个中断控制器的父节点。在这种情况下，interrupt-parent 属性可以用于指定层次结构中的上级中断控制器。</p>
<h4 id="57-1-5-interrupt-cells"><a href="#57-1-5-interrupt-cells" class="headerlink" title="57.1.5 #interrupt-cells"></a>57.1.5 <code>#interrupt-cells</code></h4><p><code>#interrupt-cells</code> 属性用于描述中断控制器中<strong>每个中断信号源的中断编号单元的数量</strong>。中断编号单元是指用于表示中断号和其他相关信息的固定大小的单元。通过指定中断编号单元的数量，操作系统可以正确解析和处理中断信息，并将其与中断控制器和中断信号源进行关联。</p>
<p><code>#interrupt-cells</code> 属性的值是一个整数，表示中断编号单元的数量。通常，这个值是一个正整数，例如1、2 或3，取决于中断控制器和设备的要求。</p>
<p>在gpio0 的中断控制器为gic，在gic 节点中#interrupt-cells 属性被设置为3，这也就是为什么在gpio0 节点中interrupts 属性有三个值，而ft5x06 的中断控制器为gpio0，在gpio0 节点中#interrupt-cells 属性被设置为2，所以ft5x06 节点的interrupts 属性只有两个值。</p>
<h3 id="57-2-中断实例编写"><a href="#57-2-中断实例编写" class="headerlink" title="57.2 中断实例编写"></a>57.2 中断实例编写</h3><p>在上一个小节中对设备树中断要用到的属性进行了讲解，而在本小节将会编写一个在RK3568 上的ft5x06 触摸中断设备树。<br>首先确定ft5x06 的中断引脚号，由于iTOP-RK3568 有1.2 和1.7 两个版本，所以这里展示了两个版本的原理图：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408221117424.png" alt="image-20240822111753364"></p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408221117801.png" alt="image-20240822111759747"></p>
<p>第一张图为V1.2 版本的原理图，触摸引脚网络标号为<code>TP_INT_L_GPIO0_B5</code>，对应的SOC管脚为<code>GPIO0_B5</code>，第二张图为V1.7 版本的原理图，触摸引脚网络标号为<code>TP_INT_L_GPIO3_A5</code>，对应的SOC 管脚为<code>GPIO3_A5</code>。</p>
<p>然后来查看内核源码目录下的“drivers/input/touchscreen/edt-ft5x06.c”文件，这是ft5x06的驱动文件，找到<code>compatible</code> 匹配值相关的部分，如下（图57-3）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408221118033.png" alt="image-20240822111817968"></p>
<p>这里的compatible 匹配值都可以选择，作者选择的是edt,edt-ft5206，选择其他compatible也是可以的。<br>在内核源码目录下的“include/dt-bindings/pinctrl/rockchip.h”头文件中，定义了RK 引脚名和gpio 编号的宏定义，如下图（57-4）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408221118298.png" alt="image-20240822111837251"></p>
<p>可以看到RK 已经将GPIO 组和引脚编号写成了宏定义的形式，通过宏定义可以减少在编写设备树的过程中换算的时间，并且帮助大家进行理解。<br>至此，关于编写ft5x06 设备树的前置内容就查找完成了，接下来进行设备树的编写。编写完成的设备树如下所示：</p>
<p>V1.2</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token operator">/</span>dts<span class="token operator">-</span>v1<span class="token operator">/</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"dt-bindings/pinctrl/rockchip.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"dt-bindings/interrupt-controller/irq.h"</span></span>
<span class="token operator">/</span><span class="token punctuation">{</span>
    model <span class="token operator">=</span> <span class="token string">"This is my devicetree!"</span><span class="token punctuation">;</span>
    ft5x06@<span class="token number">38</span> <span class="token punctuation">{</span>
        compatible <span class="token operator">=</span> <span class="token string">"edt,edt-ft5206"</span><span class="token punctuation">;</span>
        interrupt<span class="token operator">-</span>parent <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio0<span class="token operator">&gt;</span><span class="token punctuation">;</span>
        interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span>RK_PB5 IRQ_TYPE_EDGE_RISING<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>V1.7</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token operator">/</span>dts<span class="token operator">-</span>v1<span class="token operator">/</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"dt-bindings/pinctrl/rockchip.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"dt-bindings/interrupt-controller/irq.h"</span></span>
<span class="token operator">/</span><span class="token punctuation">{</span>
    model <span class="token operator">=</span> <span class="token string">"This is my devicetree!"</span><span class="token punctuation">;</span>
    ft5x06@<span class="token number">38</span> <span class="token punctuation">{</span>
        compatible <span class="token operator">=</span> <span class="token string">"edt,edt-ft5206"</span><span class="token punctuation">;</span>
        interrupt<span class="token operator">-</span>parent <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio3<span class="token operator">&gt;</span><span class="token punctuation">;</span>
        interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span>RK_PA5 IRQ_TYPE_EDGE_RISING<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第1 行: 设备树文件的头部，指定了使用的设备树语法版本。<br>第3 行：用于定义Rockchip 平台的引脚控制器相关的绑定。<br>第4 行：用于定义中断控制器相关的绑定。<br>第5 行：表示设备树的根节点开始。<br>第6 行：指定了设备树的模型名称，描述为”This is my devicetree!”。<br>第9 行：指定了设备节点的兼容性字符串，表示该设备与”edt,edt-ft5206” 兼容。<br>第10 行：指定了中断的父节点，即中断控制器所在的节点。这里使用了一个引用（&amp;gpio0）来表示父节点。<br>第11 行：指定了中断信号的配置。RK_PB5 表示中断信号的引脚编号，IRQ_TYPE_EDGE_RISING 表示中断类型为上升沿触发。<br>至此，关于ft5x06 的设备树就讲解完成了。</p>
<h3 id="57-3-其他SOC-设备树对比"><a href="#57-3-其他SOC-设备树对比" class="headerlink" title="57.3 其他SOC 设备树对比"></a>57.3 其他SOC 设备树对比</h3><p>而无论使用的是瑞芯微SOC 还是恩智浦、三星的SOC，在设备树关于中断相关的描述都离不开上面提到的四个属性，关于在恩智浦和三星源码中的ft5x06 设备树如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">gpio1<span class="token operator">:</span> gpio@<span class="token number">0209</span>c000 <span class="token punctuation">{</span>
    compatible <span class="token operator">=</span> <span class="token string">"fsl,inx6ul-gpio"</span><span class="token punctuation">,</span> <span class="token string">"fsl,imx35-gpio"</span><span class="token punctuation">;</span>
    reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x0209c000</span> <span class="token number">0x4000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span>GIC_SPI <span class="token number">66</span> IRQ_TYPE_LEVEL_HIGH<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>GIC_SPI <span class="token number">67</span> IRQ_TYPE_LEVEL_HIGH<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    gpio<span class="token operator">-</span>controller<span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">gpio</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    interrupt<span class="token operator">-</span>controller<span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">interrupt</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    
    edt<span class="token operator">-</span>ft5x06@<span class="token number">38</span> <span class="token punctuation">{</span>
        compatible <span class="token operator">=</span> <span class="token string">"edt,edt-ft5306"</span><span class="token punctuation">,</span> <span class="token string">"edt,edt-ft5x06"</span><span class="token punctuation">,</span> <span class="token string">"edt,edt-ft5406"</span><span class="token punctuation">;</span>
        pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>
        pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>ts_int_pin <span class="token operator">&amp;</span>ts_reset_pin<span class="token operator">&gt;</span><span class="token punctuation">;</span>
        reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x38</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        interrupt<span class="token operator">-</span>parent <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio1<span class="token operator">&gt;</span><span class="token punctuation">;</span>
        interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">9</span> <span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        reset<span class="token operator">-</span>gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio5 <span class="token number">9</span> GPIO_ACTIVE_LOW<span class="token operator">&gt;</span><span class="token punctuation">;</span>
        irq<span class="token operator">-</span>gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio1 <span class="token number">9</span> GPIO_ACTIVE_LOW<span class="token operator">&gt;</span><span class="token punctuation">;</span>
        status <span class="token operator">=</span> <span class="token string">"disabled"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>三星</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">gpio_c<span class="token operator">:</span> gpioc <span class="token punctuation">{</span>
    compatible <span class="token operator">=</span> <span class="token string">"gpio-controller"</span><span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">gpio</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    interrupt<span class="token operator">-</span>controller<span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">interrupt</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

ft5x06<span class="token operator">:</span> ft5x06038 <span class="token punctuation">{</span>
    compatible <span class="token operator">=</span> <span class="token string">"edt,edt-ft5406"</span><span class="token punctuation">;</span>
    reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x38</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>
    
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>RGB_1024x600<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">defined</span><span class="token punctuation">(</span>RGB_800x480<span class="token punctuation">)</span></span></span>
    pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>tsc2007_irq<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    interrupt<span class="token operator">-</span>parent <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio_c<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">26</span> IRQ_TYPE_EDGE_FALLING<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>LvDs_800×<span class="token number">1280</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">defined</span><span class="token punctuation">(</span>LvDS_1024x768<span class="token punctuation">)</span></span></span>
    pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gt911_irq<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    interrupt<span class="token operator">-</span>parent <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio_b<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">29</span> IRQ_TYPE_EDGE_FALLING<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    
    reset<span class="token operator">-</span>gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio_e <span class="token number">30</span> <span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>对比之后会发现，不同厂商对于中断属性的配置都是类似的，只是里面的参数有些许区别，如果大家在之后遇到了其他平台，只需要稍加区分即可。</p>
<h2 id="第58-章实例分析：时钟"><a href="#第58-章实例分析：时钟" class="headerlink" title="第58 章实例分析：时钟"></a>第58 章实例分析：时钟</h2><p>时钟（Clock）用于描述硬件设备和系统中的时钟源以及时钟相关的配置和连接关系。时钟在计算机系统中起着至关重要的作用，用于同步和定时各种硬件设备的操作。时钟可以分为两个主要角色：时钟生产者（clock provider）和时钟消费者（clock consumer）。</p>
<h3 id="58-1-时钟生产者（Clock-Provider）"><a href="#58-1-时钟生产者（Clock-Provider）" class="headerlink" title="58.1 时钟生产者（Clock Provider）"></a>58.1 时钟生产者（Clock Provider）</h3><p>定义：时钟生产者是负责生成和提供时钟信号的硬件或软件模块。它可以是时钟控制器、PLL、时钟发生器等。<br>设备树节点：时钟生产者在设备树中以时钟节点的形式表示。</p>
<p>时钟节点属性：<br><strong>（1）<code>clock-cells</code>：该属性用于指定时钟编号的位数。</strong>它是一个整数值，表示时钟编号的位数。通常情况下，当clock-cells 为0 时表示一个时钟，为1 表示多个时钟。具体示例如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">示例<span class="token number">1</span>：单个时钟
osc24m<span class="token operator">:</span> osc24m <span class="token punctuation">{</span>
    compatible <span class="token operator">=</span> <span class="token string">"clock"</span><span class="token punctuation">;</span>
    clock<span class="token operator">-</span>frequency <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">24000000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    clock<span class="token operator">-</span>output<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"osc24m"</span><span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">clock</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span>O<span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

示例<span class="token number">2</span>：多个时钟
    clock<span class="token operator">:</span> clock <span class="token punctuation">{</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">clock</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    clock<span class="token operator">-</span>output<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"clock1"</span><span class="token punctuation">,</span> <span class="token string">"clock2"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>（2）<code>clock-frequency</code> 属性是设备树中用于指定时钟频率的属性。</strong>它用于描述时钟节点所提供的时钟信号的频率，使用Hertz (Hz) 作为单位。对于时钟生产者节点，clock-frequency 属性表示该节点生成的时钟信号的频率。它用于描述时钟控制器、晶振、PLL 等产生时钟信号的硬件或软件模块的输出频率，例如指定时钟频率为24000000 的具体示例如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">osc24m<span class="token operator">:</span> osc24m <span class="token punctuation">{</span>
    compatible <span class="token operator">=</span> <span class="token string">"clock"</span><span class="token punctuation">;</span>
    clock<span class="token operator">-</span>frequency <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">24000000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    clock<span class="token operator">-</span>output<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"osc24m"</span><span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">clock</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span>O<span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>（3）<code>assigned-clocks</code> 和<code>assigned-clock-rates</code> 是设备树中用于描述多路时钟的属性，通常一起使用。</strong></p>
<p><code>assigned-clocks</code> 属性用于标识时钟消费者节点所使用的时钟源。它是一个整数数组，每个元素对应一个时钟编号。时钟编号是指时钟生产者节点（如时钟控制器）所提供的时钟源的编号。通过在时钟消费者节点中使用<code>assigned-clocks</code> 属性，可以指定该节点所需的时钟源。</p>
<p><code>assigned-clock-rates</code> 属性用于指定每个时钟源的时钟频率。它是一个整数数组，每个元素对应一个时钟源的频率。时钟频率以Hz (赫兹) 为单位表示。<code>assigned-clock-rates</code> 属性的元素数量和顺序应与<code>assigned-clocks</code> 属性中的时钟编号相对应。</p>
<p>关于<code>assigned-clocks</code> 和<code>assigned-clock-rates</code> 属性的一个具体示例如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">cru<span class="token operator">:</span> clock<span class="token operator">-</span>controller@fdd20000 <span class="token punctuation">{</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">clock</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    assigned<span class="token operator">-</span>clocks <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>pmucru CLK_RTC_32K<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>cru ACLK_RKVDEC_PRE<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    assigned<span class="token operator">-</span>clock<span class="token operator">-</span>rates <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">32768</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token number">300000000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>（4）<code>clock-indices</code>：<code>clock-indices</code> 属性用于指定时钟消费者节点所使用的时钟源的索引值。</strong>它是一个整数数组，每个元素对应一个时钟源的索引。</p>
<p>时钟索引是指时钟生产者节点（如时钟控制器）所提供的时钟源的编号。通过在时钟消费者节点中使用clock-indices 属性，可以明确指定该节点所需的时钟源，并按照特定的顺序进行匹配。一个clock-indices 示例如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">scpi_dvfs<span class="token operator">:</span> clocks<span class="token operator">-</span><span class="token number">0</span> <span class="token punctuation">{</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">clock</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    clock<span class="token operator">-</span>indices <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    clock<span class="token operator">-</span>output<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"atlclk"</span><span class="token punctuation">,</span> <span class="token string">"aplclk"</span><span class="token punctuation">,</span> <span class="token string">"gpuclk"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

scpi_clk<span class="token operator">:</span> clocks<span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">clock</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    clock<span class="token operator">-</span>indices <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">3</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    clock<span class="token operator">-</span>output<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"pxlclk"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在第一个节点中”atlclk”, “aplclk”, “gpuclk”三个时钟源的索引就分别被设置为了0、1、2，在第二个节点中”pxlclk”时钟源的索引值被设置为了3.</p>
<p><strong>（5）assigned-clock-parents 属性用于指定时钟消费者节点所使用的时钟源的父时钟源。</strong>它是一个时钟源引用的数组，每个元素对应一个父时钟源的引用。在时钟的层次结构中，某些时钟源可能是其他时钟源的父时钟源，即它们提供时钟信号给其他时钟源作为输入。通过在时钟消费者节点中使用<code>assigned-clock-parents</code> 属性，可以明确指定该节点所需的父时钟源，并按照特定的顺序进行匹配。一个实际的<code>assigned-clock-parents</code> 属性例子如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">clock<span class="token operator">:</span> clock <span class="token punctuation">{</span>
    assigned<span class="token operator">-</span>clocks <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>clkcon <span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>pll <span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    assigned<span class="token operator">-</span>clock<span class="token operator">-</span>parents <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>pll <span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    assigned<span class="token operator">-</span>clock<span class="token operator">-</span>rates <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">115200</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token number">9600</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上述设备树表示了一个名为clock 的时钟消费者节点，具有以下属性：</p>
<ul>
<li><code>assigned-clocks</code> 属性指定了该节点使用的时钟源，引用了两个时钟源节点：clkcon 0 和pll 2。</li>
<li><code>assigned-clock-parents</code> 属性指定了这些时钟源的父时钟源，引用了pll 2 时钟源节点。</li>
<li><code>assigned-clock-rates</code> 属性指定了每个时钟源的时钟频率，分别是115200 和9600。</li>
</ul>
<h3 id="58-2-时钟消费者（Clock-Consumer）"><a href="#58-2-时钟消费者（Clock-Consumer）" class="headerlink" title="58.2 时钟消费者（Clock Consumer）"></a>58.2 时钟消费者（Clock Consumer）</h3><p>定义：时钟消费者是依赖时钟信号的硬件设备或模块。它们通过引用时钟生产者节点提供的时钟源来获取时钟信号。<br>设备树节点：时钟消费者在设备树中的节点中使用属性来引用时钟生产者的时钟源。</p>
<p><strong>时钟消费者属性：</strong><br>（1）clocks：该属性用于指定时钟消费者节点所需的时钟源。它是一个整数数组，每个元素是一个时钟编号，表示时钟消费者需要的一个时钟源。<br>（2）clock-names：可选属性，用于指定时钟消费者节点所需时钟源的名称。它是一个字符串数组，与clocks 数组一一对应，用于提供时钟源的描述性名称。</p>
<p>一个时钟消费者示例如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">clock<span class="token operator">:</span> clock <span class="token punctuation">{</span>
    clocks <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>cru CLK_VOP<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    clock<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"clk_vop"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>clocks</code> 属性指定了该节点使用的时钟源，引用了cru 节点中的CLK_VOP 时钟源。<br><code>clock-names</code> 属性指定了时钟源的名称，这里是”clk_vop”。</p>
<h2 id="第59-章实例分析：CPU"><a href="#第59-章实例分析：CPU" class="headerlink" title="第59 章实例分析：CPU"></a>第59 章实例分析：CPU</h2><h3 id="59-1-cpus-节点"><a href="#59-1-cpus-节点" class="headerlink" title="59.1 cpus 节点"></a>59.1 cpus 节点</h3><p>设备树的cpus 节点是用于描述系统中的处理器的一个重要节点。它是处理器拓扑结构的顶层节点，包含了所有处理器相关的信息。下面将详细介绍设备树的cpus 节点的各个方面。</p>
<p><strong>节点结构：</strong><br>cpus 节点是一个容器节点，其下包含了系统中每个处理器的子节点。每个子节点的名称通常为cpu@X，其中X 是处理器的索引号。每个子节点都包含了与处理器相关的属性，例如时钟频率、缓存大小等。</p>
<p><strong>处理器属性：</strong><br>cpu@X 子节点中的属性可以包括以下信息：</p>
<ul>
<li>（1）device_type：指示设备类型为处理器（”cpu”）。</li>
<li>（2）reg：指定处理器的地址范围，通常是物理地址或寄存器地址。</li>
<li>（3）compatible：指定处理器的兼容性信息，用于匹配相应的设备驱动程序。</li>
<li>（4）clock-frequency：指定处理器的时钟频率。</li>
<li>（5）cache-size：指定处理器的缓存大小。</li>
</ul>
<p><strong>处理器拓扑关系：</strong><br>除了处理器的基本属性，cpus 节点还可以包含其他用于描述处理器拓扑关系的节点，以提供更详细的处理器拓扑信息。这些节点可以帮助操作系统和软件了解处理器之间的连接关系、组织结构和特性。</p>
<ul>
<li>cpu-map 节点：描述处理器的映射关系，通常在多核处理器系统中使用。</li>
<li>socket 节点：描述多处理器系统中的物理插槽或芯片组。</li>
<li>cluster 节点：描述处理器集群，即将多个处理器组织在一起形成的逻辑组。</li>
<li>core 节点：描述处理器核心，即一个物理处理器内的独立执行单元。</li>
<li>thread 节点：描述处理器线程，即一个物理处理器核心内的线程。</li>
</ul>
<p>这些节点的嵌套关系可以在cpus 节点下形成一个层次结构，反映了处理器的拓扑结构。上述这些节点会在后面的小节进行介绍。一个单核CPU 设备树和一个四核CPU 设备树示例如下所示：</p>
<p>单核CPU 示例：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">cpus <span class="token punctuation">{</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    cpu0<span class="token operator">:</span> cpu@<span class="token number">0</span> <span class="token punctuation">{</span>
        compatible <span class="token operator">=</span> <span class="token string">"arm,cortex-a7"</span><span class="token punctuation">;</span>
        device_type <span class="token operator">=</span> <span class="token string">"cpu"</span><span class="token punctuation">;</span>
        <span class="token comment">// 其他属性...</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>多核CPU 示例：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">cpus <span class="token punctuation">{</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    cpu0<span class="token operator">:</span> cpu@<span class="token number">0</span> <span class="token punctuation">{</span>
        device_type <span class="token operator">=</span> <span class="token string">"cpu"</span><span class="token punctuation">;</span>
        compatible <span class="token operator">=</span> <span class="token string">"arm,cortex-a9"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    cpu1<span class="token operator">:</span> cpu@<span class="token number">1</span> <span class="token punctuation">{</span>
        device_type <span class="token operator">=</span> <span class="token string">"cpu"</span><span class="token punctuation">;</span>
        compatible <span class="token operator">=</span> <span class="token string">"arm,cortex-a9"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    cpu2<span class="token operator">:</span> cpu@<span class="token number">2</span> <span class="token punctuation">{</span>
        device_type <span class="token operator">=</span> <span class="token string">"cpu"</span><span class="token punctuation">;</span>
        compatible <span class="token operator">=</span> <span class="token string">"arm,cortex-a9"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    cpu3<span class="token operator">:</span> cpu@<span class="token number">3</span> <span class="token punctuation">{</span>
        device_type <span class="token operator">=</span> <span class="token string">"cpu"</span><span class="token punctuation">;</span>
        compatible <span class="token operator">=</span> <span class="token string">"arm,cortex-a9"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>cpus 节点是一个容器节点，包含了cpu0 子节点。该节点使用了#address-cells 和#size-cells 属性来指定地址和大小的单元数量。<br>cpu0 子节点代表第一个处理器，具有以下属性：</p>
<ul>
<li>compatible 属性指定了处理器的兼容性信息</li>
<li>device_type 属性指示设备类型为处理器。</li>
</ul>
<p>你可以在此基础上继续添加其他属性来描述处理器的特性，如时钟频率、缓存大小等。</p>
<h3 id="59-2-cpu-map、socket、cluster-节点"><a href="#59-2-cpu-map、socket、cluster-节点" class="headerlink" title="59.2 cpu-map、socket、cluster 节点"></a>59.2 <code>cpu-map</code>、<code>socket</code>、<code>cluster</code> 节点</h3><p>cpu-map 节点是设备树中用于描述大小核架构处理器的映射关系的节点之一。它的父节点必须是cpus 节点，而子节点可以是一个或多个cluster 和socket 节点。通过cpu-map 节点，可以定义不同核心和集群之间的连接和组织结构。</p>
<p>socket 节点用于描述处理器插槽（socket）之间的映射关系。每个socket 子节点表示一个处理器插槽，可以使用cpu-map-mask 属性来指定该插槽使用的核心。通过为每个socket 子节点指定适当的cpu-map-mask，可以定义不同插槽中使用的核心。这样，操作系统和软件可以了解到不同插槽之间的核心分配情况。</p>
<p>cluster 节点用于描述核心（cluster）之间的映射关系。每个cluster 子节点表示一个核心集群，可以使用cpu-map-mask 属性来指定该集群使用的核心。通过为每个cluster 子节点指定适当的cpu-map-mask，可以定义每个集群中使用的核心。这样，操作系统和软件可以了解到不同集群之间的核心分配情况。</p>
<p>通过在cpu-map 节点中定义socket 和cluster 子节点，并为它们指定适当的cpu-map-mask，可以提供处理器的拓扑结构信息。这对于操作系统和软件来说非常有用，因为它们可以根据这些信息进行任务调度和资源分配的优化，以充分利用大小核架构处理器的性能和能效特性。</p>
<p>一个大小核架构的具体示例如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">cpus <span class="token punctuation">{</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    cpu<span class="token operator">-</span>map <span class="token punctuation">{</span>
        cluster0 <span class="token punctuation">{</span>
            core0 <span class="token punctuation">{</span>
            	cpu <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>cpu_l0<span class="token operator">&gt;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            core1 <span class="token punctuation">{</span>
            	cpu <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>cpu_l1<span class="token operator">&gt;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            core2 <span class="token punctuation">{</span>
            	cpu <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>cpu_l2<span class="token operator">&gt;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            core3 <span class="token punctuation">{</span>
            	cpu <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>cpu_l3<span class="token operator">&gt;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        cluster1 <span class="token punctuation">{</span>
            core0 <span class="token punctuation">{</span>
            	cpu <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>cpu_b0<span class="token operator">&gt;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            core1 <span class="token punctuation">{</span>
            	cpu <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>cpu_b1<span class="token operator">&gt;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    cpu_l0<span class="token operator">:</span> cpu@<span class="token number">0</span> <span class="token punctuation">{</span>
        device_type <span class="token operator">=</span> <span class="token string">"cpu"</span><span class="token punctuation">;</span>
        compatible <span class="token operator">=</span> <span class="token string">"arm,cortex-a53"</span><span class="token punctuation">,</span> <span class="token string">"arm,armv8"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    cpu_l1<span class="token operator">:</span> cpu@<span class="token number">1</span> <span class="token punctuation">{</span>
        device_type <span class="token operator">=</span> <span class="token string">"cpu"</span><span class="token punctuation">;</span>
        compatible <span class="token operator">=</span> <span class="token string">"arm,cortex-a53"</span><span class="token punctuation">,</span> <span class="token string">"arm,armv8"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    cpu_l2<span class="token operator">:</span> cpu@<span class="token number">2</span> <span class="token punctuation">{</span>
        device_type <span class="token operator">=</span> <span class="token string">"cpu"</span><span class="token punctuation">;</span>
        compatible <span class="token operator">=</span> <span class="token string">"arm,cortex-a53"</span><span class="token punctuation">,</span> <span class="token string">"arm,armv8"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    cpu_l3<span class="token operator">:</span> cpu@<span class="token number">3</span> <span class="token punctuation">{</span>
        device_type <span class="token operator">=</span> <span class="token string">"cpu"</span><span class="token punctuation">;</span>
        compatible <span class="token operator">=</span> <span class="token string">"arm,cortex-a53"</span><span class="token punctuation">,</span> <span class="token string">"arm,armv8"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    cpu_b0<span class="token operator">:</span> cpu@<span class="token number">100</span> <span class="token punctuation">{</span>
        device_type <span class="token operator">=</span> <span class="token string">"cpu"</span><span class="token punctuation">;</span>
        compatible <span class="token operator">=</span> <span class="token string">"arm,cortex-a72"</span><span class="token punctuation">,</span> <span class="token string">"arm,armv8"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    cpu_b1<span class="token operator">:</span> cpu@<span class="token number">101</span> <span class="token punctuation">{</span>
        device_type <span class="token operator">=</span> <span class="token string">"cpu"</span><span class="token punctuation">;</span>
        compatible <span class="token operator">=</span> <span class="token string">"arm,cortex-a72"</span><span class="token punctuation">,</span> <span class="token string">"arm,armv8"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="第60-章实例分析：GPIO"><a href="#第60-章实例分析：GPIO" class="headerlink" title="第60 章实例分析：GPIO"></a>第60 章实例分析：GPIO</h2><h3 id="60-1-GPIO-相关属性"><a href="#60-1-GPIO-相关属性" class="headerlink" title="60.1 GPIO 相关属性"></a>60.1 GPIO 相关属性</h3><p>&lt;1&gt;在GPIO控制器中，必须有一个属性<code>#gpio-cells</code>，表示其他节点如果使用这个GPIO控制器需要几个cell来表示使用哪一个GPIO。<br>&lt;2&gt;在GPIO控制器中，必须有一个属性<code>gpio-controller</code>，表示他是GPIO控制器。<br>&lt;3&gt;在设备树中使用GPIO，需要使用属性<code>data-gpios=&lt;&amp;gpio1 12 0&gt;</code>来指定具体的GPIO引脚。data-gpios属性可以为自定义属性。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">简化<span class="token operator">:</span>
gpiol<span class="token operator">:</span> gpiol <span class="token punctuation">{</span>
    gpio<span class="token operator">-</span>controller
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">gpio</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span></span></span>
<span class="token punctuation">}</span>
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>

data<span class="token operator">-</span>gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio1 <span class="token number">12</span> <span class="token number">0</span><span class="token operator">&gt;</span>，<span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio1 <span class="token number">15</span> <span class="token number">0</span><span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="60-1-1-RK-ft5x06-设备树节点"><a href="#60-1-1-RK-ft5x06-设备树节点" class="headerlink" title="60.1.1 RK ft5x06 设备树节点"></a>60.1.1 RK ft5x06 设备树节点</h4><p>下面展示的是iTOP-RK3568 开发板SDK 源码中的ft5x06 设备树，其中蓝色字体部分就是关于gpio 相关的描述，包括了<code>gpios</code>、<code>gpio-controller</code>、<code>#gpio-cells</code>、<code>gpio-parent</code>四种常见属性：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">gpio0<span class="token operator">:</span> gpio@fdd60000 <span class="token punctuation">{</span>
    compatible <span class="token operator">=</span> <span class="token string">"rockchip,gpio-bank"</span><span class="token punctuation">;</span>
    reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x0</span> <span class="token number">0xfdd60000</span> <span class="token number">0x0</span> <span class="token number">0x100</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span>GIC_SPI <span class="token number">33</span> IRQ_TYPE_LEVEL_HIGH<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    clocks <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>pmucru PCLK_GPI00<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>pmucru DBCLK_GPI00<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    gpio<span class="token operator">-</span>controller<span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">gpio</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    gpio<span class="token operator">-</span>ranges <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>pinctrl <span class="token number">0</span> <span class="token number">0</span> <span class="token number">32</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    interrupt<span class="token operator">-</span>controller<span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">interrupt</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

ft5x06<span class="token operator">:</span> ft5x06@<span class="token number">38</span> <span class="token punctuation">{</span>
    status <span class="token operator">=</span> <span class="token string">"disabled"</span><span class="token punctuation">;</span>
    compatible <span class="token operator">=</span> <span class="token string">"edt,edt-ft5306"</span><span class="token punctuation">;</span>
    reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x38</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    touch<span class="token operator">-</span>gpio <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio0 RK_PB5 IRQ_TYPE_EDGE_RISING<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    interrupt<span class="token operator">-</span>parent <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio0<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span>RK_PB5 IRQ_TYPE_LEVEL_LOW<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    reset<span class="token operator">-</span>gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio0 RK_PB6 GPIO_ACTIVE_LOW<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    touchscreen<span class="token operator">-</span>size<span class="token operator">-</span>x <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">800</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    touchscreen<span class="token operator">-</span>size<span class="token operator">-</span>y <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1280</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    touch_type <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中gpio0 节点是在内核源码的“<code>/arch/arm64/boot/dts/rockchip/rk3568.dtsi</code>”设备树的3549-3560 行定义的， 而ft5x06: ft5x06@38 触摸芯片节点是在内核源码的“<code>/arch/arm64/boot/dts/rockchip/topeet_rk3568_lcds.dtsi</code>”设备树的301-313 行定义的。接下来将会对设备树常见的四个gpio 属性进行介绍。</p>
<h4 id="60-1-2-gpio-controller"><a href="#60-1-2-gpio-controller" class="headerlink" title="60.1.2 gpio-controller"></a>60.1.2 gpio-controller</h4><p><code>gpio-controller</code> 属性用于标识一个设备节点作为GPIO 控制器。GPIO 控制器是负责管理和控制GPIO 引脚的硬件模块或驱动程序。</p>
<p><code>gpio-controller</code> 属性通常作为设备节点的一个属性出现，位于设备节点的属性列表中。当一个设备节点被标识为GPIO 控制器时，它通常会定义一组GPIO 引脚，并提供相关的GPIO 控制和配置功能。其他设备节点可以使用该GPIO 控制器来控制和管理其GPIO 引脚。</p>
<p>通过使用<code>gpio-controller</code> 属性，设备树可以明确标识出GPIO 控制器设备节点，使系统可以正确识别和管理GPIO 引脚的配置和控制。</p>
<h4 id="60-1-3-gpio-cells"><a href="#60-1-3-gpio-cells" class="headerlink" title="60.1.3 #gpio-cells"></a>60.1.3 #gpio-cells</h4><p><code>#gpio-cells</code> 属性用于指定GPIO 引脚描述符的编码方式。GPIO 引脚描述符是用于标识和配置GPIO 引脚的一组值，例如引脚编号、引脚属性等。</p>
<p><code>#gpio-cells</code> 属性的属性值是一个整数，表示用于编码GPIO 引脚描述符的单元数。通常，这个值为2。</p>
<p>在第一小节的示例中有1 个gpio 引脚描述属性,由于#gpio-cells 属性被设置为了2，所以每个引脚描述属性中会有两个整数，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">ft5x06<span class="token operator">:</span> ft5x06@<span class="token number">38</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    reset<span class="token operator">-</span>gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio0 RK_PB6 GPIO_ACTIVE_LOW<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>RK_PB6</code>、<code>GPIO_ACTIVE_LOW</code> 都属于宏定义，会在下面的小节进行讲解。<br>通过使用<code>#gpio-cells</code> 属性，设备树可以指定GPIO 引脚描述符的编码方式，使系统能够正确识别和解析GPIO 引脚的配置和控制。</p>
<h4 id="60-1-4-gpio-ranges"><a href="#60-1-4-gpio-ranges" class="headerlink" title="60.1.4 gpio-ranges"></a>60.1.4 gpio-ranges</h4><p><code>gpio-ranges</code> 属性是设备树中一个用于描述GPIO 范围映射的属性。它通常用于描述具有大量GPIO 引脚的GPIO 控制器，以简化GPIO 引脚的编码和访问。</p>
<p>在设备树中，GPIO 控制器的每个引脚都有一个本地编号，用于在控制器内部进行引脚寻址。然而，这些本地编号并不一定与外部引脚的物理编号或其他系统中使用的编号一致。为了解决这个问题，可以使用<code>gpio-ranges</code> 属性将本地编号映射到实际的引脚编号。</p>
<p><code>gpio-ranges</code> 属性是一个包含一系列整数值的列表，每个整数值对应于设备树中的一个GPIO控制器。列表中的每个整数值按照特定的顺序提供以下信息：</p>
<ul>
<li>（1）外部引脚编号的起始值。</li>
<li>（2）GPIO 控制器内部本地编号的起始值。</li>
<li>（3）引脚范围的大小（引脚数量）。</li>
</ul>
<p>在第一小节的示例中gpio-ranges 属性的值为<code>&lt;&amp;pinctrl 0 0 32&gt;</code>，其中<code>&lt;&amp;pinctrl&gt;</code>表示引用了名为<code>pinctrl</code> 的引脚控制器节点，**<code>0 0 32</code> 表示外部引脚从0 开始，控制器本地编号从0 开始，共映射了32 个引脚。**</p>
<p>这样，<code>gpio-ranges</code> 属性将GPIO 控制器的本地编号直接映射到外部引脚编号，使得GPIO 引脚的编码和访问更加简洁和直观。</p>
<h4 id="60-1-5-gpio-引脚描述属性"><a href="#60-1-5-gpio-引脚描述属性" class="headerlink" title="60.1.5 gpio 引脚描述属性"></a>60.1.5 gpio 引脚描述属性</h4><p>第一小节的设备树中关于gpio 引脚描述属性相关内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">ft5x06<span class="token operator">:</span> ft5x06@<span class="token number">38</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    reset<span class="token operator">-</span>gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio0 RK_PB6 GPIO_ACTIVE_LOW<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>gpio 引脚描述属性个数由#gpio-cells 所决定，因为gpio0 节点中的#gpio-cells 属性设置为了2，所以上面设备树gpio 引脚描述属性个数也为2。</p>
<p>其中RK_PB6 定义在内核源码目录下的“include/dt-bindings/pinctrl/rockchip.h”头文件中，定义了RK 引脚名和gpio 编号的宏定义，如下图（图60-1）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408221406424.png" alt="image-20240822140646363"></p>
<p><code>GPIO_ACTIVE_LOW</code> 定义在源码目录下的“<code>include/dt-bindings/gpio/gpio.h</code>”中，表示设置为低电平，同理<code>GPIO_ACTIVE_HIGH</code> 就表示将这个GPIO 设置为高电平，但这里只是对设备的描述，具体的设置还是要跟驱动相匹配。</p>
<h4 id="60-1-6-其他属性"><a href="#60-1-6-其他属性" class="headerlink" title="60.1.6 其他属性"></a>60.1.6 其他属性</h4><p>本小节将根据下面的设备树示例讲解一下gpio 的其他重要属性，设备树具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">gpio<span class="token operator">-</span>controller@<span class="token number">00000000</span> <span class="token punctuation">{</span>
    compatible <span class="token operator">=</span> <span class="token string">"foo"</span><span class="token punctuation">;</span>
    reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x00000000</span> <span class="token number">0x1000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    gpio<span class="token operator">-</span>controller<span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">gpio</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    ngpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">18</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    gpio<span class="token operator">-</span>reserved<span class="token operator">-</span>ranges <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span> <span class="token number">4</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token number">12</span> <span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    gpio<span class="token operator">-</span>line<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"MMC-CD"</span><span class="token punctuation">,</span> <span class="token string">"MMC-WP"</span><span class="token punctuation">,</span>
                    <span class="token string">"voD eth"</span><span class="token punctuation">,</span> <span class="token string">"RST eth"</span><span class="token punctuation">,</span> <span class="token string">"LED R"</span><span class="token punctuation">,</span>
                    <span class="token string">"LED G"</span><span class="token punctuation">,</span> <span class="token string">"LED B"</span><span class="token punctuation">,</span> <span class="token string">"col A"</span><span class="token punctuation">,</span>
                    <span class="token string">"col B"</span><span class="token punctuation">,</span> <span class="token string">"col C"</span><span class="token punctuation">,</span> <span class="token string">"col D"</span><span class="token punctuation">,</span>
                    <span class="token string">"NMI button"</span><span class="token punctuation">,</span> <span class="token string">"Row A"</span><span class="token punctuation">,</span> <span class="token string">"Row B"</span><span class="token punctuation">,</span>
                    <span class="token string">"Row C"</span><span class="token punctuation">,</span> <span class="token string">"Row D"</span><span class="token punctuation">,</span> <span class="token string">"poweroff"</span><span class="token punctuation">,</span>
                    <span class="token string">"reset"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>第6 行的<code>ngpios</code> 属性指定了GPIO 控制器所支持的GPIO 引脚数量。它表示该设备上可用的GPIO 引脚的总数。在这个例子中，<code>ngpios</code>的值为18，<strong>意味着该GPIO 控制器支持18个GPIO 引脚</strong>。</li>
<li>第7 行的<code>gpio-reserved-ranges</code> 属性定义了保留的GPIO 范围。每个范围由两个整数值表示，用尖括号括起来。保留的GPIO 范围意味着这些GPIO 引脚不可用或已被其他设备或功能保留。在这个例子中，有两个保留范围：&lt;0 4&gt;和&lt;12 2&gt;。&lt;0 4&gt;表示从第0 个引脚开始的连续4 个引脚被保留，而&lt;12 2&gt;表示从第12 个引脚开始的连续2 个引脚被保留。</li>
<li>第8 行的gpio-line-names 属性定义了GPIO 引脚的名称，以逗号分隔。每个名称对应一个GPIO 引脚。这些名称用于标识和识别每个GPIO 引脚的作用或连接的设备。在这个例子中，gpio-line-names 属性列出了多个GPIO 引脚的名称，如”MMC-CD”、”MMC-WP”、”voD eth” 等等。通过这些名称，可以清楚地了解每个GPIO 引脚的功能或用途。</li>
</ul>
<h3 id="60-2-中断实例编写"><a href="#60-2-中断实例编写" class="headerlink" title="60.2 中断实例编写"></a>60.2 中断实例编写</h3><p>在上一个小节中对设备树中断要用到的属性进行了讲解，而在本小节将会编写一个在RK3568 上LED 灯的中断设备树。<br>首先确定LED 的引脚编号，LED 原理图如下图（图60-2）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408221410234.png" alt="image-20240822141028170"></p>
<p>从上面的原理图可以得到LED 灯的引脚网络标号为<code>Working_LEDEN_H_GPIO0_B7</code>，对应的引脚为<code>GPIO0_B7</code>。</p>
<p>然后来查看内核源码目录下的“<code>drivers/drivers/leds/leds-gpio.c</code>”文件，这是led 的驱动文件，然后找到compatible 匹配值相关的部分，如下（图60-3）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408221410153.png" alt="image-20240822141058102"></p>
<p>可以看到compatible 匹配值为<code>gpio-leds</code>。<br>最后在内核源码目录下的“include/dt-bindings/pinctrl/rockchip.h”头文件中，定义了RK 引脚名和gpio 编号的宏定义，如下图（图60-4）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408221411126.png" alt="image-20240822141115068"></p>
<p>在源码目录下的“<code>include/dt-bindings/gpio/gpio.h</code>”文件中定义了引脚极性设置宏定义，如下图（图60-5）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408221411793.png" alt="image-20240822141127740"></p>
<p>其中GPIO_ACTIVE_HIGH 表示将该引脚设置为高电平，GPIO_ACTIVE_LOW 表示将该引脚设置为低电平。<br>至此，我们关于编写LED 设备树的前置内容就查找完成了，接下来进行设备树的编写。编写完成的设备树如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token operator">/</span>dts<span class="token operator">-</span>v1<span class="token operator">/</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"dt-bindings/pinctrl/rockchip.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"dt-bindings/gpio/gpio.h"</span></span>
<span class="token operator">/</span><span class="token punctuation">{</span>
    model <span class="token operator">=</span> <span class="token string">"This is my devicetree!"</span><span class="token punctuation">;</span>
    led led@<span class="token number">1</span> <span class="token punctuation">{</span>
        compatible <span class="token operator">=</span> <span class="token string">"gpio-leds"</span><span class="token punctuation">;</span>
        gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio0 RK_PB7 GPIO_ACTIVE_HIGH<span class="token operator">&gt;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>第1 行: 设备树文件的头部，指定了使用的设备树语法版本。</li>
<li>第3 行：用于定义Rockchip 平台的引脚控制器相关的绑定。</li>
<li>第4 行：用于定义中断控制器相关的绑定。</li>
<li>第5 行：表示设备树的根节点开始。</li>
<li>第6 行：指定了设备树的模型名称，描述为”This is my devicetree!”。</li>
<li>第9 行：指定了设备节点的兼容性字符串，表示该设备与”gpio-leds” 兼容。</li>
<li>第10 行：指定了该LED 设备所使用的GPIO 引脚。&amp;gpio0 是引脚控制器的引用，RK_PB7 是引脚的编号或标识，GPIO_ACTIVE_HIGH 表示该GPIO 引脚的活动电平是高电平。</li>
</ul>
<p>至此，关于led 的设备树就讲解完成了。</p>
<h3 id="60-3-其他SOC-设备树对比"><a href="#60-3-其他SOC-设备树对比" class="headerlink" title="60.3 其他SOC 设备树对比"></a>60.3 其他SOC 设备树对比</h3><p>而无论使用的是瑞芯微SOC 还是恩智浦、三星的SOC，在设备树关于gpio 相关的描述都是类似的，关于在恩智浦和三星源码中的ft5x06 设备树如下所示（关于gpio 相关的属性已经标记为了蓝色）：</p>
<p>恩智浦</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">gpio1<span class="token operator">:</span> gpio@<span class="token number">0209</span>c000 <span class="token punctuation">{</span>
    compatible <span class="token operator">=</span> <span class="token string">"fsl,inx6ul-gpio"</span><span class="token punctuation">,</span> <span class="token string">"fsl,imx35-gpio"</span><span class="token punctuation">;</span>
    reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x0209c000</span> <span class="token number">0x4000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span>GIC_SPI <span class="token number">66</span> IRQ_TYPE_LEVEL_HIGH<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>GIC_SPI <span class="token number">67</span> IRQ_TYPE_LEVEL_HIGH<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    gpio<span class="token operator">-</span>controller<span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">gpio</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    interrupt<span class="token operator">-</span>controller<span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">interrupt</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    
    edt<span class="token operator">-</span>ft5x06@<span class="token number">38</span> <span class="token punctuation">{</span>
        compatible <span class="token operator">=</span> <span class="token string">"edt,edt-ft5306"</span><span class="token punctuation">,</span> <span class="token string">"edt,edt-ft5x06"</span><span class="token punctuation">,</span> <span class="token string">"edt,edt-ft5406"</span><span class="token punctuation">;</span>
        pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>
        pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>ts_int_pin <span class="token operator">&amp;</span>ts_reset_pin<span class="token operator">&gt;</span><span class="token punctuation">;</span>
        reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x38</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        interrupt<span class="token operator">-</span>parent <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio1<span class="token operator">&gt;</span><span class="token punctuation">;</span>
        interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">9</span> <span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        reset<span class="token operator">-</span>gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio5 <span class="token number">9</span> GPIO_ACTIVE_LOW<span class="token operator">&gt;</span><span class="token punctuation">;</span>
        irq<span class="token operator">-</span>gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio1 <span class="token number">9</span> GPIO_ACTIVE_LOW<span class="token operator">&gt;</span><span class="token punctuation">;</span>
        status <span class="token operator">=</span> <span class="token string">"disabled"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>三星</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">gpio_c<span class="token operator">:</span> gpioc <span class="token punctuation">{</span>
    compatible <span class="token operator">=</span> <span class="token string">"gpio-controller"</span><span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">gpio</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    interrupt<span class="token operator">-</span>controller<span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">interrupt</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

ft5x06<span class="token operator">:</span> ft5x06038 <span class="token punctuation">{</span>
    compatible <span class="token operator">=</span> <span class="token string">"edt,edt-ft5406"</span><span class="token punctuation">;</span>
    reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x38</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>
    
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>RGB_1024x600<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">defined</span><span class="token punctuation">(</span>RGB_800x480<span class="token punctuation">)</span></span></span>
    pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>tsc2007_irq<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    interrupt<span class="token operator">-</span>parent <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio_c<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">26</span> IRQ_TYPE_EDGE_FALLING<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>LvDs_800×<span class="token number">1280</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">defined</span><span class="token punctuation">(</span>LvDS_1024x768<span class="token punctuation">)</span></span></span>
    pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gt911_irq<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    interrupt<span class="token operator">-</span>parent <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio_b<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">29</span> IRQ_TYPE_EDGE_FALLING<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    
    reset<span class="token operator">-</span>gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio_e <span class="token number">30</span> <span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>对比之后会发现，不同厂商对于gpio 的配置都是类似的，只是里面的参数有些许区别，如果大家在之后遇到了其他平台，只需要稍加区分即可。</p>
<h2 id="第61-章实例分析：pinctrl"><a href="#第61-章实例分析：pinctrl" class="headerlink" title="第61 章实例分析：pinctrl"></a>第61 章实例分析：pinctrl</h2><h3 id="61-1-pinmux-介绍"><a href="#61-1-pinmux-介绍" class="headerlink" title="61.1 pinmux 介绍"></a>61.1 pinmux 介绍</h3><p>Pinmux（引脚复用）是指在系统中配置和管理引脚功能的过程。在许多现代集成电路中，单个引脚可以具有多个功能，例如作为GPIO、UART、SPI 或I2C 等。通过使用引脚复用功能，可以在这些不同的功能之间切换。</p>
<p>引脚复用通过硬件和软件的方式实现。硬件层面，芯片设计会为每个引脚提供多个功能的选择。这些功能通常由芯片厂商在芯片规格文档中定义。通过编程设置寄存器或开关，可以选择某个功能来连接引脚。这种硬件层面的配置通常是由引脚控制器（Pin Controller）或引脚复用控制器（Pin Mux Controller）负责管理。</p>
<p>软件层面，操作系统或设备驱动程序需要了解和配置引脚的功能。它们使用设备树（DeviceTree）或设备树绑定（Device Tree Bindings）来描述和配置引脚的功能。在设备树中，可以指定引脚的复用功能，将其连接到特定的硬件接口或功能。操作系统或设备驱动程序在启动过程中解析设备树，并根据配置对引脚进行初始化和设置。</p>
<p>那我们要怎样知晓每一个管脚都可以复用成什么功能呢，一般在核心板原理图都会标注出每个管脚的复用功能，如下图（图61-1）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408221417306.png" alt="image-20240822141702208"></p>
<p>从上图可以看到<code>UART4_RX_M1</code> 对应的引脚可以复用为以下6 个功能<code>LCDC_D16</code>、<code>VOP_BT1120_D7</code>、<code>GMAC1_RXD0_M0</code>、<code>UART4_RX_M1</code>、<code>PWM8_M0</code>、<code>GPIO3_B1_d</code>，对应的BGA引脚标号为AG1,那这里的AG1 是如何定位的呢。</p>
<p>在BGA（Ball Grid Array，球栅阵列）封装中，引脚标号是用于唯一标识每个引脚的标识符。这些标号通常由芯片制造商定义，并在芯片的规格文档或数据手册中提供。</p>
<p>BGA 芯片的引脚标号通常由字母和数字的组合构成。它们用于在芯片的封装底部的焊盘上进行标记。每个引脚标号都与芯片内部的功能或信号相对应，以便正确连接到印刷电路板（PCB）上的目标位置。RK3568 的引脚标号图如下（图61-2）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408221417388.png" alt="image-20240822141736261"></p>
<p>可以看到纵向为A-AH 的28 个字母类型标号，横向为1-28 的28 个字母类型标号，瑞芯微也在对应的3568 数据手册中加入了根据BGA 位置制作的复用功能图，部分内容如下图（图61-3）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408221418501.png" alt="image-20240822141800339"></p>
<p>其中黑色框代表被保留的引脚，其他有颜色的框一般为电源和地，白色的框代表有具体复用功能的引脚。</p>
<p>脚复用提高了芯片的灵活性和可重用性，通过允许同一个引脚在不同的功能之间切换，可以减少硬件设计的复杂性和成本。此外，引脚复用还使得在使用相同芯片的不同应用中可以更加灵活地配置和定制引脚功能。</p>
<p>会在下一个小节中讲解如何使用pinctrl 在设备树中配置引脚的复用。</p>
<h3 id="61-2-使用pinctrl-设置复用关系"><a href="#61-2-使用pinctrl-设置复用关系" class="headerlink" title="61.2 使用pinctrl 设置复用关系"></a>61.2 使用pinctrl 设置复用关系</h3><p>pinctrl（引脚控制）用于描述和配置硬件设备上的引脚功能和连接方式。它是设备树的一部分，用于在启动过程中传递引脚配置信息给操作系统和设备驱动程序，以便正确地初始化和控制引脚。</p>
<p>在设备树中，pinctrl（引脚控制）使用了客户端和服务端的概念来描述引脚控制的关系和配置。</p>
<h4 id="61-2-1-客户端（Client）-固定的"><a href="#61-2-1-客户端（Client）-固定的" class="headerlink" title="61.2.1 客户端（Client）(固定的)"></a>61.2.1 客户端（Client）(固定的)</h4><p>接下来将使用三个例子对客户端要用到的属性进行讲解。</p>
<p><strong>例1：</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">node <span class="token punctuation">{</span>
    pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>
    pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>pinctrl_hog_1<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>在例1 中，<code>pinctrl-names</code> 属性定义了一个状态名称：default。<br>pinctrl-0 属性指定了第一个状态default 对应的引脚配置。<br>&lt;&amp;pinctrl_hog_1&gt; 是一个引脚描述符，它引用了一个名为pinctrl_hog_1 的引脚控制器节点。这表示在default 状态下，设备的引脚配置将使用pinctrl_hog_1 节点中定义的配置。</p>
<p><strong>例2：</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">node <span class="token punctuation">{</span>
pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">,</span> <span class="token string">"wake up"</span><span class="token punctuation">;</span>
pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>pinctrl_hog_1<span class="token operator">&gt;</span><span class="token punctuation">;</span>				<span class="token comment">//这个就是default的状态的配置，pinctrl_hog_1是服务端的节点</span>
pinctrl<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>pinctrl_hog_2<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在例2 中，<code>pinctrl-names</code> 属性定义了两个状态名称：default 和wake up。<br>pinctrl-0 属性指定了第一个状态default 对应的引脚配置，引用了pinctrl_hog_1 节点。</p>
<p>pinctrl-1 属性指定了第二个状态wake up 对应的引脚配置，引用了pinctrl_hog_2 节点。<br>这意味着设备可以处于两个不同的状态之一，每个状态分别使用不同的引脚配置。</p>
<p><strong>例3：</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">node <span class="token punctuation">{</span>
    pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>
    pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>pinctrl_hog_1 <span class="token operator">&amp;</span>pinctrl_hog_2<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>在这个例子中，pinctrl-names 属性仍然定义了一个状态名称：default。<br>pinctrl-0 属性指定了第一个状态default 对应的引脚配置，但与之前的例子不同的是，它引用了两个引脚描述符：pinctrl_hog_1 和pinctrl_hog_2。<br>这表示在default 状态下，设备的引脚配置将使用pinctrl_hog_1 和pinctrl_hog_2 两个节点中定义的配置。这种方式可以将多个引脚控制器的配置组合在一起，以满足特定状态下的引脚需求。</p>
<p>至此关于客户端的内容就讲解完成了，低于客户端的内容，不同厂家的编写格式是相同的，而服务端每个厂家就有区别了，在下一个小节将以rk3568 的pinctrl 服务端为例进行讲解。</p>
<h4 id="61-2-2-服务端（Server）（根据平台）"><a href="#61-2-2-服务端（Server）（根据平台）" class="headerlink" title="61.2.2 服务端（Server）（根据平台）"></a>61.2.2 服务端（Server）（根据平台）</h4><p>服务端是设备树中定义引脚配置的部分。它包含引脚组和引脚描述符，为客户端提供引脚配置选择。服务端在设备树中定义了pinctrl 节点，其中包含引脚组和引脚描述符的定义。</p>
<p>这里以瑞芯微的RK3568 为例进行pinctrl 服务端的讲解，瑞芯微原厂BSP 工程师为了方便用户通过pinctrl 设置管脚的复用关系，将包含所有复用关系的配置写在了内核目录下的“<code>arch/arm64/boot/dts/rockchip/rk3568-pinctrl.dtsi</code>”设备树中，具体内容如下（图61-4）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408271124323.png" alt="image-20240827112404162"></p>
<p>在<code>pinctrl</code> 节点中就是每个节点的复用功能，然后我们以uart4 的引脚复用为例进行讲解，uart4 的pinctrl 服务端内容如下（图61-5）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408271405276.png" alt="image-20240827140548217"></p>
<p> 其中<code>&lt;3 RK_PB1 4 &amp;pcfg_pull_up&gt;</code>和<code>&lt;3 RK_PB2 4 &amp;pcfg_pull_up&gt;</code>分别表示将<code>GPIO3</code> 的<code>PB1</code> 引脚设置为功能4，将<code>GPIO3</code> 的<code>PB2</code> 也设置为功能4，且电器属性都会设置为上拉。通过查找原理图可以得到两个引脚在BGA 封装位置分别为AG1 和AF2，如下图（图61-6）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408271411463.png" alt="image-20240827141158404"></p>
<p>然后在rk3568 的数据手册中找到引脚复用表对应的位置，具体内容如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408271412440.png" alt="image-20240827141223385" style="zoom:80%;"><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408271412307.png" alt="image-20240827141232242" style="zoom:80%;"></p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408271412029.png" alt="image-20240827141241969"></p>
<p>可以看到功能4 对应串口4 的发送端和接收端，pinctrl 服务端的配置和数据手册中的引脚复用功能是一一对应，那如果要将RK_PB1 和RK_PB2 设置为GPIO 功能要如何设置呢，从上图可以看到GPIO 对应功能0，所以可以通过以下pinctrl 内容将设置RK_PB1 和RK_PB2 设置为GPIO 功能（事实上如果不对该管脚进行功能复用该引脚默认就会设置为GPIO 功能）：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token operator">&lt;</span><span class="token number">3</span> RK_PB1 <span class="token number">0</span> <span class="token operator">&amp;</span>pcfg_pull_up<span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token operator">&lt;</span><span class="token number">3</span> RK_PB2 <span class="token number">0</span> <span class="token operator">&amp;</span>pcfg_pull_up<span class="token operator">&gt;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>最后来看客户端对uart4 服务端的引用，具体内容在内核源码目录“<code>arch/arm64/boot/dts/rockchip/rk3568-evb1-ddr4-v10-linux.dts</code>”：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408271414747.png" alt="image-20240827141417695"></p>
<p>通过在客户端中引用服务端的引脚描述符，设备树可以将客户端和服务端的引脚配置关联起来。这样，在设备树被解析和处理时，操作系统和设备驱动程序可以根据客户端的需求，查找并应用适当的引脚配置。</p>
<h3 id="61-3-pinctrl-实例编写"><a href="#61-3-pinctrl-实例编写" class="headerlink" title="61.3 pinctrl 实例编写"></a>61.3 pinctrl 实例编写</h3><p>本小节将通过上面学到的<code>pinctrl</code> 相关知识，将<code>led</code> 的控制引脚复用为<code>GPIO</code> 模式。</p>
<p>首先来对rk3568 的设备树结构进行以下介绍，根据sdk 源码目录下的“<code>device/rockchip/rk356x/BoardConfig-rk3568-evb1-ddr4-v10.mk</code>”默认配置文件可以了解到编译的设备树为<code>rk3568-evb1-ddr4-v10-linux.dts</code>,整理好的设备树之间包含关系列表如下所示：</p>
<table>
<thead>
<tr>
<th>顶层设备树</th>
<th>rk3568-evb1-ddr4-v10-linux.dts</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>第二级设备树</td>
<td>rk3568-evb1-ddr4-v10.dtsi</td>
<td>rk3568-linux.dtsi</td>
</tr>
<tr>
<td>第三级设备树</td>
<td>rk3568.dtsi<br>rk3568-evb.dtsi<br>topeet_screen_choose.dtsi<br>topeet_rk3568_lcds.dtsi</td>
<td></td>
</tr>
</tbody></table>
<p>Led 在<code>rk3568-evb.dtsi</code> 设备树中已经被正常配置了，如下图（图61- 9）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408271417947.png" alt="image-20240827141725887"></p>
<p>这时候可能大家就有问题了，这里也并没有配置pinctrl 呀，那为什么led 最后能正常使用呢，这个原因在上节课中其实我们已经提到了，当一个引脚没有被复用为任何功能时，默认就是GPIO 功能，所以这里没有pinctrl led 功能也可以正常使用。<br>但这里我们仍旧使用pinctrl 对led 进行配置，从而熟练pinctrl，首先注释掉leds 节点，注释完成如下（图61- 10）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408271418789.png" alt="image-20240827141810730"></p>
<p>保存退出之后，然后进入到<code>rk3568-evb1-ddr4-v10.dtsi</code> 设备树中，找到<code>rk_485_ctl</code> 节点，如下图（图61- 11）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408271419205.png" alt="image-20240827141920151"></p>
<p>这是根节点的最后一个节点，而且也是用来控制一个GPIO 的，我们完全可以仿照该节点，在该节点下方编写led 控制节点，仿写完成的设备树内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">my_led<span class="token operator">:</span> led <span class="token punctuation">{</span>
    compatible <span class="token operator">=</span> <span class="token string">"topeet,led"</span><span class="token punctuation">;</span>
    gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio0 RK_PB7 GPIO_ACTIVE_HIGH<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>
    pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>rk_led_gpio<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>第1 行：节点名称为led，标签名为my_led。</li>
<li>第2 行：compatible 属性指定了设备的兼容性标识，即设备与驱动程序之间的匹配规则。在这里，设备标识为”topeet,led”，表示该LED 设备与名为”topeet,led” 的驱动程序兼容。</li>
<li>第3 行：gpios 属性指定了与LED 相关的GPIO（通用输入/输出）引脚配置。</li>
<li>第4 行：pinctrl-names 属性指定了与引脚控制相关的命名。default 表示状态0</li>
<li>第5 行：pinctrl-0 属性指定了与pinctrl-names 属性中命名的引脚控制相关联的实际引脚控制器配置。&lt;&amp;rk_led_gpio&gt; 表示引用了名为rk_led_gpio 的引脚控制器配置。</li>
</ul>
<p>添加完成如下图（图61- 12）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408271423694.png" alt="image-20240827142351625"></p>
<p>然后继续找到在同一设备树文件的485 pinctrl 服务端节点，具体内容如下（图61- 13）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408271424261.png" alt="image-20240827142412208"></p>
<p>然后在该节点下方仿写led 控制引脚<code>pinctrl</code> 服务端节点，仿写完成的节点内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">rk_led<span class="token punctuation">{</span>
    rk_led_gpio<span class="token operator">:</span>rk<span class="token operator">-</span>led<span class="token operator">-</span>gpio <span class="token punctuation">{</span>
        rockchip<span class="token punctuation">,</span>pins <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span> RK_PB7 RK_FUNC_GPIO <span class="token operator">&amp;</span>pcfg_pull_none<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>添加完成之后如下图（图61- 14）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408271425776.png" alt="image-20240827142504710"></p>
<p>至此，led 的控制引脚就通过pinctrl 被复用为了GPIO 功能，保存退出之后，重新编译内核，没有报错就证明我们的实验完成了。</p>
<h2 id="第62-章dtb-文件格式讲解"><a href="#第62-章dtb-文件格式讲解" class="headerlink" title="第62 章dtb 文件格式讲解"></a>第62 章dtb 文件格式讲解</h2><p>设备树Blob (DTB) 格式是设备树数据的平面二进制编码。它用于在软件程序之间交换设备树数据。例如，在启动操作系统时，固件会将DTB 传递给操作系统内核。</p>
<p>DTB 格式在单个、线性、无指针数据结构中对设备树数据进行编码。它由一个小头部和三个可变大小的部分组成：内存保留块、结构块和字符串块。这些应该以该顺序出现在展平的设备树中。因此，设备树结构作为一个整体，当加载到内存地址时，将类似于下图（图62-1）所示：</p>
<img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408271431617.png" alt="image-20240827143144552" style="zoom:50%;">

<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token operator">/</span>dts<span class="token operator">-</span>v1<span class="token operator">/</span><span class="token punctuation">;</span>
<span class="token operator">/</span> <span class="token punctuation">{</span>
    model <span class="token operator">=</span> <span class="token string">"This is my devicetree!"</span><span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    chosen <span class="token punctuation">{</span>
    	bootargs <span class="token operator">=</span> <span class="token string">"root=/dev/nfs rw nfsroot=192.168.1.1 console=ttyS0, 115200"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    cpu1<span class="token operator">:</span> cpu@<span class="token number">1</span> <span class="token punctuation">{</span>
        device_type <span class="token operator">=</span> <span class="token string">"cpu"</span><span class="token punctuation">;</span>
        compatible <span class="token operator">=</span> <span class="token string">"arm,cortex-a35"</span><span class="token punctuation">,</span> <span class="token string">"arm,armv8"</span><span class="token punctuation">;</span>
        reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x0</span> <span class="token number">0x1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    aliases <span class="token punctuation">{</span>
        led1 <span class="token operator">=</span> <span class="token string">"/gpio@22020101"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    node1 <span class="token punctuation">{</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
        gpio@<span class="token number">22020102</span> <span class="token punctuation">{</span>
            reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x20220102</span> <span class="token number">0x40</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    node2 <span class="token punctuation">{</span>
        node1<span class="token operator">-</span>child <span class="token punctuation">{</span>
            pinnum <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">01234</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    gpio@<span class="token number">22020101</span> <span class="token punctuation">{</span>
        compatible <span class="token operator">=</span> <span class="token string">"led"</span><span class="token punctuation">;</span>
        reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x20220101</span> <span class="token number">0x40</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>而我们之后要分析的是二进制的dtb 文件，所以需要使用dtc 工具将上面的dts 文件编译成dtb 文件，具体命令如下（图62-2）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408271435819.png" alt="image-20240827143537756"></p>
<p>为了方便用户学习，已经将本章节要讲解的设备树dts 文件和dtb 文件放在了对应的网盘路径下，同时也将pxBinaryViewerSetup 二进制分析软件放在了同一目录下，iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568 开发板】指南教程\02_Linux 驱动配套资料\04_Linux驱动例程\49_dt_format，如下图（图62-3）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408271436663.png" alt="image-20240827143610609"></p>
<p>使用二进制分析软件打开deb 文件并设置<strong>大端模式</strong>之后如下（图62-4）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408271437021.png" alt="image-20240827143704746"></p>
<p>在接下来的小节中将会对读取出的设备树二进制内容进行讲解。</p>
<h3 id="62-1-Header"><a href="#62-1-Header" class="headerlink" title="62.1 Header"></a>62.1 Header</h3><p>devicetree 的头布局由以下C 结构定义。所有的头字段都是32 位整数，以大端格式存储。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">fdt_header</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint32_t</span> magic<span class="token punctuation">;</span> <span class="token comment">// 设备树头部的魔数</span>
    <span class="token class-name">uint32_t</span> totalsize<span class="token punctuation">;</span> <span class="token comment">// 设备树文件的总大小</span>
    <span class="token class-name">uint32_t</span> off_dt_struct<span class="token punctuation">;</span> <span class="token comment">// 设备树结构体（节点数据）相对于文件开头的偏移量</span>
    <span class="token class-name">uint32_t</span> off_dt_strings<span class="token punctuation">;</span> <span class="token comment">// 设备树字符串表相对于文件开头的偏移量</span>
    <span class="token class-name">uint32_t</span> off_mem_rsvmap<span class="token punctuation">;</span> <span class="token comment">// 内存保留映射表相对于文件开头的偏移量</span>
    <span class="token class-name">uint32_t</span> version<span class="token punctuation">;</span> <span class="token comment">// 设备树版本号</span>
    <span class="token class-name">uint32_t</span> last_comp_version<span class="token punctuation">;</span> <span class="token comment">// 最后一个兼容版本号</span>
    <span class="token class-name">uint32_t</span> boot_cpuid_phys<span class="token punctuation">;</span> <span class="token comment">// 启动CPU 的物理ID</span>
    <span class="token class-name">uint32_t</span> size_dt_strings<span class="token punctuation">;</span> <span class="token comment">// 设备树字符串表的大小</span>
    <span class="token class-name">uint32_t</span> size_dt_struct<span class="token punctuation">;</span> <span class="token comment">// 设备树结构体（节点数据）的大小</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>每个字段的描述如下所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408271439301.png" alt="image-20240827143959237"></p>
<p>然后来查看二进制文件，其中4 个字节表示一个单位，前十个单位分别代表上述的十个字段如下图（图62-5）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408271440474.png" alt="image-20240827144032405"></p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408271443334.png" alt="image-20240827144304278"></p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408271443425.png" alt="image-20240827144315370"></p>
<p>在接下来的小节中将会对header 提到的内存保留块、结构块和字符串块进行更详细的讲解。</p>
<h3 id="62-2-内存保留块"><a href="#62-2-内存保留块" class="headerlink" title="62.2 内存保留块"></a>62.2 内存保留块</h3><p>内存保留块（Memory Reserved Block）是用于客户端程序的保护和保留物理内存区域的列表。这些保留区域不应被用于一般的内存分配，而是用于保护重要数据结构，以防止客户端程序覆盖这些数据。内存保留块的目的是确保特定的内存区域在客户端程序运行时不被修改或使用。由于在示例设备树中没有设置内存保留块，所以相应的区域都为0，如下（图62-6）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408271443967.png" alt="image-20240827144358886"></p>
<p><strong>保留区域列表</strong>： 内存保留块是一个由一组64 位大端整数对构成的列表。每对整数对应一个保留内存区域，其中包含物理地址和区域的大小（以字节为单位）。这些保留区域应该彼此不重叠。<br><strong>保留区域的用途</strong>： 客户端程序不应访问内存保留块中的保留区域，除非引导程序提供的其他信息明确指示可以访问。引导程序可以使用特定的方式来指示客户端程序可以访问保留内存的部分内容。引导程序可能会在文档、可选的扩展或特定于平台的文档中说明保留内存的特定用途。<br><strong>格式</strong>： 内存保留块中的每个保留区域由一个64 位大端整数对表示。每对由以下C 结构表示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">fdt_reserve_entry</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint64_t</span> address<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> size<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中的第一个整数表示保留区域的物理地址，第二个整数表示保留区域的大小（以字节为单位）。每个整数都以64 位的形式表示，即使在32 位架构上也是如此。在32 位CPU 上，整数的高32 位将被忽略。</p>
<p>内存保留块为设备树提供了保护和保留物理内存区域的功能。它确保了特定的内存区域在客户端程序运行时不被修改或使用。这样可以确保引导程序和其他关键组件在需要的情况下能够访问保留内存的特定部分，并保护关键数据结构免受意外修改。</p>
<h3 id="62-3-结构块"><a href="#62-3-结构块" class="headerlink" title="62.3 结构块"></a>62.3 结构块</h3><p>结构块是设备树中描述设备树本身结构和内容的部分。它由一系列带有数据的令牌序列组成，这些令牌按照线性树结构进行组织。</p>
<p><strong>（1）令牌类型</strong><br>结构块中的令牌分为五种类型，每种类型用于不同的目的。<br>a. FDT_BEGIN_NODE (0x00000001): FDT_BEGIN_NODE 标记表示一个节点的开始。它后面跟着节点的单元名称作为额外数据。节点名称以以空字符结尾的字符串形式存储，并且可以包括单元地址。节点名称后可能需要填充零字节以对齐，然后是下一个标记，可以是除了FDT_END之外的任何标记。</p>
<p>b. FDT_END_NODE (0x00000002): FDT_END_NODE 标记表示一个节点的结束。该标记没有额外的数据，紧随其后的是下一个标记，可以是除了FDT_PROP 之外的任何标记。</p>
<p>c. FDT_PROP (0x00000003): FDT_PROP 标记表示设备树中属性的开始。它后面跟着描述属性的额外数据，该数据首先由属性的长度和名称组成，表示为以下C 结构</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint32_t</span> len<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> nameoff<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>长度表示属性值的字节长度，名称偏移量指向字符串块中存储属性名称的位置。在这个结构之后，属性的值作为字节字符串给出。属性值后可能需要填充零字节以对齐，然后是下一个令牌，可以是除了FDT_END 之外的任何标记。</p>
<p>d. FDT_NOP (0x00000004): FDT_NOP 令牌可以被解析设备树的程序忽略。该令牌没有额外的数据，紧随其后的是下一个令牌，可以是任何有效的令牌。使用FDT_NOP 令牌可以覆盖树中的属性或节点定义，从而将其从树中删除，而无需移动设备树blob 中的其他部分。</p>
<p>e. FDT_END (0x00000009): FDT_END 标记表示结构块的结束。应该只有一个FDT_END 标记，并且应该是结构块中的最后一个标记。该标记没有额外的数据，紧随其后的字节应该位于结构块的开头偏移处，该偏移等于设备树blob 标头中的size_dt_struct 字段的值。</p>
<p><strong>（2）树状结构：</strong></p>
<p>设备树的结构以线性树的形式表示。每个节点由FDT_BEGIN_NODE 标记开始，由FDT_END_NODE 标记结束。节点的属性和子节点在FDT_END_NODE 之前表示，因此子节点的FDT_BEGIN_NODE 和FDT_END_NODE 令牌嵌套在父节点的令牌中。</p>
<p><strong>（3）结构块的结束</strong></p>
<p>结构块以单个FDT_END 标记结束。该标记没有额外的数据，它位于结构块的末尾，并且是结构块中的最后一个标记。FDT_END 标记之后的字节应位于结构块的开头偏移处，该偏移等于设备树blob 标头中的size_dt_struct 字段的值。</p>
<p>最后对结构块开头的部分内容进行讲解，具体内容如下（图62-7）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408271448054.png" alt="image-20240827144816961"></p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408271448511.png" alt="image-20240827144843447"></p>
<p>通过使用结构块，设备树可以以一种层次化的方式组织和描述系统中的设备和资源。每个节点可以包含属性和子节点，从而实现更加灵活和可扩展的设备树表示。</p>
<h3 id="62-4-字符串块"><a href="#62-4-字符串块" class="headerlink" title="62.4 字符串块"></a>62.4 字符串块</h3><p>字符串块用于存储设备树中使用的所有属性名称。它由一系列以空字符结尾的字符串组成，这些字符串在字符串块中简单地连接在一起，具体示例如下（图62-8）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408271449107.png" alt="image-20240827144919021"></p>
<p><strong>（1）字符串连接</strong></p>
<p>字符串块中的字符串以空字符（\0）作为终止符来连接。这意味着每个字符串都以空字符结尾，并且下一个字符串紧跟在上一个字符串的末尾。这种连接方式使得字符串块中的所有字符串形成一个连续的字符序列。</p>
<p><strong>（2）偏移量引用</strong></p>
<p>在结构块中，属性的名称是通过偏移量来引用字符串块中的相应字符串的。偏移量是一个无符号整数值，它表示字符串在字符串块中的位置。通过使用偏移量引用，设备树可以节省空间，并且在属性名称发生变化时也更加灵活，因为只需要更新偏移量，而不需要修改结构块中的属性引用。</p>
<p><strong>（3）对齐约束：</strong></p>
<p>字符串块没有对齐约束，这意味着它可以出现在设备树blob 的任何偏移处。这使得字符串块的位置在设备树blob 中是灵活的，并且可以根据需要进行调整，而不会对设备树的解析和处理造成影响。</p>
<p>字符串块是设备树中用于存储属性名称的部分。它由字符串连接而成，并通过偏移量在结构块中进行引用。字符串块的灵活位置使得设备树的表示更加紧凑和可扩展。</p>
<h2 id="第63-章dtb-展开成device-node-实验"><a href="#第63-章dtb-展开成device-node-实验" class="headerlink" title="第63 章dtb 展开成device_node 实验"></a>第63 章dtb 展开成device_node 实验</h2><p>在上个小节中我们讲解了设备树deb 的文件格式，那deb 文件是怎样传递给内核的呢，那就进入到本小节的学习吧。</p>
<h3 id="63-1-dtb-展开流程"><a href="#63-1-dtb-展开流程" class="headerlink" title="63.1 dtb 展开流程"></a>63.1 dtb 展开流程</h3><p>dtb 展开流程图如下（图63-1）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408271450283.png" alt="image-20240827145012209"></p>
<p>接下来将会根据上图对deb 的展开流程进行详细的讲解：</p>
<ul>
<li>（1）<strong>设备树源文件编写</strong>：根据之前的章节中讲解的设备树的基本语法和相关知识编写符合规范的设备树。</li>
<li>（2）设备树编译：设备树源文件经过设备树编译器（dtc）进行编译，生成设备树二进制文件（.dtb）。设备树编译器会检查源文件的语法和语义，并将其转换为二进制格式，以便内核能够解析和使用。</li>
<li>（3）<strong>boot.img 镜像生成</strong>：<strong>boot.img 是一个包含内核镜像、设备树二进制文件和其他一些资源文件的镜像文件</strong>（<strong>目前只是适用于瑞芯微的soc 上，其他厂商的soc 需要具体问题具体分析</strong>）。在生成boot.img 时，通常会将内核镜像、设备树二进制文件和其他一些资源文件打包在一起。这个过程可以使用特定的工具或脚本完成。</li>
<li>（4）<strong>U-Boot 加载</strong>：U-Boot（Universal Bootloader）是一种常用的开源引导加载程序，用于引导嵌入式系统。在系统启动过程中，U-Boot 会将boot.img 中的内核和设备树的二进制文件加载到系统内存的特定地址。</li>
<li>（5）<strong>内核初始化</strong>：U-Boot 将内核和设备树的二进制文件加载到系统内存的特定地址后，控制权会转交给内核。在内核初始化的过程中，会解析设备树二进制文件，将其展开为内核可以识别的数据结构，以便内核能够正确地初始化和管理硬件资源。</li>
<li>（6）<strong>设备树展开</strong>：设备树展开是指将设备树二进制文件解析成内核中的设备节点（device_node）的过程。内核会读取设备树二进制文件的内容，并根据设备树的描述信息，构建设备树数据结构，例如设备节点、中断控制器、寄存器、时钟等。这些设备树数据结构将在内核运行时用于管理和配置硬件资源。</li>
</ul>
<p>而本章节要讲解的重点就在上面的第6 步“设备树的展开”，最终设备树二进制文件会被解析成device_node，device_node 结构体定义在内核源码的“/include/linux/of.h”文件中，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span> <span class="token comment">// 设备节点的名称</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>type<span class="token punctuation">;</span> <span class="token comment">// 设备节点的类型</span>
    phandle phandle<span class="token punctuation">;</span> <span class="token comment">// 设备节点的句柄</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>full_name<span class="token punctuation">;</span> <span class="token comment">// 设备节点的完整名称</span>
    <span class="token keyword">struct</span> <span class="token class-name">fwnode_handle</span> fwnode<span class="token punctuation">;</span> <span class="token comment">// 设备节点的固件节点句柄</span>
    <span class="token keyword">struct</span> <span class="token class-name">property</span> <span class="token operator">*</span>properties<span class="token punctuation">;</span> <span class="token comment">// 设备节点的属性列表</span>
    <span class="token keyword">struct</span> <span class="token class-name">property</span> <span class="token operator">*</span>deadprops<span class="token punctuation">;</span> <span class="token comment">// 已删除的属性列表</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>parent<span class="token punctuation">;</span> <span class="token comment">// 父设备节点指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>child<span class="token punctuation">;</span> <span class="token comment">// 子设备节点指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>sibling<span class="token punctuation">;</span> <span class="token comment">// 兄弟设备节点指针</span>
    
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>CONFIG_OF_KOBJ<span class="token punctuation">)</span></span></span>
        <span class="token keyword">struct</span> <span class="token class-name">kobject</span> kobj<span class="token punctuation">;</span> <span class="token comment">// 内核对象（用于sysfs）</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> _flags<span class="token punctuation">;</span> <span class="token comment">// 设备节点的标志位</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">;</span> <span class="token comment">// 与设备节点相关的数据指针</span>
    
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>CONFIG_SPARC<span class="token punctuation">)</span></span></span>
        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path_component_name<span class="token punctuation">;</span> <span class="token comment">// 设备节点的路径组件名称</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> unique_id<span class="token punctuation">;</span> <span class="token comment">// 设备节点的唯一标识</span>
        <span class="token keyword">struct</span> <span class="token class-name">of_irq_controller</span> <span class="token operator">*</span>irq_trans<span class="token punctuation">;</span> <span class="token comment">// 设备节点的中断控制器</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后对该结构体的重要参数进行讲解：</p>
<ul>
<li>（1）**<code>name</code>**：name 字段表示设备节点的名称。设备节点的名称是在设备树中唯一标识该节点的字符串。它通常用于在设备树中引用设备节点。</li>
<li>（2）**<code>type</code>**：type 字段表示设备节点的类型。设备节点的类型提供了关于设备节点功能和所属设备类别的信息。它可以用于识别设备节点的用途和特性。</li>
<li>（3）**<code>properties</code>**：properties 字段是指向设备节点属性列表的指针。设备节点的属性包含了与设备节点相关联的配置和参数信息。属性以键值对的形式存在，可以提供设备的特定属性、寄存器地址、中断信息等。property 字段同样定义在内核源码的“/include/linux/of.h”文件中，</li>
</ul>
<p>具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">property</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span> <span class="token comment">// 属性的名称</span>
    <span class="token keyword">int</span> length<span class="token punctuation">;</span> <span class="token comment">// 属性值的长度（字节数）</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>value<span class="token punctuation">;</span> <span class="token comment">// 属性值的指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">property</span> <span class="token operator">*</span>next<span class="token punctuation">;</span> <span class="token comment">// 下一个属性节点指针</span>
    
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>CONFIG_OF_DYNAMIC<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">defined</span><span class="token punctuation">(</span>CONFIG_SPARC<span class="token punctuation">)</span></span></span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> _flags<span class="token punctuation">;</span> <span class="token comment">// 属性的标志位</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>CONFIG_OF_PROMTREE<span class="token punctuation">)</span></span></span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> unique_id<span class="token punctuation">;</span> <span class="token comment">// 属性的唯一标识</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>CONFIG_OF_KOBJ<span class="token punctuation">)</span></span></span>
        <span class="token keyword">struct</span> <span class="token class-name">bin_attribute</span> attr<span class="token punctuation">;</span> <span class="token comment">// 内核对象二进制属性</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>（4）**<code>parent</code>**（父设备节点）： parent 字段指向当前设备节点的父设备节点。设备树中的设备节点按照层次结构组织，每个设备节点都有一个直接上级（父设备节点）。通过<code>parent</code> 字段，可以在设备树中向上遍历设备节点的父节点。</li>
<li>（5）**<code>child</code>**（子设备节点）： child 字段指向当前设备节点的第一个子设备节点。一个设备节点可以拥有多个子设备节点，在设备树中表示它们是当前设备节点的直接下级。通过child字段获取到第一个子设备节点后，可以使用sibling 字段遍历它们的兄弟节点，从而遍历所有的子节点。</li>
<li>（6）**<code>sibling</code>**（兄弟设备节点）： sibling 字段指向当前设备节点在设备树中的下一个兄弟设备节点。兄弟设备节点是指在设备树中处于同一级别的设备节点，它们共享相同的父设备节点。通过sibling 字段，可以在同级设备节点之间进行遍历，获取它们的信息或进行操作。</li>
</ul>
<p>至此，关于device_node 的结构体讲解就完成了，虽然我们现在知道了，dtb 文件最终会展开成device_node 这一可以让内核识别的格式，那更具体的实现流程是怎样的呢，让我们进入下一小节的学习吧。</p>
<h3 id="63-2-dtb-解析过程源码分析"><a href="#63-2-dtb-解析过程源码分析" class="headerlink" title="63.2 dtb 解析过程源码分析"></a>63.2 dtb 解析过程源码分析</h3><p>首先来到源码目录下的“<code>/init/main.c</code>”文件，找到其中的<code>start_kernel</code> 函数，<code>start_kernel</code> 函数是<code>Linux</code> 内核启动的入口点，它是Linux 内核的核心函数之一，负责完成内核的初始化和启动过程，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">asmlinkage __visible <span class="token keyword">void</span> __init <span class="token function">start_kernel</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>command_line<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>after_dashes<span class="token punctuation">;</span>
    <span class="token function">set_task_stack_end_magic</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>init_task<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置任务栈的魔数</span>
    <span class="token function">smp_setup_processor_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置处理器ID</span>
    <span class="token function">debug_objects_early_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化调试对象</span>
    <span class="token function">cgroup_init_early</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化cgroup（控制组）</span>
    <span class="token function">local_irq_disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 禁用本地中断</span>
    early_boot_irqs_disabled <span class="token operator">=</span> true<span class="token punctuation">;</span> <span class="token comment">// 标记早期引导期间中断已禁用</span>
    <span class="token comment">/*
    * 中断仍然被禁用。进行必要的设置，然后启用它们。
    */</span>
    <span class="token function">boot_cpu_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化引导CPU</span>
    <span class="token function">page_address_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置页地址</span>
    <span class="token function">pr_notice</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> linux_banner<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打印Linux 内核版本信息</span>
    <span class="token function">setup_arch</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>command_line<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 架构相关的初始化</span>
    <span class="token function">mm_init_cpumask</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>init_mm<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化内存管理的cpumask（CPU 掩码）</span>
    <span class="token function">setup_command_line</span><span class="token punctuation">(</span>command_line<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置命令行参数</span>
    <span class="token function">setup_nr_cpu_ids</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置CPU 个数</span>
    <span class="token function">setup_per_cpu_areas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置每个CPU 的区域</span>
    <span class="token function">smp_prepare_boot_cpu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 准备启动CPU（架构特定的启动CPU 钩子）</span>
    <span class="token function">boot_cpu_hotplug_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化热插拔的引导CPU</span>
    <span class="token function">build_all_zonelists</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 构建所有内存区域列表</span>
    <span class="token function">page_alloc_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化页面分配器</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中跟设备树相关的函数为第20 行的<code>setup_arch(&amp;command_line);</code>该函数定义在内核源码的“<code>/arch/arm64/kernel/setup.c</code>”文件中，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> __init <span class="token function">setup_arch</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>cmdline_p<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    init_mm<span class="token punctuation">.</span>start_code <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> _text<span class="token punctuation">;</span>
    init_mm<span class="token punctuation">.</span>end_code <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> _etext<span class="token punctuation">;</span>
    init_mm<span class="token punctuation">.</span>end_data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> _edata<span class="token punctuation">;</span>
    init_mm<span class="token punctuation">.</span>brk <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> _end<span class="token punctuation">;</span>
    <span class="token operator">*</span>cmdline_p <span class="token operator">=</span> boot_command_line<span class="token punctuation">;</span>
    
    <span class="token function">early_fixmap_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化early fixmap</span>
    <span class="token function">early_ioremap_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化early ioremap</span>
    
    <span class="token function">setup_machine_fdt</span><span class="token punctuation">(</span>__fdt_pointer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置机器的FDT（平台设备树）</span>
    
    <span class="token comment">// 初始化静态密钥，早期可能会被cpufeature 代码和早期参数启用</span>
    <span class="token function">jump_label_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">parse_early_param</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 在启动可能的早期控制台后，解除屏蔽异步中断和FIQ（一旦我们可以报告发生的系统错误）</span>
    <span class="token function">local_daif_restore</span><span class="token punctuation">(</span>DAIF_PROCCTX_NOIRQ<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 在这个阶段，TTBR0 仅用于身份映射。将其指向零页面，以避免做出猜测性的新条目获取。</span>
    <span class="token function">cpu_uninstall_idmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">xen_early_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Xen 平台的早期初始化</span>
    <span class="token function">efi_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// EFI 平台的初始化</span>
    <span class="token function">arm64_memblock_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ARM64 内存块的初始化</span>
    
    <span class="token function">paging_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 分页初始化</span>
    
    <span class="token function">acpi_table_upgrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ACPI 表的升级</span>
    
    <span class="token comment">// 解析ACPI 表以进行可能的引导时配置</span>
    <span class="token function">acpi_boot_table_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>acpi_disabled<span class="token punctuation">)</span>
        <span class="token function">unflatten_device_tree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 展开设备树</span>
    <span class="token function">bootmem_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 引导内存的初始化</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在setup_arch 函数中与设备树相关的函数分别为第13 行的<code>setup_machine_fdt(__fdt_pointer)</code>和第37 行的<code>unflatten_device_tree()</code>，接下来将对上述两个函数进行详细的介绍</p>
<h4 id="63-2-1-setup-machine-fdt-fdt-pointer"><a href="#63-2-1-setup-machine-fdt-fdt-pointer" class="headerlink" title="63.2.1 setup_machine_fdt(__fdt_pointer)"></a>63.2.1 <code>setup_machine_fdt(__fdt_pointer)</code></h4><p><code>setup_machine_fdt(__fdt_pointer)</code>中的<code>__fdt_pointer</code> 是dtb 二进制文件加载到内存的地址，该地址由bootloader 启动kernel 时透过x0 寄存器传递过来的，具体的汇编代码在内核源码目录下的“<code>/arch/arm64/kernel/head.S</code>”文件中，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">preserve_boot_args<span class="token operator">:</span>
    mov x21<span class="token punctuation">,</span> x0 <span class="token comment">// x21=FDT</span>
        
__primary_switched<span class="token operator">:</span>
    str_l x21<span class="token punctuation">,</span> __fdt_pointer<span class="token punctuation">,</span> x5 <span class="token comment">// Save FDT pointer</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>第2 行: 将寄存器x0 的值复制到寄存器x21。x0 寄存器中保存了一个指针，该指针指向设备树（Device Tree）。</li>
<li>第4 行: 将寄存器x21 的值存储到内存地址__fdt_pointer 中。</li>
</ul>
<p>然后来看setup_machine_fdt 函数，该函数定义在内核源码的“<code>/arch/arm64/kernel/setup.c</code>”文件中，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 初始化设置机器的设备树</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> __init <span class="token function">setup_machine_fdt</span><span class="token punctuation">(</span><span class="token class-name">phys_addr_t</span> dt_phys<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> size<span class="token punctuation">;</span>
    <span class="token comment">// 将设备树物理地址映射到内核虚拟地址空间</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>dt_virt <span class="token operator">=</span> <span class="token function">fixmap_remap_fdt</span><span class="token punctuation">(</span>dt_phys<span class="token punctuation">,</span> <span class="token operator">&amp;</span>size<span class="token punctuation">,</span> PAGE_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
    
    <span class="token comment">// 如果映射成功</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dt_virt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 保留设备树占用的内存区域</span>
        <span class="token function">memblock_reserve</span><span class="token punctuation">(</span>dt_phys<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 如果设备树映射失败或者设备树解析失败</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dt_virt <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">early_init_dt_scan</span><span class="token punctuation">(</span>dt_virt<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 输出错误信息</span>
        <span class="token function">pr_crit</span><span class="token punctuation">(</span><span class="token string">"\n"</span>
        <span class="token string">"Error: invalid device tree blob at physical address %pa (virtual address 0x%p)\n"</span>
        <span class="token string">"The dtb must be 8-byte aligned and must not exceed 2 MB in size\n"</span>
        <span class="token string">"\nPlease check your bootloader."</span><span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>dt_phys<span class="token punctuation">,</span> dt_virt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 无限循环，等待系统崩溃</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>true<span class="token punctuation">)</span>
        <span class="token function">cpu_relax</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 早期修复完成，将设备树映射为只读模式</span>
    <span class="token function">fixmap_remap_fdt</span><span class="token punctuation">(</span>dt_phys<span class="token punctuation">,</span> <span class="token operator">&amp;</span>size<span class="token punctuation">,</span> PAGE_KERNEL_RO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 获取设备树的机器名</span>
    name <span class="token operator">=</span> <span class="token function">of_flat_dt_get_machine_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 如果设备树没有机器名，则返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>name<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"Machine model: %s\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出机器型号信息</span>
        <span class="token function">dump_stack_set_arch_desc</span><span class="token punctuation">(</span><span class="token string">"%s (DT)"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置栈转储的架构描述为机器型号</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>此函数用于在内核启动过程中设置机器的设备树。在此函数中，将执行以下步骤：</p>
<ul>
<li>1.使用fixmap_remap_fdt() 将设备树映射到内核虚拟地址空间中的fixmap 区域。</li>
<li>2.如果映射成功，则使用memblock_reserve() 保留设备树占用的物理内存区域。</li>
<li>3.检查设备树的有效性和完整性，通过调用early_init_dt_scan()进行早期扫描。如果设备树无效或扫描失败，则会输出错误信息并进入死循环。</li>
<li>4.早期修复已完成，现在将设备树映射为只读，通过调用fixmap_remap_fdt() 实现。</li>
<li>5.获取设备树中的机器模型名称，通过调用of_flat_dt_get_machine_name()。</li>
<li>6.如果机器模型名称存在，则输出机器模型的信息，并通过dump_stack_set_arch_desc()设置堆栈描述信息。</li>
</ul>
<p>其中上面的第3 步调用的early_init_dt_scan() 需要详细的讲解一下，该函数定义在内核源码的“drivers/of/fdt.c”目录下，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">bool __init <span class="token function">early_init_dt_scan</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>params<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    bool status<span class="token punctuation">;</span>
    
    <span class="token comment">// 验证设备树的兼容性和完整性</span>
    status <span class="token operator">=</span> <span class="token function">early_init_dt_verify</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>status<span class="token punctuation">)</span>
        <span class="token keyword">return</span> false<span class="token punctuation">;</span>
    
    <span class="token comment">// 扫描设备树节点</span>
    <span class="token function">early_init_dt_scan_nodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> true<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>首先，调用<code>early_init_dt_verify()</code> 函数对设备树进行兼容性和完整性验证。该函数可能会检查设备树中的一致性标记、版本信息以及必需的节点和属性是否存在。如果验证失败，函数会返回false。该函数的具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">bool __init <span class="token function">early_init_dt_verify</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>params<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 验证传入的参数是否为空</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>params<span class="token punctuation">)</span>
        <span class="token keyword">return</span> false<span class="token punctuation">;</span>
    
    <span class="token comment">// 检查设备树头部的有效性</span>
    <span class="token comment">// 如果设备树头部无效，返回false</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fdt_check_header</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> false<span class="token punctuation">;</span>
    
    <span class="token comment">// 设置指向设备树的指针为传入的参数</span>
    initial_boot_params <span class="token operator">=</span> params<span class="token punctuation">;</span>
    
    <span class="token comment">// 计算设备树的CRC32 校验值</span>
    <span class="token comment">// 并将结果保存在全局变量of_fdt_crc32 中</span>
    of_fdt_crc32 <span class="token operator">=</span> <span class="token function">crc32_be</span><span class="token punctuation">(</span><span class="token operator">~</span><span class="token number">0</span><span class="token punctuation">,</span> initial_boot_params<span class="token punctuation">,</span> <span class="token function">fdt_totalsize</span><span class="token punctuation">(</span>initial_boot_params<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 返回true，表示设备树验证和初始化成功</span>
    <span class="token keyword">return</span> true<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第4 行：该进行参数的有效性检查，如果params 为空，则直接返回false，表示参数无效。<br>第9 行：检查设备树头部的有效性。fdt_check_header 是一个用于检查设备树头部的函数，如果设备树头部无效，则返回false，表示设备树不合法。<br>第13 行：如果设备树头部有效，程序继续执行，将传入的params 赋值给全局变量initial_boot_params，用来保存设备树的指针。<br>第17 行，使用crc32_be 函数计算设备树的CRC32 校验值，其中crc32_be 是一个用于计算CRC32 校验值的函数，~0 表示初始值为全1 的位模式。计算完成后，将结果保存在全局变量of_fdt_crc32 中。</p>
<p>然后继续回到early_init_dt_scan() 函数中，如果设备树验证成功（即status 为真），则调用early_init_dt_scan_nodes() 函数。这个函数的作用是扫描设备树的节点并进行相应的处理，该函数的具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> __init <span class="token function">early_init_dt_scan_nodes</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">/* 从/chosen 节点中检索各种信息*/</span>
    <span class="token function">of_scan_flat_dt</span><span class="token punctuation">(</span>early_init_dt_scan_chosen<span class="token punctuation">,</span> boot_command_line<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* 初始化{size,address}-cells 信息*/</span>
    <span class="token function">of_scan_flat_dt</span><span class="token punctuation">(</span>early_init_dt_scan_root<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* 设置内存信息，调用early_init_dt_add_memory_arch 函数*/</span>
    <span class="token function">of_scan_flat_dt</span><span class="token punctuation">(</span>early_init_dt_scan_memory<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>函数<code>early_init_dt_scan_nodes</code> 被声明为<code>__init</code>，这表示它是在内核初始化阶段被调用，并且在初始化完成后不再需要。该函数的目的是在早期阶段扫描设备树节点，并执行一些初始化操作。</p>
<p>函数中主要调用了<code>of_scan_flat_dt</code> 函数，该函数用于扫描平面设备树（flat device tree）。平面设备树是一种将设备树以紧凑形式表示的数据结构，它不使用树状结构，而是使用线性结构，以节省内存空间。</p>
<p>具体来看，<code>early_init_dt_scan_nodes</code> 函数的执行步骤如下：<br>（1）**<code>of_scan_flat_dt(early_init_dt_scan_chosen, boot_command_line)</code>**：从设备树的/chosen节点中检索各种信息。/chosen 节点通常包含了一些系统的全局配置参数，比如命令行参数。<code>early_init_dt_scan_chosen</code> 是一个回调函数，用于处理/chosen 节点的信息。<code>boot_command_line</code>是一个参数，表示内核启动时的命令行参数。<br>（ 2 ） <strong><code>of_scan_flat_dt(early_init_dt_scan_root, NULL)</code></strong> ： 初始化<code>{size,address}-cells</code> 信息。<br><code>{size,address}-cells</code> 描述了设备节点中地址和大小的编码方式。<code>early_init_dt_scan_root</code> 是一个回调函数，用于处理设备树的根节点。<br>（ 3 ） <strong><code>of_scan_flat_dt(early_init_dt_scan_memory, NULL)</code></strong> ： 设置内存信息， 并调用<code>early_init_dt_add_memory_arch</code> 函数。这个步骤主要用于在设备树中获取内存的相关信息，并将其传递给内核的内存管理模块。<code>early_init_dt_scan_memory</code> 是一个回调函数，用于处理内存信息。</p>
<p>至此，关于<code>setup_machine_fdt(__fdt_pointer)</code>代码的分析就完成了。</p>
<h4 id="63-2-2-unflatten-device-tree"><a href="#63-2-2-unflatten-device-tree" class="headerlink" title="63.2.2 unflatten_device_tree"></a>63.2.2 <code>unflatten_device_tree</code></h4><p>该函数用于解析设备树，将紧凑的设备树数据结构转换为树状结构的设备树，该函数定义在内核源码目录下的“/drivers/of/fdt.c”文件中，具体内容如下所示：</p>
<pre class="line-numbers language-none"><code class="language-none">void __init unflatten_device_tree(void)
{
/* 解析设备树*/
__unflatten_device_tree(initial_boot_params, NULL, &amp;of_root,
early_init_dt_alloc_memory_arch, false);
/* 获取指向"/chosen" 和"/aliases" 节点的指针，以供全局使用*/
of_alias_scan(early_init_dt_alloc_memory_arch);
/* 运行设备树的单元测试*/
unittest_unflatten_overlay_base();
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该函数主要用于解析设备树，并将解析后的设备树存储在全局变量of_root 中。函数首先调用<code>__unflatten_device_tree</code> 函数来执行设备树的解析操作。解析后的设备树将使用<code>of_root</code> 指针进行存储。</p>
<p>接下来，函数调用<code>of_alias_scan</code> 函数。这个函数用于扫描设备树中的/chosen 和/aliases 节点，并为它们分配内存。这样，其他部分的代码可以通过全局变量访问这些节点。</p>
<p>最后，函数调用<code>unittest_unflatten_overlay_base</code> 函数，用于运行设备树的单元测试。然后对<code>__unflatten_device_tree</code> 这一设备树的解析函数进行详细的介绍，该函数的具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">__unflatten_device_tree</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>blob<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>dad<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span><span class="token operator">*</span>mynodes<span class="token punctuation">,</span>
                              <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>dt_alloc<span class="token punctuation">)</span><span class="token punctuation">(</span>u64 size<span class="token punctuation">,</span> u64 align<span class="token punctuation">)</span><span class="token punctuation">,</span>bool detached<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> size<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>mem<span class="token punctuation">;</span>
    
    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">" -&gt; unflatten_device_tree()\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>blob<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"No device tree pointer\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"Unflattening device tree:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"magic: %08x\n"</span><span class="token punctuation">,</span> <span class="token function">fdt_magic</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"size: %08x\n"</span><span class="token punctuation">,</span> <span class="token function">fdt_totalsize</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"version: %08x\n"</span><span class="token punctuation">,</span> <span class="token function">fdt_version</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fdt_check_header</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"Invalid device tree blob header\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/* 第一遍扫描，计算大小*/</span>
    size <span class="token operator">=</span> <span class="token function">unflatten_dt_nodes</span><span class="token punctuation">(</span>blob<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> dad<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    
    size <span class="token operator">=</span> <span class="token function">ALIGN</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">" 大小为%d，正在分配内存...\n"</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* 为展开的设备树分配内存*/</span>
    mem <span class="token operator">=</span> <span class="token function">dt_alloc</span><span class="token punctuation">(</span>size <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token function">alignof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mem<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    
    <span class="token function">memset</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>__be32 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>mem <span class="token operator">+</span> size<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">cpu_to_be32</span><span class="token punctuation">(</span><span class="token number">0xdeadbeef</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">" 正在展开%p...\n"</span><span class="token punctuation">,</span> mem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* 第二遍扫描，实际展开设备树*/</span>
    <span class="token function">unflatten_dt_nodes</span><span class="token punctuation">(</span>blob<span class="token punctuation">,</span> mem<span class="token punctuation">,</span> dad<span class="token punctuation">,</span> mynodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">be32_to_cpup</span><span class="token punctuation">(</span>mem <span class="token operator">+</span> size<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0xdeadbeef</span><span class="token punctuation">)</span>
        <span class="token function">pr_warning</span><span class="token punctuation">(</span><span class="token string">"End of tree marker overwritten: %08x\n"</span><span class="token punctuation">,</span> <span class="token function">be32_to_cpup</span><span class="token punctuation">(</span>mem <span class="token operator">+</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>detached <span class="token operator">&amp;&amp;</span> mynodes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">of_node_set_flag</span><span class="token punctuation">(</span><span class="token operator">*</span>mynodes<span class="token punctuation">,</span> OF_DETACHED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"unflattened tree is detached\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">" &lt;- unflatten_device_tree()\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> mem<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该函数的重点在两次设备树的扫描上，第一遍扫描的目的是计算展开设备树所需的内存大小。</p>
<p>第29 行：<code>unflatten_dt_nodes</code> 函数的作用是递归地遍历设备树数据块，并计算展开设备树所需的内存大小。它接受四个参数：blob（设备树数据块指针）、start（当前节点的起始地址，初始为NULL）、dad（父节点指针）和mynodes（用于存储节点指针数组的指针，初始为NULL）。第一遍扫描完成后，<code>unflatten_dt_nodes</code> 函数会返回展开设备树所需的内存大小，然后在对大小进行对齐操作，并为展开的设备树分配内存。</p>
<p>第二遍扫描的目的是实际展开设备树，并填充设备节点的名称、类型和属性等信息。</p>
<p>第49 行：再次调用了<code>unflatten_dt_nodes</code> 函数进行第二遍扫描。通过这样的过程，第二遍扫描会将设备树数据块中的节点展开为真正的设备节点，并填充节点的名称、类型和属性等信息。这样就完成了设备树的展开过程。</p>
<p>最后我们来对<code>unflatten_dt_nodes</code> 函数内容进行一下深究，<code>unflatten_dt_nodes</code> 函数具体定义如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">unflatten_dt_nodes</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>blob<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>mem<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>dad<span class="token punctuation">,</span>
                              <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span><span class="token operator">*</span>nodepp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>root<span class="token punctuation">;</span> <span class="token comment">// 根节点</span>
    <span class="token keyword">int</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> depth <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> initial_depth <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 偏移量、深度和初始深度</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FDT_MAX_DEPTH64</span> <span class="token comment">// 最大深度</span></span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>nps<span class="token punctuation">[</span>FDT_MAX_DEPTH<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 设备节点数组</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>base <span class="token operator">=</span> mem<span class="token punctuation">;</span> <span class="token comment">// 基地址，用于计算偏移量</span>
    bool dryrun <span class="token operator">=</span> <span class="token operator">!</span>base<span class="token punctuation">;</span> <span class="token comment">// 是否只是模拟运行，不实际处理</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nodepp<span class="token punctuation">)</span>
        <span class="token operator">*</span>nodepp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">// 如果指针不为空，将其置为空指针</span>
    
    <span class="token comment">/*
    * 如果@dad 有效，则表示正在展开设备子树。
    * 在第一层深度可能有多个节点。
    * 将@depth 设置为1，以使fdt_next_node() 正常工作。
    * 当发现负的@depth 时，该函数会立即退出。
    * 否则，除第一个节点外的设备节点将无法成功展开。
    */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dad<span class="token punctuation">)</span>
        depth <span class="token operator">=</span> initial_depth <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    
    root <span class="token operator">=</span> dad<span class="token punctuation">;</span> <span class="token comment">// 根节点为@dad</span>
    nps<span class="token punctuation">[</span>depth<span class="token punctuation">]</span> <span class="token operator">=</span> dad<span class="token punctuation">;</span> <span class="token comment">// 将根节点放入设备节点数组</span>
    
    <span class="token keyword">for</span> <span class="token punctuation">(</span>offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> offset <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> depth <span class="token operator">&gt;=</span> initial_depth<span class="token punctuation">;</span>
         offset <span class="token operator">=</span> <span class="token function">fdt_next_node</span><span class="token punctuation">(</span>blob<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> <span class="token operator">&amp;</span>depth<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WARN_ON_ONCE</span><span class="token punctuation">(</span>depth <span class="token operator">&gt;=</span> FDT_MAX_DEPTH<span class="token punctuation">)</span><span class="token punctuation">)</span>
        	<span class="token keyword">continue</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 如果未启用CONFIG_OF_KOBJ 并且节点不可用，则跳过该节点</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">IS_ENABLED</span><span class="token punctuation">(</span>CONFIG_OF_KOBJ<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span><span class="token operator">!</span><span class="token function">of_fdt_device_is_available</span><span class="token punctuation">(</span>blob<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">)</span>
        	<span class="token keyword">continue</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 填充节点信息，并将子节点添加到设备节点数组</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">populate_node</span><span class="token punctuation">(</span>blob<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mem<span class="token punctuation">,</span> nps<span class="token punctuation">[</span>depth<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>nps<span class="token punctuation">[</span>depth<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dryrun<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> mem <span class="token operator">-</span> base<span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dryrun <span class="token operator">&amp;&amp;</span> nodepp <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token operator">*</span>nodepp<span class="token punctuation">)</span>
            <span class="token operator">*</span>nodepp <span class="token operator">=</span> nps<span class="token punctuation">[</span>depth<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 将子节点指针赋值给@nodepp</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dryrun <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>root<span class="token punctuation">)</span>
            root <span class="token operator">=</span> nps<span class="token punctuation">[</span>depth<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 如果根节点为空，则将子节点设置为根节点</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> offset <span class="token operator">!=</span> <span class="token operator">-</span>FDT_ERR_NOTFOUND<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"Error %d processing FDT\n"</span><span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 反转子节点列表。一些驱动程序假设节点顺序与.dts 文件中的节点顺序一致</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dryrun<span class="token punctuation">)</span>
        <span class="token function">reverse_nodes</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> mem <span class="token operator">-</span> base<span class="token punctuation">;</span> <span class="token comment">// 返回处理的字节数</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>unflatten_dt_nodes</code> 函数的作用我们在上面已经讲解过了，这里重点介绍第31 行的<code>fdt_next_node</code>()函数和第41 行的<code>populate_node</code> 函数。<br><code>fdt_next_node()</code> 函数用来遍历设备树的节点。从偏移量为0 开始，只要偏移量大于等于0且深度大于等于初始深度，就执行循环。循环中的每次迭代都会处理一个设备树节点。</p>
<p>在每次迭代中，首先检查深度是否超过了最大深度<code>FDT_MAX_DEPTH</code>，如果超过了，则跳过该节点。</p>
<p>如果未启用<code>CONFIG_OF_KOBJ</code> 并且节点不可用（通过<code>of_fdt_device_is_available()</code> 函数判断），则跳过该节点。<br>随后调用<code>populate_node()</code> 函数填充节点信息， 并将子节点添加到设备节点数组nps 中。<code>populate_node()</code> 函数定义如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> bool <span class="token function">populate_node</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>blob<span class="token punctuation">,</span> <span class="token keyword">int</span> offset<span class="token punctuation">,</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span>mem<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>dad<span class="token punctuation">,</span>
                          <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span><span class="token operator">*</span>pnp<span class="token punctuation">,</span> bool dryrun<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">;</span> <span class="token comment">// 设备节点指针</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathp<span class="token punctuation">;</span> <span class="token comment">// 节点路径字符串指针</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> l<span class="token punctuation">,</span> allocl<span class="token punctuation">;</span> <span class="token comment">// 路径字符串长度和分配的内存大小</span>
    
    pathp <span class="token operator">=</span> <span class="token function">fdt_get_name</span><span class="token punctuation">(</span>blob<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> <span class="token operator">&amp;</span>l<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取节点路径和长度    </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pathp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>pnp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> false<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    allocl <span class="token operator">=</span> <span class="token operator">++</span>l<span class="token punctuation">;</span> <span class="token comment">// 分配内存大小为路径长度加一，用于存储节点路径字符串</span>
    
    np <span class="token operator">=</span> <span class="token function">unflatten_dt_alloc</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span><span class="token punctuation">)</span> <span class="token operator">+</span> allocl<span class="token punctuation">,</span>
                            <span class="token function">__alignof__</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 分配设备节点内存</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dryrun<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>fn<span class="token punctuation">;</span>
        <span class="token function">of_node_init</span><span class="token punctuation">(</span>np<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化设备节点</span>
        np<span class="token operator">-&gt;</span>full_name <span class="token operator">=</span> fn <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>np<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>np<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置设备节点的完整路径名</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> pathp<span class="token punctuation">,</span> l<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将节点路径字符串复制到设备节点的完整路径名中</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dad <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            np<span class="token operator">-&gt;</span>parent <span class="token operator">=</span> dad<span class="token punctuation">;</span> <span class="token comment">// 设置设备节点的父节点</span>
            np<span class="token operator">-&gt;</span>sibling <span class="token operator">=</span> dad<span class="token operator">-&gt;</span>child<span class="token punctuation">;</span> <span class="token comment">// 设置设备节点的兄弟节点</span>
            dad<span class="token operator">-&gt;</span>child <span class="token operator">=</span> np<span class="token punctuation">;</span> <span class="token comment">// 将设备节点添加为父节点的子节点</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token function">populate_properties</span><span class="token punctuation">(</span>blob<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> mem<span class="token punctuation">,</span> np<span class="token punctuation">,</span> pathp<span class="token punctuation">,</span> dryrun<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 填充设备节点的属性信息</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dryrun<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        np<span class="token operator">-&gt;</span>name <span class="token operator">=</span> <span class="token function">of_get_property</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取设备节点的名称属性</span>
        np<span class="token operator">-&gt;</span>type <span class="token operator">=</span> <span class="token function">of_get_property</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> <span class="token string">"device_type"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取设备节点的设备类型属性</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>np<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span>
            np<span class="token operator">-&gt;</span>name <span class="token operator">=</span> <span class="token string">"&lt;NULL&gt;"</span><span class="token punctuation">;</span> <span class="token comment">// 如果设备节点没有名称属性，则设置为"&lt;NULL&gt;"</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>np<span class="token operator">-&gt;</span>type<span class="token punctuation">)</span>
            np<span class="token operator">-&gt;</span>type <span class="token operator">=</span> <span class="token string">"&lt;NULL&gt;"</span><span class="token punctuation">;</span> <span class="token comment">// 如果设备节点没有设备类型属性，则设置为"&lt;NULL&gt;"</span>
    <span class="token punctuation">}</span>
    
    <span class="token operator">*</span>pnp <span class="token operator">=</span> np<span class="token punctuation">;</span> <span class="token comment">// 将设备节点指针赋值给*pnp</span>
    <span class="token keyword">return</span> true<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在<code>populate_node</code> 函数中首先会调用第18 行的<code>unflatten_dt_alloc</code> 函数分配设备节点内存。分配的内存大小为<code>sizeof(struct device_node) + allocl</code> 字节， 并使用<code>__alignof__(structdevice_node)</code> 对齐。然后调用<code>populate_properties</code> 函数填充设备节点的属性信息。该函数会解析设备节点的属性，并根据需要分配内存来存储属性值。</p>
<p>至此，关于dtb 二进制文件的解析过程就讲解完成了，完整的源码分析流程图如下（图63-2）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408271527034.png" alt="image-20240827152705940"></p>
<h2 id="第64-章device-node-转换成platform-device-实验"><a href="#第64-章device-node-转换成platform-device-实验" class="headerlink" title="第64 章device_node 转换成platform_device 实验"></a>第64 章<code>device_node</code> 转换成<code>platform_device</code> 实验</h2><p>在上一章中，我们学习了dtb 二进制文件展开成<code>device_node</code> 的具体流程，而<code>device_node</code>这时候还并不能跟内核中的<code>platform_driver</code> 进行对接，而为了让操作系统能够识别和管理设备，需要将设备节点转换为平台设备。</p>
<h3 id="64-1-转换规则"><a href="#64-1-转换规则" class="headerlink" title="64.1 转换规则"></a>64.1 转换规则</h3><p>在之前学习的平台总线模型中，<code>device</code> 部分是用<code>platform_device</code> 结构体来描述硬件资源的，所以内核最终会将内核认识的<code>device_node</code> 树转换<code>platform_ device</code>，但是并不是所有的<code>device_node</code> 都会被转换成<code>platform_ device</code>，只有满足要求的才会转换成<code>platform_ device</code>,转换成platform_device 的节点可以在/sys/bus/platform/devices 下查看，那device_node 节点要满足什么要求才会被转换成platform_device 呢?</p>
<ul>
<li>根据规则1，首先遍历根节点下包含<code>compatible</code> 属性的子节点，对于每个子节点，创建一个对应的<code>platform_device</code>。</li>
<li>根据规则2，遍历包含<code>compatible</code> 属性为”<code>simple-bus</code>“、”<code>simple-mfd</code>“ 或”<code>isa</code>“ 的节点以及它们的子节点。如果子节点包含<code>compatible</code> 属性值则会创建一个对应的<code>platform_device</code>。</li>
<li>根据规则3，检查节点的<code>compatible</code> 属性是否包含”<code>arm</code>“ 或”<code>primecell</code>“。如果是，则不将该节点转换为<code>platform_device</code>，而是将其识别为AMBA 设备。</li>
</ul>
<p>接下来将通过几个设备树示例对上述规则进行实践。</p>
<p><strong>举例1：</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token operator">/</span>dts<span class="token operator">-</span>v1<span class="token operator">/</span><span class="token punctuation">;</span>
<span class="token operator">/</span> <span class="token punctuation">{</span>
    model <span class="token operator">=</span> <span class="token string">"This is my devicetree!"</span><span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    chosen <span class="token punctuation">{</span>
        bootargs <span class="token operator">=</span> <span class="token string">"root=/dev/nfs rw nfsroot=192.168.1.1 console=ttyS0, 115200"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    cpu1<span class="token operator">:</span> cpu@<span class="token number">1</span> <span class="token punctuation">{</span>
        device_type <span class="token operator">=</span> <span class="token string">"cpu"</span><span class="token punctuation">;</span>
        compatible <span class="token operator">=</span> <span class="token string">"arm,cortex-a35"</span><span class="token punctuation">,</span> <span class="token string">"arm,armv8"</span><span class="token punctuation">;</span>
        reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x0</span> <span class="token number">0x1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    aliases <span class="token punctuation">{</span>
        led1 <span class="token operator">=</span> <span class="token string">"/gpio@22020101"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    node1 <span class="token punctuation">{</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
        gpio@<span class="token number">22020102</span> <span class="token punctuation">{</span>
            reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x20220102</span> <span class="token number">0x40</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    node2 <span class="token punctuation">{</span>
        node1<span class="token operator">-</span>child <span class="token punctuation">{</span>
            pinnum <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">01234</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    gpio@<span class="token number">22020101</span> <span class="token punctuation">{</span>
        compatible <span class="token operator">=</span> <span class="token string">"led"</span><span class="token punctuation">;</span>
        reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x20220101</span> <span class="token number">0x40</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在上面的设备树中，总共有<code>chosen</code>、<code>cpu1: cpu@1</code>、<code>aliases</code>、<code>node1</code>、<code>node2</code>、<code>gpio@22020101</code>这六个节点，其中前五个节点都没有<code>compatible</code> 属性，所以并不会被转换为<code>platform_device</code>，而最后一个<code>gpio@22020101</code> 节点符合规则一，在根节点下，且有<code>compatible</code> 属性，所以最后会转换为<code>platform_device</code>。</p>
<p><strong>举例2：</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token operator">/</span>dts<span class="token operator">-</span>v1<span class="token operator">/</span><span class="token punctuation">;</span>
<span class="token operator">/</span> <span class="token punctuation">{</span>
    model <span class="token operator">=</span> <span class="token string">"This is my devicetree!"</span><span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    
    chosen <span class="token punctuation">{</span>
        bootargs <span class="token operator">=</span> <span class="token string">"root=/dev/nfs rw nfsroot=192.168.1.1 console=ttyS0, 115200"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    cpu1<span class="token operator">:</span> cpu@<span class="token number">1</span> <span class="token punctuation">{</span>
        device_type <span class="token operator">=</span> <span class="token string">"cpu"</span><span class="token punctuation">;</span>
        compatible <span class="token operator">=</span> <span class="token string">"arm,cortex-a35"</span><span class="token punctuation">,</span> <span class="token string">"arm,armv8"</span><span class="token punctuation">;</span>
        reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x0</span> <span class="token number">0x1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    aliases <span class="token punctuation">{</span>
        led1 <span class="token operator">=</span> <span class="token string">"/gpio@22020101"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    node1 <span class="token punctuation">{</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
        compatible <span class="token operator">=</span> <span class="token string">"simple-bus"</span><span class="token punctuation">;</span>
        gpio@<span class="token number">22020102</span> <span class="token punctuation">{</span>
            reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x20220102</span> <span class="token number">0x40</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    node2 <span class="token punctuation">{</span>
        node1<span class="token operator">-</span>child <span class="token punctuation">{</span>
            pinnum <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">01234</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    gpio@<span class="token number">22020101</span> <span class="token punctuation">{</span>
        compatible <span class="token operator">=</span> <span class="token string">"led"</span><span class="token punctuation">;</span>
        reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x20220101</span> <span class="token number">0x40</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>相较于示例1 的设备树，这里在node1 节点中添加了<code>compatible</code> 属性，但是这个<code>compatible</code> 属性值为<code>simple-bus</code>，我们需要继续看他的子节点，子节点<code>gpio@22020102</code> 并没有<code>compatible</code> 属性值，所以这里的node1 节点不会被转换。</p>
<p><strong>举例3：</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token operator">/</span>dts<span class="token operator">-</span>v1<span class="token operator">/</span><span class="token punctuation">;</span>
<span class="token operator">/</span> <span class="token punctuation">{</span>
    model <span class="token operator">=</span> <span class="token string">"This is my devicetree!"</span><span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    chosen <span class="token punctuation">{</span>
    	bootargs <span class="token operator">=</span> <span class="token string">"root=/dev/nfs rw nfsroot=192.168.1.1 console=ttyS0, 115200"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    cpu1<span class="token operator">:</span> cpu@<span class="token number">1</span> <span class="token punctuation">{</span>
        device_type <span class="token operator">=</span> <span class="token string">"cpu"</span><span class="token punctuation">;</span>
        compatible <span class="token operator">=</span> <span class="token string">"arm,cortex-a35"</span><span class="token punctuation">,</span> <span class="token string">"arm,armv8"</span><span class="token punctuation">;</span>
        reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x0</span> <span class="token number">0x1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    aliases <span class="token punctuation">{</span>
        led1 <span class="token operator">=</span> <span class="token string">"/gpio@22020101"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    node1 <span class="token punctuation">{</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
        compatible <span class="token operator">=</span> <span class="token string">"simple-bus"</span><span class="token punctuation">;</span>
        gpio@<span class="token number">22020102</span> <span class="token punctuation">{</span>
            compatible <span class="token operator">=</span> <span class="token string">"gpio"</span><span class="token punctuation">;</span>
            reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x20220102</span> <span class="token number">0x40</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    node2 <span class="token punctuation">{</span>
        node1<span class="token operator">-</span>child <span class="token punctuation">{</span>
            pinnum <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">01234</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    	<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    gpio@<span class="token number">22020101</span> <span class="token punctuation">{</span>
        compatible <span class="token operator">=</span> <span class="token string">"led"</span><span class="token punctuation">;</span>
        reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x20220101</span> <span class="token number">0x40</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>相较于示例2 的设备树，这里在node1 节点的子节点<code>gpio@22020102</code> 中添加了<code>compatible</code> 属性，node1 节点的<code>compatible</code> 属性值为<code>simple-bus</code>，然后需要继续看他的子节点，子节点<code>gpio@22020102</code> 的<code>compatible</code> 属性值为gpio，所以这里的<code>gpio@22020102</code> 节点会被转换成<code>platform_device</code>。</p>
<p><strong>举例4：</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token operator">/</span>dts<span class="token operator">-</span>v1<span class="token operator">/</span><span class="token punctuation">;</span>
<span class="token operator">/</span> <span class="token punctuation">{</span>
    model <span class="token operator">=</span> <span class="token string">"This is my devicetree!"</span><span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    
    chosen <span class="token punctuation">{</span>
        bootargs <span class="token operator">=</span> <span class="token string">"root=/dev/nfs rw nfsroot=192.168.1.1 console=ttyS0,115200"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    cpul<span class="token operator">:</span> cpu@<span class="token number">1</span> <span class="token punctuation">{</span>
        device_type <span class="token operator">=</span> <span class="token string">"cpu"</span><span class="token punctuation">;</span>
        compatible <span class="token operator">=</span> <span class="token string">"arm,cortex-a35"</span><span class="token punctuation">,</span> <span class="token string">"arm,armv8"</span><span class="token punctuation">;</span>
        reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x0</span> <span class="token number">0x1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        amba <span class="token punctuation">{</span>
            compatible <span class="token operator">=</span> <span class="token string">"simple-bus"</span><span class="token punctuation">;</span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
            ranges<span class="token punctuation">;</span>
            dmac_peri<span class="token operator">:</span> dma<span class="token operator">-</span>controller@ff250000 <span class="token punctuation">{</span>
                compatible <span class="token operator">=</span> <span class="token string">"arm,p1330"</span><span class="token punctuation">,</span> <span class="token string">"arm,primecell"</span><span class="token punctuation">;</span>
                reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x0</span> <span class="token number">0xff250000</span> <span class="token number">0x0</span> <span class="token number">0x4000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
                interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span>GIC_SPI <span class="token number">2</span> IRQ_TYPE_LEVEL_HIGH<span class="token operator">&gt;</span><span class="token punctuation">,</span>
                <span class="token operator">&lt;</span>GIC_SPI <span class="token number">3</span> IRQ_TYPE_LEVEL_HIGH<span class="token operator">&gt;</span><span class="token punctuation">;</span>
                <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">dma</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
                arm<span class="token punctuation">,</span>pl330<span class="token operator">-</span>broken<span class="token operator">-</span>no<span class="token operator">-</span>flushp<span class="token punctuation">;</span>
                arm<span class="token punctuation">,</span>p1330<span class="token operator">-</span>periph<span class="token operator">-</span>burst<span class="token punctuation">;</span>
                clocks <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>cru ACLK DMAC_PERI<span class="token operator">&gt;</span><span class="token punctuation">;</span>
                clock<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"apb_pclk"</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            dmac_bus<span class="token operator">:</span> dma<span class="token operator">-</span>controller@ff600000 <span class="token punctuation">{</span>
                compatible <span class="token operator">=</span> <span class="token string">"arm,p1330"</span><span class="token punctuation">,</span> <span class="token string">"arm,primecell"</span><span class="token punctuation">;</span>
                reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x0</span> <span class="token number">0xff600000</span> <span class="token number">0x0</span> <span class="token number">0x4000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
                interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span>GIC_SPI <span class="token number">0</span> IRQ_TYPE_LEVEL_HIGH<span class="token operator">&gt;</span><span class="token punctuation">,</span>
                <span class="token operator">&lt;</span>GIC_SPI <span class="token number">1</span> IRQ_TYPE_LEVEL_HIGH<span class="token operator">&gt;</span><span class="token punctuation">;</span>
                <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">dma</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
                arm<span class="token punctuation">,</span>pl330<span class="token operator">-</span>broken<span class="token operator">-</span>no<span class="token operator">-</span>flushp<span class="token punctuation">;</span>
                arm<span class="token punctuation">,</span>pl330<span class="token operator">-</span>periph<span class="token operator">-</span>burst<span class="token punctuation">;</span>
                clocks <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>cru ACLK_DMAC_BUS<span class="token operator">&gt;</span><span class="token punctuation">;</span>
                clock<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"apb_pclk"</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>amba</code> 节点的<code>compatible</code> 值为<code>simple-bus</code>，不会被转换为<code>platform_device</code>，而是作为父节点用于组织其他设备，所以需要来查看他的子节点。</p>
<p><code>dmac_peri: dma-controller@ff250000</code> 节点: 该节点的<code>compatible</code> 属性包含”<code>arm,p1330</code>“和”<code>arm,primecell</code>“，根据规则3，该节点不会被转换为<code>platform_device</code>，而是被识别为<code>AMBA</code>设备。</p>
<p>dmac_bus: dma-controller@ff600000 节点: 该节点的compatible 属性包含”arm,p1330” 和”arm,primecell”，根据规则3，该节点不会被转换为platform_device，而是被识别为AMBA 设备。</p>
<h3 id="64-2-转换流程源码分析"><a href="#64-2-转换流程源码分析" class="headerlink" title="64.2 转换流程源码分析"></a>64.2 转换流程源码分析</h3><p>首先进入到内核源码目录下的“<code>drivers/of/platform.c</code>”文件中，找到第555 行，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">arch_initcall_sync</span><span class="token punctuation">(</span>of_platform_default_populate_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><code>arch_initcall_sync</code> 是Linux 内核中的一个函数，用于在内核初始化过程中执行架构相关的初始化函数。它属于内核的初始化调用机制，用于确保在系统启动过程中适时地调用特定架构的初始化函数。</p>
<p>在Linux 内核的初始化过程中，各个子系统和架构会注册自己的初始化函数。这些初始化函数负责完成特定子系统或架构相关的初始化工作，例如初始化硬件设备、注册中断处理程序、设置内存映射等。而arch_initcall_sync 函数则用于调用与当前架构相关的初始化函数。</p>
<p>当内核启动时， 调用<code>rest_init()</code> 函数来启动初始化过程。在初始化过程中，<code>arch_initcall_sync</code> 函数会被调用，以确保所有与当前架构相关的初始化函数按照正确的顺序执行。这样可以保证在启动过程中，特定架构相关的初始化工作得到正确地完成。</p>
<p>而<code>of_platform_default_populate_init</code> 函数的作用是在内核初始化过程中自动解析设备树，并根据设备树中的设备节点创建对应的<code>platform_device</code> 结构。它会遍历设备树中的设备节点，并为每个设备节点创建一个对应的<code>platform_device</code> 结构，然后将其注册到内核中，使得设备驱动程序能够识别和操作这些设备。该函数的具体内容如下所示：</p>
<ul>
<li>```c<br>static int __init of_platform_default_populate_init(void)<br>{<br>struct device_node <em>node;<br>// 暂停设备链接供应商同步状态<br>device_links_supplier_sync_state_pause();<br><br>// 如果设备树尚未填充，则返回错误码<br>if (!of_have_populated_dt())<br>    return -ENODEV;<br>/</em><br>* 显式处理某些兼容性，因为我们不想为/reserved-memory 中的每个具有“compatible”的节点创建<br>platform_device。<br>*/<br>for_each_matching_node(node, reserved_mem_matches)<br>    of_platform_device_create(node, NULL, NULL);<br><br>// 查找节点”/firmware”<br>node = of_find_node_by_path(“/firmware”);<br>if (node) {<br>    // 使用该节点进行设备树平台设备的填充<br>    of_platform_populate(node, NULL, NULL, NULL);<br>    of_node_put(node);<br>}<br><br>// 填充其他设备<br>fw_devlink_pause();<br>of_platform_default_populate(NULL, NULL, NULL);<br>fw_devlink_resume();<br><br>return 0;<br>}<pre class="line-numbers language-none"><code class="language-none">
- 第6 行：暂停设备链接供应商的同步状态，确保设备链接的状态不会在此过程中被改变。
- 第9 行：检查设备树是否已经被填充。如果设备树尚未填充，则返回错误码-ENODEV。
- 第16 行：遍历设备树中与reserved_mem_matches 匹配的节点。这些节点是/reserved-memory 中具有"compatible" 属性的节点。
- 第17 行：为/reserved-memory 中匹配的节点创建platform_device 结构。这些节点不会为每个节点都创建platform_device，而是根据需要进行显式处理。
- 第20 行：在设备树中查找路径为"/firmware" 的节点。
- 第23 行：使用找到的节点填充设备树中的平台设备。这些节点可能包含与固件相关的设备。
- 第28 行：暂停固件设备链接，确保在填充其他设备时链接状态不会改变。
- 第29 行：填充设备树中的其他设备。
- 第30 行：恢复固件设备链接。
- 上诉内容中我们要着重关注的是第29 行的`of_platform_default_populate(NULL, NULL, NULL)`函数，找到该函数的定义之后如下所示：

```c
int of_platform_default_populate(struct device_node *root,const struct of_dev_auxdata *lookup,
                                 struct device *parent)
{
    return of_platform_populate(root, of_default_bus_match_table, lookup, parent);
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<p>该函数的作用是调用<code>of_platform_populate</code> 函数来填充设备树中的平台设备，并使用默认的设备匹配表<code>of_default_bus_match_table</code>，设备匹配表内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> of_default_bus_match_table<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">{</span> <span class="token punctuation">.</span>compatible <span class="token operator">=</span> <span class="token string">"simple-bus"</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token punctuation">.</span>compatible <span class="token operator">=</span> <span class="token string">"simple-mfd"</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token punctuation">.</span>compatible <span class="token operator">=</span> <span class="token string">"isa"</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_ARM_AMBA</span></span>
        <span class="token punctuation">{</span> <span class="token punctuation">.</span>compatible <span class="token operator">=</span> <span class="token string">"arm,amba-bus"</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* CONFIG_ARM_AMBA */</span></span>
    
    <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">/* Empty terminated list */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上述的设备匹配表就是我们在第一小节中第2 条规则，，函数将自动根据设备树节点的属性匹配相应的设备驱动程序，并填充内核的平台设备列表。接下来找到of_platform_populate函数的定义，该函数的具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">of_platform_populate</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>root<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> <span class="token operator">*</span>matches<span class="token punctuation">,</span>
                         <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_dev_auxdata</span> <span class="token operator">*</span>lookup<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>parent<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>child<span class="token punctuation">;</span>
    <span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 如果root 不为空，则增加root 节点的引用计数；否则，在设备树中根据路径查找root 节点</span>
    root <span class="token operator">=</span> root <span class="token operator">?</span> <span class="token function">of_node_get</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">of_find_node_by_path</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>root<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    
    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"%s()\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">" starting at: %pOF\n"</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 暂停设备链接供应商同步状态</span>
    <span class="token function">device_links_supplier_sync_state_pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 遍历root 节点的所有子节点</span>
    <span class="token function">for_each_child_of_node</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        
        <span class="token comment">// 创建平台设备并添加到设备树总线</span>
        rc <span class="token operator">=</span> <span class="token function">of_platform_bus_create</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> matches<span class="token punctuation">,</span> lookup<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">of_node_put</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 恢复设备链接供应商同步状态</span>
    <span class="token function">device_links_supplier_sync_state_resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 设置root 节点的OF_POPULATED_BUS 标志</span>
    <span class="token function">of_node_set_flag</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> OF_POPULATED_BUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 释放root 节点的引用计数</span>
    <span class="token function">of_node_put</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> rc<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该函数的具体执行步骤如下：</p>
<ul>
<li>第10 行：检查给定的设备树节点node 是否为有效节点。如果节点为空，函数将立即返回。</li>
<li>第21 行：遍历设备树节点的子节点，查找与平台设备相关的节点。这些节点通常具有compatible 属性，用于匹配设备驱动程序。</li>
<li>第23 行：对于每个找到的平台设备节点，创建一个platform_device 结构，并根据设备树节点的属性设置该结构的各个字段。</li>
<li>第25 行：将创建的platform_device 添加到内核的平台设备列表中，以便设备驱动程序能够识别和操作这些设备。</li>
</ul>
<p>接下来对该函数的第23 行核心代码of_platform_bus_create(child, matches, lookup, parent,true)函数进行讲解，该函数的具体定义如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">of_platform_bus_create</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>bus<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> <span class="token operator">*</span>matches<span class="token punctuation">,</span>
                         <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_dev_auxdata</span> <span class="token operator">*</span>lookup<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>parent<span class="token punctuation">,</span> bool strict<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_dev_auxdata</span> <span class="token operator">*</span>auxdata<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>child<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>dev<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>bus_id <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>platform_data <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* 确保设备节点具有compatible 属性*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>strict <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">of_get_property</span><span class="token punctuation">(</span>bus<span class="token punctuation">,</span> <span class="token string">"compatible"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"%s() - skipping %pOF, no compatible prop\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">,</span> bus<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/* 跳过不想创建设备的节点*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token function">of_match_node</span><span class="token punctuation">(</span>of_skipped_node_table<span class="token punctuation">,</span> bus<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"%s() - skipping %pOF node\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> bus<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">of_node_check_flag</span><span class="token punctuation">(</span>bus<span class="token punctuation">,</span> OF_POPULATED_BUS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"%s() - skipping %pOF, already populated\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> bus<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    auxdata <span class="token operator">=</span> <span class="token function">of_dev_lookup</span><span class="token punctuation">(</span>lookup<span class="token punctuation">,</span> bus<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>auxdata<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bus_id <span class="token operator">=</span> auxdata<span class="token operator">-&gt;</span>name<span class="token punctuation">;</span>
        platform_data <span class="token operator">=</span> auxdata<span class="token operator">-&gt;</span>platform_data<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">of_device_is_compatible</span><span class="token punctuation">(</span>bus<span class="token punctuation">,</span> <span class="token string">"arm,primecell"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/*
        * 在此处不返回错误以保持与旧设备树文件的兼容性。
        */</span>
        <span class="token function">of_amba_device_create</span><span class="token punctuation">(</span>bus<span class="token punctuation">,</span> bus_id<span class="token punctuation">,</span> platform_data<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    dev <span class="token operator">=</span> <span class="token function">of_platform_device_create_pdata</span><span class="token punctuation">(</span>bus<span class="token punctuation">,</span> bus_id<span class="token punctuation">,</span> platform_data<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dev <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">of_match_node</span><span class="token punctuation">(</span>matches<span class="token punctuation">,</span> bus<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">for_each_child_of_node</span><span class="token punctuation">(</span>bus<span class="token punctuation">,</span> child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">" create child: %pOF\n"</span><span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rc <span class="token operator">=</span> <span class="token function">of_platform_bus_create</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> matches<span class="token punctuation">,</span> lookup<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> strict<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">of_node_put</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token function">of_node_set_flag</span><span class="token punctuation">(</span>bus<span class="token punctuation">,</span> OF_POPULATED_BUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> rc<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>第14 行：如果<code>strict</code> 为真且设备节点bus 没有兼容性属性，则输出调试信息并返回0。这个条件判断确保设备节点具有<code>compatible</code> 属性，因为<code>compatible</code> 属性用于匹配设备驱动程序，对应我们在上一小节的第1 条规则。</li>
<li>第21 行：如果设备节点bus 在被跳过的节点表中，则输出调试信息并返回0。这个条件判断用于跳过不想创建设备的节点。</li>
<li>第27 行：如果设备节点bus 的<code>OF_POPULATED_BUS</code> 标志已经设置，则输出调试信息并返回0。这个条件判断用于避免重复创建已经填充的设备节点。</li>
<li>第34 行：使用lookup 辅助数据结构查找设备节点bus 的特定配置信息，并将其赋值给变量<code>bus_id</code> 和<code>platform_data</code>。这个步骤用于获取设备节点的特定配置信息，以便在创建平台设备时使用，由于这里传入的参数为<code>NULL</code>，所以下面的条件判断并不会被执行。</li>
<li>第39 行：如果设备节点bus 兼容于”<code>arm,primecell</code>“，则调用<code>of_amba_device_create</code> 函数创建AMBA 设备，并返回0，对应我们在上一小节学习的第3 条规则。</li>
<li>第47 行：调用<code>of_platform_device_create_pdata</code> 函数创建平台设备，并将其赋值给变量dev。然后，检查设备节点bus 是否与给定的匹配表<code>matches</code> 匹配。如果平台设备创建失败或者设备节点不匹配，那么返回0。</li>
<li>第51 行-第58 行：遍历设备节点bus 的每个子节点child，并递归调用<code>of_platform_bus_create</code> 函数来创建子节点的平台设备。</li>
</ul>
<p>接下来对该函数的第47 行<code>of_platform_device_create_pdata</code> 函数进行讲解，该函数的具体定义如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span><span class="token function">of_platform_device_create_pdata</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span>
                              <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>bus_id<span class="token punctuation">,</span><span class="token keyword">void</span> <span class="token operator">*</span>platform_data<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>parent<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>dev<span class="token punctuation">;</span>
    
    <span class="token comment">/* 检查设备节点是否可用或已填充*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">of_device_is_available</span><span class="token punctuation">(</span>np<span class="token punctuation">)</span> <span class="token operator">||</span><span class="token function">of_node_test_and_set_flag</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> OF_POPULATED<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* 分配平台设备结构体*/</span>
    dev <span class="token operator">=</span> <span class="token function">of_device_alloc</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> bus_id<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dev<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> err_clear_flag<span class="token punctuation">;</span>
    
    <span class="token comment">/* 设置平台设备的一些属性*/</span>
    dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>coherent_dma_mask <span class="token operator">=</span> <span class="token function">DMA_BIT_MASK</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>dma_mask<span class="token punctuation">)</span>
        dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>dma_mask <span class="token operator">=</span> <span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>coherent_dma_mask<span class="token punctuation">;</span>
    dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>bus <span class="token operator">=</span> <span class="token operator">&amp;</span>platform_bus_type<span class="token punctuation">;</span>
    dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>platform_data <span class="token operator">=</span> platform_data<span class="token punctuation">;</span>
    <span class="token function">of_msi_configure</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>of_node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">of_reserved_mem_device_init_by_idx</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>of_node<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* 将平台设备添加到设备模型中*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">of_device_add</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">platform_device_put</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> err_clear_flag<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> dev<span class="token punctuation">;</span>
    
    err_clear_flag<span class="token operator">:</span>
    <span class="token comment">/* 清除设备节点的已填充标志*/</span>
    <span class="token function">of_node_clear_flag</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> OF_POPULATED<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>第10 行：函数会检查设备节点的可用性，即检查设备树对应节点的status 属性。如果设备节点不可用或已经被填充，则直接返回NULL。</li>
<li>第15 行：函数调用<code>of_device_alloc</code> 分配一个平台设备结构体，并将设备节点指针、设备标识符和父设备指针传递给它。如果分配失败，则跳转到err_clear_flag 标签处进行错误处理。</li>
<li>第19 行，函数设置平台设备的一些属性。它将<code>coherent_dma_mask</code> 属性设置为32 位的DMA 位掩码，并检查dma_mask 属性是否为NULL。如果dma_mask 为NULL，则将其指向<code>coherent_dma_mask</code>。然后，函数设置平台设备的总线类型为<code>platform_bus_type</code>，并将平台数据指针存储在<code>platform_data</code> 属性中。接着，函数调用<code>of_msi_configure</code> 和<code>of_reserved_mem_device_init_by_idx</code> 来配置设备的MSI 和保留内存信息。</li>
<li>第29 行：函数调用<code>of_device_add</code> 将平台设备添加到设备模型中。如果添加失败，则释放已分配的平台设备，并跳转到err_clear_flag 标签处进行错误处理。</li>
</ul>
<p>至此，关于<code>device_node</code> 转换成<code>platform_device</code> 的具体流程就分析完成了，函数调用流程图如下（图64-1）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408281101106.png" alt="image-20240828110128986"></p>
<h2 id="第65-章设备树下platform-device-和platform-driver-匹配实验"><a href="#第65-章设备树下platform-device-和platform-driver-匹配实验" class="headerlink" title="第65 章设备树下platform_device 和platform_driver 匹配实验"></a>第65 章设备树下<code>platform_device</code> 和<code>platform_driver</code> 匹配实验</h2><p>在上一章节中我们学习了从device_node 到platform_device 的转换流程，转换完成之后操作系统才能够识别和管理设备，从而与platform_driver 进行匹配，在本章将将会对设备树下platform_device 和platform_driver 的匹配进行讲解。</p>
<h3 id="65-1-of-match-table"><a href="#65-1-of-match-table" class="headerlink" title="65.1 of_match_table"></a>65.1 of_match_table</h3><p>在前面平台总线相关章节的学习中，了解到只有<code>platform_device</code> 结构体中的<code>name</code> 属性与<code>platform_driver</code> 结构体中嵌套的<code>driver</code> 结构体<code>name</code> 属性或者<code>id_table</code> 相同才能加载<code>probe</code> 初始化函数。</p>
<p>而为了使设备树能够与驱动程序进行匹配，需要在<code>platform_driver</code> 驱动程序中添加<code>driver</code>结构体的<code>of_match_table</code> 属性。这个属性是一个指向<code>const struct of_device_id</code> 结构的指针，用于描述设备树节点和驱动程序之间的匹配规则。<code>of_device_id</code> 结构体定义在内核源码的“<code>/include/linux/mod_devicetable.h</code>”文件中，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> name<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> type<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> compatible<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>struct of_device_id 结构体通常作为一个数组在驱动程序中定义，用于描述设备树节点和驱动程序之间的匹配规则。数组的最后一个元素必须是一个空的结构体，以标记数组的结束。</p>
<p>以下是一个示例，展示了如何在驱动程序中使用<code>struct of_device_id</code> 进行设备树匹配：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> my_driver_match<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">{</span> <span class="token punctuation">.</span>compatible <span class="token operator">=</span> <span class="token string">"vendor,device-1"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token punctuation">.</span>compatible <span class="token operator">=</span> <span class="token string">"vendor,device-2"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在上述示例中，<code>my_driver_match</code> 是一个<code>struct of_device_id</code> 结构体数组。每个数组元素都包含了一个compatible 字段，用于指定设备树节点的兼容性字符串。驱动程序将根据这些兼容性字符串与设备树中的节点进行匹配。</p>
<h2 id="65-2-实验程序编写"><a href="#65-2-实验程序编写" class="headerlink" title="65.2 实验程序编写"></a>65.2 实验程序编写</h2><p>本次实验的要求使用设备树描述下面的内存资源：<br><strong>内存资源：</strong><br>起始地址：0xFDD60000<br>结束地址：0xFDD60004</p>
<p>然后编写对应的platform_driver 驱动程序，要求跟上述内存资源所创建的节点进行匹配，从而验证上一小节讲解的<code>of_match_table</code> 属性。</p>
<h4 id="65-2-1-设备树的编写"><a href="#65-2-1-设备树的编写" class="headerlink" title="65.2.1 设备树的编写"></a>65.2.1 设备树的编写</h4><p>改完成的dts 文件和编译完成的boot.img 镜像对应的网盘路径为：iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568 开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\54_devicetree_probe\dts。<br>首先来对rk3568 的设备树结构进行以下介绍，根据sdk 源码目录下的“device/rockchip/rk356x/BoardConfig-rk3568-evb1-ddr4-v10.mk”默认配置文件可以了解到编译的设备树为rk3568-evb1-ddr4-v10-linux.dts,设备树之间的包含关系如下表所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408281105433.png" alt="image-20240828110500387"></p>
<p><code>rk3568-evb1-ddr4-v10-linux.dts</code> 是顶层设备树，为了便于理解我们之后在该设备树下进行节点的添加（<strong>当然这里也可以修改其他设备树</strong>），进入该设备树文件之后如下（图65-1）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408281105151.png" alt="image-20240828110519083"></p>
<p>然后将根据需求编写的设备树节点添加到<code>rk3568-evb1-ddr4-v10-linux.dts</code> 中，要添加的内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token operator">/</span><span class="token punctuation">{</span>
    topeet<span class="token punctuation">{</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
        compatible <span class="token operator">=</span> <span class="token string">"simple-bus"</span><span class="token punctuation">;</span>
        myLed<span class="token punctuation">{</span>
            compatible <span class="token operator">=</span> <span class="token string">"my devicetree"</span><span class="token punctuation">;</span>
            reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0xFDD60000</span> <span class="token number">0x00000004</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>为了避免<code>#address-cells = &lt;1&gt;;</code> 和<code>#size-cells = &lt;1&gt;;</code>这两个属性改变根节点其他的节点的属性，所以在这里创建了一个topeet 节点。在这个示例中，<code>#address-cells</code> 设置为1 表示地址使用一个32 位的单元，<code>#size-cells</code> 也设置为1 表示大小使用一个32 位的单元。</p>
<ul>
<li>第5 行：将<code>compatible</code> 属性设置为”<code>simple-bus</code>“用于表示<code>topeet</code> 节点的兼容性，指明它是一个简单总线设备，在转换platform_device 的过程中，会继续查找该节点的子节点。</li>
<li>第8 行：<code>myLed</code> 节点下的<code>compatible</code> 属性为”my devicetree”，表明该节点将会被转换为<code>platform_device</code>。</li>
<li>第9 行：这个属性用于描述myLed 节点的寄存器信息。reg 属性的值<code>&lt;0xFDD60000 0x00000004&gt;</code> 表示<code>myLed</code> 设备的寄存器起始地址为<code>0xFDD60000</code>，大小为<code>0x00000004</code>。添加完成如下所示：</li>
</ul>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408281108759.png" alt="image-20240828110850671"></p>
<p>保存退出之后，重新编译内核源码，编译完成之后将生成的boot.img 烧写到开发板即可。</p>
<h4 id="66-2-2-驱动程序的编写"><a href="#66-2-2-驱动程序的编写" class="headerlink" title="66.2.2 驱动程序的编写"></a>66.2.2 驱动程序的编写</h4><p>本实验驱动对应的网盘路径为：iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\54_devicetree_probe\module。</p>
<p>本小节驱动程序是由“第52 章注册platform 驱动实验”程序修改而来，相较于源程序只是添加了of_match_table 相关代码，用来与设备树节点进行匹配。</p>
<p>编写完成的platform_driver.c 代码如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/platform_device.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mod_devicetable.h&gt;</span></span>
<span class="token comment">// 平台设备的初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">my_platform_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"my_platform_probe: Probing platform device\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 添加设备特定的操作</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 平台设备的移除函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">my_platform_remove</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"my_platform_remove: Removing platform device\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 清理设备特定的操作</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> of_match_table_id<span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">{</span><span class="token punctuation">.</span>compatible<span class="token operator">=</span><span class="token string">"my devicetree"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义平台驱动结构体</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">platform_driver</span> my_platform_driver <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>probe <span class="token operator">=</span> my_platform_probe<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>remove <span class="token operator">=</span> my_platform_remove<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>driver <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"my_platform_device"</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
		<span class="token punctuation">.</span>of_match_table <span class="token operator">=</span>  of_match_table_id<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 模块初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">my_platform_driver_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    <span class="token comment">// 注册平台驱动</span>
    ret <span class="token operator">=</span> <span class="token function">platform_driver_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_platform_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"Failed to register platform driver\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"my_platform_driver: Platform driver initialized\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 模块退出函数</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">my_platform_driver_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 注销平台驱动</span>
    <span class="token function">platform_driver_unregister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_platform_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"my_platform_driver: Platform driver exited\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>my_platform_driver_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>my_platform_driver_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"topeet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="65-3-运行测试"><a href="#65-3-运行测试" class="headerlink" title="65.3 运行测试"></a>65.3 运行测试</h3><h4 id="65-3-1-编译驱动程序"><a href="#65-3-1-编译驱动程序" class="headerlink" title="65.3.1 编译驱动程序"></a>65.3.1 编译驱动程序</h4><p>在上一小节中的<code>platform_driver.c</code> 代码同一目录下创建Makefile 文件，Makefile 文件内容：然后使用命令“make”进行驱动的编译，编译完生成platform_driver.ko 目标文件，至此驱动模块就编译成功了。</p>
<h4 id="65-3-2-运行测试"><a href="#65-3-2-运行测试" class="headerlink" title="65.3.2 运行测试"></a>65.3.2 运行测试</h4><p>在进行实验之前，首先要确保开发板烧写的是我们在65.2.1 小节中编译出来的boot.img。开发板启动之后，首先进入到“/proc/device-tree”目录下，查看是否已经存在了topeet 目录，如下图（图65-6）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408281112960.png" alt="image-20240828111235903"></p>
<p>只有在设备树节点编写正确的前提下，这里才会生成topeet 目录，如果没有出现topeet目录就要回头检查看看了。<br>然后使用以下命令进行驱动模块的加载，如下图（图65-7）所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">insmod platform_driver.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408281112894.png" alt="image-20240828111259839"></p>
<p>可以看到成功打印了在probe 函数中的打印，证明我们添加的设备树节点和platform_driver驱动匹配成功了。<br>然后使用以下命令进行驱动模块的卸载，如下图（图65-8）所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">rmmod platform_driver.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408281113151.png" alt="image-20240828111321095"></p>
<p>至此，设备树下<code>platform_device</code> 和<code>platform_driver</code> 匹配实验就完成了。</p>
<h2 id="第66-章of-操作函数实验：获取设备树节点"><a href="#第66-章of-操作函数实验：获取设备树节点" class="headerlink" title="第66 章of 操作函数实验：获取设备树节点"></a>第66 章of 操作函数实验：获取设备树节点</h2><p>在上一章节的学习中，我们学习了设备树下<code>platform_device</code> 和<code>platform_driver</code> 匹配，现在也只是让他们匹配在了一起，但这样显然是不够的，为了完成一些和硬件相关的需求，我们还需要获取到在设备树中编写的一些属性，那驱动是如何获取设备树中的属性呢，让我们一起进入后续章节的学习吧。</p>
<h3 id="66-1-of-操作：获取设备树节点"><a href="#66-1-of-操作：获取设备树节点" class="headerlink" title="66.1 of 操作：获取设备树节点"></a>66.1 of 操作：获取设备树节点</h3><p>在Linux 内核源码中提供了一系列的of 操作函数来帮助我们获取到设备树中编写的属性，在内核中以device_node 结构体来对设备树进行描述，所以of 操作函数实际上就是获取device_node 结构体，所以接下来我们学习的of 操作函数的返回值都是device_node 结构体，关于device_node 结构体的具体内容已经在63.1 小节讲解过了，这里不再进行赘述。</p>
<h4 id="66-1-1-of-find-node-by-name函数"><a href="#66-1-1-of-find-node-by-name函数" class="headerlink" title="66.1.1 of_find_node_by_name函数"></a>66.1.1 <code>of_find_node_by_name</code>函数</h4><p><code>of_find_node_by_name</code> 是Linux 内核中用于通过节点名称查找设备树节点的函数。下面是对<code>of_find_node_by_name</code> 函数的详细介绍：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">函数原型：
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span><span class="token function">of_find_node_by_name</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>from<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
头文件：
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of.h&gt;</span></span>
函数作用：
    该函数通过指定的节点名称在设备树中进行查找，返回匹配的节点的<span class="token keyword">struct</span> <span class="token class-name">device_node</span> 指针。
参数含义：
    from：指定起始节点，表示从哪个节点开始查找。如果from 参数为<span class="token constant">NULL</span>，则从设备树的根节点开始查找。
    name：要查找的节点名称。
返回值：
    如果找到匹配的节点，则返回对应的<span class="token keyword">struct</span> <span class="token class-name">device_node</span> 指针。
    如果未找到匹配的节点，则返回<span class="token constant">NULL</span>。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>会在接下来的实验小节中，对该函数进行实际演示。</p>
<h4 id="66-1-2-of-find-node-by-path-函数"><a href="#66-1-2-of-find-node-by-path-函数" class="headerlink" title="66.1.2 of_find_node_by_path 函数"></a>66.1.2 <code>of_find_node_by_path</code> 函数</h4><p><code>of_find_node_by_path</code> 是Linux 内核中用于通过节点路径查找设备树节点的函数。下面是对<code>of_find_node_by_path</code> 函数的详细介绍：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">函数原型：
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span><span class="token function">of_find_node_by_path</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
头文件：
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of.h&gt;</span></span>
函数作用：
    该函数根据节点路径在设备树中进行查找，返回匹配的节点的<span class="token keyword">struct</span> <span class="token class-name">device_node</span> 指针。
参数含义：
    path：节点的路径，以斜杠分隔的字符串表示。路径格式为设备树节点的绝对路径，例如<span class="token operator">/</span>topeet<span class="token operator">/</span>myLed。
返回值：
    如果找到匹配的节点，则返回对应的<span class="token keyword">struct</span> <span class="token class-name">device_node</span> 指针。
    如果未找到匹配的节点，则返回<span class="token constant">NULL</span>。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>of_find_node_by_path</code> 函数通过节点路径在设备树中进行查找。路径是设备树节点从根节点到目标节点的完整路径。可以通过指定正确的路径来准确地访问设备树中的特定节点。<br>使用of_find_node_by_path 函数时，可以直接传递节点的完整路径作为path 参数，函数会在设备树中查找匹配的节点。这对于已知节点路径的情况非常有用。</p>
<h4 id="66-1-3-of-get-parent-函数"><a href="#66-1-3-of-get-parent-函数" class="headerlink" title="66.1.3 of_get_parent 函数"></a>66.1.3 <code>of_get_parent</code> 函数</h4><p>在Linux 内核中，<code>of_get_parent</code> 函数用于获取设备树节点的父节点。下面是对<code>of_get_parent</code>函数的详细介绍：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">函数原型：
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span><span class="token function">of_get_parent</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
头文件：
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of.h&gt;</span></span>
函数作用：
    该函数接收一个指向设备树节点的指针node，并返回该节点的父节点的指针。
参数含义：
    node：要获取父节点的设备树节点指针。
返回值：
    如果找到匹配的节点，则返回对应的<span class="token keyword">struct</span> <span class="token class-name">device_node</span> 指针。
    如果未找到匹配的节点，则返回<span class="token constant">NULL</span>。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>使用<code>of_get_parent</code> 函数时，可以将特定的设备树节点作为参数传递给函数，然后它将返回该节点的父节点。这对于在设备树中导航和访问节点之间的层次关系非常有用。<br>父节点在设备树中表示了节点之间的层次结构关系。通过获取父节点，你可以访问上一级节点的属性和配置信息，从而更好地理解设备树中的节点之间的关系。</p>
<h4 id="66-1-4-of-get-next-child-函数"><a href="#66-1-4-of-get-next-child-函数" class="headerlink" title="66.1.4 of_get_next_child 函数"></a>66.1.4 <code>of_get_next_child</code> 函数</h4><p>在Linux 内核中，<code>of_get_next_child</code> 函数用于获取设备树节点的下一个子节点。下面是对<code>of_get_next_child</code> 函数的详细介绍：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">函数原型：
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span><span class="token function">of_get_next_child</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>node<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>prev<span class="token punctuation">)</span><span class="token punctuation">;</span>
头文件：
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of.h&gt;</span></span>
函数作用：
    该函数接收两个参数：node 是当前节点，prev 是上一个子节点。它返回下一个子节点的指针。
参数含义：
    node：当前节点，用于指定要获取子节点的起始节点。
    prev：上一个子节点，用于指定从哪个子节点开始获取下一个子节点。如果为<span class="token constant">NULL</span>，则从起始节点的第一个子节点开始。
返回值：
    如果找到匹配的节点，则返回对应的<span class="token keyword">struct</span> <span class="token class-name">device_node</span> 指针。
    如果未找到匹配的节点，则返回<span class="token constant">NULL</span>。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>使用<code>of_get_next_child</code> 函数时，可以传递当前节点以及上一个子节点作为参数。函数将从上一个子节点的下一个节点开始，查找并返回下一个子节点。<br>设备树中的子节点表示了节点之间的层次关系。通过获取子节点，你可以遍历和访问当前节点的所有子节点，以便进一步处理它们的属性和配置信息。</p>
<h4 id="64-1-5-of-find-compatible-node-函数"><a href="#64-1-5-of-find-compatible-node-函数" class="headerlink" title="64.1.5 of_find_compatible_node 函数"></a>64.1.5 <code>of_find_compatible_node</code> 函数</h4><p>当设备树中存在多个设备节点，需要根据设备的兼容性字符串进行匹配时，可以使用<code>of_find_compatible_node</code> 函数。该函数用于在设备树中查找与指定兼容性字符串匹配的节点。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">函数原型：
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span><span class="token function">of_find_compatible_node</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>from<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>type<span class="token punctuation">,</span> 
                                                <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>compatible<span class="token punctuation">)</span><span class="token punctuation">;</span>
头文件：
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of.h&gt;</span></span>
函数作用：
    在设备树中查找与指定兼容性字符串匹配的节点。
参数含义：
    from：指定起始节点，表示从哪个节点开始查找。如果from 参数为<span class="token constant">NULL</span>，则从设备树的根节点开始查找。
    type：要匹配的设备类型字符串，通常是compatible 属性中的一部分。
    compatible：要匹配的兼容性字符串，通常是设备树节点的compatible 属性中的值。
返回值：
    如果找到匹配的节点，则返回对应的<span class="token keyword">struct</span> <span class="token class-name">device_node</span> 指针。
    如果未找到匹配的节点，则返回<span class="token constant">NULL</span>。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>使用<code>of_find_compatible_node</code> 函数时，可以指定起始节点和需要匹配的设备类型字符串以及兼容性字符串。函数会从起始节点开始遍历设备树，查找与指定兼容性字符串匹配的节点，并返回匹配节点的指针。</p>
<h4 id="64-1-6-of-find-matching-node-and-match-函数"><a href="#64-1-6-of-find-matching-node-and-match-函数" class="headerlink" title="64.1.6 of_find_matching_node_and_match 函数"></a>64.1.6 <code>of_find_matching_node_and_match</code> 函数</h4><p>在Linux 内核中，<code>of_find_matching_node_and_match</code> 函数用于根据给定的<code>of_device_id</code> 匹配表在设备树中查找匹配的节点。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">函数原型：
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span><span class="token function">of_find_matching_node_and_match</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>from<span class="token punctuation">,</span>
                              <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> <span class="token operator">*</span>matches<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> <span class="token operator">*</span><span class="token operator">*</span>match<span class="token punctuation">)</span><span class="token punctuation">;</span>
头文件：
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of.h&gt;</span></span>
函数作用：
    根据给定的of_device_id 匹配表在设备树中查找匹配的节点。
参数含义：
    from：表示从哪个节点开始搜索。通常将上一次调用该函数返回的节点作为参数传递给fr
    om，以便从上一次的下一个节点开始搜索。如果要从设备树的根节点开始搜索，可以将from参数设置为<span class="token constant">NULL</span>。
    matches：指向一个of_device_id 类型的匹配表，该表包含要搜索的匹配项。
    match：用于输出匹配到的of_device_id 条目的指针。
返回值：
    如果找到匹配的节点，则返回对应的<span class="token keyword">struct</span> <span class="token class-name">device_node</span> 指针。
    如果未找到匹配的节点，则返回<span class="token constant">NULL</span>。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>of_find_matching_node_and_match</code> 函数在设备树中遍历节点，对每个节点使用<code>__of_match_node</code> 函数进行匹配。如果找到匹配的节点，将返回该节点的指针，并将match 指针更新为匹配到的<code>of_device_id</code> 条目，函数会自动增加匹配节点的引用计数。以下是使用<code>of_find_matching_node_and_match</code> 函数的示例代码：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of.h&gt;</span></span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> my_match_table<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">{</span> <span class="token punctuation">.</span>compatible <span class="token operator">=</span> <span class="token string">"vendor,device"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token comment">/* sentinel */</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> <span class="token operator">*</span>match<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">;</span>

<span class="token comment">// 从根节点开始查找匹配的节点</span>
np <span class="token operator">=</span> <span class="token function">of_find_matching_node_and_match</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> my_match_table<span class="token punctuation">,</span> <span class="token operator">&amp;</span>match<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在上述示例中，我们定义了一个<code>of_device_id</code> 匹配表<code>my_match_table</code>，其中包含了一个兼容性字符串为”<code>vendor,device</code>“的匹配项。然后，我们使用<code>of_find_matching_node_and_match</code> 函数从根节点开始查找匹配的节点。</p>
<h3 id="66-2-实验程序编写"><a href="#66-2-实验程序编写" class="headerlink" title="66.2 实验程序编写"></a>66.2 实验程序编写</h3><p>本实验驱动对应的网盘路径为：iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\55_of_01。</p>
<p>本小节驱动程序是由上一章程序修改而来，相较于源程序只是在probe 函数中添加了本章节学习的of 操作相关代码，用来获取设备树节点。</p>
<p>编写完成的platform_driver.c 代码如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/platform_device.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mod_devicetable.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>mydevice_node<span class="token punctuation">;</span>      
<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> <span class="token operator">*</span>mynode_match<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> mynode_of_match<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">{</span><span class="token punctuation">.</span>compatible<span class="token operator">=</span><span class="token string">"my devicetree"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 平台设备的初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">my_platform_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"my_platform_probe: Probing platform device\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 通过节点名称查找设备树节点</span>
    mydevice_node <span class="token operator">=</span> <span class="token function">of_find_node_by_name</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"myLed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"mydevice node is %s\n"</span><span class="token punctuation">,</span> mydevice_node<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
	<span class="token comment">// 通过节点路径查找设备树节点</span>
    mydevice_node <span class="token operator">=</span> <span class="token function">of_find_node_by_path</span><span class="token punctuation">(</span><span class="token string">"/topeet/myLed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"mydevice node is %s\n"</span><span class="token punctuation">,</span> mydevice_node<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token comment">// 获取父节点</span>
    mydevice_node <span class="token operator">=</span> <span class="token function">of_get_parent</span><span class="token punctuation">(</span>mydevice_node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"myled's parent node is %s\n"</span><span class="token punctuation">,</span> mydevice_node<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
    <span class="token comment">// 获取子节点</span>
    mydevice_node <span class="token operator">=</span> <span class="token function">of_get_next_child</span><span class="token punctuation">(</span>mydevice_node<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"myled's sibling node is %s\n"</span><span class="token punctuation">,</span> mydevice_node<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 使用compatible值查找节点</span>
	mydevice_node<span class="token operator">=</span><span class="token function">of_find_compatible_node</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"my devicetree"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"mydevice node is %s\n"</span> <span class="token punctuation">,</span> mydevice_node<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//根据给定的of_device_id匹配表在设备树中查找匹配的节点</span>
	mydevice_node<span class="token operator">=</span><span class="token function">of_find_matching_node_and_match</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token punctuation">,</span> mynode_of_match<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mynode_match<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"mydevice node is %s\n"</span> <span class="token punctuation">,</span>mydevice_node<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 平台设备的移除函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">my_platform_remove</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"my_platform_remove: Removing platform device\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 清理设备特定的操作</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> of_match_table_id<span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">{</span><span class="token punctuation">.</span>compatible<span class="token operator">=</span><span class="token string">"my devicetree"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义平台驱动结构体</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">platform_driver</span> my_platform_driver <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>probe <span class="token operator">=</span> my_platform_probe<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>remove <span class="token operator">=</span> my_platform_remove<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>driver <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"my_platform_device"</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
		<span class="token punctuation">.</span>of_match_table <span class="token operator">=</span>  of_match_table_id<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 模块初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">my_platform_driver_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    <span class="token comment">// 注册平台驱动</span>
    ret <span class="token operator">=</span> <span class="token function">platform_driver_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_platform_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"Failed to register platform driver\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"my_platform_driver: Platform driver initialized\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 模块退出函数</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">my_platform_driver_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 注销平台驱动</span>
    <span class="token function">platform_driver_unregister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_platform_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"my_platform_driver: Platform driver exited\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>my_platform_driver_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>my_platform_driver_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"topeet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="66-3-运行测试"><a href="#66-3-运行测试" class="headerlink" title="66.3 运行测试"></a>66.3 运行测试</h3><h4 id="66-3-1-编译驱动程序"><a href="#66-3-1-编译驱动程序" class="headerlink" title="66.3.1 编译驱动程序"></a>66.3.1 编译驱动程序</h4><p>在上一小节中的platform_driver.c 代码同一目录下创建Makefile 文件，Makefile 文件内容：然后使用命令“make”进行驱动的编译，编译完生成platform_driver.ko 目标文件，至此驱动模块就编译成功了。</p>
<h4 id="66-3-2-运行测试"><a href="#66-3-2-运行测试" class="headerlink" title="66.3.2 运行测试"></a>66.3.2 运行测试</h4><p>在进行实验之前，首先要确保开发板烧写的是我们在65.2.1 小节中编译出来的boot.img，开发板启动之后，使用以下命令进行驱动模块的加载，如下图（图66-4）所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">insmod platform_driver.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408281124477.png" alt="image-20240828112424400"></p>
<p>可以看到总共有4 个打印，前两个打印都是查找的myLed 节点，第三个打印是查找的myLed的父节点，也就是topeet 节点，第四个打印是查找的topeet 的子节点，也就又回到了myLed节点。第5 个打印是通过compatible 属性查找到的myLed 节点，第6 个打印是通过of_device_id匹配表查找到的myLed 节点.</p>
<p>然后使用以下命令进行驱动模块的卸载，如下图（图66-5）所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">rmmod platform_driver.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408281124225.png" alt="image-20240828112452164"></p>
<p>至此，使用of 操作函数获取设备树节点实验就完成了。</p>
<h2 id="第67-章of-操作函数实验：获取属性"><a href="#第67-章of-操作函数实验：获取属性" class="headerlink" title="第67 章of 操作函数实验：获取属性"></a>第67 章of 操作函数实验：获取属性</h2><h3 id="67-1-of-操作：获取属性"><a href="#67-1-of-操作：获取属性" class="headerlink" title="67.1 of 操作：获取属性"></a>67.1 of 操作：获取属性</h3><h4 id="67-1-1-of-find-property-函数"><a href="#67-1-1-of-find-property-函数" class="headerlink" title="67.1.1 of_find_property 函数"></a>67.1.1 <code>of_find_property</code> 函数</h4><p><code>of_find_property</code> 函数用于在设备树中查找节点下具有指定名称的属性。如果找到了该属性，可以通过返回的属性结构体指针进行进一步的操作，比如获取属性值、属性长度等。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">函数原型<span class="token operator">:</span>
    <span class="token keyword">struct</span> <span class="token class-name">property</span> <span class="token operator">*</span><span class="token function">of_find_property</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>lenp<span class="token punctuation">)</span>
头文件：
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of.h&gt;</span></span>
函数作用<span class="token operator">:</span>
    该函数用于在节点np 下查找指定名称name 的属性。
函数参数<span class="token operator">:</span>
    np<span class="token operator">:</span> 要查找的节点。
    name<span class="token operator">:</span> 要查找的属性的属性名。
    lenp<span class="token operator">:</span> 一个指向整数的指针，用于接收属性值的字节数。
返回值<span class="token operator">:</span>
    如果成功找到了指定名称的属性，则返回对应的属性结构体指针<span class="token keyword">struct</span> <span class="token class-name">property</span> <span class="token operator">*</span>；如果未找到，则返回<span class="token constant">NULL</span>。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="67-1-2-of-property-count-elems-of-size-函数"><a href="#67-1-2-of-property-count-elems-of-size-函数" class="headerlink" title="67.1.2 of_property_count_elems_of_size 函数"></a>67.1.2 <code>of_property_count_elems_of_size</code> 函数</h4><p>该函数在设备树中的设备节点下查找指定名称的属性，并获取该属性中元素的数量。调用该函数可以用于获取设备树属性中某个属性的元素数量，比如一个字符串列表的元素数量或一个整数数组的元素数量等。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">函数原型<span class="token operator">:</span>
    <span class="token keyword">int</span> <span class="token function">of_property_count_elems_of_size</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span> 
                                        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">,</span> <span class="token keyword">int</span> lem_size<span class="token punctuation">)</span>
头文件：
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of.h&gt;</span></span>
函数作用<span class="token operator">:</span>
    该函数用于获取属性中指定元素的数量。
函数参数<span class="token operator">:</span>
    np<span class="token operator">:</span> 设备节点。
    propname<span class="token operator">:</span> 需要获取元素数量的属性名。
    elem_size<span class="token operator">:</span> 单个元素的尺寸。
返回值<span class="token operator">:</span>
    如果成功获取了指定属性中元素的数量，则返回该数量；
    如果未找到属性或属性中没有元素，则返回<span class="token number">0</span>。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="67-1-3-of-property-read-u32-index-函数"><a href="#67-1-3-of-property-read-u32-index-函数" class="headerlink" title="67.1.3 of_property_read_u32_index 函数"></a>67.1.3 <code>of_property_read_u32_index</code> 函数</h4><p>该函数在设备树中的设备节点下查找指定名称的属性，并获取该属性在给定索引位置处的u32 类型的数据值。<br>这个函数通常用于从设备树属性中读取特定索引位置的整数值。通过指定属性名和索引，可以获取属性中指定位置的具体数值。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">函数原型<span class="token operator">:</span>
    <span class="token keyword">int</span> <span class="token function">of_property_read_u32_index</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">,</span> 
                                   u32 index<span class="token punctuation">,</span> u32 <span class="token operator">*</span>out_value<span class="token punctuation">)</span>
头文件：
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of.h&gt;</span></span>
函数作用<span class="token operator">:</span>
    该函数用于从指定属性中获取指定索引位置的u32 类型的数据值。
函数参数<span class="token operator">:</span>
    np<span class="token operator">:</span> 设备节点。
    propname<span class="token operator">:</span> 要读取的属性名。
    index<span class="token operator">:</span> 要读取的属性值在属性中的索引，索引从<span class="token number">0</span> 开始。
    out_value<span class="token operator">:</span> 用于存储读取到的值的指针。
返回值<span class="token operator">:</span>
	如果成功读取到了指定属性指定索引位置的u32 类型的数据值，则返回<span class="token number">0</span>；
    如果未找到属性或读取失败，则返回相应的错误码。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="67-1-4-of-property-read-u64-index-函数"><a href="#67-1-4-of-property-read-u64-index-函数" class="headerlink" title="67.1.4 of_property_read_u64_index 函数"></a>67.1.4 <code>of_property_read_u64_index</code> 函数</h4><p>该函数在设备树中的设备节点下查找指定名称的属性，并获取该属性在给定索引位置处的u64 类型的数据值。<br>这个函数通常用于从设备树属性中读取特定索引位置的64 位整数值。通过指定属性名和索引，可以获取属性中指定位置的具体数值。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">函数原型<span class="token operator">:</span>
    <span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">int</span> <span class="token function">of_property_read_u64_index</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span> 
                                                 <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">,</span> u32 index<span class="token punctuation">,</span> u64 <span class="token operator">*</span>out_value<span class="token punctuation">)</span>
头文件：
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of.h&gt;</span></span>
函数作用<span class="token operator">:</span>
    该函数用于从指定属性中获取指定索引位置的u64 类型的数据值。
函数参数<span class="token operator">:</span>
    np<span class="token operator">:</span> 设备节点。
    propname<span class="token operator">:</span> 要读取的属性名。
    index<span class="token operator">:</span> 要读取的属性值在属性中的索引，索引从<span class="token number">0</span> 开始。
    out_value<span class="token operator">:</span> 用于存储读取到的值的指针。
返回值<span class="token operator">:</span>
    如果成功读取到了指定属性指定索引位置的u64 类型的数据值，则返回<span class="token number">0</span>；
    如果未找到属性或读取失败，则返回相应的错误码。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="67-1-5-of-property-read-variable-u32-array-函数"><a href="#67-1-5-of-property-read-variable-u32-array-函数" class="headerlink" title="67.1.5 of_property_read_variable_u32_array 函数"></a>67.1.5 <code>of_property_read_variable_u32_array</code> 函数</h4><p>该函数用于从设备树中读取指定属性名的变长数组。通过提供设备节点、属性名和输出数组的指针，可以将设备树中的数组数据读取到指定的内存区域中。同时，还需要指定数组的最小大小和最大大小，以确保读取到的数组符合预期的大小范围。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">函数原型：
    <span class="token keyword">int</span> <span class="token function">of_property_read_variable_u32_array</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">,</span> 
                                            u32 <span class="token operator">*</span>out_values<span class="token punctuation">,</span> <span class="token class-name">size_t</span> SZ_min<span class="token punctuation">,</span> <span class="token class-name">size_t</span> SZ_max<span class="token punctuation">)</span>
函数作用<span class="token operator">:</span>
    从指定属性中读取变长的u32 数组。
函数参数和返回值<span class="token operator">:</span>
    np<span class="token operator">:</span> 设备节点。
    propname<span class="token operator">:</span> 要读取的属性名。
    out_values<span class="token operator">:</span> 用于存储读取到的u8 数组的指针。
    SZ_min<span class="token operator">:</span> 数组的最小大小。
    SZ_max<span class="token operator">:</span> 数组的最大大小。
返回值：
    如果成功读取到了指定属性的u8 数组，则返回数组的大小。
    如果未找到属性或读取失败，则返回相应的错误码。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面介绍的函数用于从指定属性中读取变长的u32 数组，下面是另外三个读取其他数组大小的函数：<br>这里给出了四个函数，用于从设备树中读取数组类型的属性值：</p>
<p>从指定属性中读取变长的u8 数组：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">of_property_read_variable_u8_array</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">,</span> 
                                       u8 <span class="token operator">*</span>out_values<span class="token punctuation">,</span><span class="token class-name">size_t</span> SZ_min<span class="token punctuation">,</span> <span class="token class-name">size_t</span> SZ_max<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>从指定属性中读取变长的u16 数组：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">of_property_read_variable_u16_array</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">,</span> 
                                        u16<span class="token operator">*</span>out_values<span class="token punctuation">,</span> <span class="token class-name">size_t</span> SZ_min<span class="token punctuation">,</span> <span class="token class-name">size_t</span> SZ_max<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>从指定属性中读取变长的u64 数组：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">of_property_read_variable_u64_array</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">,</span> 
                                        u64<span class="token operator">*</span>out_values<span class="token punctuation">,</span> <span class="token class-name">size_t</span> SZ_min<span class="token punctuation">,</span> <span class="token class-name">size_t</span> SZ_max<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="67-1-6-of-property-read-string-函数"><a href="#67-1-6-of-property-read-string-函数" class="headerlink" title="67.1.6 of_property_read_string 函数"></a>67.1.6 <code>of_property_read_string</code> 函数</h4><p>该函数在设备树中的设备节点下查找指定名称的属性，并获取该属性的字符串值，最后返回读取到的字符串的指针，通常用于从设备树属性中读取字符串值。通过指定属性名，可以获取属性中的字符串数据。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">函数原型<span class="token operator">:</span>
    <span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">int</span> <span class="token function">of_property_read_string</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span> 
                                              <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>out_string<span class="token punctuation">)</span>
头文件：
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of.h&gt;</span></span>
函数作用<span class="token operator">:</span>
    该函数用于从指定属性中读取字符串。
函数参数<span class="token operator">:</span>
    np<span class="token operator">:</span> 设备节点。
    propname<span class="token operator">:</span> 要读取的属性名。
    out_string<span class="token operator">:</span> 用于存储读取到的字符串的指针。
返回值<span class="token operator">:</span>
    如果成功读取到了指定属性的字符串，则返回<span class="token number">0</span>；
    如果未找到属性或读取失败，则返回相应的错误码。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="67-2-实验程序编写"><a href="#67-2-实验程序编写" class="headerlink" title="67.2 实验程序编写"></a>67.2 实验程序编写</h3><p>本实验驱动对应的网盘路径为：iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\56_of_02。</p>
<p>本小节驱动程序是由65 章驱动程序修改而来，由于本章节获取设备树属性的函数需要在查找到设备树节点的前提下使用，所以在下面的程序中，先在probe 函数中添加获取设备树节点的相关内容，然后添加了本章节学习的of 操作相关代码，用来获取设备树节点相关属性。</p>
<p>编写完成的platform_driver.c 代码如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/platform_device.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mod_devicetable.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>mydevice_node<span class="token punctuation">;</span>      
<span class="token keyword">int</span> num<span class="token punctuation">;</span>
u32 value_u32<span class="token punctuation">;</span>
u64 value_u64<span class="token punctuation">;</span>
u32 out_value<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>value_compatible<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">property</span> <span class="token operator">*</span>my_property<span class="token punctuation">;</span>

<span class="token comment">// 平台设备的探测函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">my_platform_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"my_platform_probe: Probing platform device\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 通过节点名称查找设备树节点</span>
    mydevice_node <span class="token operator">=</span> <span class="token function">of_find_node_by_name</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"myLed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"mydevice node is %s\n"</span><span class="token punctuation">,</span> mydevice_node<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 查找compatible属性</span>
    my_property <span class="token operator">=</span> <span class="token function">of_find_property</span><span class="token punctuation">(</span>mydevice_node<span class="token punctuation">,</span> <span class="token string">"compatible"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"my_property name is %s\n"</span><span class="token punctuation">,</span> my_property<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取reg属性的元素数量</span>
    num <span class="token operator">=</span> <span class="token function">of_property_count_elems_of_size</span><span class="token punctuation">(</span>mydevice_node<span class="token punctuation">,</span> <span class="token string">"reg"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"reg num is %d\n"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 读取reg属性的值</span>
    <span class="token function">of_property_read_u32_index</span><span class="token punctuation">(</span>mydevice_node<span class="token punctuation">,</span> <span class="token string">"reg"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>value_u32<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">of_property_read_u64_index</span><span class="token punctuation">(</span>mydevice_node<span class="token punctuation">,</span> <span class="token string">"reg"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>value_u64<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"value u32 is 0x%X\n"</span><span class="token punctuation">,</span> value_u32<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"value u64 is 0x%llx\n"</span><span class="token punctuation">,</span> value_u64<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 读取reg属性的变长数组</span>
    <span class="token function">of_property_read_variable_u32_array</span><span class="token punctuation">(</span>mydevice_node<span class="token punctuation">,</span> <span class="token string">"reg"</span><span class="token punctuation">,</span> out_value<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"out_value[0] is 0x%X\n"</span><span class="token punctuation">,</span> out_value<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"out_value[1] is 0x%X\n"</span><span class="token punctuation">,</span> out_value<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 读取compatible属性的字符串值</span>
    <span class="token function">of_property_read_string</span><span class="token punctuation">(</span>mydevice_node<span class="token punctuation">,</span> <span class="token string">"compatible"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>value_compatible<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"compatible value is %s\n"</span><span class="token punctuation">,</span> value_compatible<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 平台设备的移除函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">my_platform_remove</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"my_platform_remove: Removing platform device\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 清理设备特定的操作</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> of_match_table_id<span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">{</span><span class="token punctuation">.</span>compatible<span class="token operator">=</span><span class="token string">"my devicetree"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义平台驱动结构体</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">platform_driver</span> my_platform_driver <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>probe <span class="token operator">=</span> my_platform_probe<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>remove <span class="token operator">=</span> my_platform_remove<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>driver <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"my_platform_device"</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
		<span class="token punctuation">.</span>of_match_table <span class="token operator">=</span>  of_match_table_id<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 模块初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">my_platform_driver_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    <span class="token comment">// 注册平台驱动</span>
    ret <span class="token operator">=</span> <span class="token function">platform_driver_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_platform_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"Failed to register platform driver\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"my_platform_driver: Platform driver initialized\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 模块退出函数</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">my_platform_driver_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 注销平台驱动</span>
    <span class="token function">platform_driver_unregister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_platform_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"my_platform_driver: Platform driver exited\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>my_platform_driver_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>my_platform_driver_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"topeet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="67-3-运行测试"><a href="#67-3-运行测试" class="headerlink" title="67.3 运行测试"></a>67.3 运行测试</h3><h4 id="67-3-1-编译驱动程序"><a href="#67-3-1-编译驱动程序" class="headerlink" title="67.3.1 编译驱动程序"></a>67.3.1 编译驱动程序</h4><pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile"><span class="token keyword">export</span> ARCH<span class="token operator">=</span>arm64<span class="token comment">#设置平台架构</span>
<span class="token keyword">export</span> CROSS_COMPILE<span class="token operator">=</span>aarch64-linux-gnu-<span class="token comment">#交叉编译器前缀</span>
obj-m <span class="token operator">+=</span> platform_driver.o <span class="token comment">#此处要和你的驱动源文件同名</span>
KDIR <span class="token operator">:=</span>/home/topeet/Linux/linux_sdk/kernel <span class="token comment">#这里是你的内核目录</span>
PWD <span class="token operator">?=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">shell</span> pwd<span class="token punctuation">)</span>
<span class="token target symbol">all</span><span class="token punctuation">:</span>
    make -C <span class="token variable">$</span><span class="token punctuation">(</span>KDIR<span class="token punctuation">)</span> M<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PWD<span class="token punctuation">)</span> modules <span class="token comment">#make 操作</span>
<span class="token target symbol">clean</span><span class="token punctuation">:</span>
    make -C <span class="token variable">$</span><span class="token punctuation">(</span>KDIR<span class="token punctuation">)</span> M<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PWD<span class="token punctuation">)</span> clean <span class="token comment">#make clean 操作</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>对于Makefile 的内容注释已在上图添加，保存退出之后，来到存放platform_driver.c 和Makefile 文件目录下，如下图（图67-1）所示：然后使用命令“make”进行驱动的编译，编译完生成platform_driver.ko 目标文件，至此驱动模块就编译成功了。</p>
<h4 id="67-3-2-运行测试"><a href="#67-3-2-运行测试" class="headerlink" title="67.3.2 运行测试"></a>67.3.2 运行测试</h4><p>在进行实验之前，首先要确保开发板烧写的是我们在65.2.1 小节中编译出来的boot.img，开发板启动之后，使用以下命令进行驱动模块的加载，如下图（图67-4）所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">insmod platform_driver.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408281139895.png" alt="image-20240828113912798"></p>
<p>可以看到总共有8 个打印，第一个打印表示查找到的节点为myLed,接下来的打印都是使用该节点进行的属性查找。第二个打印表示查找的属性名为“compatible”，第三个打印表示查找的reg 属性数量为2，第四个和第五个分别表示读取到的32 位和64 位的reg 属性值，第6 个和第7 个打印表示reg 的第一个属性值和第二个属性值，第8 个打印表示compatite 属性<br>值为“my devicetree”。<br>然后使用以下命令进行驱动模块的卸载，如下图（图67-5）所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">rmmod platform_driver.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408281139424.png" alt="image-20240828113937356"></p>
<p>至此，使用of 操作函数获取设备树节点实验就完成了。</p>
<h2 id="第68-章ranges-属性实验"><a href="#第68-章ranges-属性实验" class="headerlink" title="第68 章ranges 属性实验"></a>第68 章ranges 属性实验</h2><h3 id="68-1-platform-get-resource-获取设备树资源"><a href="#68-1-platform-get-resource-获取设备树资源" class="headerlink" title="68.1 platform_get_resource 获取设备树资源"></a>68.1 platform_get_resource 获取设备树资源</h3><p>在上个章节中讲解了使用of 操作函数来获取设备树的属性，由于设备树在系统启动的时候都会转化为platform 设备， 那我们能不能直接在驱动中使用在53.1 小节中讲解的<code>platform_get_resource</code> 函数直接获取<code>platform_device</code> 资源呢？</p>
<h4 id="68-1-1-驱动程序编写"><a href="#68-1-1-驱动程序编写" class="headerlink" title="68.1.1 驱动程序编写"></a>68.1.1 驱动程序编写</h4><p>带着疑惑我们这里仍旧以65 章的驱动程序为原型， 在<code>probe</code> 函数中加入使用<code>platform_get_resource</code> 函数获取reg 资源的函数，添加完成的驱动程序内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/platform_device.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mod_devicetable.h&gt;</span></span>

<span class="token comment">// 平台设备的初始化函数</span>
<span class="token keyword">struct</span> <span class="token class-name">resource</span> <span class="token operator">*</span>myresources<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">my_platform_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"my_platform_probe: Probing platform device\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取平台设备的资源</span>
    myresources <span class="token operator">=</span> <span class="token function">platform_get_resource</span><span class="token punctuation">(</span>pdev<span class="token punctuation">,</span> IORESOURCE_MEM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>myresources <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果获取资源失败，打印value_compatible 的值</span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"platform_get_resource is error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"reg valus is %llx\n"</span> <span class="token punctuation">,</span> myresources<span class="token operator">-&gt;</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 平台设备的移除函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">my_platform_remove</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"my_platform_remove: Removing platform device\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 清理设备特定的操作</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> of_match_table_id<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">{</span><span class="token punctuation">.</span>compatible<span class="token operator">=</span><span class="token string">"my devicetree"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义平台驱动结构体</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">platform_driver</span> my_platform_driver <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>probe <span class="token operator">=</span> my_platform_probe<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>remove <span class="token operator">=</span> my_platform_remove<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>driver <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"my_platform_device"</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>of_match_table <span class="token operator">=</span> of_match_table_id<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 模块初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">my_platform_driver_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token comment">// 注册平台驱动</span>
    ret <span class="token operator">=</span> <span class="token function">platform_driver_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_platform_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"Failed to register platform driver\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"my_platform_driver: Platform driver initialized\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 模块退出函数</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">my_platform_driver_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 注销平台驱动</span>
    <span class="token function">platform_driver_unregister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_platform_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"my_platform_driver: Platform driver exited\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>my_platform_driver_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>my_platform_driver_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"topeet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>编译成模块之后，放到开发板上进行加载，打印信息如下（图68-1）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408290923684.png" alt="image-20240829092256561"></p>
<p>可以看到使用platform_get_resource 函数获取reg 资源的函数失败了，在下一个小节中将分析获取资源失败的原因。</p>
<h4 id="68-1-2-获取资源失败源码分析"><a href="#68-1-2-获取资源失败源码分析" class="headerlink" title="68.1.2 获取资源失败源码分析"></a>68.1.2 获取资源失败源码分析</h4><p><code>platform_get_resource</code> 定义在内核源码目录下的”<code>/drivers/base/platform.c</code>“目录下，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">resource</span> <span class="token operator">*</span><span class="token function">platform_get_resource</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>
                                       <span class="token keyword">unsigned</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> num<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    u32 i<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> dev<span class="token operator">-&gt;</span>num_resources<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">resource</span> <span class="token operator">*</span>r <span class="token operator">=</span> <span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>resource<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> <span class="token function">resource_type</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> num<span class="token operator">--</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> r<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该函数返回<code>NULL</code> 符合第一小节中的情况，返回<code>NULL</code> 的情况有两种可能性，一种是没进入上面的for 循环直接返回了NULL，另外一种是进入了for 循环，但是类型匹配不正确，跳出for循环之后再返回NULL。这里的类型一定是匹配的，所以我们就来寻找为什么没有进入for 循环，这里只有一种可能，也就是<code>dev-&gt;num_resources</code> 为0。</p>
<p>所以现在的目标来到了寻找<code>dev-&gt;num_resources</code> 是在哪里进行的赋值，前面已经讲解过了由设备树转换为<code>platform</code> 的过程，而且在系统启动后，在对应目录下也有了相应的节点：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408290925203.png" alt="image-20240829092533132"></p>
<p>证明转换是没问题的，所以继续寻找中间转换过程中有关资源数量的相关函数，定位到了<code>of_platform_device_create_pdata</code> 函数，该函数定义在内核源码目录下的“<code>drivers/of/platform.c</code>”文件中，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span><span class="token function">of_platform_device_create_pdata</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span>
                             <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>bus_id<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>platform_data<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>parent<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>dev<span class="token punctuation">;</span>
    <span class="token comment">/* 检查设备节点是否可用或已填充*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">of_device_is_available</span><span class="token punctuation">(</span>np<span class="token punctuation">)</span> <span class="token operator">||</span><span class="token function">of_node_test_and_set_flag</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> OF_POPULATED<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* 分配平台设备结构体*/</span>
    dev <span class="token operator">=</span> <span class="token function">of_device_alloc</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> bus_id<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dev<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> err_clear_flag<span class="token punctuation">;</span>
    
    <span class="token comment">/* 设置平台设备的一些属性*/</span>
    dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>coherent_dma_mask <span class="token operator">=</span> <span class="token function">DMA_BIT_MASK</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>dma_mask<span class="token punctuation">)</span>
        dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>dma_mask <span class="token operator">=</span> <span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>coherent_dma_mask<span class="token punctuation">;</span>
    dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>bus <span class="token operator">=</span> <span class="token operator">&amp;</span>platform_bus_type<span class="token punctuation">;</span>
    dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>platform_data <span class="token operator">=</span> platform_data<span class="token punctuation">;</span>
    <span class="token function">of_msi_configure</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>of_node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">of_reserved_mem_device_init_by_idx</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>of_node<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 将平台设备添加到设备模型中*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">of_device_add</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">platform_device_put</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> err_clear_flag<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> dev<span class="token punctuation">;</span>
    err_clear_flag<span class="token operator">:</span>
    <span class="token comment">/* 清除设备节点的已填充标志*/</span>
    <span class="token function">of_node_clear_flag</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> OF_POPULATED<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第15 行：函数调用<code>of_device_alloc</code> 分配一个平台设备结构体，并将设备节点指针、设备标识符和父设备指针传递给它，正是该函数决定的<code>resource.num</code>,然后找到该函数的定义，如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span><span class="token function">of_device_alloc</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>bus_id<span class="token punctuation">,</span>
                                        <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>parent<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>dev<span class="token punctuation">;</span>
    <span class="token keyword">int</span> rc<span class="token punctuation">,</span> i<span class="token punctuation">,</span> num_reg <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> num_irq<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">resource</span> <span class="token operator">*</span>res<span class="token punctuation">,</span> temp_res<span class="token punctuation">;</span>
    dev <span class="token operator">=</span> <span class="token function">platform_device_alloc</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> PLATFORM_DEVID_NONE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dev<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* count the io and irq resources */</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">of_address_to_resource</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> num_reg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>temp_res<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        num_reg<span class="token operator">++</span><span class="token punctuation">;</span>
    num_irq <span class="token operator">=</span> <span class="token function">of_irq_count</span><span class="token punctuation">(</span>np<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* Populate the resource table */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>num_irq <span class="token operator">||</span> num_reg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res <span class="token operator">=</span> <span class="token function">kcalloc</span><span class="token punctuation">(</span>num_irq <span class="token operator">+</span> num_reg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">platform_device_put</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        dev<span class="token operator">-&gt;</span>num_resources <span class="token operator">=</span> num_reg <span class="token operator">+</span> num_irq<span class="token punctuation">;</span>
        dev<span class="token operator">-&gt;</span>resource <span class="token operator">=</span> res<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_reg<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">,</span> res<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            rc <span class="token operator">=</span> <span class="token function">of_address_to_resource</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> i<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">WARN_ON</span><span class="token punctuation">(</span>rc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">of_irq_to_resource_table</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> res<span class="token punctuation">,</span> num_irq<span class="token punctuation">)</span> <span class="token operator">!=</span> num_irq<span class="token punctuation">)</span>
            <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"not all legacy IRQ resources mapped for %pOFn\n"</span><span class="token punctuation">,</span>np<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>of_node <span class="token operator">=</span> <span class="token function">of_node_get</span><span class="token punctuation">(</span>np<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>fwnode <span class="token operator">=</span> <span class="token operator">&amp;</span>np<span class="token operator">-&gt;</span>fwnode<span class="token punctuation">;</span>
    dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>parent <span class="token operator">=</span> parent <span class="token operator">?</span> <span class="token operator">:</span> <span class="token operator">&amp;</span>platform_bus<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bus_id<span class="token punctuation">)</span>
    <span class="token function">dev_set_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> bus_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
    <span class="token function">of_device_make_bus_id</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> dev<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在第26 行出现了for 循环的<code>dev-&gt;num_resources = num_reg + num_irq;</code>reg 的number 和irq的number，由于在设备树中并没有添加中断相关的属性<code>num_irq</code> 为0，那这里的<code>num_reg</code> 是哪里确定的呢。<br>我们向上找到14、15 行，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* count the io and irq resources */</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">of_address_to_resource</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> num_reg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>temp_res<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    num_reg<span class="token operator">++</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>然后跳转到while 循环中的<code>of_address_to_resource</code> 函数，该函数定义在内核源码目录的<code>drivers/of/address.c</code> 文件中，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">of_address_to_resource</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">resource</span> <span class="token operator">*</span>r<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">const</span> __be32 <span class="token operator">*</span>addrp<span class="token punctuation">;</span>
    u64 size<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> flags<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span>name <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    
    addrp <span class="token operator">=</span> <span class="token function">of_get_address</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> index<span class="token punctuation">,</span> <span class="token operator">&amp;</span>size<span class="token punctuation">,</span> <span class="token operator">&amp;</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>addrp <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    
    <span class="token comment">/* Get optional "reg-names" property to add a name to a resource */</span>
    <span class="token function">of_property_read_string_index</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"reg-names"</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> <span class="token operator">&amp;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">__of_address_to_resource</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> addrp<span class="token punctuation">,</span> size<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> name<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第9 行，获取reg 属性的地址、大小和类型，在设备树中reg 属性已经存在了，所以这里会正确返回。<br>第14 行，读取reg-names 属性，由于设备树中没有定义这个属性，所以该函数不会有影响。<br>最后具有决定性作用的函数就是返回的__of_address_to_resource 函数了，跳转到该函数的定义如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">__of_address_to_resource</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>
                                    <span class="token keyword">const</span> __be32 <span class="token operator">*</span>addrp<span class="token punctuation">,</span> u64 size<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span>
                                    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">resource</span> <span class="token operator">*</span>r<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    u64 taddr<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> IORESOURCE_MEM<span class="token punctuation">)</span>
        taddr <span class="token operator">=</span> <span class="token function">of_translate_address</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> addrp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> IORESOURCE_IO<span class="token punctuation">)</span>
        taddr <span class="token operator">=</span> <span class="token function">of_translate_ioport</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> addrp<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>taddr <span class="token operator">==</span> OF_BAD_ADDR<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    
    <span class="token function">memset</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">resource</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    r<span class="token operator">-&gt;</span>start <span class="token operator">=</span> taddr<span class="token punctuation">;</span>
    r<span class="token operator">-&gt;</span>end <span class="token operator">=</span> taddr <span class="token operator">+</span> size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    r<span class="token operator">-&gt;</span>flags <span class="token operator">=</span> flags<span class="token punctuation">;</span>
    r<span class="token operator">-&gt;</span>name <span class="token operator">=</span> name <span class="token operator">?</span> name <span class="token operator">:</span> dev<span class="token operator">-&gt;</span>full_name<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>reg 属性的flags 为<code>IORESOURCE_MEM</code>，所以又会执行第9 行的<code>of_translate_address</code> 函数，跳转到该函数，该函数的定义如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">u64 <span class="token function">of_translate_address</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">const</span> __be32 <span class="token operator">*</span>in_addr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>host<span class="token punctuation">;</span>
    u64 ret<span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">__of_translate_address</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> in_addr<span class="token punctuation">,</span> <span class="token string">"ranges"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>host<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>host<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">of_node_put</span><span class="token punctuation">(</span>host<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> OF_BAD_ADDR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该函数的重点在第6 行，上述函数实际上是<code>__of_translate_address</code> 函数的封装，其中传入的第三个参数“ranges”是我们要关注的重点，继续跳转到该函数的定义，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> u64 <span class="token function">__of_translate_address</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span><span class="token keyword">const</span> __be32 <span class="token operator">*</span>in_addr<span class="token punctuation">,</span> 
                                  <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>rprop<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span><span class="token operator">*</span>host<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>parent <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">of_bus</span> <span class="token operator">*</span>bus<span class="token punctuation">,</span> <span class="token operator">*</span>pbus<span class="token punctuation">;</span>
    __be32 addr<span class="token punctuation">[</span>OF_MAX_ADDR_CELLS<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> na<span class="token punctuation">,</span> ns<span class="token punctuation">,</span> pna<span class="token punctuation">,</span> pns<span class="token punctuation">;</span>
    u64 result <span class="token operator">=</span> OF_BAD_ADDR<span class="token punctuation">;</span>
    
    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"** translation for device %pOF **\n"</span><span class="token punctuation">,</span> dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* Increase refcount at current level */</span>
    <span class="token function">of_node_get</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>host <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    
    
    <span class="token comment">/* Get parent &amp; match bus type */</span>
    parent <span class="token operator">=</span> <span class="token function">of_get_parent</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token keyword">goto</span> bail<span class="token punctuation">;</span>
    
    bus <span class="token operator">=</span> <span class="token function">of_match_bus</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* Count address cells &amp; copy address locally */</span>
    bus<span class="token operator">-&gt;</span><span class="token function">count_cells</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>na<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ns<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">OF_CHECK_COUNTS</span><span class="token punctuation">(</span>na<span class="token punctuation">,</span> ns<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"Bad cell count for %pOF\n"</span><span class="token punctuation">,</span> dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> bail<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> in_addr<span class="token punctuation">,</span> na <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"bus is %s (na=%d, ns=%d) on %pOF\n"</span><span class="token punctuation">,</span>bus<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> na<span class="token punctuation">,</span> ns<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">of_dump_addr</span><span class="token punctuation">(</span><span class="token string">"translating address:"</span><span class="token punctuation">,</span> addr<span class="token punctuation">,</span> na<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* Translate */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">logic_pio_hwaddr</span> <span class="token operator">*</span>iorange<span class="token punctuation">;</span>
        <span class="token comment">/* Switch to parent bus */</span>
        <span class="token function">of_node_put</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dev <span class="token operator">=</span> parent<span class="token punctuation">;</span>
        parent <span class="token operator">=</span> <span class="token function">of_get_parent</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* If root, we have finished */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"reached root node\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> <span class="token function">of_read_number</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> na<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    	<span class="token punctuation">}</span>
        
        <span class="token comment">/*
        * For indirectIO device which has no ranges property, get
        * the address from reg directly.
        */</span>
        iorange <span class="token operator">=</span> <span class="token function">find_io_range_by_fwnode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>fwnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>iorange <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>iorange<span class="token operator">-&gt;</span>flags <span class="token operator">!=</span> LOGIC_PIO_CPU_MMIO<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result <span class="token operator">=</span> <span class="token function">of_read_number</span><span class="token punctuation">(</span>addr <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> na <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"indirectIO matched(%pOF) 0x%llx\n"</span><span class="token punctuation">,</span>
            dev<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">*</span>host <span class="token operator">=</span> <span class="token function">of_node_get</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">/* Get new parent bus and counts */</span>
        pbus <span class="token operator">=</span> <span class="token function">of_match_bus</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pbus<span class="token operator">-&gt;</span><span class="token function">count_cells</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pna<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pns<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">OF_CHECK_COUNTS</span><span class="token punctuation">(</span>pna<span class="token punctuation">,</span> pns<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"Bad cell count for %pOF\n"</span><span class="token punctuation">,</span> dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"parent bus is %s (na=%d, ns=%d) on %pOF\n"</span><span class="token punctuation">,</span>pbus<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> pna<span class="token punctuation">,</span> pns<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">/* Apply bus translation */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">of_translate_one</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> bus<span class="token punctuation">,</span> pbus<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> na<span class="token punctuation">,</span> ns<span class="token punctuation">,</span> pna<span class="token punctuation">,</span> rprop<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        
        <span class="token comment">/* Complete the move up one level */</span>
        na <span class="token operator">=</span> pna<span class="token punctuation">;</span>
        ns <span class="token operator">=</span> pns<span class="token punctuation">;</span>
        bus <span class="token operator">=</span> pbus<span class="token punctuation">;</span>
        <span class="token function">of_dump_addr</span><span class="token punctuation">(</span><span class="token string">"one level translation:"</span><span class="token punctuation">,</span> addr<span class="token punctuation">,</span> na<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    bail<span class="token operator">:</span>
    <span class="token function">of_node_put</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">of_node_put</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第18 行，<code>parent = of_get_parent(dev);</code>获取父节点和匹配的总线类型<br>第24 行，<code>bus-&gt;count_cells(dev, &amp;na, &amp;ns);</code>获取address-cell 和size-cells<br>然后是一个for 循环，在76 行使用<code>of_translate_one</code> 函数进行转换，其中rprop 参数表示要转换的资源属性，该参数的值为传入的“ranges”，然后我们继续跳转到该函数，该函数的具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">of_translate_one</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>parent<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">of_bus</span> <span class="token operator">*</span>bus<span class="token punctuation">,</span>
                            <span class="token keyword">struct</span> <span class="token class-name">of_bus</span> <span class="token operator">*</span>pbus<span class="token punctuation">,</span> __be32 <span class="token operator">*</span>addr<span class="token punctuation">,</span>
                            <span class="token keyword">int</span> na<span class="token punctuation">,</span> <span class="token keyword">int</span> ns<span class="token punctuation">,</span> <span class="token keyword">int</span> pna<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>rprop<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">const</span> __be32 <span class="token operator">*</span>ranges<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> rlen<span class="token punctuation">;</span>
    <span class="token keyword">int</span> rone<span class="token punctuation">;</span>
    u64 offset <span class="token operator">=</span> OF_BAD_ADDR<span class="token punctuation">;</span>
    
    <span class="token comment">/*
    * Normally, an absence of a "ranges" property means we are
    * crossing a non-translatable boundary, and thus the addresses
    * below the current cannot be converted to CPU physical ones.
    * Unfortunately, while this is very clear in the spec, it's not
    * what Apple understood, and they do have things like /uni-n or
    * /ht nodes with no "ranges" property and a lot of perfectly
    * useable mapped devices below them. Thus we treat the absence of
    * "ranges" as equivalent to an empty "ranges" property which means
    * a 1:1 translation at that level. It's up to the caller not to try
    * to translate addresses that aren't supposed to be translated in
    * the first place. --BenH.
    *
    * As far as we know, this damage only exists on Apple machines, so
    * This code is only enabled on powerpc. --gcl
    */</span>
    ranges <span class="token operator">=</span> <span class="token function">of_get_property</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> rprop<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ranges <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">of_empty_ranges_quirk</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"no ranges; cannot translate\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ranges <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> rlen <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        offset <span class="token operator">=</span> <span class="token function">of_read_number</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> na<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">memset</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> pna <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"empty ranges; 1:1 translation\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> finish<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"walking ranges...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* Now walk through the ranges */</span>
    rlen <span class="token operator">/=</span> <span class="token number">4</span><span class="token punctuation">;</span>
    rone <span class="token operator">=</span> na <span class="token operator">+</span> pna <span class="token operator">+</span> ns<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> rlen <span class="token operator">&gt;=</span> rone<span class="token punctuation">;</span> rlen <span class="token operator">-=</span> rone<span class="token punctuation">,</span> ranges <span class="token operator">+=</span> rone<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        offset <span class="token operator">=</span> bus<span class="token operator">-&gt;</span><span class="token function">map</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> ranges<span class="token punctuation">,</span> na<span class="token punctuation">,</span> ns<span class="token punctuation">,</span> pna<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">!=</span> OF_BAD_ADDR<span class="token punctuation">)</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">==</span> OF_BAD_ADDR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"not found !\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> ranges <span class="token operator">+</span> na<span class="token punctuation">,</span> <span class="token number">4</span> <span class="token operator">*</span> pna<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    finish<span class="token operator">:</span>
    <span class="token function">of_dump_addr</span><span class="token punctuation">(</span><span class="token string">"parent translation for:"</span><span class="token punctuation">,</span> addr<span class="token punctuation">,</span> pna<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"with offset: %llx\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* Translate it into parent bus space */</span>
    <span class="token keyword">return</span> pbus<span class="token operator">-&gt;</span><span class="token function">translate</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> pna<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在该函数的第26 行使用<code>of_get_property</code> 函数获取“ranges”属性，但由于在我们添加的设备树节点中并没有该属性，所以这里的ranges 值就为NULL，第27 行的条件判断成立，也就会返回1。<br>接下来再根据这个返回值继续分析上级函数:<code>of_translate_one</code> 函数返回1 之后，上一级的<code>_of_translate_address</code> 的返回值就为<code>OF BADADDR</code>，再上一级的<code>of_translate_address</code> 返回值也是<code>OF BAD _ADDR</code>，继续向上查找<code>_of_address_to_resource</code> 函数会返回<code>EINVAL</code>，<code>of address_ to resource</code> 返回<code>EINVAL</code>，所以<code>num_reg</code> 为0;到这里关于为什么<code>platform_get_resource</code> 函数获取资源失败的问题就找到了，只是因为在设备树中并没有这个名为<code>ranges</code> 这个属性，所以只需要对设备树进行<code>ranges</code> 属性的添加即可，要修改的设备树为<code>arch/arm64/boot/dts/rockchip/rk3568-evb1-ddr4-v10-linux.dts</code>，修改完成如下（图68-3）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291000567.png" alt="image-20240829100053478"></p>
<p>然后重新编译内核，将编译生成的<code>boot.img</code> 烧写进开发板之后重新加载上面编写的驱动程序，可以看到之前获取失败的打印就消失了，而且成功打印出了reg 属性的第一个值，如下图（图68-4）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291001485.png" alt="image-20240829100114406"></p>
<p>虽然这里的问题解决了，但引起的思考并没有结束，那我们在这里添加的ranges 属性的作用是啥呢，带着疑问，开始下一小节的学习吧。</p>
<h3 id="68-2-ranges-属性"><a href="#68-2-ranges-属性" class="headerlink" title="68.2 ranges 属性"></a>68.2 ranges 属性</h3><h4 id="68-2-1-ranges-属性介绍"><a href="#68-2-1-ranges-属性介绍" class="headerlink" title="68.2.1 ranges 属性介绍"></a>68.2.1 ranges 属性介绍</h4><p>ranges 属性是一种用于描述设备之间地址映射关系的属性。它在设备树（Device Tree）中使用，用于描述子设备地址空间如何映射到父设备地址空间。设备树是一种硬件描述语言，用于描述嵌入式系统中的硬件组件和它们之间的连接关系。</p>
<p>设备树中的每个设备节点都可以具有ranges 属性，其中包含了地址映射的信息。下面是一个常见的格式：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">ranges <span class="token operator">=</span> <span class="token operator">&lt;</span>child<span class="token operator">-</span>bus<span class="token operator">-</span>address parent<span class="token operator">-</span>bus<span class="token operator">-</span>address length<span class="token operator">&gt;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>或者</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">ranges<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后对上述格式中每个部分进行解释：</p>
<ul>
<li><code>child-bus-address</code>：子设备地址空间的起始地址。它指定了子设备在父设备地址空间中的位置。具体的字长由ranges 所在节点的<code>#address-cells</code> 属性决定。</li>
<li><code>parent-bus-address</code>：父设备地址空间的起始地址。它指定了父设备中用于映射子设备的地址范围。具体的字长由ranges 的父节点的<code>#address-cells</code> 属性决定。</li>
<li><code>length</code>：映射的大小。它指定了子设备地址空间在父设备地址空间中的长度。具体的字长由ranges 的父节点的#size-cells 属性决定。</li>
<li>当<code>ranges</code> 属性的值为空时，表示子设备地址空间和父设备地址空间具有完全相同的映射，即1:1 映射。这通常用于描述内存区域，其中子设备和父设备具有相同的地址范围。</li>
<li>当<code>ranges</code> 属性的值不为空时，按照指定的映射规则将子设备地址空间映射到父设备地址空间。具体的映射规则取决于设备树的结构和设备的特定要求。</li>
</ul>
<p>然后以下面的设备树为例进行ranges 属性的讲解，设备树内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token operator">/</span>dts<span class="token operator">-</span>v1<span class="token operator">/</span><span class="token punctuation">;</span>
<span class="token operator">/</span> <span class="token punctuation">{</span>
    compatible <span class="token operator">=</span> <span class="token string">"acme,coyotes-revenge"</span><span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    external<span class="token operator">-</span>bus <span class="token punctuation">{</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
        ranges <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span> <span class="token number">0</span> <span class="token number">0x10100000</span> <span class="token number">0x10000</span>
                    <span class="token number">1</span> <span class="token number">0</span> <span class="token number">0x10160000</span> <span class="token number">0x10000</span>
                    <span class="token number">2</span> <span class="token number">0</span> <span class="token number">0x30000000</span> <span class="token number">0x30000000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        <span class="token comment">// Chipselect 1, Ethernet</span>
        <span class="token comment">// Chipselect 2, i2c controller</span>
        <span class="token comment">// Chipselect 3, NOR Flash</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里以ranges 的第一个属性值为例进行具体解释如下：<br>在<code>external-bus</code> 节点中<code>#address-cells</code> 属性值为2 表示<code>child-bus-address</code> 由两个值表示，也就是0 和0，父节点的<code>#address-cells</code> 属性值和<code>#size-cells</code> 属性值为1，表示<code>parent-bus-address</code>和<code>length</code> 都由一个表示，也就是<code>0x10100000</code> 和<code>0x10000</code>，该ranges 值表示将子地址空间（0x0-0xFFFF）映射到父地址空间0x10100000 - x1010FFFF，这里的例子为带参数ranges 属性映射，不带参数的ranges 属性为1：1 映射，较为简单，这里不再进行举例。</p>
<p>在嵌入式系统中，不同的设备可能连接到相同的总线或总线控制器上，它们需要在物理地址空间中进行正确的映射，以便进行数据交换和通信。例如，一个设备可能通过总线连接到主处理器或其他设备，而这些设备的物理地址范围可能不同。ranges 属性就是用来描述这种地址映射关系的。</p>
<h4 id="68-2-2-设备分类"><a href="#68-2-2-设备分类" class="headerlink" title="68.2.2 设备分类"></a>68.2.2 设备分类</h4><p>根据上面讲解的映射关系可以将设备分为两类：内存映射型设备和非内存映射型设备。</p>
<p><strong>（1）内存映射型设备：</strong></p>
<p><strong>内存映射型设备是指可以通过内存地址进行直接访问的设备</strong>。这类设备在物理地址空间中的一部分被映射到系统的内存地址空间中，使得CPU 可以通过读写内存地址的方式与设备进行通信和控制。</p>
<p>特点：<br>（1）直接访问：内存映射型设备可以被CPU 直接访问，类似于访问内存中的数据。这种直接访问方式提供了高速的数据传输和低延迟的设备操作。<br>（2）内存映射：设备的寄存器、缓冲区等资源被映射到系统的内存地址空间中，使用读写内存的方式与设备进行通信。<br>（3）读写操作：CPU 可以通过读取和写入映射的内存地址来与设备进行数据交换和控制操作。</p>
<p>在设备树中，内存映射型设备的设备树举例如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token operator">/</span>dts<span class="token operator">-</span>v1<span class="token operator">/</span><span class="token punctuation">;</span>
<span class="token operator">/</span> <span class="token punctuation">{</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    ranges<span class="token punctuation">;</span>
    serial@<span class="token number">101f</span><span class="token number">0000</span> <span class="token punctuation">{</span>
        compatible <span class="token operator">=</span> <span class="token string">"arm,pl011"</span><span class="token punctuation">;</span>
        reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x101f0000</span> <span class="token number">0x1000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    gpio@<span class="token number">101f</span><span class="token number">3000</span> <span class="token punctuation">{</span>
        compatible <span class="token operator">=</span> <span class="token string">"arm,pl061"</span><span class="token punctuation">;</span>
        reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x101f3000</span> <span class="token number">0x1000</span>
        <span class="token number">0x101f4000</span> <span class="token number">0x10</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    spi@<span class="token number">10115000</span> <span class="token punctuation">{</span>
        compatible <span class="token operator">=</span> <span class="token string">"arm,pl022"</span><span class="token punctuation">;</span>
        reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x10115000</span> <span class="token number">0x1000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第5 行的ranges 属性表示该设备树中会进行1：1 的地址范围映射。	</p>
<p><strong>（2）非内存映射型设备：</strong></p>
<p><strong>非内存映射型设备是指不能通过内存地址直接访问的设备</strong>。这类设备可能采用其他方式与CPU 进行通信，例如通过I/O 端口、专用总线或特定的通信协议。</p>
<p><strong>特点：</strong></p>
<ul>
<li>（1）非内存访问：非内存映射型设备不能像内存映射型设备那样直接通过内存地址进行访问。它们可能使用独立的I/O 端口或专用总线进行通信。</li>
<li>（2）特定接口：设备通常使用特定的接口和协议与CPU 进行通信和控制，例如SPI、I2C、UART 等。</li>
<li>（3）驱动程序：非内存映射型设备通常需要特定的设备驱动程序来实现与CPU 的通信和控制。</li>
</ul>
<p>在设备树中，非内存映射型设备的设备树举例如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token operator">/</span>dts<span class="token operator">-</span>v1<span class="token operator">/</span><span class="token punctuation">;</span>
<span class="token operator">/</span> <span class="token punctuation">{</span>
    compatible <span class="token operator">=</span> <span class="token string">"acme,coyotes-revenge"</span><span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    external<span class="token operator">-</span>bus <span class="token punctuation">{</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
        ranges <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span> <span class="token number">0</span> <span class="token number">0x10100000</span> <span class="token number">0x10000</span>
                <span class="token number">1</span> <span class="token number">0</span> <span class="token number">0x10160000</span> <span class="token number">0x10000</span>
                <span class="token number">2</span> <span class="token number">0</span> <span class="token number">0x30000000</span> <span class="token number">0x30000000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        
        <span class="token comment">// Chipselect 1, Ethernet</span>
        <span class="token comment">// Chipselect 2, i2c controller</span>
        <span class="token comment">// Chipselect 3, NOR Flash</span>
        ethernet@<span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span> <span class="token punctuation">{</span>
            compatible <span class="token operator">=</span> <span class="token string">"smc,smc91c111"</span><span class="token punctuation">;</span>
            reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span> <span class="token number">0</span> <span class="token number">0x1000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        
        i2c@<span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span> <span class="token punctuation">{</span>
            compatible <span class="token operator">=</span> <span class="token string">"acme,a1234-i2c-bus"</span><span class="token punctuation">;</span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
            reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span> <span class="token number">0</span> <span class="token number">0x1000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
            rtc@<span class="token number">58</span> <span class="token punctuation">{</span>
                compatible <span class="token operator">=</span> <span class="token string">"maxim,ds1338"</span><span class="token punctuation">;</span>
                reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x58</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="68-2-3-映射地址计算"><a href="#68-2-3-映射地址计算" class="headerlink" title="68.2.3 映射地址计算"></a>68.2.3 映射地址计算</h4><p>接下来以上面列举的非内存映射型设备的设备树中的ethernet@0 节点为例，计算该网卡设备的映射地址。<br>首先，找到ethernet@0 所在的节点，并查看其reg 属性。在给定的设备树片段中，ethernet@0 的reg 属性为<code>&lt;0 0 0x1000&gt;</code>。在根节点中，<code>#address-cells</code> 的值为1，表示地址由一个单元格组成。</p>
<p>接下来，根据ranges 属性进行地址映射计算。在external-bus 节点的ranges 属性中，有三个映射条目：</p>
<ul>
<li>第一个映射条目为“<code>0 0 0x10100000 0x10000</code>”，表示外部总线的地址范围为<code>0x10100000</code>到<code>0x1010FFFF</code>。该映射条目的第一个值为0，表示与<code>external-bus</code> 节点的第一个子节点（ethernet@0,0）相关联。</li>
<li>第二个映射条目：“<code>1 0 0x10160000 0x10000</code>”，表示外部总线的地址范围为<code>0x10160000</code>到<code>0x1016FFFF</code>。该映射条目的第一个值为1，表示与<code>external-bus</code> 节点的第二个子节点（i2c@1,0）相关联。</li>
<li>第三个映射条目：“<code>2 0 0x30000000 0x30000000</code>”，表示外部总线的地址范围为<code>0x30000000</code>到<code>0x5FFFFFFF</code>。该映射条目的第一个值为2，表示与<code>external-bus</code> 节点的第三个子节点相关联。</li>
</ul>
<p>由于ethernet@0 与external-bus 的第一个子节点相关联，并且它的reg 属性为&lt;0 0 0x1000&gt;，我们可以进行以下计算：<br>ethernet@0 的物理起始地址= 外部总线地址起始值=0x10100000<br>ethernet@0 的物理结束地址= 外部总线地址起始值+ （ethernet@0 的reg 属性的第二个值-1）<br>= 0x10100000 + 0xFFF<br>= 0x10100FFF<br>因此，ethernet@0 的物理地址范围为0x10100000 - 0x10100FFF，至此，关于映射地址的计算就讲解完成了，大家可以根据同样的方法计算i2c@1 的物理地址。</p>
<h2 id="第69-章of-操作函数实验：获取中断资源"><a href="#第69-章of-操作函数实验：获取中断资源" class="headerlink" title="第69 章of 操作函数实验：获取中断资源"></a>第69 章of 操作函数实验：获取中断资源</h2><h3 id="69-1-of-操作：获取中断资源"><a href="#69-1-of-操作：获取中断资源" class="headerlink" title="69.1 of 操作：获取中断资源"></a>69.1 of 操作：获取中断资源</h3><h4 id="69-1-1-irq-of-parse-and-map-函数"><a href="#69-1-1-irq-of-parse-and-map-函数" class="headerlink" title="69.1.1 irq_of_parse_and_map 函数"></a>69.1.1 <code>irq_of_parse_and_map</code> 函数</h4><p>该函数的主要功能是解析设备节点的”interrupts”属性，并将对应的中断号映射到系统的中断号。”interrupts”属性通常以一种特定的格式表示，可以包含一个或多个中断号。通过提供索引号，可以获取对应的中断号。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">函数原型：
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">irq_of_parse_and_map</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
头文件：
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of_irq.h&gt;</span></span>
函数作用：
    从设备节点的<span class="token string">"interrupts"</span>属性中解析和映射对应的中断号
参数说明：
    dev：设备节点，表示要解析的设备节点。
    index：索引号，表示从<span class="token string">"interrupts"</span>属性中获取第几个中断号。
返回值：
    是一个无符号整数，表示成功解析和映射的中断号。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="69-1-2-irq-get-trigger-type-函数"><a href="#69-1-2-irq-get-trigger-type-函数" class="headerlink" title="69.1.2 irq_get_trigger_type 函数"></a>69.1.2 <code>irq_get_trigger_type</code> 函数</h4><p>该函数的主要功能是从给定的中断数据结构中提取中断触发类型。中断触发类型描述了中断信号的触发条件，例如边沿触发（edge-triggered）或电平触发（level-triggered）等。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">函数原型：
    u32 <span class="token function">irqd_get_trigger_type</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">irq_data</span> <span class="token operator">*</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
头文件：
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/irq.h&gt;</span></span>
函数作用：
    从中断数据结构（irq_data）中获取对应的中断触发类型。
参数说明：
    d：中断数据结构（irq_data），表示要获取中断触发类型的中断。
返回值：
    是一个无符号<span class="token number">32</span> 位整数，表示成功获取的中断触发类型。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="69-1-3-irq-get-irq-data-函数"><a href="#69-1-3-irq-get-irq-data-函数" class="headerlink" title="69.1.3 irq_get_irq_data 函数"></a>69.1.3 irq_get_irq_data 函数</h4><p>函数irq_get_irq_data 的作用是根据中断号获取对应的中断数据结构（irq_data）。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">函数原型：
    <span class="token keyword">struct</span> <span class="token class-name">irq_data</span> <span class="token operator">*</span><span class="token function">irq_get_irq_data</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> irq<span class="token punctuation">)</span><span class="token punctuation">;</span>
头文件：
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/irq.h&gt;</span></span>
函数作用：
    根据中断号获取对应的中断数据结构。
参数说明：
    irq：中断号，表示要获取中断数据结构的中断号。
返回值：
    指向irq_data 结构体的指针，表示成功获取的中断数据结构。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="69-1-4-gpio-to-irq-函数"><a href="#69-1-4-gpio-to-irq-函数" class="headerlink" title="69.1.4 gpio_to_irq 函数"></a>69.1.4 gpio_to_irq 函数</h4><p>该函数的主要功能是将给定的GPIO 编号转换为对应的中断号。在某些系统中，GPIO 可以配置为中断引脚，当特定事件发生时触发中断。通过该函数，可以根据GPIO 编号获取与之关联的中断号，以便进行中断处理等操作。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">函数原型：
    <span class="token keyword">int</span> <span class="token function">gpio_to_irq</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> gpio<span class="token punctuation">)</span><span class="token punctuation">;</span>
头文件：
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/gpio.h&gt;</span></span>
函数作用：
    根据GPIO 编号获取对应的中断号。
参数说明：
    gpio：GPIO 编号，表示要获取中断号的GPIO。
返回值：
    是一个整数，表示成功获取的中断号。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="69-1-5-of-irq-get-函数"><a href="#69-1-5-of-irq-get-函数" class="headerlink" title="69.1.5 of_irq_get 函数"></a>69.1.5 <code>of_irq_get</code> 函数</h4><p>该函数的主要功能是从给定的设备节点的”interrupts”属性中解析并获取对应的中断号。”interrupts”属性通常以一种特定的格式表示，可以包含一个或多个中断号。通过提供索引号，可以获取对应的中断号</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">函数原型：
    <span class="token keyword">int</span> <span class="token function">of_irq_get</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
头文件：
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of_irq.h&gt;</span></span>
函数作用：
    是从设备节点的<span class="token string">"interrupts"</span>属性中获取对应的中断号。
参数说明：
    dev：设备节点，表示要获取中断号的设备节点。
    index：索引号，表示从<span class="token string">"interrupts"</span>属性中获取第几个中断号。
返回值：
    是一个整数，表示成功获取的中断号。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="69-1-6-platform-get-irq-函数"><a href="#69-1-6-platform-get-irq-函数" class="headerlink" title="69.1.6 platform_get_irq 函数"></a>69.1.6 <code>platform_get_irq</code> 函数</h4><p><code>platform_get_irq</code> 函数的主要功能是根据给定的平台设备和索引号获取对应的中断号。平台设备是指与特定硬件平台相关的设备。在某些情况下，平台设备可能具有多个中断号，通过提供索引号，可以获取对应的中断号。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">函数原型：
    <span class="token keyword">int</span> <span class="token function">platform_get_irq</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
函数作用：
    根据平台设备和索引号获取对应的中断号。
头文件：
    linux<span class="token operator">/</span>platform_device<span class="token punctuation">.</span>h
参数说明：
    dev：平台设备，表示要获取中断号的平台设备。
    num：索引号，表示从中获取第几个中断号。
返回值：
    是一个整数，表示成功获取的中断号。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="69-2-实验程序编写"><a href="#69-2-实验程序编写" class="headerlink" title="69.2 实验程序编写"></a>69.2 实验程序编写</h3><h4 id="69-2-1-设备树的修改"><a href="#69-2-1-设备树的修改" class="headerlink" title="69.2.1 设备树的修改"></a>69.2.1 设备树的修改</h4><p>本实验修改完成的设备树和编译完成的boot.img 对应的网盘路径为：<code>iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568 开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\57_of_03\dts</code>。</p>
<p>由于本章节要获取的是中断相关的资源，所以需要在设备树中添加有关中断的设备节点，在第57 章节的学习中，我们已经对中断实例进行了讲解，所以这里直接对<code>rk3568-evb1-ddr4-v10-linux.dts</code> 设备树进行中断节点的添加，添加的内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">myirq <span class="token punctuation">{</span>
    compatible <span class="token operator">=</span> <span class="token string">"my_devicetree_irq"</span><span class="token punctuation">;</span>
    interrupt<span class="token operator">-</span>parent <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio3<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span>RK_PA5 IRQ_TYPE_LEVEL_LOW<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>添加完成如下图（图69-1）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291041774.png" alt="image-20240829104143669"></p>
<p>保存退出之后，重新编译内核源码，得到boot.img 内核镜像之后烧写到开发板即可。</p>
<h4 id="69-2-2-实验程序的编写"><a href="#69-2-2-实验程序的编写" class="headerlink" title="69.2.2 实验程序的编写"></a>69.2.2 实验程序的编写</h4><p>本实验驱动对应的网盘路径为：<code>iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\57_of_03</code>。</p>
<p>本小节驱动程序是由65 章驱动程序修改而来，由于本章节获取中断属性的函数需要在查找到设备树节点的前提下使用，所以在下面的程序中，先在probe 函数中查找设备树节点，然后添加了本章节学习的of 操作相关代码和其他一些相关的函数，用来获取设备树节点中断资源。</p>
<p>编写完成的<code>platform_driver.c</code> 代码如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/platform_device.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mod_devicetable.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of_irq.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/gpio.h&gt;</span></span>
<span class="token keyword">int</span> num<span class="token punctuation">;</span>
<span class="token keyword">int</span> irq<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">irq_data</span> <span class="token operator">*</span>my_irq_data<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>mydevice_node<span class="token punctuation">;</span>
u32 trigger_type<span class="token punctuation">;</span>

<span class="token comment">// 平台设备的初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">my_platform_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"my_platform_probe: Probing platform device\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 查找设备节点</span>
    mydevice_node <span class="token operator">=</span> <span class="token function">of_find_node_by_name</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"myirq"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 解析和映射中断</span>
    irq <span class="token operator">=</span> <span class="token function">irq_of_parse_and_map</span><span class="token punctuation">(</span>mydevice_node<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"irq is %d\n"</span><span class="token punctuation">,</span> irq<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 获取中断数据结构</span>
    my_irq_data <span class="token operator">=</span> <span class="token function">irq_get_irq_data</span><span class="token punctuation">(</span>irq<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取中断触发类型</span>
    trigger_type <span class="token operator">=</span> <span class="token function">irqd_get_trigger_type</span><span class="token punctuation">(</span>my_irq_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"trigger type is 0x%x\n"</span><span class="token punctuation">,</span> trigger_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 将GPIO转换为中断号</span>
    irq <span class="token operator">=</span> <span class="token function">gpio_to_irq</span><span class="token punctuation">(</span><span class="token number">101</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"irq is %d\n"</span><span class="token punctuation">,</span> irq<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 从设备节点获取中断号</span>
    irq <span class="token operator">=</span> <span class="token function">of_irq_get</span><span class="token punctuation">(</span>mydevice_node<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"irq is %d\n"</span><span class="token punctuation">,</span> irq<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 获取平台设备的中断号</span>
    irq <span class="token operator">=</span> <span class="token function">platform_get_irq</span><span class="token punctuation">(</span>pdev<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"irq is %d\n"</span><span class="token punctuation">,</span> irq<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 平台设备的移除函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">my_platform_remove</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"my_platform_remove: Removing platform device\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 清理设备特定的操作</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> of_match_table_id<span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">{</span><span class="token punctuation">.</span>compatible<span class="token operator">=</span><span class="token string">"my_devicetree_irq"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义平台驱动结构体</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">platform_driver</span> my_platform_driver <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>probe <span class="token operator">=</span> my_platform_probe<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>remove <span class="token operator">=</span> my_platform_remove<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>driver <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"my_platform_device"</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
		<span class="token punctuation">.</span>of_match_table <span class="token operator">=</span>  of_match_table_id<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 模块初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">my_platform_driver_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    <span class="token comment">// 注册平台驱动</span>
    ret <span class="token operator">=</span> <span class="token function">platform_driver_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_platform_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"Failed to register platform driver\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"my_platform_driver: Platform driver initialized\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 模块退出函数</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">my_platform_driver_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 注销平台驱动</span>
    <span class="token function">platform_driver_unregister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_platform_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"my_platform_driver: Platform driver exited\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>my_platform_driver_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>my_platform_driver_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"topeet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="69-3-运行测试"><a href="#69-3-运行测试" class="headerlink" title="69.3 运行测试"></a>69.3 运行测试</h3><h4 id="69-3-1-编译驱动程序"><a href="#69-3-1-编译驱动程序" class="headerlink" title="69.3.1 编译驱动程序"></a>69.3.1 编译驱动程序</h4><p>对于Makefile 的内容注释已在上图添加，保存退出之后，来到存放platform_driver.c 和Makefile 文件目录下，如下图（图69-2）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291046613.png" alt="image-20240829104603535"></p>
<p>然后使用命令“make”进行驱动的编译，编译完生成platform_driver.ko 目标文件，至此驱动模块就编译成功了。</p>
<h4 id="69-3-2-运行测试"><a href="#69-3-2-运行测试" class="headerlink" title="69.3.2 运行测试"></a>69.3.2 运行测试</h4><p>在进行实验之前，首先要确保开发板烧写的是我们在69.2.1 小节中编译出来的boot.img，开发板启动之后，使用以下命令进行驱动模块的加载，如下图（图69-5）所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">insmod platform_driver.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291046718.png" alt="image-20240829104637622"></p>
<p>可以看到总共有5 个打印，第1、3、4、5 个打印都是获取的中断号为113，第2 个打印的是中断的类型， 即<code>IRQ_TYPE_LEVEL_LOW</code> ， 该触发类型的宏定义在内核源码“include/dt-bindings/interrupt-controller/irq.h”目录下，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRQ_TYPE_NONE</span> <span class="token expression"><span class="token number">0</span> </span><span class="token comment">// 无中断触发类型</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRQ_TYPE_EDGE_RISING</span> <span class="token expression"><span class="token number">1</span> </span><span class="token comment">// 上升沿触发</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRQ_TYPE_EDGE_FALLING</span> <span class="token expression"><span class="token number">2</span> </span><span class="token comment">// 下降沿触发</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRQ_TYPE_EDGE_BOTH</span> <span class="token expression"><span class="token punctuation">(</span>IRQ_TYPE_EDGE_FALLING <span class="token operator">|</span> IRQ_TYPE_EDGE_RISING<span class="token punctuation">)</span></span><span class="token comment">// 双边沿触发</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRQ_TYPE_LEVEL_HIGH</span> <span class="token expression"><span class="token number">4</span> </span><span class="token comment">// 高电平触发</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRQ_TYPE_LEVEL_LOW</span> <span class="token expression"><span class="token number">8</span> </span><span class="token comment">// 低电平触发</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看到<code>IRQ_TYPE_LEVEL_LOW</code> 的宏定义为8，证明上面的打印正确。<br>然后使用以下命令进行驱动模块的卸载，如下图（图69-6）所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">rmmod platform_driver.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291047970.png" alt="image-20240829104730890"></p>
<p>至此，使用of 操作函数获取中断资源实验就完成了。</p>
<h2 id="第70-章参考文档：设备树bindings"><a href="#第70-章参考文档：设备树bindings" class="headerlink" title="第70 章参考文档：设备树bindings"></a>第70 章参考文档：设备树bindings</h2><p>在前面的章节中，我们已经介绍了许多设备树编写相关的知识，当然上面我们讲解的都是标准属性，但当我们遇到非标准属性或无法理解的属性时，要如何处理呢？这时候就不得不提到bindings 文档了。</p>
<p><code>Documentation/devicetree/bindings</code> 目录是Linux 内核源码中的一个重要目录，用于存储设备树（Device Tree）的bindings 文档。设备树是一种描述硬件平台和设备配置的数据结构，它以一种可移植和独立于具体硬件的方式描述了设备的属性、寄存器配置、中断信息等。</p>
<p>bindings 目录中的文档提供了有关设备树的各种设备和驱动程序的详细说明和用法示例。这些文档对于开发人员来说非常重要，因为它们提供了在设备树中描述硬件和配置驱动程序所需的属性和约定。bindings 目录截图如下（图70-1）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291048384.png" alt="image-20240829104812252"></p>
<p>接下来对Documentation/devicetree/bindings 目录的一些常见子目录和其内容的概述：</p>
<ul>
<li>arm：包含与ARM 体系结构相关的设备和驱动程序的bindings 文档。</li>
<li>clock：包含与时钟设备和时钟控制器相关的bindings 文档。</li>
<li>dma：包含与直接内存访问（DMA）控制器和设备相关的bindings 文档。</li>
<li>gpio：包含与通用输入输出（GPIO）控制器和设备相关的bindings 文档。</li>
<li>i2c：包含与I2C 总线和设备相关的bindings 文档。</li>
<li>interrupt-controller：包含与中断控制器相关的bindings 文档。</li>
<li>media：包含与多媒体设备和驱动程序相关的bindings 文档。</li>
<li>mfd：包含与多功能设备（MFD）子系统和设备相关的bindings 文档。</li>
<li>networking：包含与网络设备和驱动程序相关的bindings 文档。</li>
<li>power：包含与电源管理子系统和设备相关的bindings 文档。</li>
<li>spi：包含与SPI 总线和设备相关的bindings 文档。</li>
<li>usb：包含与USB 控制器和设备相关的bindings 文档。</li>
<li>video：包含与视频设备和驱动程序相关的bindings 文档。</li>
</ul>
<p>每个子目录中的文档通常以.txt 或.yaml 的扩展名保存，使用文本或YAML 格式编写。这些文档提供了有关设备树中属性的详细说明、属性的语法、可选值和用法示例。它们还描述了设备树的约定和最佳实践，以帮助开发人员正确地配置和描述硬件设备和驱动程序。</p>
<p>通过阅读Documentation/devicetree/bindings 目录中的文档，开发人员可以了解各种设备和驱动程序的设备树属性的含义和用法，以便正确地配置和描述硬件平台和设备。这有助于实现硬件与软件之间的正确匹配和交互，使系统能够正确识别和使用硬件设备。</p>
<h1 id="第八篇设备树插件"><a href="#第八篇设备树插件" class="headerlink" title="第八篇设备树插件"></a>第八篇设备树插件</h1><h2 id="第71-章设备树插件介绍"><a href="#第71-章设备树插件介绍" class="headerlink" title="第71 章设备树插件介绍"></a>第71 章设备树插件介绍</h2><p>在上一篇中，我们学习了设备树的相关内容，那么本篇开始学习设备树的扩展机制——设备树插件。下面让我们一起进入设备树插件的学习吧。</p>
<h3 id="71-1-什么是设备树插件"><a href="#71-1-什么是设备树插件" class="headerlink" title="71.1 什么是设备树插件"></a>71.1 什么是设备树插件</h3><p>Linux4.4 以后引入了动态设备树（Dynamic DeviceTree）。设备树插件（Device Tree Overlay）是一种用于设备树（Device Tree）的扩展机制。设备树是一种用于描述硬件设备的数据结构，广泛应用于嵌入式系统中，特别是基于Linux 内核的系统中。</p>
<p><strong>设备树插件允许在运行时动态修改设备树的内容，以便添加，修改或删除设备节点和属性</strong>。它提供了一种灵活的方式来配置和管理硬件设备，而无需重新编译整个设备树。通过使用设备树插件，开发人员可以在不重新启动系统的情况下对硬件进行配置更改。</p>
<p>设备树插件（Dynamic DeviceTree）通常以一种文本格式定义，称为设备树源文件（DeviceTree Source,DTS）。DTS 文件描述了设备树的结构和属性，包括设备节点，寄存器地址，中断信息等。设备树插件可以通过加载和解析设备树文件，并将其合并到现有的设备树中，从而实现对设备树的动态修改。</p>
<h3 id="71-2-设备树插件的应用场景"><a href="#71-2-设备树插件的应用场景" class="headerlink" title="71.2 设备树插件的应用场景"></a>71.2 设备树插件的应用场景</h3><p>使用设备树插件，可以实现一些常见的配置变化，比如添加外部设备，禁用不需要的设备，修改设备属性等。这对于嵌入式系统的开发和调试非常有用，特别是面对多种硬件配置或需要频繁更改硬件配置的情况下。</p>
<h2 id="第72-章设备树插件语法和编译实验"><a href="#第72-章设备树插件语法和编译实验" class="headerlink" title="第72 章设备树插件语法和编译实验"></a>第72 章设备树插件语法和编译实验</h2><p>在上一章节中，我们介绍了设备树插件和概念和作用，本章节将继续深入探讨设备树插件，重点关注其语法和编译过程。无论是在嵌入式系统开发还是设备驱动开发中，掌握设备树插件的语法和编译过程都是非常重要的。接下来，让我们一起深入了解这些内容，为更好地应用设备树插件打下坚实的基础。</p>
<h3 id="72-1-设备树插件语法"><a href="#72-1-设备树插件语法" class="headerlink" title="72.1 设备树插件语法"></a>72.1 设备树插件语法</h3><p>设备树插件的语法格式基于设备树源文件的语法，但是有一些特定的语法和指令用于描述插件的行为。下面是设备树插件语法格式的一般结构和示例。我们新建overlay.dts，如下（图72- 1）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291052247.png" alt="image-20240829105225168"></p>
<p>我们编写overlay.dts，如下所示：<br>1 首先添加插件头部声明，它指定了插件的名称和版本等信息，并指定了要修改的设备树的路径，如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token operator">/</span>dts<span class="token operator">-</span>v1<span class="token operator">/</span><span class="token punctuation">;</span>
<span class="token operator">/</span>plugin<span class="token operator">/</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>2 插件节点名称用于定义要添加，修改或删除的设备节点及其属性。它使用与设备树源文件相同的语法，但在节点名称前面使用特定的修饰符来指示插件的操作。比如设备树中rs485 节点为如下所示，rs485 节点位于（图72- 2）根节点下。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291053058.png" alt="image-20240829105303972"></p>
<p>那么我们如果在设备树插件中要为这个节点添加overlay_node 节点，可以有如下几种表达方式：</p>
<img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291053990.png" alt="image-20240829105314902" style="zoom:67%;">

<img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291053504.png" alt="image-20240829105329417" style="zoom:67%;">

<p>这四种方式是等效的，大家了解即可。</p>
<h3 id="72-2-设备树插件编译"><a href="#72-2-设备树插件编译" class="headerlink" title="72.2 设备树插件编译"></a>72.2 设备树插件编译</h3><p>我们将上个小节编写的overlay.dts 的方法二三四注释掉，保留方法一，然后编译设备树插件overlay.dts，输入以下命令：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/home/topeet/Linux/linux_sdk/kernel/scripts/dtc/dtc <span class="token parameter variable">-I</span> dts <span class="token parameter variable">-O</span> dtb overlay.dts <span class="token parameter variable">-o</span> overlay.dtbo<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291054777.png" alt="image-20240829105435697"></p>
<p>反编译设备树，输入以下命令：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/home/topeet/Linux/linux_sdk/kernel/scripts/dtc/dtc <span class="token parameter variable">-I</span> dtb <span class="token parameter variable">-O</span> dts overlay.dtbo <span class="token parameter variable">-o</span> <span class="token number">1</span>.dts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291055781.png" alt="image-20240829105503704"></p>
<p>反编译成功之后，查看1.dts,可以比较下overlay.dts 和1.dts 的区别。通过反编译设备树有助于理解和修改设备树配置，帮助开发者更好地进行系统开发，调试和故障排除。</p>
<h2 id="第73-章设备树插件使用实验"><a href="#第73-章设备树插件使用实验" class="headerlink" title="第73 章设备树插件使用实验"></a>第73 章设备树插件使用实验</h2><p>在上一章节中，我们详细介绍了设备树插件的语法和编译过程，为了更好地理解和应用这些知识，本章节将重点关注设备树插件在实际实验操作中的使用方法。让我们开始实际使用设备树插件吧！</p>
<h3 id="73-1-准备实验环境"><a href="#73-1-准备实验环境" class="headerlink" title="73.1 准备实验环境"></a>73.1 准备实验环境</h3><p>我们首先烧写网盘资料“<code>iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568 开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\65_dtbocfg</code>”目录下的Linux 系统镜像，然后将设备树插件dtbocfg.ko 拷贝到系统中，最后使用“insmod dtbocfg.ko”命令加载驱动，如下（图73-1）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291055328.png" alt="image-20240829105538246"></p>
<p>然后输入命令cat proc/filesystems 检查configfs 是否挂载成功。挂载成功如下（图73-2）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291056096.png" alt="image-20240829105605010"></p>
<h3 id="73-2-设备树插件的使用"><a href="#73-2-设备树插件的使用" class="headerlink" title="73.2 设备树插件的使用"></a>73.2 设备树插件的使用</h3><p>在上一个小节中，我们烧写了支持设备树插件的内核镜像，并且加载了dtbocfg.ko。在此基础上，本小节来讲述如何使用设备树插件。<br>在上一章节中，我们编写了overlay.dts。在overlay.dts 中，rk-485-ctl 节点下添加新的节点overlay_node 节点，如下（图73-3）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291056882.png" alt="image-20240829105623804"></p>
<p>使用dtc 编译器编译得到dtbo 文件，并将dtbo 拷贝到开发板上。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/home/topeet/Linux/linux_sdk/kernel/scripts/dtc/dtc <span class="token parameter variable">-I</span> dts <span class="token parameter variable">-O</span> dtb overlay.dts <span class="token parameter variable">-o</span> overlay.dtbo<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291056180.png" alt="image-20240829105649100"></p>
<p>我们将编译好的dtbo 文件拷贝到开发板上，如下图（图73-5）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291056863.png" alt="image-20240829105659781"></p>
<p>我们进到系统/sys/kernel/config/device-tree/overlays/（这个目录需要加载设备树插件才会生成）目录下。如下图（图73-6）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291057199.png" alt="image-20240829105717123"></p>
<p>在这个目录下使用以下命令创建一个内核对象，如下图（图73-7）所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> <span class="token builtin class-name">test</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291057624.png" alt="image-20240829105733544"></p>
<p>使用命令cd test 进到test 文件夹，如下图（图73-8）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291057722.png" alt="image-20240829105741647"></p>
<p>使用以下命令写入dtbo 中，如下图（图73-9）所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> /overlay.dtbo <span class="token operator">&gt;</span> dtbo<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291057072.png" alt="image-20240829105758995"></p>
<p>使用以下命令使能dtbo，如下图（图73-10）所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token number">1</span> <span class="token operator">&gt;</span> status<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291058692.png" alt="image-20240829105819613"></p>
<p>此时我们可以使用以下命令看到加载的节点。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ls</span> /proc/device-tree/rk-485-ctl/overlay_node/<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291058942.png" alt="image-20240829105837861"></p>
<p>如果我们想删掉使用dtbo 修改的节点，在<code>/sys/kernel/config/device-tree/overlays</code> 下使用“<code>rmdir test</code>”即可。如下图（图73-12）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291058636.png" alt="image-20240829105859553"></p>
<p>此时我们可以使用命令“ <code>ls /proc/device-tree/rk-485-ctl/</code> ” 查看， 已经看不到添加的<code>overlay_node</code> 节点了。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291059520.png" alt="image-20240829105917441"></p>
<h3 id="73-3-加载多个dtbo"><a href="#73-3-加载多个dtbo" class="headerlink" title="73.3 加载多个dtbo"></a>73.3 加载多个dtbo</h3><p>我们准备第二个dtbo 文件，修改overlay_node 节点中的status 属性。如下（图73-14）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291100603.png" alt="image-20240829110049524"></p>
<p>在这个目录下使用命令<code>mkdir test1</code> 创建一个内核对象。如下图（图73-15）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291101403.png" alt="image-20240829110102323"></p>
<p>使用命令“<code>cd test</code>”进到test1 文件夹，如下图（图73-16）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291102270.png" alt="image-20240829110210189"></p>
<p>使用命令“<code>cat /overlay2.dtbo &gt; dtbo</code>”写进dtbo 中，如下图（图73-17）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291102943.png" alt="image-20240829110223858"></p>
<p>使用命令“echo 1 &gt; status”使用dtbo，如下图（图73-18）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291102856.png" alt="image-20240829110246776"></p>
<p>此时我们可以使用命令“<code>cat /proc/device-tree/rk-485-ctl/overlay_node/status</code>”看到属性值已经被修改了过来，如下图（图73-19）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291103728.png" alt="image-20240829110341645"></p>
<p>删除test1 文件夹，如下图（图73-20）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291103972.png" alt="image-20240829110352891"></p>
<p>可以看到status 的属性值已经被修改了回来，如下图（图73-21）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291104660.png" alt="image-20240829110400579"></p>
<h2 id="第74-章虚拟文件系统ConfigFS-介绍"><a href="#第74-章虚拟文件系统ConfigFS-介绍" class="headerlink" title="第74 章虚拟文件系统ConfigFS 介绍"></a>第74 章虚拟文件系统ConfigFS 介绍</h2><p>前面几个章节中，我们详细讲解了设备树插件的语法和编译过程，了解了如何利用设备树插件实现设备树的模块化和复用。本章节将进一步拓展我们的知识，介绍虚拟文件系统ConfigFS。虚拟文件系统ConfigFS 是一个特殊的文件系统，旨在提供一种动态配置Linux 内核和设备的机制。让我们一起深入学习ConfigFS，并将其应用于实际实验操作中，为我们的设备树和系统开发带来更多的可能性和创新性。</p>
<h3 id="74-1-常用的虚拟文件系统"><a href="#74-1-常用的虚拟文件系统" class="headerlink" title="74.1 常用的虚拟文件系统"></a>74.1 常用的虚拟文件系统</h3><p>在Linux 内核中，有几个常用的虚拟文件系统，虚拟文件系统提供了一个内核抽象层，使得应用程序可以通过统一的文件访问接口操作不同类型的文件和设备。它简化了应用程序的开发和维护，提供了更高的可移植性和灵活性，并提供了管理文件系统和访问底层硬件的功能。</p>
<p>其中最常见的虚拟文件系统如下所示：</p>
<ul>
<li>1 procfs 是一个虚拟文件系统，提供了对系统内核运行时状态的访问接口。它以文件和目录的形式表示内核中的进程，设备，驱动程序和其他系统信息。通过读取和写入procfs 中的文件，可以获取和修改有关系统状态的信息。</li>
<li>2 sysfs 是一个虚拟文件系统，用于表示系统中的设备，驱动程序和其他内核对象。它提供一种统一的接口，通过文件和目录来访问和配置这些对象的属性和状态。Sysfs 常用于设备驱动程序和系统管理工具，用于查看和控制系统的硬件和内核对象。</li>
<li>3 configfs 是一个虚拟文件系统，用于动态配置和管理内核对象。它提供了一种以文件和目录的形式访问内核对象的接口，允许用户在运行时添加，修改和删除内核对象，而无需重新编译内核或重新启动系统。ConfigFS 常用于配置和管理设备，驱动程序和子系统。</li>
</ul>
<p>这些虚拟文件系统在功能上有一些区别，如下所示：</p>
<ul>
<li>Procfs 主要用于访问和管理进程信息，提供了有关进程，内核参数和系统状态的信息。</li>
<li>Sysfs 主要用于表示和配置系统中的设备，驱动程序和其他内核对象，提供了一种统一的接口来访问和控制这些对象的属性和状态。</li>
<li>Configfs 主要用于动态配置和管理内核对象，提供了一种以文件和目录的形式访问内核对象的接口，允许在运行时添加，修改和删除内核对象。</li>
</ul>
<h3 id="74-2-设备树插件选择ConfigFS-原因"><a href="#74-2-设备树插件选择ConfigFS-原因" class="headerlink" title="74.2 设备树插件选择ConfigFS 原因"></a>74.2 设备树插件选择ConfigFS 原因</h3><p>在上个章节，我们学习了设备树插件的使用，从而理出设备树插件的实现方式，</p>
<p>通过上节课设备树插件的使用我们可以理出设备树的插件的实现方式，如下图（图74-1）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291108079.png" alt="image-20240829110759977"></p>
<p>要实现上述的功能，用户空间需要和内核进行交互，也就是将dtbo 加载到内存里面去。sysfs 虚拟文件系统的作用是将内核中的数据、属性以文件的方式导出到用户空间。导出到用户空间以后，读这些文件表示读取设备的文件，写这些文件就表示控制设备。configfs 作用的英文解释为<code>Userspace-driven kernel object configuration</code>，翻译过来就是用户空间配置内核对象。</p>
<p>所以configfs 与sysfs 恰恰相反，<strong>sysfs 导出内核对象给用户空间，configfs 是从用户空间去配置内核对象，并且不需要重新编译内核或者修改内核代码</strong>。所以configfs 更适合设备树插件这个技术。</p>
<p>选择ConfigFS 虚拟文件系统作为设备树插件的实现方式，可以满足设备树插件对动态性、灵活性的需求，使得设备树的配置和管理更加方便和高效。</p>
<h2 id="第75-章ConfigFS-的核心数据结构"><a href="#第75-章ConfigFS-的核心数据结构" class="headerlink" title="第75 章ConfigFS 的核心数据结构"></a>第75 章ConfigFS 的核心数据结构</h2><p>在前面的章节中，我们对于ConfigFS 有了一个感性的认识，本章节将进一步深入，探讨ConfigFS 的核心数据结构，这将为我们理解ConfigFS 的内部工作原理提供基础。让我们一起深入学习ConfigFS 的核心数据结构吧！</p>
<h3 id="75-1-关键数据结构"><a href="#75-1-关键数据结构" class="headerlink" title="75.1 关键数据结构"></a>75.1 关键数据结构</h3><p>接下来我们将要学习如何创建内核对象，然后生成对应的文件和目录。<br>在创建之前，我们先要了解下和ConfigFs 文件系统相关的几个核心数据结构。<br>ConfigFS 的核心数据结构主要包括以下几个部分：</p>
<ul>
<li><code>configfs_subsystem</code>：configfs_subsystem 是一个顶层的数据结构，用于表示整个ConfigFS 子系统。它包含了根配置项组的指针，以及ConfigFS 的其他属性和状态信息。</li>
<li><code>config_group</code>：config_group 是一种特殊类型的配置项，表示一个配置项组。它可以包含一组相关的配置项，形成一个层次结构。config_group 结构包含了父配置项的指针，以及指向子配置项的链表。</li>
<li><code>config_item</code>：这是ConfigFS 中最基本的数据结构，用于表示一个配置项。每个配置项都是一个内核对象，可以是设备、驱动程序、子系统等。config_item 结构包含了配置项的类型、名称、属性、状态等信息，以及指向父配置项和子配置项的指针。</li>
</ul>
<p>这些数据结构之间的关系可以形成一个树形结构，其中<code>configfs_subsystem</code> 是根节点，<code>config_group</code> 表示配置项组，<code>config_item</code> 表示单个配置项。子配置项通过链表连接在一起，形成父子关系。如下表（图75-1）所示：</p>
<img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291111207.png" alt="image-20240829111135116" style="zoom:50%;">

<h3 id="75-2-子系统、容器和config-item"><a href="#75-2-子系统、容器和config-item" class="headerlink" title="75.2 子系统、容器和config_item"></a>75.2 子系统、容器和<code>config_item</code></h3><p>本小节我们来了解下子系统，容器，config_item 的结构体。<br><code>configfs_subsystem</code> 结构体，如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">configfs_subsystem</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">config_group</span> su_group<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">mutex</span> su_mutex<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>configfs_subsystem</code> 结构体中包含<code>config_group</code> 结构体，<code>config_group</code> 结构体如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">config_group</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">config_item</span> cg_item<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> cg_children<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">configfs_subsystem</span> <span class="token operator">*</span>cg_subsys<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> default_groups<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> group_entry<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>config_group</code> 结构体中包含<code>config_item</code> 结构体，<code>config_item</code> 结构体如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>ci_name<span class="token punctuation">;</span>
    <span class="token keyword">char</span> ci_namebuf<span class="token punctuation">[</span>CONFIGFS_ITEM_NAME_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//目录的名字</span>
    <span class="token keyword">struct</span> <span class="token class-name">kref</span> ci_kref<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> ci_entry<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>ci_parent<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">config_group</span> <span class="token operator">*</span>ci_group<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">config_item_type</span> <span class="token operator">*</span>ci_type<span class="token punctuation">;</span> <span class="token comment">//目录下属性文件和属性操作</span>
    <span class="token keyword">struct</span> <span class="token class-name">dentry</span> <span class="token operator">*</span>ci_dentry<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>接下来我们来分析设备树插件驱动代码，如下（图75-2）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291113539.png" alt="image-20240829111310452"></p>
<p>这段代码定义了一个名为<code>dtbocfg_root_subsys</code> 的<code>configfs_subsystem</code> 结构体实例，表示<code>ConfigFS</code> 中的一个子系统。<br>首先，<code>dtbocfg_root_subsys.su_group</code> 是一个<code>config_group</code> 结构体，它表示子系统的根配置项组。在这里，该结构体的<code>.cg_item</code> 字段表示根配置项组的基本配置项。</p>
<ul>
<li><code>.ci_namebuf = "device-tree"</code>：配置项的名称设置为”device-tree”，表示该配置项的名称为”device-tree”。</li>
<li><code>.ci_type = &amp;dtbocfg_root_type</code>：配置项的类型设置为<code>dtbocfg_root_type</code>，这是一个自定义的配置项类型。</li>
</ul>
<p>接下来，<code>.su_mutex</code> 字段是一个互斥锁，用于保护子系统的操作。在这里，使用了<code>__MUTEX_INITIALIZER</code> 宏来初始化互斥锁。<br>通过这段代码，创建了一个名为”device-tree”的子系统，它的根配置项组为空。可以在该子系统下添加更多的配置项和配置项组，用于动态配置和管理设备树相关的内核对象。Linux系统下创建了device-tree 这个子系统，如下图（图75-3）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291116148.png" alt="image-20240829111606061"></p>
<p>接下来继续分析设备树插件驱动代码中注册配置项组的部分，如下图（图75-4）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291116425.png" alt="image-20240829111616319"></p>
<p>这段代码是一个初始化函数<code>dtbocfg_module_init()</code>，用于初始化和注册ConfigFS 子系统和配置项组。首先，通过<code>config_group_init()</code>函数初始化了<code>dtbocfg_root_subsys.su_group</code>，即子系统的根配置项组。接下来，使用<code>config_group_init_type_name()</code>函数初始化了<code>dtbocfg_overlay_group</code>，表示名为”overlays”的配置项组，并指定了配置项组的类型为<code>dtbocfg_overlays_type</code>，这是一个自定义的配置项类型。然后，调用<code>configfs_register_subsystem()</code><br>函数注册了<code>dtbocfg_root_subsys</code> 子系统。如果注册失败，将打印错误信息，并跳转到<code>register_subsystem_failed</code> 标签处进行错误处理。接着，调用<code>configfs_register_group()</code>函数注册了<code>dtbocfg_overlay_group</code> 配置项组，并将其添加到<code>dtbocfg_root_subsys.su_group</code> 下。如果注册失败，同样会打印错误信息，并跳转到<code>register_group_failed</code> 标签处进行错误处理。最后，如果所有的注册过程都成功，将打印”OK”消息，并返回0，表示初始化成功。如果在注册配置项组失败时，会先调用<code>configfs_unregister_subsystem()</code>函数注销之前注册的子系统，然后返回注册失败的错误码retval。</p>
<p>这段代码的作用是初始化和注册一个名为”device-tree”的ConfigFS 子系统，并在其下创建一个名为”overlays”的配置项组。Linux 系统下，在device-tree 子系统下创建了overlays 容器，如下图（图75-5）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408291117712.png" alt="image-20240829111758628"></p>
<h3 id="75-3-属性和方法"><a href="#75-3-属性和方法" class="headerlink" title="75.3 属性和方法"></a>75.3 属性和方法</h3><p>我们要在容器下放目录或属性文件，所以我们看一下<code>config_item</code> 结构体，如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>ci_name<span class="token punctuation">;</span>
    <span class="token keyword">char</span> ci_namebuf<span class="token punctuation">[</span>CONFIGFS_ITEM_NAME_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//目录的名字</span>
    <span class="token keyword">struct</span> <span class="token class-name">kref</span> ci_kref<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> ci_entry<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>ci_parent<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">config_group</span> <span class="token operator">*</span>ci_group<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">config_item_type</span> <span class="token operator">*</span>ci_type<span class="token punctuation">;</span> <span class="token comment">//目录下属性文件和属性操作</span>
    <span class="token keyword">struct</span> <span class="token class-name">dentry</span> <span class="token operator">*</span>ci_dentry<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>config_item 结构体中包含了config_item_type 结构体，config_item_type 结构体如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">config_item_type</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>ct_owner<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">configfs_item_operations</span> <span class="token operator">*</span>ct_item_ops<span class="token punctuation">;</span> <span class="token comment">//item（目录）的操作方法</span>
    <span class="token keyword">struct</span> <span class="token class-name">configfs_group_operations</span> <span class="token operator">*</span>ct_group_ops<span class="token punctuation">;</span> <span class="token comment">//group（容器）的操作方法</span>
    <span class="token keyword">struct</span> <span class="token class-name">configfs_attribute</span> <span class="token operator">*</span><span class="token operator">*</span>ct_attrs<span class="token punctuation">;</span> <span class="token comment">//属性文件的操作方法</span>
    <span class="token keyword">struct</span> <span class="token class-name">configfs_bin_attribute</span> <span class="token operator">*</span><span class="token operator">*</span>ct_bin_attrs<span class="token punctuation">;</span> <span class="token comment">//bin 属性文件的操作方法</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>config_item_type 结构体中包含了struct configfs_item_operations 结构体，如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">configfs_item_operations</span> <span class="token punctuation">{</span>
    <span class="token comment">//删除item 方法，在group 下面使用rmdir 命令会调用这个方法</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>release<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>allow_link<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>src<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>drop_link<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>src<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>config_item_type</code> 结构体中包含了<code>struct configfs_group_operations</code> 结构体，如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">configfs_group_operations</span> <span class="token punctuation">{</span>
    <span class="token comment">//创建item 的方法，在group 下面使用mkdir 命令会调用这个方法</span>
    <span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>make_item<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_group</span> <span class="token operator">*</span>group<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//创建group 的方法</span>
    <span class="token keyword">struct</span> <span class="token class-name">config_group</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>make_group<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_group</span> <span class="token operator">*</span>group<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>commit_item<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>disconnect_notify<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_group</span> <span class="token operator">*</span>group<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>drop_item<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_group</span> <span class="token operator">*</span>group<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>config_item_type</code> 结构体中包含了<code>struct configfs_attribute</code> 结构体，如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">configfs_attribute</span> <span class="token punctuation">{</span>
<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>ca_name<span class="token punctuation">;</span> 			<span class="token comment">// 属性文件的名字</span>
<span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>ca_owner<span class="token punctuation">;</span> 		<span class="token comment">// 属性文件文件的所属模块</span>
<span class="token class-name">umode_t</span> ca_mode<span class="token punctuation">;</span> 			   <span class="token comment">// 属性文件访问权限</span>
    
<span class="token comment">// 读写方法的函数指针，具体功能需要自行实现。</span>
<span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>show<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>store<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="75-4-总结"><a href="#75-4-总结" class="headerlink" title="75.4 总结"></a>75.4 总结</h3><p>在上面几个小节中，对ConfigFS 的核心数据结构做出了详细的解释，本小节我们来总结一下。这些核心数据结构相互关联，通过在ConfigFS 层级结构进行组织和管理，使得设备的配置和管理更加灵活和可定制。如下图（图75-6）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409021126051.png" alt="image-20240902112626884"></p>
<p>理解ConfigFS 的核心数据结构对于深入使用和定制ConfigFS 非常重要，可以帮助开发者更好地进行设备的配置和管理，提高系统的灵活性和可扩展性。如果大家还有不理解的地方，建议反复观看视频学习。</p>
<h2 id="第76-章注册configfs-子系统实验"><a href="#第76-章注册configfs-子系统实验" class="headerlink" title="第76 章注册configfs 子系统实验"></a>第76 章注册configfs 子系统实验</h2><p>在上个章节中，我们深入学习了configfs 的核心数据结构，我们理解了它们在ConfigFS 中的层级关系，以及他们如何用于设备的动态配置和管理。本章节我们将以实验的方式来应用我们所学的知识，自己编写一个设备树插件驱动，实现注册一个configfs 子系统。接下来我们开始编写驱动吧！</p>
<h3 id="76-1-实验程序的编写"><a href="#76-1-实验程序的编写" class="headerlink" title="76.1 实验程序的编写"></a>76.1 实验程序的编写</h3><h4 id="76-1-1-驱动程序编写"><a href="#76-1-1-驱动程序编写" class="headerlink" title="76.1.1 驱动程序编写"></a>76.1.1 驱动程序编写</h4><p>本实验对应的网盘路径为：<code>iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\59_configfs_subsystem\module</code>。<br>我们编写驱动代码创建一个名为“myconfigfs”的configfs 子系统，并将其注册到内核中。编写完成的configfs_subsystem.c 代码如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/configfs.h&gt;</span></span>

<span class="token comment">//定义名为"myconfig_item_type"的配置项类型结构体</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">config_item_type</span> myconfig_item_type <span class="token operator">=</span><span class="token punctuation">{</span>
  <span class="token punctuation">.</span>ct_owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>ct_item_ops <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">.</span>ct_group_ops <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">.</span>ct_attrs <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//定义一个configfs_subsystem结构体实例"myconfigfs_subsystem"</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">configfs_subsystem</span> myconfigfs_subsystem <span class="token operator">=</span><span class="token punctuation">{</span>
  <span class="token punctuation">.</span>su_group <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>cg_item <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span>ci_namebuf <span class="token operator">=</span> <span class="token string">"myconfigfs"</span><span class="token punctuation">,</span>
      <span class="token punctuation">.</span>ci_type <span class="token operator">=</span> <span class="token operator">&amp;</span>myconfig_item_type<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//模块的初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">myconfigfs_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">//初始化配置组</span>
  <span class="token function">config_group_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myconfigfs_subsystem<span class="token punctuation">.</span>su_group<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//注册子系统</span>
  <span class="token function">configfs_register_subsystem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myconfigfs_subsystem<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 模块退出函数</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">myconfigfs_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">configfs_unregister_subsystem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myconfigfs_subsystem<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>myconfigfs_init<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定模块的初始化函数</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>myconfigfs_exit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定模块的退出函数</span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 模块使用的许可证</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"topeet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 模块的作者</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="76-2-运行测试"><a href="#76-2-运行测试" class="headerlink" title="76.2 运行测试"></a>76.2 运行测试</h3><h4 id="76-2-1-编译驱动程序"><a href="#76-2-1-编译驱动程序" class="headerlink" title="76.2.1 编译驱动程序"></a>76.2.1 编译驱动程序</h4><p>在上一小节中的<code>configfs_subsystem.c</code> 代码同一目录下创建Makefile 文件(记得用交叉编译的GCC)，Makefile 文件内容：然后使用命令“make”进行驱动的编译，编译完生成<code>configfs_subsystem.ko</code> 目标文件，至此驱动模块就编译成功了，接下来进行测试。</p>
<h4 id="76-2-2-运行测试"><a href="#76-2-2-运行测试" class="headerlink" title="76.2.2 运行测试"></a>76.2.2 运行测试</h4><p>开发板启动之后，使用以下命令进行驱动模块的加载，如下图（图76-4）所示：</p>
<pre class="line-numbers language-none"><code class="language-none">insmod configfs_subsystem.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409021152145.png" alt="image-20240902115204071"></p>
<p>驱动加载之后，我们进入<code>/sys/kernel/config</code> 目录下，可以看到注册生成的<code>myconfigfs</code> 子系统，如下图（图76-5）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409021152031.png" alt="image-20240902115223958"></p>
<p>最后可以使用以下命令进行驱动的卸载，如下图（图76-6）所示：</p>
<pre class="line-numbers language-none"><code class="language-none">rmmod configfs_subsystem<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409021154120.png" alt="image-20240902115409045"></p>
<p>至此，注册configfs 子系统实验就完成了。</p>
<h2 id="第77-章注册group-容器实验"><a href="#第77-章注册group-容器实验" class="headerlink" title="第77 章注册group 容器实验"></a>第77 章注册group 容器实验</h2><p>上一章节，我们编写驱动程序注册了一个configfs 子系统，本章节在上个章节的基础上进行注册group 容器的实验。</p>
<h3 id="77-1-实验程序的编写"><a href="#77-1-实验程序的编写" class="headerlink" title="77.1 实验程序的编写"></a>77.1 实验程序的编写</h3><h4 id="77-1-1-驱动程序编写"><a href="#77-1-1-驱动程序编写" class="headerlink" title="77.1.1 驱动程序编写"></a>77.1.1 驱动程序编写</h4><p>本实验对应的网盘路径为：iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\60_config_group\module。<br>本章编写的驱动文件在上个章节驱动文件的基础上进行编写。我们接下来注册group 容器实验。在这个实验中，我们将创建一个配置组，并将其注册到ConfigFS 子系统中，编写完成的config_group.c 代码如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/configfs.h&gt;</span></span>

<span class="token comment">// 定义一个名为"mygroup"的config_group结构体</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">config_group</span> mygroup<span class="token punctuation">;</span>
<span class="token comment">// 定义一个名为"mygroup_config_item_type"的config_item_type结构体，用于描述配置项类型。</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">config_item_type</span> mygroup_config_item_type <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>ct_owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>ct_item_ops <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>ct_group_ops <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>ct_attrs <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义名为"myconfig_item_type"的配置项类型结构体</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">config_item_type</span> myconfig_item_type <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>ct_owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>ct_group_ops <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义一个configfs_subsystem结构体实例"myconfigfs_subsystem"</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">configfs_subsystem</span> myconfigfs_subsystem <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>su_group <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span>cg_item <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span>ci_namebuf <span class="token operator">=</span> <span class="token string">"myconfigfs"</span><span class="token punctuation">,</span>
            <span class="token punctuation">.</span>ci_type <span class="token operator">=</span> <span class="token operator">&amp;</span>myconfig_item_type<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 模块的初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">myconfig_group_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">// 初始化配置组</span>
  <span class="token function">config_group_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myconfigfs_subsystem<span class="token punctuation">.</span>su_group<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 注册子系统</span>
  <span class="token function">configfs_register_subsystem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myconfigfs_subsystem<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 初始化配置组"mygroup"</span>
  <span class="token function">config_group_init_type_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mygroup<span class="token punctuation">,</span> <span class="token string">"mygroup"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>mygroup_config_item_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 在子系统中注册配置组"mygroup"</span>
  <span class="token function">configfs_register_group</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myconfigfs_subsystem<span class="token punctuation">.</span>su_group<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mygroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 模块退出函数</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">myconfig_group_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">// 注销子系统</span>
  <span class="token function">configfs_unregister_subsystem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myconfigfs_subsystem<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>myconfig_group_init<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定模块的初始化函数</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>myconfig_group_exit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定模块的退出函数</span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 模块使用的许可证</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"topeet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 模块的作者</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="77-2-运行测试"><a href="#77-2-运行测试" class="headerlink" title="77.2 运行测试"></a>77.2 运行测试</h3><p>77.2.1 编译驱动程序<br>在上一小节中的<code>config_group.c</code> 代码同一目录下创建Makefile 文件，Makefile 文件内容如下所示：然后使用命令“make”进行驱动的编译，编译完生成config_group.ko 目标文件，至此驱动模块就编译成功了，接下来进行测试。</p>
<h4 id="77-2-2-运行测试"><a href="#77-2-2-运行测试" class="headerlink" title="77.2.2 运行测试"></a>77.2.2 运行测试</h4><p>开发板启动之后，使用以下命令进行驱动模块的加载，如下图（图77-4）所示：</p>
<pre class="line-numbers language-none"><code class="language-none">insmod config_group.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409021157371.png" alt="image-20240902115725297"></p>
<p>驱动加载之后，我们进入<code>/sys/kernel/config</code> 目录下，可以看到注册生成的<code>myconfigfs</code> 子系统，如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409021157347.png" alt="image-20240902115743272"></p>
<p>然后我们进入注册生成的myconfigfs 子系统，如下图所示，可以看到注册生成的mygroup容器。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409021158134.png" alt="image-20240902115802055"></p>
<p>最后可以使用以下命令进行驱动的卸载，如下图（图77-7）所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">rmmod config_group<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409021158068.png" alt="image-20240902115815988"></p>
<p>至此，注册group 容器实验就完成了。</p>
<h2 id="第78-章用户空间创建item-实验"><a href="#第78-章用户空间创建item-实验" class="headerlink" title="第78 章用户空间创建item 实验"></a>第78 章用户空间创建item 实验</h2><p>通过前面的学习，我们已经成功在/sys/kernel/config/目录下创建了myconfigfs 子系统，并在这个子系统下创建了mygroup 容器，但是mygroup 容器下不能使用mkdir 创建item。本章节我们来学习用代码实现用mkdir 命令创建item 功能。</p>
<h3 id="78-1-实验程序的编写"><a href="#78-1-实验程序的编写" class="headerlink" title="78.1 实验程序的编写"></a>78.1 实验程序的编写</h3><h4 id="78-1-1-驱动程序编写"><a href="#78-1-1-驱动程序编写" class="headerlink" title="78.1.1 驱动程序编写"></a>78.1.1 驱动程序编写</h4><p>本实验对应的网盘路径为：iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\61_mkdir_item\module。<br>本章编写的驱动文件在上个章节驱动文件的基础上进行编写。我们编写驱动程序，实现用mkdir 命令创建item 功能。编写完成的<code>mkdir_item.c</code> 代码如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/configfs.h&gt;</span></span>

<span class="token comment">// 定义一个名为"mygroup"的config_group结构体</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">config_group</span> mygroup<span class="token punctuation">;</span>

<span class="token comment">// 自定义的配置项结构体</span>
<span class="token keyword">struct</span> <span class="token class-name">myitem</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">config_item</span> item<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 配置项释放函数</span>
<span class="token keyword">void</span> <span class="token function">myitem_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>item<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">myitem</span> <span class="token operator">*</span>myitem <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">myitem</span><span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">kfree</span><span class="token punctuation">(</span>myitem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 配置项操作结构体</span>
<span class="token keyword">struct</span> <span class="token class-name">configfs_item_operations</span> myitem_ops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>release <span class="token operator">=</span> myitem_release<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 配置项类型结构体</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">config_item_type</span> mygroup_item_type <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>ct_owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>ct_item_ops <span class="token operator">=</span> <span class="token operator">&amp;</span>myitem_ops<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 创建配置项函数</span>
<span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span><span class="token function">mygroup_make_item</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_group</span> <span class="token operator">*</span>group<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">myitem</span> <span class="token operator">*</span>myconfig_item<span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    myconfig_item <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>myconfig_item<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">config_item_init_type_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myconfig_item<span class="token operator">-&gt;</span>item<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mygroup_item_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>myconfig_item<span class="token operator">-&gt;</span>item<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 配置组操作结构体</span>
<span class="token keyword">struct</span> <span class="token class-name">configfs_group_operations</span> mygroup_ops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>make_item <span class="token operator">=</span> mygroup_make_item<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义名为"mygroup_config_item_type"的config_item_type结构体，用于描述配置项类型。</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">config_item_type</span> mygroup_config_item_type <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>ct_owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>ct_group_ops <span class="token operator">=</span> <span class="token operator">&amp;</span>mygroup_ops<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义名为"myconfig_item_type"的配置项类型结构体</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">config_item_type</span> myconfig_item_type <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>ct_owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>ct_group_ops <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义一个configfs_subsystem结构体实例"myconfigfs_subsystem"</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">configfs_subsystem</span> myconfigfs_subsystem <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>su_group <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span>cg_item <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span>ci_namebuf <span class="token operator">=</span> <span class="token string">"myconfigfs"</span><span class="token punctuation">,</span>
            <span class="token punctuation">.</span>ci_type <span class="token operator">=</span> <span class="token operator">&amp;</span>myconfig_item_type<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 模块的初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">myconfig_group_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 初始化配置组</span>
    <span class="token function">config_group_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myconfigfs_subsystem<span class="token punctuation">.</span>su_group<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 注册子系统</span>
    <span class="token function">configfs_register_subsystem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myconfigfs_subsystem<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 初始化配置组"mygroup"</span>
    <span class="token function">config_group_init_type_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mygroup<span class="token punctuation">,</span> <span class="token string">"mygroup"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>mygroup_config_item_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 在子系统中注册配置组"mygroup"</span>
    <span class="token function">configfs_register_group</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myconfigfs_subsystem<span class="token punctuation">.</span>su_group<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mygroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 模块退出函数</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">myconfig_group_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 注销子系统</span>
    <span class="token function">configfs_unregister_subsystem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myconfigfs_subsystem<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>myconfig_group_init<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定模块的初始化函数</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>myconfig_group_exit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定模块的退出函数</span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 模块使用的许可证</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"topeet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 模块的作者</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="78-2-运行测试"><a href="#78-2-运行测试" class="headerlink" title="78.2 运行测试"></a>78.2 运行测试</h3><h4 id="78-2-1-编译驱动程序"><a href="#78-2-1-编译驱动程序" class="headerlink" title="78.2.1 编译驱动程序"></a>78.2.1 编译驱动程序</h4><p>在上一小节中的mkdir_item.c 代码同一目录下创建Makefile 文件，Makefile 文件内容如下所示：然后使用命令“make”进行驱动的编译，编译完生成mkdir_item.ko 目标文件，至此驱动模块就编译成功了，接下来进行测试。</p>
<h4 id="78-2-2-运行测试"><a href="#78-2-2-运行测试" class="headerlink" title="78.2.2 运行测试"></a>78.2.2 运行测试</h4><p>开发板启动之后，使用以下命令进行驱动模块的加载，如下图（图78-4）所示：</p>
<pre class="line-numbers language-none"><code class="language-none">insmod mkdir_item.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409021200984.png" alt="image-20240902120048909"></p>
<p>驱动加载之后，我们进入<code>/sys/kernel/config</code> 目录下，可以看到注册生成的myconfigfs 子系统，如下图（图78-5）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409021201336.png" alt="image-20240902120108259"></p>
<p>然后我们进入注册生成的myconfigfs 子系统，如下图（图78-6）所示，可以看到注册生成的mygroup 容器。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409021202735.png" alt="image-20240902120255651"></p>
<p>然后输入“ <code>mkdir test</code> ” 命令创建<code>config_item</code> ， 如下图所示， 创建成功之后， 打印“<code>mygroup_make_item</code>”，说明驱动程序中<code>mygroup_make_item</code> 函数成功执行。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409021355333.png" alt="image-20240902135536252"></p>
<p>输入“<code>rmdir test</code>”命令删除item,如下图（图78-8）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409021356813.png" alt="image-20240902135602738"></p>
<p>最后可以使用以下命令进行驱动的卸载，如下图（图78-9）所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">rmmod mkdir_item<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409021356025.png" alt="image-20240902135619949"></p>
<p>至此，用户空间创建item 实验就完成了。</p>
<h2 id="第79-章完善drop-和release-函数实验"><a href="#第79-章完善drop-和release-函数实验" class="headerlink" title="第79 章完善drop 和release 函数实验"></a>第79 章完善drop 和release 函数实验</h2><p>当我们在命令行使用rmdir 命令删除item 时，会执行驱动中的release 函数，本章节来学习一个新函数——<code>drop</code> 函数。一起开始本章的学习吧。</p>
<h3 id="79-1-release-和drop-函数的区别"><a href="#79-1-release-和drop-函数的区别" class="headerlink" title="79.1 release 和drop 函数的区别"></a>79.1 release 和drop 函数的区别</h3><p><code>release</code> 和<code>.drop_item</code> 是两个不同的成员字段，用于不同的目的：<br><code>.release</code> 成员字段是在<code>struct config_item_type</code> 结构体中定义的一个回调函数指针。它指向一个函数，当configfs 中的配置项被释放或删除时，内核会调用该函数来执行相应的资源释放操作。它通常用于释放与配置项相关的资源，比如释放动态分配的内存、关闭打开的文件描述符等。<br><code>.drop_item</code> 是在<code>struct configfs_group_operations</code> 结构体中定义的一个回调函数指针。它指向一个函数，当configfs 中的配置组（group）被删除时，内核会调用该函数来处理与配置组相关的操作。这个函数通常用于清理配置组的状态、释放相关的资源以及执行其他必要的清理操作。.drop_item 函数在删除配置组时被调用，而不是在删除单个配置项时被调用。</p>
<p><code>.release</code> 成员字段用于配置项的释放操作，而<code>.drop_item</code> 成员字段用于配置组的删除操作。它们分别在不同的上下文中执行不同的任务，但都与资源释放和清理有关。</p>
<h3 id="79-2-实验程序的编写"><a href="#79-2-实验程序的编写" class="headerlink" title="79.2 实验程序的编写"></a>79.2 实验程序的编写</h3><h4 id="79-2-1-驱动程序编写"><a href="#79-2-1-驱动程序编写" class="headerlink" title="79.2.1 驱动程序编写"></a>79.2.1 驱动程序编写</h4><p>本实验对应的网盘路径为：iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\62_drop\module。<br>本章编写的驱动文件在上个章节驱动文件的基础上进行编写。在驱动程序中实现了删除配置项的函数，它会释放配置项相关的资源。编写完成的drop.c 代码如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/configfs.h&gt;</span></span>

<span class="token comment">// 定义一个名为"mygroup"的config_group结构体</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">config_group</span> mygroup<span class="token punctuation">;</span>

<span class="token comment">// 自定义的配置项结构体</span>
<span class="token keyword">struct</span> <span class="token class-name">myitem</span><span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">config_item</span> item<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 配置项释放函数</span>
<span class="token keyword">void</span> <span class="token function">myitem_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>item<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">myitem</span> <span class="token operator">*</span>myitem <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">myitem</span><span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">kfree</span><span class="token punctuation">(</span>myitem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 配置项操作结构体</span>
<span class="token keyword">struct</span> <span class="token class-name">configfs_item_operations</span> myitem_ops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>release <span class="token operator">=</span> myitem_release<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 配置项类型结构体</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">config_item_type</span> mygroup_item_type <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>ct_owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>ct_item_ops <span class="token operator">=</span> <span class="token operator">&amp;</span>myitem_ops<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 创建配置项函数</span>
<span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span><span class="token function">mygroup_make_item</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_group</span> <span class="token operator">*</span>group<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">myitem</span> <span class="token operator">*</span>myconfig_item<span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    myconfig_item <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>myconfig_item<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">config_item_init_type_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myconfig_item<span class="token operator">-&gt;</span>item<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mygroup_item_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>myconfig_item<span class="token operator">-&gt;</span>item<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 删除配置项函数</span>
<span class="token keyword">void</span> <span class="token function">mygroup_delete_item</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_group</span> <span class="token operator">*</span>group<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>item<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">myitem</span> <span class="token operator">*</span>myitem <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">myitem</span><span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">config_item_put</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myitem<span class="token operator">-&gt;</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 配置组操作结构体</span>
<span class="token keyword">struct</span> <span class="token class-name">configfs_group_operations</span> mygroup_ops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>make_item <span class="token operator">=</span> mygroup_make_item<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>drop_item <span class="token operator">=</span> mygroup_delete_item<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义名为"mygroup_config_item_type"的config_item_type结构体，用于描述配置项类型。</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">config_item_type</span> mygroup_config_item_type <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>ct_owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>ct_group_ops <span class="token operator">=</span> <span class="token operator">&amp;</span>mygroup_ops<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义名为"myconfig_item_type"的配置项类型结构体</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">config_item_type</span> myconfig_item_type <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>ct_owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>ct_group_ops <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义一个configfs_subsystem结构体实例"myconfigfs_subsystem"</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">configfs_subsystem</span> myconfigfs_subsystem <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>su_group <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span>cg_item <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span>ci_namebuf <span class="token operator">=</span> <span class="token string">"myconfigfs"</span><span class="token punctuation">,</span>
            <span class="token punctuation">.</span>ci_type <span class="token operator">=</span> <span class="token operator">&amp;</span>myconfig_item_type<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 模块的初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">myconfig_group_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 初始化配置组</span>
    <span class="token function">config_group_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myconfigfs_subsystem<span class="token punctuation">.</span>su_group<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 注册子系统</span>
    <span class="token function">configfs_register_subsystem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myconfigfs_subsystem<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 初始化配置组"mygroup"</span>
    <span class="token function">config_group_init_type_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mygroup<span class="token punctuation">,</span> <span class="token string">"mygroup"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>mygroup_config_item_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 在子系统中注册配置组"mygroup"</span>
    <span class="token function">configfs_register_group</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myconfigfs_subsystem<span class="token punctuation">.</span>su_group<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mygroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 模块退出函数</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">myconfig_group_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 注销子系统</span>
    <span class="token function">configfs_unregister_subsystem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myconfigfs_subsystem<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>myconfig_group_init<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定模块的初始化函数</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>myconfig_group_exit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定模块的退出函数</span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 模块使用的许可证</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"topeet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 模块的作者</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="79-3-运行测试"><a href="#79-3-运行测试" class="headerlink" title="79.3 运行测试"></a>79.3 运行测试</h3><h4 id="79-3-1-编译驱动程序"><a href="#79-3-1-编译驱动程序" class="headerlink" title="79.3.1 编译驱动程序"></a>79.3.1 编译驱动程序</h4><p>在上一小节中的drop.c 代码同一目录下创建Makefile 文件，Makefile 文件内容如下所示：然后使用命令“make”进行驱动的编译，编译完生成drop.ko 目标文件，至此驱动模块就编译成功了，接下来进行测试。</p>
<h4 id="79-3-2-运行测试"><a href="#79-3-2-运行测试" class="headerlink" title="79.3.2 运行测试"></a>79.3.2 运行测试</h4><p>开发板启动之后，使用以下命令进行驱动模块的加载，如下图（图79-4）所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">insmod drop.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031101000.png" alt="image-20240903110120924"></p>
<p>驱动加载之后，我们进入<code>/sys/kernel/config</code> 目录下，可以看到注册生成的<code>myconfigfs</code> 子系统，如下图（图79-5）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031100167.png" alt="image-20240903110048092"></p>
<p>然后我们进入注册生成的myconfigfs 子系统，如下图（图79-6）所示，可以看到注册生成的mygroup 容器。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031111190.png" alt="image-20240903111155102"></p>
<p>然后输入“<code>mkdir test</code>”命令创建<code>config_item</code>，如下图（图79-7）所示，创建成功之后，打印“<code>mygroup_make_item</code>”。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031113018.png" alt="image-20240903111358875"></p>
<p>输入“ <code>rmdir test</code> ” 命令删除<code>item</code>, 如下图所示， 执行rmdir 命令之后， 依次执行了<code>mygroup_delete_item</code> 函数和<code>myitem_release</code> 函数。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031114156.png" alt="image-20240903111427078"></p>
<p>最后可以使用以下命令进行驱动的卸载，如下图（图79-9）所示：</p>
<pre class="line-numbers language-none"><code class="language-none">rmmod mkdir_item<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031114388.png" alt="image-20240903111438313"></p>
<p>至此，完善drop 和release 函数实验就完成了。</p>
<h2 id="第80-章注册attribute-实验"><a href="#第80-章注册attribute-实验" class="headerlink" title="第80 章注册attribute 实验"></a>第80 章注册attribute 实验</h2><p>在前面的几章实验中，我们编写驱动程序，实现了注册<code>ConfigFS</code> 子系统，注册group 容器，支持使用mkdir 命令创建item,完善了drop 和release 函数的功能。在之前的实验中，我们成功创建了item，但是item 下面没有创建属性和操作项，那么本章节我们来学习如何注册属性。</p>
<h3 id="80-1-实验程序的编写"><a href="#80-1-实验程序的编写" class="headerlink" title="80.1 实验程序的编写"></a>80.1 实验程序的编写</h3><h4 id="80-1-1-驱动程序编写"><a href="#80-1-1-驱动程序编写" class="headerlink" title="80.1.1 驱动程序编写"></a>80.1.1 驱动程序编写</h4><p>本实验对应的网盘路径为：iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\63_attr\module。<br>本章编写的驱动文件在上个章节驱动文件的基础上进行编写。驱动实现在item 目录下生成属性read 和write，并对read 属性进行读取和对write 属性进行写入。编写完成的attr.c 代码如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/configfs.h&gt;</span></span>

<span class="token comment">// 定义一个名为"mygroup"的config_group结构体</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">config_group</span> mygroup<span class="token punctuation">;</span>

<span class="token comment">// 自定义的配置项结构体</span>
<span class="token keyword">struct</span> <span class="token class-name">myitem</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">config_item</span> item<span class="token punctuation">;</span>
    <span class="token keyword">int</span> size<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 配置项释放函数</span>
<span class="token keyword">void</span> <span class="token function">myitem_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>item<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">myitem</span> <span class="token operator">*</span>myitem <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">myitem</span><span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">kfree</span><span class="token punctuation">(</span>myitem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 读取配置项内容的回调函数</span>
<span class="token class-name">ssize_t</span> <span class="token function">myread_show</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>item<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>page<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">myitem</span> <span class="token operator">*</span>myitem <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">myitem</span><span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> myitem<span class="token operator">-&gt;</span>addr<span class="token punctuation">,</span> myitem<span class="token operator">-&gt;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> myitem<span class="token operator">-&gt;</span>size<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 写入配置项内容的回调函数</span>
<span class="token class-name">ssize_t</span> <span class="token function">mywrite_store</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>item<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>page<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">myitem</span> <span class="token operator">*</span>myitem <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">myitem</span><span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    myitem<span class="token operator">-&gt;</span>addr <span class="token operator">=</span> <span class="token function">kmemdup</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> size<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    myitem<span class="token operator">-&gt;</span>size <span class="token operator">=</span> size<span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> myitem<span class="token operator">-&gt;</span>size<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 创建只读配置项</span>
<span class="token function">CONFIGFS_ATTR_RO</span><span class="token punctuation">(</span>my<span class="token punctuation">,</span> read<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 创建只写配置项</span>
<span class="token function">CONFIGFS_ATTR_WO</span><span class="token punctuation">(</span>my<span class="token punctuation">,</span> write<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 配置项属性数组</span>
<span class="token keyword">struct</span> <span class="token class-name">configfs_attribute</span> <span class="token operator">*</span>my_attrs<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token operator">&amp;</span>myattr_read<span class="token punctuation">,</span>
    <span class="token operator">&amp;</span>myattr_write<span class="token punctuation">,</span>
    <span class="token constant">NULL</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 配置项操作结构体</span>
<span class="token keyword">struct</span> <span class="token class-name">configfs_item_operations</span> myitem_ops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>release <span class="token operator">=</span> myitem_release<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 配置项类型结构体</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">config_item_type</span> mygroup_item_type <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>ct_owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>ct_item_ops <span class="token operator">=</span> <span class="token operator">&amp;</span>myitem_ops<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>ct_attrs <span class="token operator">=</span> my_attrs<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 创建配置项函数</span>
<span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span><span class="token function">mygroup_make_item</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_group</span> <span class="token operator">*</span>group<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">myitem</span> <span class="token operator">*</span>myconfig_item<span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    myconfig_item <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>myconfig_item<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">config_item_init_type_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myconfig_item<span class="token operator">-&gt;</span>item<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mygroup_item_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>myconfig_item<span class="token operator">-&gt;</span>item<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 删除配置项函数</span>
<span class="token keyword">void</span> <span class="token function">mygroup_delete_item</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_group</span> <span class="token operator">*</span>group<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>item<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">myitem</span> <span class="token operator">*</span>myitem <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">myitem</span><span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">config_item_put</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myitem<span class="token operator">-&gt;</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 配置组操作结构体</span>
<span class="token keyword">struct</span> <span class="token class-name">configfs_group_operations</span> mygroup_ops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>make_item <span class="token operator">=</span> mygroup_make_item<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>drop_item <span class="token operator">=</span> mygroup_delete_item<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 配置项类型结构体</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">config_item_type</span> mygroup_config_item_type <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>ct_owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>ct_group_ops <span class="token operator">=</span> <span class="token operator">&amp;</span>mygroup_ops<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 配置项类型结构体</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">config_item_type</span> myconfig_item_type <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>ct_owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>ct_group_ops <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义一个configfs_subsystem结构体实例"myconfigfs_subsystem"</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">configfs_subsystem</span> myconfigfs_subsystem <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>su_group <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span>cg_item <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span>ci_namebuf <span class="token operator">=</span> <span class="token string">"myconfigfs"</span><span class="token punctuation">,</span>
            <span class="token punctuation">.</span>ci_type <span class="token operator">=</span> <span class="token operator">&amp;</span>myconfig_item_type<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 模块的初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">myconfig_group_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 初始化配置组</span>
    <span class="token function">config_group_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myconfigfs_subsystem<span class="token punctuation">.</span>su_group<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 注册子系统</span>
    <span class="token function">configfs_register_subsystem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myconfigfs_subsystem<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 初始化配置组"mygroup"</span>
    <span class="token function">config_group_init_type_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mygroup<span class="token punctuation">,</span> <span class="token string">"mygroup"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>mygroup_config_item_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 在子系统中注册配置组"mygroup"</span>
    <span class="token function">configfs_register_group</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myconfigfs_subsystem<span class="token punctuation">.</span>su_group<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mygroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 模块退出函数</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">myconfig_group_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 注销子系统</span>
    <span class="token function">configfs_unregister_subsystem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myconfigfs_subsystem<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>myconfig_group_init<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定模块的初始化函数</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>myconfig_group_exit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定模块的退出函数</span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 模块使用的许可证</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"topeet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 模块的作者</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="80-2-运行测试"><a href="#80-2-运行测试" class="headerlink" title="80.2 运行测试"></a>80.2 运行测试</h3><h4 id="80-2-1-编译驱动程序"><a href="#80-2-1-编译驱动程序" class="headerlink" title="80.2.1 编译驱动程序"></a>80.2.1 编译驱动程序</h4><p>在上一小节中的attr.c 代码同一目录下创建Makefile 文件，Makefile 文件内容如下所示：然后使用命令“make”进行驱动的编译，编译完生成attr.ko 目标文件，至此驱动模块就编译成功了，接下来进行测试。</p>
<h4 id="80-2-2-运行测试"><a href="#80-2-2-运行测试" class="headerlink" title="80.2.2 运行测试"></a>80.2.2 运行测试</h4><p>开发板启动之后，使用以下命令进行驱动模块的加载，如下图（图80-4）所示：</p>
<pre class="line-numbers language-none"><code class="language-none">insmod attr.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031118213.png" alt="image-20240903111856132"></p>
<p>驱动加载之后，我们进入<code>/sys/kernel/config</code> 目录下，可以看到注册生成的<code>myconfigfs</code> 子系统，如下图（图80-5）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031119290.png" alt="image-20240903111918215"></p>
<p>然后我们进入注册生成的<code>myconfigfs</code> 子系统，如下图（图80-6）所示，可以看到注册生成的<code>mygroup</code> 容器。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031119987.png" alt="image-20240903111933903"></p>
<p>然后输入“<code>mkdir test</code>”命令创建<code>config_item</code>，如下图（图80-7）所示，创建成功之后，打印“<code>mygroup_make_item</code>”。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031120218.png" alt="image-20240903112000137"></p>
<p>然后进入到test 目录下，如下图（图80-8）所示。有生成的属性：read 和write</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031120697.png" alt="image-20240903112014620"></p>
<p>我们输入以下命令对属性进行读写操作，如下图（图80-9）所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> <span class="token builtin class-name">read</span>
<span class="token builtin class-name">echo</span> <span class="token number">1</span> <span class="token operator">&gt;</span> <span class="token function">write</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031120561.png" alt="image-20240903112033481"></p>
<p>在上图中，我们分别对属性read 和write 进行读写操作后，分别打印“<code>myread_show</code>”和“<code>mywrite_store</code>”。<br>输入“<code>rmdir test</code>”命令删除item,如下图（图80-10）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031120579.png" alt="image-20240903112058501"></p>
<p>最后可以使用以下命令进行驱动的卸载，如下图（图80-11）所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">rmmod attr<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031121046.png" alt="image-20240903112115971"></p>
<p>至此，注册attribute 实验就完成了。</p>
<h2 id="第81-章实现多级目录实验"><a href="#第81-章实现多级目录实验" class="headerlink" title="第81 章实现多级目录实验"></a>第81 章实现多级目录实验</h2><p>经过前面理论的学习，我们了解到一个配置组也就是（group）可以包含多个配置项（item）和子配置组。配置项和配置组都是作为配置组的成员存在的。配置项和配置组之间通过指针进行关联，以形成一个层次结构。本章节我们来学习在设备树插件驱动程序中实现多级目录。</p>
<h3 id="81-1-实验程序的编写"><a href="#81-1-实验程序的编写" class="headerlink" title="81.1 实验程序的编写"></a>81.1 实验程序的编写</h3><h4 id="81-1-1-驱动程序编写"><a href="#81-1-1-驱动程序编写" class="headerlink" title="81.1.1 驱动程序编写"></a>81.1.1 驱动程序编写</h4><p>本实验对应的网盘路径为：iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\64_make_group\module。<br>编写完成的make_group.c 代码如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/configfs.h&gt;</span></span>

<span class="token comment">// 定义一个名为"mygroup"的config_group结构体</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">config_group</span> mygroup<span class="token punctuation">;</span>

<span class="token comment">// 自定义的配置项结构体</span>
<span class="token keyword">struct</span> <span class="token class-name">myitem</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">config_item</span> item<span class="token punctuation">;</span>
    <span class="token keyword">int</span> size<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 自定义的配置组结构体</span>
<span class="token keyword">struct</span> <span class="token class-name">mygroup</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">config_group</span> group<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 配置项释放函数</span>
<span class="token keyword">void</span> <span class="token function">myitem_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>item<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">myitem</span> <span class="token operator">*</span>myitem <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">myitem</span><span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">kfree</span><span class="token punctuation">(</span>myitem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 读取配置项内容的回调函数</span>
<span class="token class-name">ssize_t</span> <span class="token function">myread_show</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>item<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>page<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">myitem</span> <span class="token operator">*</span>myitem <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">myitem</span><span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> myitem<span class="token operator">-&gt;</span>addr<span class="token punctuation">,</span> myitem<span class="token operator">-&gt;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> myitem<span class="token operator">-&gt;</span>size<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 写入配置项内容的回调函数</span>
<span class="token class-name">ssize_t</span> <span class="token function">mywrite_store</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>item<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>page<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">myitem</span> <span class="token operator">*</span>myitem <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">myitem</span><span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    myitem<span class="token operator">-&gt;</span>addr <span class="token operator">=</span> <span class="token function">kmemdup</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> size<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    myitem<span class="token operator">-&gt;</span>size <span class="token operator">=</span> size<span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> myitem<span class="token operator">-&gt;</span>size<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 创建只读配置项</span>
<span class="token function">CONFIGFS_ATTR_RO</span><span class="token punctuation">(</span>my<span class="token punctuation">,</span> read<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 创建只写配置项</span>
<span class="token function">CONFIGFS_ATTR_WO</span><span class="token punctuation">(</span>my<span class="token punctuation">,</span> write<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 配置项属性数组</span>
<span class="token keyword">struct</span> <span class="token class-name">configfs_attribute</span> <span class="token operator">*</span>my_attrs<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token operator">&amp;</span>myattr_read<span class="token punctuation">,</span>
    <span class="token operator">&amp;</span>myattr_write<span class="token punctuation">,</span>
    <span class="token constant">NULL</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 配置项操作结构体</span>
<span class="token keyword">struct</span> <span class="token class-name">configfs_item_operations</span> myitem_ops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>release <span class="token operator">=</span> myitem_release<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 配置项类型结构体</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">config_item_type</span> mygroup_item_type <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>ct_owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>ct_item_ops <span class="token operator">=</span> <span class="token operator">&amp;</span>myitem_ops<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>ct_attrs <span class="token operator">=</span> my_attrs<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 配置组类型结构体</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">config_item_type</span> mygroup_type <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>ct_owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 创建配置项函数</span>
<span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span><span class="token function">mygroup_make_item</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_group</span> <span class="token operator">*</span>group<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">myitem</span> <span class="token operator">*</span>myconfig_item<span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    myconfig_item <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>myconfig_item<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">config_item_init_type_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myconfig_item<span class="token operator">-&gt;</span>item<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mygroup_item_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>myconfig_item<span class="token operator">-&gt;</span>item<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 删除配置项函数</span>
<span class="token keyword">void</span> <span class="token function">mygroup_delete_item</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_group</span> <span class="token operator">*</span>group<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>item<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">myitem</span> <span class="token operator">*</span>myitem <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">myitem</span><span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">config_item_put</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myitem<span class="token operator">-&gt;</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 创建配置组函数</span>
<span class="token keyword">struct</span> <span class="token class-name">config_group</span> <span class="token operator">*</span><span class="token function">mygroup_make_group</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_group</span> <span class="token operator">*</span>group<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">mygroup</span> <span class="token operator">*</span>mygroup<span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mygroup <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>mygroup<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">config_group_init_type_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mygroup<span class="token operator">-&gt;</span>group<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mygroup_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>mygroup<span class="token operator">-&gt;</span>group<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 配置组操作结构体</span>
<span class="token keyword">struct</span> <span class="token class-name">configfs_group_operations</span> mygroup_ops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>make_item <span class="token operator">=</span> mygroup_make_item<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>drop_item <span class="token operator">=</span> mygroup_delete_item<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>make_group <span class="token operator">=</span> mygroup_make_group<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 配置项类型结构体</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">config_item_type</span> mygroup_config_item_type <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>ct_owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>ct_group_ops <span class="token operator">=</span> <span class="token operator">&amp;</span>mygroup_ops<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 配置项类型结构体</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">config_item_type</span> myconfig_item_type <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>ct_owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>ct_group_ops <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义一个configfs_subsystem结构体实例"myconfigfs_subsystem"</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">configfs_subsystem</span> myconfigfs_subsystem <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>su_group <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span>cg_item <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span>ci_namebuf <span class="token operator">=</span> <span class="token string">"myconfigfs"</span><span class="token punctuation">,</span>
            <span class="token punctuation">.</span>ci_type <span class="token operator">=</span> <span class="token operator">&amp;</span>myconfig_item_type<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 模块的初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">myconfig_group_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 初始化配置组</span>
    <span class="token function">config_group_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myconfigfs_subsystem<span class="token punctuation">.</span>su_group<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 注册子系统</span>
    <span class="token function">configfs_register_subsystem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myconfigfs_subsystem<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 初始化配置组"mygroup"</span>
    <span class="token function">config_group_init_type_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mygroup<span class="token punctuation">,</span> <span class="token string">"mygroup"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>mygroup_config_item_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 在子系统中注册配置组"mygroup"</span>
    <span class="token function">configfs_register_group</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myconfigfs_subsystem<span class="token punctuation">.</span>su_group<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mygroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 模块退出函数</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">myconfig_group_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 注销子系统</span>
    <span class="token function">configfs_unregister_subsystem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myconfigfs_subsystem<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>myconfig_group_init<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定模块的初始化函数</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>myconfig_group_exit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定模块的退出函数</span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 模块使用的许可证</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"topeet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 模块的作者</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="81-2-运行测试"><a href="#81-2-运行测试" class="headerlink" title="81.2 运行测试"></a>81.2 运行测试</h3><h4 id="81-2-1-编译驱动程序"><a href="#81-2-1-编译驱动程序" class="headerlink" title="81.2.1 编译驱动程序"></a>81.2.1 编译驱动程序</h4><p>在上一小节中的make_group.c 代码同一目录下创建Makefile 文件，Makefile 文件内容如下所示：然后使用命令“<code>make</code>”进行驱动的编译，编译完生成<code>make_group.ko</code> 目标文件，至此驱动模块就编译成功了，接下来进行测试。</p>
<h4 id="81-2-2-运行测试"><a href="#81-2-2-运行测试" class="headerlink" title="81.2.2 运行测试"></a>81.2.2 运行测试</h4><p>开发板启动之后，使用以下命令进行驱动模块的加载，如下图（图81-4）所示：</p>
<pre class="line-numbers language-none"><code class="language-none">insmod make_group.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031123665.png" alt="image-20240903112339582"></p>
<p>驱动加载之后，我们进入<code>/sys/kernel/config</code> 目录下，可以看到注册生成的<code>myconfigfs</code> 子系统，如下图（图81-5）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031124504.png" alt="image-20240903112428425"></p>
<p>然后我们进入注册生成的myconfigfs 子系统，如下图（图81-6）所示，可以看到注册生成的mygroup 容器。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031124924.png" alt="image-20240903112442838"></p>
<p>然后输入“<code>mkdir test</code>”命令创建<code>config_item</code>，如下图（图81-7）所示，创建成功之后，打印“mygroup_make_group”。我们进入创建的group——test 目录下，此时可以在test 目录下创建item——test2。但由于在驱动中我们并没有实现在group 下创建item 功能，所以会提示创建test2 没有权限。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031125352.png" alt="image-20240903112514261"></p>
<p>输入“rmdir test”命令删除group，如下图（图81-8）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031125861.png" alt="image-20240903112523779"></p>
<p>最后可以使用以下命令进行驱动的卸载，如下图（图81-9）所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">rmmod make_group<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031125105.png" alt="image-20240903112540022"></p>
<p>至此，实现多级目录实验就完成了。</p>
<h2 id="第82-章移植设备树插件驱动实验"><a href="#第82-章移植设备树插件驱动实验" class="headerlink" title="第82 章移植设备树插件驱动实验"></a>第82 章移植设备树插件驱动实验</h2><p>在73 章节，我们学会了如何使用设备树插件。在本章节中，我们将探讨如何移植设备树插件到iTOP-RK3568 开发板上。移植设备树插件主要包括以下几个步骤</p>
<ul>
<li>1 配置内核支持挂载configfs 虚拟文件系统。</li>
<li>2 配置内核支持设备树插件</li>
<li>3 移植设备树插件驱动</li>
</ul>
<p>接下来开始移植设备树插件驱动吧！</p>
<h3 id="82-1-挂载configfs-虚拟文件系统"><a href="#82-1-挂载configfs-虚拟文件系统" class="headerlink" title="82.1 挂载configfs 虚拟文件系统"></a>82.1 挂载configfs 虚拟文件系统</h3><p>首先我们打开Linux 内核源码，输入以下命令打开menuconfig 配置界面。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031130144.png" alt="image-20240903113043059"></p>
<p>界面打开之后，将下图（图82-2）中的选项勾选。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031130585.png" alt="image-20240903113055474"></p>
<p>勾选之后保存退出，然后输入以下命令</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cp</span> .config arch/arm64/configs/rockchip_linux_defconfig
<span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/
./build.sh kernel<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>将编译之后的内核镜像烧写到开发板上，接着使用mount 命令检查configfs 虚拟文件系统是否挂载成功。挂载成功如下图（图82-3）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031131004.png" alt="image-20240903113139910"></p>
<p>如果系统没有自动挂载configfs 虚拟文件系统，需要输入以下命令挂载：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mount</span> <span class="token parameter variable">-t</span> configfs none /sys/kernel/config<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="82-2-配置内核支持设备树插件"><a href="#82-2-配置内核支持设备树插件" class="headerlink" title="82.2 配置内核支持设备树插件"></a>82.2 配置内核支持设备树插件</h3><p>首先我们打开Linux 内核源码，输入以下命令打开menuconfig 配置界面。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031132439.png" alt="image-20240903113207356"></p>
<p>界面打开之后，将下图中的选项勾选。</p>
<img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031132905.png" alt="image-20240903113225795" style="zoom: 67%;">

<img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031132953.png" alt="image-20240903113241834" style="zoom:67%;">

<p>勾选之后保存退出，然后输入以下命令</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cp</span> .config arch/arm64/configs/rockchip_linux_defconfig
<span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/
./build.sh kernel<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>内核编译成功之后，接下来我们开始移植设备树插件驱动。</p>
<h3 id="82-3-移植驱动"><a href="#82-3-移植驱动" class="headerlink" title="82.3 移植驱动"></a>82.3 移植驱动</h3><p>现在我们已经学完了configfs 虚拟文件系统的数据结构。如果水平足够，完全可以自己编写驱动实现一个设备树插件。但是我们没有必要重复造轮子，github 上有大神编写好的设备树插件驱动，为了方便大家使用，放在了网盘资料“<code>iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568 开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\65_dtbocfg</code>”目录下，如下图（图82-7）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031133660.png" alt="image-20240903113338576"></p>
<p>dtbocfg.c 是设备树插件驱动，我们只要将此驱动编译成驱动模块或者编译进内核即可。在网盘资料中提供了编译好的dtbocfg.ko 文件。<br>好了，设备树插件驱动移植完毕，设备树插件的使用，可以查看本手册73 章节。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*********************************************************************************
 *
 *       Copyright (C) 2016-2021 Ichiro Kawazome
 *       All rights reserved.
 * 
 *       Redistribution and use in source and binary forms, with or without
 *       modification, are permitted provided that the following conditions
 *       are met:
 * 
 *         1. Redistributions of source code must retain the above copyright
 *            notice, this list of conditions and the following disclaimer.
 * 
 *         2. Redistributions in binary form must reproduce the above copyright
 *            notice, this list of conditions and the following disclaimer in
 *            the documentation and/or other materials provided with the
 *            distribution.
 * 
 *       THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 *       "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 *       LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 *       A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT
 *       OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 *       SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 *       LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 *       DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 *       THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT 
 *       (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 *       OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 * 
 ********************************************************************************/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of_fdt.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/configfs.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/limits.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/file.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/version.h&gt;</span></span>

<span class="token comment">/**
 * Device Tree Overlay Item Structure
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">dtbocfg_overlay_item</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">config_item</span>	    item<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span>LINUX_VERSION_CODE <span class="token operator">&lt;</span> <span class="token number">0x041100</span><span class="token punctuation">)</span></span></span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span><span class="token operator">*</span>     node<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token keyword">int</span>                     id<span class="token punctuation">;</span>
    <span class="token keyword">void</span><span class="token operator">*</span>                   dtbo<span class="token punctuation">;</span>
    <span class="token keyword">int</span>                     dtbo_size<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * dtbocfg_overlay_create() - Create Device Tree Overlay
 * @overlay: Pointer to Device Tree Overlay Item
 * return    Success(0) or Error Status.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">dtbocfg_overlay_item_create</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">dtbocfg_overlay_item</span> <span class="token operator">*</span>overlay<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret_val<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span>LINUX_VERSION_CODE <span class="token operator">&gt;=</span> <span class="token number">0x041100</span><span class="token punctuation">)</span></span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">int</span> ovcs_id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        ret_val <span class="token operator">=</span> <span class="token function">of_overlay_fdt_apply</span><span class="token punctuation">(</span>overlay<span class="token operator">-&gt;</span>dtbo<span class="token punctuation">,</span>overlay<span class="token operator">-&gt;</span>dtbo_size<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ovcs_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret_val <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"%s: Failed to apply overlay (ret_val=%d)\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> ret_val<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> failed<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        overlay<span class="token operator">-&gt;</span>id <span class="token operator">=</span> ovcs_id<span class="token punctuation">;</span>
        <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"%s: apply OK(id=%d)\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> ovcs_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span>LINUX_VERSION_CODE <span class="token operator">&gt;=</span> <span class="token number">0x040700</span><span class="token punctuation">)</span></span></span>
    <span class="token function">of_fdt_unflatten_tree</span><span class="token punctuation">(</span>overlay<span class="token operator">-&gt;</span>dtbo<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>overlay<span class="token operator">-&gt;</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    <span class="token function">of_fdt_unflatten_tree</span><span class="token punctuation">(</span>overlay<span class="token operator">-&gt;</span>dtbo<span class="token punctuation">,</span> <span class="token operator">&amp;</span>overlay<span class="token operator">-&gt;</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>overlay<span class="token operator">-&gt;</span>node <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"%s: failed to unflatten tree\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret_val <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> failed<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"%s: unflattened OK\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span>LINUX_VERSION_CODE <span class="token operator">&gt;=</span> <span class="token number">0x040F00</span><span class="token punctuation">)</span></span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">int</span> ovcs_id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        ret_val <span class="token operator">=</span> <span class="token function">of_overlay_apply</span><span class="token punctuation">(</span>overlay<span class="token operator">-&gt;</span>node<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ovcs_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret_val <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"%s: Failed to apply overlay (ret_val=%d)\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> ret_val<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> failed<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        overlay<span class="token operator">-&gt;</span>id <span class="token operator">=</span> ovcs_id<span class="token punctuation">;</span>
        <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"%s: apply OK(id=%d)\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> ovcs_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    <span class="token punctuation">{</span>
        <span class="token function">of_node_set_flag</span><span class="token punctuation">(</span>overlay<span class="token operator">-&gt;</span>node<span class="token punctuation">,</span> OF_DETACHED<span class="token punctuation">)</span><span class="token punctuation">;</span>

        ret_val <span class="token operator">=</span> <span class="token function">of_resolve_phandles</span><span class="token punctuation">(</span>overlay<span class="token operator">-&gt;</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret_val <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"%s: Failed to resolve tree\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> failed<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"%s: resolved OK\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        ret_val <span class="token operator">=</span> <span class="token function">of_overlay_create</span><span class="token punctuation">(</span>overlay<span class="token operator">-&gt;</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret_val <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"%s: Failed to create overlay (ret_val=%d)\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> ret_val<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> failed<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        overlay<span class="token operator">-&gt;</span>id <span class="token operator">=</span> ret_val<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"%s: create OK\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

  failed<span class="token operator">:</span>
    <span class="token keyword">return</span> ret_val<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * dtbocfg_overlay_item_release() - Relase Device Tree Overlay
 * @overlay: Pointer to Device Tree Overlay Item
 * return    none
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">dtbocfg_overlay_item_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">dtbocfg_overlay_item</span> <span class="token operator">*</span>overlay<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>overlay<span class="token operator">-&gt;</span>id <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span>LINUX_VERSION_CODE <span class="token operator">&gt;=</span> <span class="token number">0x040F00</span><span class="token punctuation">)</span></span></span>
        <span class="token function">of_overlay_remove</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>overlay<span class="token operator">-&gt;</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span>        </span>
        <span class="token function">of_overlay_destroy</span><span class="token punctuation">(</span>overlay<span class="token operator">-&gt;</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>        </span>
        overlay<span class="token operator">-&gt;</span>id <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * container_of_dtbocfg_overlay_item() - Get Device Tree Overlay Item Pointer from Configuration Item
 * @item:  Pointer to Configuration Item
 * return  Pointer to Device Tree Overlay Item
 */</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">struct</span> <span class="token class-name">dtbocfg_overlay_item</span><span class="token operator">*</span> <span class="token function">container_of_dtbocfg_overlay_item</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>item<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> item <span class="token operator">?</span> <span class="token function">container_of</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">dtbocfg_overlay_item</span><span class="token punctuation">,</span> item<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * dtbocfg_overlay_item_status_store() - Set Status Attibute
 * @item:  Pointer to Configuration Item
 * @page:  Pointer to Value Buffer
 * @count: Size of Value Buffer Size
 * return  Stored Size or Error Status.
 */</span>
<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">dtbocfg_overlay_item_status_store</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>item<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">dtbocfg_overlay_item</span> <span class="token operator">*</span>overlay <span class="token operator">=</span> <span class="token function">container_of_dtbocfg_overlay_item</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ssize_t</span>       status<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> value<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">!=</span> <span class="token punctuation">(</span>status <span class="token operator">=</span> <span class="token function">kstrtoul</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">goto</span> failed<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>overlay<span class="token operator">-&gt;</span>id <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">dtbocfg_overlay_item_release</span><span class="token punctuation">(</span>overlay<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>overlay<span class="token operator">-&gt;</span>id  <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">dtbocfg_overlay_item_create</span><span class="token punctuation">(</span>overlay<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> count<span class="token punctuation">;</span>
  failed<span class="token operator">:</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>EPERM<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * dtbocfg_overlay_item_status_show() - Show Status Attibute
 * @item : Pointer to Configuration Item
 * @page : Pointer to Value for Store
 * return  String Size or Error Status.
 */</span>
<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">dtbocfg_overlay_item_status_show</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>item<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>page<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">dtbocfg_overlay_item</span> <span class="token operator">*</span>overlay <span class="token operator">=</span> <span class="token function">container_of_dtbocfg_overlay_item</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> <span class="token string">"%d\n"</span><span class="token punctuation">,</span> overlay<span class="token operator">-&gt;</span>id <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * dtbocfg_overlay_item_dtbo_write() - Write Device Tree Blob to Configuration Item
 * @item : Pointer to Configuration Item
 * @page : Pointer to Value Buffer 
 * @count: Size of Value Buffer
 * return  Stored Size or Error Status.
 */</span>
<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">dtbocfg_overlay_item_dtbo_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>item<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">dtbocfg_overlay_item</span> <span class="token operator">*</span>overlay <span class="token operator">=</span> <span class="token function">container_of_dtbocfg_overlay_item</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>overlay<span class="token operator">-&gt;</span>dtbo_size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>overlay<span class="token operator">-&gt;</span>id <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>EPERM<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">kfree</span><span class="token punctuation">(</span>overlay<span class="token operator">-&gt;</span>dtbo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        overlay<span class="token operator">-&gt;</span>dtbo      <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        overlay<span class="token operator">-&gt;</span>dtbo_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    overlay<span class="token operator">-&gt;</span>dtbo <span class="token operator">=</span> <span class="token function">kmemdup</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> count<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>overlay<span class="token operator">-&gt;</span>dtbo <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        overlay<span class="token operator">-&gt;</span>dtbo_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        overlay<span class="token operator">-&gt;</span>dtbo_size <span class="token operator">=</span> count<span class="token punctuation">;</span>
        <span class="token keyword">return</span> count<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * dtbocfg_overlay_item_dtbo_read() - Read Device Tree Blob from Configuration Item
 * @item : Pointer to Configuration Item
 * @page : Pointer to Value for Store, or NULL to query the buffer size
 * @size : Size of the supplied buffer
 * return  Read Size
 */</span>
<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">dtbocfg_overlay_item_dtbo_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>item<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">dtbocfg_overlay_item</span> <span class="token operator">*</span>overlay <span class="token operator">=</span> <span class="token function">container_of_dtbocfg_overlay_item</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>overlay<span class="token operator">-&gt;</span>dtbo <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>buf <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> overlay<span class="token operator">-&gt;</span>dtbo<span class="token punctuation">,</span> overlay<span class="token operator">-&gt;</span>dtbo_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> overlay<span class="token operator">-&gt;</span>dtbo_size<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * Device Tree Blob Overlay Attribute Structure
 */</span>
<span class="token function">CONFIGFS_BIN_ATTR</span><span class="token punctuation">(</span>dtbocfg_overlay_item_<span class="token punctuation">,</span> dtbo<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1MiB should be way more than enough</span>
<span class="token function">CONFIGFS_ATTR</span><span class="token punctuation">(</span>dtbocfg_overlay_item_<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">configfs_attribute</span> <span class="token operator">*</span>dtbocfg_overlay_attrs<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token operator">&amp;</span>dtbocfg_overlay_item_attr_status<span class="token punctuation">,</span>
    <span class="token constant">NULL</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">configfs_bin_attribute</span> <span class="token operator">*</span>dtbocfg_overlay_bin_attrs<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token operator">&amp;</span>dtbocfg_overlay_item_attr_dtbo<span class="token punctuation">,</span>
    <span class="token constant">NULL</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * dtbocfg_overlay_release() - Release Device Tree Overlay Item
 * @item : Pointer to Configuration Item
 * Return  None
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">dtbocfg_overlay_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>item<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">dtbocfg_overlay_item</span> <span class="token operator">*</span>overlay <span class="token operator">=</span> <span class="token function">container_of_dtbocfg_overlay_item</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">dtbocfg_overlay_item_release</span><span class="token punctuation">(</span>overlay<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>overlay<span class="token operator">-&gt;</span>dtbo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">kfree</span><span class="token punctuation">(</span>overlay<span class="token operator">-&gt;</span>dtbo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        overlay<span class="token operator">-&gt;</span>dtbo      <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        overlay<span class="token operator">-&gt;</span>dtbo_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">kfree</span><span class="token punctuation">(</span>overlay<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * Device Tree Blob Overlay Item Structure
 */</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">configfs_item_operations</span> dtbocfg_overlay_item_ops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>release        <span class="token operator">=</span> dtbocfg_overlay_release<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">config_item_type</span> dtbocfg_overlay_item_type <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>ct_item_ops    <span class="token operator">=</span> <span class="token operator">&amp;</span>dtbocfg_overlay_item_ops<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>ct_attrs       <span class="token operator">=</span> dtbocfg_overlay_attrs<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>ct_bin_attrs   <span class="token operator">=</span> dtbocfg_overlay_bin_attrs<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>ct_owner       <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * dtbocfg_overlay_group_make_item() - Make Device Tree Overlay Group Item
 * @group: Pointer to Configuration Group
 * @name : Pointer to Group Name
 * Return  Pointer to Device Tree Overlay Group Item
 */</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span><span class="token function">dtbocfg_overlay_group_make_item</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_group</span> <span class="token operator">*</span>group<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">dtbocfg_overlay_item</span> <span class="token operator">*</span>overlay<span class="token punctuation">;</span>

    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    overlay <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>overlay<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>overlay<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span><span class="token operator">-</span>ENOMEM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    overlay<span class="token operator">-&gt;</span>id        <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    overlay<span class="token operator">-&gt;</span>dtbo      <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    overlay<span class="token operator">-&gt;</span>dtbo_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token function">config_item_init_type_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>overlay<span class="token operator">-&gt;</span>item<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dtbocfg_overlay_item_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>overlay<span class="token operator">-&gt;</span>item<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * dtbocfg_overlay_group_drop_item() - Drop Device Tree Overlay Group Item
 * @group: Pointer to Configuration Group
 * @item : Pointer to Device Tree Overlay Group Item
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">dtbocfg_overlay_group_drop_item</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_group</span> <span class="token operator">*</span>group<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>item<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">dtbocfg_overlay_item</span> <span class="token operator">*</span>overlay <span class="token operator">=</span> <span class="token function">container_of_dtbocfg_overlay_item</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">config_item_put</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>overlay<span class="token operator">-&gt;</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * Device Tree Blob Overlay Sub Group Structures
 */</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">configfs_group_operations</span> dtbocfg_overlays_ops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>make_item      <span class="token operator">=</span> dtbocfg_overlay_group_make_item<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>drop_item      <span class="token operator">=</span> dtbocfg_overlay_group_drop_item<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">config_item_type</span> dtbocfg_overlays_type <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>ct_group_ops   <span class="token operator">=</span> <span class="token operator">&amp;</span>dtbocfg_overlays_ops<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>ct_owner       <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">config_group</span> dtbocfg_overlay_group<span class="token punctuation">;</span>

<span class="token comment">/**
 * Device Tree Blob Overlay Root Sub System Structures
 */</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">configfs_group_operations</span> dtbocfg_root_ops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">/* empty - we don't allow anything to be created */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">config_item_type</span> dtbocfg_root_type <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>ct_group_ops   <span class="token operator">=</span> <span class="token operator">&amp;</span>dtbocfg_root_ops<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>ct_owner       <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">configfs_subsystem</span> dtbocfg_root_subsys <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>su_group <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span>cg_item <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span>ci_namebuf <span class="token operator">=</span> <span class="token string">"device-tree"</span><span class="token punctuation">,</span>
            <span class="token punctuation">.</span>ci_type    <span class="token operator">=</span> <span class="token operator">&amp;</span>dtbocfg_root_type<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">.</span>su_mutex <span class="token operator">=</span> <span class="token function">__MUTEX_INITIALIZER</span><span class="token punctuation">(</span>dtbocfg_root_subsys<span class="token punctuation">.</span>su_mutex<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * dtbocfg_module_init()
 */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">dtbocfg_module_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> retval <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">config_group_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dtbocfg_root_subsys<span class="token punctuation">.</span>su_group<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">config_group_init_type_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dtbocfg_overlay_group<span class="token punctuation">,</span> <span class="token string">"overlays"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>dtbocfg_overlays_type<span class="token punctuation">)</span><span class="token punctuation">;</span>

    retval <span class="token operator">=</span> <span class="token function">configfs_register_subsystem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dtbocfg_root_subsys<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>retval <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pr_err</span><span class="token punctuation">(</span> <span class="token string">"%s: couldn't register subsys\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> register_subsystem_failed<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    retval <span class="token operator">=</span> <span class="token function">configfs_register_group</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dtbocfg_root_subsys<span class="token punctuation">.</span>su_group<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dtbocfg_overlay_group<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>retval <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pr_err</span><span class="token punctuation">(</span> <span class="token string">"%s: couldn't register group\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> register_group_failed<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"%s: OK\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

  register_group_failed<span class="token operator">:</span>
    <span class="token function">configfs_unregister_subsystem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dtbocfg_root_subsys<span class="token punctuation">)</span><span class="token punctuation">;</span>
  register_subsystem_failed<span class="token operator">:</span>
    <span class="token keyword">return</span> retval<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * dtbocfg_module_exit()
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">dtbocfg_module_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">configfs_unregister_group</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dtbocfg_overlay_group<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">configfs_unregister_subsystem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dtbocfg_root_subsys<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>dtbocfg_module_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>dtbocfg_module_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"ikwzm"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_DESCRIPTION</span><span class="token punctuation">(</span><span class="token string">"Device Tree Overlay Configuration File System"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"Dual BSD/GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="第83-章设备树插件驱动分析实验"><a href="#第83-章设备树插件驱动分析实验" class="headerlink" title="第83 章设备树插件驱动分析实验"></a>第83 章设备树插件驱动分析实验</h2><p>在上个章节中，我们成功移植了设备树插件驱动，而在本章节中，我们将深入研究设备树驱动的分析过程。<br>大家有了configfs 虚拟文件系统数据结构的基础以后，现在分析设备树插件的驱动就非常容易了。<br>网盘资料“<code>iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568 开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\65_dtbocfg</code>”dtbocfg.c 为设备树插件驱动文件。<br>在驱动文件中，生成device-tree/overlays 目录结构，如下图（图83-1）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031135487.png" alt="image-20240903113557377"></p>
<p>在<code>dtbocfg_overlays_type</code> 中实现了<code>ct_group_ops</code> 下的<code>make_item</code> 和<code>drop_item</code>。如下图（图83-2）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031136493.png" alt="image-20240903113643398"></p>
<p>在命令行输入<code>mkdir</code> 命令会去执行的函数，如下图（图83-3）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031137589.png" alt="image-20240903113711478"></p>
<p>在<code>dtbocfg_overlay_item_type</code> 中实现了<code>attrs</code> 和<code>bin_attrs</code> 和<code>ct_item_ops</code>，如下图（图83-4）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031138547.png" alt="image-20240903113800453"></p>
<p>定义了<code>dtbocfg_overlay_item_attr_dtbo</code> 结构体。实现了<code>dtbocfg_overlay_item_dtbo_read</code> 和<code>dtbocfg_overlay_item_dtbo_write</code> 函数，如下图（图83-5）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031138828.png" alt="image-20240903113830732"></p>
<p>重点看当给status 写1 的时候会发生什么事情，如下图（图83-6）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031138321.png" alt="image-20240903113851216"></p>
<p>当status 写入1 的时，会执行<code>dtbocfg_overlay_item_create</code> 函数。在这个函数中又去执行了<code>of_overlay_fdt_apply</code> 函数。<code>of_overlay_fdt_apply</code> 函数如下图（图83-7）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031139391.png" alt="image-20240903113927290"></p>
<p>设备树插件（dtbo）里面的节点也要被转换成device_node，有的device_node 也要被转换成platform_device。不过在进行转换之前，of_overlay_fdt_apply 函数会先创建一个改变集。然后根据这个改变集去进行修改。</p>
<p>创建改变集的目的是为了方便对设备树进行修改和复原。设备树是一种静态的数据结构，一旦被编译和加载到内核中，就难以直接修改。为了解决这个问题，设备树覆盖功能引入了改变集的概念。</p>
<p>改变集是一个描述设备树变化的数据结构，它记录了对设备树的修改操作，如添加、删除或修改节点。通过创建改变集，我们可以在运行时对设备树进行动态修改，而无需修改原始的设备树源文件。</p>
<p>通过创建改变集，我们可以方便地定义需要进行的修改操作，而不必直接操作设备树的底层结构。这提供了一种高层次的抽象，使我们能够以更简洁和可读的方式描述设备树的变化。同时，改变集也可以被保存、传递和应用到其他设备树上，方便在不同系统或环境中进行设备树的配置和定制。</p>
<p>此外，改变集还可以用于设备树的复原。在某些情况下，我们可能需要在运行时撤销对设备树的修改并恢复到原始状态。通过应用反向的改变集，我们可以还原设备树，使其回到修改之前的状态，实现修改的复原。</p>
<p>因此，创建改变集提供了一种方便、可控和可复原的方式来修改设备树，使设备树的管理和配置更加灵活和可靠。</p>
<h2 id="第84-章设备树插件参考资料介绍"><a href="#第84-章设备树插件参考资料介绍" class="headerlink" title="第84 章设备树插件参考资料介绍"></a>第84 章设备树插件参考资料介绍</h2><p>通过上述章节的学习，设备树插件的知识已经学习完了，本章节将介绍设备树插件其他的一些参考资料。<br>在linux 源码中<code>linux_sdk/kernel/Documentation/filesystems/configfs</code> 目录下的configfs.txt。<br>内容解释如下所示：</p>
<p><strong>[什么是configfs?]</strong></p>
<ul>
<li>configfs 是一种基于RAM 的文件系统，提供了与sysfs 功能相反的功能。sysfs 是内核对象的基于文件系统的视图，而configfs 是内核对象（或config_items）的基于文件系统的管理器。</li>
<li>使用sysfs 时，在内核中创建一个对象（例如，当发现设备时），并将其注册到sysfs 中。然后，它的属性会出现在sysfs 中，允许用户空间通过readdir(3)/read(2)读取属性。它可能允许通过write(2)修改某些属性。重要的是，对象在内核中创建和销毁，内核控制sysfs 表示的生命周期，而sysfs 只是对所有这些的一种窗口。</li>
<li>通过显式的用户空间操作（例如mkdir(2)），可以创建一个configfs config_item。通过rmdir(2)销毁它。属性在mkdir(2)时出现，并且可以通过read(2)和write(2)读取或修改。与sysfs 类似，readdir(3)查询项目和/或属性的列表。可以使用symlink(2)将项目组合在一起。与sysfs 不同，表示的生命周期完全由用户空间驱动。支持项目的内核模块必须响应此操作。</li>
<li>sysfs 和configfs 可以并且应该在同一系统上同时存在。它们不是彼此的替代品。</li>
</ul>
<p><strong>【使用configfs】</strong></p>
<ul>
<li><p>configfs 可以作为模块编译或集成到内核中。您可以通过以下方式访问它：</p>
<pre class="line-numbers language-none"><code class="language-none">mount -t configfs none /config<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>除非也加载了客户端模块，否则configfs 树将为空。这些模块将其项目类型注册为configfs 的子系统。一旦加载了客户端子系统，它将显示为/config 下的一个或多个子目录。与sysfs 一样，configfs 树始终存在，无论是否挂载在/config 上。</p>
</li>
<li><p>可以通过mkdir(2)创建项目。项目的属性也将同时出现。readdir(3)可以确定属性是什么，read(2)可以查询其默认值，write(2)可以存储新值。不要在一个属性文件中混合多个属性。</p>
</li>
<li><p>configfs 有两种类型的属性：</p>
<ul>
<li><strong>普通属性（Normal attributes）</strong>类似于sysfs 属性，是小型的ASCII 文本文件，最大大小为一页（PAGE_SIZE，在i386 上为4096）。最好每个文件只使用一个值，并且与sysfs 相同的注意事项也适用。configfs 期望write(2)一次存储整个缓冲区。当写入普通configfs 属性时，用户空间进程应首先读取整个文件，修改要更改的部分，然后将整个缓冲区写回。</li>
<li><strong>二进制属性（Binary attributes）</strong>与sysfs 二进制属性类似，但语义上有一些细微的变化。不适用PAGE_SIZE限制，但整个二进制项必须适应单个内核vmalloc 的缓冲区。来自用户空间的write(2)调用是缓冲的，并且在最终关闭时将调用属性的write_bin_attribute 方法，因此用户空间必须检查close(2)的返回代码以验证操作是否成功完成。为避免恶意用户OOM（Out of Memory）内核，有每个二进制属性的最大缓冲区值。</li>
</ul>
</li>
<li><p>当需要销毁项目时，使用rmdir(2)将其删除。如果任何其他项目通过symlink(2)链接到它，则无法销毁<br>该项目。可以使用unlink(2)删除链接。</p>
</li>
</ul>
<p><strong>【配置FakeNBD：一个示例】</strong></p>
<ul>
<li>假设有一个网络块设备（Network Block Device，NBD）驱动程序，允许您访问远程块设备。将其称为FakeNBD。FakeNBD 使用configfs 进行配置。显然，将有一个方便的程序供系统管理员使用来配置FakeNBD，但某种方式下，该程序必须告知驱动程序。这就是configfs 的用武之地。</li>
<li>加载FakeNBD 驱动程序时，它会向configfs 注册自己。readdir(3)可以看到这一点：</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># ls /config</span>
fakenbd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>可以使用mkdir(2)创建fakenbd 连接。名称是任意的，但工具可能会对名称进行一些处理。也许它是一个UUID 或磁盘名称：</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># mkdir /config/fakenbd/disk1</span>
<span class="token comment"># ls /config/fakenbd/disk1</span>
target device rw<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li>target 属性包含FakeNBD 将连接到的服务器的IP 地址。device 属性是服务器上的设备。可预测的是，rw 属性确定连接是只读还是读写。</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># echo 10.0.0.1 &gt; /config/fakenbd/disk1/target</span>
<span class="token comment"># echo /dev/sda1 &gt; /config/fakenbd/disk1/device</span>
<span class="token comment"># echo 1 &gt; /config/fakenbd/disk1/rw</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li>target 属性包含FakeNBD 将连接到的服务器的IP 地址。device 属性是服务器上的设备。可预测的是，rw 属性确定连接是只读还是读写。</li>
</ul>
<p><strong>【使用configfs 进行编码】</strong></p>
<ul>
<li><p>configfs 中的每个对象都是一个config_item。config_item 反映了子系统中的一个对象。它具有与该对象上的值相匹配的属性。configfs 处理该对象及其属性的文件系统表示，使得子系统只需关注基本的show/store 交互。</p>
</li>
<li><p>项目是在config_group 内创建和销毁的。组是共享相同属性和操作的项目集合。项目通过mkdir(2)创建，并通过rmdir(2)移除，但configfs 会处理这些操作。组具有一组操作来执行这些任务。</p>
</li>
<li><p>子系统是客户端模块的顶层。在初始化过程中，客户端模块向configfs 注册子系统，该子系统将在configfs 文件系统的顶部显示为一个目录。子系统也是一个config_group，并且可以执行config_group 的所有功能。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">[</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span><span class="token punctuation">]</span>

<span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>ci_name<span class="token punctuation">;</span>
    <span class="token keyword">char</span> ci_namebuf<span class="token punctuation">[</span>UOBJ_NAME_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">kref</span> ci_kref<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> ci_entry<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>ci_parent<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">config_group</span> <span class="token operator">*</span>ci_group<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">config_item_type</span> <span class="token operator">*</span>ci_type<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">dentry</span> <span class="token operator">*</span>ci_dentry<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">config_item_init</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">config_item_init_type_name</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span><span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span>
                                <span class="token keyword">struct</span> <span class="token class-name">config_item_type</span> <span class="token operator">*</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span><span class="token function">config_item_get</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">config_item_put</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>通常，struct config_item 被嵌入在一个容器结构中，这个结构实际上代表了子系统正在做的事情。该结构中的config_item 部分是对象与configfs 进行交互的方式。</li>
<li>无论是在源文件中静态定义还是由父config_group 创建，config_item 都必须调用其中一个<code>_init()</code>函数。这将初始化引用计数并设置适当的字段。</li>
<li>所有使用<code>config_item</code> 的用户都应该通过<code>config_item_get()</code>对其进行引用，并在完成后通过<code>config_item_put()</code>释放引用。</li>
<li>单独一个config_item 不能做更多的事情，只能出现在configfs 中。通常，子系统希望该项显示和/或存储属性，以及其他一些操作。为此，它需要一个类型。</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">[</span><span class="token keyword">struct</span> <span class="token class-name">config_item_type</span><span class="token punctuation">]</span>

<span class="token keyword">struct</span> <span class="token class-name">configfs_item_operations</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>release<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>allow_link<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>src<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>drop_link<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>src<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">config_item_type</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>ct_owner<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">configfs_item_operations</span> <span class="token operator">*</span>ct_item_ops<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">configfs_group_operations</span> <span class="token operator">*</span>ct_group_ops<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">configfs_attribute</span> <span class="token operator">*</span><span class="token operator">*</span>ct_attrs<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">configfs_bin_attribute</span> <span class="token operator">*</span><span class="token operator">*</span>ct_bin_attrs<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>config_item_type</code> 的最基本功能是定义可以在<code>config_item</code> 上执行的操作。所有动态分配的项目都需要提供<code>ct_item_ops-&gt;release()</code>方法。当<code>config_item</code> 的引用计数达到零时，将调用此方法。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">[</span><span class="token keyword">struct</span> <span class="token class-name">configfs_attribute</span><span class="token punctuation">]</span>

<span class="token keyword">struct</span> <span class="token class-name">configfs_attribute</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>ca_name<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>ca_owner<span class="token punctuation">;</span>
    <span class="token class-name">umode_t</span> ca_mode<span class="token punctuation">;</span>
    <span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>show<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>store<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>当config_item 希望将属性显示为项目的configfs 目录中的文件时，它必须定义一个描述该属性的configfs_attribute。然后将属性添加到以NULL 结尾的config_item_type-&gt;ct_attrs 数组中。当项目出现在configfs 中时，属性文件将显示为configfs_attribute-&gt;ca_name 文件名。configfs_attribute-&gt;ca_mode 指定文件权限。</p>
</li>
<li><p>如果属性是可读的并提供了一个-&gt;show 方法，每当用户空间请求对属性进行read(2)时，该方法将被调用。如果属性是可写的并提供了一个-&gt;store 方法，每当用户空间请求对属性进行write(2)时，该方法将被调用。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">[</span><span class="token keyword">struct</span> <span class="token class-name">configfs_bin_attribute</span><span class="token punctuation">]</span>

<span class="token keyword">struct</span> <span class="token class-name">configfs_attribute</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">configfs_attribute</span> cb_attr<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>cb_private<span class="token punctuation">;</span>
    <span class="token class-name">size_t</span> cb_max_size<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>当需要使用二进制数据块作为文件内容显示在项目的configfs 目录中时，可以使用二进制属性（binary attribute）。为此，将二进制属性添加到以NULL 结尾的<code>config_item_type-&gt;ct_bin_attrs</code> 数组中，当项目出现在configfs 中时，属性文件将显示为<code>configfs_bin_attribute-&gt;cb_attr.ca_name</code> 文件名。<code>configfs_bin_attribute-&gt;cb_attr.ca_mode</code> 指定文件权限。</p>
</li>
<li><p><code>cb_private</code> 成员供驱动程序使用，而<code>cb_max_size</code> 成员指定要使用的<code>vmalloc</code> 缓冲区的最大大小。</p>
</li>
<li><p>如果二进制属性是可读的，并且<code>config_item</code> 提供了<code>ct_item_ops-&gt;read_bin_attribute()</code>方法，那么每当用户空间请求对属性进行read(2)时，该方法将被调用。对于write(2)，也会发生相反的情况。读取/写入是缓冲的，因此只会发生单个读取/写入；属性本身不需要关心这一点。<code>[struct config_group]</code></p>
</li>
<li><p><code>config_item</code> 不能独立存在。创建<code>config_item</code> 的唯一方法是通过在<code>config_group</code> 上执行mkdir(2)操作。这将触发创建子项。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">config_group</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">config_item</span> cg_item<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> cg_children<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">configfs_subsystem</span> <span class="token operator">*</span>cg_subsys<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> default_groups<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> group_entry<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">config_group_init</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_group</span> <span class="token operator">*</span>group<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">config_group_init_type_name</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_group</span> <span class="token operator">*</span>group<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span>
                                 <span class="token keyword">struct</span> <span class="token class-name">config_item_type</span> <span class="token operator">*</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p><code>config_group</code> 结构包含一个<code>config_item</code>。适当配置该项意味着组可以作为一个独立的项进行操作。然而，它还可以做更多的事情：它可以创建子项或子组。这是通过在组的config_item_type 上指定的组操作来实现的。</p>
</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">configfs_group_operations</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>make_item<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_group</span> <span class="token operator">*</span>group<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">config_group</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>make_group<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_group</span> <span class="token operator">*</span>group<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>commit_item<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>disconnect_notify<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_group</span> <span class="token operator">*</span>group<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>drop_item<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_group</span> <span class="token operator">*</span>group<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


</li>
<li><p>组通过提供ct_group_ops-&gt;make_item()方法来创建子项。如果提供了该方法，它将在组的目录中的mkdir(2)操作中调用。子系统分配一个新的config_item（或更常见的是其容器结构），对其进行初始化，并将其返回给configfs。然后，configfs 将填充文件系统树以反映新的项。</p>
</li>
<li><p>如果子系统希望子项本身成为一个组，子系统将提供ct_group_ops-&gt;make_group()。其他操作与之相同，在组上使用组的_init()函数。</p>
</li>
<li><p>最后，当用户空间对项或组调用rmdir(2)时，将调用ct_group_ops-&gt;drop_item()。由于config_group 也是一个config_item，因此不需要单独的drop_group()方法。子系统必须对在项分配时初始化的引用执行config_item_put()。如果子系统没有其他工作要执行，可以省略ct_group_ops-&gt;drop_item()方法，configfs将代表子系统对项执行config_item_put()。</p>
</li>
<li><p>重要提示：drop_item()是void 类型的，因此无法失败。当调用rmdir(2)时，configfs 将从文件系统树中删除该项（假设没有子项）。子系统负责对此作出响应。如果子系统在其他线程中引用该项，则内存是安全的。实际上，该项从子系统的使用中消失可能需要一些时间。但它已经从configfs 中消失了。</p>
</li>
<li><p>当调用drop_item()时，项的链接已经被拆除。它不再引用其父项，并且在项层次结构中没有位置。如果客户端在此拆除发生之前需要进行一些清理工作，子系统可以实现ct_group_ops-&gt;disconnect_notify()方法。该方法在configfs 将项从文件系统视图中删除之后、但在将项从其父组中删除之前调用。与drop_item()一样，disconnect_notify()是void 类型的，不会失败。客户端子系统不应在此处删除任何引用，因为它们仍然必须在drop_item()中执行。</p>
</li>
<li><p>只要config_group 仍然具有子项，就无法删除它。这在configfs 的rmdir(2)代码中实现。不会调用-&gt;drop_item()，因为项尚未被删除。rmdir(2)将失败，因为目录不为空。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">[</span><span class="token keyword">struct</span> <span class="token class-name">configfs_subsystem</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>子系统通常在module_init 时间注册自身。这告诉configfs 将子系统显示在文件树中。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">configfs_subsystem</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">config_group</span> su_group<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">mutex</span> su_mutex<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">configfs_register_subsystem</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">configfs_subsystem</span> <span class="token operator">*</span>subsys<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">configfs_unregister_subsystem</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">configfs_subsystem</span> <span class="token operator">*</span>subsys<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>一个子系统由一个顶级的config_group 和一个互斥锁组成。config_group 是创建子config_item 的地方。对于子系统来说，这个组通常是静态定义的。在调用configfs_register_subsystem()之前，子系统必须通过常规的group_init()函数对组进行初始化，并且还必须初始化互斥锁。</p>
</li>
<li><p>当注册调用返回时，子系统将处于活动状态，并且将通过configfs 可见。此时，可以调用mkdir(2)，子系统必须准备好接收该调用。</p>
</li>
</ul>
<p><strong>【示例】</strong></p>
<p>这些基本概念的最佳示例是在<code>samples/configfs/configfs_sample.c</code> 中的<code>simple_children</code> 子系统/组和simple_child 项。它展示了一个简单的对象，显示和存储属性，以及一个简单的组来创建和销毁这些子项。</p>
<p><strong>【层次结构导航和子系统互斥锁】</strong></p>
<ul>
<li>configfs 提供了一个额外的功能。由于config_groups 和config_items 出现在文件系统中，它们按层次结构排列。子系统永远不会触及文件系统的部分，但子系统可能对此层次结构感兴趣。因此，层次结构通过<code>config_group-&gt;cg_children</code> 和<code>config_item-&gt;ci_parent</code> 结构成员进行镜像。</li>
<li>子系统可以通过<code>cg_children</code> 列表和ci_parent 指针遍历子系统创建的树。这可能与configfs 对层次结构的管理发生竞争，因此configfs 使用子系统互斥锁来保护修改操作。每当子系统想要遍历层次结构时，必须在子系统互斥锁的保护下进行。</li>
<li>在新分配的项尚未链接到该层次结构时，子系统将无法获取互斥锁。类似地，在放弃项尚未取消链接时，它也无法获取互斥锁。这意味着项的ci_parent 指针在项位于configfs 中时永远不会为NULL，并且项仅在其父项的cg_children 列表中存在相同的时间段。这允许子系统在持有互斥锁时信任ci_parent 和cg_children。</li>
</ul>
<p><strong>【通过symlink(2)进行项聚合】</strong></p>
<ul>
<li>configfs 通过group-&gt;item 父/子关系提供了一个简单的组。然而，通常需要在父/子连接之外进行聚合。这是通过symlink(2)实现的。</li>
<li>config_item 可以提供ct_item_ops-&gt;allow_link()和ct_item_ops-&gt;drop_link()方法。如果存在-&gt;allow_link()方法，可以使用config_item 作为链接源调用symlink(2)。这些链接仅允许在configfs config_item 之间创建。任何在configfs 文件系统之外的symlink(2)尝试都将被拒绝。</li>
<li>调用symlink(2)时，将使用源config_item 的-&gt;allow_link()方法和自身和目标项作为参数。如果源项允许链接到目标项，则返回0。如果源项只希望链接到某种类型的对象（例如，在其自己的子系统中），则可以拒绝链接。</li>
<li>在符号链接上调用unlink(2)时，将通过-&gt;drop_link()方法通知源项。与-&gt;drop_item()方法一样，这是一个无返回值的函数，无法返回失败。子系统负责响应该更改。</li>
<li>在任何项链接到其他项时，无法删除config_item，也无法在有项链接到它时删除config_item。在configfs中，不允许存在悬空的符号链接。</li>
</ul>
<p><strong>【自动创建的子组】</strong></p>
<ul>
<li>新的config_group 可能希望具有两种类型的子config_item。虽然可以通过-&gt;make_item()中的魔术名称来编码这一点，但更明确的做法是让用户空间看到这种分歧的方法。</li>
<li>configfs 提供了一种方法，通过该方法可以在父级创建时自动在其中创建一个或多个子组。因此，mkdir(“parent”)将导致创建”parent”、”parent/subgroup1”，一直到”parent/subgroupN”。类型为1 的项现在可以在”parent/subgroup1”中创建，类型为N 的项可以在”parent/subgroupN”中创建。</li>
<li>这些自动创建的子组，或默认组，不排除父组的其他子项。如果存在ct_group_ops-&gt;make_group()，可以直接在父组上创建其他子组。</li>
<li>通过向父config_group 结构添加它们，configfs 子系统可以指定默认组。这是一个关于configfs 的C 代码示例，它展示了configfs 的一些基本概念和用法。</li>
<li>首先，在代码中定义了一个名为”simple_children”的子系统/组和一个名为”simple_child”的项。这个简单的对象展示了如何显示和存储属性，并且使用一个简单的组来创建和销毁这些子项。</li>
<li>configfs 中的子系统和组是以层次结构排列的，可以通过config_group-&gt;cg_children 和config_item-&gt;ci_parent 来遍历子系统创建的树。为了保护修改操作，configfs 使用了子系统互斥锁。</li>
<li>在代码中还使用了symlink(2)函数来创建项之间的链接。config_item 可以提供allow_link()和drop_link()方法来控制链接的创建和删除。使用symlink(2)函数创建的链接只允许在configfs 中的config_item 之间创建，对于configfs 文件系统之外的symlink(2)尝试会被拒绝。</li>
<li>此外，代码中还介绍了自动创建的子组的概念。通过在父级创建时自动创建一个或多个子组，可以更方便地组织config_item。这些自动创建的子组不会排除父组的其他子项。</li>
<li>这只是一个简单的示例，用于介绍configfs 的基本概念和用法。实际使用configfs 时，可能会有更复杂的场景和用法。</li>
</ul>
<p>Linux 内核源码<code>linux_sdk/kernel/samples/configfs</code> 目录下的<code>configfs_sample.c</code>，如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
 * vim: noexpandtab ts=8 sts=0 sw=8:
 *
 * configfs_example_macros.c - This file is a demonstration module
 *      containing a number of configfs subsystems.  It uses the helper
 *      macros defined by configfs.h
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public
 * License as published by the Free Software Foundation; either
 * version 2 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * General Public License for more details.
 *
 * You should have received a copy of the GNU General Public
 * License along with this program; if not, write to the
 * Free Software Foundation, Inc., 59 Temple Place - Suite 330,
 * Boston, MA 021110-1307, USA.
 *
 * Based on sysfs:
 * 	sysfs is Copyright (C) 2001, 2002, 2003 Patrick Mochel
 *
 * configfs Copyright (C) 2005 Oracle.  All rights reserved.
 */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/configfs.h&gt;</span></span>



<span class="token comment">/*
 * 01-childless
 *
 * This first example is a childless subsystem.  It cannot create
 * any config_items.  It just has attributes.
 *
 * Note that we are enclosing the configfs_subsystem inside a container.
 * This is not necessary if a subsystem has no attributes directly
 * on the subsystem.  See the next example, 02-simple-children, for
 * such a subsystem.
 */</span>

<span class="token keyword">struct</span> <span class="token class-name">childless</span> <span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">configfs_subsystem</span> subsys<span class="token punctuation">;</span>
	<span class="token keyword">int</span> showme<span class="token punctuation">;</span>
	<span class="token keyword">int</span> storeme<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">struct</span> <span class="token class-name">childless</span> <span class="token operator">*</span><span class="token function">to_childless</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>item<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">return</span> item <span class="token operator">?</span> <span class="token function">container_of</span><span class="token punctuation">(</span><span class="token function">to_configfs_subsystem</span><span class="token punctuation">(</span><span class="token function">to_config_group</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token keyword">struct</span> <span class="token class-name">childless</span><span class="token punctuation">,</span> subsys<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">childless_showme_show</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>item<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>page<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">childless</span> <span class="token operator">*</span>childless <span class="token operator">=</span> <span class="token function">to_childless</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">ssize_t</span> pos<span class="token punctuation">;</span>

	pos <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> <span class="token string">"%d\n"</span><span class="token punctuation">,</span> childless<span class="token operator">-&gt;</span>showme<span class="token punctuation">)</span><span class="token punctuation">;</span>
	childless<span class="token operator">-&gt;</span>showme<span class="token operator">++</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> pos<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">childless_storeme_show</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>item<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>page<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> <span class="token string">"%d\n"</span><span class="token punctuation">,</span> <span class="token function">to_childless</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token operator">-&gt;</span>storeme<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">childless_storeme_store</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>item<span class="token punctuation">,</span>
		<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>page<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">childless</span> <span class="token operator">*</span>childless <span class="token operator">=</span> <span class="token function">to_childless</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> tmp<span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> page<span class="token punctuation">;</span>

	tmp <span class="token operator">=</span> <span class="token function">simple_strtoul</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token operator">&amp;</span>p<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">*</span>p <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">*</span>p <span class="token operator">!=</span> <span class="token char">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>tmp <span class="token operator">&gt;</span> INT_MAX<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>ERANGE<span class="token punctuation">;</span>

	childless<span class="token operator">-&gt;</span>storeme <span class="token operator">=</span> tmp<span class="token punctuation">;</span>

	<span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">childless_description_show</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>item<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>page<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span>
<span class="token string">"[01-childless]\n"</span>
<span class="token string">"\n"</span>
<span class="token string">"The childless subsystem is the simplest possible subsystem in\n"</span>
<span class="token string">"configfs.  It does not support the creation of child config_items.\n"</span>
<span class="token string">"It only has a few attributes.  In fact, it isn't much different\n"</span>
<span class="token string">"than a directory in /proc.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">CONFIGFS_ATTR_RO</span><span class="token punctuation">(</span>childless_<span class="token punctuation">,</span> showme<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">CONFIGFS_ATTR</span><span class="token punctuation">(</span>childless_<span class="token punctuation">,</span> storeme<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">CONFIGFS_ATTR_RO</span><span class="token punctuation">(</span>childless_<span class="token punctuation">,</span> description<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">configfs_attribute</span> <span class="token operator">*</span>childless_attrs<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token operator">&amp;</span>childless_attr_showme<span class="token punctuation">,</span>
	<span class="token operator">&amp;</span>childless_attr_storeme<span class="token punctuation">,</span>
	<span class="token operator">&amp;</span>childless_attr_description<span class="token punctuation">,</span>
	<span class="token constant">NULL</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">config_item_type</span> childless_type <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span>ct_attrs	<span class="token operator">=</span> childless_attrs<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>ct_owner	<span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">childless</span> childless_subsys <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span>subsys <span class="token operator">=</span> <span class="token punctuation">{</span>
		<span class="token punctuation">.</span>su_group <span class="token operator">=</span> <span class="token punctuation">{</span>
			<span class="token punctuation">.</span>cg_item <span class="token operator">=</span> <span class="token punctuation">{</span>
				<span class="token punctuation">.</span>ci_namebuf <span class="token operator">=</span> <span class="token string">"01-childless"</span><span class="token punctuation">,</span>
				<span class="token punctuation">.</span>ci_type <span class="token operator">=</span> <span class="token operator">&amp;</span>childless_type<span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token comment">/* ----------------------------------------------------------------- */</span>

<span class="token comment">/*
 * 02-simple-children
 *
 * This example merely has a simple one-attribute child.  Note that
 * there is no extra attribute structure, as the child's attribute is
 * known from the get-go.  Also, there is no container for the
 * subsystem, as it has no attributes of its own.
 */</span>

<span class="token keyword">struct</span> <span class="token class-name">simple_child</span> <span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">config_item</span> item<span class="token punctuation">;</span>
	<span class="token keyword">int</span> storeme<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">struct</span> <span class="token class-name">simple_child</span> <span class="token operator">*</span><span class="token function">to_simple_child</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>item<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">return</span> item <span class="token operator">?</span> <span class="token function">container_of</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">simple_child</span><span class="token punctuation">,</span> item<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">simple_child_storeme_show</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>item<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>page<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> <span class="token string">"%d\n"</span><span class="token punctuation">,</span> <span class="token function">to_simple_child</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token operator">-&gt;</span>storeme<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">simple_child_storeme_store</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>item<span class="token punctuation">,</span>
		<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>page<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">simple_child</span> <span class="token operator">*</span>simple_child <span class="token operator">=</span> <span class="token function">to_simple_child</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> tmp<span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> page<span class="token punctuation">;</span>

	tmp <span class="token operator">=</span> <span class="token function">simple_strtoul</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token operator">&amp;</span>p<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">*</span>p <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">*</span>p <span class="token operator">!=</span> <span class="token char">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>tmp <span class="token operator">&gt;</span> INT_MAX<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>ERANGE<span class="token punctuation">;</span>

	simple_child<span class="token operator">-&gt;</span>storeme <span class="token operator">=</span> tmp<span class="token punctuation">;</span>

	<span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">CONFIGFS_ATTR</span><span class="token punctuation">(</span>simple_child_<span class="token punctuation">,</span> storeme<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">configfs_attribute</span> <span class="token operator">*</span>simple_child_attrs<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token operator">&amp;</span>simple_child_attr_storeme<span class="token punctuation">,</span>
	<span class="token constant">NULL</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">simple_child_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>item<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">kfree</span><span class="token punctuation">(</span><span class="token function">to_simple_child</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">configfs_item_operations</span> simple_child_item_ops <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span>release		<span class="token operator">=</span> simple_child_release<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">config_item_type</span> simple_child_type <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span>ct_item_ops	<span class="token operator">=</span> <span class="token operator">&amp;</span>simple_child_item_ops<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>ct_attrs	<span class="token operator">=</span> simple_child_attrs<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>ct_owner	<span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token keyword">struct</span> <span class="token class-name">simple_children</span> <span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">config_group</span> group<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">struct</span> <span class="token class-name">simple_children</span> <span class="token operator">*</span><span class="token function">to_simple_children</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>item<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">return</span> item <span class="token operator">?</span> <span class="token function">container_of</span><span class="token punctuation">(</span><span class="token function">to_config_group</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token keyword">struct</span> <span class="token class-name">simple_children</span><span class="token punctuation">,</span> group<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span><span class="token function">simple_children_make_item</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_group</span> <span class="token operator">*</span>group<span class="token punctuation">,</span>
		<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">simple_child</span> <span class="token operator">*</span>simple_child<span class="token punctuation">;</span>

	simple_child <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">simple_child</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>simple_child<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span><span class="token operator">-</span>ENOMEM<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">config_item_init_type_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>simple_child<span class="token operator">-&gt;</span>item<span class="token punctuation">,</span> name<span class="token punctuation">,</span>
				   <span class="token operator">&amp;</span>simple_child_type<span class="token punctuation">)</span><span class="token punctuation">;</span>

	simple_child<span class="token operator">-&gt;</span>storeme <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token operator">&amp;</span>simple_child<span class="token operator">-&gt;</span>item<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">simple_children_description_show</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>item<span class="token punctuation">,</span>
		<span class="token keyword">char</span> <span class="token operator">*</span>page<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span>
<span class="token string">"[02-simple-children]\n"</span>
<span class="token string">"\n"</span>
<span class="token string">"This subsystem allows the creation of child config_items.  These\n"</span>
<span class="token string">"items have only one attribute that is readable and writeable.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">CONFIGFS_ATTR_RO</span><span class="token punctuation">(</span>simple_children_<span class="token punctuation">,</span> description<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">configfs_attribute</span> <span class="token operator">*</span>simple_children_attrs<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token operator">&amp;</span>simple_children_attr_description<span class="token punctuation">,</span>
	<span class="token constant">NULL</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">simple_children_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>item<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">kfree</span><span class="token punctuation">(</span><span class="token function">to_simple_children</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">configfs_item_operations</span> simple_children_item_ops <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span>release	<span class="token operator">=</span> simple_children_release<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * Note that, since no extra work is required on -&gt;drop_item(),
 * no -&gt;drop_item() is provided.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">configfs_group_operations</span> simple_children_group_ops <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span>make_item	<span class="token operator">=</span> simple_children_make_item<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">config_item_type</span> simple_children_type <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span>ct_item_ops	<span class="token operator">=</span> <span class="token operator">&amp;</span>simple_children_item_ops<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>ct_group_ops	<span class="token operator">=</span> <span class="token operator">&amp;</span>simple_children_group_ops<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>ct_attrs	<span class="token operator">=</span> simple_children_attrs<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>ct_owner	<span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">configfs_subsystem</span> simple_children_subsys <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span>su_group <span class="token operator">=</span> <span class="token punctuation">{</span>
		<span class="token punctuation">.</span>cg_item <span class="token operator">=</span> <span class="token punctuation">{</span>
			<span class="token punctuation">.</span>ci_namebuf <span class="token operator">=</span> <span class="token string">"02-simple-children"</span><span class="token punctuation">,</span>
			<span class="token punctuation">.</span>ci_type <span class="token operator">=</span> <span class="token operator">&amp;</span>simple_children_type<span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token comment">/* ----------------------------------------------------------------- */</span>

<span class="token comment">/*
 * 03-group-children
 *
 * This example reuses the simple_children group from above.  However,
 * the simple_children group is not the subsystem itself, it is a
 * child of the subsystem.  Creation of a group in the subsystem creates
 * a new simple_children group.  That group can then have simple_child
 * children of its own.
 */</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">config_group</span> <span class="token operator">*</span><span class="token function">group_children_make_group</span><span class="token punctuation">(</span>
		<span class="token keyword">struct</span> <span class="token class-name">config_group</span> <span class="token operator">*</span>group<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">simple_children</span> <span class="token operator">*</span>simple_children<span class="token punctuation">;</span>

	simple_children <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">simple_children</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
				  GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>simple_children<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span><span class="token operator">-</span>ENOMEM<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">config_group_init_type_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>simple_children<span class="token operator">-&gt;</span>group<span class="token punctuation">,</span> name<span class="token punctuation">,</span>
				    <span class="token operator">&amp;</span>simple_children_type<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token operator">&amp;</span>simple_children<span class="token operator">-&gt;</span>group<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">group_children_description_show</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">config_item</span> <span class="token operator">*</span>item<span class="token punctuation">,</span>
		<span class="token keyword">char</span> <span class="token operator">*</span>page<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span>
<span class="token string">"[03-group-children]\n"</span>
<span class="token string">"\n"</span>
<span class="token string">"This subsystem allows the creation of child config_groups.  These\n"</span>
<span class="token string">"groups are like the subsystem simple-children.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">CONFIGFS_ATTR_RO</span><span class="token punctuation">(</span>group_children_<span class="token punctuation">,</span> description<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">configfs_attribute</span> <span class="token operator">*</span>group_children_attrs<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token operator">&amp;</span>group_children_attr_description<span class="token punctuation">,</span>
	<span class="token constant">NULL</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * Note that, since no extra work is required on -&gt;drop_item(),
 * no -&gt;drop_item() is provided.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">configfs_group_operations</span> group_children_group_ops <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span>make_group	<span class="token operator">=</span> group_children_make_group<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">config_item_type</span> group_children_type <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span>ct_group_ops	<span class="token operator">=</span> <span class="token operator">&amp;</span>group_children_group_ops<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>ct_attrs	<span class="token operator">=</span> group_children_attrs<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>ct_owner	<span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">configfs_subsystem</span> group_children_subsys <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span>su_group <span class="token operator">=</span> <span class="token punctuation">{</span>
		<span class="token punctuation">.</span>cg_item <span class="token operator">=</span> <span class="token punctuation">{</span>
			<span class="token punctuation">.</span>ci_namebuf <span class="token operator">=</span> <span class="token string">"03-group-children"</span><span class="token punctuation">,</span>
			<span class="token punctuation">.</span>ci_type <span class="token operator">=</span> <span class="token operator">&amp;</span>group_children_type<span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/* ----------------------------------------------------------------- */</span>

<span class="token comment">/*
 * We're now done with our subsystem definitions.
 * For convenience in this module, here's a list of them all.  It
 * allows the init function to easily register them.  Most modules
 * will only have one subsystem, and will only call register_subsystem
 * on it directly.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">configfs_subsystem</span> <span class="token operator">*</span>example_subsys<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token operator">&amp;</span>childless_subsys<span class="token punctuation">.</span>subsys<span class="token punctuation">,</span>
	<span class="token operator">&amp;</span>simple_children_subsys<span class="token punctuation">,</span>
	<span class="token operator">&amp;</span>group_children_subsys<span class="token punctuation">,</span>
	<span class="token constant">NULL</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">configfs_example_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>
	<span class="token keyword">int</span> i<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">configfs_subsystem</span> <span class="token operator">*</span>subsys<span class="token punctuation">;</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> example_subsys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		subsys <span class="token operator">=</span> example_subsys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

		<span class="token function">config_group_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>subsys<span class="token operator">-&gt;</span>su_group<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>subsys<span class="token operator">-&gt;</span>su_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		ret <span class="token operator">=</span> <span class="token function">configfs_register_subsystem</span><span class="token punctuation">(</span>subsys<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"Error %d while registering subsystem %s\n"</span><span class="token punctuation">,</span>
			       ret<span class="token punctuation">,</span>
			       subsys<span class="token operator">-&gt;</span>su_group<span class="token punctuation">.</span>cg_item<span class="token punctuation">.</span>ci_namebuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">goto</span> out_unregister<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

out_unregister<span class="token operator">:</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span>
		<span class="token function">configfs_unregister_subsystem</span><span class="token punctuation">(</span>example_subsys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">configfs_example_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">int</span> i<span class="token punctuation">;</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> example_subsys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token function">configfs_unregister_subsystem</span><span class="token punctuation">(</span>example_subsys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>configfs_example_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>configfs_example_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面的驱动文件，大家可以好好分析下代码。至此，设备树模型课程学习完毕。</p>
<h1 id="第九篇设备模型"><a href="#第九篇设备模型" class="headerlink" title="第九篇设备模型"></a>第九篇设备模型</h1><h2 id="第85-章设备模型基本框架-kobject-和kset"><a href="#第85-章设备模型基本框架-kobject-和kset" class="headerlink" title="第85 章设备模型基本框架-kobject 和kset"></a>第85 章设备模型基本框架-kobject 和kset</h2><h3 id="85-1-什么是设备模型"><a href="#85-1-什么是设备模型" class="headerlink" title="85.1 什么是设备模型"></a>85.1 什么是设备模型</h3><p>字符设备驱动通常适用于相对简单的设备，对于一些更复杂的功能，比如说电源管理和热插拔事件管理，使用字符设备框架可能不够灵活和高效。<strong>为了应对更复杂的设备和功能，Linux内核提供了设备模型</strong>。设备模型允许开发人员以更高级的方式来描述硬件设备和它们之间的关系，并提供一组通用API 和机制来处理设备的注册，热插拔事件，电源管理等。</p>
<p>通过使用设备模型，驱动开发人员可以将更多的底层功能交给内核来处理，而不必重复实现这些基础功能。这使得驱动的编写更加高级和模块化，减少了重复工作和出错的可能性。对于一些常见的硬件设备，如USB、i2c 和平台设备，内核已经提供了相应的设备模型和相关驱动，开发人员可以基于这些模型来编写驱动，从而更快地实现特定设备的功能，并且可以借助内核的电源管理和热插拔事件管理功能。</p>
<p>总之，使用设备模型可以帮助简化驱动开发过程，并提供更高级的功能和灵活性，使得驱动开发人员能够更好地适应复杂的硬件设备需求。</p>
<h3 id="85-2-设备模型的好处"><a href="#85-2-设备模型的好处" class="headerlink" title="85.2 设备模型的好处"></a>85.2 设备模型的好处</h3><p>设备模型在内核驱动中扮演着重要的角色，它提供了一种统一的方式来描述硬件设备和它们之间的关系。以下是设备模型在内核驱动中的几个重要方面。</p>
<ul>
<li>1 <strong>代码复用</strong>：设备模型允许多个设备复用同一个驱动。通过在设备树或总线上定义不同的设备节点，这些设备可以使用相同的驱动进行初始化和管理。这样可以减少代码的冗余，提高驱动的复用性和维护性。</li>
<li>2 <strong>资源的动态申请和释放</strong>：设备模型提供了一种机制来动态申请和释放设备所需的资源，如内存，中断等。驱动可以使用这些机制来管理设备所需的资源，确保在设备初始化和关闭时进行正确的资源分配和释放。</li>
<li>3 <strong>简化驱动编写</strong>: 设备模型提供了一组通用API 和机制，使得驱动编写更加简化和模块化。开发人员可以使用这些API 来注册设备，处理设备事件，进行设备的读写操作等，而无需重复实现这些通用功能。</li>
<li>4 <strong>热插拔机制</strong>：设备模型支持热插拔机制，能够在运行时动态添加或移除设备。当设备插入或拔出时，内核会生成相应的热插拔事件，驱动可以通过监听这些事件来执行相应的操作，如设备的初始化或释放。</li>
<li>5 <strong>驱动的面向对象思想</strong>：设备模型的设计借鉴了面向对象编程（OOP）的思想。每个设备都被看作是一个对象，具有自己的属性和方法，并且可以通过设备模型的机制进行继承和扩展。这种设计使得驱动的编写更加模块化和可扩展，可以更好地应对不同类型的设备和功能需求。</li>
</ul>
<p>总之，设备模型在内核驱动中扮演着关键的角色，通过提供统一的设备描述和管理机制，简化了驱动的编写和维护过程，提高了代码的复用性和可维护性，并支持热插拔和动态资源管理等重要功能。</p>
<h3 id="85-3-kobject-和kset-基本概念"><a href="#85-3-kobject-和kset-基本概念" class="headerlink" title="85.3 kobject 和kset 基本概念"></a>85.3 kobject 和kset 基本概念</h3><p><strong>kobject 和kset 是Linux 内核中用于管理内核对象的基本概念。</strong><br>**kobject(内核对象)**是内核中抽象出来的通用对象模型，用于表示内核中的各种实体。kobject是一个结构体，其中包含了一些描述该对象的属性和方法。它提供了一种统一的接口和机制，用于管理和操作内核对象。kobject 结构体在内核源码<code>kernel/include/linux/kobject.h</code> 文件中，如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> entry<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>parent<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">kset</span> <span class="token operator">*</span>kset<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">kobj_type</span> <span class="token operator">*</span>ktype<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">kernfs_node</span> <span class="token operator">*</span>sd<span class="token punctuation">;</span> <span class="token comment">/* sysfs directory entry */</span>
    <span class="token keyword">struct</span> <span class="token class-name">kref</span> kref<span class="token punctuation">;</span>
    
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_DEBUG_KOBJECT_RELEASE</span></span>
        <span class="token keyword">struct</span> <span class="token class-name">delayed_work</span> release<span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> state_initialized<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> state_in_sysfs<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> state_add_uevent_sent<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> state_remove_uevent_sent<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> uevent_suppress<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">ANDROID_KABI_RESERVE</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ANDROID_KABI_RESERVE</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ANDROID_KABI_RESERVE</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ANDROID_KABI_RESERVE</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这是Linux 内核中的struct kobject 结构体的定义。它包含了一些字段用于表示和管理内核对象。<br>下面是一些主要字段的解释：</p>
<ul>
<li>const char *name：表示kobject 的名称，通常用于在/sys 目录下创建对应的目录。</li>
<li>struct list_head entry：用于将kobject 链接到父kobject 的子对象列表中，以建立层次关系。</li>
<li>struct kobject *parent：指向父kobject，表示kobject 的层次关系。</li>
<li>struct kset *kset：指向包含该kobject 的kset，用于进一步组织和管理kobject。</li>
<li>struct kobj_type *ktype：指向定义kobject 类型的kobj_type 结构体，描述kobject 的属性和操作。</li>
<li>struct kernfs_node *sd：指向sysfs 目录中对应的kernfs_node，用于访问和操作sysfs 目录项。</li>
<li>struct kref kref：用于对kobject 进行引用计数，确保在不再使用时能够正确释放资源。</li>
<li>unsigned int 字段：表示一些状态标志和配置选项，例如是否已初始化、是否在sysfs 中、是否发送了add/remove uevent 等。</li>
</ul>
<p>该结构体还包含了一些与特定配置相关的保留字段。这些字段共同构成了kobject 的基本属性和关系，用于在内核中表示和管理不同类型的内核对象。通过这些字段，可以建立层次化的关系，进行资源管理和操作。每一个kobject 都会对应系统/sys/下的一个目录，如下图所示。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031426620.png" alt="image-20240903142614500"></p>
<p>之前我们在学习平台总线时，查看平台总线要进入/sys/bus 目录下，bus 目录下的文件都是和总线相关的目录，比如amba 总线，CPU 总线，platform 总线。如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031426096.png" alt="image-20240903142626983"></p>
<p><code>kobject</code> 表示系统<code>/sys</code> 下的一个目录，而目录又是有多个层次，所以对应kobject 的树状关系如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031426339.png" alt="image-20240903142655212"></p>
<p>我们来分析一下上图。在kobject 结构体中，parent 指针用于表示父kobject，从而建立了kobject 之间的层次关系，类似于目录结构中的父目录和子目录的关系。一个kobject 可以有一个父kobject 和多个子kobject，通过parent 指针可以将它们连接起来形成一个层次化的结构，类似于目录结构中，一个目录可以有一个父目录和多个子目录，通过目录的路径可以表示目录之间的层次关系。这种层次化的关系可以方便地进行遍历，查找和管理，使得内核对象能够按照层次关系进行组织和管理。这种设计使得kobject 的树状结构在内核中具有很高的灵活性和可扩展性。</p>
<p>接下来我们继续学习kset。<br>**kset(内核对象集合)**是一种用于组织和管理一组相关kobject 的容器。kset 是kobject 的一种扩展，它提供了一种层次化的组织结构，可以将一组相关的kobject 组织在一起。kset 在内核里面用struct kset 结构体来表示，定义在<code>include/linux/kobject.h</code> 头文件中，如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">kset</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> list<span class="token punctuation">;</span>
    <span class="token class-name">spinlock_t</span> list_lock<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">kobject</span> kobj<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">kset_uevent_ops</span> <span class="token operator">*</span>uevent_ops<span class="token punctuation">;</span>
    <span class="token function">ANDROID_KABI_RESERVE</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ANDROID_KABI_RESERVE</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ANDROID_KABI_RESERVE</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ANDROID_KABI_RESERVE</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> __randomize_layout<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这是Linux 内核中的struct kset 结构体的定义。<strong>kset 是一种用于组织和管理kobject 的集合</strong>。下面是一些主要字段的解释：</p>
<ul>
<li>struct list_head list：用于将kset 链接到全局kset 链表中，以便对kset 进行遍历和管理。</li>
<li>spinlock_t list_lock：用于保护对kset 链表的并发访问，确保线程安全性。</li>
<li>struct kobject kobj：作为kset 的kobject 表示，用于在/sys 目录下创建对应的目录，并与kset 关联。</li>
<li>const struct kset_uevent_ops *uevent_ops：指向kset 的uevent 操作的结构体，用于处理与kset 相关的uevent 事件。</li>
</ul>
<p>该结构体还包含了一些与特定配置相关的保留字段。kset 通过包含一个kobject 作为其成员，将kset 本身表示为一个kobject，并使用kobj 来管理和操作kset。通过list 字段，kset 可以链接到全局kset 链表中，以便进行全局的遍历和管理。同时，list_lock 字段用于保护对kset 链表的并发访问。kset 还可以定义自己的uevent 操作，用于处理与kset 相关的uevent 事件，例如在添加或删除kobject 时发送相应的uevent 通知。</p>
<p>这些字段共同构成了kset 的基本属性和关系，用于在内核中组织和管理一组相关的kobject。kset 提供了一种层次化的组织结构，并与sysfs 目录相对应，方便对kobject 进行管理和操作。</p>
<h3 id="85-4-kset-和kobject-的关系"><a href="#85-4-kset-和kobject-的关系" class="headerlink" title="85.4 kset 和kobject 的关系"></a>85.4 kset 和kobject 的关系</h3><p>在Linux 内核中，kset 和kobject 是相关联的两个概念，它们之间存在一种层次化的关系，</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409031429326.png" alt="image-20240903142939186"></p>
<ol>
<li>kset 是kobject 的一种扩展：kset 可以被看作是kobject 的一种特殊形式，它扩展了kobject并提供了一些额外的功能。kset 可以包含多个kobject，形成一个层次化的组织结构。</li>
<li>kobject 属于一个kset：每个kobject 都属于一个kset。kobject 结构体中的struct kset *kset字段指向所属的kset。这个关联关系表示了kobject 所在的集合或组织。</li>
</ol>
<p>通过kset 和kobject 之间的关系，可以实现对内核对象的层次化管理和操作。kset 提供了对kobject 的集合管理接口，可以通过kset 来迭代、查找、添加或删除kobject。同时，kset 也提供了特定于集合的功能，例如在集合级别处理uevent 事件。<br>总结起来，kset 和kobject 之间的关系是：一个kset 可以包含多个kobject，而一个kobject只能属于一个kset。kset 提供了对kobject 的集合管理和操作接口，用于组织和管理具有相似特性或关系的kobject。这种关系使得内核能够以一种统一的方式管理和操作不同类型的内核对象。</p>
<h2 id="第86-章创建kobject-实验"><a href="#第86-章创建kobject-实验" class="headerlink" title="第86 章创建kobject 实验"></a>第86 章创建kobject 实验</h2><p>本章节是关于创建kobject 的实践，通过使用kobject 的API 函数来创建系统根目录下的目录。本章介绍了两种创建kobject 的方法，一种是使用kobject_create_and_add 函数，另一种是使用kzalloc 和kobject_init_and_add 函数，还介绍了如何释放创建的kobject。最后，实验演示了将驱动程序加载到开发板上，并验证了创建的kobject 是否成功。</p>
<h3 id="86-1-实验程序的编写"><a href="#86-1-实验程序的编写" class="headerlink" title="86.1 实验程序的编写"></a>86.1 实验程序的编写</h3><h4 id="86-1-1-驱动程序编写"><a href="#86-1-1-驱动程序编写" class="headerlink" title="86.1.1 驱动程序编写"></a>86.1.1 驱动程序编写</h4><p>本实验对应的网盘路径为：<code>iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\66_make_kobj\module</code>。<br>我们编写驱动代码演示如何在Linux 内核模块中创建和管理kobject 对象，其中包括俩种方法创建kobject 对象，分别使用<code>kobject_create_and_add</code> 和<code>kobject_init_and_add</code> 函数。通过这些操作，可以创建具有层次关系的kobject 对象，并在模块初始化和退出时进行相应的管理的释放。编写完成的make_kobj.c 代码如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/configfs.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kobject.h&gt;</span></span>

<span class="token comment">// 定义了三个kobject指针变量：mykobject01、mykobject02、mykobject03</span>
<span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>mykobject01<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>mykobject02<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>mykobject03<span class="token punctuation">;</span>

<span class="token comment">// 定义了一个kobj_type结构体变量mytype，用于描述kobject的类型。</span>
<span class="token keyword">struct</span> <span class="token class-name">kobj_type</span> mytype<span class="token punctuation">;</span>
<span class="token comment">// 模块的初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">mykobj_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token comment">// 创建kobject的第一种方法</span>
    <span class="token comment">// 创建并添加了名为"mykobject01"的kobject对象，父kobject为NULL</span>
    mykobject01 <span class="token operator">=</span> <span class="token function">kobject_create_and_add</span><span class="token punctuation">(</span><span class="token string">"mykobject01"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建并添加了名为"mykobject02"的kobject对象，父kobject为mykobject01。</span>
    mykobject02 <span class="token operator">=</span> <span class="token function">kobject_create_and_add</span><span class="token punctuation">(</span><span class="token string">"mykobject02"</span><span class="token punctuation">,</span> mykobject01<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建kobject的第二种方法</span>
    <span class="token comment">// 1 使用kzalloc函数分配了一个kobject对象的内存</span>
    mykobject03 <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2 初始化并添加到内核中，名为"mykobject03"。</span>
    ret <span class="token operator">=</span> <span class="token function">kobject_init_and_add</span><span class="token punctuation">(</span>mykobject03<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mytype<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"mykobject03"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 模块退出函数</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">mykobj_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 释放了之前创建的kobject对象</span>
    <span class="token function">kobject_put</span><span class="token punctuation">(</span>mykobject01<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">kobject_put</span><span class="token punctuation">(</span>mykobject02<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">kobject_put</span><span class="token punctuation">(</span>mykobject03<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>mykobj_init<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定模块的初始化函数</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>mykobj_exit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定模块的退出函数</span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 模块使用的许可证</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"topeet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 模块的作者</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="86-2-运行测试"><a href="#86-2-运行测试" class="headerlink" title="86.2 运行测试"></a>86.2 运行测试</h3><h4 id="86-2-1-编译驱动程序"><a href="#86-2-1-编译驱动程序" class="headerlink" title="86.2.1 编译驱动程序"></a>86.2.1 编译驱动程序</h4><p>在上一小节中的make_kobj.c 代码同一目录下创建Makefile 文件，Makefile 文件内容如下所示：然后使用命令“make”进行驱动的编译，编译完生成make_kobj.ko 目标文件，至此驱动模块就编译成功了，接下来进行测试。</p>
<h4 id="81-2-2-运行测试-1"><a href="#81-2-2-运行测试-1" class="headerlink" title="81.2.2 运行测试"></a>81.2.2 运行测试</h4><p>开发板启动之后，使用以下命令进行驱动模块的加载，如下图（图86-4）所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">insmod make_kobj.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409061112430.png" alt="image-20240906111236295"></p>
<p>驱动加载之后，我们进入/sys/目录下，如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409061129349.png" alt="image-20240906112957261"></p>
<p>如上图所示，我们发现kobject01，kobject03 创建在系统根目录/sys 目录下，kobject02 的父节点是kobject01，所以被创建在mykobject02 目录下。现在我们成功验证了创建kobject 就是在系统根目录/sys 目录下创建一个文件夹，他们是一一对应的关系。<br>最后可以使用以下命令进行驱动的卸载，如下图（图86-6）所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">rmmod make_kobj<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409061131561.png" alt="image-20240906113122480"></p>
<p>至此，创建kobject 实验就完成了。</p>
<h2 id="第87-章创建kset-实验"><a href="#第87-章创建kset-实验" class="headerlink" title="第87 章创建kset 实验"></a>第87 章创建kset 实验</h2><p>本章节是关于在Linux 上创建kset 的实验。在实验中介绍了如何使用代码创建kset，并将多个kobject 与kset 关联起来。通过演示实验现象，讲解了kset 是一组kobject 的集合，并解释了kobject 在sys 目录下生成的原因。</p>
<h3 id="87-1-实验程序的编写"><a href="#87-1-实验程序的编写" class="headerlink" title="87.1 实验程序的编写"></a>87.1 实验程序的编写</h3><h4 id="87-1-1-驱动程序编写"><a href="#87-1-1-驱动程序编写" class="headerlink" title="87.1.1 驱动程序编写"></a>87.1.1 驱动程序编写</h4><p>本实验对应的网盘路径为：iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\67_make_kset\module。<br>我们编写驱动代码，这段代码用于定义并初始化两个自定义内核对象mykobject01 和mykobject02，并将它们添加到一个自定义内核对象集合mykset 中。这些自定义内核对象可以用于在Linux 内核中表示和管理特定的功能或资源。代码中的注释对各个部分进行了解释，帮助理解代码的功能。编写完成的make_kset.c 代码如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/configfs.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kobject.h&gt;</span></span>

<span class="token comment">// 定义kobject结构体指针，用于表示第一个自定义内核对象</span>
<span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>mykobject01<span class="token punctuation">;</span>
<span class="token comment">// 定义kobject结构体指针，用于表示第二个自定义内核对象</span>
<span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>mykobject02<span class="token punctuation">;</span>
<span class="token comment">// 定义kset结构体指针，用于表示自定义内核对象的集合</span>
<span class="token keyword">struct</span> <span class="token class-name">kset</span> <span class="token operator">*</span>mykset<span class="token punctuation">;</span>
<span class="token comment">// 定义kobj_type结构体，用于定义自定义内核对象的类型</span>
<span class="token keyword">struct</span> <span class="token class-name">kobj_type</span> mytype<span class="token punctuation">;</span>

<span class="token comment">// 模块的初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">mykobj_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    <span class="token comment">// 创建并添加kset，名称为"mykset"，父kobject为NULL，属性为NULL</span>
    mykset <span class="token operator">=</span> <span class="token function">kset_create_and_add</span><span class="token punctuation">(</span><span class="token string">"mykset"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 为mykobject01分配内存空间，大小为struct kobject的大小，标志为GFP_KERNEL</span>
    mykobject01 <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将mykset设置为mykobject01的kset属性</span>
    mykobject01<span class="token operator">-&gt;</span>kset <span class="token operator">=</span> mykset<span class="token punctuation">;</span>
    <span class="token comment">// 初始化并添加mykobject01，类型为mytype，父kobject为NULL，格式化字符串为"mykobject01"</span>
    ret <span class="token operator">=</span> <span class="token function">kobject_init_and_add</span><span class="token punctuation">(</span>mykobject01<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mytype<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"mykobject01"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 为mykobject02分配内存空间，大小为struct kobject的大小，标志为GFP_KERNEL</span>
    mykobject02 <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将mykset设置为mykobject02的kset属性</span>
    mykobject02<span class="token operator">-&gt;</span>kset <span class="token operator">=</span> mykset<span class="token punctuation">;</span>
    <span class="token comment">// 初始化并添加mykobject02，类型为mytype，父kobject为NULL，格式化字符串为"mykobject02"</span>
    ret <span class="token operator">=</span> <span class="token function">kobject_init_and_add</span><span class="token punctuation">(</span>mykobject02<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mytype<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"mykobject02"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 模块退出函数</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">mykobj_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 释放mykobject01的引用计数</span>
    <span class="token function">kobject_put</span><span class="token punctuation">(</span>mykobject01<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 释放mykobject02的引用计数</span>
    <span class="token function">kobject_put</span><span class="token punctuation">(</span>mykobject02<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>mykobj_init<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定模块的初始化函数</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>mykobj_exit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定模块的退出函数</span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 模块使用的许可证</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"topeet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 模块的作者</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="87-2-运行测试"><a href="#87-2-运行测试" class="headerlink" title="87.2 运行测试"></a>87.2 运行测试</h3><h4 id="87-2-1-编译驱动程序"><a href="#87-2-1-编译驱动程序" class="headerlink" title="87.2.1 编译驱动程序"></a>87.2.1 编译驱动程序</h4><p>在上一小节中的make_kset.c 代码同一目录下创建Makefile 文件，Makefile 文件内容如下所示：然后使用命令“make”进行驱动的编译，编译完生成make_kset.ko 目标文件，至此驱动模块就编译成功了，接下来进行测试。</p>
<h4 id="87-2-2-运行测试"><a href="#87-2-2-运行测试" class="headerlink" title="87.2.2 运行测试"></a>87.2.2 运行测试</h4><p>开发板启动之后，使用以下命令进行驱动模块的加载，如下图（图87-4）所示：</p>
<pre class="line-numbers language-none"><code class="language-none">insmod make_kset.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409061133388.png" alt="image-20240906113320309"></p>
<p>驱动加载之后，我们进入<code>/sys/</code>目录下，可以看到创建生成的<code>kset</code>，如下图所示，我们进到<code>mykset</code> 目录下，可以看到创建的<code>kobject</code>。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409061133670.png" alt="image-20240906113336586"></p>
<p>最后可以使用以下命令进行驱动的卸载，如下图（图87-6）所示：</p>
<pre class="line-numbers language-none"><code class="language-none">rmmod make_kset<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>至此，创建kset 实验就完成了。</p>
<h2 id="第88-章为什么要引入设备模型"><a href="#第88-章为什么要引入设备模型" class="headerlink" title="第88 章为什么要引入设备模型"></a>第88 章为什么要引入设备模型</h2><h3 id="88-1-设备模型简介"><a href="#88-1-设备模型简介" class="headerlink" title="88.1 设备模型简介"></a>88.1 设备模型简介</h3><p>设备模型在内核驱动中扮演着关键的角色，通过提供统一的设备描述和管理机制，简化了驱动的编写和维护过程，提高了代码的复用性和可维护性，并支持热插拔和动态资源管理等重要功能。设备模型包含以下四个概念：</p>
<ol>
<li><strong>总线（Bus）</strong>：总线是设备模型中的基础组件，用于连接和传输数据的通信通道。总线可以是物理总线（如PCI、USB）或虚拟总线（如虚拟设备总线）。总线提供了设备之间进行通信和数据传输的基本机制。</li>
<li><strong>设备（Device）</strong>：设备是指计算机系统中的硬件设备，例如网卡、显示器、键盘等。每个设备都有一个唯一的标识符，用于在系统中进行识别和管理。<strong>设备模型通过设备描述符来描述设备的属性和特性</strong>。</li>
<li><strong>驱动（Driver）</strong>：驱动是设备模型中的软件组件，用于控制和管理设备的操作。每个设备都需要相应的驱动程序来与操作系统进行交互和通信。<strong>驱动程序负责向设备发送命令、接收设备事件、进行设备配置等操作</strong>。</li>
<li><strong>类（Class）</strong>：类是设备模型中的逻辑组织单元，用于对具有相似功能和特性的设备进行分类和管理。类定义了一组共享相同属性和行为的设备的集合。<strong>通过设备类，可以对设备进行分组、识别和访问</strong>。</li>
</ol>
<p>设备模型的设计目的是为了提供一种统一的方式来管理和操作系统中的各种硬件设备。通过将设备、驱动和总线等概念进行抽象和标准化，设备模型可以提供一致的接口和数据结构，简化驱动开发和设备管理，并实现设备的兼容性和可移植性。</p>
<h3 id="88-2-相关结构体"><a href="#88-2-相关结构体" class="headerlink" title="88.2 相关结构体"></a>88.2 相关结构体</h3><p>在Linux 设备模型中，虚构了一条名为“<code>platform</code>”的总线，用来连接一些直接与CPU 相连的设备控制器。这种设备控制器通常不符合常见的总线标准，比如PCI 总线和USB 总线，所以Linux 使用platform 总线来管理这些设备。Platform 总线允许设备控制器与设备驱动程序进行通信和交互。设备控制器在设备树中定义，并通过设备树与对应的设备驱动程序匹配。在设备模型中，Platform 总线提供了一种统一的接口和机制来注册和管理这些设备控制器。设备驱动程序可以通过注册到Platform 总线的方式，与相应的设备控制器进行绑定和通信。设备驱动程序可以访问设备控制器的寄存器、配置设备、处理中断等操作，如下图所示：</p>
<img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409061141252.png" alt="image-20240906114119162" style="zoom:80%;">

<p>当作为嵌入式/驱动开发人员时，了解<strong>设备，驱动程序，总线和类</strong>这几个结构体的概念和关系非常重要。尽管在芯片原厂提供的BSP 中已经实现了设备模型，但是了解这些概念可以帮助您更好地理解设备的工作原理，驱动程序的编写和设备的管理。</p>
<h4 id="88-2-1-struct-bus-type"><a href="#88-2-1-struct-bus-type" class="headerlink" title="88.2.1 struct bus_type"></a>88.2.1 <code>struct bus_type</code></h4><p><code>bus_type</code> 结构体是Linux 内核中用于描述总线的数据结构，定义在<code>include/linux/device.h</code>头文件中。以下是对<code>bus_type</code> 结构体的一般定义。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">bus_type</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>dev_name<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev_root<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">attribute_group</span> <span class="token operator">*</span><span class="token operator">*</span>bus_groups<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">attribute_group</span> <span class="token operator">*</span><span class="token operator">*</span>dev_groups<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">attribute_group</span> <span class="token operator">*</span><span class="token operator">*</span>drv_groups<span class="token punctuation">;</span>
    
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>match<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">device_driver</span> <span class="token operator">*</span>drv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>uevent<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">kobj_uevent_env</span> <span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>probe<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>sync_state<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>remove<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>shutdown<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>online<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>offline<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>suspend<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token class-name">pm_message_t</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>resume<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>num_vf<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>dma_configure<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">dev_pm_ops</span> <span class="token operator">*</span>pm<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">iommu_ops</span> <span class="token operator">*</span>iommu_ops<span class="token punctuation">;</span>
    
    <span class="token keyword">struct</span> <span class="token class-name">subsys_private</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">lock_class_key</span> lock_key<span class="token punctuation">;</span>
    bool need_parent_lock<span class="token punctuation">;</span>
    
    <span class="token function">ANDROID_KABI_RESERVE</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ANDROID_KABI_RESERVE</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ANDROID_KABI_RESERVE</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ANDROID_KABI_RESERVE</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>以下是结构体包含的成员和其作用的简要说明</p>
<ul>
<li>name:总线类型的名称</li>
<li>dev_name:总线设备名称</li>
<li>dev_root: 总线设备的根设备</li>
<li>bus_groups: 总线类型的属性组</li>
<li>dev_groups: 设备的属性组</li>
<li>drv_groups: 驱动程序的属性组</li>
</ul>
<p>以下是一些回调函数成员</p>
<ul>
<li>match: 设备和驱动程序之间的匹配函数</li>
<li>uevent:设备的事件处理函数</li>
<li>probe: 设备的探测函数</li>
<li>sync_state: 设备状态同步函数</li>
<li>remove: 设备的移除函数</li>
<li>online:设备上线函数</li>
<li>offline：设备离线函数</li>
<li>suspend: 设备的挂起函数</li>
<li>resume: 设备的恢复函数</li>
<li>num_vf: 设备的虚拟功能数目函数</li>
<li>dma_configure:设备的DMA 配置函数</li>
</ul>
<p>以下是一些其他成员：</p>
<ul>
<li>pm：设备的电源管理操作。</li>
<li>iommu_ops：设备的IOMMU 操作。</li>
<li>p：子系统私有数据。</li>
<li>lock_key：用于锁机制的锁类别键。</li>
<li>need_parent_lock：是否需要父级锁。</li>
</ul>
<h4 id="88-2-2-struct-device"><a href="#88-2-2-struct-device" class="headerlink" title="88.2.2 struct device"></a>88.2.2 <code>struct device</code></h4><p>device 结构体是Linux 内核中用于描述设备的数据结构，定义在include/linux/device.h 头文件中。以下是device 结构体的一般定义：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token punctuation">{</span>
    <span class="token comment">//设备的父设备</span>
    <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>parent<span class="token punctuation">;</span>
    <span class="token comment">//私有指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_private</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
    <span class="token comment">//对应的kobj</span>
    <span class="token keyword">struct</span> <span class="token class-name">kobject</span> kobj<span class="token punctuation">;</span>
    <span class="token comment">//设备初始化的名字</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>init_name<span class="token punctuation">;</span>
    <span class="token comment">//设备类型</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_type</span> <span class="token operator">*</span>type<span class="token punctuation">;</span>
    <span class="token comment">//设备所属的总线</span>
    <span class="token keyword">struct</span> <span class="token class-name">bus_type</span> <span class="token operator">*</span>bus<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_driver</span> <span class="token operator">*</span>driver<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">//设备所属的类</span>
    <span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span>class<span class="token punctuation">;</span>
    <span class="token comment">//设备的属性组</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">attribute_group</span> <span class="token operator">*</span><span class="token operator">*</span>groups<span class="token punctuation">;</span> <span class="token comment">/* optional groups */</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="88-2-3-struct-device-driver"><a href="#88-2-3-struct-device-driver" class="headerlink" title="88.2.3 struct device_driver"></a>88.2.3 <code>struct device_driver</code></h4><p><code>struct device_driver</code> 是Linux 内核中描述<strong>设备驱动程序</strong>的数据结构， 定义在<code>include/linux/device.h</code> 头文件中。以下是<code>struct device_driver</code> 的一般定义：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">device_driver</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">bus_type</span> <span class="token operator">*</span>bus<span class="token punctuation">;</span>
    
    <span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>owner<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>mod_name<span class="token punctuation">;</span> <span class="token comment">/* used for built-in modules */</span>
    
    bool suppress_bind_attrs<span class="token punctuation">;</span> <span class="token comment">/* disables bind/unbind via sysfs */</span>
    <span class="token keyword">enum</span> <span class="token class-name">probe_type</span> probe_type<span class="token punctuation">;</span>
    
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> <span class="token operator">*</span>of_match_table<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">acpi_device_id</span> <span class="token operator">*</span>acpi_match_table<span class="token punctuation">;</span>
    
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>probe<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>sync_state<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>remove<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>shutdown<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>suspend<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token class-name">pm_message_t</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>resume<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">attribute_group</span> <span class="token operator">*</span><span class="token operator">*</span>groups<span class="token punctuation">;</span>
    
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">dev_pm_ops</span> <span class="token operator">*</span>pm<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>coredump<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">struct</span> <span class="token class-name">driver_private</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
    
    <span class="token function">ANDROID_KABI_RESERVE</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ANDROID_KABI_RESERVE</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ANDROID_KABI_RESERVE</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ANDROID_KABI_RESERVE</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>以下是该结构体包含的成员和其作用的简要说明。</p>
<ul>
<li>name:设备驱动程序的名称</li>
<li>bus: 设备驱动程序所属的总线类型</li>
<li>owner：拥有该驱动程序的模块。</li>
<li>mod_name：用于内置模块的名称。</li>
<li>suppress_bind_attrs：禁用通过sysfs 进行绑定/解绑的属性。</li>
<li>probe_type：探测类型，用于指定探测的方式。</li>
<li>of_match_table：Open Firmware（OF）设备匹配表。</li>
<li>acpi_match_table：ACPI 设备匹配表。</li>
<li>groups：驱动程序的属性组。</li>
<li>pm：电源管理操作。</li>
<li>p：驱动程序的私有数据。</li>
</ul>
<p>以下是一些回调函数成员</p>
<ul>
<li>probe:设备的探测函数，用于初始化和配置设备，注意：device 和device_driver 必须挂在同一个bus 下。这样才可以触发probe</li>
<li>sync_state: 设备状态同步函数</li>
<li>remove:设备的移除函数</li>
<li>shutdown: 设备的关机函数</li>
<li>suspend: 设备的挂起函数</li>
<li>resume: 设备的恢复函数</li>
<li>coredump: 设备的核心转储函数</li>
</ul>
<h4 id="88-2-4-struct-class"><a href="#88-2-4-struct-class" class="headerlink" title="88.2.4 struct class"></a>88.2.4 <code>struct class</code></h4><p><code>struct class</code> 是Linux 内核中描述设备类的数据结构，定义在<code>include/linux/device.h</code> 头文件中。以下是struct class 的一般定义：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>owner<span class="token punctuation">;</span>
    
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">attribute_group</span> <span class="token operator">*</span><span class="token operator">*</span>class_groups<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">attribute_group</span> <span class="token operator">*</span><span class="token operator">*</span>dev_groups<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>dev_kobj<span class="token punctuation">;</span>
    
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>dev_uevent<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">kobj_uevent_env</span> <span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>devnode<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token class-name">umode_t</span> <span class="token operator">*</span>mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>class_release<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span>class<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>dev_release<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>shutdown_pre<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">kobj_ns_type_operations</span> <span class="token operator">*</span>ns_type<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>namespace<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>get_ownership<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token class-name">kuid_t</span> <span class="token operator">*</span>uid<span class="token punctuation">,</span> <span class="token class-name">kgid_t</span> <span class="token operator">*</span>gid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">dev_pm_ops</span> <span class="token operator">*</span>pm<span class="token punctuation">;</span>
    
    <span class="token keyword">struct</span> <span class="token class-name">subsys_private</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
    
    <span class="token function">ANDROID_KABI_RESERVE</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ANDROID_KABI_RESERVE</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ANDROID_KABI_RESERVE</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ANDROID_KABI_RESERVE</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>以下是该结构体包含的成员和其作用的简要说明</p>
<ul>
<li>name : 设备类的名称</li>
<li>owner：拥有该类的模块</li>
</ul>
<p>以下是一些属性组成员</p>
<ul>
<li>class_groups: 类属性组， 用于描述设备类的属性， 在类注册到内核时， 会自动在/sys/class/xxx_class 下创建对应的属性文件</li>
<li>dev_groups: 设备属性组，用于描述设备的属性，在类注册到内核时，会自动在该类下的设备目录创建对应的属性文件</li>
<li>dev_kobj: 设备的内核对象</li>
</ul>
<p>以下是一些回调函数成员</p>
<ul>
<li>dev_uevent :设备的事件处理函数</li>
<li>devnode : 生成设备节点的函数</li>
</ul>
<p>以下是一些其他成员</p>
<ul>
<li>class_release: 类资源的释放函数</li>
<li>dev_release: 设备资源的释放函数</li>
<li>shutdown_pre: 设备关机前的回调函数</li>
<li>ns_type: 命名空间类型操作</li>
<li>namespace: 命名空间函数</li>
<li>get_ownership: 获取设备所有权的函数</li>
<li>pm: 电源管理操作</li>
<li>p: 子系统私有数据</li>
</ul>
<h2 id="第89-章进一步探究设备模型"><a href="#第89-章进一步探究设备模型" class="headerlink" title="第89 章进一步探究设备模型"></a>第89 章进一步探究设备模型</h2><p>在前面的章节中，我们介绍了设备模型四个重要的组成部分：<strong>总线，设备，驱动，类</strong>。然而，要更深入地理解设备模型，我们需要进一步探究其代码层面的实现。在第86 章节实验中，我们创建了kobject。本章节我们从代码的层面分析下——为什么当创建kobj 的时候，父节点为NULL，会在系统根目录/sys 目录下创建呢。</p>
<h3 id="89-1-什么是sysfs-文件系统"><a href="#89-1-什么是sysfs-文件系统" class="headerlink" title="89.1 什么是sysfs 文件系统"></a>89.1 什么是sysfs 文件系统</h3><p><strong><code>sysfs</code> 文件系统是Linux 内核提供的一种虚拟文件系统，用于向用户空间提供内核中设备，驱动程序和其他内核对象的信息</strong>。它以一种层次结构的方式组织数据，并将这些数据表示为文件和目录，使得用户空间可以通过文件系统接口访问和操作内核对象的属性。</p>
<p>sysfs 提供了一种统一的接口，用于浏览和管理内核中的设备、总线、驱动程序和其他内核对象。它在/sys 目录下挂载，用户可以通过查看和修改/sys 目录下的文件和目录来获取和配置内核对象的信息。</p>
<h3 id="89-2-设备模型的基本框架"><a href="#89-2-设备模型的基本框架" class="headerlink" title="89.2 设备模型的基本框架"></a>89.2 设备模型的基本框架</h3><p><strong>为什么说kobject 和kset 是设备模型的基本框架呢</strong>？本小节来进行详细阐述。<br><strong>当使用kobject 时，通常不会单独使用它，而是将其嵌入到一个数据结构中</strong>。这样做的目的是将高级对象接入到设备模型中。比如cdev 结构体和platform_device 结构体，如下所示：</p>
<p>cdev 结构体如下所示，其成员有kobject</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">cdev</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">kobject</span> kobj<span class="token punctuation">;</span>		<span class="token comment">//内嵌到cdev 中的kobject</span>
    <span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>owner<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> <span class="token operator">*</span>ops<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> list<span class="token punctuation">;</span>
    <span class="token class-name">dev_t</span> dev<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>platform_device 结构体如下所示，其成员有device 结构体，在device 结构体中包含了kobject结构体。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span>name<span class="token punctuation">;</span>
    <span class="token keyword">int</span> id<span class="token punctuation">;</span>
    bool id_auto<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">device</span> dev<span class="token punctuation">;</span>					<span class="token comment">//会在这个结构体下面</span>
    u32 num_resources<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">resource</span> <span class="token operator">*</span>resource<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">platform_device_id</span> <span class="token operator">*</span>id_entry<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>driver_override<span class="token punctuation">;</span> 			<span class="token comment">/* Driver name to force a match */</span>
    <span class="token comment">/* MFD cell pointer */</span>
    <span class="token keyword">struct</span> <span class="token class-name">mfd_cell</span> <span class="token operator">*</span>mfd_cell<span class="token punctuation">;</span>
    <span class="token comment">/* arch specific additions */</span>
    <span class="token keyword">struct</span> <span class="token class-name">pdev_archdata</span> archdata<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>device 结构体如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token punctuation">{</span>
    <span class="token comment">//设备的父设备</span>
    <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>parent<span class="token punctuation">;</span>
    <span class="token comment">//私有指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_private</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
    
    <span class="token comment">//对应的kobj</span>
    <span class="token keyword">struct</span> <span class="token class-name">kobject</span> kobj<span class="token punctuation">;</span>
    
    <span class="token comment">//设备初始化的名字</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>init_name<span class="token punctuation">;</span>
    <span class="token comment">//设备类型</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_type</span> <span class="token operator">*</span>type<span class="token punctuation">;</span>
    <span class="token comment">//设备所属的总线</span>
    <span class="token keyword">struct</span> <span class="token class-name">bus_type</span> <span class="token operator">*</span>bus<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_driver</span> <span class="token operator">*</span>driver<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">//设备所属的类</span>
    <span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span>class<span class="token punctuation">;</span>
    <span class="token comment">//设备的属性组</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">attribute_group</span> <span class="token operator">*</span><span class="token operator">*</span>groups<span class="token punctuation">;</span> <span class="token comment">/* optional groups */</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以我们也可以把<strong>总线，设备，驱动看作是kobject 的派生类</strong>。因为他们都是设备模型中的实体，通过继承或扩展kobject 来实现与设备模型的集成。<br>在Linux 内核中，kobject 是一个通用的基础结构，用于构建设备模型。每个kobject 实例对应于sys 目录下的一个目录，这个目录包含了该kobject 相关的属性，操作和状态信息。如下图所示：（纠正：下图的bus的kobject的子右边 应该是derive的kobject）</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409061201199.png" alt="image-20240906120105090"></p>
<p>因此，可以说kobject 是设备模型的基石，通过创建对应的目录结构和属性文件， 它提供了一个统一的接口和框架，用于管理和操作设备模型中的各个实体。</p>
<h3 id="89-3-代码层面分析"><a href="#89-3-代码层面分析" class="headerlink" title="89.3 代码层面分析"></a>89.3 代码层面分析</h3><p>在系统启动的时候会在/sys 目录下创建以下目录，如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409061357788.png" alt="image-20240906135716693"></p>
<p>让我们从代码层面一层层解释一下为什么当使用<code>kobject_create_and_add()</code>函数创建kobject 时，父节点为NULL 会在系统根目录/sys 下创建。<br>逐步追踪路径如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">kobject_create_and_add<span class="token operator">-&gt;</span>kobject_add<span class="token operator">-&gt;</span>kobject_add_varg<span class="token operator">-&gt;</span>kobject_add_internal<span class="token operator">-&gt;</span>
    create_dir<span class="token operator">-&gt;</span>sysfs_create_dir_ns（fs<span class="token operator">/</span>sysfs<span class="token operator">/</span>dir<span class="token punctuation">.</span>c）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>接下来我们看一下<code>kobject_create_and_add</code> 函数实现，如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span><span class="token function">kobject_create_and_add</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>parent<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">;</span>
    <span class="token keyword">int</span> retval<span class="token punctuation">;</span>
    kobj <span class="token operator">=</span> <span class="token function">kobject_create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>kobj<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    retval <span class="token operator">=</span> <span class="token function">kobject_add</span><span class="token punctuation">(</span>kobj<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>retval<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pr_warn</span><span class="token punctuation">(</span><span class="token string">"%s: kobject_add error: %d\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> retval<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">kobject_put</span><span class="token punctuation">(</span>kobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        kobj <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> kobj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">EXPORT_SYMBOL_GPL</span><span class="token punctuation">(</span>kobject_create_and_add<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在上述代码中，首先调用了<code>kobject_create()</code>函数创建看一个新的kobject。该函数分配了一个新的kobject 结构体，并对其进行初始化，包括将kobject 的name 字段设置为传入的name参数，将kobject 的parent 字段设置为传入的parent 参数。</p>
<p>接下来，函数调用<code>kobject_add()</code>将新创建的kobject 添加到设备模型中，我们进一步追究下kobject_add()实现，如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">kobject_add</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>parent<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    va_list args<span class="token punctuation">;</span>
    <span class="token keyword">int</span> retval<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>kobj<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>kobj<span class="token operator">-&gt;</span>state_initialized<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"kobject '%s' (%p): tried to add an uninitialized object, something is seriously wrong.\n"</span><span class="token punctuation">,</span><span class="token function">kobject_name</span><span class="token punctuation">(</span>kobj<span class="token punctuation">)</span><span class="token punctuation">,</span> kobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">dump_stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">va_start</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> fmt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    retval <span class="token operator">=</span> <span class="token function">kobject_add_varg</span><span class="token punctuation">(</span>kobj<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> fmt<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">va_end</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> retval<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在上述函数中，函数调用<code>kobject_add_varg()</code>，该函数会根据传入的参数将kobj 添加到设备模型中。<code>kobject_add_varg()</code>函数的实现可能会根据具体情况进行一些额外的处理，例如创建对应的目录并设置父节点等。我们进一步探究下<code>kobject_add_varg()</code>函数的实现，如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token function">__printf</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">int</span> <span class="token function">kobject_add_varg</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>parent<span class="token punctuation">,</span>
                                           <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>fmt<span class="token punctuation">,</span> va_list vargs<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> retval<span class="token punctuation">;</span>
    retval <span class="token operator">=</span> <span class="token function">kobject_set_name_vargs</span><span class="token punctuation">(</span>kobj<span class="token punctuation">,</span> fmt<span class="token punctuation">,</span> vargs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>retval<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"kobject: can not set name properly!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> retval<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    kobj<span class="token operator">-&gt;</span>parent <span class="token operator">=</span> parent<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">kobject_add_internal</span><span class="token punctuation">(</span>kobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在上述函数中，<code>kobject_add_varg()</code>函数用于将指定的kobject 添加到设备模型中。它通过调用<code>kobject_set_name_vargs()</code>设置kobject 的名称，并将父节点赋值给kobject 的parent 字段。然后，它调用<code>kobject_add_internal()</code>函数执行实际的添加操作。接下来我们进一步探究下<code>kobject_add_internal()</code>函数的实现，如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">kobject_add_internal</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> error <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>parent<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>kobj<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOENT<span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>kobj<span class="token operator">-&gt;</span>name <span class="token operator">||</span> <span class="token operator">!</span>kobj<span class="token operator">-&gt;</span>name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">WARN</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"kobject: (%p): attempted to be registered with empty name!\n"</span><span class="token punctuation">,</span>kobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    parent <span class="token operator">=</span> <span class="token function">kobject_get</span><span class="token punctuation">(</span>kobj<span class="token operator">-&gt;</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* join kset if set, use it as parent if we do not already have one */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>kobj<span class="token operator">-&gt;</span>kset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>parent<span class="token punctuation">)</span>
            parent <span class="token operator">=</span> <span class="token function">kobject_get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kobj<span class="token operator">-&gt;</span>kset<span class="token operator">-&gt;</span>kobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">kobj_kset_join</span><span class="token punctuation">(</span>kobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        kobj<span class="token operator">-&gt;</span>parent <span class="token operator">=</span> parent<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"kobject: '%s' (%p): %s: parent: '%s', set: '%s'\n"</span><span class="token punctuation">,</span>\
             <span class="token function">object_name</span><span class="token punctuation">(</span>kobj<span class="token punctuation">)</span><span class="token punctuation">,</span> kobj<span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span>
             parent <span class="token operator">?</span> <span class="token function">kobject_name</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">"&lt;NULL&gt;"</span><span class="token punctuation">,</span>
             kobj<span class="token operator">-&gt;</span>kset <span class="token operator">?</span> <span class="token function">kobject_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kobj<span class="token operator">-&gt;</span>kset<span class="token operator">-&gt;</span>kobj<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">"&lt;NULL&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    error <span class="token operator">=</span> <span class="token function">create_dir</span><span class="token punctuation">(</span>kobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">kobj_kset_leave</span><span class="token punctuation">(</span>kobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">kobject_put</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        kobj<span class="token operator">-&gt;</span>parent <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token comment">/* be noisy on error issues */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">==</span> <span class="token operator">-</span>EEXIST<span class="token punctuation">)</span>
            <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"%s failed for %s with -EEXIST, don't try to register things with the same name in the same directory.\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">,</span> <span class="token function">kobject_name</span><span class="token punctuation">(</span>kobj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"%s failed for %s (error: %d parent: %s)\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">,</span> <span class="token function">kobject_name</span><span class="token punctuation">(</span>kobj<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                   error<span class="token punctuation">,</span>parent <span class="token operator">?</span> <span class="token function">kobject_name</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">"'none'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
    <span class="token keyword">else</span>
        kobj<span class="token operator">-&gt;</span>state_in_sysfs <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> error<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>kobject_add_internal()</code>函数用于在设备模型中添加指定的kobject。它会检查kobject 的有效性和名称是否为空，并处理kobject 所属的kset 相关的操作。然后，它会创建kobject 在sysfs中的目录，并处理创建失败的情况。最后，它会设置kobject 的相关状态，并返回相应的错误。我们继续追究<code>create_dir()</code>函数的实现，如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">create_dir</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">kobj_ns_type_operations</span> <span class="token operator">*</span>ops<span class="token punctuation">;</span>
    
    <span class="token keyword">int</span> error<span class="token punctuation">;</span>
    error <span class="token operator">=</span> <span class="token function">sysfs_create_dir_ns</span><span class="token punctuation">(</span>kobj<span class="token punctuation">,</span> <span class="token function">kobject_namespace</span><span class="token punctuation">(</span>kobj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        <span class="token keyword">return</span> error<span class="token punctuation">;</span>
    
    error <span class="token operator">=</span> <span class="token function">populate_dir</span><span class="token punctuation">(</span>kobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">sysfs_remove_dir</span><span class="token punctuation">(</span>kobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> error<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/*
    * @kobj-&gt;sd may be deleted by an ancestor going away. Hold an
    * extra reference so that it stays until @kobj is gone.
    */</span>
    <span class="token function">sysfs_get</span><span class="token punctuation">(</span>kobj<span class="token operator">-&gt;</span>sd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/*
    * If @kobj has ns_ops, its children need to be filtered based on
    * their namespace tags. Enable namespace support on @kobj-&gt;sd.
    */</span>
    ops <span class="token operator">=</span> <span class="token function">kobj_child_ns_ops</span><span class="token punctuation">(</span>kobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ops<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">BUG_ON</span><span class="token punctuation">(</span>ops<span class="token operator">-&gt;</span>type <span class="token operator">&lt;=</span> KOBJ_NS_TYPE_NONE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">BUG_ON</span><span class="token punctuation">(</span>ops<span class="token operator">-&gt;</span>type <span class="token operator">&gt;=</span> KOBJ_NS_TYPES<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">BUG_ON</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">kobj_ns_type_registered</span><span class="token punctuation">(</span>ops<span class="token operator">-&gt;</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token function">sysfs_enable_ns</span><span class="token punctuation">(</span>kobj<span class="token operator">-&gt;</span>sd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>create_dir()</code>函数用于创建与给定kobject 相关联的目录，并填充该目录。它还处理了引用计数、命名空间操作等相关的逻辑。如果创建目录或填充目录时发生错误，函数会相应地处理并返回错误码。函数调用<code>sysfs_create_dir_ns()</code>函数来创建与kobj 相关联的目录。<code>sysfs_create_dir_ns</code>实现如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/**
* sysfs_create_dir_ns - create a directory for an object with a namespace tag
* @kobj: object we're creating directory for
* @ns: the namespace tag to use
*/</span>
<span class="token keyword">int</span> <span class="token function">sysfs_create_dir_ns</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>ns<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">kernfs_node</span> <span class="token operator">*</span>parent<span class="token punctuation">,</span> <span class="token operator">*</span>kn<span class="token punctuation">;</span>
    <span class="token class-name">kuid_t</span> uid<span class="token punctuation">;</span>
    <span class="token class-name">kgid_t</span> gid<span class="token punctuation">;</span>
    <span class="token function">BUG_ON</span><span class="token punctuation">(</span><span class="token operator">!</span>kobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>kobj<span class="token operator">-&gt;</span>parent<span class="token punctuation">)</span>
        parent <span class="token operator">=</span> kobj<span class="token operator">-&gt;</span>parent<span class="token operator">-&gt;</span>sd<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        parent <span class="token operator">=</span> sysfs_root_kn<span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>parent<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOENT<span class="token punctuation">;</span>
    <span class="token function">kobject_get_ownership</span><span class="token punctuation">(</span>kobj<span class="token punctuation">,</span> <span class="token operator">&amp;</span>uid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>gid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    kn <span class="token operator">=</span> <span class="token function">kernfs_create_dir_ns</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> <span class="token function">kobject_name</span><span class="token punctuation">(</span>kobj<span class="token punctuation">)</span><span class="token punctuation">,</span>
                              S_IRWXU <span class="token operator">|</span> S_IRUGO <span class="token operator">|</span> S_IXUGO<span class="token punctuation">,</span> uid<span class="token punctuation">,</span> gid<span class="token punctuation">,</span>kobj<span class="token punctuation">,</span> ns<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>kn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PTR_ERR</span><span class="token punctuation">(</span>kn<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span>EEXIST<span class="token punctuation">)</span>
            <span class="token function">sysfs_warn_dup</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> <span class="token function">kobject_name</span><span class="token punctuation">(</span>kobj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>kn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    kobj<span class="token operator">-&gt;</span>sd <span class="token operator">=</span> kn<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在上面的函数中，当没有父节点的时候，父节点被赋值成了<code>sysfs_root_kn</code>，即<code>/sys</code> 目录根目录的节点。如果有<code>parent</code>，则它的父节点为<code>kobj-&gt;parent-&gt;sd</code>，然后调用<code>kernfs_create_dir_ns</code>创建目录。那么<code>sysfs_root_kn</code> 是在什么时候创建的呢？我们找到<code>fs/sysfs/mount.c</code> 文件，如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __init <span class="token function">sysfs_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> err<span class="token punctuation">;</span>
    sysfs_root <span class="token operator">=</span> <span class="token function">kernfs_create_root</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> KERNFS_ROOT_EXTRA_OPEN_PERM_CHECK<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>sysfs_root<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>sysfs_root<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    sysfs_root_kn <span class="token operator">=</span> sysfs_root<span class="token operator">-&gt;</span>kn<span class="token punctuation">;</span>
    err <span class="token operator">=</span> <span class="token function">register_filesystem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sysfs_fs_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">kernfs_destroy_root</span><span class="token punctuation">(</span>sysfs_root<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>通过上述对API 函数的分析，我们可以总结出创建目录的规律，如下所示：</p>
<ul>
<li>1、无父目录、无kset，则将在sysfs 的根目录（即/sys/）下创建目录。</li>
<li>2、无父目录、有kset，则将在kset 下创建目录，并将kobj 加入kset.list。</li>
<li>3、有父目录、无kset，则将在parent 下创建目录。</li>
<li>4、有父目录、有kset，则将在parent 下创建目录，并将kobj 加入kset.list。</li>
</ul>
<h2 id="第90-章虚拟文件系统sysfs-目录层次分析实验"><a href="#第90-章虚拟文件系统sysfs-目录层次分析实验" class="headerlink" title="第90 章虚拟文件系统sysfs 目录层次分析实验"></a>第90 章虚拟文件系统sysfs 目录层次分析实验</h2><h3 id="90-1-sys-目录对设备模型的层次结构"><a href="#90-1-sys-目录对设备模型的层次结构" class="headerlink" title="90.1 sys 目录对设备模型的层次结构"></a>90.1 sys 目录对设备模型的层次结构</h3><p>我们进入到Linux 系统的/sys 目录下，可以看到如下文件夹。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409061419857.png" alt="image-20240906141940761"></p>
<p>和设备模型有关的文件夹为bus，class，devices。完整路径为如下所示：</p>
<pre class="line-numbers language-none"><code class="language-none">/sys/bus
/sys/class
/sys/devices<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><strong><code>/sys/devices</code><strong>：</strong>该目录包含了系统中所有设备的子目录</strong>。每个设备子目录代表一个具体的设备，通过其路径层次结构和符号链接反映设备的关系和拓扑结构。每个设备子目录中包含了设备的属性、状态和其他相关信息。如下所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409061420335.png" alt="image-20240906142036237"></p>
<p><strong><code>/sys/bus</code><strong>：</strong>该目录包含了总线类型的子目录</strong>。每个子目录代表一个特定类型的总线，例如PCI、USB 等。每个总线子目录中包含与该总线相关的设备和驱动程序的信息。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409061422362.png" alt="image-20240906142224260"></p>
<p>比如I2C 总线下连接的设备，如下所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409061422039.png" alt="image-20240906142244908"></p>
<p><strong><code>/sys/class</code><strong>：</strong>该目录包含了设备类别的子目录</strong>。每个子目录代表一个设备类别，例如磁盘、网络接口等。每个设备类别子目录中包含了属于该类别的设备的信息。如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409061424646.png" alt="image-20240906142413539"></p>
<p>使用class 进行归类的好处有以下几点：</p>
<ol>
<li><strong>逻辑上的组织</strong>：通过将设备按照类别进行归类，可以在设备模型中建立逻辑上的组织结构。这样，相关类型的设备可以被放置在同一个类别目录下，使得设备的组织结构更加清晰和可管理。</li>
<li><strong>统一的接口和属性</strong>：每个设备类别目录下可以定义一组统一的接口和属性，用于描述和配置该类别下所有设备的共同特征和行为。这样，对于同一类别的设备，可以使用相同的方法和属性来操作和配置，简化了设备驱动程序的编写和维护。</li>
<li><strong>简化设备发现和管理</strong>：通过将设备进行分类，可以提供一种简化的设备发现和管理机制。用户和应用程序可以在类别目录中查找和识别特定类型的设备，而无需遍历整个设备模型。这样，设备的发现和访问变得更加高效和方便。</li>
<li><strong>扩展性和可移植性</strong>：使用<code>class</code>进行归类可以提供一种扩展性和可移植性的机制。当引入新的设备类型时，可以将其归类到现有的类别中，而无需修改现有的设备管理和驱动程序。这种扩展性和可移植性使得系统更加灵活，并且对于开发人员和设备供应商来说，更容易集成新设备。</li>
</ol>
<p><strong>比如应用现在要设置gpio</strong><br>如果使用类可以直接使用以下命令：</p>
<pre class="line-numbers language-none"><code class="language-none">echo 1 &gt; /sys/class/gpio/gpio157/value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果不使用类，使用以下命令：</p>
<pre class="line-numbers language-none"><code class="language-none">echo 1 &gt; /sys/devices/platform/fe770000.gpio/gpiochip4/gpio/gpio157/value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="90-2-sys-目录层次图解"><a href="#90-2-sys-目录层次图解" class="headerlink" title="90.2 sys 目录层次图解"></a>90.2 sys 目录层次图解</h3><p>Sys 目录层次结构如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409061426511.png" alt="image-20240906142632399"></p>
<h2 id="第91-章什么是引用计数器"><a href="#第91-章什么是引用计数器" class="headerlink" title="第91 章什么是引用计数器"></a>第91 章什么是引用计数器</h2><h3 id="91-1-什么是引用计数器。"><a href="#91-1-什么是引用计数器。" class="headerlink" title="91.1 什么是引用计数器。"></a>91.1 什么是引用计数器。</h3><p>引用计数器（reference counting）是一种内存管理技术，用于跟踪对象或资源的引用数量。它通过在对象被引用时增加计数值，并在引用被释放时减少计数值，以确定何时可以安全地释放对象或资源。</p>
<p>引用计数器的基本原理如下：</p>
<ul>
<li>对象或资源被创建时，引用计数器初始化为1。</li>
<li>当有新的引用指向对象或资源时，引用计数器增加。</li>
<li>当引用不再指向对象或资源时（引用被删除、超出作用域等），引用计数器减少。</li>
<li>当引用计数器的值为0 时，表示没有任何引用指向对象或资源，可以安全地释放对象或资源，并进行相关的清理操作。</li>
</ul>
<h3 id="91-2-引用计数器kref-介绍"><a href="#91-2-引用计数器kref-介绍" class="headerlink" title="91.2 引用计数器kref 介绍"></a>91.2 引用计数器kref 介绍</h3><p>kref 是Linux 内核中提供的一种引用计数器实现，它是一种轻量级的引用计数技术，用于管理内核中的对象的引用计数。</p>
<p>在Linux 系统中，引用计数器用结构体kref 来表示。<code>struct kref</code> 定义在<code>include/linux/kref.h</code>头文件当中，本质是一个int 型变量。如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">kref</span> <span class="token punctuation">{</span>
    <span class="token class-name">refcount_t</span> refcount<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token class-name">atomic_t</span> refs<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token class-name">refcount_t</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> counter<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token class-name">atomic_t</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在使用引用计数器时，通常会将结构体<code>kref</code> 嵌入到其他结构体中，例如<code>struct kobject</code>，以实现引用计数的管理。如下所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409061430392.png" alt="image-20240906143002280"></p>
<p>为了实现引用计数功能，struct kobject 通常会包含一个嵌入的struct kref 对象。这样可以通过对struct kref 的操作来对struct kobject 进行引用计数的管理，并在引用计数减少到0 时释放相关资源。</p>
<p>再比如结构体device_node，如下所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409061430900.png" alt="image-20240906143027798"></p>
<h3 id="91-3-常用api-函数"><a href="#91-3-常用api-函数" class="headerlink" title="91.3 常用api 函数"></a>91.3 常用api 函数</h3><p>struct kref 提供了一些常用的API 函数来进行引用计数的增加和减少操作，下面是一些常用的<code>struct kref API</code> 函数。</p>
<p><strong><code>kref_init(struct kref *kref)：</code></strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">函数作用：初始化一个<span class="token keyword">struct</span> <span class="token class-name">kref</span> 对象。在使用引用计数之前，必须先调用此函数进行初始化。初始化kerf 的值为<span class="token number">1</span>
函数原型：
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">kref_init</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kref</span> <span class="token operator">*</span>kref<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">refcount_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kref<span class="token operator">-&gt;</span>refcount<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong><code>kref_get(struct kref *kref)：</code></strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">函数作用：增加<span class="token keyword">struct</span> <span class="token class-name">kref</span> 的引用计数。每次调用此函数，引用计数都会增加。kref 计数值加<span class="token number">1</span>
函数原型：
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">kref_get</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kref</span> <span class="token operator">*</span>kref<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">refcount_inc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kref<span class="token operator">-&gt;</span>refcount<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong><code>kref_put(struct kref *kref, void (*release)(struct kref *))：</code></strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">函数作用：减少<span class="token keyword">struct</span> <span class="token class-name">kref</span> 的引用计数，并在引用计数减少到零时调用release 函数来进行资源的释放。通常，release 函数会在其中执行对象的销毁和内存释放等操作。
函数原型：
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">int</span> <span class="token function">kref_put</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kref</span> <span class="token operator">*</span>kref<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>release<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kref</span> <span class="token operator">*</span>kref<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">refcount_dec_and_test</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kref<span class="token operator">-&gt;</span>refcount<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">release</span><span class="token punctuation">(</span>kref<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong><code>void refcount_set(refcount_t *r, int n)</code></strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">函数作用：设置kerf 的计数值。
函数原型：
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">refcount_set</span><span class="token punctuation">(</span><span class="token class-name">refcount_t</span> <span class="token operator">*</span>r<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">atomic_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>r<span class="token operator">-&gt;</span>refs<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="第92-章引用计数器实验"><a href="#第92-章引用计数器实验" class="headerlink" title="第92 章引用计数器实验"></a>第92 章引用计数器实验</h2><h3 id="92-1-实验程序的编写"><a href="#92-1-实验程序的编写" class="headerlink" title="92.1 实验程序的编写"></a>92.1 实验程序的编写</h3><h4 id="92-1-1-驱动程序编写"><a href="#92-1-1-驱动程序编写" class="headerlink" title="92.1.1 驱动程序编写"></a>92.1.1 驱动程序编写</h4><p>本实验对应的网盘路径为：<code>iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\68_kref\module</code>。</p>
<p>我们编写驱动代码，这段代码用于定义并初始化两个自定义内核对象mykobject01 和mykobject02，并将它们添加到一个自定义内核对象集合mykset 中。这些自定义内核对象可以用于在Linux 内核中表示和管理特定的功能或资源。代码中的注释对各个部分进行了解释，帮助理解代码的功能和目的。编写完成的kref.c 代码如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/configfs.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kobject.h&gt;</span></span>

<span class="token comment">// 定义了三个kobject指针变量：mykobject01、mykobject02、mykobject03</span>
<span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>mykobject01<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>mykobject02<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>mykobject03<span class="token punctuation">;</span>

<span class="token comment">// 定义了一个kobj_type结构体变量mytype，用于描述kobject的类型。</span>
<span class="token keyword">struct</span> <span class="token class-name">kobj_type</span> mytype<span class="token punctuation">;</span>
<span class="token comment">// 模块的初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">mykobj_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token comment">// 创建kobject的第一种方法</span>
    <span class="token comment">// 创建并添加了名为"mykobject01"的kobject对象，父kobject为NULL</span>
    mykobject01 <span class="token operator">=</span> <span class="token function">kobject_create_and_add</span><span class="token punctuation">(</span><span class="token string">"mykobject01"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"mykobject01 kref is %d\n"</span><span class="token punctuation">,</span> mykobject01<span class="token operator">-&gt;</span>kref<span class="token punctuation">.</span>refcount<span class="token punctuation">.</span>refs<span class="token punctuation">.</span>counter<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建并添加了名为"mykobject02"的kobject对象，父kobject为mykobject01。</span>
    mykobject02 <span class="token operator">=</span> <span class="token function">kobject_create_and_add</span><span class="token punctuation">(</span><span class="token string">"mykobject02"</span><span class="token punctuation">,</span> mykobject01<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"mykobject01 kref is %d\n"</span><span class="token punctuation">,</span> mykobject01<span class="token operator">-&gt;</span>kref<span class="token punctuation">.</span>refcount<span class="token punctuation">.</span>refs<span class="token punctuation">.</span>counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"mykobject02 kref is %d\n"</span><span class="token punctuation">,</span> mykobject02<span class="token operator">-&gt;</span>kref<span class="token punctuation">.</span>refcount<span class="token punctuation">.</span>refs<span class="token punctuation">.</span>counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建kobject的第二种方法</span>
    <span class="token comment">// 1 使用kzalloc函数分配了一个kobject对象的内存</span>
    mykobject03 <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2 初始化并添加到内核中，名为"mykobject03"。</span>
    ret <span class="token operator">=</span> <span class="token function">kobject_init_and_add</span><span class="token punctuation">(</span>mykobject03<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mytype<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"mykobject03"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"mykobject03 kref is %d\n"</span><span class="token punctuation">,</span> mykobject03<span class="token operator">-&gt;</span>kref<span class="token punctuation">.</span>refcount<span class="token punctuation">.</span>refs<span class="token punctuation">.</span>counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 模块退出函数</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">mykobj_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"mykobject01 kref is %d\n"</span><span class="token punctuation">,</span> mykobject01<span class="token operator">-&gt;</span>kref<span class="token punctuation">.</span>refcount<span class="token punctuation">.</span>refs<span class="token punctuation">.</span>counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"mykobject02 kref is %d\n"</span><span class="token punctuation">,</span> mykobject02<span class="token operator">-&gt;</span>kref<span class="token punctuation">.</span>refcount<span class="token punctuation">.</span>refs<span class="token punctuation">.</span>counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"mykobject03 kref is %d\n"</span><span class="token punctuation">,</span> mykobject03<span class="token operator">-&gt;</span>kref<span class="token punctuation">.</span>refcount<span class="token punctuation">.</span>refs<span class="token punctuation">.</span>counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 释放了之前创建的kobject对象</span>
    <span class="token function">kobject_put</span><span class="token punctuation">(</span>mykobject01<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"mykobject01 kref is %d\n"</span><span class="token punctuation">,</span> mykobject01<span class="token operator">-&gt;</span>kref<span class="token punctuation">.</span>refcount<span class="token punctuation">.</span>refs<span class="token punctuation">.</span>counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"mykobject02 kref is %d\n"</span><span class="token punctuation">,</span> mykobject02<span class="token operator">-&gt;</span>kref<span class="token punctuation">.</span>refcount<span class="token punctuation">.</span>refs<span class="token punctuation">.</span>counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"mykobject03 kref is %d\n"</span><span class="token punctuation">,</span> mykobject03<span class="token operator">-&gt;</span>kref<span class="token punctuation">.</span>refcount<span class="token punctuation">.</span>refs<span class="token punctuation">.</span>counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">kobject_put</span><span class="token punctuation">(</span>mykobject02<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"mykobject01 kref is %d\n"</span><span class="token punctuation">,</span> mykobject01<span class="token operator">-&gt;</span>kref<span class="token punctuation">.</span>refcount<span class="token punctuation">.</span>refs<span class="token punctuation">.</span>counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"mykobject02 kref is %d\n"</span><span class="token punctuation">,</span> mykobject02<span class="token operator">-&gt;</span>kref<span class="token punctuation">.</span>refcount<span class="token punctuation">.</span>refs<span class="token punctuation">.</span>counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"mykobject03 kref is %d\n"</span><span class="token punctuation">,</span> mykobject03<span class="token operator">-&gt;</span>kref<span class="token punctuation">.</span>refcount<span class="token punctuation">.</span>refs<span class="token punctuation">.</span>counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">kobject_put</span><span class="token punctuation">(</span>mykobject03<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"mykobject01 kref is %d\n"</span><span class="token punctuation">,</span> mykobject01<span class="token operator">-&gt;</span>kref<span class="token punctuation">.</span>refcount<span class="token punctuation">.</span>refs<span class="token punctuation">.</span>counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"mykobject02 kref is %d\n"</span><span class="token punctuation">,</span> mykobject02<span class="token operator">-&gt;</span>kref<span class="token punctuation">.</span>refcount<span class="token punctuation">.</span>refs<span class="token punctuation">.</span>counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"mykobject03 kref is %d\n"</span><span class="token punctuation">,</span> mykobject03<span class="token operator">-&gt;</span>kref<span class="token punctuation">.</span>refcount<span class="token punctuation">.</span>refs<span class="token punctuation">.</span>counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>mykobj_init<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定模块的初始化函数</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>mykobj_exit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定模块的退出函数</span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 模块使用的许可证</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"topeet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 模块的作者</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="92-2-运行测试"><a href="#92-2-运行测试" class="headerlink" title="92.2 运行测试"></a>92.2 运行测试</h3><h4 id="92-2-1-编译驱动程序"><a href="#92-2-1-编译驱动程序" class="headerlink" title="92.2.1 编译驱动程序"></a>92.2.1 编译驱动程序</h4><p>在上一小节中的kref.c 代码同一目录下创建Makefile 文件，Makefile 文件内容如下所示：然后使用命令“make”进行驱动的编译，编译完生成kref.ko 目标文件，至此驱动模块就编译成功了，接下来进行测试。</p>
<h4 id="92-2-2-运行测试"><a href="#92-2-2-运行测试" class="headerlink" title="92.2.2 运行测试"></a>92.2.2 运行测试</h4><p>开发板启动之后，使用以下命令进行驱动模块的加载，如下图（图92-4）所示：</p>
<pre class="line-numbers language-none"><code class="language-none">insmod kref.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409090945300.png" alt="image-20240909094539148"></p>
<p>如上图所示，驱动加载之后，第一条打印为“mykobject01 kref is 1”，因为创建了mykobject01,所以引用计数器的值为1，如下图所示的I。第二条打印为：“mykobject01 kref is 2”，因为在mykobject01 目录下创建了子目录mykobject02,所以mykobject01 的计数器值为2，mykobject02的计数器值为1，如下图所示的II。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409090946692.png" alt="image-20240909094610589"></p>
<p>现在我们拓展学习一下，如上图III 所示，如果在objectA 下面创建俩个object，objectA 的计数器值为3。如上图所示IV，如果在objectA 下面创建俩个object，那么objectA 的计数器值为3，在objectB 下创建object,那么objectB 的计数器值为2，objectC 的计数器值为1。最后可以使用以下命令进行驱动的卸载，如下图（图21-11）所示：</p>
<pre class="line-numbers language-none"><code class="language-none">rmmod kref<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409090946482.png" alt="image-20240909094631377"></p>
<p>如上图所示，计数器的值打印如上。当引用计数器的值为0 时，表示没有任何引用指向对象或资源，可以安全地释放对象或资源，并进行相关的清理操作。<br>至此，引用计数器实验就完成了。</p>
<h2 id="第93-章kobject-释放实例分析实验"><a href="#第93-章kobject-释放实例分析实验" class="headerlink" title="第93 章kobject 释放实例分析实验"></a>第93 章kobject 释放实例分析实验</h2><p>通过上个章节的实验，我们已经知道引用计数器是如何工作的。当引用计数器的值变为0后，会自动调用自定义的释放函数去执行释放的操作。那么kboj 是如何释放的呢，本章节我们来从代码层面进行下分析。</p>
<h3 id="93-1-Kobj-是如何释放的？"><a href="#93-1-Kobj-是如何释放的？" class="headerlink" title="93.1 Kobj 是如何释放的？"></a>93.1 Kobj 是如何释放的？</h3><p>要学习kobject 是如何释放的，那么我们要先明白kobj 是如何创建的。对于kobject 的创建，我们可以进一步分析这两种方法的实现细节。</p>
<ol>
<li><strong>使用<code>kobject_create_and_add()</code>函数创建kobject：</strong></li>
</ol>
<ul>
<li><code>kobject_create_and_add()</code>函数首先调用<code>kobject_create()</code>函数，该函数使用<code>kzalloc()</code>为kobject 分配内存空间。在<code>kobject_create()</code>函数中，调用<code>kobject_init()</code>函数对分配的内存进行初始化，并指定了默认的ktype。接下来，<code>kobject_create_and_add()</code>函数调用<code>kobject_add()</code>函数将kobject 添加到系统中，使其可见。</li>
<li><code>kobject_add()</code>函数内部调用了<code>kobject_add_internal()</code>函数，该函数负责将kobject 添加到父对象的子对象列表中，并创建相应的sysfs 文件系统条目。</li>
</ul>
<ol start="2">
<li><strong>使用<code>kobject_init_and_add()</code>函数创建kobject：</strong><br> <code>kobject_init_and_add()</code>函数需要手动分配内存，并通过<code>kobject_init()</code>函数对分配的内存进行初始化。此时需要自己实现ktype 结构体。初始化完成后，调用<code>kobject_add()</code>函数将kobject添加到系统中。</li>
</ol>
<p>无论是哪种方法，最终都会调用<code>kobject_add()</code>函数将kobject 添加到系统中，以使其可见。了解了kobject 的创建过程后，我们可以深入学习kobject 的释放过程。<br>我们来追踪下kobject 的释放函数——<code>kobject_put()</code>函数的实现。<br>在Linux 内核中，<code>kobject_put()</code>函数用于减少kobject 的引用计数，并在引用计数达到0 时释放kobject 相关的资源。如下图所示，在函数里面，当引用计数器的值变为0 以后，会调用release 函数执行释放的操作。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409090949556.png" alt="image-20240909094937461"></p>
<p>Linux 系统帮我们实现好了释放函数，如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409090949729.png" alt="image-20240909094947629"></p>
<p>在上图的release 函数中，该函数最终会去调用<code>kobject_cleanup</code> 函数，kobject_cleanup 函数实现如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409090950473.png" alt="image-20240909095008351"></p>
<p>如上图所示，函数定义了一个名叫kobject_cleanup 的静态函数，参数为一个指向struct kobject 结构体的指针kobj。函数内部定义了一个指向struct kobj_type 结构体的指针t，用于获取kobj 的类型信息。还定义了一个指向常量字符的指针name，用于保存kobj 的名称。<br>接下来，使用pr_debug 打印调试信息，显示kobject 的名称、地址、函数名称和父对象的地址。<br>然后，检查kobj 的类型信息t 是否存在，并且检查t-&gt;release 是否为NULL。如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409090956106.png" alt="image-20240909095639007"></p>
<p>如果t 存在但t-&gt;release 为NULL，表示kobj 的类型没有定义释放函数，会打印调试信息指示该情况。</p>
<p>接下来，检查kobj 的状态变量state_add_uevent_sent 和state_remove_uevent_sent。如果state_add_uevent_sent 为真而state_remove_uevent_sent 为假，表示调用者没有发送”remove” 事件，会自动发送”remove” 事件。</p>
<p>然后，检查kobj 的状态变量state_in_sysfs。如果为真，表示调用者没有从sysfs 中删除kobj，会自动调用kobject_del() 函数将其从sysfs 中删除。</p>
<p>接下来，再次检查t 是否存在，并且检查t-&gt;release 是否存在。如果存在，表示kobj 的类型定义了释放函数，会调用该释放函数进行资源清理。如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409090957168.png" alt="image-20240909095751067"></p>
<p>最后，检查name 是否存在。如果存在，表示kobj 的名称是动态分配的，会释放该名称的内存。这就是<code>kobject_cleanup()</code> 函数的实现。它负责执行kobject 的资源清理和释放操作，包括处理类型信息、发送事件、删除sysfs 中的对象以及调用释放函数。</p>
<p><code>kobject_cleanup()</code> 函数的实现表明，最终调用的释放函数是在kobj_type 结构体中定义的。这解释了为什么在使用kobject_init_and_add() 函数时，kobj_type 结构体不能为空的原因。因为释放函数是在kobj_type 结构体中定义的，如果不实现释放函数，就无法进行正确的资源释放。</p>
<p>接下来，我们来看一下在Linux 内核中，<code>dynamic_kobj_ktype</code> 是一个<code>kobj_type</code> 结构体对象，用于定义动态创建的kobject 的类型。它指定了释放函数和sysfs 操作。如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091002468.png" alt="image-20240909100236371"></p>
<p>如下图所示：dynamic_kobj_release 函数如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091005754.png" alt="image-20240909100555658"></p>
<p>在上图中，使用kfree 函数对创建的kobj 进行了释放。总结起来，kobj_type 结构体中的释放函数是为了确保在释放kobject 时执行必要的资源清理和释放操作，以确保系统的正确运行</p>
<h2 id="第94-章引入并完善kobject-type-结构体"><a href="#第94-章引入并完善kobject-type-结构体" class="headerlink" title="第94 章引入并完善kobject_type 结构体"></a>第94 章引入并完善kobject_type 结构体</h2><p>在上个章节中，我们掌握了kobject_init_and_add()函数需要手动分配内存，并通过kobject_init()函数对分配的内存进行初始化。此时需要自己实现ktype 结构体。那么ktype 结构体如何实现呢，本章节将进一步学习，以实验的方式带着大家进行操作。</p>
<h3 id="94-1-实验程序的编写"><a href="#94-1-实验程序的编写" class="headerlink" title="94.1 实验程序的编写"></a>94.1 实验程序的编写</h3><h4 id="94-1-1-驱动程序编写"><a href="#94-1-1-驱动程序编写" class="headerlink" title="94.1.1 驱动程序编写"></a>94.1.1 驱动程序编写</h4><p>本实验对应的网盘路径为：<code>iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\69_ktype\module</code>。<br>我们编写驱动代码，该代码实现了一个简单的内核模块，创建了一个自定义的kobject 对象，并定义了相应的初始化和释放函数。编写完成的ktype.c 代码如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/configfs.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kobject.h&gt;</span></span>

<span class="token comment">// 定义了kobject指针变量：mykobject03</span>
<span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>mykobject03<span class="token punctuation">;</span>

<span class="token comment">// 定义kobject的释放函数</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">dynamic_kobj_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"kobject: (%p): %s\n"</span><span class="token punctuation">,</span> kobj<span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">kfree</span><span class="token punctuation">(</span>kobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 定义了一个kobj_type结构体变量mytype，用于描述kobject的类型。</span>
<span class="token keyword">struct</span> <span class="token class-name">kobj_type</span> mytype <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>release <span class="token operator">=</span> dynamic_kobj_release<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 模块的初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">mykobj_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    <span class="token comment">// 创建kobject的第二种方法</span>
    <span class="token comment">// 1 使用kzalloc函数分配了一个kobject对象的内存</span>
    mykobject03 <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2 初始化并添加到内核中，名为"mykobject03"。</span>
    ret <span class="token operator">=</span> <span class="token function">kobject_init_and_add</span><span class="token punctuation">(</span>mykobject03<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mytype<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"mykobject03"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 模块退出函数</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">mykobj_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">kobject_put</span><span class="token punctuation">(</span>mykobject03<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>mykobj_init<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定模块的初始化函数</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>mykobj_exit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定模块的退出函数</span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 模块使用的许可证</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"topeet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 模块的作者</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="94-2-运行测试"><a href="#94-2-运行测试" class="headerlink" title="94.2 运行测试"></a>94.2 运行测试</h3><h4 id="94-2-1-编译驱动程序"><a href="#94-2-1-编译驱动程序" class="headerlink" title="94.2.1 编译驱动程序"></a>94.2.1 编译驱动程序</h4><p>在上一小节中的ktype.c 代码同一目录下创建Makefile 文件，Makefile 文件内容如下所示：然后使用命令“make”进行驱动的编译，编译完生成ktype.ko 目标文件，至此驱动模块就编译成功了，接下来进行测试。</p>
<h4 id="94-2-2-运行测试"><a href="#94-2-2-运行测试" class="headerlink" title="94.2.2 运行测试"></a>94.2.2 运行测试</h4><p>开发板启动之后，使用以下命令进行驱动模块的加载，如下图（图94-4）所示：</p>
<pre class="line-numbers language-none"><code class="language-none">insmod ktype.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091018348.png" alt="image-20240909101823249"></p>
<p>驱动加载之后，最后可以使用以下命令进行驱动的卸载，如上图（图94-4）所示，dynamic_kobj_release 函数被成功执行。</p>
<pre class="line-numbers language-none"><code class="language-none">rmmod ktype<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>至此，引入并完善kobject_type 结构体实验就完成了。</p>
<h2 id="第95-章创建属性文件并实现读写功能实验1"><a href="#第95-章创建属性文件并实现读写功能实验1" class="headerlink" title="第95 章创建属性文件并实现读写功能实验1"></a>第95 章创建属性文件并实现读写功能实验1</h2><p>本章节我们来探索如何创建具有读写功能的属性文件。属性文件通过sysfs 文件系统提供了一种方便的方式来与内核对象进行交互。我们将深入研究一个代码示例，演示如何创建具有属性的自定义kobject，使我们能够读取和写入值。让我们开始吧！</p>
<h3 id="95-1-实验程序的编写"><a href="#95-1-实验程序的编写" class="headerlink" title="95.1 实验程序的编写"></a>95.1 实验程序的编写</h3><h4 id="95-1-1-驱动程序编写"><a href="#95-1-1-驱动程序编写" class="headerlink" title="95.1.1 驱动程序编写"></a>95.1.1 驱动程序编写</h4><p>本实验对应的网盘路径为：<code>iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\70_attr\module</code>。<br>我们编写驱动代码，该代码创建了一个自定义的kobject，并在sysfs 中创建了两个属性——value1 和value2，允许读取和写入这些属性的值。模块的初始化函数负责创建和添加kobject，而退出函数则负责释放相关资源。编写完成的attr.c 代码如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/configfs.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kobject.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/sysfs.h&gt;</span> </span>

<span class="token comment">// 自定义的kobject结构体，包含一个kobject对象和两个整型值</span>
<span class="token keyword">struct</span> <span class="token class-name">mykobj</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">kobject</span> kobj<span class="token punctuation">;</span>
    <span class="token keyword">int</span> value1<span class="token punctuation">;</span>
    <span class="token keyword">int</span> value2<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义了mykobj结构体指针变量mykobject01</span>
<span class="token keyword">struct</span> <span class="token class-name">mykobj</span> <span class="token operator">*</span>mykobject01<span class="token punctuation">;</span>

<span class="token comment">// 自定义的kobject释放函数</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">dynamic_kobj_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">mykobj</span> <span class="token operator">*</span>mykobject01 <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>kobj<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">mykobj</span><span class="token punctuation">,</span> kobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"kobject: (%p): %s\n"</span><span class="token punctuation">,</span> kobj<span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">kfree</span><span class="token punctuation">(</span>mykobject01<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 自定义的attribute对象value1和value2</span>
<span class="token keyword">struct</span> <span class="token class-name">attribute</span> value1 <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"value1"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>mode <span class="token operator">=</span> <span class="token number">0666</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">attribute</span> value2 <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"value2"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>mode <span class="token operator">=</span> <span class="token number">0666</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 将attribute对象放入数组中</span>
<span class="token keyword">struct</span> <span class="token class-name">attribute</span> <span class="token operator">*</span>myattr<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token operator">&amp;</span>value1<span class="token punctuation">,</span>
    <span class="token operator">&amp;</span>value2<span class="token punctuation">,</span>
    <span class="token constant">NULL</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 自定义的show函数，用于读取属性值</span>
<span class="token class-name">ssize_t</span> <span class="token function">myshow</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">attribute</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">ssize_t</span> count<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">mykobj</span> <span class="token operator">*</span>mykobject01 <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>kobj<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">mykobj</span><span class="token punctuation">,</span> kobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>attr<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> <span class="token string">"value1"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        count <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"%d\n"</span><span class="token punctuation">,</span> mykobject01<span class="token operator">-&gt;</span>value1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>attr<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> <span class="token string">"value2"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        count <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"%d\n"</span><span class="token punctuation">,</span> mykobject01<span class="token operator">-&gt;</span>value2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 自定义的store函数，用于写入属性值</span>
<span class="token class-name">ssize_t</span> <span class="token function">mystore</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">attribute</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">mykobj</span> <span class="token operator">*</span>mykobject01 <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>kobj<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">mykobj</span><span class="token punctuation">,</span> kobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>attr<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> <span class="token string">"value1"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">sscanf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"%d\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>mykobject01<span class="token operator">-&gt;</span>value1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>attr<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> <span class="token string">"value2"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">sscanf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"%d\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>mykobject01<span class="token operator">-&gt;</span>value2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> size<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 自定义的sysfs_ops结构体，包含show和store函数指针</span>
<span class="token keyword">struct</span> <span class="token class-name">sysfs_ops</span> myops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>show <span class="token operator">=</span> myshow<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>store <span class="token operator">=</span> mystore<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 自定义的kobj_type结构体，包含释放函数、默认属性和sysfs_ops</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">kobj_type</span> mytype <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>release <span class="token operator">=</span> dynamic_kobj_release<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>default_attrs <span class="token operator">=</span> myattr<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>sysfs_ops <span class="token operator">=</span> <span class="token operator">&amp;</span>myops<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 模块的初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">mykobj_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    <span class="token comment">// 分配并初始化mykobject01</span>
    mykobject01 <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mykobj</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mykobject01<span class="token operator">-&gt;</span>value1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    mykobject01<span class="token operator">-&gt;</span>value2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">// 初始化并添加mykobject01到内核中，名为"mykobject01"</span>
    ret <span class="token operator">=</span> <span class="token function">kobject_init_and_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mykobject01<span class="token operator">-&gt;</span>kobj<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mytype<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"mykobject01"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 模块的退出函数</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">mykobj_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 释放mykobject01</span>
    <span class="token function">kobject_put</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mykobject01<span class="token operator">-&gt;</span>kobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>mykobj_init<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定模块的初始化函数</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>mykobj_exit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定模块的退出函数</span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 模块使用的许可证</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"topeet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 模块的作者</span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 模块使用的许可证</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"topeet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 模块的作者</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="95-2-运行测试"><a href="#95-2-运行测试" class="headerlink" title="95.2 运行测试"></a>95.2 运行测试</h3><h4 id="95-2-1-编译驱动程序"><a href="#95-2-1-编译驱动程序" class="headerlink" title="95.2.1 编译驱动程序"></a>95.2.1 编译驱动程序</h4><p>在上一小节中的attr.c 代码同一目录下创建Makefile 文件，Makefile 文件内容如下所示：然后使用命令“make”进行驱动的编译，编译完生成attr.ko 目标文件，至此驱动模块就编译成功了，接下来进行测试。</p>
<h4 id="95-2-2-运行测试"><a href="#95-2-2-运行测试" class="headerlink" title="95.2.2 运行测试"></a>95.2.2 运行测试</h4><p>开发板启动之后，使用以下命令进行驱动模块的加载，如下图（图95-4）所示：</p>
<pre class="line-numbers language-none"><code class="language-none">insmod attr.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091023355.png" alt="image-20240909102342259"></p>
<p>驱动加载之后，我们进入/sys/目录下，可以看到创建生成的myobject01，如下图所示</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091023755.png" alt="image-20240909102354649"></p>
<p>我们进到myobject01 目录下，可以看到创建的属性文件value1 和value2。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091024579.png" alt="image-20240909102403481"></p>
<p>我们可以使用echo 和cat 命令对属性值进行写入和读取，如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091024503.png" alt="image-20240909102415399"></p>
<p>最后可以使用以下命令进行驱动的卸载，如下图（95-8）所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">rmmod attr<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091024635.png" alt="image-20240909102435535"></p>
<p>至此，创建属性文件并实现读写功能实验就完成了。</p>
<h2 id="第96-章优化属性文件读写函数实验"><a href="#第96-章优化属性文件读写函数实验" class="headerlink" title="第96 章优化属性文件读写函数实验"></a>第96 章优化属性文件读写函数实验</h2><p>在上个章节中，我们创建具有属性的自定义kobject，并且能够读取和写入值。那么读写属性文件有什么作用呢？我们可以通过属性文件实现用户空间和内核空间信息交换的功能。通过属性文件实现用户空间和内核空间信息交换，用户可以根据自己的需求自定义属性和操作，增强了系统的灵活性和可定制性。本章节我们在上个章节实验的基础上优化属性文件读写函数实验。让我们开始吧！</p>
<h3 id="96-1-实验程序的编写"><a href="#96-1-实验程序的编写" class="headerlink" title="96.1 实验程序的编写"></a>96.1 实验程序的编写</h3><h4 id="96-1-1-驱动程序编写"><a href="#96-1-1-驱动程序编写" class="headerlink" title="96.1.1 驱动程序编写"></a>96.1.1 驱动程序编写</h4><p>本实验对应的网盘路径为：iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\71_attr02\module。<br>我们编写驱动代码，在驱动代码中，创建了一个自定义的kobject，并在sysfs 中创建了两个属性文件，并实现了读取和写入这些属性的功能。属性对象value1 和value2 被定义为kobj_attribute 结构体，并使用<code>__ATTR</code> 宏进行初始化。编写完成的attr.c 代码如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/configfs.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kobject.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/sysfs.h&gt;</span></span>

<span class="token comment">// 自定义的kobject结构体，包含一个kobject对象和两个整型值</span>
<span class="token keyword">struct</span> <span class="token class-name">mykobj</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">kobject</span> kobj<span class="token punctuation">;</span>
    <span class="token keyword">int</span> value1<span class="token punctuation">;</span>
    <span class="token keyword">int</span> value2<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义了mykobj结构体指针变量mykobject01</span>
<span class="token keyword">struct</span> <span class="token class-name">mykobj</span> <span class="token operator">*</span>mykobject01<span class="token punctuation">;</span>

<span class="token comment">// 自定义的show函数，用于读取属性值</span>
<span class="token class-name">ssize_t</span> <span class="token function">show_myvalue1</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">kobj_attribute</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">ssize_t</span> count<span class="token punctuation">;</span>
    count <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"show_myvalue1\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 自定义的store函数，用于写入属性值</span>
<span class="token class-name">ssize_t</span> <span class="token function">store_myvalue1</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">kobj_attribute</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"buf is %s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 自定义的show函数，用于读取属性值</span>
<span class="token class-name">ssize_t</span> <span class="token function">show_myvalue2</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">kobj_attribute</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">ssize_t</span> count<span class="token punctuation">;</span>
    count <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"show_myvalue2\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 自定义的store函数，用于写入属性值</span>
<span class="token class-name">ssize_t</span> <span class="token function">store_myvalue2</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">kobj_attribute</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"buf is %s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义attribute对象value1和value2</span>
<span class="token keyword">struct</span> <span class="token class-name">kobj_attribute</span> value1 <span class="token operator">=</span> <span class="token function">__ATTR</span><span class="token punctuation">(</span>value1<span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">,</span> show_myvalue1<span class="token punctuation">,</span> store_myvalue1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">kobj_attribute</span> value2 <span class="token operator">=</span> <span class="token function">__ATTR</span><span class="token punctuation">(</span>value2<span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">,</span> show_myvalue2<span class="token punctuation">,</span> store_myvalue2<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 自定义的kobject释放函数</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">dynamic_kobj_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">mykobj</span> <span class="token operator">*</span>mykobject01 <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>kobj<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">mykobj</span><span class="token punctuation">,</span> kobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"kobject: (%p): %s\n"</span><span class="token punctuation">,</span> kobj<span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">kfree</span><span class="token punctuation">(</span>mykobject01<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 将attribute对象放入数组中</span>
<span class="token keyword">struct</span> <span class="token class-name">attribute</span> <span class="token operator">*</span>myattr<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token operator">&amp;</span>value1<span class="token punctuation">.</span>attr<span class="token punctuation">,</span>
    <span class="token operator">&amp;</span>value2<span class="token punctuation">.</span>attr<span class="token punctuation">,</span>
    <span class="token constant">NULL</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 自定义的show函数，用于读取属性值</span>
<span class="token class-name">ssize_t</span> <span class="token function">myshow</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">attribute</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">ssize_t</span> count<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">kobj_attribute</span> <span class="token operator">*</span>kobj_attr <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>attr<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">kobj_attribute</span><span class="token punctuation">,</span> attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    count <span class="token operator">=</span> kobj_attr<span class="token operator">-&gt;</span><span class="token function">show</span><span class="token punctuation">(</span>kobj<span class="token punctuation">,</span> kobj_attr<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 自定义的store函数，用于写入属性值</span>
<span class="token class-name">ssize_t</span> <span class="token function">mystore</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">attribute</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">kobj_attribute</span> <span class="token operator">*</span>kobj_attr <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>attr<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">kobj_attribute</span><span class="token punctuation">,</span> attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> kobj_attr<span class="token operator">-&gt;</span><span class="token function">store</span><span class="token punctuation">(</span>kobj<span class="token punctuation">,</span> kobj_attr<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 自定义的sysfs_ops结构体，包含show和store函数指针</span>
<span class="token keyword">struct</span> <span class="token class-name">sysfs_ops</span> myops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>show <span class="token operator">=</span> myshow<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>store <span class="token operator">=</span> mystore<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 自定义的kobj_type结构体，包含释放函数、默认属性和sysfs_ops</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">kobj_type</span> mytype <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>release <span class="token operator">=</span> dynamic_kobj_release<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>default_attrs <span class="token operator">=</span> myattr<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>sysfs_ops <span class="token operator">=</span> <span class="token operator">&amp;</span>myops<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 模块的初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">mykobj_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    <span class="token comment">// 分配并初始化mykobject01</span>
    mykobject01 <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mykobj</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mykobject01<span class="token operator">-&gt;</span>value1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    mykobject01<span class="token operator">-&gt;</span>value2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">// 初始化并添加mykobject01到内核中，名为"mykobject01"</span>
    ret <span class="token operator">=</span> <span class="token function">kobject_init_and_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mykobject01<span class="token operator">-&gt;</span>kobj<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mytype<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"mykobject01"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 模块的退出函数</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">mykobj_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 释放mykobject01</span>
    <span class="token function">kobject_put</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mykobject01<span class="token operator">-&gt;</span>kobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>mykobj_init<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定模块的初始化函数</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>mykobj_exit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定模块的退出/</span>
<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 模块使用的许可证</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"topeet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 模块的作者</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="96-2-运行测试"><a href="#96-2-运行测试" class="headerlink" title="96.2 运行测试"></a>96.2 运行测试</h3><h4 id="96-2-1-编译驱动程序"><a href="#96-2-1-编译驱动程序" class="headerlink" title="96.2.1 编译驱动程序"></a>96.2.1 编译驱动程序</h4><p>在上一小节中的attr.c 代码同一目录下创建Makefile 文件，Makefile 文件内容如下所示：然后使用命令“make”进行驱动的编译，编译完生成attr.ko 目标文件，至此驱动模块就编译成功了，接下来进行测试。</p>
<h4 id="96-2-2-运行测试"><a href="#96-2-2-运行测试" class="headerlink" title="96.2.2 运行测试"></a>96.2.2 运行测试</h4><p>开发板启动之后，使用以下命令进行驱动模块的加载，如下图（图96-4）所示：</p>
<pre class="line-numbers language-none"><code class="language-none">insmod attr.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091032694.png" alt="image-20240909103239591"></p>
<p>驱动加载之后，我们进入/sys/目录下，可以看到创建生成的myobject01，如下图所示</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091032245.png" alt="image-20240909103251138"></p>
<p>我们进到myobject01 目录下，可以看到创建的属性文件value1 和value2。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091033719.png" alt="image-20240909103326619"></p>
<p>我们可以使用echo 和cat 命令对属性值进行写入和读取，如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091033760.png" alt="image-20240909103336653"></p>
<p>最后可以使用以下命令进行驱动的卸载，如下图（图96-8）所示：</p>
<pre class="line-numbers language-none"><code class="language-none">rmmod attr<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091033045.png" alt="image-20240909103350942"></p>
<p>至此，优化属性文件读写实验就完成了。</p>
<h2 id="第97-章创建属性文件并实现读写功能实验2"><a href="#第97-章创建属性文件并实现读写功能实验2" class="headerlink" title="第97 章创建属性文件并实现读写功能实验2"></a>第97 章创建属性文件并实现读写功能实验2</h2><p>在95 章的实验中，我们使用<code>kobject_init_and_add</code> 函数创建kobject,并创建了属性文件，实现了读写功能。在93 章节中，我们学习到创建kobject 有俩种方法。本章节我们使用另一种方法—— <code>kobject_create_and_add</code> 函数创建kobject，并创建属性文件，实现读写功能。让我们开始吧</p>
<h3 id="97-1-实验程序的编写"><a href="#97-1-实验程序的编写" class="headerlink" title="97.1 实验程序的编写"></a>97.1 实验程序的编写</h3><h4 id="97-1-1-驱动程序编写"><a href="#97-1-1-驱动程序编写" class="headerlink" title="97.1.1 驱动程序编写"></a>97.1.1 驱动程序编写</h4><p>本实验对应的网盘路径为：<code>iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\72_attr03\module</code>。<br>我们编写驱动代码，使用kobject_create_and_add 函数创建了一个名为”mykobject01” 的自定义kobject，并在其中创建了两个属性文件”value1” 和”value2”。可以通过读取和写入这些属性文件来实现用户空间和内核空间的信息交换。编写完成的attr.c 代码如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/configfs.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kobject.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/sysfs.h&gt;</span></span>

<span class="token comment">// 定义了mykobj结构体指针变量mykobject01</span>
<span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>mykobject01<span class="token punctuation">;</span>

<span class="token comment">// 自定义的show函数，用于读取属性值</span>
<span class="token class-name">ssize_t</span> <span class="token function">show_myvalue1</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">kobj_attribute</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">ssize_t</span> count<span class="token punctuation">;</span>
    count <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"show_myvalue1\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 自定义的store函数，用于写入属性值</span>
<span class="token class-name">ssize_t</span> <span class="token function">store_myvalue1</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">kobj_attribute</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"buf is %s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 自定义的show函数，用于读取属性值</span>
<span class="token class-name">ssize_t</span> <span class="token function">show_myvalue2</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">kobj_attribute</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">ssize_t</span> count<span class="token punctuation">;</span>
    count <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"show_myvalue2\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 自定义的store函数，用于写入属性值</span>
<span class="token class-name">ssize_t</span> <span class="token function">store_myvalue2</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">kobj_attribute</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"buf is %s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义attribute对象value1和value2</span>
<span class="token keyword">struct</span> <span class="token class-name">kobj_attribute</span> value1 <span class="token operator">=</span> <span class="token function">__ATTR</span><span class="token punctuation">(</span>value1<span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">,</span> show_myvalue1<span class="token punctuation">,</span> store_myvalue1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">kobj_attribute</span> value2 <span class="token operator">=</span> <span class="token function">__ATTR</span><span class="token punctuation">(</span>value2<span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">,</span> show_myvalue2<span class="token punctuation">,</span> store_myvalue2<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 模块的初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">mykobj_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    <span class="token comment">// // 分配并初始化mykobject01</span>
    <span class="token comment">// mykobject01 = kzalloc(sizeof(struct mykobj), GFP_KERNEL);</span>
    <span class="token comment">// mykobject01-&gt;value1 = 1;</span>
    <span class="token comment">// mykobject01-&gt;value2 = 1;</span>
    <span class="token comment">// // 初始化并添加mykobject01到内核中，名为"mykobject01"</span>
    <span class="token comment">// ret = kobject_init_and_add(&amp;mykobject01-&gt;kobj, &amp;mytype, NULL, "%s", "mykobject01");</span>

    mykobject01 <span class="token operator">=</span> <span class="token function">kobject_create_and_add</span><span class="token punctuation">(</span><span class="token string">"mykobject01"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">sysfs_create_file</span><span class="token punctuation">(</span>mykobject01<span class="token punctuation">,</span> <span class="token operator">&amp;</span>value1<span class="token punctuation">.</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">sysfs_create_file</span><span class="token punctuation">(</span>mykobject01<span class="token punctuation">,</span> <span class="token operator">&amp;</span>value2<span class="token punctuation">.</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 模块的退出函数</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">mykobj_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 释放mykobject01</span>
    <span class="token function">kobject_put</span><span class="token punctuation">(</span>mykobject01<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>mykobj_init<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定模块的初始化函数</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>mykobj_exit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定模块的退出/</span>
<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 模块使用的许可证</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"topeet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 模块的作者</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>接下来驱动编写好之后，我们修改Linux 源码中的kernel/lib/kobject.c 文件，添加如下打印：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091040004.png" alt="image-20240909104020863"></p>
<p>然后重新编译内核镜像，单独烧写内核镜像。</p>
<h3 id="97-2-运行测试"><a href="#97-2-运行测试" class="headerlink" title="97.2 运行测试"></a>97.2 运行测试</h3><h4 id="97-2-1-编译驱动程序"><a href="#97-2-1-编译驱动程序" class="headerlink" title="97.2.1 编译驱动程序"></a>97.2.1 编译驱动程序</h4><p>在上一小节中的make_kset.c 代码同一目录下创建Makefile 文件，Makefile 文件内容如下所示：然后使用命令“make”进行驱动的编译，编译完生成attr.ko 目标文件，至此驱动模块就编译成功了，接下来进行测试。</p>
<h4 id="97-2-2-运行测试"><a href="#97-2-2-运行测试" class="headerlink" title="97.2.2 运行测试"></a>97.2.2 运行测试</h4><p>内核镜像更新之后，开发板启动，使用以下命令进行驱动模块的加载，如下图（图97-5）所示：</p>
<pre class="line-numbers language-none"><code class="language-none">insmod attr.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091041671.png" alt="image-20240909104139572"></p>
<p>驱动加载之后，我们进入/sys/目录下，可以看到创建生成的myobject01，如下图所示</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091041118.png" alt="image-20240909104149009"></p>
<p>我们进到myobject01 目录下，可以看到创建的属性文件value1 和value2。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091042590.png" alt="image-20240909104204485"></p>
<p>我们可以使用echo 和cat 命令对属性值进行写入和读取，如下图所示，可以看到在写入和读取的过程中，会打印我们在内核中添加的打印。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091042984.png" alt="image-20240909104216861"></p>
<p>最后可以使用以下命令进行驱动的卸载，如下图（图97-9）所示：</p>
<pre class="line-numbers language-none"><code class="language-none">rmmod attr<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091043440.png" alt="image-20240909104347333"></p>
<p>至此，创建属性文件并实现读写功能实验2 就完成了。</p>
<h3 id="第98-章创建多个属性文件的简便方法"><a href="#第98-章创建多个属性文件的简便方法" class="headerlink" title="第98 章创建多个属性文件的简便方法"></a>第98 章创建多个属性文件的简便方法</h3><p>在上一章节中，我们创建了一个属性文件，但是在情况中，我们可能需要创建N 个属性文件，如果还按照上个章节的方法是非常麻烦的。本章节我们来学习创建多个属性文件的简便方法，这样可以更好地组织和管理相关属性文件，提供更清晰和一致的sysfs 接口。</p>
<h4 id="98-1-sysfs-create-group-函数"><a href="#98-1-sysfs-create-group-函数" class="headerlink" title="98.1 sysfs_create_group 函数"></a>98.1 <code>sysfs_create_group</code> 函数</h4><p><code>sysfs_create_group</code> 函数，用于在sysfs 中创建一个组(group)。组是一组相关的属性文件的集合，可以将它们放在同一个目录下提供更好的组织性和可读性。<br>函数原型如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">sysfs_create_group</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">attribute_group</span> <span class="token operator">*</span>grp<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>此函数有俩个参数，分别为如下所示：</p>
<ul>
<li>kobj: 指向包含目标组的kobject 的指针。</li>
<li>grp: 指向attribute_group 结构体的指针，该结构体定义了组中的属性文件。</li>
</ul>
<p>attribute_group 结构体定义如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">attribute_group</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">attribute</span> <span class="token operator">*</span><span class="token operator">*</span>attrs<span class="token punctuation">;</span>
    <span class="token class-name">mode_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>is_visible<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">attribute</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>结构体中包含如下字段：</p>
<ul>
<li><code>name</code>: 组的名称，将用作sysfs 目录的名称。</li>
<li><code>attrs</code>: 指向属性文件数组的指针</li>
<li><code>is_visible</code> : 可选的回调函数，用于决定每个属性文件是否可见。如果为NULL，则所有属性文件都可见。</li>
</ul>
<p>属性文件数组是一个以struct attribute *类型为元素的数组，以NULL 结束。每个struct attribute 结构体表示一个属性文件，可以使用&amp;运算符将属性对象（如struct kobject_attribute）的.attr 字段传递给属性文件数组。<br>下面展示使用sysfs_create_group 创建一个组并添加属性文件</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">attribute</span> <span class="token operator">*</span>attrs<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token operator">&amp;</span>attr1<span class="token punctuation">.</span>attr<span class="token punctuation">,</span>
    <span class="token operator">&amp;</span>attr2<span class="token punctuation">.</span>attr<span class="token punctuation">,</span>
    <span class="token constant">NULL</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">attribute_group</span> attr_group <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"my_group"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>attrs <span class="token operator">=</span> attrs<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">sysfs_create_group</span><span class="token punctuation">(</span>kobj<span class="token punctuation">,</span> <span class="token operator">&amp;</span>attr_group<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在上述示例中，我们创建了一个名叫“my_group”的组，并将属性文件attr1 和attr2 添加到该组中，然后使用<code>sys_create_group</code> 将该组添加到指定的kobject kobj 中。接下来我们开始做实验。</p>
<h3 id="98-2-实验程序的编写"><a href="#98-2-实验程序的编写" class="headerlink" title="98.2 实验程序的编写"></a>98.2 实验程序的编写</h3><h4 id="98-2-1-驱动程序编写"><a href="#98-2-1-驱动程序编写" class="headerlink" title="98.2.1 驱动程序编写"></a>98.2.1 驱动程序编写</h4><p>本实验对应的网盘路径为：iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\73_attr04\module。<br>我们编写驱动代码，创建了一个名为”mykobject01” 的自定义kobject，并在其中使用上小节介绍的方式创建了两个属性文件”value1” 和”value2”。编写完成的attr.c 代码如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/configfs.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kobject.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/sysfs.h&gt;</span></span>

<span class="token comment">// 定义了mykobj结构体指针变量mykobject01</span>
<span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>mykobject01<span class="token punctuation">;</span>

<span class="token comment">// 自定义的show函数，用于读取属性值</span>
<span class="token class-name">ssize_t</span> <span class="token function">show_myvalue1</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">kobj_attribute</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">ssize_t</span> count<span class="token punctuation">;</span>
    count <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"show_myvalue1\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 自定义的store函数，用于写入属性值</span>
<span class="token class-name">ssize_t</span> <span class="token function">store_myvalue1</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">kobj_attribute</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"buf is %s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 自定义的show函数，用于读取属性值</span>
<span class="token class-name">ssize_t</span> <span class="token function">show_myvalue2</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">kobj_attribute</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">ssize_t</span> count<span class="token punctuation">;</span>
    count <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"show_myvalue2\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 自定义的store函数，用于写入属性值</span>
<span class="token class-name">ssize_t</span> <span class="token function">store_myvalue2</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">kobj_attribute</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"buf is %s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义attribute对象value1和value2</span>
<span class="token keyword">struct</span> <span class="token class-name">kobj_attribute</span> value1 <span class="token operator">=</span> <span class="token function">__ATTR</span><span class="token punctuation">(</span>value1<span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">,</span> show_myvalue1<span class="token punctuation">,</span> store_myvalue1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">kobj_attribute</span> value2 <span class="token operator">=</span> <span class="token function">__ATTR</span><span class="token punctuation">(</span>value2<span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">,</span> show_myvalue2<span class="token punctuation">,</span> store_myvalue2<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">attribute</span> <span class="token operator">*</span>attr<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token operator">&amp;</span>value1<span class="token punctuation">.</span>attr<span class="token punctuation">,</span>
    <span class="token operator">&amp;</span>value2<span class="token punctuation">.</span>attr<span class="token punctuation">,</span>
    <span class="token constant">NULL</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">attribute_group</span> my_attr_group <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"myattr"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>attrs <span class="token operator">=</span> attr<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 模块的初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">mykobj_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    <span class="token comment">// 创建并添加kobject "mykobject01"</span>
    mykobject01 <span class="token operator">=</span> <span class="token function">kobject_create_and_add</span><span class="token punctuation">(</span><span class="token string">"mykobject01"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 在kobject "mykobject01" 中创建属性组</span>
    ret <span class="token operator">=</span> <span class="token function">sysfs_create_group</span><span class="token punctuation">(</span>mykobject01<span class="token punctuation">,</span> <span class="token operator">&amp;</span>my_attr_group<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 模块的退出函数</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">mykobj_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 释放kobject "mykobject01"</span>
    <span class="token function">kobject_put</span><span class="token punctuation">(</span>mykobject01<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>mykobj_init<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定模块的初始化函数</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>mykobj_exit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定模块的退出函数</span>
<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 模块使用的许可证</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"topeet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 模块的作者</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>接下来驱动编写好之后，我们修改Linux 源码中的kernel/lib/kobject.c 文件，添加如下打印：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091049002.png" alt="image-20240909104908855"></p>
<p>然后重新编译内核镜像，单独烧写内核镜像。</p>
<h3 id="98-3-运行测试"><a href="#98-3-运行测试" class="headerlink" title="98.3 运行测试"></a>98.3 运行测试</h3><h4 id="98-3-1-编译驱动程序"><a href="#98-3-1-编译驱动程序" class="headerlink" title="98.3.1 编译驱动程序"></a>98.3.1 编译驱动程序</h4><p>在上一小节中的attr.c 代码同一目录下创建Makefile 文件，Makefile 文件内容如下所示：然后使用命令“make”进行驱动的编译，编译完生成attr.ko 目标文件，至此驱动模块就编译成功了，接下来进行测试。</p>
<h4 id="98-3-2-运行测试"><a href="#98-3-2-运行测试" class="headerlink" title="98.3.2 运行测试"></a>98.3.2 运行测试</h4><p>内核镜像更新之后，开发板启动，使用以下命令进行驱动模块的加载，如下图（图98-5）所示：</p>
<pre class="line-numbers language-none"><code class="language-none">insmod attr.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091049660.png" alt="image-20240909104959549"></p>
<p>驱动加载之后，我们进入/sys/目录下，可以看到创建生成的myobject01，如下图所示</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091050973.png" alt="image-20240909105010858"></p>
<p>最后可以使用以下命令进行驱动的卸载，如下图（图98-6）所示：</p>
<pre class="line-numbers language-none"><code class="language-none">rmmod attr<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091050373.png" alt="image-20240909105025262"></p>
<p>至此，创建多个属性文件实验就完成了。</p>
<h2 id="第99-章注册一个自己的总线实验"><a href="#第99-章注册一个自己的总线实验" class="headerlink" title="第99 章注册一个自己的总线实验"></a>第99 章注册一个自己的总线实验</h2><p>在设备模型中，包含总线、设备、驱动和类四个概念。在前面的章节中，我们学习了设备模型的基本框架kobject 和kset。而在本章节中，我们将学习设备模型中总线的概念。并进行实验——注册一个自己的总线。</p>
<h3 id="99-1-总线注册API-函数"><a href="#99-1-总线注册API-函数" class="headerlink" title="99.1 总线注册API 函数"></a>99.1 总线注册API 函数</h3><p>我们进入开发板的/sys/bus 目录下，/sys/bus 是Linux 系统中的一个目录，用于表示总线（bus）子系统的根目录。如果我们自己注册一个总线，会在此目录下显示。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091051480.png" alt="image-20240909105100362"></p>
<p><code>bus_register</code> 是一个函数，用于将一个自定义总线注册到Linux 内核中。</p>
<p>函数原型如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">bus_register</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">bus_type</span> <span class="token operator">*</span>bus<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>参数bus 是一个指向<code>struct bus_type</code> 结构体的指针，表示要注册的自定义总线。关于<code>bus_type</code> 结构体的介绍请参阅88.2.1 小节<br>函数返回一个整数值，表示注册操作的结果。通常情况下，返回值为0 表示注册成功，负值表示注册失败。</p>
<p><code>bus_unregister</code> 是一个函数，用于取消注册一个已经注册的自定义总线。</p>
<p>函数原型如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">bus_unregister</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">bus_type</span> <span class="token operator">*</span>bus<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>参数bus 是一个指向struct bus_type 结构体的指针，表示要取消注册的自定义总线。该函数没有返回值。<br>接下来，我们使用上述的API 函数编写驱动代码进行实验。</p>
<h3 id="99-2-实验程序的编写"><a href="#99-2-实验程序的编写" class="headerlink" title="99.2 实验程序的编写"></a>99.2 实验程序的编写</h3><h4 id="99-2-1-驱动程序编写"><a href="#99-2-1-驱动程序编写" class="headerlink" title="99.2.1 驱动程序编写"></a>99.2.1 驱动程序编写</h4><p>本实验对应的网盘路径为：<code>iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\74_bus01\module</code>。<br>我们编写驱动代码，驱动中定义了一个名为”mybus” 的自定义总线，并指定了该总线的匹配回调函数<code>mybus_match</code> 和探测回调函数<code>mybus_probe</code>。编写完成的bus.c 代码如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/configfs.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kobject.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/device.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">mybus_match</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">device_driver</span> <span class="token operator">*</span>drv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token function">dev_name</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">,</span> drv<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">mybus_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_driver</span> <span class="token operator">*</span>drv <span class="token operator">=</span> dev<span class="token operator">-&gt;</span>driver<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>drv<span class="token operator">-&gt;</span>probe<span class="token punctuation">)</span>
        drv<span class="token operator">-&gt;</span><span class="token function">probe</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">bus_type</span> mybus <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"mybus"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>match <span class="token operator">=</span> mybus_match<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>probe <span class="token operator">=</span> mybus_probe<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 模块的初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">bus_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">bus_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mybus<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 模块退出函数</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">bus_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">bus_unregister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mybus<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>bus_init<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定模块的初始化函数</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>bus_exit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定模块的退出函数</span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 模块使用的许可证</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"topeet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 模块的作者</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="99-3-运行测试"><a href="#99-3-运行测试" class="headerlink" title="99.3 运行测试"></a>99.3 运行测试</h3><h4 id="99-3-1-编译驱动程序"><a href="#99-3-1-编译驱动程序" class="headerlink" title="99.3.1 编译驱动程序"></a>99.3.1 编译驱动程序</h4><p>在上一小节中的bus.c 代码同一目录下创建Makefile 文件，Makefile 文件内容如下所示：然后使用命令“make”进行驱动的编译，编译完生成bus.ko 目标文件，至此驱动模块就编译成功了，接下来进行测试。</p>
<h4 id="99-3-2-运行测试"><a href="#99-3-2-运行测试" class="headerlink" title="99.3.2 运行测试"></a>99.3.2 运行测试</h4><p>开发板启动之后，使用以下命令进行驱动模块的加载，如下图（图99-3）所示：</p>
<pre class="line-numbers language-none"><code class="language-none">insmod bus.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091117922.png" alt="image-20240909111713802"></p>
<p>驱动加载之后，我们进入<code>/sys/bus</code> 目录下，可以看到创建生成的总线mybus，如下图所示，我们进到mybus 目录下，可以看到创建属性文件。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091117106.png" alt="image-20240909111726978"></p>
<p>最后可以使用以下命令进行驱动的卸载，如下图（图99-4）所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">rmmod bus<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091118903.png" alt="image-20240909111835787"></p>
<p>至此，注册一个自己的总线实验就完成了。</p>
<h2 id="第100-章在总线目录下创建属性文件实验"><a href="#第100-章在总线目录下创建属性文件实验" class="headerlink" title="第100 章在总线目录下创建属性文件实验"></a>第100 章在总线目录下创建属性文件实验</h2><p>在上个章节中，我们成功注册了一个自定义总线，并为其创建了必要的数据结构和函数。现在，在本章节中，我们将继续深入了解总线的概念，并在总线目录下创建属性文件以扩展其功能。通过创建属性文件，我们可以为总线添加额外的信息和控制选项，以便与设备和驱动进行交互。这些属性文件可以用于读取总线的状态、设置参数或执行其他相关操作。让我们开始吧！</p>
<h3 id="100-1-总线下创建属性API-函数"><a href="#100-1-总线下创建属性API-函数" class="headerlink" title="100.1 总线下创建属性API 函数"></a>100.1 总线下创建属性API 函数</h3><p><code>bus_create_file()</code> 函数用于在总线的sysfs 目录下创建一个属性文件。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">bus_create_file</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">bus_type</span> <span class="token operator">*</span>bus<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">attribute</span> <span class="token operator">*</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
参数说明：
    bus：指向总线类型结构体<span class="token keyword">struct</span> <span class="token class-name">bus_type</span> 的指针，表示要创建属性文件的总线。
    kobj：指向内核对象<span class="token keyword">struct</span> <span class="token class-name">kobject</span> 的指针，表示要在其下创建属性文件的内核对象。
    attr：指向属性<span class="token keyword">struct</span> <span class="token class-name">attribute</span> 的指针，表示要创建的属性文件的属性。
返回值：
    成功时返回<span class="token number">0</span>，否则返回负数错误代码。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在调用bus_create_file()函数之前，需要先定义好属性结构体struct attribute，并将其相关字段填充好。通常，属性结构体会包含以下字段：<br>.name：属性的名称。<br>.mode：属性的访问权限。<br>示例用法：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">bus_attribute</span> mybus_attr <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>attr <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"value"</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>mode <span class="token operator">=</span> <span class="token number">0664</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>show <span class="token operator">=</span> mybus_show<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
ret <span class="token operator">=</span> <span class="token function">bus_create_file</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mybus<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mydevice<span class="token punctuation">.</span>kobj<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mybus_attr<span class="token punctuation">.</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上述示例代码创建了一个名为”value” 的属性文件，并指定了访问权限为0664。在创建属性文件时，还可以指定其他属性的回调函数，如.show、.store 等，以实现对属性值的读取和写入操作。<br>请注意，在使用<code>bus_create_file()</code> 函数之前，需要确保总线对象和内核对象已正确初始化和注册。<br>接下来我们开始编写驱动文件，进行实验。</p>
<h3 id="100-2-实验程序的编写"><a href="#100-2-实验程序的编写" class="headerlink" title="100.2 实验程序的编写"></a>100.2 实验程序的编写</h3><h4 id="100-2-1-驱动程序编写"><a href="#100-2-1-驱动程序编写" class="headerlink" title="100.2.1 驱动程序编写"></a>100.2.1 驱动程序编写</h4><p>本实验对应的网盘路径为：iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\75_bus02\module。</p>
<p>我们编写驱动代码，定义了一个名为”mybus” 的总线，并实现了总线的匹配回调函数mybus_match 和设备探测回调函数mybus_probe。同时，还定义了一个名为”value” 的属性文件，并实现了属性的显示回调函数mybus_show。编写完成的bus.c 代码如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/configfs.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kobject.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/device.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/sysfs.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">mybus_match</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">device_driver</span> <span class="token operator">*</span>drv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 检查设备名称和驱动程序名称是否匹配</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token function">dev_name</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">,</span> drv<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">mybus_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_driver</span> <span class="token operator">*</span>drv <span class="token operator">=</span> dev<span class="token operator">-&gt;</span>driver<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>drv<span class="token operator">-&gt;</span>probe<span class="token punctuation">)</span>
        drv<span class="token operator">-&gt;</span><span class="token function">probe</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">bus_type</span> mybus <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"mybus"</span><span class="token punctuation">,</span>                 <span class="token comment">// 总线的名称</span>
    <span class="token punctuation">.</span>match <span class="token operator">=</span> mybus_match<span class="token punctuation">,</span>            <span class="token comment">// 设备和驱动程序匹配的回调函数</span>
    <span class="token punctuation">.</span>probe <span class="token operator">=</span> mybus_probe<span class="token punctuation">,</span>            <span class="token comment">// 设备探测的回调函数</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">EXPORT_SYMBOL_GPL</span><span class="token punctuation">(</span>mybus<span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// 导出总线符号</span>

<span class="token class-name">ssize_t</span> <span class="token function">value_show</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">bus_type</span> <span class="token operator">*</span>bus<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 在 sysfs 中显示总线的值</span>
    <span class="token keyword">return</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token string">"mybus_show"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token comment">// struct bus_attribute mybus_attr = {</span>
<span class="token comment">//     .attr = {</span>
<span class="token comment">//         .name = "value",             // 属性的名称</span>
<span class="token comment">//         .mode = 0664,                // 属性的访问权限</span>
<span class="token comment">//     },</span>
<span class="token comment">//     .show = mybus_show,               // 属性的 show 回调函数</span>
<span class="token comment">// };</span>

<span class="token comment">// static BUS_ATTR(value,0664,mybus_show,NULL);   //用这个宏定义可以替换上面的结构体定义，就更简单一些.但是这个会报错</span>
<span class="token keyword">static</span> <span class="token function">BUS_ATTR_RO</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//value_show，和value_store  名称是固定的，要用括号里面的名字</span>
<span class="token comment">// struct bus_attribute bus_attr_value = __ATTR(value,0664,mybus_show,NULL);</span>

<span class="token comment">// 模块的初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">bus_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">bus_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mybus<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 注册总线</span>
    <span class="token comment">// ret = bus_create_file(&amp;mybus, &amp;mybus_attr);  // 在 sysfs 中创建属性文件</span>
    ret <span class="token operator">=</span> <span class="token function">bus_create_file</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mybus<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bus_attr_value<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 在 sysfs 中创建属性文件 //用这个宏定义名字得改一下</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 模块退出函数</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">bus_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">bus_remove_file</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mybus<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bus_attr_value<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 从 sysfs 中移除属性文件 //用这个宏定义名字得改一下</span>
    <span class="token function">bus_unregister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mybus<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 取消注册总线</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>bus_init<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">// 指定模块的初始化函数</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>bus_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">// 指定模块的退出函数</span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">// 模块使用的许可证</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"topeet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">// 模块的作者</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="100-3-运行测试"><a href="#100-3-运行测试" class="headerlink" title="100.3 运行测试"></a>100.3 运行测试</h3><h4 id="100-3-1-编译驱动程序"><a href="#100-3-1-编译驱动程序" class="headerlink" title="100.3.1 编译驱动程序"></a>100.3.1 编译驱动程序</h4><p>在上一小节中的bus.c 代码同一目录下创建Makefile 文件，Makefile 文件内容如下所示：然后使用命令“make”进行驱动的编译，编译完生成bus.ko 目标文件，至此驱动模块就编译成功了，接下来进行测试。</p>
<h4 id="100-3-2-运行测试"><a href="#100-3-2-运行测试" class="headerlink" title="100.3.2 运行测试"></a>100.3.2 运行测试</h4><p>开发板启动之后，使用以下命令进行驱动模块的加载，如下图（图100-5）所示：</p>
<pre class="line-numbers language-none"><code class="language-none">insmod bus.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091123157.png" alt="image-20240909112351031"></p>
<p>驱动加载之后，我们进入<code>/sys/bus</code> 目录下，可以看到创建生成的总线mybus，如下图所示，我们进到mybus 目录下，可以看到创建属性文件value。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091124161.png" alt="image-20240909112402034"></p>
<p>最后可以使用以下命令进行驱动的卸载，如下图（图100-7）所示：</p>
<pre class="line-numbers language-none"><code class="language-none">rmmod bus<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091125127.png" alt="image-20240909112512006"></p>
<p>至此，在总线目录下创建属性文件实验就完成了。</p>
<h2 id="第101-章总线注册流程理论分析实验"><a href="#第101-章总线注册流程理论分析实验" class="headerlink" title="第101 章总线注册流程理论分析实验"></a>第101 章总线注册流程理论分析实验</h2><p>在上个章节中，我们成功地在总线目录下创建了属性文件，为总线添加了额外的信息和控制选项。现在，在本章节中，我们将深入分析总线注册的流程，从代码的层面来理解总线的实现过程。通过这样的分析，我们将更好地理解总线注册的内部机制，并能够应用这些知识来实现更复杂的总线功能。让我们深入代码，一起学习总线注册的流程吧！</p>
<h3 id="101-1-bus-register-函数解析"><a href="#101-1-bus-register-函数解析" class="headerlink" title="101.1 bus_register 函数解析"></a>101.1 <code>bus_register</code> 函数解析</h3><p>开发板上电，我们进入到开发板的<code>/sys/bus/mybus</code> 目录下。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091126421.png" alt="image-20240909112648295"></p>
<p>如上图所示，为什么在sys/bus 目录下会生成mybus 目录以及对应的devices，drivers，drivers_autoprobe，drivers_probe，uevent 目录和属性呢？<br>在开发板/sys 目录下的目录都对应一个kobject，所以我们猜测mybus 目录和devices，drivers目录和kobject 有关系的。而kobject 一般要嵌入到其他结构体中去使用。如下图所示，kobject嵌入到device 结构体中。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091131050.png" alt="image-20240909113147919"></p>
<p>在struct device 结构体中包含了kobject 结构体，而struct bus_type 结构体又包含了struct device 结构体。如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091132511.png" alt="image-20240909113206383"></p>
<p>所以我们猜测这些/sys/bus/下的目录是和struct device 结构体中的kobj 有关系。接下来我<br>们追踪bus_register 函数，函数原型如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
bus_register - 注册一个驱动核心子系统
@bus: 要注册的总线
注册总线时，首先将总线与kobject 基础设施关联起来，然后注册属于该总线的子系统：
归属于该子系统的设备和驱动程序。
*/</span>
<span class="token keyword">int</span> <span class="token function">bus_register</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">bus_type</span> <span class="token operator">*</span>bus<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> retval<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">subsys_private</span> <span class="token operator">*</span>priv<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">lock_class_key</span> <span class="token operator">*</span>key <span class="token operator">=</span> <span class="token operator">&amp;</span>bus<span class="token operator">-&gt;</span>lock_key<span class="token punctuation">;</span>
    
    <span class="token comment">// 分配并初始化一个subsys_private 结构体，用于保存子系统的相关信息</span>
    priv <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">subsys_private</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>priv<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
    priv<span class="token operator">-&gt;</span>bus <span class="token operator">=</span> bus<span class="token punctuation">;</span>
    bus<span class="token operator">-&gt;</span>p <span class="token operator">=</span> priv<span class="token punctuation">;</span>
    
    <span class="token comment">// 初始化一个阻塞通知链表bus_notifier</span>
    <span class="token function">BLOCKING_INIT_NOTIFIER_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>priv<span class="token operator">-&gt;</span>bus_notifier<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 设置子系统的名称</span>
    retval <span class="token operator">=</span> <span class="token function">kobject_set_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>priv<span class="token operator">-&gt;</span>subsys<span class="token punctuation">.</span>kobj<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> bus<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>retval<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
    
    <span class="token comment">// 设置子系统的kset 和ktype</span>
    priv<span class="token operator">-&gt;</span>subsys<span class="token punctuation">.</span>kobj<span class="token punctuation">.</span>kset <span class="token operator">=</span> bus_kset<span class="token punctuation">;</span>
    priv<span class="token operator">-&gt;</span>subsys<span class="token punctuation">.</span>kobj<span class="token punctuation">.</span>ktype <span class="token operator">=</span> <span class="token operator">&amp;</span>bus_ktype<span class="token punctuation">;</span>
    priv<span class="token operator">-&gt;</span>drivers_autoprobe <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 注册子系统的kset</span>
    retval <span class="token operator">=</span> <span class="token function">kset_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>priv<span class="token operator">-&gt;</span>subsys<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>retval<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
    
    <span class="token comment">// 在总线上创建一个属性文件</span>
    retval <span class="token operator">=</span> <span class="token function">bus_create_file</span><span class="token punctuation">(</span>bus<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bus_attr_uevent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>retval<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> bus_uevent_fail<span class="token punctuation">;</span>
    
    <span class="token comment">// 创建并添加"devices" 子目录的kset</span>
    priv<span class="token operator">-&gt;</span>devices_kset <span class="token operator">=</span> <span class="token function">kset_create_and_add</span><span class="token punctuation">(</span><span class="token string">"devices"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>priv<span class="token operator">-&gt;</span>subsys<span class="token punctuation">.</span>kobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>priv<span class="token operator">-&gt;</span>devices_kset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        retval <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> bus_devices_fail<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 创建并添加"drivers" 子目录的kset</span>
    priv<span class="token operator">-&gt;</span>drivers_kset <span class="token operator">=</span> <span class="token function">kset_create_and_add</span><span class="token punctuation">(</span><span class="token string">"drivers"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>priv<span class="token operator">-&gt;</span>subsys<span class="token punctuation">.</span>kobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>priv<span class="token operator">-&gt;</span>drivers_kset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        retval <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> bus_drivers_fail<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 初始化接口链表、互斥锁和设备/驱动的klist</span>
    <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>priv<span class="token operator">-&gt;</span>interfaces<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>priv<span class="token operator">-&gt;</span>mutex<span class="token punctuation">,</span> <span class="token string">"subsys mutex"</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">klist_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>priv<span class="token operator">-&gt;</span>klist_devices<span class="token punctuation">,</span> klist_devices_get<span class="token punctuation">,</span> klist_devices_put<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">klist_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>priv<span class="token operator">-&gt;</span>klist_drivers<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 添加驱动探测文件</span>
    retval <span class="token operator">=</span> <span class="token function">add_probe_files</span><span class="token punctuation">(</span>bus<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>retval<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> bus_probe_files_fail<span class="token punctuation">;</span>
    
    <span class="token comment">// 添加总线的属性组</span>
    retval <span class="token operator">=</span> <span class="token function">bus_add_groups</span><span class="token punctuation">(</span>bus<span class="token punctuation">,</span> bus<span class="token operator">-&gt;</span>bus_groups<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>retval<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> bus_groups_fail<span class="token punctuation">;</span>
    
    <span class="token comment">// 打印调试信息，表示总线注册成功</span>
    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"bus: '%s': registered\n"</span><span class="token punctuation">,</span> bus<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    bus_groups_fail<span class="token operator">:</span>
        <span class="token function">remove_probe_files</span><span class="token punctuation">(</span>bus<span class="token punctuation">)</span><span class="token punctuation">;</span>
    bus_probe_files_fail<span class="token operator">:</span>
        <span class="token function">kset_unregister</span><span class="token punctuation">(</span>bus<span class="token operator">-&gt;</span>p<span class="token operator">-&gt;</span>drivers_kset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    bus_drivers_fail<span class="token operator">:</span>
        <span class="token function">kset_unregister</span><span class="token punctuation">(</span>bus<span class="token operator">-&gt;</span>p<span class="token operator">-&gt;</span>devices_kset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    bus_devices_fail<span class="token operator">:</span>
        <span class="token function">bus_remove_file</span><span class="token punctuation">(</span>bus<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bus_attr_uevent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    bus_uevent_fail<span class="token operator">:</span>
        <span class="token function">kset_unregister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bus<span class="token operator">-&gt;</span>p<span class="token operator">-&gt;</span>subsys<span class="token punctuation">)</span><span class="token punctuation">;</span>
    out<span class="token operator">:</span>
        <span class="token function">kfree</span><span class="token punctuation">(</span>bus<span class="token operator">-&gt;</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        bus<span class="token operator">-&gt;</span>p <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> retval<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">EXPORT_SYMBOL_GPL</span><span class="token punctuation">(</span>bus_register<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">*</span><span class="token operator">/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>以下是该函数的主要步骤：</p>
<ul>
<li>1 分配并初始化一个subsys_private 结构体，该结构体用于保存子系统的相关信息。</li>
<li>2 将bus 结构体与subsys_private 关联起来。</li>
<li>3 初始化一个阻塞通知链表bus_notifier。</li>
<li>4 通过kobject_set_name() 设置子系统的名称。</li>
<li>5 设置子系统的相关属性，如kset 和ktype。</li>
<li>6 注册子系统的kset。</li>
<li>7 创建并添加”devices” 和”drivers” 两个子目录的kset。</li>
<li>8 初始化子系统的接口链表、互斥锁和设备/驱动的klist。</li>
<li>9 添加驱动探测文件。</li>
<li>10 添加总线的属性组。</li>
<li>11 打印调试信息，表示总线注册成功。</li>
</ul>
<p>接下来我们对上述步骤进行补充讲解。<br>在步骤1 中，出现了新的结构体：struct subsys_private，如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">subsys_private</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">kset</span> subsys<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">kset</span> <span class="token operator">*</span>devices_kset<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> interfaces<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">mutex</span> mutex<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">kset</span> <span class="token operator">*</span>drivers_kset<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">klist</span> klist_devices<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">klist</span> klist_drivers<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">blocking_notifier_head</span> bus_notifier<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> drivers_autoprobe<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">bus_type</span> <span class="token operator">*</span>bus<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">kset</span> glue_dirs<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span>class<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>struct subsys_private</code> 是一个结构体，用于保存驱动核心子系统（bus）的私有信息。每个子系统都可以有私有数据，这些私有数据存储在struct subsys_private 结构体中。那么什么是子系统呢？</p>
<p>在Linux 中，子系统是一种机制，用于将特定功能的实现抽象为一个独立的实体。它提供了一种方便的方式，将相关的代码和数据结构组织在一起，以实现特定的功能。子系统可以被视为一个功能模块，它封装了相关的功能和操作，使得用户和应用程序可以通过统一的接口与其交互。</p>
<p>在Linux 中，存在许多常见的子系统，每个子系统都负责实现特定的功能。以下是一些常见的子系统示例。</p>
<ul>
<li><strong>虚拟文件系统（VFS）子系统</strong>：VFS 子系统提供了对不同文件系统的统一访问接口，使得应用程序可以透明地访问各种文件系统（如ext4、NTFS、FAT 等），而无需关心底层文件系统的具体实现。</li>
<li><strong>设备驱动子系统</strong>：设备驱动子系统管理和控制硬件设备的驱动程序。它提供了与硬件设备交互的接口，使得应用程序可以通过驱动程序与设备进行通信和控制。</li>
<li><strong>网络子系统</strong>：网络子系统负责管理和控制网络相关的功能。它包括网络协议栈、套接字接口、网络设备驱动程序等，用于实现网络通信和网络协议的处理。</li>
<li><strong>内存管理子系统</strong>：内存管理子系统负责管理系统的物理内存和虚拟内存。它包括内存分配、页面置换、内存映射等功能，用于有效地分配和管理系统的内存资源。</li>
<li><strong>进程管理子系统</strong>：进程管理子系统负责管理和控制系统中的进程。它包括进程的创建、调度、终止等功能，以及进程间通信的机制，如信号、管道、共享内存等。</li>
<li><strong>电源管理子系统</strong>：电源管理子系统负责管理和控制系统的电源管理功能。它可以用于控制电源的开关、电源模式的切换、节能功能的实现等。</li>
<li><strong>文件系统子系统</strong>：文件系统子系统负责管理和控制文件系统的创建、格式化、挂载、数据存取等操作。它支持各种文件系统类型，如ext4、FAT、NTFS 等。</li>
<li><strong>图形子系统</strong>：图形子系统负责管理和控制图形显示功能，包括显示驱动程序、窗口管理、图形渲染等。它提供了图形界面的支持，使得用户可以通过图形方式与计算机交互。</li>
</ul>
<p>在步骤2 中，<code>priv-&gt;bus = bus;</code>将priv 结构体中的bus 成员设置为当前注册的总线。这样做的目的是将bus 成员与当前总线建立关联。通过将bus 成员设置为当前总线，priv 结构体可以获取并访问与该总线相关的信息和功能。这种关联可以使priv 结构体在操作当前总线时更加方便和高效。</p>
<p>在步骤2 中，<code>bus-&gt;p = priv;</code>将priv 结构体指针存储在当前注册的总线结构体的成员p 中，目的是让当前注册的总线结构体能够快速地找到并访问与之关联的priv 结构体。通过将priv结构体指针存储在总线结构体的成员中，总线可以轻松地获取与之相关的私有数据结构。这种关联使得总线能够直接访问和操作与特定总线相关的数据和功能，而无需通过其他方式来查找或传递指针。</p>
<p>在步骤8 中，klist_init 函数用于初始化两个内核链表(klist)，分别是priv-&gt;klist_devices 和priv-&gt;klist_drivers。</p>
<p><code>klist_init(&amp;priv-&gt;klist_devices, klist_devices_get, klist_devices_put);</code>这行代码初始化了名为<code>priv-&gt;klist_devices</code> 的内核链表。klist_devices_get 和klist_devices_put 是两个回调函数，用于在向链表添加或移除元素时执行相应的操作。通常，这些回调函数用于在链表中的每个元素被引用或释放时执行额外的操作。例如，当设备被添加到链表时，klist_devices_get函数可能会增加设备的引用计数；当设备从链表中移除时，klist_devices_put 函数可能会减少设备的引用计数。</p>
<p><code>klist_init(&amp;priv-&gt;klist_drivers, NULL, NULL);</code>这行代码初始化了名为priv-&gt;klist_drivers 的内核链表，但与第一个初始化不同，这里没有提供回调函数。因此，这个链表在添加或移除元素时不会执行额外的操作。这种情况下，链表主要用于存储驱动程序对象，而不需要附加的处理逻辑</p>
<p>通过分析bus_register 函数，我们对设备模型有了更深层次的感悟，如下所示：</p>
<ol>
<li>kobject 和kset 是设备模型的基本框架，它们可以嵌入到其他结构体中以提供设备模型的功能。kobject 代表设备模型中的一个对象，而kset 则是一组相关的kobject 的集合。</li>
<li>属性文件在设备模型中具有重要作用，它们用于在内核空间和用户空间之间进行数据交换。属性文件可以通过sysfs 虚拟文件系统在用户空间中表示为文件，用户可以读取或写入这些文件来与设备模型进行交互。属性文件允许用户访问设备的状态、配置和控制信息，从而实现了设备模型的管理和配置。</li>
<li>sysfs 虚拟文件系统在设备模型中扮演关键角色，它可以将设备模型的组织层次展现出来。通过sysfs，设备模型中的对象、属性和关系可以以目录和文件的形式在用户空间中表示。这种组织形式使用户能够以层次结构的方式浏览和管理设备模型，从而方便地获取设备的信息、配置和状态。sysfs 提供了一种统一的接口，使用户能够通过文件系统操作来与设备模型进行交互，提供了设备模型的可视化和可操作性。</li>
</ol>
<h2 id="第102-章platform-总线注册流程实例分析实验"><a href="#第102-章platform-总线注册流程实例分析实验" class="headerlink" title="第102 章platform 总线注册流程实例分析实验"></a>第102 章platform 总线注册流程实例分析实验</h2><p>在上个章节中，我们详细地从代码的层面分析了总线注册的流程，并深入了解了总线的实现过程。现在，在本章节中，我们将继续承接前文的内容，进一步分析platform 总线的注册流程。本章节将深入研究platform 总线注册的关键步骤。揭示platform 总线注册的内部机制。让我们开始吧！</p>
<p>内核在初始化的过程中调用<code>platform_bus_init()</code>函数来初始化平台总线，调用流程如下所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091144545.png" alt="image-20240909114439368"></p>
<p>我们直接分析platform_bus_init 函数。在内核driver/base/platform.c 文件中注册了platform文件，platform_bus_init 函数如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __init <span class="token function">platform_bus_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> error<span class="token punctuation">;</span>
    <span class="token function">early_platform_cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 提前清理平台总线相关资源</span>
    error <span class="token operator">=</span> <span class="token function">device_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>platform_bus<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 注册平台总线设备</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">put_device</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>platform_bus<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 注册失败，释放平台总线设备</span>
        <span class="token keyword">return</span> error<span class="token punctuation">;</span> <span class="token comment">// 返回错误代码</span>
    <span class="token punctuation">}</span>
    error <span class="token operator">=</span> <span class="token function">bus_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>platform_bus_type<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 注册平台总线类型</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">device_unregister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>platform_bus<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 注册失败，注销平台总线设备</span>
        <span class="token keyword">return</span> error<span class="token punctuation">;</span> <span class="token comment">// 返回错误代码</span>
    <span class="token punctuation">}</span>
    <span class="token function">of_platform_register_reconfig_notifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 注册平台重新配置的通知器</span>
    <span class="token keyword">return</span> error<span class="token punctuation">;</span> <span class="token comment">// 返回错误代码（如果有）</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>函数首先清空总线<code>early_platform_device_list</code> 上的所有节点。然后使用调用<code>device_register(platform_bus_type)</code> 注册平台总线设备，将<code>platform_bus</code> 结构体注册到设备子系统中。然后使用<code>bus_register(&amp;platform_bus_type)</code>函数注册平台总线类型，将<code>platform_bus_type</code>结构体注册到总线子系统中。</p>
<p>在上面的函数中使用<code>bus_register(&amp;platform_bus_type)</code>注册了平台总线。platform_bus_type结构体如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">bus_type</span> platform_bus_type <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"platform"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>dev_groups <span class="token operator">=</span> platform_dev_groups<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>match <span class="token operator">=</span> platform_match<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>uevent <span class="token operator">=</span> platform_uevent<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>dma_configure <span class="token operator">=</span> platform_dma_configure<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>pm <span class="token operator">=</span> <span class="token operator">&amp;</span>platform_dev_pm_ops<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上述代码定义了一个名为platform_bus_type 的struct bus_type 结构体变量，表示平台总线类型。</p>
<p>该结构体变量的成员包括：</p>
<ul>
<li>.name = “platform”：指定平台总线类型的名称为”platform”。</li>
<li>.dev_groups = platform_dev_groups：指定设备组的指针，用于定义与平台总线相关的设备属性组。</li>
<li>.match = platform_match：指定匹配函数的指针，用于确定设备是否与平台总线兼容。</li>
<li>.uevent = platform_uevent：指定事件处理函数的指针，用于处理与平台总线相关的事件。</li>
<li>.dma_configure = platform_dma_configure：指定DMA 配置函数的指针，用于配置平台总线上的DMA。</li>
<li>.pm = &amp;platform_dev_pm_ops：指定与电源管理相关的操作函数的指针，用于管理平台总线上的设备电源。</li>
</ul>
<p>我们重点来看看platform_match 函数，如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">platform_match</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">device_driver</span> <span class="token operator">*</span>drv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev <span class="token operator">=</span> <span class="token function">to_platform_device</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">platform_driver</span> <span class="token operator">*</span>pdrv <span class="token operator">=</span> <span class="token function">to_platform_driver</span><span class="token punctuation">(</span>drv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* When driver_override is set, only bind to the matching driver */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pdev<span class="token operator">-&gt;</span>driver_override<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>pdev<span class="token operator">-&gt;</span>driver_override<span class="token punctuation">,</span> drv<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* Attempt an OF style match first */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">of_driver_match_device</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> drv<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* Then try ACPI style match */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">acpi_driver_match_device</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> drv<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* Then try to match against the id table */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pdrv<span class="token operator">-&gt;</span>id_table<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">platform_match_id</span><span class="token punctuation">(</span>pdrv<span class="token operator">-&gt;</span>id_table<span class="token punctuation">,</span> pdev<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* fall-back to driver name match */</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>pdev<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> drv<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>platform_match 是一个用于判断设备和驱动程序是否匹配的函数。它接受两个参数：dev表示设备对象指针，drv 表示驱动程序对象指针。上述函数的主要逻辑如下：</p>
<ul>
<li>1 首先，将dev 和drv 分别转换为struct platform_device 和struct platform_driver 类型的指针，以便后续使用。</li>
<li>2 检查pdev-&gt;driver_override 是否设置。如果设置了，表示只要与指定的驱动程序名称匹配，即可认为设备和驱动程序匹配。函数会比较pdev-&gt;driver_override 和drv-&gt;name 的字符串是否相等，如果相等则返回匹配（非零）。</li>
<li>3 如果pdev-&gt;driver_override 未设置，首先尝试进行OF 风格的匹配（Open Firmware）。调用<code>of_driver_match_device(dev, drv)</code>函数，该函数会检查设备是否与驱动程序匹配。如果匹配成功，则返回匹配（非零）。</li>
<li>4 如果OF 风格的匹配失败，接下来尝试进行ACPI 风格的匹配（Advanced Configuration and Power Interface）。调用acpi_driver_match_device(dev, drv)函数，该函数会检查设备是否与驱动程序匹配。如果匹配成功，则返回匹配（非零）。</li>
<li>5 如果ACPI 风格的匹配也失败，最后尝试根据驱动程序的ID 表进行匹配。检查<code>pdrv-&gt;id_table</code> 是否存在。如果存在，则调用<code>platform_match_id(pdrv-&gt;id_table, pdev)</code>函数来检查设备是否与ID 表中的任何条目匹配。如果匹配成功，则返回匹配（非零）。</li>
<li>6 如果以上所有匹配尝试都失败，最后使用驱动程序名称与设备名称进行比较。比较<code>pdev-&gt;name</code> 和<code>drv-&gt;name</code> 的字符串是否相等，如果相等则返回匹配（非零）。</li>
</ul>
<p>通过上述分析， 我们终于明白了为什么在platform 总线匹配优先级的时候，<code>of_match_table&gt;id_table&gt;name</code>。<br>至此，platform 总线注册流程分析完毕。</p>
<h2 id="第103-章在总线下注册设备实验"><a href="#第103-章在总线下注册设备实验" class="headerlink" title="第103 章在总线下注册设备实验"></a>第103 章在总线下注册设备实验</h2><p>在99 章节中，我们成功地注册了自定义的总线，并确保该总线已被系统识别和管理。现在，在本章节中，将继续构建在该总线上注册设备的流程。让我们继续构建在自定义总线上注册设备的过程，并为我们的设备模型增添更多的功能和扩展性。让我们开始吧！</p>
<h3 id="103-1-实验程序的编写"><a href="#103-1-实验程序的编写" class="headerlink" title="103.1 实验程序的编写"></a>103.1 实验程序的编写</h3><h4 id="103-1-1-驱动程序编写"><a href="#103-1-1-驱动程序编写" class="headerlink" title="103.1.1 驱动程序编写"></a>103.1.1 驱动程序编写</h4><p>本实验对应的网盘路径为：iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\76_device\module。<br>我们编写驱动代码，定义了一个名为”mybus” 的总线，并实现了总线的匹配回调函数mybus_match 和设备探测回调函数mybus_probe。同时，还定义了一个名为”value” 的属性文件，并实现了属性的显示回调函数mybus_show。编写完成的bus.c 代码如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/configfs.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kobject.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/device.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/sysfs.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">mybus_match</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">device_driver</span> <span class="token operator">*</span>drv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 检查设备名称和驱动程序名称是否匹配</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token function">dev_name</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">,</span> drv<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">mybus_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_driver</span> <span class="token operator">*</span>drv <span class="token operator">=</span> dev<span class="token operator">-&gt;</span>driver<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>drv<span class="token operator">-&gt;</span>probe<span class="token punctuation">)</span>
        drv<span class="token operator">-&gt;</span><span class="token function">probe</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">bus_type</span> mybus <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"mybus"</span><span class="token punctuation">,</span>                 <span class="token comment">// 总线的名称</span>
    <span class="token punctuation">.</span>match <span class="token operator">=</span> mybus_match<span class="token punctuation">,</span>            <span class="token comment">// 设备和驱动程序匹配的回调函数</span>
    <span class="token punctuation">.</span>probe <span class="token operator">=</span> mybus_probe<span class="token punctuation">,</span>            <span class="token comment">// 设备探测的回调函数</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">EXPORT_SYMBOL_GPL</span><span class="token punctuation">(</span>mybus<span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// 导出总线符号</span>

<span class="token class-name">ssize_t</span> <span class="token function">value_show</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">bus_type</span> <span class="token operator">*</span>bus<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 在 sysfs 中显示总线的值</span>
    <span class="token keyword">return</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token string">"mybus_show"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token comment">// struct bus_attribute mybus_attr = {</span>
<span class="token comment">//     .attr = {</span>
<span class="token comment">//         .name = "value",             // 属性的名称</span>
<span class="token comment">//         .mode = 0664,                // 属性的访问权限</span>
<span class="token comment">//     },</span>
<span class="token comment">//     .show = mybus_show,               // 属性的 show 回调函数</span>
<span class="token comment">// };</span>

<span class="token comment">// static BUS_ATTR(value,0664,mybus_show,NULL);   //用这个宏定义可以替换上面的结构体定义，就更简单一些.但是这个会报错</span>
<span class="token keyword">static</span> <span class="token function">BUS_ATTR_RO</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//value_show，和value_store  名称是固定的，要用括号里面的名字</span>
<span class="token comment">// struct bus_attribute bus_attr_value = __ATTR(value,0664,mybus_show,NULL);</span>

<span class="token comment">// 模块的初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">bus_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">bus_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mybus<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 注册总线</span>
    <span class="token comment">// ret = bus_create_file(&amp;mybus, &amp;mybus_attr);  // 在 sysfs 中创建属性文件</span>
    ret <span class="token operator">=</span> <span class="token function">bus_create_file</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mybus<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bus_attr_value<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 在 sysfs 中创建属性文件 //用这个宏定义名字得改一下</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 模块退出函数</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">bus_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">bus_remove_file</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mybus<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bus_attr_value<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 从 sysfs 中移除属性文件 //用这个宏定义名字得改一下</span>
    <span class="token function">bus_unregister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mybus<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 取消注册总线</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>bus_init<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">// 指定模块的初始化函数</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>bus_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">// 指定模块的退出函数</span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">// 模块使用的许可证</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"topeet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">// 模块的作者</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们编写驱动文件device.c，在驱动中，Linux 内核中创建一个自定义设备并将其注册到自定义总线上。<br>编写好的驱动如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/configfs.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kobject.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/device.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/sysfs.h&gt;</span></span>

<span class="token keyword">extern</span> <span class="token keyword">struct</span> <span class="token class-name">bus_type</span> mybus<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">myrelease</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"This is myrelease\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">device</span> mydevice <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>init_name <span class="token operator">=</span> <span class="token string">"mydevice"</span><span class="token punctuation">,</span>      <span class="token comment">// 设备的初始化名称</span>
    <span class="token punctuation">.</span>bus <span class="token operator">=</span> <span class="token operator">&amp;</span>mybus<span class="token punctuation">,</span>                <span class="token comment">// 所属总线</span>
    <span class="token punctuation">.</span>release <span class="token operator">=</span> myrelease<span class="token punctuation">,</span>         <span class="token comment">// 设备的释放回调函数</span>
    <span class="token punctuation">.</span>devt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">255</span> <span class="token operator">&lt;&lt;</span> <span class="token number">20</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment">// 设备号</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 模块的初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">device_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">device_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mydevice<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 注册设备</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 模块退出函数</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">device_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">device_unregister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mydevice<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 取消注册设备</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>device_init<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">// 指定模块的初始化函数</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>device_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">// 指定模块的退出函数</span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">// 模块使用的许可证</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"topeet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// 模块的作者</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="103-3-运行测试"><a href="#103-3-运行测试" class="headerlink" title="103.3 运行测试"></a>103.3 运行测试</h3><h4 id="103-3-1-编译驱动程序"><a href="#103-3-1-编译驱动程序" class="headerlink" title="103.3.1 编译驱动程序"></a>103.3.1 编译驱动程序</h4><p>在上一小节中的device.c 代码同一目录下创建Makefile 文件，Makefile 文件内容如下所示：然后使用命令“make”进行驱动的编译，编译完生成bus.ko 目标文件，至此device.ko 驱动模块就编译成功了，bus.ko 也需要重新编译，接下来进行测试。</p>
<h3 id="103-3-2-运行测试"><a href="#103-3-2-运行测试" class="headerlink" title="103.3.2 运行测试"></a>103.3.2 运行测试</h3><p>开发板启动之后，使用以下命令进行bus.ko 驱动模块的加载，如下图（图103-4）所示：</p>
<pre class="line-numbers language-none"><code class="language-none">insmod bus.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091156913.png" alt="image-20240909115636783"></p>
<p>然后加载device.ko 驱动模块，如下图所示：</p>
<pre class="line-numbers language-none"><code class="language-none">insmod device.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091156951.png" alt="image-20240909115650818"></p>
<p>驱动加载之后，我们进入<code>/sys/devices</code> 目录下，如下图所示，有注册生成的设备。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091157681.png" alt="image-20240909115708524"></p>
<p>我们进入到/sys/bus/mybus/devices 目录下，如下图所示，在总线下注册的设备为mydevice。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091157379.png" alt="image-20240909115722236"></p>
<p>最后可以使用以下命令进行驱动的卸载，如下所示：</p>
<pre class="line-numbers language-none"><code class="language-none">rmmod device
rmmod bus<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>至此，在总线下注册设备实验就完成了。</p>
<h2 id="第104-章设备注册流程分析实验"><a href="#第104-章设备注册流程分析实验" class="headerlink" title="第104 章设备注册流程分析实验"></a>第104 章设备注册流程分析实验</h2><p>在上个章节中，我们成功在自定义总线上注册了设备，使得系统能够正确地管理和操作该设备。本章节我们将深入分析设备注册的流程，从代码的层面来理解设备的注册过程。</p>
<h3 id="104-1-device-register-函数分析"><a href="#104-1-device-register-函数分析" class="headerlink" title="104.1 device_register 函数分析"></a>104.1 device_register 函数分析</h3><p>device_register 函数原型定义在drivers/base/core.c 文件中，如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">device_register</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">device_initialize</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">device_add</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">EXPORT_SYMBOL_GPL</span><span class="token punctuation">(</span>device_register<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上述代码展示了一个名为device_register 的函数实现，用于注册设备到内核中。函数接受一个指向struct device 类型的设备对象指针作为参数。首先，代码调用device_initialize 函数对设备对象进行初始化。接下来，代码调用device_add 函数将设备添加到内核中。device_add函数会将设备添加到设备总线的设备列表中，并执行与设备添加相关的操作，例如分配设备号、创建设备节点等。最后，函数返回设备添加的结果，通常是一个整数值表示成功或失败的状态码。</p>
<h4 id="104-1-1-device-initialize-函数"><a href="#104-1-1-device-initialize-函数" class="headerlink" title="104.1.1 device_initialize 函数"></a>104.1.1 device_initialize 函数</h4><p>device_initialize 函数原型，如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">device_initialize</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    dev<span class="token operator">-&gt;</span>kobj<span class="token punctuation">.</span>kset <span class="token operator">=</span> devices_kset<span class="token punctuation">;</span>
    <span class="token function">kobject_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>kobj<span class="token punctuation">,</span> <span class="token operator">&amp;</span>device_ktype<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>dma_pools<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">lockdep_set_novalidate_class</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">spin_lock_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>devres_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>devres_head<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">device_pm_init</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">set_dev_node</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_GENERIC_MSI_IRQ</span></span>
        <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>msi_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    
    <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>links<span class="token punctuation">.</span>consumers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>links<span class="token punctuation">.</span>suppliers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>links<span class="token punctuation">.</span>needs_suppliers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>links<span class="token punctuation">.</span>defer_hook<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dev<span class="token operator">-&gt;</span>links<span class="token punctuation">.</span>status <span class="token operator">=</span> DL_DEV_NO_DRIVER<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">EXPORT_SYMBOL_GPL</span><span class="token punctuation">(</span>device_initialize<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上述代码展示了一个名为device_initialize 的函数实现，用于对设备对象进行初始化。函数接收一个指向struct device 类型的设备对象指针作为参数。</p>
<p>首先，代码将设备对象的kobj.kset 成员设置为devices_kset，表示该设备对象所属的kset为devices_kset，即设备对象属于devices 子系统。</p>
<p>接下来，代码调用kobject_init 函数初始化设备对象的kobj 成员，使用device_ktype 作为ktype。通过这个函数调用，设备对象的kobject 被正确地初始化和设置。</p>
<p>然后，代码使用INIT_LIST_HEAD 宏初始化设备对象的dma_pools、msi_list、consumers、suppliers、needs_suppliers 和defer_hook 等链表头，以确保它们为空链表。</p>
<p>代码接着调用mutex_init 函数初始化设备对象的mutex 互斥锁，用于对设备进行互斥操作。通过lockdep_set_novalidate_class 函数，设置dev-&gt;mutex 的验证类别为无效，以避免死锁分析器对该互斥锁的验证。</p>
<p>接下来，代码调用spin_lock_init 函数初始化设备对象的devres_lock 自旋锁，用于对设备资源进行保护。通过INIT_LIST_HEAD 宏初始化设备对象的devres_head 链表头，以确保它为空链表。</p>
<p>代码接着调用device_pm_init 函数初始化设备对象的电源管理相关信息。然后，代码使用<code>set_dev_node</code>函数将设备对象的设备节点设置为-1，表示没有指定设备节点。在#ifdef CONFIG_GENERIC_MSI_IRQ 条件编译块内，代码使用INIT_LIST_HEAD 宏初始化设备对象的msi_list 链表头，用于管理设备的MSI（消息信号中断）信息。</p>
<p>最后，代码使用INIT_LIST_HEAD 宏初始化设备对象的consumers、suppliers、needs_suppliers和defer_hook 等链表头，用于管理设备间的连接关系。代码将设备对象的status 成员设置为DL_DEV_NO_DRIVER，表示设备当前没有驱动程序。</p>
<h4 id="104-1-2-device-add-函数"><a href="#104-1-2-device-add-函数" class="headerlink" title="104.1.2 device_add 函数"></a>104.1.2 device_add 函数</h4><p>接下来我们分析device_add 函数，函数实现如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">device_add</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>parent<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">class_interface</span> <span class="token operator">*</span>class_intf<span class="token punctuation">;</span>
    <span class="token keyword">int</span> error <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>glue_dir <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 获取设备的引用</span>
    dev <span class="token operator">=</span> <span class="token function">get_device</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dev<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> done<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dev<span class="token operator">-&gt;</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果设备的私有数据（private data）未初始化，则进行初始化</span>
        error <span class="token operator">=</span> <span class="token function">device_private_init</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span>
            <span class="token keyword">goto</span> done<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/*
    * 对于静态分配的设备（应该都会被转换），需要初始化设备名称。
    * 我们禁止读回名称，并强制使用dev_name()函数。
    */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>init_name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 初始化设备的名称</span>
        <span class="token function">dev_set_name</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> dev<span class="token operator">-&gt;</span>init_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dev<span class="token operator">-&gt;</span>init_name <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/* 子系统可以指定简单的设备枚举*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">dev_name</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> dev<span class="token operator">-&gt;</span>bus <span class="token operator">&amp;&amp;</span> dev<span class="token operator">-&gt;</span>bus<span class="token operator">-&gt;</span>dev_name<span class="token punctuation">)</span>
        <span class="token comment">// 如果设备的名称为空，并且设备所属总线的名称不为空，则设置设备名称</span>
        <span class="token function">dev_set_name</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"%s%u"</span><span class="token punctuation">,</span> dev<span class="token operator">-&gt;</span>bus<span class="token operator">-&gt;</span>dev_name<span class="token punctuation">,</span> dev<span class="token operator">-&gt;</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">dev_name</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        error <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> name_error<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"device: '%s': %s\n"</span><span class="token punctuation">,</span> <span class="token function">dev_name</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 获取设备的父设备引用</span>
    parent <span class="token operator">=</span> <span class="token function">get_device</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 获取设备的父kobject</span>
    kobj <span class="token operator">=</span> <span class="token function">get_device_parent</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>kobj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        error <span class="token operator">=</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>kobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> parent_error<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>kobj<span class="token punctuation">)</span>
        dev<span class="token operator">-&gt;</span>kobj<span class="token punctuation">.</span>parent <span class="token operator">=</span> kobj<span class="token punctuation">;</span>
    
    <span class="token comment">// 使用父设备的NUMA 节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">dev_to_node</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span> <span class="token operator">==</span> NUMA_NO_NODE<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">set_dev_node</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token function">dev_to_node</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 首先，向通用层注册设备</span>
    <span class="token comment">// 需要在此之前设置设备的名称，并将parent 设置为NULL</span>
    error <span class="token operator">=</span> <span class="token function">kobject_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>kobj<span class="token punctuation">,</span> dev<span class="token operator">-&gt;</span>kobj<span class="token punctuation">.</span>parent<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        glue_dir <span class="token operator">=</span> <span class="token function">get_glue_dir</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> Error<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 通知平台设备的添加</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>platform_notify<span class="token punctuation">)</span>
        <span class="token function">platform_notify</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 创建设备的uevent 属性文件</span>
    error <span class="token operator">=</span> <span class="token function">device_create_file</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dev_attr_uevent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> attrError<span class="token punctuation">;</span>
    
    <span class="token comment">// 添加设备类的符号链接</span>
    error <span class="token operator">=</span> <span class="token function">device_add_class_symlinks</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> SymlinkError<span class="token punctuation">;</span>
    
    <span class="token comment">// 添加设备的属性</span>
    error <span class="token operator">=</span> <span class="token function">device_add_attrs</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> AttrsError<span class="token punctuation">;</span>
    
    <span class="token comment">// 将设备添加到总线</span>
    error <span class="token operator">=</span> <span class="token function">bus_add_device</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> BusError<span class="token punctuation">;</span>
    
    <span class="token comment">// 在设备电源管理目录中添加设备</span>
    error <span class="token operator">=</span> <span class="token function">dpm_sysfs_add</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> DPMError<span class="token punctuation">;</span>
    
    <span class="token comment">// 添加设备到电源管理</span>
    <span class="token function">device_pm_add</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 如果设备的devt 存在主设备号</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">MAJOR</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>devt<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建设备的dev 属性文件</span>
        error <span class="token operator">=</span> <span class="token function">device_create_file</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dev_attr_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span>
            <span class="token keyword">goto</span> DevAttrError<span class="token punctuation">;</span>
        
        <span class="token comment">// 创建设备的sys 设备节点</span>
        error <span class="token operator">=</span> <span class="token function">device_create_sys_dev_entry</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span>
            <span class="token keyword">goto</span> SysEntryError<span class="token punctuation">;</span>
        
        <span class="token comment">// 在devtmpfs 上创建设备节点</span>
        <span class="token function">devtmpfs_create_node</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 通知设备添加的事件链</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>bus<span class="token punctuation">)</span>
        <span class="token function">blocking_notifier_call_chain</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>bus<span class="token operator">-&gt;</span>p<span class="token operator">-&gt;</span>bus_notifier<span class="token punctuation">,</span>BUS_NOTIFY_ADD_DEVICE<span class="token punctuation">,</span> dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 为设备的kobject 发送KOBJ_ADD 事件</span>
    <span class="token function">kobject_uevent</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>kobj<span class="token punctuation">,</span> KOBJ_ADD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/*
    * 检查其他设备（消费者）是否一直在等待该设备（供应者）的添加，
    * 以便可以创建设备链接。
    *
    * 这需要在device_pm_add()之后进行，因为device_link_add()
    * 要求在调用之前注册供应者。
    *
    * 但是，这也需要在bus_probe_device()之前发生，以确保等待的消费者在驱动程序绑定到设备之前
    可以链接到它。
    */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>fwnode <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>dev<span class="token operator">-&gt;</span>fwnode<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dev<span class="token operator">-&gt;</span>fwnode<span class="token operator">-&gt;</span>dev <span class="token operator">=</span> dev<span class="token punctuation">;</span>
        <span class="token function">fw_devlink_link_device</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 对总线中的设备进行探测</span>
    <span class="token function">bus_probe_device</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 如果存在父设备，则将当前设备添加到父设备的子设备列表中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token punctuation">)</span>
        <span class="token function">klist_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>p<span class="token operator">-&gt;</span>knode_parent<span class="token punctuation">,</span><span class="token operator">&amp;</span>parent<span class="token operator">-&gt;</span>p<span class="token operator">-&gt;</span>klist_children<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 如果设备有类别</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>class<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>class<span class="token operator">-&gt;</span>p<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 将设备添加到类别的设备列表中</span>
        <span class="token function">klist_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>knode_class<span class="token punctuation">,</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>class<span class="token operator">-&gt;</span>p<span class="token operator">-&gt;</span>klist_devices<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 通知任何接口设备已添加</span>
        <span class="token function">list_for_each_entry</span><span class="token punctuation">(</span>class_intf<span class="token punctuation">,</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>class<span class="token operator">-&gt;</span>p<span class="token operator">-&gt;</span>interfaces<span class="token punctuation">,</span> node<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>class_intf<span class="token operator">-&gt;</span>add_dev<span class="token punctuation">)</span>
            class_intf<span class="token operator">-&gt;</span><span class="token function">add_dev</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> class_intf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>class<span class="token operator">-&gt;</span>p<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    done<span class="token operator">:</span>
        <span class="token comment">// 释放设备的引用</span>
        <span class="token function">put_device</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> error<span class="token punctuation">;</span>
    
    SysEntryError<span class="token operator">:</span>
        <span class="token comment">// 如果存在主设备号，则移除设备的dev 属性文件</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">MAJOR</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>devt<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">device_remove_file</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dev_attr_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    DevAttrError<span class="token operator">:</span>
        <span class="token comment">// 移除设备的电源管理</span>
        <span class="token function">device_pm_remove</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 从设备电源管理目录中移除设备</span>
        <span class="token function">dpm_sysfs_remove</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    DPMError<span class="token operator">:</span>
        <span class="token comment">// 从总线中移除设备</span>
        <span class="token function">bus_remove_device</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    BusError<span class="token operator">:</span>
        <span class="token comment">// 移除设备的属性</span>
        <span class="token function">device_remove_attrs</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    AttrsError<span class="token operator">:</span>
        <span class="token comment">// 移除设备类的符号链接</span>
        <span class="token function">device_remove_class_symlinks</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    SymlinkError<span class="token operator">:</span>
        <span class="token comment">// 移除设备的uevent 属性文件</span>
        <span class="token function">device_remove_file</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dev_attr_uevent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    attrError<span class="token operator">:</span>
        <span class="token comment">// 为设备的kobject 发送KOBJ_REMOVE 事件</span>
        <span class="token function">kobject_uevent</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>kobj<span class="token punctuation">,</span> KOBJ_REMOVE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取设备的粘合目录</span>
        glue_dir <span class="token operator">=</span> <span class="token function">get_glue_dir</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 删除设备的kobject</span>
        <span class="token function">kobject_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>kobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Error<span class="token operator">:</span>
        <span class="token comment">// 清理设备的粘合目录</span>
        <span class="token function">cleanup_glue_dir</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> glue_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
        parent_error<span class="token operator">:</span>
        <span class="token comment">// 释放父设备的引用</span>
        <span class="token function">put_device</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    name_error<span class="token operator">:</span>
        <span class="token comment">// 释放设备的私有数据</span>
        <span class="token function">kfree</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dev<span class="token operator">-&gt;</span>p <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> done<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个device_add 函数用于向系统中添加设备。让我们逐步理解代码并逐行解释其功能：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">device_add</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>parent<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">class_interface</span> <span class="token operator">*</span>class_intf<span class="token punctuation">;</span>
    <span class="token keyword">int</span> error <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>glue_dir <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该函数以指向<code>struct device</code>的指针作为参数。它初始化了函数中使用的一些局部变量。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">dev <span class="token operator">=</span> <span class="token function">get_device</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dev<span class="token punctuation">)</span>
    <span class="token keyword">goto</span> done<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>调用get_device 函数以获取设备的引用。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dev<span class="token operator">-&gt;</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    error <span class="token operator">=</span> <span class="token function">device_private_init</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> done<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果设备结构体的p 成员为空，那么调用device_private_init 函数进行设备的私有初始化。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>init_name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">dev_set_name</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> dev<span class="token operator">-&gt;</span>init_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dev<span class="token operator">-&gt;</span>init_name <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果设备的init_name 成员非空，那么使用dev_set_name 函数将其作为设备的名称，并将init_name 设置为空。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">dev_name</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> dev<span class="token operator">-&gt;</span>bus <span class="token operator">&amp;&amp;</span> dev<span class="token operator">-&gt;</span>bus<span class="token operator">-&gt;</span>dev_name<span class="token punctuation">)</span>
    <span class="token function">dev_set_name</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"%s%u"</span><span class="token punctuation">,</span> dev<span class="token operator">-&gt;</span>bus<span class="token operator">-&gt;</span>dev_name<span class="token punctuation">,</span> dev<span class="token operator">-&gt;</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>如果设备的名称为空且设备的总线(bus)和总线的名称(dev_name)非空，那么使用总线名称和设备ID 设置设备的名称。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">dev_name</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    error <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token keyword">goto</span> name_error<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果设备的名称为空，那么设置错误码为-EINVAL，并跳转到name_error 标签处。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"device: '%s': %s\n"</span><span class="token punctuation">,</span> <span class="token function">dev_name</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

parent <span class="token operator">=</span> <span class="token function">get_device</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
kobj <span class="token operator">=</span> <span class="token function">get_device_parent</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>kobj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    error <span class="token operator">=</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>kobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">goto</span> parent_error<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>kobj<span class="token punctuation">)</span>
dev<span class="token operator">-&gt;</span>kobj<span class="token punctuation">.</span>parent <span class="token operator">=</span> kobj<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>打印调试信息，包括设备的名称和函数名。获取设备的父设备，并设置设备的父对象。如果获取父对象的过程中发生错误，那么将错误码设为获取父对象的返回值，并跳转到parent_error 标签处。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">dev_to_node</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span> <span class="token operator">==</span> NUMA_NO_NODE<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">set_dev_node</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token function">dev_to_node</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>如果设备有父设备且设备的节点号为NUMA_NO_NODE，那么将设备的节点号设为父设备的节点号。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">error <span class="token operator">=</span> <span class="token function">kobject_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>kobj<span class="token punctuation">,</span> dev<span class="token operator">-&gt;</span>kobj<span class="token punctuation">.</span>parent<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    glue_dir <span class="token operator">=</span> <span class="token function">get_glue_dir</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">goto</span> Error<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>使用kobject_add 函数将设备的内核对象添加到内核对象层次结构中。如果添加过程中发生错误，那么获取设备的”粘合目录”（glue_dir）并跳转到<code>Error</code>标签处。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span>platform_notify<span class="token punctuation">)</span>
    <span class="token function">platform_notify</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>如果存在平台通知函数（platform_notify），则调用该函数通知平台设备已添加。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">error <span class="token operator">=</span> <span class="token function">device_create_file</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dev_attr_uevent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span>
    <span class="token keyword">goto</span> attrError<span class="token punctuation">;</span>

error <span class="token operator">=</span> <span class="token function">device_add_class_symlinks</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span>
    <span class="token keyword">goto</span> SymlinkError<span class="token punctuation">;</span>

error <span class="token operator">=</span> <span class="token function">device_add_attrs</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span>
    <span class="token keyword">goto</span> AttrsError<span class="token punctuation">;</span>

error <span class="token operator">=</span> <span class="token function">bus_add_device</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span>
    <span class="token keyword">goto</span> BusError<span class="token punctuation">;</span>

error <span class="token operator">=</span> <span class="token function">dpm_sysfs_add</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span>
    <span class="token keyword">goto</span> DPMError<span class="token punctuation">;</span>

<span class="token function">device_pm_add</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>创建设备的uevent 属性文件。添加设备的类符号链接。添加设备的属性。添加设备到总线。添加设备电源管理相关的sysfs 接口。启动设备接下来的代码主要是处理设备的设备号（devt）相关操作，以及通知相关组件设备添加的过程。</p>
<p>在上述代码中，使用bus_add_device 函数添加设备到总线中，我们再来追踪下这个函数。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">bus_add_device</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">bus_type</span> <span class="token operator">*</span>bus <span class="token operator">=</span> <span class="token function">bus_get</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>bus<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取设备所属的总线类型(bus_type)的指针</span>
    <span class="token keyword">int</span> error <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 错误码初始化为0</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bus<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果成功获取总线类型指针</span>
        <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"bus: '%s': add device %s\n"</span><span class="token punctuation">,</span> bus<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> <span class="token function">dev_name</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打印调试信息，包括总线名称和设备名称</span>
        error <span class="token operator">=</span> <span class="token function">device_add_groups</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> bus<span class="token operator">-&gt;</span>dev_groups<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将设备添加到总线类型的设备组(dev_groups)中</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token comment">// 如果添加过程中发生错误</span>
            <span class="token keyword">goto</span> out_put<span class="token punctuation">;</span> <span class="token comment">// 跳转到out_put 标签处，执行错误处理代码</span>
        
        error <span class="token operator">=</span> <span class="token function">sysfs_create_link</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bus<span class="token operator">-&gt;</span>p<span class="token operator">-&gt;</span>devices_kset<span class="token operator">-&gt;</span>kobj<span class="token punctuation">,</span>
              <span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>kobj<span class="token punctuation">,</span> <span class="token function">dev_name</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 在总线类型的设备集(kset)的内核对象(kobj)下创建设备的符号链接</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token comment">// 如果创建过程中发生错误</span>
            <span class="token keyword">goto</span> out_groups<span class="token punctuation">;</span> <span class="token comment">// 跳转到out_groups 标签处，执行错误处理代码</span>
        
        error <span class="token operator">=</span> <span class="token function">sysfs_create_link</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>kobj<span class="token punctuation">,</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>bus<span class="token operator">-&gt;</span>p<span class="token operator">-&gt;</span>subsys<span class="token punctuation">.</span>kobj<span class="token punctuation">,</span> 
                <span class="token string">"subsystem"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 在设备的内核对象(kobj)下创建指向总线类型子系统(subsystem)的符号链接</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token comment">// 如果创建过程中发生错误</span>
            <span class="token keyword">goto</span> out_subsys<span class="token punctuation">;</span> <span class="token comment">// 跳转到out_subsys 标签处，执行错误处理代码</span>
        
        <span class="token function">klist_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>p<span class="token operator">-&gt;</span>knode_bus<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bus<span class="token operator">-&gt;</span>p<span class="token operator">-&gt;</span>klist_devices<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将设备的节点添加到总线类型的设备列表中</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 返回0 表示成功添加设备</span>
    
    out_subsys<span class="token operator">:</span>
    <span class="token function">sysfs_remove_link</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bus<span class="token operator">-&gt;</span>p<span class="token operator">-&gt;</span>devices_kset<span class="token operator">-&gt;</span>kobj<span class="token punctuation">,</span> <span class="token function">dev_name</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 移除设备和总线类型子系统之间的符号链接</span>
    
    out_groups<span class="token operator">:</span>
    <span class="token function">device_remove_groups</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> bus<span class="token operator">-&gt;</span>dev_groups<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 从总线类型的设备组中移除设备</span>
    
    out_put<span class="token operator">:</span>
    <span class="token function">bus_put</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>bus<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 减少设备的总线引用计数</span>
    <span class="token keyword">return</span> error<span class="token punctuation">;</span> <span class="token comment">// 返回错误码</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该代码是一个设备添加到总线的函数<code>bus_add_device()</code>。下面是对该函数的分析：</p>
<ol>
<li>bus_get(dev-&gt;bus)：通过设备的bus 字段获取设备所属的总线类型（bus_type）的指针。这个函数会增加总线的引用计数，确保总线在设备添加过程中不会被释放。</li>
<li>if (bus)：检查总线类型指针是否有效。</li>
<li>pr_debug(“bus: ‘%s’: add device %s\n”, bus-&gt;name, dev_name(dev))：打印调试信息，包括总线名称和设备名称，以便跟踪设备添加的过程。</li>
<li>device_add_groups(dev, bus-&gt;dev_groups)：将设备添加到总线类型的设备组（dev_groups）中。设备组是一组属性文件，用于在设备的sysfs 目录中显示和设置设备的属性。</li>
<li>sysfs_create_link(&amp;bus-&gt;p-&gt;devices_kset-&gt;kobj, &amp;dev-&gt;kobj, dev_name(dev))：在总线类型的设备集（devices_kset）的内核对象（kobj）下创建设备的符号链接。这个符号链接将设备的sysfs 目录链接到总线类型的设备集目录中。</li>
<li>sysfs_create_link(&amp;dev-&gt;kobj, &amp;dev-&gt;bus-&gt;p-&gt;subsys.kobj, “subsystem”)：在设备的内核对象（kobj）下创建指向总线类型子系统（subsystem）的符号链接。这个符号链接将设备的sysfs目录链接到总线类型子系统的目录中。</li>
<li>klist_add_tail(&amp;dev-&gt;p-&gt;knode_bus, &amp;bus-&gt;p-&gt;klist_devices)：将设备的节点添加到总线类型的设备列表中。这个步骤用于维护总线类型下的设备列表。</li>
</ol>
<p>至此，device_register 函数分析结束。</p>
<h2 id="第105-章platform-总线设备注册流程实例分析实验"><a href="#第105-章platform-总线设备注册流程实例分析实验" class="headerlink" title="第105 章platform 总线设备注册流程实例分析实验"></a>第105 章platform 总线设备注册流程实例分析实验</h2><p>在上个章节中，我们详细分析了设备是如何注册到总线上的过程，在本章节中，我们将进一步探讨platform 设备是如何注册到platform 总线上的。<br>在平台设备驱动中， 我们使用platform_device_register 函数注册平台总线设备。<code>platform_device_register</code> 函数实现如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">platform_device_register</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">device_initialize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">arch_setup_pdev_archdata</span><span class="token punctuation">(</span>pdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">platform_device_add</span><span class="token punctuation">(</span>pdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>device_initialize 函数在上个章节重点分析过， 在此不作过多解释。我们重点来看platform_device_add 函数，函数实现如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">platform_device_add</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    u32 i<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    
    <span class="token comment">// 检查输入的平台设备指针是否为空</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pdev<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    
    <span class="token comment">// 如果平台设备的父设备为空，将父设备设置为platform_bus</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>parent<span class="token punctuation">)</span>
        pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>parent <span class="token operator">=</span> <span class="token operator">&amp;</span>platform_bus<span class="token punctuation">;</span>
    
    <span class="token comment">// 将平台设备的总线设置为platform_bus_type</span>
    pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>bus <span class="token operator">=</span> <span class="token operator">&amp;</span>platform_bus_type<span class="token punctuation">;</span>
    
    <span class="token comment">// 根据平台设备的id 进行不同的处理</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>pdev<span class="token operator">-&gt;</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token comment">// 根据设备名和id 设置设备的名字</span>
        <span class="token function">dev_set_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"%s.%d"</span><span class="token punctuation">,</span> pdev<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> pdev<span class="token operator">-&gt;</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
            
        <span class="token keyword">case</span> PLATFORM_DEVID_NONE<span class="token operator">:</span>
        <span class="token comment">// 如果id 为PLATFORM_DEVID_NONE，则只使用设备名作为设备的名字</span>
        <span class="token function">dev_set_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> pdev<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
            
        <span class="token keyword">case</span> PLATFORM_DEVID_AUTO<span class="token operator">:</span>
        <span class="token comment">/*
        * 自动分配的设备ID。将其标记为自动分配的，以便我们记住它需要释放，
        * 并且为了避免与显式ID 的命名空间冲突，我们附加一个后缀。
        */</span>
        ret <span class="token operator">=</span> <span class="token function">ida_simple_get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>platform_devid_ida<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">goto</span> err_out<span class="token punctuation">;</span>
        pdev<span class="token operator">-&gt;</span>id <span class="token operator">=</span> ret<span class="token punctuation">;</span>
        pdev<span class="token operator">-&gt;</span>id_auto <span class="token operator">=</span> true<span class="token punctuation">;</span>
        <span class="token function">dev_set_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"%s.%d.auto"</span><span class="token punctuation">,</span> pdev<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> pdev<span class="token operator">-&gt;</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 遍历平台设备的资源列表，处理每个资源</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pdev<span class="token operator">-&gt;</span>num_resources<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">resource</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token operator">*</span>r <span class="token operator">=</span> <span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>resource<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 如果资源的名称为空，则将资源的名称设置为设备的名字</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token operator">-&gt;</span>name <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        r<span class="token operator">-&gt;</span>name <span class="token operator">=</span> <span class="token function">dev_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        p <span class="token operator">=</span> r<span class="token operator">-&gt;</span>parent<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            
            <span class="token comment">// 如果资源没有指定父资源，则根据资源类型设置默认的父资源</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">resource_type</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">==</span> IORESOURCE_MEM<span class="token punctuation">)</span>
                p <span class="token operator">=</span> <span class="token operator">&amp;</span>iomem_resource<span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">resource_type</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">==</span> IORESOURCE_IO<span class="token punctuation">)</span>
                p <span class="token operator">=</span> <span class="token operator">&amp;</span>ioport_resource<span class="token punctuation">;</span>
    	<span class="token punctuation">}</span>
        
        <span class="token comment">// 如果父资源存在，并且将资源插入到父资源中失败，则返回错误</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">&amp;&amp;</span> <span class="token function">insert_resource</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">dev_err</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"failed to claim resource %d: %pR\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ret <span class="token operator">=</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span>
            <span class="token keyword">goto</span> failed<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 打印调试信息，注册平台设备</span>
    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"Registering platform device '%s'. Parent at %s\n"</span><span class="token punctuation">,</span><span class="token function">dev_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">dev_name</span><span class="token punctuation">(</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>parent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 添加设备到设备层级中，注册设备</span>
    ret <span class="token operator">=</span> <span class="token function">device_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    
    failed<span class="token operator">:</span>
        <span class="token comment">// 如果设备ID 是自动分配的，需要移除已分配的ID</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pdev<span class="token operator">-&gt;</span>id_auto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ida_simple_remove</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>platform_devid_ida<span class="token punctuation">,</span> pdev<span class="token operator">-&gt;</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pdev<span class="token operator">-&gt;</span>id <span class="token operator">=</span> PLATFORM_DEVID_AUTO<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    
        <span class="token comment">// 在失败的情况下，释放已插入的资源</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">struct</span> <span class="token class-name">resource</span> <span class="token operator">*</span>r <span class="token operator">=</span> <span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>resource<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token operator">-&gt;</span>parent<span class="token punctuation">)</span>
                <span class="token function">release_resource</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    
    err_out<span class="token operator">:</span>
        <span class="token comment">// 返回错误码</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上述函数表示向平台总线中添加平台设备。下面是函数的执行过程及注释：</p>
<ul>
<li>第6~8 行代码中，检查传入的平台设备指针是否为空，如果为空则返回无效参数错误码。</li>
<li>第11 行代码中，如果平台设备的父设备为空，则将父设备设置为platform_bus。将平台设备的总线设置为platform_bus_type。</li>
<li>第17 行~39 行代码中，根据平台设备的ID 进行不同的处理：默认情况下，根据设备名称和ID 设置设备的名称。如果ID 为PLATFORM_DEVID_NONE，则只使用设备名称作为设备的名称。如果ID 为PLATFORM_DEVID_AUTO，则自动分配设备ID。使用ida_simple_get 函数获取一个可用的ID，并将设备ID 标记为自动分配。设备名称将附加一个后缀以避免与显式ID 的命名空间冲突。</li>
</ul>
<p>设置设备的名字，名字有三种格式，如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091446345.png" alt="image-20240909144609163"></p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091446538.png" alt="image-20240909144616376"></p>
<ul>
<li>第42 行~64 行代码中，遍历平台设备的资源列表，处理每个资源。如果资源的名称为空，则将资源的名称设置为设备的名称。如果资源没有指定父资源，则根据资源类型设置默认的父资源。如果父资源存在，并且将资源插入到父资源中失败，则返回忙碌错误码。<br>在Linux 操作系统中，为了方便管理设备资源，所有设备资源都会添加到资源树中。每个设备资源都会有一个父资源，用于表示该设备资源所属的资源的根。</li>
<li>第67 行代码，打印调试信息，注册平台设备。</li>
<li>第71 行代码，调用device_add 函数将设备添加到设备层级结构中进行设备注册。如果注册成功，则返回0。</li>
</ul>
<p>到此，platform 总线设备注册流程分析完毕。</p>
<h2 id="第106-章为什么注册总线之前要先注册设备实例分析实验"><a href="#第106-章为什么注册总线之前要先注册设备实例分析实验" class="headerlink" title="第106 章为什么注册总线之前要先注册设备实例分析实验"></a>第106 章为什么注册总线之前要先注册设备实例分析实验</h2><p>在上个章节中，我们详细分析了设备如何注册到总线上的过程，其中包括platform 设备的注册。但在注册platform 设备之前，会先调用device_register() 函数注册一个platform bus设备。</p>
<p>为了更好地理解这一过程，需要了解platform 总线的特性。在Linux 内核中，platform 总线是一种特殊的总线类型，用于管理与硬件平台紧密相关的设备。它提供了一种机制，使得与特定硬件平台相关的设备能够在系统中得到正确的识别和初始化。</p>
<p>在注册platform 总线之前，需要先注册一个platform bus 设备。这个platform bus 设备充当了platform 总线的代表，它是platform 总线与设备之间的桥梁。通过注册platform bus设备，系统可以识别到platform 总线的存在，并为后续的platform 设备注册提供必要的基础。通过调用device_register() 函数注册platform bus 设备，可以将其添加到设备层次结构中，并与platform 总线相关联。这样，当platform 总线初始化时，它可以找到并识别这个platform bus 设备，进而完成platform 设备的注册和管理。</p>
<p>接下来我们从代码的层面进行分析这个问题。<br>platform_bus_init 函数如下图所示：</p>
<img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091448730.png" alt="image-20240909144859549" style="zoom:80%;">

<p>先调用device_register 函数注册paltform_bus 这个设备，会在/sys/devices 目录下创建目录<code>/sys/devices/platform</code>，此目录所有platform 设备的父目录，即所有platform_device 设备都会在<code>/sys/devices/platform</code> 下创建子目录，如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409091525227.png" alt="image-20240909152551038"></p>
<p>创建好platform bus 设备之后，使用platform_device_add 函数将platform_device 结构体添加到platform 总线中进行注册，代码实现如下所示：</p>
<img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409120958900.png" alt="image-20240912095848722" style="zoom: 67%;">

<p>至此，注册总线之前要先注册设备实验分析完毕。</p>
<h2 id="第107-章在自己的总线下注册驱动实验"><a href="#第107-章在自己的总线下注册驱动实验" class="headerlink" title="第107 章在自己的总线下注册驱动实验"></a>第107 章在自己的总线下注册驱动实验</h2><h3 id="107-1-实验程序的编写"><a href="#107-1-实验程序的编写" class="headerlink" title="107.1 实验程序的编写"></a>107.1 实验程序的编写</h3><h4 id="107-1-1-驱动程序编写"><a href="#107-1-1-驱动程序编写" class="headerlink" title="107.1.1 驱动程序编写"></a>107.1.1 驱动程序编写</h4><p>本实验对应的网盘路径为：<code>iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\77_driver\module</code>。<br>我们编写驱动代码，这段代码的作用是注册一个驱动程序，该驱动程序属于名为”mydevice”的总线类型”mybus”，并在探测设备时调用”mydriver_probe”函数，移除设备时调用”mydriver_remove”函数。编写完成的driver.c 代码如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/configfs.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kobject.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/device.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/sysfs.h&gt;</span></span>

<span class="token keyword">extern</span> <span class="token keyword">struct</span> <span class="token class-name">bus_type</span> mybus<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">mydriver_remove</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"This is mydriver_remove\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">mydriver_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"This is mydriver_probe\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token keyword">struct</span> <span class="token class-name">device_driver</span> mydriver <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"mydevice"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>bus <span class="token operator">=</span> <span class="token operator">&amp;</span>mybus<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>probe <span class="token operator">=</span> mydriver_probe<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>remove <span class="token operator">=</span> mydriver_remove<span class="token punctuation">,</span>
    
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 模块的初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">mydriver_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">driver_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mydriver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 模块退出函数</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">mydriver_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">driver_unregister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mydriver<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>mydriver_init<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定模块的初始化函数</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>mydriver_exit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定模块的退出函数</span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 模块使用的许可证</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"topeet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 模块的作者</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="107-3-运行测试"><a href="#107-3-运行测试" class="headerlink" title="107.3 运行测试"></a>107.3 运行测试</h3><h4 id="107-3-1-编译驱动程序"><a href="#107-3-1-编译驱动程序" class="headerlink" title="107.3.1 编译驱动程序"></a>107.3.1 编译驱动程序</h4><p>在上一小节中的driver.c 代码同一目录下创建Makefile 文件，Makefile 文件内容如下所示：然后使用命令“make”进行驱动的编译，编译完生成driver.ko 目标文件，至此驱动模块就编译成功了，接下来进行测试。</p>
<h4 id="107-3-2-运行测试"><a href="#107-3-2-运行测试" class="headerlink" title="107.3.2 运行测试"></a>107.3.2 运行测试</h4><p>开发板启动之后，使用以下命令进行bus.ko 驱动模块的加载，如下图（图107-4）所示：</p>
<pre class="line-numbers language-none"><code class="language-none">insmod bus.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409121002687.png" alt="image-20240912100204584"></p>
<p>然后加载device.ko 驱动模块，如下图所示：</p>
<pre class="line-numbers language-none"><code class="language-none">insmod device.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409121002922.png" alt="image-20240912100244826"></p>
<p>然后加载driver.ko 驱动模块，如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409121002411.png" alt="image-20240912100255311"></p>
<p>驱动加载之后，我们进入/sys/devices 目录下，如下图所示，有注册生成的设备。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409121003151.png" alt="image-20240912100312052"></p>
<p>我们进入到<code>/sys/bus/mybus/devices</code> 目录下，如下图所示，在总线下注册的设备为mydevice。然后进入到<code>/sys/bus/mybus/driver</code> 目录下，如下图所示，在总线下注册的驱动为mydevice</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409121003855.png" alt="image-20240912100343744"></p>
<p>最后可以使用以下命令进行驱动的卸载，如下所示：</p>
<pre class="line-numbers language-none"><code class="language-none">rmmod device
rmmod driver
rmmod bus<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>至此，在总线下注册驱动实验就完成了。</p>
<h2 id="第108-章驱动注册流程分析实验"><a href="#第108-章驱动注册流程分析实验" class="headerlink" title="第108 章驱动注册流程分析实验"></a>第108 章驱动注册流程分析实验</h2><p>在上一章节中，我们学习了设备注册到自定义总线下，并进行了实验。在本章节中，我们将继续探讨驱动是如何注册到总线上的。<br>一旦驱动程序的结构体和匹配信息准备就绪，我们就可以调用<code>driver_register()</code> 函数将驱动程序注册到总线上。</p>
<h3 id="108-1-driver-register-函数解析"><a href="#108-1-driver-register-函数解析" class="headerlink" title="108.1 driver_register 函数解析"></a>108.1 driver_register 函数解析</h3><p><code>driver_register</code> 函数实现如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">driver_register</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_driver</span> <span class="token operator">*</span>drv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_driver</span> <span class="token operator">*</span>other<span class="token punctuation">;</span>
    
    <span class="token comment">// 检查总线是否已初始化</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>drv<span class="token operator">-&gt;</span>bus<span class="token operator">-&gt;</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"Driver '%s' was unable to register with bus_type '%s' because the bus was not initialized.\n"</span><span class="token punctuation">,</span>drv<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> drv<span class="token operator">-&gt;</span>bus<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 检查驱动程序的方法是否需要更新</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>drv<span class="token operator">-&gt;</span>bus<span class="token operator">-&gt;</span>probe <span class="token operator">&amp;&amp;</span> drv<span class="token operator">-&gt;</span>probe<span class="token punctuation">)</span> <span class="token operator">||</span><span class="token punctuation">(</span>drv<span class="token operator">-&gt;</span>bus<span class="token operator">-&gt;</span>remove <span class="token operator">&amp;&amp;</span> drv<span class="token operator">-&gt;</span>remove<span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token punctuation">(</span>drv<span class="token operator">-&gt;</span>bus<span class="token operator">-&gt;</span>shutdown <span class="token operator">&amp;&amp;</span> drv<span class="token operator">-&gt;</span>shutdown<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"Driver '%s' needs updating - please use bus_type methods\n"</span><span class="token punctuation">,</span> drv<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 检查驱动程序是否已被注册</span>
    other <span class="token operator">=</span> <span class="token function">driver_find</span><span class="token punctuation">(</span>drv<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> drv<span class="token operator">-&gt;</span>bus<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>other<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"Error: Driver '%s' is already registered, aborting...\n"</span><span class="token punctuation">,</span> drv<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    ret <span class="token operator">=</span> <span class="token function">bus_add_driver</span><span class="token punctuation">(</span>drv<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将驱动程序添加到总线</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    
    ret <span class="token operator">=</span> <span class="token function">driver_add_groups</span><span class="token punctuation">(</span>drv<span class="token punctuation">,</span> drv<span class="token operator">-&gt;</span>groups<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 添加驱动程序的组属性</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">bus_remove_driver</span><span class="token punctuation">(</span>drv<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 移除已添加的驱动程序</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">kobject_uevent</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>drv<span class="token operator">-&gt;</span>p<span class="token operator">-&gt;</span>kobj<span class="token punctuation">,</span> KOBJ_ADD<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 发送内核对象事件，通知驱动程序添加成功</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span> <span class="token comment">// 返回注册结果</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>driver_register 函数用于注册设备驱动程序并将其添加到总线中。以下是该函数的功能解释：</p>
<ul>
<li>第5~11 行代码检查总线是否已初始化：<ul>
<li>首先，通过drv-&gt;bus 访问设备驱动程序结构体中的总线信息。如果总线的p 成员为NULL，表示总线未初始化。如果总线未初始化，则打印错误消息，并返回-EINVAL 错误码表示无效的参数。</li>
</ul>
</li>
<li>第13 行~19 行代码检查驱动程序的方法是否需要更新：<ul>
<li>通过检查驱动程序结构体中的bus-&gt;probe 和drv-&gt;probe、bus-&gt;remove 和drv-&gt;remove、bus-&gt;shutdown 和drv-&gt;shutdown 成员是否同时存在来判断。如果存在需要更新的方法组合，说明驱动程序需要更新。在这种情况下，打印警告消息，建议使用bus_type 方法进行更新。</li>
</ul>
</li>
<li>第21 行~26 行检查驱动程序是否已被注册：<ul>
<li>调用driver_find 函数来查找是否已经注册了同名的驱动程序。如果找到同名驱动程序，表示驱动程序已经注册过。在这种情况下，打印错误消息，并返回-EBUSY 错误码表示设备忙。</li>
</ul>
</li>
<li>第28 行代码添加驱动程序到总线：<ul>
<li>调用<code>bus_add_driver</code> 函数将驱动程序添加到总线。如果添加失败，则返回相应的错误码。</li>
</ul>
</li>
<li>第31 行代码添加驱动程序的组属性：<ul>
<li>调用<code>driver_add_groups</code> 函数将驱动程序的组属性添加到驱动程序中。如果添加失败，则调用<code>bus_remove_driver</code> 函数移除已添加的驱动程序，并返回相应的错误码。</li>
</ul>
</li>
<li>第36 行代码发送内核对象事件：<ul>
<li>调用<code>kobject_uevent</code> 函数向驱动程序的内核对象发送事件，通知驱动程序已成功添加到系统中。</li>
</ul>
</li>
</ul>
<p>综上所述，driver_register 函数的功能是注册设备驱动程序并将其添加到总线中，同时进行各种检查和错误处理操作。<br>在上面代码中，调用bus_add_driver 函数将驱动程序添加到总线。我们来详细分析下<code>bus_add_driver</code> 函数。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">bus_add_driver</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_driver</span> <span class="token operator">*</span>drv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">bus_type</span> <span class="token operator">*</span>bus<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">driver_private</span> <span class="token operator">*</span>priv<span class="token punctuation">;</span>
    <span class="token keyword">int</span> error <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 获取总线对象</span>
    bus <span class="token operator">=</span> <span class="token function">bus_get</span><span class="token punctuation">(</span>drv<span class="token operator">-&gt;</span>bus<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bus<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span> <span class="token comment">// 返回无效参数错误码</span>
    
    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"bus: '%s': add driver %s\n"</span><span class="token punctuation">,</span> bus<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> drv<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 分配并初始化驱动程序私有数据</span>
    priv <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>priv<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>priv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        error <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> out_put_bus<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">klist_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>priv<span class="token operator">-&gt;</span>klist_devices<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    priv<span class="token operator">-&gt;</span>driver <span class="token operator">=</span> drv<span class="token punctuation">;</span>
    drv<span class="token operator">-&gt;</span>p <span class="token operator">=</span> priv<span class="token punctuation">;</span>
    priv<span class="token operator">-&gt;</span>kobj<span class="token punctuation">.</span>kset <span class="token operator">=</span> bus<span class="token operator">-&gt;</span>p<span class="token operator">-&gt;</span>drivers_kset<span class="token punctuation">;</span>
    
    <span class="token comment">// 初始化并添加驱动程序的内核对象</span>
    error <span class="token operator">=</span> <span class="token function">kobject_init_and_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>priv<span class="token operator">-&gt;</span>kobj<span class="token punctuation">,</span> <span class="token operator">&amp;</span>driver_ktype<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token string">"%s"</span><span class="token punctuation">,</span> drv<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> out_unregister<span class="token punctuation">;</span>
    
    <span class="token comment">// 将驱动程序添加到总线的驱动程序列表</span>
    <span class="token function">klist_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>priv<span class="token operator">-&gt;</span>knode_bus<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bus<span class="token operator">-&gt;</span>p<span class="token operator">-&gt;</span>klist_drivers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 如果总线启用了自动探测，则尝试自动探测设备</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>drv<span class="token operator">-&gt;</span>bus<span class="token operator">-&gt;</span>p<span class="token operator">-&gt;</span>drivers_autoprobe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        error <span class="token operator">=</span> <span class="token function">driver_attach</span><span class="token punctuation">(</span>drv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span>
            <span class="token keyword">goto</span> out_unregister<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 将驱动程序添加到模块</span>
    <span class="token function">module_add_driver</span><span class="token punctuation">(</span>drv<span class="token operator">-&gt;</span>owner<span class="token punctuation">,</span> drv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 创建驱动程序的uevent 属性文件</span>
    error <span class="token operator">=</span> <span class="token function">driver_create_file</span><span class="token punctuation">(</span>drv<span class="token punctuation">,</span> <span class="token operator">&amp;</span>driver_attr_uevent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"%s: uevent attr (%s) failed\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">,</span> drv<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 添加驱动程序的组属性</span>
    error <span class="token operator">=</span> <span class="token function">driver_add_groups</span><span class="token punctuation">(</span>drv<span class="token punctuation">,</span> bus<span class="token operator">-&gt;</span>drv_groups<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* How the hell do we get out of this pickle? Give up */</span>
        <span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"%s: driver_create_groups(%s) failed\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">,</span> drv<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 如果驱动程序不禁止绑定属性文件，则添加绑定属性文件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>drv<span class="token operator">-&gt;</span>suppress_bind_attrs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        error <span class="token operator">=</span> <span class="token function">add_bind_files</span><span class="token punctuation">(</span>drv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/* Ditto */</span>
            <span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"%s: add_bind_files(%s) failed\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">,</span> drv<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 返回成功</span>
    
    out_unregister<span class="token operator">:</span>
        <span class="token function">kobject_put</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>priv<span class="token operator">-&gt;</span>kobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* drv-&gt;p is freed in driver_release() */</span>
        drv<span class="token operator">-&gt;</span>p <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    out_put_bus<span class="token operator">:</span>
        <span class="token function">bus_put</span><span class="token punctuation">(</span>bus<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> error<span class="token punctuation">;</span> <span class="token comment">// 返回错误码</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>bus_add_driver 该函数用于将设备驱动程序添加到总线中。以下是功能的详细解释：</p>
<ul>
<li>第8 行代码获取总线对象：<ul>
<li>通过drv-&gt;bus 访问设备驱动程序结构体中的总线信息。通过调用bus_get 函数获取总线对象。如果总线对象不存在，则返回-EINVAL 错误码表示无效的参数。</li>
</ul>
</li>
<li>第15 行~23 行代码分配并初始化驱动程序私有数据：<ul>
<li>调用kzalloc 函数为驱动程序的私有数据结构体priv 分配内存，并使用GFP_KERNEL 标志进行内存分配。如果内存分配失败，则返回-ENOMEM 错误码表示内存不足。使用klist_init函数初始化priv 结构体中的设备列表。设置priv 结构体中的驱动程序指针，并将其赋值为当前的驱动程序。将drv-&gt;p 指向priv 结构体，以便后续的释放操作。</li>
</ul>
</li>
<li>第25 行代码初始化并添加驱动程序的内核对象：<ul>
<li>设置priv-&gt;kobj.kset 成员为总线对象的drivers_kset。调用kobject_init_and_add 函数初始化并添加驱动程序的内核对象。如果初始化或添加失败，则跳转到out_unregister 进行错误<br>处理。</li>
</ul>
</li>
<li>第31 行代码将驱动程序添加到总线的驱动程序列表：<ul>
<li>使用klist_add_tail 函数将驱动程序的节点添加到总线的驱动程序列表中。</li>
</ul>
</li>
</ul>
<p>到此，如何在总线下注册驱动流程已经分析完毕。</p>
<h2 id="第109-章probe-函数执行流程分析实验"><a href="#第109-章probe-函数执行流程分析实验" class="headerlink" title="第109 章probe 函数执行流程分析实验"></a>第109 章probe 函数执行流程分析实验</h2><p>在上个章节中，我们在代码中分析了驱动在总线下注册的流程，本章节我们继续分析代码，分析probe 函数执行流程。<br>接着上个章节分析<code>bus_add_driver</code> 函数。<code>bus_add_driver</code> 函数实现如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">bus_add_driver</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_driver</span> <span class="token operator">*</span>drv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">bus_type</span> <span class="token operator">*</span>bus<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">driver_private</span> <span class="token operator">*</span>priv<span class="token punctuation">;</span>
    <span class="token keyword">int</span> error <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 获取总线对象</span>
    bus <span class="token operator">=</span> <span class="token function">bus_get</span><span class="token punctuation">(</span>drv<span class="token operator">-&gt;</span>bus<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bus<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span> <span class="token comment">// 返回无效参数错误码</span>
    
    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"bus: '%s': add driver %s\n"</span><span class="token punctuation">,</span> bus<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> drv<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 分配并初始化驱动程序私有数据</span>
    priv <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>priv<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>priv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        error <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> out_put_bus<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">klist_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>priv<span class="token operator">-&gt;</span>klist_devices<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    priv<span class="token operator">-&gt;</span>driver <span class="token operator">=</span> drv<span class="token punctuation">;</span>
    drv<span class="token operator">-&gt;</span>p <span class="token operator">=</span> priv<span class="token punctuation">;</span>
    priv<span class="token operator">-&gt;</span>kobj<span class="token punctuation">.</span>kset <span class="token operator">=</span> bus<span class="token operator">-&gt;</span>p<span class="token operator">-&gt;</span>drivers_kset<span class="token punctuation">;</span>
    
    <span class="token comment">// 初始化并添加驱动程序的内核对象</span>
    error <span class="token operator">=</span> <span class="token function">kobject_init_and_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>priv<span class="token operator">-&gt;</span>kobj<span class="token punctuation">,</span> <span class="token operator">&amp;</span>driver_ktype<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token string">"%s"</span><span class="token punctuation">,</span> drv<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> out_unregister<span class="token punctuation">;</span>
    
    <span class="token comment">// 将驱动程序添加到总线的驱动程序列表</span>
    <span class="token function">klist_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>priv<span class="token operator">-&gt;</span>knode_bus<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bus<span class="token operator">-&gt;</span>p<span class="token operator">-&gt;</span>klist_drivers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 如果总线启用了自动探测，则尝试自动探测设备</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>drv<span class="token operator">-&gt;</span>bus<span class="token operator">-&gt;</span>p<span class="token operator">-&gt;</span>drivers_autoprobe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        error <span class="token operator">=</span> <span class="token function">driver_attach</span><span class="token punctuation">(</span>drv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span>
            <span class="token keyword">goto</span> out_unregister<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 将驱动程序添加到模块</span>
    <span class="token function">module_add_driver</span><span class="token punctuation">(</span>drv<span class="token operator">-&gt;</span>owner<span class="token punctuation">,</span> drv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 创建驱动程序的uevent 属性文件</span>
    error <span class="token operator">=</span> <span class="token function">driver_create_file</span><span class="token punctuation">(</span>drv<span class="token punctuation">,</span> <span class="token operator">&amp;</span>driver_attr_uevent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"%s: uevent attr (%s) failed\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">,</span> drv<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 添加驱动程序的组属性</span>
    error <span class="token operator">=</span> <span class="token function">driver_add_groups</span><span class="token punctuation">(</span>drv<span class="token punctuation">,</span> bus<span class="token operator">-&gt;</span>drv_groups<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* How the hell do we get out of this pickle? Give up */</span>
        <span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"%s: driver_create_groups(%s) failed\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">,</span> drv<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 如果驱动程序不禁止绑定属性文件，则添加绑定属性文件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>drv<span class="token operator">-&gt;</span>suppress_bind_attrs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        error <span class="token operator">=</span> <span class="token function">add_bind_files</span><span class="token punctuation">(</span>drv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/* Ditto */</span>
            <span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"%s: add_bind_files(%s) failed\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">,</span> drv<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 返回成功</span>
    
    out_unregister<span class="token operator">:</span>
        <span class="token function">kobject_put</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>priv<span class="token operator">-&gt;</span>kobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* drv-&gt;p is freed in driver_release() */</span>
        drv<span class="token operator">-&gt;</span>p <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    out_put_bus<span class="token operator">:</span>
        <span class="token function">bus_put</span><span class="token punctuation">(</span>bus<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> error<span class="token punctuation">;</span> <span class="token comment">// 返回错误码</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>第31 行~37 行代码自动探测设备：<ul>
<li>如果总线启用了自动探测（drivers_autoprobe 标志），则调用driver_attach 函数尝试自动探测设备。<br>如果自动探测失败，则跳转到out_unregister 进行错误处理。<br>变量drivers_autoprobe 也可以在用户空间通过属性文件drivers_autoprobe 来控制，再次体现属性文件的作用。</li>
</ul>
</li>
<li><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409121020405.png" alt="image-20240912102010300"></li>
<li>第39 行代码将驱动程序添加到模块：<ul>
<li>调用module_add_driver 函数将驱动程序添加到模块中。</li>
</ul>
</li>
<li>第42 行~46 行代码创建驱动程序的uevent 属性文件：<ul>
<li>调用driver_create_file 函数为驱动程序创建uevent 属性文件。如果创建失败，则打印错误消息。</li>
</ul>
</li>
<li>第48 行~53 行代码添加驱动程序的组属性：<ul>
<li>调用driver_add_groups 函数将驱动程序的组属性添加到驱动程序中。如果添加失败，则打印错误消息。</li>
</ul>
</li>
<li>第56 行~63 行添加绑定属性文件：<ul>
<li>如果驱动程序没有禁止绑定属性文件（suppress_bind_attrs 标志），则调用add_bind_files函数添加绑定属性文件。如果添加失败，则打印错误消息。</li>
</ul>
</li>
</ul>
<p>在上述函数中，使用driver_attach 函数来探测设备，我们进一步分析下driver_attach 函数。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">driver_attach</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_driver</span> <span class="token operator">*</span>drv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">bus_for_each_dev</span><span class="token punctuation">(</span>drv<span class="token operator">-&gt;</span>bus<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> drv<span class="token punctuation">,</span> __driver_attach<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">EXPORT_SYMBOL_GPL</span><span class="token punctuation">(</span>driver_attach<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>bus_for_each_dev</code> 函数实现如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">bus_for_each_dev</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">bus_type</span> <span class="token operator">*</span>bus<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>start<span class="token punctuation">,</span>
                     <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fn<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">klist_iter</span> i<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">;</span>
    <span class="token keyword">int</span> error <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 检查总线对象是否存在</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bus <span class="token operator">||</span> <span class="token operator">!</span>bus<span class="token operator">-&gt;</span>p<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span> <span class="token comment">// 返回无效参数错误码</span>
    
    <span class="token comment">// 初始化设备列表迭代器</span>
    <span class="token function">klist_iter_init_node</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bus<span class="token operator">-&gt;</span>p<span class="token operator">-&gt;</span>klist_devices<span class="token punctuation">,</span> <span class="token operator">&amp;</span>i<span class="token punctuation">,</span><span class="token punctuation">(</span>start <span class="token operator">?</span> <span class="token operator">&amp;</span>start<span class="token operator">-&gt;</span>p<span class="token operator">-&gt;</span>knode_bus <span class="token operator">:</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 遍历设备列表并执行指定的函数</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>error <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>dev <span class="token operator">=</span> <span class="token function">next_device</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        error <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 退出设备列表迭代器</span>
    <span class="token function">klist_iter_exit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> error<span class="token punctuation">;</span> <span class="token comment">// 返回执行过程中的错误码（如果有）</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个函数的作用是遍历指定总线上的所有设备，并对每个设备执行指定的函数fn。以下是函数的参数和功能解释：</p>
<ul>
<li><p>bus：指定要遍历的总线对象。</p>
</li>
<li><p>start：指定开始遍历的设备对象。如果为NULL，则从总线的第一个设备开始遍历。</p>
</li>
<li><p>data：传递给函数fn 的额外数据。</p>
</li>
<li><p>fn：指定要执行的函数，该函数接受一个设备对象和额外数据作为参数，并返回一个整数错误码。</p>
</li>
<li><p>第9 行代码中，首先，检查传入的总线对象是否存在以及与该总线相关的私有数据是否存在。如果总线对象或其私有数据不存在，返回-EINVAL 表示无效的参数错误码。</p>
</li>
<li><p>第13 行~14 行代码中，接下来，初始化设备列表迭代器，以便遍历总线上的设备。使用klist_iter_init_node 函数初始化一个设备列表迭代器。传递总线对象的设备列表klist_devices、迭代器对象i，以及可选的起始设备的节点指针。然后，在一个循环中遍历设备列表并执行指定的函数。</p>
</li>
<li><p>第17 行代码中，使用next_device 函数从迭代器中获取下一个设备。如果存在下一个设备，则调用传入的函数指针fn，并将当前设备和额外的数据参数传递给它。如果执行函数时出现错误，将错误码赋值给error。</p>
</li>
<li><p>第21 行代码中，最后，退出设备列表迭代器，释放相关资源。使用klist_iter_exit 函数退出设备列表的迭代器。</p>
</li>
</ul>
<p>总的来说， <code>bus_for_each_dev()</code> 函数主要是提供了一个遍历指定总线上的设备对象列表，并对每个设备对象进行特定操作的快捷方式，可以用于驱动程序中需要管理和操作大量设备实例的场景。<br>fn 要执行的函数为<code>__driver_attach</code> 函数，函数实现如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">__driver_attach</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_driver</span> <span class="token operator">*</span>drv <span class="token operator">=</span> data<span class="token punctuation">;</span> <span class="token comment">// 传入的数据参数作为设备驱动对象</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token comment">/*
    * Lock device and try to bind to it. We drop the error
    * here and always return 0, because we need to keep trying
    * to bind to devices and some drivers will return an error
    * simply if it didn't support the device.
    *
    * driver_probe_device() will spit a warning if there
    * is an error.
    */</span>
    ret <span class="token operator">=</span> <span class="token function">driver_match_device</span><span class="token punctuation">(</span>drv<span class="token punctuation">,</span> dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 尝试将驱动程序绑定到设备上</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* no match */</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 如果没有匹配，则返回0</span>
    <span class="token punctuation">}</span> 
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span>EPROBE_DEFER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dev_dbg</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"Device match requests probe deferral\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">driver_deferred_probe_add</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 请求推迟探测设备</span>
    <span class="token punctuation">}</span>  
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dev_dbg</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"Bus failed to match device: %d"</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span> <span class="token comment">// 总线无法匹配设备，返回错误码</span>
    <span class="token punctuation">}</span> <span class="token comment">/* ret &gt; 0 means positive match */</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">driver_allows_async_probing</span><span class="token punctuation">(</span>drv<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/*
        * Instead of probing the device synchronously we will
        * probe it asynchronously to allow for more parallelism.
        *
        * We only take the device lock here in order to guarantee
        * that the dev-&gt;driver and async_driver fields are protected
        */</span>
        <span class="token function">dev_dbg</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"probing driver %s asynchronously\n"</span><span class="token punctuation">,</span> drv<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">device_lock</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 锁定设备以保护dev-&gt;driver 和async_driver 字段</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dev<span class="token operator">-&gt;</span>driver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">get_device</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
            dev<span class="token operator">-&gt;</span>p<span class="token operator">-&gt;</span>async_driver <span class="token operator">=</span> drv<span class="token punctuation">;</span> <span class="token comment">// 设置设备的异步驱动程序</span>
            <span class="token function">async_schedule</span><span class="token punctuation">(</span>__driver_attach_async_helper<span class="token punctuation">,</span> dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 异步调度驱动程序的附加处理函数</span>
        <span class="token punctuation">}</span>
        <span class="token function">device_unlock</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解锁设备</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token function">device_driver_attach</span><span class="token punctuation">(</span>drv<span class="token punctuation">,</span> dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 同步探测设备并绑定驱动程序</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 返回0 表示成功执行驱动程序附加操作</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上述函数中使用<code>driver_match_device</code> 函数尝试将驱动程序绑定到设备上，我们再来看看<code>driver_match_device</code> 函数。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">int</span> <span class="token function">driver_match_device</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_driver</span> <span class="token operator">*</span>drv<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> drv<span class="token operator">-&gt;</span>bus<span class="token operator">-&gt;</span>match <span class="token operator">?</span> drv<span class="token operator">-&gt;</span>bus<span class="token operator">-&gt;</span><span class="token function">match</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> drv<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>这是一个内联函数driver_match_device 的代码片段。该函数用于检查设备是否与驱动程序匹配。以下是对代码的解释：<br>    drv：指向设备驱动程序对象的指针。<br>    dev：指向设备对象的指针。</p>
<p>函数的执行过程如下：</p>
<ol>
<li>首先，检查驱动程序对象的bus 字段是否为NULL，以及bus 字段的match 函数是否存在。驱动程序对象的bus 字段表示该驱动程序所属的总线。match 函数是总线对象中的一个函数指针，用于检查设备与驱动程序是否匹配。</li>
<li>如果match`函数存在，则调用总线对象的match 函数，传入设备对象和驱动程序对象作为参数。<br> drv-&gt;bus-&gt;match(dev, drv)表示调用总线对象的match 函数，并将设备对象和驱动程序对象作为参数传递给该函数。dev 是用于匹配的设备对象。drv 是用于匹配的驱动程序对象。</li>
<li>如果总线对象的match 函数返回0，则表示设备与驱动程序不匹配，函数将返回0。返回值为0 表示不匹配</li>
<li>如果总线对象的match 函数返回非零值（大于0），则表示设备与驱动程序匹配，函数将返回1。返回值为1 表示匹配。</li>
<li>如果总线对象的match 函数不存在（为NULL），则默认认为设备与驱动程序匹配，函数将返回1。<br> 这段代码使用了条件运算符<code>? :</code> 来判断总线对象的match 函数是否存在，以便选择执行相应的逻辑。如果总线对象没有提供match 函数，那么默认认为设备与驱动程序匹配，返回值为1。</li>
</ol>
<p>如果设备和驱动匹配上，会继续执行device_driver_attach 函数，如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">device_driver_attach</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_driver</span> <span class="token operator">*</span>drv<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">__device_driver_lock</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> dev<span class="token operator">-&gt;</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*
    * If device has been removed or someone has already successfully
    * bound a driver before us just skip the driver probe call.
    */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dev<span class="token operator">-&gt;</span>p<span class="token operator">-&gt;</span>dead <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>dev<span class="token operator">-&gt;</span>driver<span class="token punctuation">)</span>
        ret <span class="token operator">=</span> <span class="token function">driver_probe_device</span><span class="token punctuation">(</span>drv<span class="token punctuation">,</span> dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__device_driver_unlock</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> dev<span class="token operator">-&gt;</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>driver_probe_device</code> 函数，如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">driver_probe_device</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_driver</span> <span class="token operator">*</span>drv<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 检查设备是否已注册，如果未注册则返回错误码-ENODEV</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">device_is_registered</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">;</span>
    
    <span class="token comment">// 打印调试信息，表示设备与驱动程序匹配</span>
    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"bus: '%s': %s: matched device %s with driver %s\n"</span><span class="token punctuation">,</span>drv<span class="token operator">-&gt;</span>bus<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> 
             <span class="token constant">__func__</span><span class="token punctuation">,</span> <span class="token function">dev_name</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">,</span> drv<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 获取设备供应商的运行时引用计数</span>
    <span class="token function">pm_runtime_get_suppliers</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 如果设备有父设备，获取父设备的同步运行时引用计数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>parent<span class="token punctuation">)</span>
        <span class="token function">pm_runtime_get_sync</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 等待设备的运行时状态达到稳定</span>
    <span class="token function">pm_runtime_barrier</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 根据初始化调试标志选择调用真实的探测函数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>initcall_debug<span class="token punctuation">)</span>
        ret <span class="token operator">=</span> <span class="token function">really_probe_debug</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> drv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        ret <span class="token operator">=</span> <span class="token function">really_probe</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> drv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 请求设备进入空闲状态（省电模式）</span>
    <span class="token function">pm_request_idle</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 如果设备有父设备，释放父设备的运行时引用计数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>parent<span class="token punctuation">)</span>
        <span class="token function">pm_runtime_put</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 释放设备供应商的运行时引用计数</span>
    <span class="token function">pm_runtime_put_suppliers</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 返回探测函数的执行结果</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>经过前面代码的分析，总结设备和驱动匹配流程函数，如下图所示</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409121034133.png" alt="image-20240912103404026"></p>
<p><code>probe</code> 函数的执行，我们来分析<code>really_probe</code> 函数。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">really_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">device_driver</span> <span class="token operator">*</span>drv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token operator">-</span>EPROBE_DEFER<span class="token punctuation">;</span> <span class="token comment">// 初始化返回值为延迟探测</span>
    <span class="token keyword">int</span> local_trigger_count <span class="token operator">=</span> <span class="token function">atomic_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>deferred_trigger_count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取当前延迟探测计数</span>
    <span class="token comment">// 判断是否启用了驱动移除测试</span>
    bool test_remove <span class="token operator">=</span> <span class="token function">IS_ENABLED</span><span class="token punctuation">(</span>CONFIG_DEBUG_TEST_DRIVER_REMOVE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span><span class="token operator">!</span>drv<span class="token operator">-&gt;</span>suppress_bind_attrs<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>defer_all_probes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/*
        * defer_all_probes 的值只能通过device_defer_all_probes_enable() 设置，
        * 而该函数会紧接着调用wait_for_device_probe()，以避免任何竞争情况。
        */</span>
        <span class="token function">dev_dbg</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"Driver %s 强制延迟探测\n"</span><span class="token punctuation">,</span> drv<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">driver_deferred_probe_add</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    ret <span class="token operator">=</span> <span class="token function">device_links_check_suppliers</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 检查设备的供应者链路</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span>EPROBE_DEFER<span class="token punctuation">)</span>
    	<span class="token function">driver_deferred_probe_add_trigger</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> local_trigger_count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将设备添加到延迟探测触发列表</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
    	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    
    <span class="token function">atomic_inc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>probe_count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 增加探测计数</span>
    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"bus: '%s': %s: 正在使用设备%s 探测驱动程序%s\n"</span><span class="token punctuation">,</span>drv<span class="token operator">-&gt;</span>bus<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> 
             <span class="token constant">__func__</span><span class="token punctuation">,</span> drv<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> <span class="token function">dev_name</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">list_empty</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>devres_head<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dev_crit</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"探测之前存在资源\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> done<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
re_probe<span class="token operator">:</span>
    dev<span class="token operator">-&gt;</span>driver <span class="token operator">=</span> drv<span class="token punctuation">;</span>
    <span class="token comment">/* 如果使用了pinctrl，绑定引脚*/</span>
    ret <span class="token operator">=</span> <span class="token function">pinctrl_bind_pins</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> pinctrl_bind_failed<span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">dma_configure</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 配置DMA</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> probe_failed<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">driver_sysfs_add</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 添加驱动的sysfs</span>
        <span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"%s: driver_sysfs_add(%s) 失败\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">,</span> <span class="token function">dev_name</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> probe_failed<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果设备有电源管理域并且存在激活函数，激活电源管理域</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pm_domain <span class="token operator">&amp;&amp;</span> dev<span class="token operator">-&gt;</span>pm_domain<span class="token operator">-&gt;</span>activate<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        ret <span class="token operator">=</span> dev<span class="token operator">-&gt;</span>pm_domain<span class="token operator">-&gt;</span><span class="token function">activate</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> probe_failed<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>bus<span class="token operator">-&gt;</span>probe<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果总线有探测函数，调用总线的探测函数</span>
        ret <span class="token operator">=</span> dev<span class="token operator">-&gt;</span>bus<span class="token operator">-&gt;</span><span class="token function">probe</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> probe_failed<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>drv<span class="token operator">-&gt;</span>probe<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 否则调用驱动的探测函数</span>
        ret <span class="token operator">=</span> drv<span class="token operator">-&gt;</span><span class="token function">probe</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> probe_failed<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>test_remove<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果启用了驱动移除测试</span>
        test_remove <span class="token operator">=</span> false<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>bus<span class="token operator">-&gt;</span>remove<span class="token punctuation">)</span> <span class="token comment">// 如果总线有移除函数，调用总线的移除函数</span>
            dev<span class="token operator">-&gt;</span>bus<span class="token operator">-&gt;</span><span class="token function">remove</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>drv<span class="token operator">-&gt;</span>remove<span class="token punctuation">)</span> <span class="token comment">// 否则调用驱动的移除函数</span>
            drv<span class="token operator">-&gt;</span><span class="token function">remove</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">devres_release_all</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 释放设备的资源</span>
        <span class="token function">driver_sysfs_remove</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 移除驱动的sysfs</span>
        dev<span class="token operator">-&gt;</span>driver <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token function">dev_set_drvdata</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果设备有电源管理域并且存在解除函数，解除电源管理域</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pm_domain <span class="token operator">&amp;&amp;</span> dev<span class="token operator">-&gt;</span>pm_domain<span class="token operator">-&gt;</span>dismiss<span class="token punctuation">)</span> 
            dev<span class="token operator">-&gt;</span>pm_domain<span class="token operator">-&gt;</span><span class="token function">dismiss</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pm_runtime_reinit</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 重新初始化电源管理运行时</span>
        <span class="token keyword">goto</span> re_probe<span class="token punctuation">;</span> <span class="token comment">// 重新进行探测</span>
    <span class="token punctuation">}</span>

    <span class="token function">pinctrl_init_done</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 完成pinctrl 的初始化</span>

    <span class="token comment">// 如果设备有电源管理域并且存在同步函数，同步电源管理域</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pm_domain <span class="token operator">&amp;&amp;</span> dev<span class="token operator">-&gt;</span>pm_domain<span class="token operator">-&gt;</span>sync<span class="token punctuation">)</span> 
        dev<span class="token operator">-&gt;</span>pm_domain<span class="token operator">-&gt;</span><span class="token function">sync</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">driver_bound</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 驱动绑定成功</span>
    ret <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"bus: '%s': %s: %s: 将设备%s 绑定到驱动程序%s\n"</span><span class="token punctuation">,</span>drv<span class="token operator">-&gt;</span>bus<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span>
             <span class="token constant">__func__</span><span class="token punctuation">,</span> <span class="token function">dev_name</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">,</span> drv<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">goto</span> done<span class="token punctuation">;</span>
    
probe_failed<span class="token operator">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>bus<span class="token punctuation">)</span>
        <span class="token function">blocking_notifier_call_chain</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>bus<span class="token operator">-&gt;</span>p<span class="token operator">-&gt;</span>bus_notifier<span class="token punctuation">,</span>BUS_NOTIFY_DRIVER_NOT_BOUND<span class="token punctuation">,</span> dev<span class="token punctuation">)</span><span class="token punctuation">;</span>

pinctrl_bind_failed<span class="token operator">:</span>
    <span class="token function">device_links_no_driver</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将设备与驱动解除绑定</span>
    <span class="token function">devres_release_all</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 释放设备的资源</span>
    <span class="token function">dma_deconfigure</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 取消DMA 配置</span>
    <span class="token function">driver_sysfs_remove</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 移除驱动的sysfs</span>
    dev<span class="token operator">-&gt;</span>driver <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token function">dev_set_drvdata</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 如果设备有电源管理域并且存在解除函数，解除电源管理域</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pm_domain <span class="token operator">&amp;&amp;</span> dev<span class="token operator">-&gt;</span>pm_domain<span class="token operator">-&gt;</span>dismiss<span class="token punctuation">)</span> 
        dev<span class="token operator">-&gt;</span>pm_domain<span class="token operator">-&gt;</span><span class="token function">dismiss</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">pm_runtime_reinit</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 重新初始化电源管理运行时</span>
    <span class="token function">dev_pm_set_driver_flags</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置设备的驱动标志为0</span>
    
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token operator">-</span>EPROBE_DEFER<span class="token operator">:</span>
        <span class="token comment">/* 驱动程序请求延迟探测*/</span>
        <span class="token function">dev_dbg</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"Driver %s 请求延迟探测\n"</span><span class="token punctuation">,</span> drv<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">driver_deferred_probe_add_trigger</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> local_trigger_count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将设备添加到延迟探测触发列表</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token operator">-</span>ENODEV<span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token operator">-</span>ENXIO<span class="token operator">:</span>
        <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"%s: 对%s 的探测拒绝匹配%d\n"</span><span class="token punctuation">,</span>
        drv<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> <span class="token function">dev_name</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token comment">/* 驱动程序匹配但探测失败*/</span>
        <span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"%s: 对%s 的探测失败，错误码%d\n"</span><span class="token punctuation">,</span>drv<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> <span class="token function">dev_name</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/*
    * 忽略-&gt;probe 返回的错误，以便下一个驱动程序可以尝试运行。
    */</span>
    ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
done<span class="token operator">:</span>
    <span class="token function">atomic_dec</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>probe_count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 减少探测计数</span>
    <span class="token function">wake_up_all</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>probe_waitqueue<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 唤醒等待探测的进程</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>至此，probe 函数执行流程分析完毕。</p>
<h2 id="第110-章加载驱动和加载设备先后顺序分析实验"><a href="#第110-章加载驱动和加载设备先后顺序分析实验" class="headerlink" title="第110 章加载驱动和加载设备先后顺序分析实验"></a>第110 章加载驱动和加载设备先后顺序分析实验</h2><p>经过前面的实验章节，我们不管是先加载device.ko 还是driver.ko，驱动和设备都可以匹配成功。所以我们可以猜测不管是device 驱动还是driver 驱动，都会有匹配操作。<br>在drivers/base/core.c 文件中的device_ add 函数中调用了bus_ probe_ device 函数。如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409121048195.png" alt="image-20240912104812074"></p>
<p>bus_ probe_ device 函数，如下图所示，此函数中最重要的是device_initial_probe 函数</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409121048350.png" alt="image-20240912104825223"></p>
<p><code>device_initial_probe</code> 函数，如下所示</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409121048891.png" alt="image-20240912104838782"></p>
<p><code>__device_attach</code> 函数如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">__device_attach</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> bool allow_async<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">device_lock</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>p<span class="token operator">-&gt;</span>dead<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">goto</span> out_unlock<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>driver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果设备已经绑定了驱动程序，则返回1</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">device_is_bound</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ret <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> out_unlock<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 尝试将设备与驱动程序进行绑定</span>
        ret <span class="token operator">=</span> <span class="token function">device_bind_driver</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            ret <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 绑定失败，将设备的驱动程序指针置为NULL</span>
            dev<span class="token operator">-&gt;</span>driver <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> 
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果设备没有驱动程序，需要遍历总线上的驱动程序进行匹配</span>
        <span class="token keyword">struct</span> <span class="token class-name">device_attach_data</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span>dev <span class="token operator">=</span> dev<span class="token punctuation">,</span>
            <span class="token punctuation">.</span>check_async <span class="token operator">=</span> allow_async<span class="token punctuation">,</span>
            <span class="token punctuation">.</span>want_async <span class="token operator">=</span> false<span class="token punctuation">,</span>
    	<span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果设备有父设备，调用pm_runtime_get_sync() 增加父设备的引用计数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>parent<span class="token punctuation">)</span>
            <span class="token function">pm_runtime_get_sync</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 遍历总线上的驱动程序，调用__device_attach_driver() 进行匹配</span>
        ret <span class="token operator">=</span> <span class="token function">bus_for_each_drv</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>bus<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>data<span class="token punctuation">,</span>__device_attach_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ret <span class="token operator">&amp;&amp;</span> allow_async <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">.</span>have_async<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/*
            * 如果无法同步找到适合的驱动程序，并且允许异步探测以及有驱动程序要求异步探测，
            * 则尝试进行异步探测。
            */</span>
            <span class="token function">dev_dbg</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"scheduling asynchronous probe\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 增加设备的引用计数，以确保在异步探测期间设备不会被释放</span>
            <span class="token function">get_device</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 调度异步任务__device_attach_async_helper() 进行异步探测</span>
            <span class="token function">async_schedule</span><span class="token punctuation">(</span>__device_attach_async_helper<span class="token punctuation">,</span> dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果无法异步探测或者没有驱动程序要求异步探测，则调用pm_request_idle() 进入空闲状态</span>
            <span class="token function">pm_request_idle</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果设备有父设备，调用pm_runtime_put() 减少父设备的引用计数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>parent<span class="token punctuation">)</span>
            <span class="token function">pm_runtime_put</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    out_unlock<span class="token operator">:</span>
        <span class="token comment">// 解锁设备</span>
        <span class="token function">device_unlock</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>__device_attach</code> 函数的主要逻辑如下：<br>    首先，通过调用device_lock(dev) 锁定设备，确保在进行设备附加操作时不会被其他线程干扰。接下来，检查设备的状态。如果设备已经被标记为死亡，那么直接跳转到解锁设备的位置，并返回0。<br>    如果设备已经绑定了驱动程序，则返回1。如果设备没有绑定驱动程序，则尝试将设备与驱动程序进行绑定。如果绑定成功，返回1；否则，将设备的驱动程序指针置为NULL，并返回0。<br>    如果设备既没有绑定驱动程序，也没有被标记为死亡，那么需要遍历总线上的驱动程序进行匹配。为此，定义了一个结构体struct device_attach_data，其中包含了设备、是否允许异步探测以及是否有驱动程序要求异步探测的信息。<br>    如果设备有父设备，调用pm_runtime_get_sync(dev-&gt;parent) 增加父设备的引用计数。</p>
<p>​	调用<code>bus_for_each_drv(dev-&gt;bus, NULL, &amp;data, __device_attach_driver)</code> 遍历总线上的驱动程序，并调用<code>__device_attach_driver</code> 进行匹配。<code>__device_attach_driver</code> 是一个回调函数，用于判断驱动程序是否适配当前设备。<br>​	如果无法同步找到适合的驱动程序，并且允许异步探测以及有驱动程序要求异步探测，则调度异步任务<code>__device_attach_async_helper</code> 进行异步探测。在异步探测之前，会增加设备的引用计数以确保设备在异步探测期间不会被释放。异步探测会在后台进行，不会阻塞当前线程。<br>​	如果无法异步探测或者没有驱动程序要求异步探测，则调用pm_request_idle(dev) 进入空闲状态，让设备进入省电模式。</p>
<p>在上述函数中，使用device_bind_driver 函数将设备与驱动程序进行绑定，如下所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409121102401.png" alt="image-20240912110216279"></p>
<p><code>driver_bound</code> 函数如下所示，用于将驱动程序绑定到设备上。</p>
<pre class="line-numbers language-none"><code class="language-none">static void driver_bound(struct device *dev)
{
if (device_is_bound(dev)) {
// 如果设备已经绑定了驱动程序，则输出警告信息并返回
printk(KERN_WARNING "%s: device %s already bound\n",
__func__, kobject_name(&amp;dev-&gt;kobj));
return;
}
// 输出绑定信息
pr_debug("driver: '%s': %s: bound to device '%s'\n", dev-&gt;driver-&gt;name,
__func__, dev_name(dev));
// 将设备添加到驱动程序的设备链表中
klist_add_tail(&amp;dev-&gt;p-&gt;knode_driver, &amp;dev-&gt;driver-&gt;p-&gt;klist_devices);
// 更新设备的驱动程序链接状态
device_links_driver_bound(dev);
// 检查设备的电源管理回调函数
device_pm_check_callbacks(dev);
/*
* 确保设备不再位于延迟探测列表中，并启动重试所有待处理设备
*/
driver_deferred_probe_del(dev);
driver_deferred_probe_trigger();
// 如果设备有总线，调用总线通知链进行通知
if (dev-&gt;bus)
blocking_notifier_call_chain(&amp;dev-&gt;bus-&gt;p-&gt;bus_notifier,
BUS_NOTIFY_BOUND_DRIVER, dev);
// 发送内核对象事件通知
kobject_uevent(&amp;dev-&gt;kobj, KOBJ_BIND);
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上述代码的作用是将驱动和设备进行绑定，首先，通过调用<code>device_is_bound(dev)</code> 检查设备是否已经绑定了驱动程序。如果设备已经绑定了驱动程序，则输出警告信息并返回。如果设备未绑定驱动程序，将输出绑定信息，其中包括驱动程序的名称、函数名和设备的名称。接下来，通过调用<code>klist_add_tail()</code> 将设备添加到驱动程序的设备链表中。这样，驱动程序可以通过遍历该链表来访问所有已绑定的设备。</p>
<p>然后，调用<code>device_links_driver_bound()</code> 更新设备的驱动程序链接状态。这个函数会确保设备和驱动程序之间的链接关系是正确的。</p>
<p>至此，加载驱动和加载设备先后顺序分析完毕。</p>
<h2 id="第111-章platform-总线注册驱动流程实例分析实验"><a href="#第111-章platform-总线注册驱动流程实例分析实验" class="headerlink" title="第111 章platform 总线注册驱动流程实例分析实验"></a>第111 章platform 总线注册驱动流程实例分析实验</h2><p>本章节我们来分析驱动是如何注册到platform 平台总线上的。在52 章中，我们编写了平台总线驱动。在驱动中使用<code>platform_driver_register</code> 函数进行平台驱动注册。</p>
<p><code>platform_driver_register</code> 函数实现如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">platform_driver_register</span><span class="token expression"><span class="token punctuation">(</span>drv<span class="token punctuation">)</span> <span class="token function">__platform_driver_register</span><span class="token punctuation">(</span>drv<span class="token punctuation">,</span> THIS_MODULE<span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><code>__platform_driver_register</code> 函数实现如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">__platform_driver_register</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_driver</span> <span class="token operator">*</span>drv<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>owner<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    drv<span class="token operator">-&gt;</span>driver<span class="token punctuation">.</span>owner <span class="token operator">=</span> owner<span class="token punctuation">;</span>
    drv<span class="token operator">-&gt;</span>driver<span class="token punctuation">.</span>bus <span class="token operator">=</span> <span class="token operator">&amp;</span>platform_bus_type<span class="token punctuation">;</span>
    drv<span class="token operator">-&gt;</span>driver<span class="token punctuation">.</span>probe <span class="token operator">=</span> platform_drv_probe<span class="token punctuation">;</span>
    drv<span class="token operator">-&gt;</span>driver<span class="token punctuation">.</span>remove <span class="token operator">=</span> platform_drv_remove<span class="token punctuation">;</span>
    drv<span class="token operator">-&gt;</span>driver<span class="token punctuation">.</span>shutdown <span class="token operator">=</span> platform_drv_shutdown<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">driver_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>drv<span class="token operator">-&gt;</span>driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这是Linux 内核中用于注册平台驱动程序的函数<code>__platform_driver_register</code> 的代码片段。该函数用于完成平台驱动程序的注册，并将其与平台总线类型进行关联。<br>下面是对代码片段的解释：</p>
<ol>
<li><code>drv-&gt;driver.owner = owner;</code> 此行将指定的owner 参数赋值给<code>drv-&gt;driver.owner</code>，表示驱动程序的所有者模块。</li>
<li><code>drv-&gt;driver.bus = &amp;platform_bus_type;</code>此行将指向平台总线类型的指针<code>&amp;platform_bus_type</code> 赋值给<code>drv-&gt;driver.bus</code>，将驱动程序与平台总线进行关联。</li>
<li><code>drv-&gt;driver.probe = platform_drv_probe;</code> 此行将指定的<code>platform_drv_probe</code> 函数赋值给<code>drv-&gt;driver.probe</code>，表示驱动程序的探测函数。</li>
<li><code>drv-&gt;driver.remove = platform_drv_remove;</code>此行将指定的<code>platform_drv_remove</code> 函数赋值给<code>drv-&gt;driver.remove</code>，表示驱动程序的移除函数。</li>
<li><code>drv-&gt;driver.shutdown = platform_drv_shutdown;</code>此行将指定的<code>platform_drv_shutdown</code> 函数赋值给drv-&gt;driver.shutdown，表示驱动程序的关机函数。</li>
<li><code>return driver_register(&amp;drv-&gt;driver);</code>此行调用<code>driver_register</code> 函数，将驱动程序的struct driver结构体作为参数进行注册。<code>driver_register</code> 函数会将驱动程序添加到内核的驱动程序列表中，并进行相应的初始化。</li>
</ol>
<p><code>driver_register</code> 函数在之前的章节已经学习过了，所以接下来我们重点看看platform 总线的probe 函数是如何执行的。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">platform_drv_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>_dev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 将传递给驱动程序的设备指针转换为platform_driver 结构体指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">platform_driver</span> <span class="token operator">*</span>drv <span class="token operator">=</span> <span class="token function">to_platform_driver</span><span class="token punctuation">(</span>_dev<span class="token operator">-&gt;</span>driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 将传递给驱动程序的设备指针转换为platform_device 结构体指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>dev <span class="token operator">=</span> <span class="token function">to_platform_device</span><span class="token punctuation">(</span>_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token comment">// 设置设备节点的默认时钟属性</span>
    ret <span class="token operator">=</span> <span class="token function">of_clk_set_defaults</span><span class="token punctuation">(</span>_dev<span class="token operator">-&gt;</span>of_node<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    
    <span class="token comment">// 将设备附加到电源域</span>
    ret <span class="token operator">=</span> <span class="token function">dev_pm_domain_attach</span><span class="token punctuation">(</span>_dev<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
    
    <span class="token comment">// 调用驱动程序的探测函数（probe）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>drv<span class="token operator">-&gt;</span>probe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ret <span class="token operator">=</span> drv<span class="token operator">-&gt;</span><span class="token function">probe</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
            <span class="token function">dev_pm_domain_detach</span><span class="token punctuation">(</span>_dev<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
out<span class="token operator">:</span>
    <span class="token comment">// 处理探测延迟和错误情况</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>drv<span class="token operator">-&gt;</span>prevent_deferred_probe <span class="token operator">&amp;&amp;</span> ret <span class="token operator">==</span> <span class="token operator">-</span>EPROBE_DEFER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dev_warn</span><span class="token punctuation">(</span>_dev<span class="token punctuation">,</span> <span class="token string">"probe deferral not supported\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token operator">-</span>ENXIO<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该函数的主要逻辑如下：</p>
<ul>
<li>1 首先，将传递给驱动程序的设备指针<code>_dev</code> 转换为<code>platform_driver</code> 结构体指针<code>drv</code>，将传递给驱动程序的设备指针_dev 转换为<code>platform_device</code> 结构体指针dev。</li>
<li>2 使用<code>of_clk_set_defaults()</code> 函数设置设备节点的默认时钟属性。这个函数会根据设备节点的属性信息配置设备的时钟。</li>
<li>3 调用<code>dev_pm_domain_attach()</code> 将设备附加到电源域。这个函数会根据设备的电源管理需求，将设备与相应的电源域进行关联。</li>
<li>4 如果驱动程序的probe 函数存在，调用它来执行设备的探测操作。<code>drv-&gt;probe(dev)</code> 表示调用驱动程序的probe 函数，并传递<code>platform_device</code> 结构体指针dev 作为参数。如果探测失败，会调用<code>dev_pm_domain_detach()</code> 分离设备的电源域。</li>
<li>5 处理探测延迟和错误情况。如果驱动程序设置了<code>prevent_deferred_probe</code> 标志，并且返回值为<code>-EPROBE_DEFER</code> ， 则表示探测被延迟。在这种情况下如果驱动程序设置了<code>prevent_deferred_probe</code> 标志，并且返回值为<code>-EPROBE_DEFER</code>，则表示探测被延迟。在这种情况下，代码会打印一个警告信息probe deferral not supported，并将返回值设置为<code>-ENXIO</code>，表示设备不存在。</li>
</ul>
<p>总体而言，该函数的作用是执行平台驱动程序的探测操作，在设备上调用驱动程序的probe 函数，并处理探测延迟和错误情况。</p>
<p>到此，platform 总线注册驱动实验分析完毕。</p>
<h1 id="第十篇热插拔"><a href="#第十篇热插拔" class="headerlink" title="第十篇热插拔"></a>第十篇热插拔</h1><h2 id="第112-章热插拔简介"><a href="#第112-章热插拔简介" class="headerlink" title="第112 章热插拔简介"></a>第112 章热插拔简介</h2><h3 id="112-1-什么是热插拔"><a href="#112-1-什么是热插拔" class="headerlink" title="112.1 什么是热插拔"></a>112.1 什么是热插拔</h3><p>热插拔是指在设备运行的情况下，能够安全地插入或拔出硬件设备，而无需关闭或重启系统。这意味着你可以在计算机或其他电子设备上插入或拔出硬件组件（比如USB 设备，扩展卡，硬件驱动器等），而无需关机或中断正在进行的操作。</p>
<p>热插拔的主要目的是提供方便性和灵活性。通过热插拔，你可以快速更换或添加硬件设备，而无需停止正在进行的任务。这在许多场景下非常有用，比如</p>
<ul>
<li>1 USB 设备：你可以随时插入或拔出USB 设备，比如鼠标，键盘，打印机，存储设备等，而无需重新启动系统。</li>
<li>2 硬盘驱动器：在某些服务器或存储系统中，你可以在运行时添加或替换硬盘驱动器，以扩展存储容量或替换故障驱动器。</li>
<li>3 扩展卡：你可以在计算机上插入或拔出显卡，网卡或声卡等扩展卡，以满足不同的需求或升级硬件性能。</li>
</ul>
<p>为了支持热插拔功能，硬件设备和系统必须具备相应的支持。硬件方面，设备接口必须设计成可以插入和拔出而不会损坏设备或系统。系统需要提供相应的驱动程序和管理功能，以便在插入和拔出设备时进行正确的配置和识别。</p>
<h3 id="112-2-热插拔的机制"><a href="#112-2-热插拔的机制" class="headerlink" title="112.2 热插拔的机制"></a>112.2 热插拔的机制</h3><p>热插拔是内核和用户空间之间，通过调用用户空间程序（如hotplug、udev 和mdev）的交互。当需要通知用户内核发生了某种热插拔事件时，内核才调用这个用户空间程序来实现交互。</p>
<p>在Linux 内核中，热插拔机制支持USB 设备、PCI 设备甚至CPU 等部件的动态插入和拔出。这个机制实现了底层硬件、内核空间和用户空间程序之间的连接，并且一直在不断演变和改进。设备文件系统是用来管理设备文件的一种机制，在Linux 中有三种常见的设备文件系统：<code>devfs、mdev 和udev</code>。</p>
<ul>
<li>**<code>devfs：</code>**devfs 是基于内核的动态设备文件系统，最早出现在Linux 2.3.46 内核中。它通过动态创建和管理设备节点的方式来处理设备文件。然而，devfs 存在一些限制和性能问题，从Linux 2.6.13 版本开始被移除。</li>
<li>**<code>mdev：</code>**mdev 是一个轻量级的热插拔设备文件系统，通常用于嵌入式Linux 系统。它是udev的简化版本，使用uevent_helper 机制来处理设备的插入和拔出事件。mdev 在设备插入时调用相应的用户程序来创建设备节点。</li>
<li>**<code>udev：</code>**udev 是目前在PC 机上广泛使用的热插拔设备文件系统。它基于netlink 机制，监听内核发送的uevent 来处理设备的插入和拔出。udev 能够动态创建和管理设备节点，并在设备插入时加载适当的驱动程序。它提供了丰富的配置选项，使用户能够灵活地管理设备文件。</li>
</ul>
<p>这些设备文件系统在Linux 中扮演着重要的角色，它们负责管理设备文件，使得用户空间程序可以方便地与底层硬件进行交互。<strong>udev 是目前应用最广泛的设备文件系统，而mdev 主要用于嵌入式系统中，提供了轻量级的设备管理功能。</strong></p>
<h2 id="第113-章内核是如何发送事件到用户空间"><a href="#第113-章内核是如何发送事件到用户空间" class="headerlink" title="第113 章内核是如何发送事件到用户空间"></a>第113 章内核是如何发送事件到用户空间</h2><h3 id="113-1-相关接口函数"><a href="#113-1-相关接口函数" class="headerlink" title="113.1 相关接口函数"></a>113.1 相关接口函数</h3><p><code>kobject_uevent</code> 是Linux 内核中的一个函数，用于生成和发送<code>uevent</code> 事件。它是udev 和其他设备管理工具与内核通信的一种方式。<br><code>kobject_uevent</code> 函数的原型如下所示：</p>
<p>参数说明：<br>    <strong>kobj :</strong> 要发送uevent 事件的内核对象（kobject）<br>    action: 表示触发uevent 的动作，可以是设备的插入，拔出，属性变化等。以下是一些常见的action 参数值。这些动作类型用于描述设备发生的不同事件，通过将相应的动作类型作为action 参数传递给kobject_uevent 函数，可以触发相应的uevent 事件，通知用户空间的udev进行相应的操作。</p>
<ul>
<li><strong>KOBJ_ADD：</strong>表示设备的添加或插入操作，表示添加一个对象到内核对象系统中。</li>
<li><strong>KOBJ_REMOVE</strong>：表示设备的移除或拔出操作，表示从内核对象系统中删除一个对象。</li>
<li><strong>KOBJ_CHANGE</strong>：表示设备属性的修改操作，表示对内核对象进行更改，例如属性修改等。</li>
<li><strong>KOBJ_MOVE</strong>：表示设备的移动操作，即设备从一个位置移动到另一个位置。</li>
<li><strong>KOBJ_ONLINE</strong>：表示设备的上线操作，即设备从离线状态变为在线状态，使其可以被访问。</li>
<li><strong>KOBJ_OFFLINE</strong>：表示设备的离线操作，即设备从在线状态变为离线状态，使其不可以被访问。</li>
<li><strong>KOBJ_BIND</strong>：表示将一个设备连接到内核对象上</li>
<li><strong>KOBJ_UNBIND</strong>: 表示从内核对象上将一个设备解绑</li>
<li><strong>KOBJ_MAX</strong>:表示枚举类型的最大值，通常用于表示没有任何操作行为。</li>
</ul>
<p><code>kobject_uevent</code> 函数的主要作用是在内核中生成<code>uevent</code> 事件，并通过<code>netlink</code> 机制将该事件发送给用户空间的<code>udev</code>。在调用该函数时，内核会将相关的设备信息和事件类型封装为uevent消息，并通过<code>netlink</code> 套接字将消息发送给用户空间。</p>
<p>用户空间的<code>udev</code> 会接收到这些<code>uevent</code> 消息，并根据消息中的设备信息和事件类型来执行相应的操作，例如创建或删除设备节点，加载或卸载驱动程序等。</p>
<h3 id="113-2-udevadm-命令"><a href="#113-2-udevadm-命令" class="headerlink" title="113.2 udevadm 命令"></a>113.2 udevadm 命令</h3><p><code>udevadm</code> 是一个用于与<code>udev</code> 设备管理器进行交互的命令行工具。它提供了一系列的子命令，用于查询和管理设备、触发<code>uevent</code> 事件以及执行其他与<code>udev</code> 相关的操作。一些常见的<code>udevadm</code> 子命令及其功能如下：</p>
<ul>
<li>1 udevadm info：用于获取设备的详细信息，包括设备路径、属性、驱动程序等。</li>
<li>2 udevadm monitor：用于监视和显示当前系统中的uevent 事件。它会实时显示设备的插入、拔出以及其他相关事件。</li>
<li>3 udevadm trigger：用于手动触发设备的uevent 事件。可以使用该命令模拟设备的插入、拔出等操作，以便触发相应的事件处理。</li>
<li>4 udevadm settle：用于等待udev 处理所有已排队的uevent 事件。它会阻塞直到udev 完成当前所有的设备处理操作。</li>
<li>5 udevadm control：用于与udev 守护进程进行交互，控制其行为。例如，可以使用该命令重新加载udev 规则、设置日志级别等。</li>
<li>6 udevadm test：用于测试udev 规则的匹配和执行过程。可以通过该命令测试特定设备是否能够正确触发相应的规则。</li>
</ul>
<p>这些是一些常见的udevadm 子命令，它们提供了与udev 设备管理器交互的便捷方式，用于设备信息查询、事件监控、事件触发、规则测试等操作。通过使用udevadm 工具，用户可以更好地理解和管理Linux 系统中的设备和udev 机制。</p>
<p>在iTOP-RK3568 开发板上烧写<code>buildroot</code> 系统，输入“<code>udevadm monitor &amp;</code>”可以监视和显示当前系统中的uevent 事件，在之后的实验中，我们要使用这个方法。如下（图113-1）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409121134699.png" alt="image-20240912113438585"></p>
<h3 id="113-3-实验程序的编写"><a href="#113-3-实验程序的编写" class="headerlink" title="113.3 实验程序的编写"></a>113.3 实验程序的编写</h3><p>本实验对应的网盘路径为：<code>iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\78_uevent\module</code>。<br>编写完成的uevent.c 代码如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/configfs.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kobject.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>mykobject01<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">kset</span> <span class="token operator">*</span>mykset<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">kobj_type</span> mytype<span class="token punctuation">;</span>

<span class="token comment">// 模块的初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">mykobj_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    <span class="token comment">// 创建并添加一个kset</span>
    mykset <span class="token operator">=</span> <span class="token function">kset_create_and_add</span><span class="token punctuation">(</span><span class="token string">"mykset"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 分配并初始化一个kobject</span>
    mykobject01 <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mykobject01<span class="token operator">-&gt;</span>kset <span class="token operator">=</span> mykset<span class="token punctuation">;</span>

    <span class="token comment">// 初始化并添加kobject到kset</span>
    ret <span class="token operator">=</span> <span class="token function">kobject_init_and_add</span><span class="token punctuation">(</span>mykobject01<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mytype<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"mykobject01"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 触发一个uevent事件，表示kobject的属性发生了变化</span>
    ret <span class="token operator">=</span> <span class="token function">kobject_uevent</span><span class="token punctuation">(</span>mykobject01<span class="token punctuation">,</span> KOBJ_CHANGE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 模块退出函数</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">mykobj_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 释放kobject</span>
    <span class="token function">kobject_put</span><span class="token punctuation">(</span>mykobject01<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">kset_unregister</span><span class="token punctuation">(</span>mykset<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>mykobj_init<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 指定模块的初始化函数</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>mykobj_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 指定模块的退出函数</span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 模块使用的许可证</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"topeet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 模块的作者</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="113-4-运行测试"><a href="#113-4-运行测试" class="headerlink" title="113.4 运行测试"></a>113.4 运行测试</h3><h4 id="113-4-1-编译驱动程序"><a href="#113-4-1-编译驱动程序" class="headerlink" title="113.4.1 编译驱动程序"></a>113.4.1 编译驱动程序</h4><p>在上一小节中的uevent.c 代码同一目录下创建Makefile 文件，Makefile 文件内容如下所示：然后使用命令“make”进行驱动的编译，编译完生成uevent.ko 目标文件，至此驱动模块就编译成功了，接下来进行测试。</p>
<h4 id="113-3-2-运行测试"><a href="#113-3-2-运行测试" class="headerlink" title="113.3.2 运行测试"></a>113.3.2 运行测试</h4><p>开发板启动之后，使用命令“<code>udevadm monitor &amp;</code>”监视和显示当前系统中的uevent 事件。然后使用以下命令进行驱动模块的加载，如下图（图113-5）所示：</p>
<pre class="line-numbers language-none"><code class="language-none">insmod uevent.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409121146887.png" alt="image-20240912114615760"></p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409121146620.png" alt="image-20240912114624496"></p>
<p>驱动加载之后，如上图所示udev 接收到change 动作，说明uevent 事件已经发送成功了。<code>/mykset/mykobject01</code> 是kobject 在根目录/sys/下的路径。<br>最后可以使用以下命令进行驱动的卸载，如下图（图113-7）所示：</p>
<pre class="line-numbers language-none"><code class="language-none">rmmod uevent<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409121147908.png" alt="image-20240912114758787"></p>
<p>至此，发送事件到用户空间实验就完成了。</p>
<h2 id="第114-章内核发送事件到用户空间的方法"><a href="#第114-章内核发送事件到用户空间的方法" class="headerlink" title="第114 章内核发送事件到用户空间的方法"></a>第114 章内核发送事件到用户空间的方法</h2><p>在前一章节中，我们成功地通过uevent 机制将内核事件发送到用户空间。然而，本章节我们尝试在实验中去掉了创建kset 的步骤，并发现用户空间无法收到事件。在分析这个问题之前，让我们回顾一下前一章节中的实验。</p>
<h3 id="114-1-实验现象"><a href="#114-1-实验现象" class="headerlink" title="114.1 实验现象"></a>114.1 实验现象</h3><p>在前一章节的代码示例中，我们演示了如何在内核中创建kset 和kobject，并将其添加到sysfs 文件系统中。这样做的目的是为了在sysfs 中创建相应的目录结构，以便用户空间能够找到正确的sysfs 路径来监听事件或访问设备属性。然而，当我们去掉了创建kset 的步骤后，用户空间无法收到事件。这是因为没有正确的sysfs 路径供用户空间监听事件。</p>
<p>上个章节的驱动代码修改如下图（图114-1）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409121152746.png" alt="image-20240912115216594"></p>
<p>编译之后，加载驱动程序，如下图（图114-2）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409121152454.png" alt="image-20240912115241329"></p>
<p>为了解决这个问题，我们需要在代码层面确保正确创建kset 和kobject，并将其添加到sysfs文件系统中。这样，用户空间才能够通过sysfs 路径找到相应的事件或属性文件。在接下来的部分，我们将通过代码分析来解释为什么没有创建kset 会导致用户空间无法接收事件。</p>
<h3 id="114-2-代码分析"><a href="#114-2-代码分析" class="headerlink" title="114.2 代码分析"></a>114.2 代码分析</h3><p>在上一小节的实验中，为什么没有创建kset 会导致用户空间无法接收事件呢？要搞清楚这个问题，我们可以追踪下kobject_uevent 函数。如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/**
* kobject_uevent - notify userspace by sending an uevent
*
* @kobj: struct kobject that the action is happening to
* @action: action that is happening
*
* Returns 0 if kobject_uevent() is completed with success or the
* corresponding error when it fails.
*/</span>
<span class="token keyword">int</span> <span class="token function">kobject_uevent</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">,</span> <span class="token keyword">enum</span> <span class="token class-name">kobject_action</span> action<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">kobject_uevent_env</span><span class="token punctuation">(</span>kobj<span class="token punctuation">,</span> action<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">EXPORT_SYMBOL_GPL</span><span class="token punctuation">(</span>kobject_uevent<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在上述代码中，可以看出<code>kobject_uevent()</code>函数是用于通知用户空间的，它通过发送<code>uevent</code>来实现。该函数接受俩个参数：</p>
<ul>
<li><code>kobject</code> 表示发生操作的<code>struct kobject</code> 对象，</li>
<li><code>action</code> 表示正在发生的操作。在这个函数中调用了<code>kobject_uevent_env()</code>函数，并将其返回值作为自己的返回值。这说明<code>kobject_uevent()</code>函数实际上是一个简化的接口，它将<code>kobject_uevent_env()</code>函数的调用参数设置为NULL，并返回相同的结果。</li>
</ul>
<p><code>kobject_uevent_env</code> 函数代码比较多，接下来我们拆分为几个部分给大家讲解下。</p>
<p>第一部分，如下所示：</p>
<ul>
<li><p>```c<br>/**</p>
<ul>
<li>kobject_uevent_env - send an uevent with environmental data //发送带有环境变量数据的事件<ul>
<li></li>
</ul>
</li>
<li>@kobj: struct kobject that the action is happening to //正在发生动作的对象</li>
<li>@action: action that is happening //正在发生的动作</li>
<li>@envp_ext: pointer to environmental data //环境变量的指针<ul>
<li></li>
</ul>
</li>
<li>Returns 0 if kobject_uevent_env() is completed with success or the</li>
<li>corresponding error when it fails.<br>*/<pre class="line-numbers language-none"><code class="language-none">


第二部分如下所示：

```c
int kobject_uevent_env(struct kobject *kobj, enum kobject_action action,
char *envp_ext[])
{
    struct kobj_uevent_env *env; //指向kobj_uevent_env 结构体的指针，用于存储发送的事件和环境变量
    const char *action_string = kobject_actions[action]; //事件的类型
    const char *devpath = NULL;//存放kobject 的路径
    const char *subsystem; //存放所属子系统的名称
    struct kobject *top_kobj; //指向顶层top_kobj 的kobject 指针
    struct kset *kset; //指向kset 的指针，表示kobject 所属的kset
    const struct kset_uevent_ops *uevent_ops; //指向struct kset_uevent_ops 结构体的指针
    int i = 0; //计数器i,用来编译环境变量数组
    int retval = 0 //表示函数的执行结果，也就是返回值<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<p>第三部分如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">==</span> KOBJ_REMOVE<span class="token punctuation">)</span>
    kobj<span class="token operator">-&gt;</span>state_remove_uevent_sent <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"kobject: '%s' (%p): %s\n"</span><span class="token punctuation">,</span><span class="token function">kobject_name</span><span class="token punctuation">(</span>kobj<span class="token punctuation">)</span><span class="token punctuation">,</span> kobj<span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* search the kset we belong to */</span>
top_kobj <span class="token operator">=</span> kobj<span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>top_kobj<span class="token operator">-&gt;</span>kset <span class="token operator">&amp;&amp;</span> top_kobj<span class="token operator">-&gt;</span>parent<span class="token punctuation">)</span>
    top_kobj <span class="token operator">=</span> top_kobj<span class="token operator">-&gt;</span>parent<span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>top_kobj<span class="token operator">-&gt;</span>kset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"kobject: '%s' (%p): %s: attempted to send uevent without kset!\n"</span><span class="token punctuation">,</span> 
             <span class="token function">kobject_name</span><span class="token punctuation">(</span>kobj<span class="token punctuation">)</span><span class="token punctuation">,</span> kobj<span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
kset <span class="token operator">=</span> top_kobj<span class="token operator">-&gt;</span>kset<span class="token punctuation">;</span>
uevent_ops <span class="token operator">=</span> kset<span class="token operator">-&gt;</span>uevent_ops<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>以上代码中， 首先检查action 是否为KOBJ_REMOVE ， 如果是， 则设置kobj-&gt;state_remove_uevent_sent 为1，表示“remove”事件已发送。</p>
<p>接下来通过调用pr_debug()函数输出调试信息，显示相关的kobject 名称和指针以及当前函数名称。</p>
<p>然后，通过循环查找kobj 所属的kset,直到找到具体有效kset 的顶层kobj，即kset 的根节点。这是通过沿着kobj 的父对象链向上遍历实现的，如果找不到有效的kset,则输出调试信息，并返回-EINVAL 表示发送uevent 失败。</p>
<p>这个过程的目的是为了确定当前kobj 所属的kset,以便后面的uevent 发送能够正确地通知用户空间的应用程序。因为uevent 是通过netlink socket 发送给用户空间的应用程序的，而netlink socket 是基于kset 的。</p>
<p>最后，将找到的kset 赋值给变量kset,并将其uevent_ops 字段赋值给变量uevent_ops，以便后续使用。</p>
<p>第四部分如下所示:</p>
</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* skip the event, if uevent_suppress is set*/</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>kobj<span class="token operator">-&gt;</span>uevent_suppress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"kobject: '%s' (%p): %s: uevent_suppress caused the event to drop!\n"</span><span class="token punctuation">,</span>
             <span class="token function">kobject_name</span><span class="token punctuation">(</span>kobj<span class="token punctuation">)</span><span class="token punctuation">,</span> kobj<span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在上面的代码中， 首先检查kobj-&gt;uevent_suppress 是否为1 ， 如果设置kobj-&gt;uevent_suppress，则输出调试信息表示该事件被跳过，并返回0 表示成功。</p>
<p>第五部分如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* skip the event, if uevent_suppress is set*/</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>kobj<span class="token operator">-&gt;</span>uevent_suppress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"kobject: '%s' (%p): %s: uevent_suppress caused the event to drop!\n"</span><span class="token punctuation">,</span>
             <span class="token function">kobject_name</span><span class="token punctuation">(</span>kobj<span class="token punctuation">)</span><span class="token punctuation">,</span> kobj<span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* skip the event, if the filter returns zero. */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>uevent_ops <span class="token operator">&amp;&amp;</span> uevent_ops<span class="token operator">-&gt;</span>filter<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>uevent_ops<span class="token operator">-&gt;</span><span class="token function">filter</span><span class="token punctuation">(</span>kset<span class="token punctuation">,</span> kobj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"kobject: '%s' (%p): %s: filter function caused the event to drop!\n"</span><span class="token punctuation">,</span>
                 <span class="token function">kobject_name</span><span class="token punctuation">(</span>kobj<span class="token punctuation">)</span><span class="token punctuation">,</span> kobj<span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token comment">/* originating subsystem */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>uevent_ops <span class="token operator">&amp;&amp;</span> uevent_ops<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span>
    subsystem <span class="token operator">=</span> uevent_ops<span class="token operator">-&gt;</span><span class="token function">name</span><span class="token punctuation">(</span>kset<span class="token punctuation">,</span> kobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">else</span>
    subsystem <span class="token operator">=</span> <span class="token function">kobject_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kset<span class="token operator">-&gt;</span>kobj<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>subsystem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"kobject: '%s' (%p): %s: unset subsystem caused the event to drop!\n"</span><span class="token punctuation">,</span> 
             <span class="token function">kobject_name</span><span class="token punctuation">(</span>kobj<span class="token punctuation">)</span><span class="token punctuation">,</span> kobj<span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在上面的代码中，检查uevent_ops 是否存在，并且uevent_ops-&gt;filter 是否存在。如果两者都存在，并且调用uevent_ops-&gt;filter(kset, kobj)，返回值为0，则表示过滤器函数导致该事件被跳过。输出相应的调试信息，并返回0 表示成功。</p>
<p>然后，根据uevent_ops 中的name 字段获取原始子系统的名称。如果uevent_ops-&gt;name 存在，则调用uevent_ops-&gt;name(kset, kobj)函数获取子系统名称，否则使用kset 的名称作为子系统名称。如果无法获取子系统名称，输出调试信息，并返回0 表示成功。</p>
<p>综上所述，这部分代码主要用于检查是否应该跳过发送uevent 的条件，如uevent_suppress标志、过滤器函数的返回结果以及获取原始子系统名称。如果满足这些条件，则该事件将被跳过，并返回0 表示成功。</p>
<p>第六部分，如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ENABLED</span><span class="token punctuation">(</span>CONFIG_ARCH_ROCKCHIP<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span><span class="token function">IS_ENABLED</span><span class="token punctuation">(</span>CONFIG_FREEZER<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span><span class="token function">IS_ENABLED</span><span class="token punctuation">(</span>CONFIG_ANDROID<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/*
    * Android healthd try to listen power_supply subsystem uevent,
    * but which will block system from suspend on big.LITTLE system
    * because thermal_cooling_device_unregister will called when
    * cpufreq_exit. So ignore this uevent when suspend.
    */</span>
    <span class="token keyword">extern</span> bool pm_freezing<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pm_freezing <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>subsystem<span class="token punctuation">,</span> <span class="token string">"thermal"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面的代码是一个条件判断，用于特定条件下跳过发送uevent 的操作，它首先使用IS_ENABLED()宏进行编译时配置的条件判断，检查是否启用了CONFIG_ARCH_ROCKCHIP、CONFIG_FREEZER 和CONFIG_ANDROID 配置选项。如果这三个选项都启用了，那么代码将进入条件块部分。内部的注释解释了为什么需要跳过发送uevent 的操作。在big.LITTLE 系统上，当cpufreq_exit 函数被调用时，thermal_cooling_device_unregister 函数也会被调用，这可能会导致系统挂起失败，为了避免这种情况，该函数忽略了thermal 子系统的uevent 事件。</p>
<p>代码中使用了一个外部变量pm_freezing，如果pm_freezing 为真（即系统正在进入挂起状态），并且子系统名称与”thermal”相同时，将返回0 表示跳过发送uevent 的操作。</p>
<p>第七部分，如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* environment buffer */</span>
env <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobj_uevent_env</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>env<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>

<span class="token comment">/* complete object path */</span>
devpath <span class="token operator">=</span> <span class="token function">kobject_get_path</span><span class="token punctuation">(</span>kobj<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>devpath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    retval <span class="token operator">=</span> <span class="token operator">-</span>ENOENT<span class="token punctuation">;</span>
    <span class="token keyword">goto</span> exit<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* default keys */</span>
retval <span class="token operator">=</span> <span class="token function">add_uevent_var</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"ACTION=%s"</span><span class="token punctuation">,</span> action_string<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>retval<span class="token punctuation">)</span>
    <span class="token keyword">goto</span> exit<span class="token punctuation">;</span>
retval <span class="token operator">=</span> <span class="token function">add_uevent_var</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"DEVPATH=%s"</span><span class="token punctuation">,</span> devpath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>retval<span class="token punctuation">)</span>
    <span class="token keyword">goto</span> exit<span class="token punctuation">;</span>
retval <span class="token operator">=</span> <span class="token function">add_uevent_var</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"SUBSYSTEM=%s"</span><span class="token punctuation">,</span> subsystem<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>retval<span class="token punctuation">)</span>
    <span class="token keyword">goto</span> exit<span class="token punctuation">;</span>

<span class="token comment">/* keys passed in from the caller */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>envp_ext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> envp_ext<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        retval <span class="token operator">=</span> <span class="token function">add_uevent_var</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> envp_ext<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>retval<span class="token punctuation">)</span>
            <span class="token keyword">goto</span> exit<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/* let the kset specific function add its stuff */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>uevent_ops <span class="token operator">&amp;&amp;</span> uevent_ops<span class="token operator">-&gt;</span>uevent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    retval <span class="token operator">=</span> uevent_ops<span class="token operator">-&gt;</span><span class="token function">uevent</span><span class="token punctuation">(</span>kset<span class="token punctuation">,</span> kobj<span class="token punctuation">,</span> env<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>retval<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"kobject: '%s' (%p): %s: uevent() returned %d\n"</span><span class="token punctuation">,</span> <span class="token function">kobject_name</span><span class="token punctuation">(</span>kobj<span class="token punctuation">)</span><span class="token punctuation">,</span> kobj<span class="token punctuation">,</span>
                 <span class="token constant">__func__</span><span class="token punctuation">,</span> retval<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面代码中，首先，它分配了一个kobj_uevent_env 结构体的内存空间，并检查是否成功分配。然后，它获取了kobj 对象所在的路径，并检查是否成功获取。接下来，它添加了一些默认的键值对到环境变量中，包括ACTION、DEVPATH 和SUBSYSTEM。最后，如果有额外的键值对传入，则将其也添加到环境变量中。循环的终止条件是envp_ext[i] 为空指针。</p>
<p>接下来它首先检查uevent_ops 和uevent_ops-&gt;uevent 是否存在。如果存在，则调用uevent_ops-&gt;uevent 函数，并传递kset、kobj 和env 作为参数。如果uevent_ops-&gt;uevent 返回非零值（表示出错），则会打印一条带有错误信息的调试消息，然后跳转到标签exit。</p>
<p>第八部分，如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> KOBJ_ADD<span class="token operator">:</span>
        <span class="token comment">/*
        * Mark "add" event so we can make sure we deliver "remove"
        * event to userspace during automatic cleanup. If
        * the object did send an "add" event, "remove" will
        * automatically generated by the core, if not already done
        * by the caller.
        */</span>
        kobj<span class="token operator">-&gt;</span>state_add_uevent_sent <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
        
    <span class="token keyword">case</span> KOBJ_UNBIND<span class="token operator">:</span>
        <span class="token function">zap_modalias_env</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
        
    <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在上面的代码中，当action 为KOBJ_ADD 时，将kobject 对象的state_add_uevent_sent 成员设置为1，表示已经发送了“add”事件，以便在自动清理期间将“remove”事件传递给用户空间。如果该对象已经发送了“add”事件，内核会自动发送“remove”事件，否则需要调用者手动发送“remove”事件。</p>
<p>当action 为KOBJ_UNBIND 时，调用zap_modalias_env 函数清除环境变量中MODALIAS 变量。MODALIAS 是一个特殊的环境变量，用于描述设备的模块别名。在设备驱动程序加载时，内核会根据MODALIAS 环境变量自动加载相应的驱动程序模块。在设备卸载时，需要清除MODALIAS 环境变量，以便下次重新加载设备驱动程序时能够正确地识别设备。</p>
<p>第九部分，如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">retval <span class="token operator">=</span> <span class="token function">add_uevent_var</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"SEQNUM=%llu"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token operator">++</span>uevent_seqnum<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>retval<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>uevent_sock_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">goto</span> exit<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
retval <span class="token operator">=</span> <span class="token function">kobject_uevent_net_broadcast</span><span class="token punctuation">(</span>kobj<span class="token punctuation">,</span> env<span class="token punctuation">,</span> action_string<span class="token punctuation">,</span>devpath<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上述代码将一个名为”SEQNUM” 的环境变量添加到uevent 环境变量列表中，并将其值设置为uevent_seqnum 的值加1。其中，add_uevent_var 是一个内部函数，用于将一个键值对添加到uevent 环境变量列表中。如果添加失败，函数将返回一个非零值，同时会释放uevent_sock_mutex 互斥锁并跳转到exit 标签处进行清理操作。这个函数的主要作用是为uevent 事件添加一个唯一的序列号，以便在处理uevent 事件时可以识别它们的顺序。通俗的话讲就是每次发送一个事件,都要有它的事件号,该事件号不能重复，也会被加到环境变量里面。</p>
<p>kobject_uevent_net_broadcast 是一个内核函数，用于将一个uevent 事件发送到系统中所有的网络命名空间中。它的参数包括kobj，env，action_string 和devpath。其中，kobj 是与uevent 事件相关的内核对象，env 是一个包含uevent 环境变量的列表，action_string 是一个字符串，表示uevent 事件的类型，devpath 是一个字符串，表示与uevent 事件相关的设备<br>路径。该函数会遍历系统中所有的网络命名空间，并将uevent 事件发送到每个网络命名空间中。这个函数的主要作用是在内核中广播一个uevent 事件，以便用户空间的应用程序可以接收并处理这些事件。</p>
<p>第十部分，如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_UEVENT_HELPER</span></span>
    <span class="token comment">/* call uevent_helper, usually only enabled during early boot */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>uevent_helper<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">kobj_usermode_filter</span><span class="token punctuation">(</span>kobj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">subprocess_info</span> <span class="token operator">*</span>info<span class="token punctuation">;</span>
        
        retval <span class="token operator">=</span> <span class="token function">add_uevent_var</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"HOME=/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>retval<span class="token punctuation">)</span>
            <span class="token keyword">goto</span> exit<span class="token punctuation">;</span>
        
        retval <span class="token operator">=</span> <span class="token function">add_uevent_var</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span><span class="token string">"PATH=/sbin:/bin:/usr/sbin:/usr/bin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>retval<span class="token punctuation">)</span>
            <span class="token keyword">goto</span> exit<span class="token punctuation">;</span>
        
        retval <span class="token operator">=</span> <span class="token function">init_uevent_argv</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> subsystem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>retval<span class="token punctuation">)</span>
            <span class="token keyword">goto</span> exit<span class="token punctuation">;</span>
        
        retval <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
        info <span class="token operator">=</span> <span class="token function">call_usermodehelper_setup</span><span class="token punctuation">(</span>env<span class="token operator">-&gt;</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> env<span class="token operator">-&gt;</span>argv<span class="token punctuation">,</span>env<span class="token operator">-&gt;</span>envp<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">,</span>
                                         <span class="token constant">NULL</span><span class="token punctuation">,</span> cleanup_uevent_env<span class="token punctuation">,</span> env<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            retval <span class="token operator">=</span> <span class="token function">call_usermodehelper_exec</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> UMH_NO_WAIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            env <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">/* freed by cleanup_uevent_env */</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在内核中调用用户空间的uevent_helper 程序来处理uevent 事件。uevent_helper 是一个用户空间程序， 它可以在内核空间生成uevent 事件时被调用。如果CONFIG_UEVENT_HELPER 宏被定义， 那么内核会在生成uevent 事件时调用uevent_helper 程序，以便在用户空间中处理这些事件。在上述代码中，如果uevent_helper 变量不为空且kobj_usermode_filter 函数返回false，那么就会调用call_usermodehelper_setup 函数来启动一个用户空间进程，并将env 中的参数传递给该进程。在这个过程中，env 中的参数将会被转换成环境变量，并被传递给用户空间进程。\</p>
<p>以上通过分析kobject_uevent_env()函数，了解到此函数用于在内核中生成并发送uevent事件到用户空间。如果没有创建kset,会导致用户空间无法接收事件，可以详细见代码分析的第三部分。</p>
<h2 id="第115-章完善kset-uevent-ops-结构体实验"><a href="#第115-章完善kset-uevent-ops-结构体实验" class="headerlink" title="第115 章完善kset_uevent_ops 结构体实验"></a>第115 章完善kset_uevent_ops 结构体实验</h2><p>在前面的章节中，我们了解了Linux 内核是如何发送uevent 事件到用户空间的。通过分析代码，我们知道在内核中，通过kset 数据结构来组织kobject，并通过kset_uevent_ops 结构体来定义uevent 事件的处理函数。这些函数可以在接收到特定事件时执行自定义的操作。</p>
<p>为了完善这个机制，我们需要对kset_uevent_ops 结构体进行实验和定制。通过填充这个结构体中的字段，我们可以定义自己的事件处理函数，从而响应特定的事件。让我们开始做实验吧！</p>
<h3 id="115-1-实验程序的编写"><a href="#115-1-实验程序的编写" class="headerlink" title="115.1 实验程序的编写"></a>115.1 实验程序的编写</h3><h4 id="115-1-1-驱动程序编写"><a href="#115-1-1-驱动程序编写" class="headerlink" title="115.1.1 驱动程序编写"></a>115.1.1 驱动程序编写</h4><p>本实验对应的网盘路径为：iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568 开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\79_uevent_ops\module。</p>
<p>我们编写驱动程序，首先，需要创建一个自定义的kset 对象，并将其与相应的kobject 关联起来。然后，我们可以定义一个包含所需事件处理逻辑的函数，并将其赋值给uevent 字段，这样当事件发生时，内核就会调用我们定义的处理函数。在处理函数中，可以根据特定的事件类型执行我们想要的操作，例如读取设备信息、处理设备状态变化等。我们还可以使用add_uevent_var 函数向uevent 环境中添加自定义的键值对，以提供额外的信息给用户空间。</p>
<p>通过这种方式，我们可以定制内核中的uevent 事件处理机制，使其适应特定需求。这种定制化的事件处理机制可以用于各种场景，例如设备驱动程序、模块加载和卸载等。</p>
<p>总结起来，通过实验和完善<code>kset_uevent_ops</code>结构体，我们可以扩展内核的uevent 事件处理能力，使其更加灵活和适应各种应用场景。这为我们提供了在内核和用户空间之间进行通信和交互的强大工具。编写完成的uevent_ops.c 代码如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/configfs.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kobject.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>mykobject01<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>mykobject02<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">kset</span> <span class="token operator">*</span>mykset<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">kobj_type</span> mytype<span class="token punctuation">;</span>

<span class="token comment">// 定义一个回调函数，返回kset的名称</span>
<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">myname</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kset</span> <span class="token operator">*</span>kset<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">"my_kset"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义一个回调函数，处理kset的uevent事件</span>
<span class="token keyword">int</span> <span class="token function">myevent</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kset</span> <span class="token operator">*</span>kset<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">kobj_uevent_env</span> <span class="token operator">*</span>env<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">add_uevent_var</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"MYDEVICE=%s"</span><span class="token punctuation">,</span> <span class="token string">"TOPEET"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义一个回调函数，用于过滤kset中的kobject</span>
<span class="token keyword">int</span> <span class="token function">myfilter</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kset</span> <span class="token operator">*</span>kset<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>kobj<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> <span class="token string">"mykobject01"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 返回0表示通过过滤</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 返回1表示过滤掉</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">kset_uevent_ops</span> my_uevent_ops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>filter <span class="token operator">=</span> myfilter<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>uevent <span class="token operator">=</span> myevent<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>name <span class="token operator">=</span> myname<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 模块的初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">mykobj_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    <span class="token comment">// 创建并添加一个kset</span>
    mykset <span class="token operator">=</span> <span class="token function">kset_create_and_add</span><span class="token punctuation">(</span><span class="token string">"mykset"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>my_uevent_ops<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 分配并初始化一个kobject</span>
    mykobject01 <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mykobject01<span class="token operator">-&gt;</span>kset <span class="token operator">=</span> mykset<span class="token punctuation">;</span>

    <span class="token comment">// 初始化并添加kobject到kset</span>
    ret <span class="token operator">=</span> <span class="token function">kobject_init_and_add</span><span class="token punctuation">(</span>mykobject01<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mytype<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"mykobject01"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 分配并初始化一个kobject</span>
    mykobject02 <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mykobject02<span class="token operator">-&gt;</span>kset <span class="token operator">=</span> mykset<span class="token punctuation">;</span>

    <span class="token comment">// 初始化并添加kobject到kset</span>
    ret <span class="token operator">=</span> <span class="token function">kobject_init_and_add</span><span class="token punctuation">(</span>mykobject02<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mytype<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"mykobject02"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 触发一个uevent事件，表示mykobject01的属性发生了变化</span>
    ret <span class="token operator">=</span> <span class="token function">kobject_uevent</span><span class="token punctuation">(</span>mykobject01<span class="token punctuation">,</span> KOBJ_CHANGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 触发一个uevent事件，表示mykobject02被添加</span>
    ret <span class="token operator">=</span> <span class="token function">kobject_uevent</span><span class="token punctuation">(</span>mykobject02<span class="token punctuation">,</span> KOBJ_ADD<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 模块退出函数</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">mykobj_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 释放kobject</span>
    <span class="token function">kobject_put</span><span class="token punctuation">(</span>mykobject01<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">kobject_put</span><span class="token punctuation">(</span>mykobject02<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">kset_unregister</span><span class="token punctuation">(</span>mykset<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>mykobj_init<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定模块的初始化函数</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>mykobj_exit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定模块的退出函数</span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 模块使用的许可证</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"topeet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 模块的作者</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="115-2-运行测试"><a href="#115-2-运行测试" class="headerlink" title="115.2 运行测试"></a>115.2 运行测试</h3><h4 id="115-2-1-编译驱动程序"><a href="#115-2-1-编译驱动程序" class="headerlink" title="115.2.1 编译驱动程序"></a>115.2.1 编译驱动程序</h4><p>在上一小节中的uevent_ops.c 代码同一目录下创建Makefile 文件，Makefile 文件内容如下所示：然后使用命令“make”进行驱动的编译，编译完生成uevent_ops.ko 目标文件，至此驱动模块就编译成功了，接下来进行测试。</p>
<h4 id="115-2-2-运行测试"><a href="#115-2-2-运行测试" class="headerlink" title="115.2.2 运行测试"></a>115.2.2 运行测试</h4><p>开发板启动之后，使用命令“<code>udevadm monitor &amp;</code>”监视和显示当前系统中的uevent 事件。然后使用以下命令进行驱动模块的加载，如下图（图115-4）所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">insmod uevent_ops<span class="token punctuation">.</span>ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409121429820.png" alt="image-20240912142919680"></p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409121429515.png" alt="image-20240912142925382"></p>
<p>驱动加载之后，如上图所示udev 接收到add 动作，说明uevent 事件已经发送成功了。/mykset/mykobject02 是kobject 在根目录/sys/下的路径。<br>最后可以使用以下命令进行驱动的卸载，如下图（图115-6）所示：</p>
<pre class="line-numbers language-none"><code class="language-none">rmmod uevent_ops<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409121430426.png" alt="image-20240912143027282"></p>
<p>至此，完善kset_uevent_ops 实验就完成了。</p>
<h2 id="第116-章netlink-监听广播信息实验"><a href="#第116-章netlink-监听广播信息实验" class="headerlink" title="第116 章netlink 监听广播信息实验"></a>第116 章netlink 监听广播信息实验</h2><p>在上一章的实验中，我们填充了三个回调函数，分别为.filter = myfilter, .uevent =myevent, .name = myname,但在最后的实验中只验证filter 过滤了kset 中的kobject1，那另外两个回调函数要如何验证呢？</p>
<p>内核通过kobject uevent 接口发送广播事件之后，用户空间可以通过netlink 来监听这些广播信息。通过监听广播信息，就可以获取到携带环境变量的事件，在本章节将会对netlink 进行详细的讲解。</p>
<h3 id="116-1-netlink-机制介绍"><a href="#116-1-netlink-机制介绍" class="headerlink" title="116.1 netlink 机制介绍"></a>116.1 netlink 机制介绍</h3><p>Netlink 是Linux 内核中用于内核和用户空间之间进行双工通信的机制。它基于socket 通信机制，并提供了一种可靠的、异步的、多播的、有序的通信方式。</p>
<p>Netlink 机制的主要特点包括：</p>
<ul>
<li>（1）双工通信：Netlink 允许内核和用户空间之间进行双向通信，使得内核可以向用户空间发送消息，同时也可以接收来自用户空间的消息。</li>
<li>（2）可靠性：Netlink 提供了可靠的消息传递机制，保证消息的完整性和可靠性。它使用了确认和重传机制，以确保消息的可靠传输。</li>
<li>（3）异步通信：Netlink 支持异步通信，即内核和用户空间可以独立地发送和接收消息，无需同步等待对方的响应。</li>
<li>（4）多播支持：Netlink 允许向多个进程或套接字广播消息，以实现一对多的通信。</li>
<li>（5）有序传输：Netlink 保证消息的有序传输，即发送的消息按照发送的顺序在接收端按序接收。</li>
</ul>
<p>Netlink 的应用广泛，常见的应用包括：</p>
<ul>
<li>（1）系统管理工具：如ifconfig、ip 等工具使用Netlink 与内核通信来获取和配置网络接口的信息。</li>
<li>（2）进程间通信：进程可以使用Netlink 进行跨进程通信，实现进程间的数据交换和协调。</li>
<li>（3）内核模块和用户空间应用程序的通信：内核模块可以通过Netlink 向用户空间应用程序发送通知或接收用户空间应用程序的指令。</li>
</ul>
<h3 id="116-2-netlink-的使用"><a href="#116-2-netlink-的使用" class="headerlink" title="116.2 netlink 的使用"></a>116.2 netlink 的使用</h3><h4 id="116-2-1-创建socket"><a href="#116-2-1-创建socket" class="headerlink" title="116.2.1 创建socket"></a>116.2.1 创建socket</h4><p>在<code>Linux socket</code> 编程中，创建套接字是构建网络应用程序的第一步。套接字可以理解为应用程序和网络之间的桥梁，用于在网络上进行数据的收发和处理。该系统调用的原型和所需头文件如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">所需头文件
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
函数原型
<span class="token keyword">int</span> <span class="token function">socket</span><span class="token punctuation">(</span><span class="token keyword">int</span> domain<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> protocol<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中，domain 参数指定了套接字的协议族，type 参数指定了套接字的类型，protocol 参数指定了套接字所使用的具体协议。下面分别介绍这三个参数的含义：</p>
<p><strong>（1）协议族</strong><br>协议族指定了套接字所使用的协议类型，常用的协议族包括<code>AF_INET</code>、<code>AF_INET6</code>、<code>AF_UNIX</code>等。其中，<code>AF_INET</code> 表示IPv4 协议族，<code>AF_INET6</code> 表示IPv6 协议族，<code>AF_UNIX</code> 表示Unix 域协议族，这里的协议族为netlink，所以该参数要在程序中设置为AF_ NETLINK。</p>
<p><strong>（2）套接字类型</strong><br>套接字类型指定了套接字的数据传输方式，常用的套接字类型包括<code>SOCK_STREAM</code>、<code>SOCK_DGRAM</code>、<code>SOCK_RAW</code> 等。其中，<code>SOCK_STREAM</code> 表示面向连接的流套接字，主要用于可靠传输数据，<strong>例如TCP 协议</strong>。<code>SOCK_DGRAM</code> 表示无连接的数据报套接字，主要用于不可靠传输数据，<strong>例如UDP 协议</strong>。在本实验中该参数要设置为<code>SOCK_RAW</code> 表示原始套接字，可以直接访问底层网络协议。</p>
<p><strong>（3）协议类型</strong><br>协议类型指定了套接字所使用的具体协议类型，常用的协议类型包括<code>IPPROTO_TCP</code>、<code>IPPROTO_UDP</code>、<code>IPPROTO_ICMP</code> 等。其中，<code>IPPROTO_TCP</code> 表示TCP 协议，<code>IPPROTO_UDP</code> 表示UDP协议，<code>IPPROTO_ICMP</code> 表示ICMP 协议，在本实验中，我们要设置为<code>NETLINK_KOBJECT_UEVENT</code>。</p>
<p>在本小节中将使用以下代码创建一个新的套接字：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> socket_fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_NETLINK<span class="token punctuation">,</span> SOCK_RAW<span class="token punctuation">,</span> NETLINK_KOBJECT_UEVENT<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li><code>AF_NETLINK</code>：指定了使用Netlink 协议族。Netlink 协议族是一种Linux 特定的协议族，用于内核和用户空间之间的通信。</li>
<li><code>SOCK_RAW</code>：指定了创建原始套接字，这种套接字类型可以直接访问底层协议，而不需要进行协议栈处理。在这种情况下，我们可以直接使用Netlink 协议进行通信。</li>
<li><code>NETLINK_KOBJECT_UEVENT</code>：指定了Netlink 协议的一种类型，即kobject uevent 类型。kobject uevent 用于内核对象相关的事件通知，当内核中的kobject 对象发生变化时，会通过此类型的Netlink 消息通知用户空间。</li>
</ul>
<h4 id="116-2-2-绑定套接字"><a href="#116-2-2-绑定套接字" class="headerlink" title="116.2.2 绑定套接字"></a>116.2.2 绑定套接字</h4><p>创建套接字后，需要将其与一个网络地址绑定，以便其他计算机可以访问该套接字。在Linux系统下，可以使用bind()系统调用绑定套接字和地址。该系统调用的原型和所需头文件如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">所需头文件
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
    
函数原型
<span class="token keyword">int</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span><span class="token class-name">socklen_t</span> addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(1) sockfd 参数指定了需要绑定的套接字描述符，<br>(2) addr 参数指定了需要绑定的地址信息，这里使用sockaddr_nl 结构体，sockaddr_nl 结构体的定义如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">sockaddr_nl</span> <span class="token punctuation">{</span>
    <span class="token class-name">sa_family_t</span> nl_family<span class="token punctuation">;</span> <span class="token comment">// AF_NETLINK</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> nl_pad<span class="token punctuation">;</span> <span class="token comment">// zero</span>
    <span class="token class-name">uint32_t</span> nl_pid<span class="token punctuation">;</span> <span class="token comment">// port ID</span>
    <span class="token class-name">uint32_t</span> nl_groups<span class="token punctuation">;</span> <span class="token comment">// multicast groups mask</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>nl_family：表示地址族，此处固定为AF_NETLINK，指示使用Netlink 协议族。</li>
<li>nl_pad：填充字段，设置为0。在结构体中进行字节对齐时使用。</li>
<li>nl_pid：端口ID，表示进程的标识符。可以将其设置为当前进程的PID，也可以设为0，表示不加入任何多播组。</li>
<li>nl_groups：多播组掩码，用于指定感兴趣的多播组。当设置为1 时，表示用户空间进程只会接收内核事件的基本组的内核事件。这意味着，用户空间进程将只接收到属于基本组的内核事件，而不会接收其他多播组的事件。</li>
</ul>
<p>(3) addrlen 参数：addrlen 参数是一个整数，指定了addr 所指向的结构体对应的字节长度。它用于确保正确解析传递给addr 参数的结构体的大小。</p>
<p>具体编程示例如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">sockaddr_nl</span> <span class="token operator">*</span>nl<span class="token punctuation">;</span> <span class="token comment">// 定义一个指向struct sockaddr_nl 结构体的指针nl</span>
<span class="token function">bzero</span><span class="token punctuation">(</span>nl<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_nl</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将nl 指向的内存区域清零，确保结构体的字段初始化为0</span>
nl<span class="token operator">-&gt;</span>nl_family <span class="token operator">=</span> AF_NETLINK<span class="token punctuation">;</span> <span class="token comment">// 设置nl 结构体的nl_family 字段为AF_NETLINK，指定地址族为Netlink</span>
nl<span class="token operator">-&gt;</span>nl_pid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 设置nl 结构体的nl_pid 字段为0，表示目标进程ID 为0，即广播给所有进程</span>
nl<span class="token operator">-&gt;</span>nl_groups <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 设置nl 结构体的nl_groups 字段为1，表示只接收基本组的内核事件</span>
ret <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span>nl<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_nl</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//使用bind 函数将socket_fd 套接字与nl 地址结构体绑定在一起</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"bind error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="116-2-3-接收数据"><a href="#116-2-3-接收数据" class="headerlink" title="116.2.3 接收数据"></a>116.2.3 接收数据</h4><p>Netlink 套接字在接收数据时不需要调用listen 函数，而是可以直接使用recv 函数进行接收。下面是recv 函数的相关说明：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">头文件：
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
函数原型：
    <span class="token class-name">ssize_t</span> <span class="token function">recv</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
函数参数：
    sockfd：指定套接字描述符，即要接收数据的Netlink 套接字。
    buf：指向数据接收缓冲区的指针，用于存储接收到的数据。
    len：指定要读取的数据的字节大小。
    flags：指定一些标志，用于控制数据的接收方式。通常情况下，可以将其设置为<span class="token number">0</span>。
返回值：
    成功情况下，返回实际读取到的字节数。
    如果返回值为<span class="token number">0</span>，表示对方已经关闭了连接。
    如果返回值为<span class="token operator">-</span><span class="token number">1</span>，表示发生了错误，可以通过查看errno 变量来获取具体的错误代码。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>使用recv 函数可以从指定的Netlink 套接字中接收数据，并将其存储在提供的缓冲区中。函数的返回值表示实际读取到的字节数，可以根据返回值来判断是否成功接收到数据。</p>
<p>接收数据的具体代码示例如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">bzero</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将缓冲区buf 清零，确保数据接收前的初始化</span>
    len <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 从socket_fd 套接字接收数据，存储到缓冲区buf 中，最大接收字节数为4096</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token char">'\0'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果接收到的数据中有'\0' 字符，将其替换为'\n'，以便在打印时换行显示</span>
        	buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\n'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打印接收到的数据</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="116-3-实验程序的编写"><a href="#116-3-实验程序的编写" class="headerlink" title="116.3 实验程序的编写"></a>116.3 实验程序的编写</h3><p>本应用程序对应的网盘路径为：<code>iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\80_netlink</code>。<br>根据上一小节所讲解的内容，使用netlink 监听广播信息的应用程序netlink.c.c 代码如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;strings.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/netlink.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_nl</span> <span class="token operator">*</span>nl<span class="token punctuation">;</span>  <span class="token comment">// 定义一个指向struct sockaddr_nl 结构体的指针nl</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">4096</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token comment">// 数据接收缓冲区</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token function">bzero</span><span class="token punctuation">(</span>nl<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_nl</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 将nl 指向的内存区域清零，确保结构体的字段初始化为0</span>
    nl<span class="token operator">-&gt;</span>nl_family <span class="token operator">=</span> AF_NETLINK<span class="token punctuation">;</span>  <span class="token comment">// 设置nl 结构体的nl_family 字段为AF_NETLINK，指定地址族为Netlink</span>
    nl<span class="token operator">-&gt;</span>nl_pid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// 设置nl 结构体的nl_pid 字段为0，表示目标进程ID 为0，即广播给所有进程</span>
    nl<span class="token operator">-&gt;</span>nl_groups <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 设置nl 结构体的nl_groups 字段为1，表示只接收基本组的内核事件</span>

    <span class="token keyword">int</span> socket_fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_NETLINK<span class="token punctuation">,</span> SOCK_RAW<span class="token punctuation">,</span> NETLINK_KOBJECT_UEVENT<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 创建一个Netlink套接字</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>socket_fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"socket error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ret <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span>nl<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_nl</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 使用bind 函数将socket_fd 套接字与nl 地址结构体绑定在一起</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"bind error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">bzero</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 将缓冲区buf 清零，确保数据接收前的初始化</span>
        len <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 从socket_fd 套接字接收数据，存储到缓冲区buf 中，最大接收字节数为4096</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token char">'\0'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 如果接收到的数据中有'\0' 字符，将其替换为'\n'，以便在打印时换行显示</span>
                buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\n'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 打印接收到的数据</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="116-4-运行测试"><a href="#116-4-运行测试" class="headerlink" title="116.4 运行测试"></a>116.4 运行测试</h3><h4 id="116-4-1-编译应用程序"><a href="#116-4-1-编译应用程序" class="headerlink" title="116.4.1 编译应用程序"></a>116.4.1 编译应用程序</h4><p>下面进行应用程序编译， 因为测试APP 是要在开发板上运行的， 所以需要<code>aarch64-linux-gnu-gcc</code> 来编译，输入以下命令，编译完成以后会生成一个netlink 的可执行程序，<br>如下图（图116-1）所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">aarch64-linux-gnu-gcc <span class="token parameter variable">-o</span> netlink netlink.c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131026995.png" alt="image-20240913102611838"></p>
<p>下面进行程序的测试。</p>
<h4 id="116-4-2-运行测试"><a href="#116-4-2-运行测试" class="headerlink" title="116.4.2 运行测试"></a>116.4.2 运行测试</h4><p>本小节测试所使用的驱动文件为上一章编译生成的uevent_ops.ko，应用程序为上一小节编译出来的netlink。<br>开发板启动之后，首先使用以下命令让应用程序在后台运行，如下图（图116-2）所示：</p>
<pre class="line-numbers language-none"><code class="language-none">./netlink &amp;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131026464.png" alt="image-20240913102638354"></p>
<p>然后继续使用以下命令加载uevent_ops.ko 驱动，打印如下图（116-3）所示：</p>
<pre class="line-numbers language-none"><code class="language-none">insmod uevent_ops.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131026542.png" alt="image-20240913102656406"></p>
<p>SUBSYSTEM=my_kset，表示设备或对象所属的子系统。在这里，子系统是”my_kset”。MYDEVICE 表示设备的名称或标识。在这里，设备的名称是”TOPEET”，正是我们在回调函数中所设置的。</p>
<p>最后可以使用以下命令进行驱动的卸载，如下图（图116-4）所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">rmmod uevent_ops<span class="token punctuation">.</span>ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131027537.png" alt="image-20240913102757411"></p>
<p>至此，使用netlink 监听广播信息实验就完成了。</p>
<h2 id="第117-章uevent-helper-实验"><a href="#第117-章uevent-helper-实验" class="headerlink" title="第117 章uevent_helper 实验"></a>第117 章uevent_helper 实验</h2><p>在前面的章节中已经讲解了广播这一内核发送事件到用户空间的方法，而在本章节中将会讲解内核发送事件到用户空间的第二种方法-调用可执行程序。</p>
<h3 id="117-1-设置uevent-helper"><a href="#117-1-设置uevent-helper" class="headerlink" title="117.1 设置uevent_helper"></a>117.1 设置uevent_helper</h3><p>在114.2 小节的第十部分中进行了定义，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_UEVENT_HELPER</span></span>
<span class="token comment">/* call uevent_helper, usually only enabled during early boot */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>uevent_helper<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">kobj_usermode_filter</span><span class="token punctuation">(</span>kobj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">subprocess_info</span> <span class="token operator">*</span>info<span class="token punctuation">;</span>
    
    retval <span class="token operator">=</span> <span class="token function">add_uevent_var</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"HOME=/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>retval<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span>
    
    retval <span class="token operator">=</span> <span class="token function">add_uevent_var</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span><span class="token string">"PATH=/sbin:/bin:/usr/sbin:/usr/bin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>retval<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span>
    
    retval <span class="token operator">=</span> <span class="token function">init_uevent_argv</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> subsystem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>retval<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span>
    
    retval <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
    info <span class="token operator">=</span> <span class="token function">call_usermodehelper_setup</span><span class="token punctuation">(</span>env<span class="token operator">-&gt;</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> env<span class="token operator">-&gt;</span>argv<span class="token punctuation">,</span>env<span class="token operator">-&gt;</span>envp<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">,</span>
                                     <span class="token constant">NULL</span><span class="token punctuation">,</span> cleanup_uevent_env<span class="token punctuation">,</span> env<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        retval <span class="token operator">=</span> <span class="token function">call_usermodehelper_exec</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> UMH_NO_WAIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        env <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">/* freed by cleanup_uevent_env */</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第3 行为一个if 表达式，它检查uevent_helper 数组的第一个元素是否为真。并调用kobj_usermode_filter 函数进行用户模式过滤， uevent_helper 定义如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">char</span> uevent_helper<span class="token punctuation">[</span>UEVENT_HELPER_PATH_LEN<span class="token punctuation">]</span> <span class="token operator">=</span> CONFIG_UEVENT_HELPER_PATH<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>其中CONFIG_UEVENT_HELPER_PATH 是一个宏定义在内核源码的“include/generated/autoconf.h”文件中，如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CONFIG_UEVENT_HELPER_PATH</span> <span class="token string">""</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>该宏为空， 所以为了使能uevent_helper 功能需要在图形配置界面使能<code>CONFIG_UEVENT_HELPER</code> 和<code>CONFIG_UEVENT_HELPER_PATH</code> 两个宏。首先来到内核源码目录下，<br>如下图（图117-1）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131030416.png" alt="image-20240913103059263"></p>
<p>然后输入以下命令将平台切换为arm64、加载rk3568 的默认配置文件和进入图像配置界面，如下图（图117- 2）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131031004.png" alt="image-20240913103114892"></p>
<p>然后需要在menuconfig 的图形配置界面进行以下配置：</p>
<p><strong>配置1:</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">Device Drivers
    Generic Driver Options
        <span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Support <span class="token keyword">for</span> uevent helper		<span class="token comment">//选中</span>
        <span class="token punctuation">(</span><span class="token operator">/</span>sbin<span class="token operator">/</span>mdev<span class="token punctuation">)</span> path to uevent helper	<span class="token comment">//设置mdev 路径</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131032508.png" alt="image-20240913103205334"></p>
<p><strong>配置2:</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">File systems
    Pseudo filesystems<span class="token punctuation">.</span>
        <span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span><span class="token operator">/</span>proc file system support<span class="token comment">//选中</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131032911.png" alt="image-20240913103240758"></p>
<p><strong>配置3:</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">File systems
    Pseudo filesystems<span class="token punctuation">.</span>
        <span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Sysctl <span class="token function">support</span><span class="token punctuation">(</span><span class="token operator">/</span>proc<span class="token operator">/</span>sys<span class="token punctuation">)</span><span class="token comment">//选中</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131033954.png" alt="image-20240913103303788"></p>
<p>配置4:</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span>Networking support		<span class="token comment">//选中</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131033171.png" alt="image-20240913103329022"></p>
<p>在上面的配置1 中设置了uevent helper 和相对应的路径，这就是配置方法1，但是这种方式需要重新编译内核，使用起来较为麻烦，除了方法一之外还有更快捷的方法2 和方法3，具体内容如下所示：</p>
<p><strong>配置方法2：</strong><br>无论是否配置了CONFIG_UEVENT_HELPER_PATH，在系统启动后，可以使用以下命令来设置uevent_helper：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> /sbin/mdev <span class="token operator">&gt;</span> /sys/kernel/uevent_helper<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这将把uevent_helper 设置为/sbin/mdex。</p>
<p><strong>配置方法3：</strong><br>无论是否配置了<code>CONFIG_UEVENT_HELPER_PATH</code>，在系统启动后，可以使用以下命令来设置<code>uevent_helper</code>：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> /sbin/mdev <span class="token operator">&gt;</span> /proc/sys/kernel/hotplug<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这将把uevent_helper 设置为/sbin/mdexw.。</p>
<p>需要注意的是配置方法2 和配置方法3 依赖于上面的配置2、3、4 选项，并且可以通过配置方法2 和配置方法3 修改配置方法1 中已经写好的值。</p>
<p>对/proc/sys/kernel/hotplug 和/sys/kernel/uevent_helper 进行读写都是为了对uevent_helper属性进行读写操作。</p>
<p><code>/sys/kernel/uevent_helper</code> 是sysfs 文件系统中的一个文件，它是uevent_helper 属性的接口。通过对该文件进行读写操作，可以读取或修改uevent_helper 属性的值。在内核源码的kernel/ksysfs.c 目录下可以找到对uevent_helper 属性的定义和相关操作的实现，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_UEVENT_HELPER</span></span>
<span class="token comment">/* uevent helper program, used during early boot */</span>
<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">uevent_helper_show</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">kobj_attribute</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"%s\n"</span><span class="token punctuation">,</span> uevent_helper<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">uevent_helper_store</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">kobj_attribute</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span>
                                   <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&gt;</span> UEVENT_HELPER_PATH_LEN<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOENT<span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>uevent_helper<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    uevent_helper<span class="token punctuation">[</span>count<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&amp;&amp;</span> uevent_helper<span class="token punctuation">[</span>count <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'\n'</span><span class="token punctuation">)</span>
        uevent_helper<span class="token punctuation">[</span>count <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">KERNEL_ATTR_RW</span><span class="token punctuation">(</span>uevent_helper<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>uevent_helper_show</code> 函数用于将uevent_helper 的值写入buf 中，并返回写入的字符数。<br><code>uevent_helper_store</code> 函数用于将buf 中的值复制到uevent_helper 中，并根据需要进行处理，然后返回写入的字符数。<br>而<code>/proc/sys/kernel/hotplug</code> 是一个虚拟文件，用于配置内核中的热插拔事件处理程序。通过对该文件进行写操作，可以设置uevent_helper 属性的值。在内核源码的kernel/sysctl.c 文件中，可以看到对hotplug 操作其实是对uevent_helper 进行操作。具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_UEVENT_HELPER</span></span>
<span class="token punctuation">{</span>
    <span class="token punctuation">.</span>procname <span class="token operator">=</span> <span class="token string">"hotplug"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token operator">&amp;</span>uevent_helper<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>maxlen <span class="token operator">=</span> UEVENT_HELPER_PATH_LEN<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>mode <span class="token operator">=</span> <span class="token number">0644</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>proc_handler <span class="token operator">=</span> proc_dostring<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>这段代码定义了一个名为hotplug 的文件，用于处理uevent 事件。它与uevent_helper 属性相关联。</p>
<ul>
<li><code>.procname</code> 表示文件名，即<code>/proc/hotplug</code>。</li>
<li><code>.data</code> 是一个指向uevent_helper 结构体的指针，用于保存与该文件相关的数据。该指针指向<code>uevent_helper</code> 结构体，用于处理uevent 事件。</li>
<li><code>.maxlen</code> 表示文件的最大长度，即文件内容的最大长度。该值为<code>UEVENT_HELPER_PATH_LEN</code>，表示文件内容的最大长度为<code>UEVENT_HELPER_PATH_LEN</code>。</li>
<li><code>.mode</code> 表示文件的访问权限。该值为0644，表示该文件的权限为<code>-rw-r--r--</code>，即所有用户都可以读取该文件，但只有root 用户可以写入该文件。</li>
</ul>
<h3 id="117-2-处理uevent-事件"><a href="#117-2-处理uevent-事件" class="headerlink" title="117.2 处理uevent 事件"></a>117.2 处理uevent 事件</h3><p>在上一章节中我们使用了netlink 机制来监听内核向用户空间发送的uevent 事件，而在上一小节中我们设置了<code>uevent_helper</code>，所以本小节将会学习调用用户空间程序来处理内核发送的uevent 事件。</p>
<h4 id="117-2-1-编写应用程序"><a href="#117-2-1-编写应用程序" class="headerlink" title="117.2.1 编写应用程序"></a>117.2.1 编写应用程序</h4><p>本应用程序对应的网盘路径为：<code>iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\81_mdev</code>。<br>本小节编写的是应用程序，所要实现的效果极其简单，只是获取<code>SUBSYSTEM</code> 环境变量并打印即可，编写完成的应用程序内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/ttyFIQ0"</span><span class="token punctuation">,</span> O_WRONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">dup2</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> STDOUT_FILENO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"SUBSYSTEM is %s\n"</span><span class="token punctuation">,</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"SUBSYSTEM"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="117-2-2-编译应用程序"><a href="#117-2-2-编译应用程序" class="headerlink" title="117.2.2 编译应用程序"></a>117.2.2 编译应用程序</h4><p>下面进行应用程序编译， 因为测试APP 是要在开发板上运行的， 所以需要<code>aarch64-linux-gnu-gcc</code> 来编译，输入以下命令，编译完成以后会生成一个mdev 的可执行程序，如下图（图117-7）所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">aarch64-linux-gnu-gcc <span class="token parameter variable">-o</span> mdev mdev.c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131046137.png"></p>
<p>下面进行程序的测试。</p>
<h4 id="117-2-3-运行测试"><a href="#117-2-3-运行测试" class="headerlink" title="117.2.3 运行测试"></a>117.2.3 运行测试</h4><p>本小节测试所使用的驱动文件为115 章编译生成的<code>uevent_ops.ko</code>，应用程序为上一小节编译出来的<code>mdev</code>。<br>mdev 可执行文件和<code>uevent_ops.ko</code> 驱动存放在开发板的/mnt 目录下，如下图(图117-8)所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131047846.png" alt="image-20240913104702689"></p>
<p>在第一小节中讲解了三种配置方法，配置方法1 是在内核中直接指定的，使用起来较为麻烦，这里直接使用配置方法2 和配置方法3 这两种方式进行演示。</p>
<p><strong>配置方法2：</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> /mnt/mdev <span class="token operator">&gt;</span> /sys/kernel/uevent_helper<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后使用以下命令加载uevent_ops.ko 驱动，如下图(图117-9)所示：<br><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131048997.png" alt="image-20240913104828830"></p>
<p><strong>配置方法3：</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> /mnt/mdev <span class="token operator">&gt;</span> /proc/sys/kernel/hotplug<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后使用以下命令加载uevent_ops.ko 驱动，如下图(图117-10)所示：<br><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131049498.png" alt="image-20240913104908337"><br>上面两种配置都可以打印出内核加载时传递的SUBSYSTEM 环境变量，最后可以使用以下命令进行驱动的卸载，如下图（图54-12)所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">rmmod uevent_ops.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131049272.png" alt="image-20240913104929156"></p>
<p>至此，uevent_helper 实验就完成了。</p>
<h2 id="第118-章使用udev-挂载U-盘和T-卡实验"><a href="#第118-章使用udev-挂载U-盘和T-卡实验" class="headerlink" title="第118 章使用udev 挂载U 盘和T 卡实验"></a>第118 章使用udev 挂载U 盘和T 卡实验</h2><p>在前面章节中所讲解的都是关于热插拔的理论和较为简单的实验，而为了加深大家对热插拔的理解以及在可以在实际工作中进行应用，所以在本章节将进行实践，使用udev 挂载U 盘和T 卡。</p>
<h3 id="118-1-配置buildroot-文件系统支持udev"><a href="#118-1-配置buildroot-文件系统支持udev" class="headerlink" title="118.1 配置buildroot 文件系统支持udev"></a>118.1 配置buildroot 文件系统支持udev</h3><p>上一章中我们编写了一个名为mdev 的应用程序，用来处理uevent 事件，而实际上udev和mdev 的可执行程序都是很复杂的，也并不需要我们自己来写，只需要在构建buildroot 文件系统时勾选对应的选项即可。首先来到buildroot 的源码目录下，如下图（图118-1）然后使用以下命令加载rk3568 的默认配置文件)所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131050784.png" alt="image-20240913105008662"></p>
<p>然后使用以下命令加载rk3568 的默认配置文件并进入到图形化配置界面，如下图（图118-2）所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">make</span> rockchip_rk3568_defconfig
<span class="token function">make</span> menuconfig<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131050215.png" alt="image-20240913105043045"></p>
<p>由于本章节使用的是udev 所以需要在在System configuration 菜单中， 选择/dev<br>management (Dynamic using devtmpfs + eudev)，如下图（图118-3）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131051958.png" alt="image-20240913105114785"></p>
<p>默认情况下选中的就是udev，相应的镜像已经放在了“<code>iTOP-RK3568 开发板【底板V1.7版本】\03_【iTOP-RK3568 开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动程序\82_udev_u 盘_TF 卡</code>”目录下如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131051768.png" alt="image-20240913105159650"></p>
<p>烧写该镜像之后，可以在串口终端输入以下命令来查看udev 是否已经启用了，如下图（图118-4）所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ps</span> <span class="token parameter variable">-aux</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-nR</span> udev<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131052800.png" alt="image-20240913105221678"></p>
<p>检查到/sbin/udevd 进程就表示当前系统使用的是udev，至此配置buildroot 文件系统支持udev 就完成了。</p>
<h3 id="118-2-使用udev-挂载U-盘"><a href="#118-2-使用udev-挂载U-盘" class="headerlink" title="118.2 使用udev 挂载U 盘"></a>118.2 使用udev 挂载U 盘</h3><p>本小节编写完成的文件对应的网盘路径为：<code>iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568 开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程04_Linux 驱动程序\82_udev_u 盘_TF 卡\U 盘</code>。<br>在上一小节中配置buildroot 使能了udev，而要想使用udev 来实现U 盘的自动挂载，还需在开发板的/etc/udev/rules.d 目录下创建相应的规则文件（/etc/udev/rules.d 目录不存在可以手动创建，一般都已经存在了），这里我们创建一个名为001.rules 的文件，如下图（图118-5）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131053116.png" alt="image-20240913105306993"></p>
<p>然后向该文件中添加以下内容：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">KERNEL<span class="token operator">==</span><span class="token string">"sd[a-z][0-9]"</span><span class="token punctuation">,</span> SUBSYSTEM<span class="token operator">==</span><span class="token string">"block"</span><span class="token punctuation">,</span> ACTION<span class="token operator">==</span><span class="token string">"add"</span><span class="token punctuation">,</span> RUN<span class="token operator">+=</span><span class="token string">"/etc/udev/rules.d/usb/usb-add.sh %k"</span>
SUBSYSTEM<span class="token operator">==</span><span class="token string">"block"</span><span class="token punctuation">,</span> ACTION<span class="token operator">==</span><span class="token string">"remove"</span><span class="token punctuation">,</span> RUN<span class="token operator">+=</span><span class="token string">"/etc/udev/rules.d/usb/usb-remove.sh"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><strong>（1）<code>KERNEL=="sd[a-z][0-9]"</code></strong><br>KERNEL：表示匹配设备的内核名。<br><code>"sd[a-z][0-9]"</code>：是一个正则表达式模式，sd：表示设备名以”sd” 开头，[a-z]：表示设备名的第三个字符是小写字母，[0-9]：表示设备名的第四个字符是数字。<br>这个模式用于匹配USB 存储设备的块设备节点，如/dev/sda1、/dev/sdb2 等。</p>
<p><strong><code>（2）SUBSYSTEM=="block"</code></strong><br>SUBSYSTEM：表示匹配设备的子系统名称。<br>“block”：表示设备的子系统是块设备子系统，即与磁盘、分区等相关的设备。<br>这部分规则是为了确保只匹配块设备子系统下的设备。</p>
<p><strong><code>（3）ACTION=="add"和ACTION=="remove"</code></strong><br>ACTION：表示匹配设备的动作。<br>“add”：表示设备被添加。<br>“remove”：表示设备被yichu。<br>这部分规则是为了处理设备被添加和被删除的事件。</p>
<p><strong><code>（5）RUN+="/etc/udev/rules.d/usb/usb-add.sh %k"</code></strong><br>RUN+=”…”：表示在匹配的设备上执行指定的命令。<br><code>"/etc/udev/rules.d/usb/usb-add.sh"</code>：是要执行的命令的路径，即在设备添加时执行<code>/etc/udev/rules.d/usb/usb-add.sh</code> 脚本文件。<br><code>%k</code>：是Udev 提供的一个变量，表示匹配的设备的内核名。</p>
<p>可以注意到当块设备被添加的时候会执行<code>/etc/udev/rules.d/usb/usb-add.sh</code> 脚本，块设备被删除的时候会执行<code>/etc/udev/rules.d/usb/usb-remove.sh</code> 脚本，所以接下来我们要完善这两个脚本内容，首先在<code>/etc/udev/rules.d/</code>目录下创建名为<code>usb</code> 的文件夹，并在这个创建usb-add.sh 和usb-remove.sh 脚本，如下图（图118-6） 所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131058499.png" alt="image-20240913105833366"></p>
<p>然后在/etc/udev/rules.d/usb/usb-add.sh 文件中写入以下内容：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>
/bin/mount <span class="token parameter variable">-t</span> vfat /dev/<span class="token variable">$1</span> /mnt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>在/etc/udev/rules.d/usb/usb-remove.sh 文件中写入以下内容：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>
<span class="token function">sync</span>
/bin/umount <span class="token parameter variable">-l</span> /mnt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>添加完成如下图（图118-7）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131059785.png" alt="image-20240913105934654"></p>
<p>添加完成之后还需要使用chmod 命令赋予两个脚本的可执行权限，如下图（图118-8）所示:</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131059850.png" alt="image-20240913105946724"></p>
<p>至此关于udev 自动挂载U 盘的相关配置文件完成了，首先输入以下df 命令查看当前的挂载情况，如下图（图118-9）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131100699.png" alt="image-20240913110007561"></p>
<p>可以看到当前并没有关于U 盘相关的挂载信息，然后插入U 盘，相关打印如下（图118-10）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131100173.png"></p>
<p>然后重新使用df 命令查看当前的挂载情况，如下图（图118-11）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131100866.png" alt="image-20240913110032725"></p>
<p>可以看到U 盘sda1 就成功挂载到了/mnt 目录，然后拔掉U 盘，重新使用df 命令查看当前挂载情况，可以发现/dev/sda1 设备已经消失了，如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131100602.png" alt="image-20240913110044454"></p>
<p>至此，使用udev 自动挂载U 盘实验就完成了。</p>
<h3 id="118-3-使用udev-挂载TF-卡"><a href="#118-3-使用udev-挂载TF-卡" class="headerlink" title="118.3 使用udev 挂载TF 卡"></a>118.3 使用udev 挂载TF 卡</h3><p>本小节编写完成的文件对应的网盘路径为：<code>iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568 开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程04_Linux 驱动程序\82_udev_u 盘_TF 卡\TF 卡</code>。<br>在上一个小节中我们实现了U 盘的自动挂载，而为了帮助同学们举一反三，本小节要使用udev 实现TF 卡的自动挂载，将TF 卡挂载到/mnt 目录下，在不做任何修改的情况下，直接插入TF 卡，会发现TF 卡直接挂载到了/mnt/sdcard 目录，如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131101981.png" alt="image-20240913110126840"></p>
<p>这是因为在/lib/udev/rules.d 目录下已经帮我们添加了很多的udev 规则，如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131101793.png" alt="image-20240913110142631"></p>
<p>这里的规则文件跟我们上一小节自己创建的规则文件所实现的作用是相同的，只是/etc/udev/rules.d/目录的规则文件比/lib/udev/rules.d 目录的规则文件优先级高。<br>所以要实现TF 卡自动挂载到/mnt 命令让就需要进入到/etc/udev/rules.d/目录下，这次我们创建一个名为002.rules 的文件，如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131102019.png" alt="image-20240913110200894"></p>
<p>然后向该文件中添加以下内容：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">KERNEL<span class="token operator">==</span><span class="token string">"mmcblk[0-9]p[0-9]"</span><span class="token punctuation">,</span> SUBSYSTEM<span class="token operator">==</span><span class="token string">"block"</span><span class="token punctuation">,</span> ACTION<span class="token operator">==</span><span class="token string">"add"</span><span class="token punctuation">,</span> RUN<span class="token operator">+=</span><span class="token string">"/etc/udev/rules.d/tf/tf-add.sh %k"</span>
SUBSYSTEM<span class="token operator">==</span><span class="token string">"block"</span><span class="token punctuation">,</span> ACTION<span class="token operator">==</span><span class="token string">"remove"</span><span class="token punctuation">,</span> RUN<span class="token operator">+=</span><span class="token string">"/etc/udev/rules.d/tf/tf-remove.sh"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><strong>（1）<code>KERNEL=="sd[a-z][0-9]"</code></strong><br>KERNEL：表示匹配设备的内核名。<br><code>"sd[a-z][0-9]"</code>：是一个正则表达式模式，sd：表示设备名以”sd” 开头，[a-z]：表示设备名的第三个字符是小写字母，[0-9]：表示设备名的第四个字符是数字。<br>这个模式用于匹配USB 存储设备的块设备节点，如/dev/sda1、/dev/sdb2 等。</p>
<p><strong><code>（2）SUBSYSTEM=="block"</code></strong><br>SUBSYSTEM：表示匹配设备的子系统名称。<br>“block”：表示设备的子系统是块设备子系统，即与磁盘、分区等相关的设备。<br>这部分规则是为了确保只匹配块设备子系统下的设备。</p>
<p><strong><code>（3）ACTION=="add"和ACTION=="remove"</code></strong><br>ACTION：表示匹配设备的动作。<br>“add”：表示设备被添加。<br>“remove”：表示设备被yichu。<br>这部分规则是为了处理设备被添加和被删除的事件。</p>
<p><strong><code>（5）RUN+="/etc/udev/rules.d/usb/usb-add.sh %k"</code></strong><br>RUN+=”…”：表示在匹配的设备上执行指定的命令。<br><code>"/etc/udev/rules.d/usb/usb-add.sh"</code>：是要执行的命令的路径，即在设备添加时执行<code>/etc/udev/rules.d/usb/usb-add.sh</code> 脚本文件。<br><code>%k</code>：是Udev 提供的一个变量，表示匹配的设备的内核名。</p>
<p>当TF 卡块设备被添加的时候会执行<code>/etc/udev/rules.d/usb/tf-add.sh</code> 脚本，TF 卡块设备被删除的时候会执行<code>/etc/udev/rules.d/tf/tf-remove.sh</code> 脚本，所以接下来我们要完善这两个脚本内容，首先在<code>/etc/udev/rules.d/</code>目录下创建名为<code>tf</code> 的文件夹，并在这个创建tf-add.sh 和tf-remove.sh 脚本，如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131105175.png"></p>
<p>然后在<code>/etc/udev/rules.d/usb/tf-add.sh</code> 文件中写入以下内容：</p>
<pre class="line-numbers language-none"><code class="language-none">#!/bin/sh
/bin/mount -t vfat /dev/$1 /mnt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>在<code>/etc/udev/rules.d/usb/tf-remove.sh</code> 文件中写入以下内容：</p>
<pre class="line-numbers language-none"><code class="language-none">#!/bin/sh
sync
/bin/umount -l /mnt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>添加完成如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131106432.png" alt="image-20240913110648301"></p>
<p>添加完成之后还需要使用chmod 命令赋予两个脚本的可执行权限，如下图所示:</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131107912.png" alt="image-20240913110701785"></p>
<p>至此关于udev 自动挂载TF 卡的相关配置文件完成了，首先输入以下df 命令查看当前的挂载情况，如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131107340.png" alt="image-20240913110713200"></p>
<p>可以看到当前并没有关于TF 卡相关的挂载信息，然后插入U 盘，相关打印如下所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131107677.png" alt="image-20240913110722518"></p>
<p>然后重新使用df 命令查看当前的挂载情况，如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131107739.png" alt="image-20240913110740595"></p>
<p>可以看到TF 卡mmcblk1p1 就成功挂载到了/mnt 目录，然后拔掉U 盘，重新使用df 命令查看当前挂载情况，可以发现/dev/mmcblk1p1 设备已经消失了，如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131107373.png" alt="image-20240913110754231"></p>
<p>至此，使用udev 自动挂载TF 卡的实验就完成了。</p>
<h2 id="第119-章使用mdev-挂载U-盘和T-卡实验"><a href="#第119-章使用mdev-挂载U-盘和T-卡实验" class="headerlink" title="第119 章使用mdev 挂载U 盘和T 卡实验"></a>第119 章使用mdev 挂载U 盘和T 卡实验</h2><p>在上一个章节中使用udev 实现了U 盘和TF 卡的自动挂载，本章节将使用mdev 来实现U盘和TF 卡的自动挂载。</p>
<h3 id="119-1-配置buildroot-文件系统支持mdev"><a href="#119-1-配置buildroot-文件系统支持mdev" class="headerlink" title="119.1 配置buildroot 文件系统支持mdev"></a>119.1 配置buildroot 文件系统支持mdev</h3><p>在上一章我们配置buildroot 文件系统支持了udev，而要想buildroot 系统支持mdev 也需要进行相似的配置。首先来到buildroot 的源码目录下，如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131108114.png" alt="image-20240913110832982"></p>
<p>然后使用以下命令加载rk3568 的默认配置文件并进入到图形化配置界面，如下图所示：</p>
<pre class="line-numbers language-none"><code class="language-none">make rockchip_rk3568_defconfig
make menuconfig<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131108972.png" alt="image-20240913110850797"></p>
<p>由于本章节使用的是mdev 所以需要在在System configuration 菜单中， 选择<code>/devmanagement (Dynamic using devtmpfs + mdev) ---&gt;</code> ，如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131109430.png" alt="image-20240913110917246"></p>
<p>除了buildroot 需要配置之外，还需要配置busybox 的相关选项，默认已经配置好了，如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131109953.png" alt="image-20240913110931778"></p>
<p>编译完成的镜像已经放在了“<code>iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动程序\83_mdev_u 盘_TF 卡</code>”目录下如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131109709.png" alt="image-20240913110952583"></p>
<p>烧写该镜像之后，可以在串口终端输入以下命令来查看mdev 是否已经启用了，如下图所示：</p>
<pre class="line-numbers language-none"><code class="language-none">ps -aux | grep -nR mdev<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131110119.png" alt="image-20240913111013990"></p>
<p>检查到/sbin/mdev 进程就表示当前系统使用的是mdev，至此配置buildroot 文件系统支持mdev 就完成了。</p>
<h3 id="119-2-使用mdev-挂载U-盘"><a href="#119-2-使用mdev-挂载U-盘" class="headerlink" title="119.2 使用mdev 挂载U 盘"></a>119.2 使用mdev 挂载U 盘</h3><p>本小节编写完成的文件对应的网盘路径为：<code>iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568 开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程04_Linux 驱动程序\83_mdev_u 盘_TF 卡\U 盘</code>。</p>
<p>跟udev 相同，mdev 也需要添加相应的规则，不同的是mdev 使用/etc/mdev.conf 文件来配置mdev 工具的规则和行为，要想使用mdev 自动挂载U 盘需要向/etc/mdev.conf 文件中添加以下两条规则，</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sd<span class="token punctuation">[</span>a-z<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span>-9<span class="token punctuation">]</span> <span class="token number">0</span>:0 <span class="token number">666</span> @/etc/mdev/usb_insert.sh
sd<span class="token punctuation">[</span>a-z<span class="token punctuation">]</span> <span class="token number">0</span>:0 <span class="token number">666</span> $/etc/mdev/usb_remove.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>这两个规则用于处理U 盘的热插拔事件，并执行相应的操作。在/etc/mdev.conf 文件中，每一行都是一个规则，具有以下格式：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token operator">&lt;</span>设备节点正则表达式<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>设备的所有者<span class="token operator">:</span>设备的所属组<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>设备的权限<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>设备插入或移除时需要执行的命令<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>下面是对上述两个规则的详细介绍：<br>（1）<code>sd[a-z][0-9]</code> 是一个正则表达式模式，用于匹配以”sd” 开头，后跟一个小写字母和一个数字的设备节点，例如/dev/sda1、/dev/sdb2 等。<br>（2）<code>0:0 666</code> 表示设置设备节点的所有者和权限。0:0 表示所有者和所属组的用户ID 和组ID 均为0，即root 用户。666 表示权限为可读可写。<br>（3）<code>@/etc/mdev/usb_insert.sh</code> 表示当符合规则的设备插入时，mdev 会执行/etc/mdev/usb_insert.sh 脚本。@ 符号表示执行的是一个shell 命令。<br>（4）<code>$/etc/mdev/usb_remove.sh</code> 表示当符合规则的设备移除时，mdev 会执行/etc/mdev/usb_remove.sh 脚本。$ 符号表示执行的是一个内部命令。</p>
<p>规则添加完成之后就要去对应的目录下添加<code>usb_insert.sh</code> 和<code>usb_remove.sh</code> 脚本文件了，首先创建/etc/mdev 目录并进入到该目录创建usb_insert.sh 和usb_remove.sh 两个文件如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131113589.png" alt="image-20240913111348448"></p>
<p>然后在/etc/mdev/usb_insert.sh 文件中写入以下内容：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-d</span> /sys/block/*/<span class="token variable">$MDEV</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token function">mount</span> /dev/<span class="token variable">$MDEV</span> /mnt
    <span class="token function">sync</span>
<span class="token keyword">fi</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在/etc/mdev/usb_remove.sh 文件中写入以下内容：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>
<span class="token function">sync</span>
/bin/umount <span class="token parameter variable">-l</span> /mnt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>添加完成如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131116372.png" alt="image-20240913111610230"></p>
<p>添加完成之后还需要使用chmod 命令赋予两个脚本的可执行权限，如下图所示:</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131116707.png" alt="image-20240913111630575"></p>
<p>至此关于mdev 自动挂载U 盘的相关配置文件完成了，首先输入以下df 命令查看当前的挂载情况，如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131116075.png" alt="image-20240913111641937"></p>
<p>可以看到当前并没有关于U 盘相关的挂载信息，然后插入U 盘，相关打印如下所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131116236.png" alt="image-20240913111650025"></p>
<p>然后重新使用df 命令查看当前的挂载情况，如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131117305.png" alt="image-20240913111700161"></p>
<p>可以看到U 盘sda1 就成功挂载到了/mnt 目录，然后拔掉U 盘，重新使用df 命令查看当前挂载情况，可以发现/dev/sda1 设备已经消失了，如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131117325.png" alt="image-20240913111710186"></p>
<p>至此，使用mdev 自动挂载U 盘实验就完成了。</p>
<h3 id="119-3-使用mdev-挂载TF-卡"><a href="#119-3-使用mdev-挂载TF-卡" class="headerlink" title="119.3 使用mdev 挂载TF 卡"></a>119.3 使用mdev 挂载TF 卡</h3><p>本小节编写完成的文件对应的网盘路径为：<code>iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568 开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程04_Linux 驱动程序\83_mdev_u 盘_TF 卡\TF 卡</code>。</p>
<p>在上一个小节中我们实现了U 盘的自动挂载，而为了帮助同学们举一反三，本小节要使用mdev 实现TF 卡的自动挂载,跟U 盘自动挂载相同，TF 卡自动挂载也需要向<code>/etc/mdev.conf</code> 文件中添加以下两条类似的规则，</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mmcblk<span class="token punctuation">[</span><span class="token number">0</span>-9<span class="token punctuation">]</span>p<span class="token punctuation">[</span><span class="token number">0</span>-9<span class="token punctuation">]</span> <span class="token number">0</span>:0 <span class="token number">666</span> @/etc/mdev/tf_insert.sh
mmcblk<span class="token punctuation">[</span><span class="token number">0</span>-9<span class="token punctuation">]</span> <span class="token number">0</span>:0 <span class="token number">666</span> $/etc/mdev/tf_remove.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>这两个规则用于处理U 盘的热插拔事件，并执行相应的操作。在/etc/mdev.conf 文件中，每一行都是一个规则，具有以下格式：</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;设备节点正则表达式&gt; &lt;设备的所有者:设备的所属组&gt; &lt;设备的权限&gt; &lt;设备插入或移除时需要执行的命令&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>下面是对上述两个规则的详细介绍：<br>（1）<code>mmcblk[0-9]p[0-9]</code> 是一个正则表达式模式，用于匹配以”mmcblk” 开头的TF 卡块设备，例如/dev/mmcblk1p1 等。<br>（2）<code>0:0 666</code> 表示设置设备节点的所有者和权限。0:0 表示所有者和所属组的用户ID 和组ID 均为0，即root 用户。666 表示权限为可读可写。<br>（5）<code>@/etc/mdev/tf_insert.sh</code> 表示当符合规则的设备插入时，mdev 会执行/etc/mdev/tf_insert.sh 脚本。@ 符号表示执行的是一个shell 命令。<br>（6）<code>$/etc/mdev/tf_remove.sh</code> 表示当符合规则的设备移除时，mdev 会执行/etc/mdev/tf_remove.sh 脚本。$ 符号表示执行的是一个内部命令。</p>
<p>规则添加完成之后就要去对应的目录下添加<code>tf_insert.sh</code> 和<code>tf_remove.sh</code> 脚本文件了，首先进入到<code>/etc/mdev</code> 目录创建<code>tf_insert.sh</code> 和<code>tf_remove.sh</code> 两个文件如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131124444.png" alt="image-20240913112418311"></p>
<p>然后在<code>/etc/mdev/tf_insert.sh</code> 文件中写入以下内容：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-d</span> /sys/block/*/<span class="token variable">$MDEV</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token function">mount</span> /dev/<span class="token variable">$MDEV</span> /mnt
    <span class="token function">sync</span>
<span class="token keyword">fi</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在<code>/etc/mdev/tf_remove.sh</code> 文件中写入以下内容：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>
<span class="token function">sync</span>
/bin/umount <span class="token parameter variable">-l</span> /mnt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>添加完成如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131126067.png" alt="image-20240913112649922"></p>
<p>添加完成之后还需要使用chmod 命令赋予两个脚本的可执行权限，如下图所示:</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131127331.png" alt="image-20240913112708195"></p>
<p>至此关于mdev 自动挂载TF 卡的相关配置文件完成了，首先输入以下df 命令查看当前的挂载情况，如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131127323.png" alt="image-20240913112722183"></p>
<p>可以看到当前并没有关于TF 卡相关的挂载信息，然后插入TF 卡，相关打印如下所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131127086.png" alt="image-20240913112737923"></p>
<p>然后重新使用df 命令查看当前的挂载情况，如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131127566.png" alt="image-20240913112747421"></p>
<p>可以看到TF 卡mmcblk1p1 就成功挂载到了/mnt 目录，然后拔掉TF 卡，重新使用df 命令查看当前挂载情况，可以发现/dev/mmcblk1p1 设备已经消失了，如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131128101.png" alt="image-20240913112803957"></p>
<p>虽然TF 卡设备已经消失了，但是又出现了一个/dev/mmcblk0p8 的设备挂载到了/mnt 目录，这里是正常的，mmcblk0p8 是emmc 里的一个分区，也符合上面我们添加的热插拔规则。<br>至此，使用mdev 自动挂载TF 卡实验就完成了。</p>
<h1 id="第十一篇pinctrl-子系统"><a href="#第十一篇pinctrl-子系统" class="headerlink" title="第十一篇pinctrl 子系统"></a>第十一篇pinctrl 子系统</h1><h2 id="第120-章pinctrl-子系统的引入"><a href="#第120-章pinctrl-子系统的引入" class="headerlink" title="第120 章pinctrl 子系统的引入"></a>第120 章pinctrl 子系统的引入</h2><p>Linux 中的pinctrl 子系统（Pin Control Subsystem）是一个用于管理和配置通用输入/输出（GPIO）引脚的框架。它提供了一种标准化的方法，以在Linux 内核中对GPIO 引脚进行配置、分配和控制，从而适应不同的硬件平台和设备。</p>
<p>pinctrl 子系统也符合Linux 内核的设备模型规范，所以pinctrl 子系统同样可以根据设备模型规范分为设备、驱动、总线和类四个部分，本章节将从设备和驱动两个部分来引入pinctrl子系统。</p>
<h3 id="120-1-pinctrl-设备树"><a href="#120-1-pinctrl-设备树" class="headerlink" title="120.1 pinctrl 设备树"></a>120.1 pinctrl 设备树</h3><p>在前面设备树相关的章节中已经对pinctrl 节点的编写和使用进行了讲解，设备树的pinctrl可以分为客户端和服务端两个部分，在pinctrl 客户端可以指定引脚描述、引脚组描述和配置描述，以满足其特定的功能和需求，不同厂商在客户端内容的编写格式是相同的。服务端是指提供GPIO 引脚配置的pinctrl 设备树节点，它是描述GPIO 引脚配置和使用规则的节点，定义了一组GPIO 引脚的配置选项，以及这些选项对应的引脚功能和电气特性。</p>
<p>接下来对rk3568 的pinctrl 设备树进行详细的讲解。首先在rk3568.dtsi 设备树根节点下找到pinctrl 节点，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">pinctrl<span class="token operator">:</span> pinctrl <span class="token punctuation">{</span>
    compatible <span class="token operator">=</span> <span class="token string">"rockchip,rk3568-pinctrl"</span><span class="token punctuation">;</span>
    rockchip<span class="token punctuation">,</span>grf <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>grf<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    rockchip<span class="token punctuation">,</span>pmu <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>pmugrf<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    ranges<span class="token punctuation">;</span>
    gpio0<span class="token operator">:</span> gpio@fdd60000 <span class="token punctuation">{</span>
        compatible <span class="token operator">=</span> <span class="token string">"rockchip,gpio-bank"</span><span class="token punctuation">;</span>
        reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x0</span> <span class="token number">0xfdd60000</span> <span class="token number">0x0</span> <span class="token number">0x100</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span>GIC_SPI <span class="token number">33</span> IRQ_TYPE_LEVEL_HIGH<span class="token operator">&gt;</span><span class="token punctuation">;</span>
        clocks <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>pmucru PCLK_GPIO0<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>pmucru DBCLK_GPIO0<span class="token operator">&gt;</span><span class="token punctuation">;</span>
        gpio<span class="token operator">-</span>controller<span class="token punctuation">;</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">gpio</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
        gpio<span class="token operator">-</span>ranges <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>pinctrl <span class="token number">0</span> <span class="token number">0</span> <span class="token number">32</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        interrupt<span class="token operator">-</span>controller<span class="token punctuation">;</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">interrupt</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    gpio1<span class="token operator">:</span> gpio@fe740000 <span class="token punctuation">{</span>
        compatible <span class="token operator">=</span> <span class="token string">"rockchip,gpio-bank"</span><span class="token punctuation">;</span>
        reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x0</span> <span class="token number">0xfe740000</span> <span class="token number">0x0</span> <span class="token number">0x100</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span>GIC_SPI <span class="token number">34</span> IRQ_TYPE_LEVEL_HIGH<span class="token operator">&gt;</span><span class="token punctuation">;</span>
        clocks <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>cru PCLK_GPIO1<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>cru DBCLK_GPIO1<span class="token operator">&gt;</span><span class="token punctuation">;</span>
        gpio<span class="token operator">-</span>controller<span class="token punctuation">;</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">gpio</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
        gpio<span class="token operator">-</span>ranges <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>pinctrl <span class="token number">0</span> <span class="token number">32</span> <span class="token number">32</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        interrupt<span class="token operator">-</span>controller<span class="token punctuation">;</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">interrupt</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    gpio2<span class="token operator">:</span> gpio@fe750000 <span class="token punctuation">{</span>
        compatible <span class="token operator">=</span> <span class="token string">"rockchip,gpio-bank"</span><span class="token punctuation">;</span>
        reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x0</span> <span class="token number">0xfe750000</span> <span class="token number">0x0</span> <span class="token number">0x100</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span>GIC_SPI <span class="token number">35</span> IRQ_TYPE_LEVEL_HIGH<span class="token operator">&gt;</span><span class="token punctuation">;</span>
        clocks <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>cru PCLK_GPIO2<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>cru DBCLK_GPIO2<span class="token operator">&gt;</span><span class="token punctuation">;</span>
        gpio<span class="token operator">-</span>controller<span class="token punctuation">;</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">gpio</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
        gpio<span class="token operator">-</span>ranges <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>pinctrl <span class="token number">0</span> <span class="token number">64</span> <span class="token number">32</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        interrupt<span class="token operator">-</span>controller<span class="token punctuation">;</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">interrupt</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    gpio3<span class="token operator">:</span> gpio@fe760000 <span class="token punctuation">{</span>
        compatible <span class="token operator">=</span> <span class="token string">"rockchip,gpio-bank"</span><span class="token punctuation">;</span>
        reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x0</span> <span class="token number">0xfe760000</span> <span class="token number">0x0</span> <span class="token number">0x100</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span>GIC_SPI <span class="token number">36</span> IRQ_TYPE_LEVEL_HIGH<span class="token operator">&gt;</span><span class="token punctuation">;</span>
        clocks <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>cru PCLK_GPIO3<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>cru DBCLK_GPIO3<span class="token operator">&gt;</span><span class="token punctuation">;</span>
        gpio<span class="token operator">-</span>controller<span class="token punctuation">;</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">gpio</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
        gpio<span class="token operator">-</span>ranges <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>pinctrl <span class="token number">0</span> <span class="token number">96</span> <span class="token number">32</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        interrupt<span class="token operator">-</span>controller<span class="token punctuation">;</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">interrupt</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    gpio4<span class="token operator">:</span> gpio@fe770000 <span class="token punctuation">{</span>
        compatible <span class="token operator">=</span> <span class="token string">"rockchip,gpio-bank"</span><span class="token punctuation">;</span>
        reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x0</span> <span class="token number">0xfe770000</span> <span class="token number">0x0</span> <span class="token number">0x100</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span>GIC_SPI <span class="token number">37</span> IRQ_TYPE_LEVEL_HIGH<span class="token operator">&gt;</span><span class="token punctuation">;</span>
        clocks <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>cru PCLK_GPIO4<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>cru DBCLK_GPIO4<span class="token operator">&gt;</span><span class="token punctuation">;</span>
        gpio<span class="token operator">-</span>controller<span class="token punctuation">;</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">gpio</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
        gpio<span class="token operator">-</span>ranges <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>pinctrl <span class="token number">0</span> <span class="token number">128</span> <span class="token number">32</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        interrupt<span class="token operator">-</span>controller<span class="token punctuation">;</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">interrupt</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"rk3568-pinctrl.dtsi"</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在上面的pinctrl 节点中，描述了RK3568 GPIO 控制器的配置和使用方式，pinctrl 节点总共描述了五个GPIO 控制器，分别是gpio0、gpio1、gpio2、gpio3 和gpio4。通过这些GPIO 控制器节点，可以在设备树中配置和控制RK3568 芯片上的GPIO 引脚，包括设置引脚功能、中断处理等。</p>
<p>在设备树的最下方通过include 包含了rk3568-pinctrl.dtsi 设备树，该设备树中包含了所有复用功能的配置，具体内容如下所示（更具体的内容描述可以回顾设备树pinctrl 章节内容）：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131146538.png" alt="image-20240913114659357"></p>
<p>无论是rk3568.dtsi 设备树中的pinctrl 节点，还是上面rk3568-pinctrl.dtsi 设备树中的一系列复用关系都是由瑞芯微原厂BSP 工程师编写的，我们只需知道如何使用即可，而pinctrl 客户端设备树是由我们自己根据特定需求来编写的，具体可以回顾前面设备树相关的章节，这里就不再进行赘述。</p>
<p>设备树中存放的只是设备的描述信息，而具体的功能实现取决于相应的pinctrl 驱动，根据rk3568.dtsi 设备树中pinctrl 节点的compatible 属性进行查找，可以查找到pinctrl 的驱动文件是内核源码的“/driver/pinctrl/pinctrl-rockchip.c”，如下所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409131147637.png" alt="image-20240913114741501"></p>
<p>在下个小节中将对pinctrl 的驱动部分进行简单的介绍。</p>
<h3 id="120-2-pinctrl-驱动"><a href="#120-2-pinctrl-驱动" class="headerlink" title="120.2 pinctrl 驱动"></a>120.2 pinctrl 驱动</h3><p>首先进入到内核源码目录下的“/drivers/pinctrl/pinctrl-rockchip.c”驱动文件中，找到驱动的入口函数，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">platform_driver</span> rockchip_pinctrl_driver <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>probe <span class="token operator">=</span> rockchip_pinctrl_probe<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>driver <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"rockchip-pinctrl"</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>pm <span class="token operator">=</span> <span class="token operator">&amp;</span>rockchip_pinctrl_dev_pm_ops<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>of_match_table <span class="token operator">=</span> rockchip_pinctrl_dt_match<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">rockchip_pinctrl_drv_register</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">platform_driver_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rockchip_pinctrl_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">postcore_initcall</span><span class="token punctuation">(</span>rockchip_pinctrl_drv_register<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">rockchip_pinctrl_drv_unregister</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">platform_driver_unregister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rockchip_pinctrl_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看到pinctrl 驱动使用的是platform 总线，当设备和驱动匹配成功之后会进入<code>rockchip_pinctrl_probe</code> 函数进行初始化，probe 函数的具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">rockchip_pinctrl_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">rockchip_pinctrl</span> <span class="token operator">*</span>info<span class="token punctuation">;</span> <span class="token comment">// Rockchip GPIO 控制器的信息结构体指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev <span class="token operator">=</span> <span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">;</span> <span class="token comment">// 设备结构体指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">rockchip_pin_ctrl</span> <span class="token operator">*</span>ctrl<span class="token punctuation">;</span> <span class="token comment">// Rockchip GPIO 控制器的配置结构体指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np <span class="token operator">=</span> pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>of_node<span class="token punctuation">,</span> <span class="token operator">*</span>node<span class="token punctuation">;</span> <span class="token comment">// 设备节点指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">resource</span> <span class="token operator">*</span>res<span class="token punctuation">;</span> <span class="token comment">// 设备资源指针</span>
    <span class="token keyword">void</span> __iomem <span class="token operator">*</span>base<span class="token punctuation">;</span> <span class="token comment">// 寄存器基地址指针</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span> <span class="token comment">// 返回值</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dev<span class="token operator">-&gt;</span>of_node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dev_err</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"device tree node not found\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 分配并初始化一个rockchip_pinctrl 结构体</span>
    info <span class="token operator">=</span> <span class="token function">devm_kzalloc</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>info<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>info<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
    
    info<span class="token operator">-&gt;</span>dev <span class="token operator">=</span> dev<span class="token punctuation">;</span>
    
    <span class="token comment">// 获取并设置与pdev 相关的rockchip_pin_ctrl 结构体</span>
    ctrl <span class="token operator">=</span> <span class="token function">rockchip_pinctrl_get_soc_data</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> pdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctrl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dev_err</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"driver data not available\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    info<span class="token operator">-&gt;</span>ctrl <span class="token operator">=</span> ctrl<span class="token punctuation">;</span>
    
    <span class="token comment">// 解析设备树中的"rockchip,grf"节点，获取寄存器映射基地址</span>
    node <span class="token operator">=</span> <span class="token function">of_parse_phandle</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> <span class="token string">"rockchip,grf"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        info<span class="token operator">-&gt;</span>regmap_base <span class="token operator">=</span> <span class="token function">syscon_node_to_regmap</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>regmap_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>regmap_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果找不到"rockchip,grf"节点，则获取IORESOURCE_MEM 类型的资源，得到寄存器基地址</span>
        res <span class="token operator">=</span> <span class="token function">platform_get_resource</span><span class="token punctuation">(</span>pdev<span class="token punctuation">,</span> IORESOURCE_MEM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        base <span class="token operator">=</span> <span class="token function">devm_ioremap_resource</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 配置寄存器映射的最大寄存器地址和名称</span>
        rockchip_regmap_config<span class="token punctuation">.</span>max_register <span class="token operator">=</span> <span class="token function">resource_size</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">;</span>
        rockchip_regmap_config<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"rockchip,pinctrl"</span><span class="token punctuation">;</span>
        info<span class="token operator">-&gt;</span>regmap_base <span class="token operator">=</span> <span class="token function">devm_regmap_init_mmio</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> base<span class="token punctuation">,</span><span class="token operator">&amp;</span>rockchip_regmap_config<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 检查旧的dt-bindings</span>
        info<span class="token operator">-&gt;</span>reg_size <span class="token operator">=</span> <span class="token function">resource_size</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 如果控制器类型为RK3188 且reg_size 小于0x200，则获取第二个IORESOURCE_MEM 类型的资源，作为pull 寄存器的基地址</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ctrl<span class="token operator">-&gt;</span>type <span class="token operator">==</span> RK3188 <span class="token operator">&amp;&amp;</span> info<span class="token operator">-&gt;</span>reg_size <span class="token operator">&lt;</span> <span class="token number">0x200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res <span class="token operator">=</span> <span class="token function">platform_get_resource</span><span class="token punctuation">(</span>pdev<span class="token punctuation">,</span> IORESOURCE_MEM<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            base <span class="token operator">=</span> <span class="token function">devm_ioremap_resource</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">// 配置pull 寄存器映射的最大寄存器地址和名称</span>
            rockchip_regmap_config<span class="token punctuation">.</span>max_register <span class="token operator">=</span><span class="token function">resource_size</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">;</span>
            rockchip_regmap_config<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"rockchip,pinctrl-pull"</span><span class="token punctuation">;</span>
            info<span class="token operator">-&gt;</span>regmap_pull <span class="token operator">=</span> <span class="token function">devm_regmap_init_mmio</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span>base<span class="token punctuation">,</span><span class="token operator">&amp;</span>rockchip_regmap_config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 尝试查找可选的pmu syscon 引用</span>
    node <span class="token operator">=</span> <span class="token function">of_parse_phandle</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> <span class="token string">"rockchip,pmu"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        info<span class="token operator">-&gt;</span>regmap_pmu <span class="token operator">=</span> <span class="token function">syscon_node_to_regmap</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>regmap_pmu<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>regmap_pmu<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 对于某些SoC 进行特殊处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctrl<span class="token operator">-&gt;</span>soc_data_init<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ret <span class="token operator">=</span> ctrl<span class="token operator">-&gt;</span><span class="token function">soc_data_init</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
            <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 注册rockchip_pinctrl 设备</span>
    ret <span class="token operator">=</span> <span class="token function">rockchip_pinctrl_register</span><span class="token punctuation">(</span>pdev<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    
    <span class="token comment">// 设置pdev 的私有数据为info</span>
    <span class="token function">platform_set_drvdata</span><span class="token punctuation">(</span>pdev<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 注册GPIO 设备</span>
    ret <span class="token operator">=</span> <span class="token function">of_platform_populate</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> rockchip_bank_match<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dev_err</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"failed to register gpio device\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">dev_info</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"probed %s\n"</span><span class="token punctuation">,</span> <span class="token function">dev_name</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面Probe 函数的作用是初始化和配置<code>Rockchip GPIO</code> 控制器，并将相关信息存储在<code>rockchip_pinctrl</code> 结构体中，最后注册相关设备和GPIO 接口，关于Probe 函数会在后面的小节中进行更加具体的分析。</p>
<p>最后来带领大家思考一个问题，<strong>假如我们要配置一个LED 外设，该LED 需要使用一个管脚来进行控制，那这个控制引脚需要复用成GPIO 之后才能完成相应的功能</strong>，通过上面内容的学习之后，<strong>我们知道是pinctrl 子系统将这个管脚复用为了GPIO 功能，那pinctrl 子系统是什么时候对该引脚进行的复用呢？</strong>带着这个疑问，让我们一起进入后面章节的学习吧。</p>
<h2 id="第121-章pinctrl-probe-函数讲解"><a href="#第121-章pinctrl-probe-函数讲解" class="headerlink" title="第121 章pinctrl probe 函数讲解"></a>第121 章pinctrl probe 函数讲解</h2><p>由于pinctrl 驱动的probe 函数理解起来较为复杂，所以在讲解pinctrl 驱动的probe 函数之前，我们先来了解一些与pinctrl 相关的数据结构，本章首先会学习pinctrl_desc 结构体和rockchip_pinctrl 结构体，最后对pinctrl probe 函数进行分析。</p>
<h3 id="121-1-pinctrl-desc-结构体分析"><a href="#121-1-pinctrl-desc-结构体分析" class="headerlink" title="121.1 pinctrl_desc 结构体分析"></a>121.1 pinctrl_desc 结构体分析</h3><p>pinctrl_desc 结构体用于描述引脚控制器（pinctrl）的属性和操作。引脚控制器是硬件系统中的一个组件，用于管理和控制引脚的功能和状态。pinctrl_desc 结构体的作用是提供一个统一的接口，用于配置和管理引脚控制器的行为。pinctrl_desc 结构体定义在内核源码目录的“<code>/include/linux/pinctrl/pinctrl.h</code>”文件中，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">pinctrl_desc</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span> <span class="token comment">// 引脚控制器的名称</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl_pin_desc</span> <span class="token operator">*</span>pins<span class="token punctuation">;</span> <span class="token comment">// 引脚描述符数组</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> npins<span class="token punctuation">;</span> <span class="token comment">// 引脚描述符数组的大小</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl_ops</span> <span class="token operator">*</span>pctlops<span class="token punctuation">;</span> <span class="token comment">// 引脚控制操作函数指针</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pinmux_ops</span> <span class="token operator">*</span>pmxops<span class="token punctuation">;</span> <span class="token comment">// 引脚复用操作函数指针</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pinconf_ops</span> <span class="token operator">*</span>confops<span class="token punctuation">;</span> <span class="token comment">// 引脚配置操作函数指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>owner<span class="token punctuation">;</span> <span class="token comment">// 拥有该结构体的模块</span>
    
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_GENERIC_PINCONF</span></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> num_custom_params<span class="token punctuation">;</span> <span class="token comment">// 自定义参数数量</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pinconf_generic_params</span> <span class="token operator">*</span>custom_params<span class="token punctuation">;</span> <span class="token comment">// 自定义参数数组</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pin_config_item</span> <span class="token operator">*</span>custom_conf_items<span class="token punctuation">;</span> <span class="token comment">// 自定义配置项数组</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>（1）const char *name: 引脚控制器的名称，用于标识引脚控制器的唯一性。</li>
<li>（2）const struct pinctrl_pin_desc *pins: 引脚描述符数组，是一个指向引脚描述符的指针，用于描述引脚的属性和配置。每个引脚描述符包含了引脚的名称、编号、模式等信息。</li>
<li>（3）unsigned int npins: 表示引脚描述符数组中元素的数量，用于确定引脚描述符数组的长度。</li>
<li>（4）const struct pinctrl_ops *pctlops: 指向引脚控制操作函数的指针，用于定义引脚控制器的操作接口。通过这些操作函数，可以对引脚进行配置、使能、禁用等操作。</li>
<li>（5）const struct pinmux_ops *pmxops: 指向引脚复用操作函数的指针，用于定义引脚的复用功能。复用功能允许将引脚的功能切换为不同的模式，以适应不同的设备需求。</li>
<li>（6）const struct pinconf_ops *confops: 指向引脚配置操作函数的指针，用于定义引脚的其他配置选项。这些配置选项可以包括引脚的上拉、下拉配置、电气特性等。</li>
<li>（7）struct module *owner: 指向拥有该引脚控制器结构体的模块的指针。这个字段用于跟踪引脚控制器结构体的所有者。</li>
<li>（8）unsigned int num_custom_params: 表示自定义配置参数的数量，用于描述引脚控制器的自定义配置参数。</li>
<li>（9）const struct pinconf_generic_params *custom_params: 指向自定义配置参数的指针，用于描述引脚控制器的自定义配置参数的属性。自定义配置参数可以根据具体需求定义，用于扩展引脚控制器的配置选项。</li>
<li>（10）const struct pin_config_item *custom_conf_items: 指向自定义配置项的指针，用于描述引脚控制器的自定义配置项的属性。自定义配置项可以根据具体需求定义，用于扩展引脚控制器的配置选项。</li>
</ul>
<h3 id="121-2-rockchip-pinctrl-结构体分析"><a href="#121-2-rockchip-pinctrl-结构体分析" class="headerlink" title="121.2 rockchip_pinctrl 结构体分析"></a>121.2 rockchip_pinctrl 结构体分析</h3><p>而瑞芯微为了适应瑞芯微芯片的特定需求和功能，对<code>struct pinctrl_desc</code> 进行了再一次封装。封装后的<code>struct rockchip_pinctrl</code> 结构体在<code>struct pinctrl_desc</code> 的基础上增加了与瑞芯微芯片相关的字段和指针，这种封装可以提供更好的集成性、易用性和扩展性，同时保持与通用引脚控制器框架的兼容性。<br>rockchip_pinctrl 结构体定义在内核源码目录下的“<code>/drivers/pinctrl/pinctrl-rockchip.h</code>”文件中，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">rockchip_pinctrl</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">regmap</span> <span class="token operator">*</span>regmap_base<span class="token punctuation">;</span> <span class="token comment">// 基本寄存器映射指针</span>
    <span class="token keyword">int</span> reg_size<span class="token punctuation">;</span> <span class="token comment">// 寄存器大小</span>
    <span class="token keyword">struct</span> <span class="token class-name">regmap</span> <span class="token operator">*</span>regmap_pull<span class="token punctuation">;</span> <span class="token comment">// 拉取寄存器映射指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">regmap</span> <span class="token operator">*</span>regmap_pmu<span class="token punctuation">;</span> <span class="token comment">// 电源管理单元寄存器映射指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">;</span> <span class="token comment">// 设备指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">rockchip_pin_ctrl</span> <span class="token operator">*</span>ctrl<span class="token punctuation">;</span> <span class="token comment">// 瑞芯微芯片引脚控制器指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_desc</span> pctl<span class="token punctuation">;</span> <span class="token comment">// 引脚控制器描述符</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctl_dev<span class="token punctuation">;</span> <span class="token comment">// 引脚控制器设备指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">rockchip_pin_group</span> <span class="token operator">*</span>groups<span class="token punctuation">;</span> <span class="token comment">// 瑞芯微芯片引脚组指针</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> ngroups<span class="token punctuation">;</span> <span class="token comment">// 引脚组数量</span>
    <span class="token keyword">struct</span> <span class="token class-name">rockchip_pmx_func</span> <span class="token operator">*</span>functions<span class="token punctuation">;</span> <span class="token comment">// 瑞芯微芯片引脚功能指针</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nfunctions<span class="token punctuation">;</span> <span class="token comment">// 引脚功能数量</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>（1）struct regmap *regmap_base：指向基本寄存器映射（regmap）的指针。基本寄存器映射是一个用于访问芯片寄存器的接口，它提供了对芯片寄存器的读写操作。<br>（2）int reg_size：表示寄存器的字节大小，用于确定寄存器的地址范围。<br>（3）struct regmap *regmap_pull：指向拉取寄存器映射的指针。拉取寄存器映射用于控制引脚上的上拉和下拉功能。<br>（4）struct regmap *regmap_pmu：指向电源管理单元（PMU）寄存器映射的指针。PMU寄存器映射用于控制引脚的电源管理功能。<br>（5）struct device *dev：指向设备结构体的指针。设备结构体用于表示与硬件相关的设备，包括设备的物理地址、中断等信息。<br>（6）struct rockchip_pin_ctrl *ctrl：指向瑞芯微芯片引脚控制器的指针。这个结构体存储了瑞芯微芯片特定的引脚控制器的相关信息和操作。<br>（7）struct pinctrl_desc pctl：包含了struct pinctrl_desc 结构体的一个实例。用于描述引脚控制器的属性和操作，包括引脚控制器的名称、引脚描述符数组、函数指针等。<br>（8）struct pinctrl_dev *pctl_dev：指向引脚控制器设备结构体的指针。引脚控制器设备结构体用于表示引脚控制器在系统中的设备实例，包含了与引脚控制器相关的设备信息和操作接口。<br>（9）struct rockchip_pin_group *groups：指向瑞芯微芯片引脚组的指针。引脚组是一组相关的引脚，可以一起进行配置和管理。<br>（10）unsigned int ngroups：表示引脚组数组的大小，用于确定引脚组数组的长度。<br>（11）struct rockchip_pmx_func *functions：指向瑞芯微芯片引脚功能的指针。引脚功能定义了引脚可以承担的不同功能，例如UART、SPI、I2C 等。<br>（12）unsigned int nfunctions：引脚功能的数量。它表示引脚功能数组的大小，用于确定引脚功能数组的长度。</p>
<h3 id="121-3-pinctrl-probe-函数分析"><a href="#121-3-pinctrl-probe-函数分析" class="headerlink" title="121.3 pinctrl probe 函数分析"></a>121.3 pinctrl probe 函数分析</h3><p>在上一章中已经找到了瑞芯微pinctrl 驱动文件的probe 函数，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">rockchip_pinctrl_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">rockchip_pinctrl</span> <span class="token operator">*</span>info<span class="token punctuation">;</span> <span class="token comment">// Rockchip GPIO 控制器的信息结构体指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev <span class="token operator">=</span> <span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">;</span> <span class="token comment">// 设备结构体指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">rockchip_pin_ctrl</span> <span class="token operator">*</span>ctrl<span class="token punctuation">;</span> <span class="token comment">// Rockchip GPIO 控制器的配置结构体指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np <span class="token operator">=</span> pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>of_node<span class="token punctuation">,</span> <span class="token operator">*</span>node<span class="token punctuation">;</span> <span class="token comment">// 设备节点指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">resource</span> <span class="token operator">*</span>res<span class="token punctuation">;</span> <span class="token comment">// 设备资源指针</span>
    <span class="token keyword">void</span> __iomem <span class="token operator">*</span>base<span class="token punctuation">;</span> <span class="token comment">// 寄存器基地址指针</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span> <span class="token comment">// 返回值</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dev<span class="token operator">-&gt;</span>of_node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dev_err</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"device tree node not found\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 分配并初始化一个rockchip_pinctrl 结构体</span>
    info <span class="token operator">=</span> <span class="token function">devm_kzalloc</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>info<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>info<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
    info<span class="token operator">-&gt;</span>dev <span class="token operator">=</span> dev<span class="token punctuation">;</span>
    
    <span class="token comment">// 获取并设置与pdev 相关的rockchip_pin_ctrl 结构体</span>
    ctrl <span class="token operator">=</span> <span class="token function">rockchip_pinctrl_get_soc_data</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> pdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctrl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dev_err</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"driver data not available\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    info<span class="token operator">-&gt;</span>ctrl <span class="token operator">=</span> ctrl<span class="token punctuation">;</span>
    
    <span class="token comment">// 解析设备树中的"rockchip,grf"节点，获取寄存器映射基地址</span>
    node <span class="token operator">=</span> <span class="token function">of_parse_phandle</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> <span class="token string">"rockchip,grf"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    info<span class="token operator">-&gt;</span>regmap_base <span class="token operator">=</span> <span class="token function">syscon_node_to_regmap</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>regmap_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>regmap_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果找不到"rockchip,grf"节点，则获取IORESOURCE_MEM 类型的资源，得到寄存器基地址</span>
        res <span class="token operator">=</span> <span class="token function">platform_get_resource</span><span class="token punctuation">(</span>pdev<span class="token punctuation">,</span> IORESOURCE_MEM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        base <span class="token operator">=</span> <span class="token function">devm_ioremap_resource</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 配置寄存器映射的最大寄存器地址和名称</span>
        rockchip_regmap_config<span class="token punctuation">.</span>max_register <span class="token operator">=</span> <span class="token function">resource_size</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">;</span>
        rockchip_regmap_config<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"rockchip,pinctrl"</span><span class="token punctuation">;</span>
        info<span class="token operator">-&gt;</span>regmap_base <span class="token operator">=</span> <span class="token function">devm_regmap_init_mmio</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> base<span class="token punctuation">,</span><span class="token operator">&amp;</span>rockchip_regmap_config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 检查旧的dt-bindings</span>
        info<span class="token operator">-&gt;</span>reg_size <span class="token operator">=</span> <span class="token function">resource_size</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 如果控制器类型为RK3188 且reg_size 小于0x200，则获取第二个IORESOURCE_MEM 类型的资源，作为pull 寄存器的基地址</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ctrl<span class="token operator">-&gt;</span>type <span class="token operator">==</span> RK3188 <span class="token operator">&amp;&amp;</span> info<span class="token operator">-&gt;</span>reg_size <span class="token operator">&lt;</span> <span class="token number">0x200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res <span class="token operator">=</span> <span class="token function">platform_get_resource</span><span class="token punctuation">(</span>pdev<span class="token punctuation">,</span> IORESOURCE_MEM<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            base <span class="token operator">=</span> <span class="token function">devm_ioremap_resource</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 配置pull 寄存器映射的最大寄存器地址和名称</span>
            rockchip_regmap_config<span class="token punctuation">.</span>max_register <span class="token operator">=</span>
            <span class="token function">resource_size</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">;</span>
            rockchip_regmap_config<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"rockchip,pinctrl-pull"</span><span class="token punctuation">;</span>
            info<span class="token operator">-&gt;</span>regmap_pull <span class="token operator">=</span> <span class="token function">devm_regmap_init_mmio</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span>base<span class="token punctuation">,</span><span class="token operator">&amp;</span>rockchip_regmap_config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 尝试查找可选的pmu syscon 引用</span>
    node <span class="token operator">=</span> <span class="token function">of_parse_phandle</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> <span class="token string">"rockchip,pmu"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        info<span class="token operator">-&gt;</span>regmap_pmu <span class="token operator">=</span> <span class="token function">syscon_node_to_regmap</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>regmap_pmu<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>regmap_pmu<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 对于某些SoC 进行特殊处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctrl<span class="token operator">-&gt;</span>soc_data_init<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ret <span class="token operator">=</span> ctrl<span class="token operator">-&gt;</span><span class="token function">soc_data_init</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
            <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 注册rockchip_pinctrl 设备</span>
    ret <span class="token operator">=</span> <span class="token function">rockchip_pinctrl_register</span><span class="token punctuation">(</span>pdev<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    
    <span class="token comment">// 设置pdev 的私有数据为info</span>
    <span class="token function">platform_set_drvdata</span><span class="token punctuation">(</span>pdev<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 注册GPIO 设备</span>
    ret <span class="token operator">=</span> <span class="token function">of_platform_populate</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> rockchip_bank_match<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dev_err</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"failed to register gpio device\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token function">dev_info</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"probed %s\n"</span><span class="token punctuation">,</span> <span class="token function">dev_name</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>接下来对该函数进行详细的分析：</p>
<ul>
<li><p>（1）第11-14 行：检查设备结构体中的设备树节点是否存在，如果不存在则报错并返回错误码。</p>
</li>
<li><p>（2）第17-19 行：使用devm_kzalloc 函数分配一个rockchip_pinctrl 结构体的内存，并将其初始化为0。然后将设备结构体指针赋值给info-&gt;dev，以便在后续代码中可以使用设备结构体的信息。</p>
</li>
<li><p>（3）第23-29 行：调用rockchip_pinctrl_get_soc_data 函数，根据设备信息获取与该设备相关的rockchip_pin_ctrl 结构体。如果获取失败，则报错并返回错误码。将获取到的结构体指针赋值给info-&gt;ctrl。</p>
</li>
<li><p>（4）第32-69 行使用of_parse_phandle 函数解析设备树中名为”rockchip,grf”的节点。如果解析成功，则调用syscon_node_to_regmap 函数将节点转换为寄存器映射的基地址，并将结果存储在info-&gt;regmap_base 中。如果解析失败，则进入”else”分支。<br>在”else”分支中，通过platform_get_resource 函数获取IORESOURCE_MEM 类型的资源，以获取寄存器的基地址。然后使用devm_ioremap_resource 函数将资源映射到内存中，并将结果存储在base 中。接下来， 配置寄存器映射的最大寄存器地址和名称， 并使用devm_regmap_init_mmio 函数初始化寄存器映射，将结果存储在info-&gt;regmap_base 中。</p>
<p>如果控制器类型为RK3188 且reg_size 小于0x200，则获取第二个IORESOURCE_MEM 类型的资源，作为pull 寄存器的基地址。类似地，配置pull 寄存器映射的最大寄存器地址和名称，并使用devm_regmap_init_mmio 函数初始化pull 寄存器映射，将结果存储在info-&gt;regmap_pull中。</p>
</li>
<li><p>（5）第72-77 行：使用of_parse_phandle 函数解析设备树中名为”rockchip,pmu”的可选节点。如果解析成功，则调用syscon_node_to_regmap 函数将节点转换为寄存器映射的基地址，并将结果存储在info-&gt;regmap_pmu 中。</p>
</li>
<li><p>（6）第80-84 行：如果ctrl-&gt;soc_data_init 不为空，则调用该函数指针所指向的函数，对特定的SoC 进行特殊处理。处理完成后，如果返回值不为0，则返回该错误码。</p>
</li>
<li><p>（7）第87-89 行：调用rockchip_pinctrl_register 函数注册rockchip_pinctrl 设备。如果注册失败，则返回错误码。</p>
</li>
<li><p>（8）第92 行：使用platform_set_drvdata 函数将info 设置为pdev 的私有数据。</p>
</li>
<li><p>（9）第95-100 行：调用of_platform_populate 函数注册GPIO 设备。如果注册失败，则返回错误码。</p>
</li>
</ul>
<p>在probe 函数中需要特别注意的是第87 行的rockchip_pinctrl_register 注册rockchip_pinctrl设备函数， 传入的参数分别为pdev 和rockchip_pinctrl 类型的info ， 然后跳转到rockchip_pinctrl_register 函数的定义，该函数的具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">rockchip_pinctrl_register</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">rockchip_pinctrl</span> <span class="token operator">*</span>info<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_desc</span> <span class="token operator">*</span>ctrldesc <span class="token operator">=</span> <span class="token operator">&amp;</span>info<span class="token operator">-&gt;</span>pctl<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_pin_desc</span> <span class="token operator">*</span>pindesc<span class="token punctuation">,</span> <span class="token operator">*</span>pdesc<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">rockchip_pin_bank</span> <span class="token operator">*</span>pin_bank<span class="token punctuation">;</span>
    <span class="token keyword">int</span> pin<span class="token punctuation">,</span> bank<span class="token punctuation">,</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">int</span> k<span class="token punctuation">;</span>
    
    <span class="token comment">// 初始化pinctrl 描述结构体</span>
    ctrldesc<span class="token operator">-&gt;</span>name <span class="token operator">=</span> <span class="token string">"rockchip-pinctrl"</span><span class="token punctuation">;</span>
    ctrldesc<span class="token operator">-&gt;</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">;</span>
    ctrldesc<span class="token operator">-&gt;</span>pctlops <span class="token operator">=</span> <span class="token operator">&amp;</span>rockchip_pctrl_ops<span class="token punctuation">;</span>
    ctrldesc<span class="token operator">-&gt;</span>pmxops <span class="token operator">=</span> <span class="token operator">&amp;</span>rockchip_pmx_ops<span class="token punctuation">;</span>
    ctrldesc<span class="token operator">-&gt;</span>confops <span class="token operator">=</span> <span class="token operator">&amp;</span>rockchip_pinconf_ops<span class="token punctuation">;</span>
    
    <span class="token comment">// 为每个引脚分配内存</span>
    pindesc <span class="token operator">=</span> <span class="token function">devm_kcalloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span>info<span class="token operator">-&gt;</span>ctrl<span class="token operator">-&gt;</span>nr_pins<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>pindesc<span class="token punctuation">)</span><span class="token punctuation">,</span>GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pindesc<span class="token punctuation">)</span>
    	<span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
    ctrldesc<span class="token operator">-&gt;</span>pins <span class="token operator">=</span> pindesc<span class="token punctuation">;</span>
    ctrldesc<span class="token operator">-&gt;</span>npins <span class="token operator">=</span> info<span class="token operator">-&gt;</span>ctrl<span class="token operator">-&gt;</span>nr_pins<span class="token punctuation">;</span>
    pdesc <span class="token operator">=</span> pindesc<span class="token punctuation">;</span>
    
    <span class="token comment">// 遍历每个引脚所属的bank，为每个引脚设置编号和名称</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>bank <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> bank <span class="token operator">&lt;</span> info<span class="token operator">-&gt;</span>ctrl<span class="token operator">-&gt;</span>nr_banks<span class="token punctuation">;</span> bank<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pin_bank <span class="token operator">=</span> <span class="token operator">&amp;</span>info<span class="token operator">-&gt;</span>ctrl<span class="token operator">-&gt;</span>pin_banks<span class="token punctuation">[</span>bank<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>pin <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> pin <span class="token operator">&lt;</span> pin_bank<span class="token operator">-&gt;</span>nr_pins<span class="token punctuation">;</span> pin<span class="token operator">++</span><span class="token punctuation">,</span> k<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pdesc<span class="token operator">-&gt;</span>number <span class="token operator">=</span> k<span class="token punctuation">;</span>
            pdesc<span class="token operator">-&gt;</span>name <span class="token operator">=</span> <span class="token function">kasprintf</span><span class="token punctuation">(</span>GFP_KERNEL<span class="token punctuation">,</span> <span class="token string">"%s-%d"</span><span class="token punctuation">,</span>pin_bank<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pdesc<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 解析设备树中的pinctrl 信息</span>
    ret <span class="token operator">=</span> <span class="token function">rockchip_pinctrl_parse_dt</span><span class="token punctuation">(</span>pdev<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    
    <span class="token comment">// 注册pinctrl 设备</span>
    info<span class="token operator">-&gt;</span>pctl_dev <span class="token operator">=</span> <span class="token function">devm_pinctrl_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> ctrldesc<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>pctl_dev<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dev_err</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"could not register pinctrl driver\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>pctl_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>（1）第4 行：将info 的pctl 参数传递给了struct pinctrl_desc *类型的变量ctrldesc，从而使得rockchip_pinctrl 结构体和pinctrl_desc 结构体建立了联系。</li>
<li>（2）第11-15 行，对pinctrl 描述结构体进行初始化。这些结构体成员包括name（pinctrl控制器的名称），owner（拥有该pinctrl 控制器的模块），pctlops（pinctrl 控制操作函数），pmxops（pinctrl 引脚复用操作函数）和confops（pinctrl 引脚配置操作函数）。</li>
<li>（3）第18-22 行，使用devm_kcalloc 函数在设备的内存上分配一块连续的内存区域，用于存储引脚描述结构体。该函数分配的内存大小为info-&gt;ctrl-&gt;nr_pins * sizeof(*pindesc)字节。如果内存分配失败，则返回-ENOMEM 错误码。</li>
<li>（4）第24-25 行：通过将引脚描述结构体的指针pindesc 赋值给pinctrl 描述结构体的pins成员，将引脚数量info-&gt;ctrl-&gt;nr_pins 赋值给pinctrl 描述结构体的npins 成员。</li>
<li>（5）第27-37 行：通过遍历每个引脚所属的bank，为每个引脚设置编号和名称。首先，定义变量pdesc 指向引脚描述结构体的起始地址。然后，使用两个嵌套的循环，外层循环遍历每个引脚所属的bank，内层循环遍历每个bank 中的引脚。<ul>
<li>在内层循环中，首先将当前引脚的编号k 赋值给引脚描述结构体的number 成员，然后使用kasprintf 函数动态分配内存储引脚名称的字符串，并将该字符串赋值给引脚描述结构体的name 成员。kasprintf 函数在内核堆中分配内存，并格式化生成字符串。格式化的字符串为”%s-%d”，其中pin_bank-&gt;name 是当前bank 的名称，pin 是当前引脚在bank 中的索引。</li>
</ul>
</li>
<li>（6）第39-42 行：调用rockchip_pinctrl_parse_dt 函数来解析设备树中的pinctrl 信息。该函数根据设备树中的描述，设置引脚的默认配置。</li>
<li>（7）第45-49 行：调用devm_pinctrl_register 函数注册pinctrl 设备。该函数将pinctrl 描述结构体、pinctrl 相关操作函数和私有数据作为参数，将pinctrl 设备注册到系统中。<ul>
<li>其中需要注意第45 行的devm_pinctrl_register 函数，该函数定义在内核源码目录下的“drivers/pinctrl/core.c”文件中，该函数的具体内容如下所示：</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span><span class="token function">devm_pinctrl_register</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_desc</span> <span class="token operator">*</span>pctldesc<span class="token punctuation">,</span>
                                          <span class="token keyword">void</span> <span class="token operator">*</span>driver_data<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span><span class="token operator">*</span>ptr<span class="token punctuation">,</span> <span class="token operator">*</span>pctldev<span class="token punctuation">;</span>
    
    <span class="token comment">// 分配用于存储pinctrl_dev 指针的内存</span>
    ptr <span class="token operator">=</span> <span class="token function">devres_alloc</span><span class="token punctuation">(</span>devm_pinctrl_dev_release<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ptr<span class="token punctuation">)</span>
    	<span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span><span class="token operator">-</span>ENOMEM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 注册pinctrl 设备</span>
    pctldev <span class="token operator">=</span> <span class="token function">pinctrl_register</span><span class="token punctuation">(</span>pctldesc<span class="token punctuation">,</span> dev<span class="token punctuation">,</span> driver_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">devres_free</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> pctldev<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 将pinctrl_dev 指针存储到devres 中</span>
    <span class="token operator">*</span>ptr <span class="token operator">=</span> pctldev<span class="token punctuation">;</span>
    <span class="token function">devres_add</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> pctldev<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个函数用于注册pinctrl 设备，并将其与设备关联起来。下面是对每个部分的详细解释：</p>
<ul>
<li>（1）第8-10 行：使用devres_alloc 函数为存储pinctrl_dev 指针的变量ptr 分配内存。devres_alloc 函数是用于管理设备资源的函数，它在设备的资源列表中分配内存。这里分配的内存大小为sizeof(*ptr)字节，即一个pinctrl_dev 指针的大小。如果内存分配失败，则返回-ENOMEM错误码。</li>
<li>（2）第13-17 行：调用pinctrl_register 函数注册pinctrl 设备。该函数将pinctrl_desc 结构体、设备指针dev 和驱动程序数据driver_data 作为参数，并返回注册后的pinctrl_dev 指针。如果注册失败（返回错误码），则释放之前分配的内存，并返回相应的错误码。</li>
<li>（3）第20-21 行：将pinctrl_dev 指针存储到ptr 指向的内存位置。接下来，使用devres_add 函数将ptr 添加到设备的资源列表中。这样，在设备释放时，会自动释放之前分配的内存。</li>
</ul>
<p>然后我们继续关注第13 行的pinctrl 设备注册函数pinctrl_register，然后跳转到他的定义，该函数的具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span><span class="token function">pinctrl_register</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_desc</span> <span class="token operator">*</span>pctldesc<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> 
                                     <span class="token keyword">void</span> <span class="token operator">*</span>driver_data<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">;</span>
    <span class="token keyword">int</span> error<span class="token punctuation">;</span>
    
    <span class="token comment">// 初始化pinctrl 控制器</span>
    pctldev <span class="token operator">=</span> <span class="token function">pinctrl_init_controller</span><span class="token punctuation">(</span>pctldesc<span class="token punctuation">,</span> dev<span class="token punctuation">,</span> driver_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> pctldev<span class="token punctuation">;</span>
    
    <span class="token comment">// 启用pinctrl 控制器</span>
    error <span class="token operator">=</span> <span class="token function">pinctrl_enable</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> pctldev<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个函数用于注册并启用pinctrl 设备。以下是对每个部分的详细解释：</p>
<p>（1）第8-10 行：调用pinctrl_init_controller 函数初始化pinctrl 控制器。该函数接受pinctrl_desc 结构体、设备指针dev 和驱动程序数据driver_data 作为参数，并返回一个指向已初始化的pinctrl_dev 结构体的指针。<br>（2）第13-15 行：调用pinctrl_enable 函数启用pinctrl 控制器。该函数接受一个pinctrl_dev结构体指针作为参数，并返回一个代表错误码的整数值。</p>
<p>至此，关于rk3568 的pinctrl probe 函数的分析就完成了，这个时候可能大家还是感觉乱乱的，大家不要着急，会在下面的章节中继续填充pinctrl 子系统的框架。</p>
<h2 id="第122-章pinctrl-子系统函数操作集"><a href="#第122-章pinctrl-子系统函数操作集" class="headerlink" title="第122 章pinctrl 子系统函数操作集"></a>第122 章pinctrl 子系统函数操作集</h2><p>再上一章中，我们对pinctrl 的probe 函数进行了详细的讲解，<strong>probe 函数的实际作用就是注册并启用pinctrl 设备</strong>，pinctrl 设备由pinctrl_desc 结构体所描述，所以在probe 函数中会对pinctrl_desc 结构体中的内容进行填充，具体可以见“121.3 pinctrl probe 函数分析”小节，在本章中将对pinctrl_desc 结构体中的三个函数操作集进行详细的讲解。</p>
<h3 id="122-1-groups-和function"><a href="#122-1-groups-和function" class="headerlink" title="122.1 groups 和function"></a>122.1 groups 和function</h3><p>在Pinctrl 子系统中，有两个关键概念：<strong>引脚组（groups）和功能（function）</strong>，在介绍pinctrl子系统函数操作集之前，首先对groups 和function 进行讲解。</p>
<p><strong>1.引脚组（Groups）</strong></p>
<p>引脚组是一组具有相似功能、约束条件或共同工作的引脚的集合。每个引脚组通常与特定的硬件功能或外设相关联。例如，一个引脚组可以用于控制串行通信接口（如UART 或SPI），另一个引脚组可以用于驱动GPIO。</p>
<p><strong>2.功能（Function）：</strong></p>
<p>定义了芯片上具有外设功能的功能。每个功能节点对应于一个或多个IO 组（group）的配置信息。这些功能可以是串口、SPI、I2C 等外设功能。<br>接下来以rk3568-pinctrl.dtsi 设备树文件中的can0 和can1 两个功能为例对上面的内容进行举例，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">can0 <span class="token punctuation">{</span>
    <span class="token operator">/</span>omit<span class="token operator">-</span><span class="token keyword">if</span><span class="token operator">-</span>no<span class="token operator">-</span>ref<span class="token operator">/</span>
    can0m0_pins<span class="token operator">:</span> can0m0<span class="token operator">-</span>pins <span class="token punctuation">{</span>
        rockchip<span class="token punctuation">,</span>pins <span class="token operator">=</span>
            <span class="token comment">/* can0_rxm0 */</span>
            <span class="token operator">&lt;</span><span class="token number">0</span> RK_PB4 <span class="token number">2</span> <span class="token operator">&amp;</span>pcfg_pull_none<span class="token operator">&gt;</span><span class="token punctuation">,</span>
            <span class="token comment">/* can0_txm0 */</span>
            <span class="token operator">&lt;</span><span class="token number">0</span> RK_PB3 <span class="token number">2</span> <span class="token operator">&amp;</span>pcfg_pull_none<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    <span class="token operator">/</span>omit<span class="token operator">-</span><span class="token keyword">if</span><span class="token operator">-</span>no<span class="token operator">-</span>ref<span class="token operator">/</span>
    can0m1_pins<span class="token operator">:</span> can0m1<span class="token operator">-</span>pins <span class="token punctuation">{</span>
        rockchip<span class="token punctuation">,</span>pins <span class="token operator">=</span>
            <span class="token comment">/* can0_rxm1 */</span>
            <span class="token operator">&lt;</span><span class="token number">2</span> RK_PA2 <span class="token number">4</span> <span class="token operator">&amp;</span>pcfg_pull_none<span class="token operator">&gt;</span><span class="token punctuation">,</span>
            <span class="token comment">/* can0_txm1 */</span>
            <span class="token operator">&lt;</span><span class="token number">2</span> RK_PA1 <span class="token number">4</span> <span class="token operator">&amp;</span>pcfg_pull_none<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

can1 <span class="token punctuation">{</span>
    <span class="token operator">/</span>omit<span class="token operator">-</span><span class="token keyword">if</span><span class="token operator">-</span>no<span class="token operator">-</span>ref<span class="token operator">/</span>
    can1m0_pins<span class="token operator">:</span> can1m0<span class="token operator">-</span>pins <span class="token punctuation">{</span>
    rockchip<span class="token punctuation">,</span>pins <span class="token operator">=</span>
        <span class="token comment">/* can1_rxm0 */</span>
        <span class="token operator">&lt;</span><span class="token number">1</span> RK_PA0 <span class="token number">3</span> <span class="token operator">&amp;</span>pcfg_pull_none<span class="token operator">&gt;</span><span class="token punctuation">,</span>
        <span class="token comment">/* can1_txm0 */</span>
        <span class="token operator">&lt;</span><span class="token number">1</span> RK_PA1 <span class="token number">3</span> <span class="token operator">&amp;</span>pcfg_pull_none<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    <span class="token operator">/</span>omit<span class="token operator">-</span><span class="token keyword">if</span><span class="token operator">-</span>no<span class="token operator">-</span>ref<span class="token operator">/</span>
    can1m1_pins<span class="token operator">:</span> can1m1<span class="token operator">-</span>pins <span class="token punctuation">{</span>
        rockchip<span class="token punctuation">,</span>pins <span class="token operator">=</span>
            <span class="token comment">/* can1_rxm1 */</span>
            <span class="token operator">&lt;</span><span class="token number">4</span> RK_PC2 <span class="token number">3</span> <span class="token operator">&amp;</span>pcfg_pull_none<span class="token operator">&gt;</span><span class="token punctuation">,</span>
            <span class="token comment">/* can1_txm1 */</span>
            <span class="token operator">&lt;</span><span class="token number">4</span> RK_PC3 <span class="token number">3</span> <span class="token operator">&amp;</span>pcfg_pull_none<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在上面的设备树中，can0 和can1 对应两个不同的function，分别为CAN0 控制器和CAN1 控制器。每个控制器中又都有两个不同的groups 引脚组。</p>
<p><strong>（1）CAN0 控制器：</strong><br>    引脚组can0m0-pins：这是CAN0 控制器的第一个引脚组，用于配置CAN0 的引脚。它定义了两个引脚：RK_PB4 和RK_PB3。其中，RK_PB4 用于CAN0 的接收引脚（can0_rxm0），RK_PB3 用于CAN0 的发送引脚（can0_txm0）。</p>
<p>​	引脚组can0m1-pins：这是CAN0 控制器的第二个引脚组，也用于配置CAN0 的引脚。它定义了两个引脚：RK_PA2 和RK_PA1。其中，RK_PA2 用于CAN0 的接收引脚（can0_rxm1），RK_PA1 用于CAN0 的发送引脚（can0_txm1）。</p>
<p><strong>（2）CAN1 控制器：</strong><br>    引脚组can1m0-pins：这是CAN1 控制器的第一个引脚组，用于配置CAN1 的引脚。它定义了两个引脚：RK_PA0 和RK_PA1。其中，RK_PA0 用于CAN1 的接收引脚（can1_rxm0），RK_PA1 用于CAN1 的发送引脚（can1_txm0）。</p>
<p>​	引脚组can1m1-pins：这是CAN1 控制器的第二个引脚组，也用于配置CAN1 的引脚。它定义了两个引脚：RK_PC2 和RK_PC3。其中，RK_PC2 用于CAN1 的接收引脚（can1_rxm1），RK_PC3 用于CAN1 的发送引脚（can1_txm1）。</p>
<h3 id="122-2-函数操作集结构体讲解"><a href="#122-2-函数操作集结构体讲解" class="headerlink" title="122.2 函数操作集结构体讲解"></a>122.2 函数操作集结构体讲解</h3><p>在pinctrl_desc 结构体中总共有三个函数操作集，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl_ops</span> <span class="token operator">*</span>pctlops<span class="token punctuation">;</span> 		<span class="token comment">// 引脚控制操作函数指针</span>
<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pinmux_ops</span> <span class="token operator">*</span>pmxops<span class="token punctuation">;</span> 		<span class="token comment">// 引脚复用操作函数指针</span>
<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pinconf_ops</span> <span class="token operator">*</span>confops<span class="token punctuation">;</span> 		<span class="token comment">// 引脚配置操作函数指针</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>本小节将会对上述函数操作集进行介绍</p>
<p><strong>（1）pinctrl_ops</strong><br>pinctrl_ops 结构体定义在内核源码的“<code>include/linux/pinctrl/pinctrl.h</code>”文件中，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">pinctrl_ops</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>get_groups_count<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//获取指定的Pin Control 设备支持的引脚组数量</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>get_group_name<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span>
                                  <span class="token keyword">unsigned</span> selector<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 获取指定引脚组选择器对应的引脚组名称</span>
    
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>get_group_pins<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span><span class="token keyword">unsigned</span> selector<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token operator">*</span><span class="token operator">*</span>pins<span class="token punctuation">,</span>
                          <span class="token keyword">unsigned</span> <span class="token operator">*</span>num_pins<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 获取指定引脚组选择器对应的引脚组中的引脚列表</span>
    
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>pin_dbg_show<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">seq_file</span> <span class="token operator">*</span>s<span class="token punctuation">,</span>
                         <span class="token keyword">unsigned</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//在调试信息中输出指定引脚选择器对应的引脚信息</span>
    
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>dt_node_to_map<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np_config<span class="token punctuation">,</span>               <span class="token keyword">struct</span> <span class="token class-name">pinctrl_map</span> <span class="token operator">*</span><span class="token operator">*</span>map<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token operator">*</span>num_maps<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 根据给定的设备树节点，创建与之相关联的Pin Control 映射</span>
    
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>dt_free_map<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_map</span> <span class="token operator">*</span>map<span class="token punctuation">,</span> 
                        <span class="token keyword">unsigned</span> num_maps<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//释放之前通过dt_node_to_map 创建的Pin Control 映射</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>pinctrl_ops 结构体定义了一组操作函数，用于与Pin Control 设备交互。以下是对每个操作函数的简要说明：</p>
<p>（1）get_groups_count：获取引脚组的数量。<br>（2）get_group_name：获取引脚组的名称。<br>（3）get_group_pins：获取引脚组的引脚列表。<br>（4）pin_dbg_show：在调试信息中输出引脚信息。<br>（5）dt_node_to_map：根据设备树节点创建与之相关联的Pin Control 映射。<br>（6）dt_free_map：释放通过<code>dt_node_to_map</code> 创建的Pin Control 映射。</p>
<p>这些操作函数用于对引脚控制器进行配置和管理，例如获取引脚组和引脚信息，以及创建和释放与设备树节点相关的引脚映射。</p>
<p><strong>（2）pinmux_ops</strong><br>pinmux_ops 结构体定义在内核源码的“<code>include/linux/pinctrl/pinctrl.h</code>”文件中，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">pinmux_ops</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>request<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//查看是否可以将某个引脚设置为可用于复用</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>free<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//request() 回调的反向函数，在请求后释放引脚</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>get_functions_count<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//返回此Pinmux 驱动程序中可选择的命名函数数量</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>get_function_name<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span><span class="token keyword">unsigned</span> selector<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//返回复用选择器的函数名称，核心调用此函数来确定应将某个设备映射到哪个复用设置</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>get_function_groups<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span><span class="token keyword">unsigned</span> selector<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> <span class="token keyword">const</span> <span class="token operator">*</span><span class="token operator">*</span>groups<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token operator">*</span>num_groups<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//返回与某个函数选择器相关联的一组组名称（依次引用引脚）</span>
    
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>set_mux<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> func_selector<span class="token punctuation">,</span><span class="token keyword">unsigned</span> group_selector<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//使用特定引脚组启用特定复用功能</span>
    
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>gpio_request_enable<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_gpio_range</span> <span class="token operator">*</span>range<span class="token punctuation">,</span>
                                <span class="token keyword">unsigned</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//在特定引脚上请求并启用GPIO</span>
    
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>gpio_disable_free<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_gpio_range</span> <span class="token operator">*</span>range<span class="token punctuation">,</span>
                               <span class="token keyword">unsigned</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//在特定引脚上释放GPIO 复用</span>
    
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>gpio_set_direction<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_gpio_range</span> <span class="token operator">*</span>range<span class="token punctuation">,</span>
                               <span class="token keyword">unsigned</span> offset<span class="token punctuation">,</span>bool input<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//根据GPIO 配置为输入或输出而进行不同的配置</span>
    
    bool strict<span class="token punctuation">;</span><span class="token comment">//不允许将同一引脚同时用于GPIO 和其他功能。在批准引脚请求之前，严格检查gpio_owner 和mux_owner</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>struct pinmux_ops 是一个用于描述引脚复用操作的结构体。它定义了一组函数指针，这些函数指针指向了引脚控制器驱动程序中实现的具体功能。下面是对该结构体成员的详细解释：</p>
<p>（1）request: 判断是否可以将某个引脚设置为可用于复用。<br>（2）free: 该函数是request()函数的反向操作，用于在引脚请求后释放引脚。<br>（3）get_functions_count: 返回在该引脚控制器驱动程序中可选择的命名函数的数量。<br>（4）get_function_name: 返回复用选择器的函数名称<br>（5）get_function_groups: 返回与某个函数选择器相关联的一组组名称（依次引用引脚）。<br>（6）set_mux: 用于启用特定的复用功能。<br>（7）gpio_request_enable: 在特定引脚上请求并启用GPIO。<br>（8）gpio_disable_free: 释放特定引脚上的GPIO 复用。<br>（9）gpio_set_direction: 根据GPIO 配置将引脚设置为输入或输出。<br>（10）strict: 表示是否严格检查将同一引脚同时用于GPIO 和其他功能的情况。在批准引脚请求之前，会严格检查<code>gpio_owner</code> 和<code>mux_owner</code>。如果设置为true，则不允许同时使用同一引脚作为GPIO 和其他功能；如果设置为false，则允许同时使用。</p>
<p>pinmux_ops 结构体提供了一组函数指针，这些函数指针定义了引脚复用操作的各个方面。通过实现这些函数，引脚控制器驱动程序可以与核心交互，并提供引脚复用的功能。核心可以通过调用这些函数来请求、释放引脚，设置复用功能，操作GPIO 等。这个结构体的设计允许引脚控制器驱动程序根据具体的硬件需求和功能定义自己的操作。</p>
<p><strong>（3）pinconf_ops</strong></p>
<p>pinconf_ops 结构体定义在内核源码的“include/linux/pinctrl/pinconf.h”文件中，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">pinconf_ops</span> <span class="token punctuation">{</span>
    
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_GENERIC_PINCONF</span></span>
    bool is_generic<span class="token punctuation">;</span> <span class="token comment">// 是否为通用引脚配置操作</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>pin_config_get<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span><span class="token keyword">unsigned</span> pin<span class="token punctuation">,</span>
                           <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取引脚配置信息</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>pin_config_set<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span><span class="token keyword">unsigned</span> pin<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>configs<span class="token punctuation">,</span>
                           <span class="token keyword">unsigned</span> num_configs<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置引脚配置信息</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>pin_config_group_get<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span><span class="token keyword">unsigned</span> selector<span class="token punctuation">,</span>
                                 <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取引脚组配置信息</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>pin_config_group_set<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span><span class="token keyword">unsigned</span> selector<span class="token punctuation">,</span>
                                 <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>configs<span class="token punctuation">,</span><span class="token keyword">unsigned</span> num_configs<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置引脚组配置信息</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>pin_config_dbg_parse_modify<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span>
                                        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解析和修改引脚配置的调试函数</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>pin_config_dbg_show<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">seq_file</span> <span class="token operator">*</span>s<span class="token punctuation">,</span>
                                 <span class="token keyword">unsigned</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调试函数，显示引脚配置信息</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>pin_config_group_dbg_show<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">seq_file</span> <span class="token operator">*</span>s<span class="token punctuation">,</span>
                                       <span class="token keyword">unsigned</span> selector<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调试函数，显示引脚组配置信息</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>pin_config_config_dbg_show<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">seq_file</span> <span class="token operator">*</span>s<span class="token punctuation">,</span>
                                        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调试函数，显示引脚配置的具体信息</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>（1）is_generic: 一个布尔值，表示是否为通用引脚配置操作。在配置文件中定义了<code>CONFIG_GENERIC_PINCONF</code> 时可用。<br>（2）pin_config_get: 获取引脚配置信息。<br>（3）pin_config_set: 设置引脚配置信息。<br>（4）pin_config_group_get: 获取引脚组配置信息。<br>（5）pin_config_group_set: 设置引脚组配置信息。<br>（6）pin_config_dbg_parse_modify: 解析和修改引脚配置的调试函数。<br>（7）pin_config_dbg_show: 显示引脚配置信息的调试函数。<br>（8）pin_config_group_dbg_show: 显示引脚组配置信息的调试函数。<br>（9）pin_config_config_dbg_show: 显示引脚配置具体信息的调试函数。</p>
<p>结构体pinconf_ops，用于定义引脚配置操作的函数指针。每个函数指针都对应了一个特定的操作，如获取引脚配置、设置引脚配置、获取引脚组配置等。这些函数在驱动程序中实现，用于对硬件引脚进行配置和控制。</p>
<h3 id="122-3-rockchip-pinctrl-进一步分析"><a href="#122-3-rockchip-pinctrl-进一步分析" class="headerlink" title="122.3 rockchip_pinctrl 进一步分析"></a>122.3 rockchip_pinctrl 进一步分析</h3><p>在讲解三个函数操作集的具体实现之前，需要进一步分析rockchip_pinctrl 结构体，在121.2小节中已经对rockchip_pinctrl 结构体进行了简单的讲解，rockchip_pinctrl 结构体是瑞芯微为了适应瑞芯微芯片的特定需求和功能，对struct pinctrl_desc 进行的再一次封装，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">rockchip_pinctrl</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">regmap</span> <span class="token operator">*</span>regmap_base<span class="token punctuation">;</span> <span class="token comment">// 基本寄存器映射指针</span>
    <span class="token keyword">int</span> reg_size<span class="token punctuation">;</span> <span class="token comment">// 寄存器大小</span>
    <span class="token keyword">struct</span> <span class="token class-name">regmap</span> <span class="token operator">*</span>regmap_pull<span class="token punctuation">;</span> <span class="token comment">// 拉取寄存器映射指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">regmap</span> <span class="token operator">*</span>regmap_pmu<span class="token punctuation">;</span> <span class="token comment">// 电源管理单元寄存器映射指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">;</span> <span class="token comment">// 设备指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">rockchip_pin_ctrl</span> <span class="token operator">*</span>ctrl<span class="token punctuation">;</span> <span class="token comment">// 瑞芯微芯片引脚控制器指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_desc</span> pctl<span class="token punctuation">;</span> <span class="token comment">// 引脚控制器描述符</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctl_dev<span class="token punctuation">;</span> <span class="token comment">// 引脚控制器设备指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">rockchip_pin_group</span> <span class="token operator">*</span>groups<span class="token punctuation">;</span> <span class="token comment">// 瑞芯微芯片引脚组指针</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> ngroups<span class="token punctuation">;</span> <span class="token comment">// 引脚组数量</span>
    <span class="token keyword">struct</span> <span class="token class-name">rockchip_pmx_func</span> <span class="token operator">*</span>functions<span class="token punctuation">;</span> <span class="token comment">// 瑞芯微芯片引脚功能指针</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nfunctions<span class="token punctuation">;</span> <span class="token comment">// 引脚功能数量</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>本小节主要对最后四个结构体参数groups、ngroups、functions 和nfunctions 的具体作用进行讲解。</p>
<p>在pinctrl 的probe 函数中，首先定义了一个<code>struct rockchip_pinctrl *</code>类型的结构体指针类型的变量info，然后传入了<code>rockchip_pinctrl_register</code> 函数，然后又分别传入了<code>rockchip_pinctrl_parse_dt</code> 函数和<code>devm_pinctrl_register</code> 函数。<code>rockchip_pinctrl_parse_dt</code> 函数稍后再进行讲解，参数传入<code>devm_pinctrl_register</code> 函数函数之后又作为私有数据传入到了<code>pinctrl_register</code> 函数，<code>pinctrl_register</code> 函数内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span><span class="token function">pinctrl_register</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_desc</span> <span class="token operator">*</span>pctldesc<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> 
                                     <span class="token keyword">void</span> <span class="token operator">*</span>driver_data<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">;</span>
    <span class="token keyword">int</span> error<span class="token punctuation">;</span>
    
    <span class="token comment">// 初始化pinctrl 控制器</span>
    pctldev <span class="token operator">=</span> <span class="token function">pinctrl_init_controller</span><span class="token punctuation">(</span>pctldesc<span class="token punctuation">,</span> dev<span class="token punctuation">,</span> driver_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">)</span><span class="token punctuation">)</span>
    	<span class="token keyword">return</span> pctldev<span class="token punctuation">;</span>
    
    <span class="token comment">// 启用pinctrl 控制器</span>
    error <span class="token operator">=</span> <span class="token function">pinctrl_enable</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> pctldev<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该函数的作用是注册一个引脚控制设备，用pinctrl_dev 来表示，上面提到的私有数据会传输到<code>pinctrl_init_controller</code> 函数进行初始化和构建pinctrl_dev 结构体，然后跳转到<code>pinctrl_init_controller</code> 的函数定义，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span><span class="token function">pinctrl_init_controller</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_desc</span> <span class="token operator">*</span>pctldesc<span class="token punctuation">,</span> 
                                                   <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span><span class="token keyword">void</span><span class="token operator">*</span>driver_data<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pctldesc<span class="token punctuation">)</span>
    	<span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span><span class="token operator">-</span>EINVAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pctldesc<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span>
    	<span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span><span class="token operator">-</span>EINVAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    pctldev <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>pctldev<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pctldev<span class="token punctuation">)</span>
    	<span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span><span class="token operator">-</span>ENOMEM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* 初始化引脚控制设备结构体*/</span>
    pctldev<span class="token operator">-&gt;</span>owner <span class="token operator">=</span> pctldesc<span class="token operator">-&gt;</span>owner<span class="token punctuation">;</span> <span class="token comment">// 设置所有者</span>
    pctldev<span class="token operator">-&gt;</span>desc <span class="token operator">=</span> pctldesc<span class="token punctuation">;</span> <span class="token comment">// 设置描述符</span>
    pctldev<span class="token operator">-&gt;</span>driver_data <span class="token operator">=</span> driver_data<span class="token punctuation">;</span> <span class="token comment">// 设置驱动程序数据</span>
    <span class="token function">INIT_RADIX_TREE</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pctldev<span class="token operator">-&gt;</span>pin_desc_tree<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化引脚描述符树</span>
    
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_GENERIC_PINCTRL_GROUPS</span></span>
    <span class="token function">INIT_RADIX_TREE</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pctldev<span class="token operator">-&gt;</span>pin_group_tree<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化引脚组树</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_GENERIC_PINMUX_FUNCTIONS</span></span>
    <span class="token function">INIT_RADIX_TREE</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pctldev<span class="token operator">-&gt;</span>pin_function_tree<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化引脚功能树</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    
    <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pctldev<span class="token operator">-&gt;</span>gpio_ranges<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化GPIO 范围链表</span>
    <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pctldev<span class="token operator">-&gt;</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化节点链表</span>
    pctldev<span class="token operator">-&gt;</span>dev <span class="token operator">=</span> dev<span class="token punctuation">;</span> <span class="token comment">// 设置设备指针</span>
    <span class="token function">mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pctldev<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化互斥锁</span>
    
    <span class="token comment">/* 检查核心操作函数的有效性*/</span>
    ret <span class="token operator">=</span> <span class="token function">pinctrl_check_ops</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dev_err</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"pinctrl ops lacks necessary functions\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> out_err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/* 如果实现了引脚复用功能，检查操作函数的有效性*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pctldesc<span class="token operator">-&gt;</span>pmxops<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ret <span class="token operator">=</span> <span class="token function">pinmux_check_ops</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
            <span class="token keyword">goto</span> out_err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/* 如果实现了引脚配置功能，检查操作函数的有效性*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pctldesc<span class="token operator">-&gt;</span>confops<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ret <span class="token operator">=</span> <span class="token function">pinconf_check_ops</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
            <span class="token keyword">goto</span> out_err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/* 注册所有引脚*/</span>
    <span class="token function">dev_dbg</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"try to register %d pins ...\n"</span><span class="token punctuation">,</span> pctldesc<span class="token operator">-&gt;</span>npins<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">pinctrl_register_pins</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">,</span> pctldesc<span class="token operator">-&gt;</span>pins<span class="token punctuation">,</span> pctldesc<span class="token operator">-&gt;</span>npins<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dev_err</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"error during pin registration\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pinctrl_free_pindescs</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">,</span> pctldesc<span class="token operator">-&gt;</span>pins<span class="token punctuation">,</span>pctldesc<span class="token operator">-&gt;</span>npins<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> out_err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> pctldev<span class="token punctuation">;</span>
    
out_err<span class="token operator">:</span>
    <span class="token function">mutex_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pctldev<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">kfree</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在该函数中我们要关注的是第19 行内容<code>pctldev-&gt;driver_data = driver_data</code>，其中右值driver_data 是从pinctrl 函数的probe 一步一步传递过来的，是一个struct rockchip_pinctrl *类型的结构体指针变量，左值pctldev 为要注册的引脚控制设备（pin controller device），至此两个数据结构建立起了关联，可以通过pctldev 来对rockchip_pinctrl 中的数据进行访问。</p>
<p>接下来分析上面提到的rockchip_pinctrl_parse_dt 函数，rockchip_pinctrl_parse_dt 函数的具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">rockchip_pinctrl_parse_dt</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">rockchip_pinctrl</span> <span class="token operator">*</span>info<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev <span class="token operator">=</span> <span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np <span class="token operator">=</span> dev<span class="token operator">-&gt;</span>of_node<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>child<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    
    <span class="token comment">// 计算子节点数量并更新info 结构体中的计数器</span>
    <span class="token function">rockchip_pinctrl_child_count</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> np<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">dev_dbg</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"nfunctions = %d\n"</span><span class="token punctuation">,</span> info<span class="token operator">-&gt;</span>nfunctions<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">dev_dbg</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"ngroups = %d\n"</span><span class="token punctuation">,</span> info<span class="token operator">-&gt;</span>ngroups<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 为函数和组分配内存空间</span>
    info<span class="token operator">-&gt;</span>functions <span class="token operator">=</span> <span class="token function">devm_kcalloc</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span>info<span class="token operator">-&gt;</span>nfunctions<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">rockchip_pmx_func</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                   GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>info<span class="token operator">-&gt;</span>functions<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
    info<span class="token operator">-&gt;</span>groups <span class="token operator">=</span> <span class="token function">devm_kcalloc</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span>info<span class="token operator">-&gt;</span>ngroups<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">rockchip_pin_group</span><span class="token punctuation">)</span><span class="token punctuation">,</span>GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>info<span class="token operator">-&gt;</span>groups<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
    
    i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 遍历每个子节点，解析函数信息</span>
    <span class="token function">for_each_child_of_node</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果节点不是函数节点，则继续下一个节点</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_function_node</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token comment">// 解析函数信息并存储到info 结构体中</span>
        ret <span class="token operator">=</span> <span class="token function">rockchip_pinctrl_parse_functions</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> info<span class="token punctuation">,</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">dev_err</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"failed to parse function\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">of_node_put</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>（1）第10-14 行：调用函数rockchip_pinctrl_child_count，计算设备节点np 的子节点数量，并更新info 结构体中的计数器，最后打印function 和组的数量。</li>
<li>（2）第17-22 行：使用devm_kcalloc 函数为函数分配内存空间，将函数数量乘以每个函数的大小sizeof(struct rockchip_pmx_func)，并将指针保存在info-&gt;functions 中。</li>
<li>（3）第24-29 行：使用devm_kcalloc 函数为组分配内存空间，将组数量乘以每个组的大小sizeof(struct rockchip_pin_group)，并将指针保存在info-&gt;groups 中。</li>
<li>（4）第33-46 行使用for_each_child_of_node 宏遍历设备节点np 的每个子节点child。如果节点child 不是函数节点，则跳过当前节点，继续遍历下一个节点，在每一个循环中调用函数<code>rockchip_pinctrl_parse_functions</code>，解析函数信息，并将结果存储在info 结构体中的相应位置。</li>
</ul>
<p>这里首先对<code>rockchip_pinctrl_child_count</code> 函数进行讲解，该函数内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">rockchip_pinctrl_child_count</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">rockchip_pinctrl</span> <span class="token operator">*</span>info<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>child<span class="token punctuation">;</span>
    <span class="token comment">// 遍历设备节点的子节点</span>
    <span class="token function">for_each_child_of_node</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果子节点不是function 节点，则跳过当前节点，继续遍历下一个节点</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_function_node</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 子节点是function 节点，增加function 计数器</span>
        info<span class="token operator">-&gt;</span>nfunctions<span class="token operator">++</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 获取子节点的子节点数量，并增加到组计数器中</span>
        info<span class="token operator">-&gt;</span>ngroups <span class="token operator">+=</span> <span class="token function">of_get_child_count</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在第一个小节中已经讲解了function 和groups，在上面的函数中首先会遍历function，从而得到系统设备树中实际使用的function 数量，保存到nfunctions 参数中，而groups 变量保存的是function 中的引脚组数量，需要通过遍历function 子节点来进行获取，到这里就可以确定<strong>rockchip_pinctrl 结构体中的nfunctions 用来记录function 数量，ngroups 用来记录groups 数量</strong>。<br>然后来看<code>rockchip_pinctrl_parse_dt</code> 函数的第40 行<code>rockchip_pinctrl_parse_functions</code> 函数，通过该函数可以解析函数信息，该函数的具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">rockchip_pinctrl_parse_functions</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">rockchip_pinctrl</span> <span class="token operator">*</span>info<span class="token punctuation">,</span>
                                            u32 index<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>child<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">rockchip_pmx_func</span> <span class="token operator">*</span>func<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">rockchip_pin_group</span> <span class="token operator">*</span>grp<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">static</span> u32 grp_index<span class="token punctuation">;</span>
    u32 i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 打印调试信息，显示正在解析的函数节点和索引</span>
    <span class="token function">dev_dbg</span><span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"parse function(%d): %pOFn\n"</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> np<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 获取当前函数在info-&gt;functions 数组中的指针</span>
    func <span class="token operator">=</span> <span class="token operator">&amp;</span>info<span class="token operator">-&gt;</span>functions<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* 初始化函数*/</span>
    func<span class="token operator">-&gt;</span>name <span class="token operator">=</span> np<span class="token operator">-&gt;</span>name<span class="token punctuation">;</span>
    
    <span class="token comment">// 获取函数节点的子节点数量，即关联的组数量</span>
    func<span class="token operator">-&gt;</span>ngroups <span class="token operator">=</span> <span class="token function">of_get_child_count</span><span class="token punctuation">(</span>np<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>func<span class="token operator">-&gt;</span>ngroups <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 为函数的组指针数组分配内存空间</span>
    func<span class="token operator">-&gt;</span>groups <span class="token operator">=</span> <span class="token function">devm_kcalloc</span><span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span>func<span class="token operator">-&gt;</span>ngroups<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>func<span class="token operator">-&gt;</span>groups<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
    
    <span class="token comment">// 遍历函数节点的每个子节点</span>
    <span class="token function">for_each_child_of_node</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 将子节点的名称存储到函数的组指针数组中</span>
        func<span class="token operator">-&gt;</span>groups<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> child<span class="token operator">-&gt;</span>name<span class="token punctuation">;</span>
        
        <span class="token comment">// 获取info-&gt;groups 数组中的对应组指针</span>
        grp <span class="token operator">=</span> <span class="token operator">&amp;</span>info<span class="token operator">-&gt;</span>groups<span class="token punctuation">[</span>grp_index<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 解析组信息，并将结果存储到对应的组指针中</span>
        ret <span class="token operator">=</span> <span class="token function">rockchip_pinctrl_parse_groups</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> grp<span class="token punctuation">,</span> info<span class="token punctuation">,</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">of_node_put</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第6-7 行：定义了<code>struct rockchip_pmx_func *</code>类型的变量<code>func</code> 和<code>struct rockchip_pin_group*</code>类型的变量<code>grp</code>，分别用来存放function 信息和groups 信息。<br>第16 行：将info 的functions 地址赋值给了func，所以<code>rockchip_pinctrl</code> 的functions 参数的作用就是用来存放pinctrl 设备树中的function 信息。<br>第37 行：将info 的groups 地址赋值给了grp，所以<code>rockchip_pinctrl</code> 的groups 参数的作用就是用来存放pinctrl 设备树中的groups 信息。<br>在第40 行：使用rockchip_pinctrl_parse_groups 函数来解析组信息，并将结果存储到对应的组指针中。</p>
<p>接下来跳转到<code>rockchip_pinctrl_parse_groups</code> 函数的定义，该函数的具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">rockchip_pinctrl_parse_groups</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">rockchip_pin_group</span> <span class="token operator">*</span>grp<span class="token punctuation">,</span>
                                         <span class="token keyword">struct</span> <span class="token class-name">rockchip_pinctrl</span> <span class="token operator">*</span>info<span class="token punctuation">,</span>u32 index<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">rockchip_pin_bank</span> <span class="token operator">*</span>bank<span class="token punctuation">;</span>
    <span class="token keyword">int</span> size<span class="token punctuation">;</span>
    <span class="token keyword">const</span> __be32 <span class="token operator">*</span>list<span class="token punctuation">;</span>
    <span class="token keyword">int</span> num<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token comment">// 打印调试信息，显示正在解析的组节点和索引</span>
    <span class="token function">dev_dbg</span><span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"group(%d): %pOFn\n"</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> np<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 初始化组信息</span>
    grp<span class="token operator">-&gt;</span>name <span class="token operator">=</span> np<span class="token operator">-&gt;</span>name<span class="token punctuation">;</span>
    
    <span class="token comment">/*
    * 绑定格式为rockchip,pins = &lt;bank pin mux CONFIG&gt;，
    * 进行合法性检查并计算引脚数量
    */</span>
    list <span class="token operator">=</span> <span class="token function">of_get_property</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> <span class="token string">"rockchip,pins"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 对返回值不进行检查，因为传递的节点是安全的</span>
    size <span class="token operator">/=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>size <span class="token operator">||</span> size <span class="token operator">%</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">dev_err</span><span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"wrong pins number or pins and configs should be by 4\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 计算组的引脚数量</span>
    grp<span class="token operator">-&gt;</span>npins <span class="token operator">=</span> size <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 为组的引脚数组和数据数组分配内存空间</span>
    grp<span class="token operator">-&gt;</span>pins <span class="token operator">=</span> <span class="token function">devm_kcalloc</span><span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> grp<span class="token operator">-&gt;</span>npins<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span>GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    grp<span class="token operator">-&gt;</span>data <span class="token operator">=</span> <span class="token function">devm_kcalloc</span><span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span>grp<span class="token operator">-&gt;</span>npins<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">rockchip_pin_config</span><span class="token punctuation">)</span><span class="token punctuation">,</span>GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>grp<span class="token operator">-&gt;</span>pins <span class="token operator">||</span> <span class="token operator">!</span>grp<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
    
    <span class="token comment">// 遍历列表中的每个元素，每4 个元素表示一个引脚的信息</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">4</span><span class="token punctuation">,</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> __be32 <span class="token operator">*</span>phandle<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np_config<span class="token punctuation">;</span>
        
        <span class="token comment">// 获取管脚号</span>
        num <span class="token operator">=</span> <span class="token function">be32_to_cpu</span><span class="token punctuation">(</span><span class="token operator">*</span>list<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bank <span class="token operator">=</span> <span class="token function">bank_num_to_bank</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>bank<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>bank<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 计算引脚编号</span>
        grp<span class="token operator">-&gt;</span>pins<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> bank<span class="token operator">-&gt;</span>pin_base <span class="token operator">+</span> <span class="token function">be32_to_cpu</span><span class="token punctuation">(</span><span class="token operator">*</span>list<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 获取引脚对应的功能选择值</span>
        grp<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>func <span class="token operator">=</span> <span class="token function">be32_to_cpu</span><span class="token punctuation">(</span><span class="token operator">*</span>list<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 获取与引脚相关的配置信息</span>
        phandle <span class="token operator">=</span> list<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>phandle<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
        
        <span class="token comment">// 通过句柄查找配置节点</span>
        np_config <span class="token operator">=</span> <span class="token function">of_find_node_by_phandle</span><span class="token punctuation">(</span><span class="token function">be32_to_cpup</span><span class="token punctuation">(</span>phandle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 解析配置信息，并将结果存储到组的数据数组中</span>
        ret <span class="token operator">=</span> <span class="token function">pinconf_generic_parse_dt_config</span><span class="token punctuation">(</span>np_config<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>grp<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>configs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>grp<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>nconfigs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
            <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>第17 行：初始化组信息，将引脚组的名称设置为节点的名称。</li>
<li>第23-29 行：通过of_get_property 函数获取引脚组节点的属性”rockchip,pins”的值，该属性的格式为”bank pin mux CONFIG”。对返回的属性值进行合法性检查，并计算引脚数量。如果属性值为空或者数量不是4 的倍数，将返回错误代码EINVAL。</li>
<li>第31-42 行：首先计算得到的引脚数量，然后根据计算得到的引脚数量为引脚数组和数据数组分配内存空间，这些数组将用于存储引脚的编号和相关的配置信息。如果内存分配失败，函数将返回错误代码ENOMEM。</li>
<li>第45 行：遍历属性值列表中的每个元素，每4 个元素表示一个引脚的信息。</li>
<li>第50-53 行：首先从列表中获取银行号，并使用bank_num_to_bank 函数将引脚号转换为对应的引脚结构体指针。如果转换失败，函数将返回相应的错误代码。</li>
<li>第56 行：根据引脚结构体中的引脚基地址（pin_base）和列表中的值计算引脚的编号，并将其存储在引脚数组（grp-&gt;pins）中。</li>
<li>第58 行：从列表中获取与当前引脚相关的功能选择值，并将其存储在数据数组（grp-&gt;data）中的相应位置。</li>
<li>第60-72 行从列表中获取与当前引脚相关的配置信息的句柄，并通过该句柄查找对应的配置节点（np_config）。然后，函数使用pinconf_generic_parse_dt_config 解析配置信息，并将解析结果存储在数据数组的相应位置。</li>
</ul>
<p>至此，关于rockchip_pinctrl 结构体的groups、ngroups、functions 和nfunctions 参数的具<br>体作用就从源码的角度讲解完成了。</p>
<h3 id="122-4-函数操作集的具体实现"><a href="#122-4-函数操作集的具体实现" class="headerlink" title="122.4 函数操作集的具体实现"></a>122.4 函数操作集的具体实现</h3><p>在上面的小节中对函数操作集和一些前置知识进行了讲解，在本小节将会对瑞芯微填充完成的函数操作集具体内容进行介绍。<br>首先找到内核源码目录下的“ <code>/drivers/pinctrl/pinctrl-rockchip.c</code> ” 文件， 在<code>rockchip_pinctrl_register</code> 函数中对三个函数操作集进行了填充，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">ctrldesc<span class="token operator">-&gt;</span>pctlops <span class="token operator">=</span> <span class="token operator">&amp;</span>rockchip_pctrl_ops<span class="token punctuation">;</span>
ctrldesc<span class="token operator">-&gt;</span>pmxops <span class="token operator">=</span> <span class="token operator">&amp;</span>rockchip_pmx_ops<span class="token punctuation">;</span>
ctrldesc<span class="token operator">-&gt;</span>confops <span class="token operator">=</span> <span class="token operator">&amp;</span>rockchip_pinconf_ops<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>接下来对每一个函数操作集的具体实现进行讲解。</p>
<h4 id="122-4-1-pinctrl-ops"><a href="#122-4-1-pinctrl-ops" class="headerlink" title="122.4.1 pinctrl_ops"></a>122.4.1 pinctrl_ops</h4><p>在122.2 小节已经对pinctrl_ops 函数操作集结构体进行了讲解，瑞芯微在源码中实现了其中五个函数，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl_ops</span> rockchip_pctrl_ops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>get_groups_count <span class="token operator">=</span> rockchip_get_groups_count<span class="token punctuation">,</span> <span class="token comment">// 获取引脚组数量的函数</span>
    <span class="token punctuation">.</span>get_group_name <span class="token operator">=</span> rockchip_get_group_name<span class="token punctuation">,</span><span class="token comment">// 获取引脚组名称的函数</span>
    <span class="token punctuation">.</span>get_group_pins <span class="token operator">=</span> rockchip_get_group_pins<span class="token punctuation">,</span><span class="token comment">// 获取引脚组引脚列表的函数</span>
    <span class="token punctuation">.</span>dt_node_to_map <span class="token operator">=</span> rockchip_dt_node_to_map<span class="token punctuation">,</span><span class="token comment">// 将设备树节点转换为引脚控制器映射的函数</span>
    <span class="token punctuation">.</span>dt_free_map <span class="token operator">=</span> rockchip_dt_free_map<span class="token punctuation">,</span> <span class="token comment">// 释放引脚控制器映射资源的函数</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>接下来是五个函数的具体内容：</p>
<p><strong>（1）rockchip_get_groups_count</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">rockchip_get_groups_count</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 从pinctrl_dev 结构中获取私有数据指针，将其转换为rockchip_pinctrl 结构</span>
    <span class="token keyword">struct</span> <span class="token class-name">rockchip_pinctrl</span> <span class="token operator">*</span>info <span class="token operator">=</span> <span class="token function">pinctrl_dev_get_drvdata</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 返回rockchip_pinctrl 结构中存储的引脚组数量</span>
    <span class="token keyword">return</span> info<span class="token operator">-&gt;</span>ngroups<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>（2）rockchip_get_group_name</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">rockchip_get_group_name</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span><span class="token keyword">unsigned</span> selector<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 从pinctrl_dev 结构中获取私有数据指针，将其转换为rockchip_pinctrl 结构</span>
    <span class="token keyword">struct</span> <span class="token class-name">rockchip_pinctrl</span> <span class="token operator">*</span>info <span class="token operator">=</span> <span class="token function">pinctrl_dev_get_drvdata</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 返回指定引脚组的名称</span>
    <span class="token keyword">return</span> info<span class="token operator">-&gt;</span>groups<span class="token punctuation">[</span>selector<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>（3）rockchip_get_group_pins</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">rockchip_get_group_pins</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span><span class="token keyword">unsigned</span> selector<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token operator">*</span><span class="token operator">*</span>pins<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token operator">*</span>npins<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 从pinctrl_dev 结构中获取私有数据指针，将其转换为rockchip_pinctrl 结构</span>
    <span class="token keyword">struct</span> <span class="token class-name">rockchip_pinctrl</span> <span class="token operator">*</span>info <span class="token operator">=</span> <span class="token function">pinctrl_dev_get_drvdata</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果选择器超出引脚组的范围，则返回错误码-EINVAL</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>selector <span class="token operator">&gt;=</span> info<span class="token operator">-&gt;</span>ngroups<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token comment">// 将指向引脚组的引脚数组的指针赋值给传入的pins 指针</span>
    <span class="token operator">*</span>pins <span class="token operator">=</span> info<span class="token operator">-&gt;</span>groups<span class="token punctuation">[</span>selector<span class="token punctuation">]</span><span class="token punctuation">.</span>pins<span class="token punctuation">;</span>
    <span class="token comment">// 将引脚组中的引脚数量赋值给传入的npins 变量</span>
    <span class="token operator">*</span>npins <span class="token operator">=</span> info<span class="token operator">-&gt;</span>groups<span class="token punctuation">[</span>selector<span class="token punctuation">]</span><span class="token punctuation">.</span>npins<span class="token punctuation">;</span>
    <span class="token comment">// 返回成功的状态码0</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>（4）rockchip_dt_node_to_map</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">rockchip_dt_node_to_map</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span>
                                   <span class="token keyword">struct</span> <span class="token class-name">pinctrl_map</span> <span class="token operator">*</span><span class="token operator">*</span>map<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token operator">*</span>num_maps<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">rockchip_pinctrl</span> <span class="token operator">*</span>info <span class="token operator">=</span> <span class="token function">pinctrl_dev_get_drvdata</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取引脚控制器的私有数据指针</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">rockchip_pin_group</span> <span class="token operator">*</span>grp<span class="token punctuation">;</span> <span class="token comment">// 引脚组指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev <span class="token operator">=</span> info<span class="token operator">-&gt;</span>dev<span class="token punctuation">;</span> <span class="token comment">// 设备指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_map</span> <span class="token operator">*</span>new_map<span class="token punctuation">;</span> <span class="token comment">// 新的引脚映射数组</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>parent<span class="token punctuation">;</span> <span class="token comment">// 父节点指针</span>
    <span class="token keyword">int</span> map_num <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 映射数量，默认为1</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token comment">/* 查找引脚组*/</span>
    grp <span class="token operator">=</span> <span class="token function">pinctrl_name_to_group</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> np<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 根据节点名称查找对应的引脚组</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>grp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dev_err</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"unable to find group for node %pOFn\n"</span><span class="token punctuation">,</span> np<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果找不到引脚组，打印错误信息</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    map_num <span class="token operator">+=</span> grp<span class="token operator">-&gt;</span>npins<span class="token punctuation">;</span> <span class="token comment">// 计算映射数量，包括复用映射和配置映射</span>
    new_map <span class="token operator">=</span> <span class="token function">kcalloc</span><span class="token punctuation">(</span>map_num<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>new_map<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 分配内存空间用于存储映射数组</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>new_map<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
    <span class="token operator">*</span>map <span class="token operator">=</span> new_map<span class="token punctuation">;</span> <span class="token comment">// 将分配的映射数组赋值给输出参数</span>
    <span class="token operator">*</span>num_maps <span class="token operator">=</span> map_num<span class="token punctuation">;</span> <span class="token comment">// 将映射数量赋值给输出参数</span>

    <span class="token comment">/* 创建复用映射*/</span>
    parent <span class="token operator">=</span> <span class="token function">of_get_parent</span><span class="token punctuation">(</span>np<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取节点的父节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">kfree</span><span class="token punctuation">(</span>new_map<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果父节点不存在，释放分配的映射数组内存空间</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    new_map<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">=</span> PIN_MAP_TYPE_MUX_GROUP<span class="token punctuation">;</span> <span class="token comment">// 设置映射类型为复用映射</span>
    new_map<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>mux<span class="token punctuation">.</span>function <span class="token operator">=</span> parent<span class="token operator">-&gt;</span>name<span class="token punctuation">;</span> <span class="token comment">// 复用功能名称为父节点的名称</span>
    new_map<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>mux<span class="token punctuation">.</span>group <span class="token operator">=</span> np<span class="token operator">-&gt;</span>name<span class="token punctuation">;</span> <span class="token comment">// 引脚组名称为节点的名称</span>
    <span class="token function">of_node_put</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 释放父节点的引用计数</span>
    
    <span class="token comment">/* 创建配置映射*/</span>
    new_map<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// 映射数组指针向后移动一个位置</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> grp<span class="token operator">-&gt;</span>npins<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        new_map<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">=</span> PIN_MAP_TYPE_CONFIGS_PIN<span class="token punctuation">;</span> <span class="token comment">// 设置映射类型为配置映射</span>
        new_map<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>configs<span class="token punctuation">.</span>group_or_pin <span class="token operator">=</span>
        <span class="token function">pin_get_name</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">,</span> grp<span class="token operator">-&gt;</span>pins<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 引脚组或引脚名称为引脚组中的引脚名称</span>
        new_map<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>configs<span class="token punctuation">.</span>configs <span class="token operator">=</span> grp<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>configs<span class="token punctuation">;</span> <span class="token comment">// 配置信息数组为引脚组中该引脚的配置信息</span>
        new_map<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>configs<span class="token punctuation">.</span>num_configs <span class="token operator">=</span> grp<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>nconfigs<span class="token punctuation">;</span> <span class="token comment">// 配置信息数量为引脚组中该引脚的配置数量</span>
    <span class="token punctuation">}</span>
    <span class="token function">dev_dbg</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"maps: function %s group %s num %d\n"</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>map<span class="token punctuation">)</span><span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>mux<span class="token punctuation">.</span>function<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>map<span class="token punctuation">)</span><span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>mux<span class="token punctuation">.</span>group<span class="token punctuation">,</span> map_num<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打印调试信息，显示创建的引脚</span>
    映射的功能名称、组名和数量
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 返回成功标志</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>（5）rockchip_dt_free_map</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">rockchip_dt_free_map</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_map</span> <span class="token operator">*</span>map<span class="token punctuation">,</span> 
                                 <span class="token keyword">unsigned</span> num_maps<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">kfree</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 释放引脚控制器映射的内存块</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="122-4-2-pinmux-ops"><a href="#122-4-2-pinmux-ops" class="headerlink" title="122.4.2 pinmux_ops"></a>122.4.2 pinmux_ops</h4><p>在122.2 小节已经对pinmux_ops 函数操作集结构体进行了讲解，瑞芯微在源码中实现了其中的四个函数，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pinmux_ops</span> rockchip_pmx_ops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>get_functions_count <span class="token operator">=</span> rockchip_pmx_get_funcs_count<span class="token punctuation">,</span><span class="token comment">// 获取引脚复用功能数量的函数</span>
    <span class="token punctuation">.</span>get_function_name <span class="token operator">=</span> rockchip_pmx_get_func_name<span class="token punctuation">,</span> <span class="token comment">// 获取引脚复用功能名称的函数</span>
    <span class="token punctuation">.</span>get_function_groups <span class="token operator">=</span> rockchip_pmx_get_groups<span class="token punctuation">,</span><span class="token comment">// 获取引脚复用功能对应的引脚组的函数</span>
    <span class="token punctuation">.</span>set_mux <span class="token operator">=</span> rockchip_pmx_set<span class="token punctuation">,</span> <span class="token comment">// 设置引脚复用功能的函数</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>接下来是五个函数的具体内容：</p>
<p><strong>（1）rockchip_pmx_get_funcs_count</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">rockchip_pmx_get_funcs_count</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">rockchip_pinctrl</span> <span class="token operator">*</span>info <span class="token operator">=</span> <span class="token function">pinctrl_dev_get_drvdata</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> info<span class="token operator">-&gt;</span>nfunctions<span class="token punctuation">;</span> <span class="token comment">// 返回引脚复用功能的数量</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>（2）rockchip_pmx_get_func_name</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">rockchip_pmx_get_func_name</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span><span class="token keyword">unsigned</span> selector<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">rockchip_pinctrl</span> <span class="token operator">*</span>info <span class="token operator">=</span> <span class="token function">pinctrl_dev_get_drvdata</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> info<span class="token operator">-&gt;</span>functions<span class="token punctuation">[</span>selector<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span> <span class="token comment">// 返回引脚复用功能的名称</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>（3）rockchip_pmx_get_groups</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">rockchip_pmx_get_groups</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span><span class="token keyword">unsigned</span> selector<span class="token punctuation">,</span>
                                   <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> <span class="token keyword">const</span> <span class="token operator">*</span><span class="token operator">*</span>groups<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token operator">*</span> <span class="token keyword">const</span> num_groups<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">rockchip_pinctrl</span> <span class="token operator">*</span>info <span class="token operator">=</span> <span class="token function">pinctrl_dev_get_drvdata</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>groups <span class="token operator">=</span> info<span class="token operator">-&gt;</span>functions<span class="token punctuation">[</span>selector<span class="token punctuation">]</span><span class="token punctuation">.</span>groups<span class="token punctuation">;</span> <span class="token comment">// 返回引脚复用功能对应的引脚组数组</span>
    <span class="token operator">*</span>num_groups <span class="token operator">=</span> info<span class="token operator">-&gt;</span>functions<span class="token punctuation">[</span>selector<span class="token punctuation">]</span><span class="token punctuation">.</span>ngroups<span class="token punctuation">;</span> <span class="token comment">// 返回引脚组的数量</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 返回成功</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>（4）rockchip_pmx_set</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">rockchip_pmx_set</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> selector<span class="token punctuation">,</span>
<span class="token keyword">unsigned</span> group<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">rockchip_pinctrl</span> <span class="token operator">*</span>info <span class="token operator">=</span> <span class="token function">pinctrl_dev_get_drvdata</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>pins <span class="token operator">=</span> info<span class="token operator">-&gt;</span>groups<span class="token punctuation">[</span>group<span class="token punctuation">]</span><span class="token punctuation">.</span>pins<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">rockchip_pin_config</span> <span class="token operator">*</span>data <span class="token operator">=</span> info<span class="token operator">-&gt;</span>groups<span class="token punctuation">[</span>group<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev <span class="token operator">=</span> info<span class="token operator">-&gt;</span>dev<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">rockchip_pin_bank</span> <span class="token operator">*</span>bank<span class="token punctuation">;</span>
    <span class="token keyword">int</span> cnt<span class="token punctuation">,</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">dev_dbg</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"enable function %s group %s\n"</span><span class="token punctuation">,</span>info<span class="token operator">-&gt;</span>functions<span class="token punctuation">[</span>selector<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> info<span class="token operator">-&gt;</span>groups<span class="token punctuation">[</span>group<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/*
    * 针对所选的引脚组中的每个引脚，将相应的引脚功能号码编程到配置寄存器中。
    */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> cnt <span class="token operator">&lt;</span> info<span class="token operator">-&gt;</span>groups<span class="token punctuation">[</span>group<span class="token punctuation">]</span><span class="token punctuation">.</span>npins<span class="token punctuation">;</span> cnt<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bank <span class="token operator">=</span> <span class="token function">pin_to_bank</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> pins<span class="token punctuation">[</span>cnt<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">rockchip_set_mux</span><span class="token punctuation">(</span>bank<span class="token punctuation">,</span> pins<span class="token punctuation">[</span>cnt<span class="token punctuation">]</span> <span class="token operator">-</span> bank<span class="token operator">-&gt;</span>pin_base<span class="token punctuation">,</span>data<span class="token punctuation">[</span>cnt<span class="token punctuation">]</span><span class="token punctuation">.</span>func<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&amp;&amp;</span> cnt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* 恢复已经设置的引脚设置*/</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>cnt<span class="token operator">--</span><span class="token punctuation">;</span> cnt <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>data<span class="token punctuation">[</span>cnt<span class="token punctuation">]</span><span class="token punctuation">.</span>func<span class="token punctuation">;</span> cnt<span class="token operator">--</span><span class="token punctuation">)</span>
            <span class="token function">rockchip_set_mux</span><span class="token punctuation">(</span>bank<span class="token punctuation">,</span> pins<span class="token punctuation">[</span>cnt<span class="token punctuation">]</span> <span class="token operator">-</span> bank<span class="token operator">-&gt;</span>pin_base<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 返回成功</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="122-4-3-pinconf-ops"><a href="#122-4-3-pinconf-ops" class="headerlink" title="122.4.3 pinconf_ops"></a>122.4.3 pinconf_ops</h4><p>在122.2 小节已经对pinconf_ops 函数操作集结构体进行了讲解，瑞芯微在源码中实现了其中五个函数，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pinconf_ops</span> rockchip_pinconf_ops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>pin_config_get <span class="token operator">=</span> rockchip_pinconf_get<span class="token punctuation">,</span> <span class="token comment">// 获取引脚配置的函数</span>
    <span class="token punctuation">.</span>pin_config_set <span class="token operator">=</span> rockchip_pinconf_set<span class="token punctuation">,</span> <span class="token comment">// 设置引脚配置的函数</span>
    <span class="token punctuation">.</span>is_generic <span class="token operator">=</span> true<span class="token punctuation">,</span> <span class="token comment">// 表示是通用的引脚配置操作</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>接下来是两个函数的具体内容：</p>
<p><strong>（1）rockchip_pinconf_set</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">rockchip_pinconf_set</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> pin<span class="token punctuation">,</span>
                                <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>configs<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> num_configs<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">rockchip_pinctrl</span> <span class="token operator">*</span>info <span class="token operator">=</span> <span class="token function">pinctrl_dev_get_drvdata</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">rockchip_pin_bank</span> <span class="token operator">*</span>bank <span class="token operator">=</span> <span class="token function">pin_to_bank</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">gpio_chip</span> <span class="token operator">*</span>gpio <span class="token operator">=</span> <span class="token operator">&amp;</span>bank<span class="token operator">-&gt;</span>gpio_chip<span class="token punctuation">;</span>
    <span class="token keyword">enum</span> <span class="token class-name">pin_config_param</span> param<span class="token punctuation">;</span>
    u32 arg<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">int</span> rc<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_configs<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        param <span class="token operator">=</span> <span class="token function">pinconf_to_config_param</span><span class="token punctuation">(</span>configs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        arg <span class="token operator">=</span> <span class="token function">pinconf_to_config_argument</span><span class="token punctuation">(</span>configs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>param <span class="token operator">==</span> PIN_CONFIG_OUTPUT <span class="token operator">||</span> param <span class="token operator">==</span> PIN_CONFIG_INPUT_ENABLE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/*
            * 检查GPIO 驱动程序是否已经探测到。
            * 锁定确保GPIO 探测完成或者GPIO 驱动程序尚未探测到。
            */</span>
            <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bank<span class="token operator">-&gt;</span>deferred_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>gpio <span class="token operator">||</span> <span class="token operator">!</span>gpio<span class="token operator">-&gt;</span>direction_output<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 如果驱动程序尚未探测到，则将配置信息延迟处理并返回。</span>
                rc <span class="token operator">=</span> <span class="token function">rockchip_pinconf_defer_pin</span><span class="token punctuation">(</span>bank<span class="token punctuation">,</span> pin <span class="token operator">-</span> bank<span class="token operator">-&gt;</span>pin_base<span class="token punctuation">,</span> param<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bank<span class="token operator">-&gt;</span>deferred_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>rc<span class="token punctuation">)</span>
                    <span class="token keyword">return</span> rc<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bank<span class="token operator">-&gt;</span>deferred_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>param<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> PIN_CONFIG_BIAS_DISABLE<span class="token operator">:</span>
                <span class="token comment">// 禁用上下拉电阻</span>
                rc <span class="token operator">=</span> <span class="token function">rockchip_set_pull</span><span class="token punctuation">(</span>bank<span class="token punctuation">,</span> pin <span class="token operator">-</span> bank<span class="token operator">-&gt;</span>pin_base<span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>rc<span class="token punctuation">)</span>
                <span class="token keyword">return</span> rc<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token keyword">case</span> PIN_CONFIG_BIAS_PULL_UP<span class="token operator">:</span>
            <span class="token keyword">case</span> PIN_CONFIG_BIAS_PULL_DOWN<span class="token operator">:</span>
            <span class="token keyword">case</span> PIN_CONFIG_BIAS_PULL_PIN_DEFAULT<span class="token operator">:</span>
            <span class="token keyword">case</span> PIN_CONFIG_BIAS_BUS_HOLD<span class="token operator">:</span>
                <span class="token comment">// 检查上下拉电阻是否有效</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">rockchip_pinconf_pull_valid</span><span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>ctrl<span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>ENOTSUPP<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>arg<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
                <span class="token comment">// 设置上下拉电阻</span>
                rc <span class="token operator">=</span> <span class="token function">rockchip_set_pull</span><span class="token punctuation">(</span>bank<span class="token punctuation">,</span> pin <span class="token operator">-</span> bank<span class="token operator">-&gt;</span>pin_base<span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>rc<span class="token punctuation">)</span>
                <span class="token keyword">return</span> rc<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token keyword">case</span> PIN_CONFIG_OUTPUT<span class="token operator">:</span>
                <span class="token comment">// 设置引脚复用功能为GPIO</span>
                rc <span class="token operator">=</span> <span class="token function">rockchip_set_mux</span><span class="token punctuation">(</span>bank<span class="token punctuation">,</span> pin <span class="token operator">-</span> bank<span class="token operator">-&gt;</span>pin_base<span class="token punctuation">,</span> RK_FUNC_GPIO<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">!=</span> RK_FUNC_GPIO<span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
                <span class="token comment">// 设置引脚为输出模式</span>
                rc <span class="token operator">=</span> gpio<span class="token operator">-&gt;</span><span class="token function">direction_output</span><span class="token punctuation">(</span>gpio<span class="token punctuation">,</span> pin <span class="token operator">-</span> bank<span class="token operator">-&gt;</span>pin_base<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>rc<span class="token punctuation">)</span>
                    <span class="token keyword">return</span> rc<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token keyword">case</span> PIN_CONFIG_INPUT_ENABLE<span class="token operator">:</span>
                <span class="token comment">// 设置引脚复用功能为GPIO</span>
                rc <span class="token operator">=</span> <span class="token function">rockchip_set_mux</span><span class="token punctuation">(</span>bank<span class="token punctuation">,</span> pin <span class="token operator">-</span> bank<span class="token operator">-&gt;</span>pin_base<span class="token punctuation">,</span> RK_FUNC_GPIO<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">!=</span> RK_FUNC_GPIO<span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
                <span class="token comment">// 设置引脚为输入模式</span>
                rc <span class="token operator">=</span> gpio<span class="token operator">-&gt;</span><span class="token function">direction_input</span><span class="token punctuation">(</span>gpio<span class="token punctuation">,</span> pin <span class="token operator">-</span> bank<span class="token operator">-&gt;</span>pin_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>rc<span class="token punctuation">)</span>
                    <span class="token keyword">return</span> rc<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token keyword">case</span> PIN_CONFIG_DRIVE_STRENGTH<span class="token operator">:</span>
                <span class="token comment">// 仅支持某些芯片（如rk3288）的每个引脚独立的驱动强度设置</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>info<span class="token operator">-&gt;</span>ctrl<span class="token operator">-&gt;</span>drv_calc_reg<span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token operator">-</span>ENOTSUPP<span class="token punctuation">;</span>
                <span class="token comment">// 设置引脚的驱动强度</span>
                rc <span class="token operator">=</span> <span class="token function">rockchip_set_drive_perpin</span><span class="token punctuation">(</span>bank<span class="token punctuation">,</span> pin <span class="token operator">-</span> bank<span class="token operator">-&gt;</span>pin_base<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> rc<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token keyword">case</span> PIN_CONFIG_INPUT_SCHMITT_ENABLE<span class="token operator">:</span>
                <span class="token comment">// 仅支持某些芯片的施密特触发设置</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>info<span class="token operator">-&gt;</span>ctrl<span class="token operator">-&gt;</span>schmitt_calc_reg<span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token operator">-</span>ENOTSUPP<span class="token punctuation">;</span>
                <span class="token comment">// 设置引脚的施密特触发模式</span>
                rc <span class="token operator">=</span> <span class="token function">rockchip_set_schmitt</span><span class="token punctuation">(</span>bank<span class="token punctuation">,</span> pin <span class="token operator">-</span> bank<span class="token operator">-&gt;</span>pin_base<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> rc<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token keyword">case</span> PIN_CONFIG_SLEW_RATE<span class="token operator">:</span>
                <span class="token comment">// 仅支持某些芯片的引脚驱动速率设置</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>info<span class="token operator">-&gt;</span>ctrl<span class="token operator">-&gt;</span>slew_rate_calc_reg<span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token operator">-</span>ENOTSUPP<span class="token punctuation">;</span>
                <span class="token comment">// 设置引脚的驱动速率</span>
                rc <span class="token operator">=</span> <span class="token function">rockchip_set_slew_rate</span><span class="token punctuation">(</span>bank<span class="token punctuation">,</span> pin <span class="token operator">-</span> bank<span class="token operator">-&gt;</span>pin_base<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> rc<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token comment">// 不支持的配置参数</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>ENOTSUPP<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token comment">/* for each config */</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>（2）rockchip_pinconf_get</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* 获取指定引脚的配置设置*/</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">rockchip_pinconf_get</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> pin<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>config<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">rockchip_pinctrl</span> <span class="token operator">*</span>info <span class="token operator">=</span> <span class="token function">pinctrl_dev_get_drvdata</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">rockchip_pin_bank</span> <span class="token operator">*</span>bank <span class="token operator">=</span> <span class="token function">pin_to_bank</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">gpio_chip</span> <span class="token operator">*</span>gpio <span class="token operator">=</span> <span class="token operator">&amp;</span>bank<span class="token operator">-&gt;</span>gpio_chip<span class="token punctuation">;</span>
    <span class="token keyword">enum</span> <span class="token class-name">pin_config_param</span> param <span class="token operator">=</span> <span class="token function">pinconf_to_config_param</span><span class="token punctuation">(</span><span class="token operator">*</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    u16 arg<span class="token punctuation">;</span>
    <span class="token keyword">int</span> rc<span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>param<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> PIN_CONFIG_BIAS_DISABLE<span class="token operator">:</span>
            <span class="token comment">// 检查上下拉电阻是否禁用</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rockchip_get_pull</span><span class="token punctuation">(</span>bank<span class="token punctuation">,</span> pin <span class="token operator">-</span> bank<span class="token operator">-&gt;</span>pin_base<span class="token punctuation">)</span> <span class="token operator">!=</span> param<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
            arg <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> PIN_CONFIG_BIAS_PULL_UP<span class="token operator">:</span>
        <span class="token keyword">case</span> PIN_CONFIG_BIAS_PULL_DOWN<span class="token operator">:</span>
        <span class="token keyword">case</span> PIN_CONFIG_BIAS_PULL_PIN_DEFAULT<span class="token operator">:</span>
        <span class="token keyword">case</span> PIN_CONFIG_BIAS_BUS_HOLD<span class="token operator">:</span>
            <span class="token comment">// 检查上下拉电阻是否有效，并获取当前的上下拉电阻配置</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">rockchip_pinconf_pull_valid</span><span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>ctrl<span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>ENOTSUPP<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rockchip_get_pull</span><span class="token punctuation">(</span>bank<span class="token punctuation">,</span> pin <span class="token operator">-</span> bank<span class="token operator">-&gt;</span>pin_base<span class="token punctuation">)</span> <span class="token operator">!=</span> param<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
            arg <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
            
        <span class="token keyword">case</span> PIN_CONFIG_OUTPUT<span class="token operator">:</span>
            <span class="token comment">// 检查引脚是否配置为GPIO 输出模式</span>
            rc <span class="token operator">=</span> <span class="token function">rockchip_get_mux</span><span class="token punctuation">(</span>bank<span class="token punctuation">,</span> pin <span class="token operator">-</span> bank<span class="token operator">-&gt;</span>pin_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">!=</span> RK_FUNC_GPIO<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>gpio <span class="token operator">||</span> <span class="token operator">!</span>gpio<span class="token operator">-&gt;</span>get<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                arg <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 获取引脚的输出状态</span>
            rc <span class="token operator">=</span> gpio<span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span>gpio<span class="token punctuation">,</span> pin <span class="token operator">-</span> bank<span class="token operator">-&gt;</span>pin_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> rc<span class="token punctuation">;</span>
            arg <span class="token operator">=</span> rc <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
            
        <span class="token keyword">case</span> PIN_CONFIG_DRIVE_STRENGTH<span class="token operator">:</span>
            <span class="token comment">// 仅支持某些芯片（如rk3288）的每个引脚独立的驱动强度设置</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>info<span class="token operator">-&gt;</span>ctrl<span class="token operator">-&gt;</span>drv_calc_reg<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>ENOTSUPP<span class="token punctuation">;</span>
            <span class="token comment">// 获取引脚的驱动强度配置</span>
            rc <span class="token operator">=</span> <span class="token function">rockchip_get_drive_perpin</span><span class="token punctuation">(</span>bank<span class="token punctuation">,</span> pin <span class="token operator">-</span> bank<span class="token operator">-&gt;</span>pin_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> rc<span class="token punctuation">;</span>
            arg <span class="token operator">=</span> rc<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
            
        <span class="token keyword">case</span> PIN_CONFIG_INPUT_SCHMITT_ENABLE<span class="token operator">:</span>
            <span class="token comment">// 仅支持某些芯片的施密特触发设置</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>info<span class="token operator">-&gt;</span>ctrl<span class="token operator">-&gt;</span>schmitt_calc_reg<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>ENOTSUPP<span class="token punctuation">;</span>
            <span class="token comment">// 获取引脚的施密特触发配置</span>
            rc <span class="token operator">=</span> <span class="token function">rockchip_get_schmitt</span><span class="token punctuation">(</span>bank<span class="token punctuation">,</span> pin <span class="token operator">-</span> bank<span class="token operator">-&gt;</span>pin_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> rc<span class="token punctuation">;</span>
            arg <span class="token operator">=</span> rc<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
            
        <span class="token keyword">case</span> PIN_CONFIG_SLEW_RATE<span class="token operator">:</span>
            <span class="token comment">// 仅支持某些芯片的引脚驱动速率设置</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>info<span class="token operator">-&gt;</span>ctrl<span class="token operator">-&gt;</span>slew_rate_calc_reg<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>ENOTSUPP<span class="token punctuation">;</span>
            <span class="token comment">// 获取引脚的驱动速率配置</span>
            rc <span class="token operator">=</span> <span class="token function">rockchip_get_slew_rate</span><span class="token punctuation">(</span>bank<span class="token punctuation">,</span> pin <span class="token operator">-</span> bank<span class="token operator">-&gt;</span>pin_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> rc<span class="token punctuation">;</span>
            arg <span class="token operator">=</span> rc<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
            
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token comment">// 不支持的配置参数</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>ENOTSUPP<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">*</span>config <span class="token operator">=</span> <span class="token function">pinconf_to_config_packed</span><span class="token punctuation">(</span>param<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>一般情况下SOC 原厂BSP 工程师已经帮我们写好了上述函数，不需要独自进行编写，所以这里这需要简单的了解即可。</p>
<h2 id="第123-章dt-node-to-map-函数分析"><a href="#第123-章dt-node-to-map-函数分析" class="headerlink" title="第123 章dt_node_to_map 函数分析"></a>第123 章dt_node_to_map 函数分析</h2><p>设备树（Device Tree）中存放的是对硬件设备信息的描述，包含了硬件设备的配置和连接信息，例如在pinctrl 节点中的引脚的配置和映射关系。而rockchip_dt_node_to_map 函数的作用就是根据设备树中的节点信息，生成对应的引脚映射数组。这个映射数组将描述硬件功能（如复用功能和配置信息）与设备树中的引脚信息进行绑定。</p>
<p><code>dt_node_to_map</code> 函数已经在122.4.1 小节的pinctrl_ops 函数操作集中进行了简单的讲解，现在将对该函数进行详细的介绍。该函数的具体实现在内核源码的“<code>drivers/pinctrl/pinctrl-rockchip.c</code>”文件中，在讲解该函数之前需要先对struct pinctrl_map 结构体进行介绍，该结构体定义在内核源码的“<code>include/linux/pinctrl/machine.h</code>”目录下，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">pinctrl_map</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>dev_name<span class="token punctuation">;</span> <span class="token comment">// 设备名称</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span> <span class="token comment">// 映射名称</span>
    <span class="token keyword">enum</span> <span class="token class-name">pinctrl_map_type</span> type<span class="token punctuation">;</span> <span class="token comment">// 映射类型</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>ctrl_dev_name<span class="token punctuation">;</span> <span class="token comment">// 控制设备名称</span>
    <span class="token keyword">union</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">pinctrl_map_mux</span> mux<span class="token punctuation">;</span> <span class="token comment">// 复用映射数据</span>
        <span class="token keyword">struct</span> <span class="token class-name">pinctrl_map_configs</span> configs<span class="token punctuation">;</span> <span class="token comment">// 配置映射数据</span>
    <span class="token punctuation">}</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该结构体用于在引脚控制器中定义引脚的映射关系。通过映射类型的不同，可以将引脚与具体的复用功能或配置信息关联起来， 从而实现引脚的配置和控制。然后来看<code>rockchip_dt_node_to_map</code> 函数，该函数的具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">rockchip_dt_node_to_map</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span>
                                   <span class="token keyword">struct</span> <span class="token class-name">pinctrl_map</span> <span class="token operator">*</span><span class="token operator">*</span>map<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token operator">*</span>num_maps<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">rockchip_pinctrl</span> <span class="token operator">*</span>info <span class="token operator">=</span> <span class="token function">pinctrl_dev_get_drvdata</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取引脚控制器的私有数据指针</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">rockchip_pin_group</span> <span class="token operator">*</span>grp<span class="token punctuation">;</span> <span class="token comment">// 引脚组指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev <span class="token operator">=</span> info<span class="token operator">-&gt;</span>dev<span class="token punctuation">;</span> <span class="token comment">// 设备指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_map</span> <span class="token operator">*</span>new_map<span class="token punctuation">;</span> <span class="token comment">// 新的引脚映射数组</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>parent<span class="token punctuation">;</span> <span class="token comment">// 父节点指针</span>
    <span class="token keyword">int</span> map_num <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 映射数量，默认为1</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    
    <span class="token comment">/* 查找引脚组*/</span>
    grp <span class="token operator">=</span> <span class="token function">pinctrl_name_to_group</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> np<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 根据节点名称查找对应的引脚组</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>grp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dev_err</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"unable to find group for node %pOFn\n"</span><span class="token punctuation">,</span> np<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果找不到引脚组，打印错误信息</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    map_num <span class="token operator">+=</span> grp<span class="token operator">-&gt;</span>npins<span class="token punctuation">;</span> <span class="token comment">// 计算映射数量，包括复用映射和配置映射</span>
    new_map <span class="token operator">=</span> <span class="token function">kcalloc</span><span class="token punctuation">(</span>map_num<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>new_map<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 分配内存空间用于存储映射数组</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>new_map<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
    
    <span class="token operator">*</span>map <span class="token operator">=</span> new_map<span class="token punctuation">;</span> <span class="token comment">// 将分配的映射数组赋值给输出参数</span>
    <span class="token operator">*</span>num_maps <span class="token operator">=</span> map_num<span class="token punctuation">;</span> <span class="token comment">// 将映射数量赋值给输出参数</span>
    
    <span class="token comment">/* 创建复用映射*/</span>
    parent <span class="token operator">=</span> <span class="token function">of_get_parent</span><span class="token punctuation">(</span>np<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取节点的父节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">kfree</span><span class="token punctuation">(</span>new_map<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果父节点不存在，释放分配的映射数组内存空间</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    new_map<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">=</span> PIN_MAP_TYPE_MUX_GROUP<span class="token punctuation">;</span> <span class="token comment">// 设置映射类型为复用映射</span>
    new_map<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>mux<span class="token punctuation">.</span>function <span class="token operator">=</span> parent<span class="token operator">-&gt;</span>name<span class="token punctuation">;</span> <span class="token comment">// 复用功能名称为父节点的名称</span>
    new_map<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>mux<span class="token punctuation">.</span>group <span class="token operator">=</span> np<span class="token operator">-&gt;</span>name<span class="token punctuation">;</span> <span class="token comment">// 引脚组名称为节点的名称</span>
    <span class="token function">of_node_put</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 释放父节点的引用计数</span>
    
    <span class="token comment">/* 创建配置映射*/</span>
    new_map<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// 映射数组指针向后移动一个位置</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> grp<span class="token operator">-&gt;</span>npins<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        new_map<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">=</span> PIN_MAP_TYPE_CONFIGS_PIN<span class="token punctuation">;</span> <span class="token comment">// 设置映射类型为配置映射</span>
        new_map<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>configs<span class="token punctuation">.</span>group_or_pin <span class="token operator">=</span><span class="token function">pin_get_name</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">,</span> grp<span class="token operator">-&gt;</span>pins<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 引脚组或引脚名称为引脚组中的引脚名称</span>
        new_map<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>configs<span class="token punctuation">.</span>configs <span class="token operator">=</span> grp<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>configs<span class="token punctuation">;</span> <span class="token comment">// 配置信息数组为引脚组中该引脚的配置信息</span>
        new_map<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>configs<span class="token punctuation">.</span>num_configs <span class="token operator">=</span> grp<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>nconfigs<span class="token punctuation">;</span> <span class="token comment">// 配置信息数量为引脚组中该引脚的配置数量</span>
    <span class="token punctuation">}</span>
    <span class="token function">dev_dbg</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"maps: function %s group %s num %d\n"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token operator">*</span>map<span class="token punctuation">)</span><span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>mux<span class="token punctuation">.</span>function<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>map<span class="token punctuation">)</span><span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>mux<span class="token punctuation">.</span>group<span class="token punctuation">,</span> map_num<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打印调试信息，显示创建的引脚映射的功能名称、组名和数量</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 返回成功标志</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第14-20 行：函数根据设备节点的名称使用pinctrl_name_to_group 函数查找与该节点对应的引脚组。如果找不到引脚组，则函数打印错误消息并返回EINVAL 错误代码。<br>第22 行：函数根据引脚组的引脚数量计算需要创建的映射数量。映射数量包括复用映射和配置映射。<br>第24-26 行：函数使用kcalloc 函数为映射数组（new_map）分配内存空间。分配的大小为映射数量乘以每个映射的大小。如果内存分配失败，函数将返回ENOMEM 错误代码。<br>第28-29 行：函数将分配的映射数组（new_map）和映射数量（map_num）通过输出参数map 和num_maps 返回给调用者。<br>第31-40 行：函数首先获取设备节点的父节点，并将其作为复用映射的功能名称。然后，函数设置第一个映射的类型为PIN_MAP_TYPE_MUX_GROUP，并将父节点的名称作为映射的数据。同时，将设备节点的名称作为映射的组名。最后，函数使用of_node_put 释放父节点的引用计数。<br>第42-52 行：函数遍历引脚组的引脚数组，并为每个引脚创建一个配置映射。函数设置映射的类型为<code>PIN_MAP_TYPE_CONFIGS_PIN</code>，并将引脚的名称作为映射的数据。同时，将引脚组中该引脚的配置信息和配置数量设置为映射的配置数据。函数使用pin_get_name 函数获取引脚的名称。<br>rockchip_dt_node_to_map 函数根据设备节点的信息创建引脚映射，包括复用映射和配置映射。复用映射用于将引脚组的功能与父节点的功能关联起来，而配置映射用于将引脚的配置信息与引脚的名称关联起来。这些映射将用于配置引脚控制器，以确保引脚在系统中正确地配置和使用。这个函数在设备树解析过程中被调用，以便为每个设备节点创建相应的引脚映射。</p>
<p>到这里关于pinctrl 子系统第一阶段的讲解到这里就结束了，为了帮助大家整合讲解过的知识点，作者绘制了以下思维导图：<br>注：该思维导图的存放路径为<code>iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\05_思维导图\01_pinctrl 阶段1.jpg</code></p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409141140616.png" alt="image-20240914114000036"></p>
<p>大家可以根据该思维导图，对上面章节的内容进行梳理，从而真正理解pinctrl 子系统框架。</p>
<h2 id="第124-章pinctrl-bind-pins-函数"><a href="#第124-章pinctrl-bind-pins-函数" class="headerlink" title="第124 章pinctrl_bind_pins 函数"></a>第124 章pinctrl_bind_pins 函数</h2><p>在前面的章节中对pinctrl 子系统的probe 函数及其相关框架进行了讲解，但在120.2 小节中提出的“引脚的复用关系是在什么时候被设置的”这一问题并没有被解决，那接下来我们要如何继续解决这一问题呢，带着疑问让我们进入本章节的学习吧。</p>
<h3 id="124-1-dev-pin-info-结构体引入"><a href="#124-1-dev-pin-info-结构体引入" class="headerlink" title="124.1 dev_pin_info 结构体引入"></a>124.1 dev_pin_info 结构体引入</h3><p>这里以485 控制引脚的设备树节点和对应的pinctrl 设备树节点进行举例，要添加的485设备树内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">rk_485_ctl<span class="token operator">:</span> rk<span class="token operator">-</span><span class="token number">485</span><span class="token operator">-</span>ctl <span class="token punctuation">{</span>
    compatible <span class="token operator">=</span> <span class="token string">"topeet,rs485_ctl"</span><span class="token punctuation">;</span>
    gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio0 <span class="token number">22</span> GPIO_ACTIVE_HIGH<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>
    pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>rk_485_gpio<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token operator">&amp;</span>pinctrl <span class="token punctuation">{</span>
    rk_485<span class="token punctuation">{</span>
        rk_485_gpio<span class="token operator">:</span>rk<span class="token operator">-</span><span class="token number">485</span><span class="token operator">-</span>gpio <span class="token punctuation">{</span>
            rockchip<span class="token punctuation">,</span>pins <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">3</span> <span class="token number">13</span> RK_FUNC_GPIO <span class="token operator">&amp;</span>pcfg_pull_none<span class="token operator">&gt;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>当上面编写的485 设备树跟驱动匹配成功之后，就会进入相应驱动中的probe 函数，在probe 函数中就可以对设备树中描述的485 使能引脚进行拉高和拉低的操作，从而控制485 的接收和发送。所以可以猜测在进入驱动的probe 函数之前就已经使用pinctrl 子系统对引脚进行了复用，在前面设备模型的学习中，我们已经知道了驱动中的probe 函数是在内核源码目录下的“drivers/base/dd.c”文件中加载执行的，然后找到really probe 函数中与probe 函数加载相关的代码，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">re_probe<span class="token operator">:</span>
dev<span class="token operator">-&gt;</span>driver <span class="token operator">=</span> drv<span class="token punctuation">;</span> <span class="token comment">// 将设备的驱动程序指针设置为当前驱动</span>

<span class="token comment">/* 如果使用了pinctrl，在探测之前绑定引脚*/</span>
ret <span class="token operator">=</span> <span class="token function">pinctrl_bind_pins</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 绑定设备的引脚</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
    <span class="token keyword">goto</span> pinctrl_bind_failed<span class="token punctuation">;</span>

ret <span class="token operator">=</span> <span class="token function">dma_configure</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 配置DMA</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
    <span class="token keyword">goto</span> probe_failed<span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">driver_sysfs_add</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 添加驱动程序的sysfs 接口</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"%s: driver_sysfs_add(%s) failed\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">,</span> <span class="token function">dev_name</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">goto</span> probe_failed<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pm_domain <span class="token operator">&amp;&amp;</span> dev<span class="token operator">-&gt;</span>pm_domain<span class="token operator">-&gt;</span>activate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ret <span class="token operator">=</span> dev<span class="token operator">-&gt;</span>pm_domain<span class="token operator">-&gt;</span><span class="token function">activate</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 激活电源管理域</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> probe_failed<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>bus<span class="token operator">-&gt;</span>probe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ret <span class="token operator">=</span> dev<span class="token operator">-&gt;</span>bus<span class="token operator">-&gt;</span><span class="token function">probe</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果总线的探测函数存在，则调用总线的探测函数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> probe_failed<span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>drv<span class="token operator">-&gt;</span>probe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ret <span class="token operator">=</span> drv<span class="token operator">-&gt;</span><span class="token function">probe</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 否则调用驱动程序的探测函数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
    <span class="token keyword">goto</span> probe_failed<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>test_remove<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    test_remove <span class="token operator">=</span> false<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>bus<span class="token operator">-&gt;</span>remove<span class="token punctuation">)</span> <span class="token comment">// 如果总线的移除函数存在，则调用总线的移除函数</span>
        dev<span class="token operator">-&gt;</span>bus<span class="token operator">-&gt;</span><span class="token function">remove</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>drv<span class="token operator">-&gt;</span>remove<span class="token punctuation">)</span> <span class="token comment">// 否则调用驱动程序的移除函数</span>
        drv<span class="token operator">-&gt;</span><span class="token function">remove</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">devres_release_all</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 释放设备资源</span>
    <span class="token function">driver_sysfs_remove</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 移除驱动程序的sysfs 接口</span>
    dev<span class="token operator">-&gt;</span>driver <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token function">dev_set_drvdata</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pm_domain <span class="token operator">&amp;&amp;</span> dev<span class="token operator">-&gt;</span>pm_domain<span class="token operator">-&gt;</span>dismiss<span class="token punctuation">)</span>
        dev<span class="token operator">-&gt;</span>pm_domain<span class="token operator">-&gt;</span><span class="token function">dismiss</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解除电源管理域的激活状态</span>
    <span class="token function">pm_runtime_reinit</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 重新初始化电源管理运行时</span>
    <span class="token keyword">goto</span> re_probe<span class="token punctuation">;</span> <span class="token comment">// 重新进行设备的探测</span>
<span class="token punctuation">}</span>

<span class="token function">pinctrl_init_done</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 完成引脚控制器的初始化</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pm_domain <span class="token operator">&amp;&amp;</span> dev<span class="token operator">-&gt;</span>pm_domain<span class="token operator">-&gt;</span>sync<span class="token punctuation">)</span>
    dev<span class="token operator">-&gt;</span>pm_domain<span class="token operator">-&gt;</span><span class="token function">sync</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 同步电源管理域</span>

<span class="token function">driver_bound</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 驱动程序与设备绑定成功</span>
ret <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"bus: '%s': %s: bound device %s to driver %s\n"</span><span class="token punctuation">,</span>drv<span class="token operator">-&gt;</span>bus<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> 
         <span class="token constant">__func__</span><span class="token punctuation">,</span> <span class="token function">dev_name</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">,</span> drv<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">goto</span> done<span class="token punctuation">;</span>
done<span class="token operator">:</span>
<span class="token comment">// 执行完成后的处理逻辑</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>根据注释可以了解到，如果使用了pinctrl 就会调用第5 行的<code>pinctrl_bind_pins()</code>函数进行设备引脚的绑定，然后根据线索跳转到<code>pinctrl_bind_pins</code> 函数，该函数定义在内核源码目录下的“<code>drivers/base/pinctrl.c</code>”文件中，函数具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">pinctrl_bind_pins</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token comment">// 检查设备是否重用了节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>of_node_reused<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 为设备的引脚分配内存空间</span>
    dev<span class="token operator">-&gt;</span>pins <span class="token operator">=</span> <span class="token function">devm_kzalloc</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dev<span class="token operator">-&gt;</span>pins<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
    
    <span class="token comment">// 获取设备的pinctrl 句柄</span>
    dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>p <span class="token operator">=</span> <span class="token function">devm_pinctrl_get</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dev_dbg</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"没有pinctrl 句柄\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup_alloc<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 查找设备的默认pinctrl 状态</span>
    dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>default_state <span class="token operator">=</span> <span class="token function">pinctrl_lookup_state</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>p<span class="token punctuation">,</span> PINCTRL_STATE_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>default_state<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dev_dbg</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"没有默认的pinctrl 状态\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup_get<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 查找设备的初始化pinctrl 状态</span>
    dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>init_state <span class="token operator">=</span> <span class="token function">pinctrl_lookup_state</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>p<span class="token punctuation">,</span> PINCTRL_STATE_INIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>init_state<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* 不提供此状态是完全合法的*/</span>
        <span class="token function">dev_dbg</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"没有初始化的pinctrl 状态\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 选择默认的pinctrl 状态</span>
        ret <span class="token operator">=</span> <span class="token function">pinctrl_select_state</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>p<span class="token punctuation">,</span> dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>default_state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 选择初始化的pinctrl 状态</span>
        ret <span class="token operator">=</span> <span class="token function">pinctrl_select_state</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>p<span class="token punctuation">,</span> dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>init_state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dev_dbg</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"无法激活初始的pinctrl 状态\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup_get<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_PM</span></span>
    <span class="token comment">/*
    * 如果启用了电源管理，我们还会寻找可选的睡眠和空闲的引脚状态，其语义在
    * &lt;linux/pinctrl/pinctrl-state.h&gt; 中定义
    */</span>
    dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>sleep_state <span class="token operator">=</span> <span class="token function">pinctrl_lookup_state</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>p<span class="token punctuation">,</span> PINCTRL_STATE_SLEEP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>sleep_state<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">/* 不提供此状态是完全合法的*/</span>
        <span class="token function">dev_dbg</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"没有睡眠的pinctrl 状态\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>idle_state <span class="token operator">=</span> <span class="token function">pinctrl_lookup_state</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>p<span class="token punctuation">,</span> PINCTRL_STATE_IDLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>idle_state<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">/* 不提供此状态是完全合法的*/</span>
        <span class="token function">dev_dbg</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"没有空闲的pinctrl 状态\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token comment">/*
    * 如果对于此设备没有找到pinctrl 句柄或默认状态，
    * 让我们明确释放设备中的引脚容器，因为保留它没有意义。
    */</span>
cleanup_get<span class="token operator">:</span>
    <span class="token function">devm_pinctrl_put</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
cleanup_alloc<span class="token operator">:</span>
    <span class="token function">devm_kfree</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> dev<span class="token operator">-&gt;</span>pins<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dev<span class="token operator">-&gt;</span>pins <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token comment">/* 返回延迟*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span>EPROBE_DEFER<span class="token punctuation">)</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    
    <span class="token comment">/* 返回严重错误*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">)</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token comment">/* 我们忽略诸如-ENOENT 的错误，表示没有pinctrl 状态*/</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>关于该函数的具体讲解将在下个小节进行，本小节的目的是引出dev_pin_info 结构体，仔细查看上面的函数内容发现并没有该结构体，但是可以发现很多dev-&gt;pins 的结构体指针引用，然后跳转到<code>struct device *</code>结构体的定义，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>parent<span class="token punctuation">;</span> <span class="token comment">// 指向父设备的指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_private</span> <span class="token operator">*</span>p<span class="token punctuation">;</span> <span class="token comment">// 私有数据指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">kobject</span> kobj<span class="token punctuation">;</span> <span class="token comment">// 内核对象，用于设备的管理</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>init_name<span class="token punctuation">;</span> <span class="token comment">// 设备的初始名称</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_type</span> <span class="token operator">*</span>type<span class="token punctuation">;</span> <span class="token comment">// 设备类型</span>
    <span class="token keyword">struct</span> <span class="token class-name">mutex</span> mutex<span class="token punctuation">;</span> <span class="token comment">// 互斥锁，用于同步对驱动程序的调用</span>
    <span class="token keyword">struct</span> <span class="token class-name">bus_type</span> <span class="token operator">*</span>bus<span class="token punctuation">;</span> <span class="token comment">// 设备所在的总线类型</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_driver</span> <span class="token operator">*</span>driver<span class="token punctuation">;</span> <span class="token comment">// 分配该设备的驱动程序</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>platform_data<span class="token punctuation">;</span> <span class="token comment">// 平台特定的数据，设备核心不会修改它</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>driver_data<span class="token punctuation">;</span> <span class="token comment">// 驱动程序的数据，使用dev_set/get_drvdata 来设置和获取</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_GENERIC_MSI_IRQ_DOMAIN</span></span>
    <span class="token keyword">struct</span> <span class="token class-name">irq_domain</span> <span class="token operator">*</span>msi_domain<span class="token punctuation">;</span> <span class="token comment">// 设备的通用MSI IRQ 域</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_PINCTRL</span></span>
    <span class="token keyword">struct</span> <span class="token class-name">dev_pin_info</span> <span class="token operator">*</span>pins<span class="token punctuation">;</span> <span class="token comment">// 设备的引脚信息</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在第21-23 行有这样一个宏定义，如果定义了<code>CONFIG_PINCTRL</code> 那记录设备引脚信息的结构体<code>struct dev_pin_info *pins</code> 就会被使能，到这里本小节要讲解的重点终于出现了，接下来跳转到<code>struct dev_pin_info</code> 结构体定义，该结构体的具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">dev_pin_info</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token operator">*</span>p<span class="token punctuation">;</span> <span class="token comment">// 引脚控制器指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_state</span> <span class="token operator">*</span>default_state<span class="token punctuation">;</span> <span class="token comment">// 默认状态指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_state</span> <span class="token operator">*</span>init_state<span class="token punctuation">;</span> <span class="token comment">// 初始化状态指针</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_PM</span></span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_state</span> <span class="token operator">*</span>sleep_state<span class="token punctuation">;</span> <span class="token comment">// 睡眠状态指针（仅在支持电源管理时可用）</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_state</span> <span class="token operator">*</span>idle_state<span class="token punctuation">;</span> <span class="token comment">// 空闲状态指针（仅在支持电源管理时可用）</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>下面对结构体中的成员变量进行详细介绍：<br>（1）struct pinctrl *p;：引脚控制器指针。该指针指向设备所使用的引脚控制器对象，用于对设备的引脚进行控制和配置。<br>（2）struct pinctrl_state *default_state;：默认状态指针。该指针指向设备的默认引脚配置状态，表示设备在正常操作时的引脚配置。<br>（3）struct pinctrl_state *init_state;：初始化状态指针。该指针指向设备的初始化引脚配置状态，表示设备在初始化阶段的引脚配置。<br>（4）struct pinctrl_state *sleep_state;：睡眠状态指针（仅在支持电源管理时可用）。该指针指向设备的引脚配置状态，表示设备在进入睡眠状态时的引脚配置。<br>（5）struct pinctrl_state *idle_state;：空闲状态指针（仅在支持电源管理时可用）。该指针指向设备的引脚配置状态，表示设备在空闲状态时的引脚配置。</p>
<p>这里仍旧以485 的控制引脚进行举例，要添加的485 设备树内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">rk_485_ctl<span class="token operator">:</span> rk<span class="token operator">-</span><span class="token number">485</span><span class="token operator">-</span>ctl <span class="token punctuation">{</span>
    compatible <span class="token operator">=</span> <span class="token string">"topeet,rs485_ctl"</span><span class="token punctuation">;</span>
    gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio0 <span class="token number">22</span> GPIO_ACTIVE_HIGH<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>
    pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>rk_485_gpio<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>pinctrl <span class="token punctuation">{</span>
    rk_485<span class="token punctuation">{</span>
        rk_485_gpio<span class="token operator">:</span>rk<span class="token operator">-</span><span class="token number">485</span><span class="token operator">-</span>gpio <span class="token punctuation">{</span>
            rockchip<span class="token punctuation">,</span>pins <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">3</span> <span class="token number">13</span> RK_FUNC_GPIO <span class="token operator">&amp;</span>pcfg_pull_none<span class="token operator">&gt;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中第4 行的pinctrl-names 属性指定了设备所使用的引脚控制器为default，即第5 行的pinctrl-0，而pinctrl-0 的值为pinctrl 节点中的<code>rk_485_gpio</code>，所以<code>struct pinctrl_state *default_state</code> 这一默认状态结构体指针会用来存放11 行的引脚复用信息，而在上一章节中也提到了设备树中的pinctrl 节点会转换为pinctrl_map 结构体，那么<code>struct pinctrl_state *default_state</code> 必然会跟pinctrl_map 结构体建立联系，那这个联系是如何建立的呢？就让我们一起进入pinctrl_bind_pins 函数的学习吧。</p>
<h3 id="124-2-pinctrl-bind-pins-函数分析1"><a href="#124-2-pinctrl-bind-pins-函数分析1" class="headerlink" title="124.2 pinctrl_bind_pins 函数分析1"></a>124.2 pinctrl_bind_pins 函数分析1</h3><p>在本小节中将对<code>pinctrl_bind_pins</code> 函数的具体内容进行详细讲解，该函数的具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">pinctrl_bind_pins</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token comment">// 检查设备是否重用了节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>of_node_reused<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 为设备的引脚分配内存空间</span>
    dev<span class="token operator">-&gt;</span>pins <span class="token operator">=</span> <span class="token function">devm_kzalloc</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dev<span class="token operator">-&gt;</span>pins<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
    
    <span class="token comment">// 获取设备的pinctrl 句柄</span>
    dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>p <span class="token operator">=</span> <span class="token function">devm_pinctrl_get</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dev_dbg</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"没有pinctrl 句柄\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup_alloc<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 查找设备的默认pinctrl 状态</span>
    dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>default_state <span class="token operator">=</span> <span class="token function">pinctrl_lookup_state</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>p<span class="token punctuation">,</span> PINCTRL_STATE_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>default_state<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dev_dbg</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"没有默认的pinctrl 状态\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup_get<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 查找设备的初始化pinctrl 状态</span>
    dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>init_state <span class="token operator">=</span> <span class="token function">pinctrl_lookup_state</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>p<span class="token punctuation">,</span> PINCTRL_STATE_INIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>init_state<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* 不提供此状态是完全合法的*/</span>
        <span class="token function">dev_dbg</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"没有初始化的pinctrl 状态\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 选择默认的pinctrl 状态</span>
        ret <span class="token operator">=</span> <span class="token function">pinctrl_select_state</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>p<span class="token punctuation">,</span> dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>default_state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 选择初始化的pinctrl 状态</span>
        ret <span class="token operator">=</span> <span class="token function">pinctrl_select_state</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>p<span class="token punctuation">,</span> dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>init_state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dev_dbg</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"无法激活初始的pinctrl 状态\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup_get<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_PM</span></span>
    <span class="token comment">/*
    * 如果启用了电源管理，我们还会寻找可选的睡眠和空闲的引脚状态，其语义在
    * &lt;linux/pinctrl/pinctrl-state.h&gt; 中定义
    */</span>
    dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>sleep_state <span class="token operator">=</span> <span class="token function">pinctrl_lookup_state</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>p<span class="token punctuation">,</span> PINCTRL_STATE_SLEEP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>sleep_state<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">/* 不提供此状态是完全合法的*/</span>
        <span class="token function">dev_dbg</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"没有睡眠的pinctrl 状态\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>idle_state <span class="token operator">=</span> <span class="token function">pinctrl_lookup_state</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>p<span class="token punctuation">,</span> PINCTRL_STATE_IDLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>idle_state<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">/* 不提供此状态是完全合法的*/</span>
        <span class="token function">dev_dbg</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"没有空闲的pinctrl 状态\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token comment">/*
    * 如果对于此设备没有找到pinctrl 句柄或默认状态，
    * 让我们明确释放设备中的引脚容器，因为保留它没有意义。
    */</span>
cleanup_get<span class="token operator">:</span>
    <span class="token function">devm_pinctrl_put</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
cleanup_alloc<span class="token operator">:</span>
    <span class="token function">devm_kfree</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> dev<span class="token operator">-&gt;</span>pins<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dev<span class="token operator">-&gt;</span>pins <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token comment">/* 返回延迟*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span>EPROBE_DEFER<span class="token punctuation">)</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    
    <span class="token comment">/* 返回严重错误*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">)</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    
    <span class="token comment">/* 我们忽略诸如-ENOENT 的错误，表示没有pinctrl 状态*/</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>（1）第5-7 行：函数检查设备是否重用了节点（dev-&gt;of_node_reused）。如果设备重用了节点，则直接返回0，表示绑定成功。<br>（2）第9-12 行：如果设备没有重用节点，则为设备的引脚分配内存空间。使用<code>devm_kzalloc</code> 函数分配了大小为<code>sizeof(*(dev-&gt;pins))</code> 的内存空间，并将其赋值给dev-&gt;pins。如果内存分配失败，则返回-ENOMEM。<br>（3）第14-20 行：获取设备的pinctrl 句柄。使用<code>devm_pinctrl_get</code> 函数获取设备的pinctrl句柄，并将其赋值给<code>dev-&gt;pins-&gt;p</code>。如果获取失败，函数会打印一条调试信息，并返回获取失败的错误码。（关于pinctrl_bind_pins 函数分析还没有完成，会在后面的章节继续分析）</p>
<p>在<code>pinctrl_bind_pins</code> 函数的第15 行使用<code>devm_pinctrl_get</code> 函数获取设备的pinctrl 句柄，该函数定义早内核源码目录下的“drivers/pinctrl/core.c”文件中具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token operator">*</span><span class="token function">devm_pinctrl_get</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token operator">*</span><span class="token operator">*</span>ptr<span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
    <span class="token comment">// 为存储引脚控制器句柄的指针分配内存</span>
    ptr <span class="token operator">=</span> <span class="token function">devres_alloc</span><span class="token punctuation">(</span>devm_pinctrl_release<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ptr<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span><span class="token operator">-</span>ENOMEM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 获取设备的引脚控制器句柄</span>
    p <span class="token operator">=</span> <span class="token function">pinctrl_get</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果获取成功，将引脚控制器句柄存储在指针中</span>
        <span class="token operator">*</span>ptr <span class="token operator">=</span> p<span class="token punctuation">;</span>
        <span class="token comment">// 将指针添加到设备资源中</span>
        <span class="token function">devres_add</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果获取失败，释放之前分配的指针内存</span>
        <span class="token function">devres_free</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 返回引脚控制器句柄或错误码指针</span>
    <span class="token keyword">return</span> p<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中最重要的内容为第10 行，使用pinctrl_get 函数获取引脚控制器句柄，我们继续跳转到该函数，该函数的具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token operator">*</span><span class="token function">pinctrl_get</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
    <span class="token comment">// 检查设备指针是否为空</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WARN_ON</span><span class="token punctuation">(</span><span class="token operator">!</span>dev<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span><span class="token operator">-</span>EINVAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*
    * 查看是否有其他组件（如设备核心）已经获取了此设备的引脚控制器句柄。
    * 在这种情况下，返回对该句柄的另一个指针。
    */</span>
    p <span class="token operator">=</span> <span class="token function">find_pinctrl</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dev_dbg</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"obtain a copy of previously claimed pinctrl\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">kref_get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>users<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> p<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 创建并返回设备的引脚控制器句柄</span>
    <span class="token keyword">return</span> <span class="token function">create_pinctrl</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>关于该函数的详细注释已经在上述内容中进行了添加，我们要注意的在返回值中使用的<code>create_pinctrl</code> 函数，该函数会创建并返回设设备的引脚控制器句柄，我们继续跳转到<code>create_pinctrl</code> 的函数定义，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token operator">*</span><span class="token function">create_pinctrl</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>devname<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_maps</span> <span class="token operator">*</span>maps_node<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl_map</span> <span class="token operator">*</span>map<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token comment">/*
    * 为每个映射创建状态cookie 持有者struct pinctrl。
    * 这是当使用pinctrl_get() 请求引脚控制句柄时消费者将获得的对象。
    */</span>
    p <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span><span class="token operator">-</span>ENOMEM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    p<span class="token operator">-&gt;</span>dev <span class="token operator">=</span> dev<span class="token punctuation">;</span>
    <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>states<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>dt_maps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">pinctrl_dt_to_map</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> pctldev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">kfree</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    devname <span class="token operator">=</span> <span class="token function">dev_name</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pinctrl_maps_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* 遍历引脚控制映射以定位正确的映射*/</span>
    <span class="token function">for_each_maps</span><span class="token punctuation">(</span>maps_node<span class="token punctuation">,</span> i<span class="token punctuation">,</span> map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* 映射必须适用于此设备*/</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>map<span class="token operator">-&gt;</span>dev_name<span class="token punctuation">,</span> devname<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token comment">/*
        * 如果pctldev 不为空，我们正在声明它的独占使用权，
        * 这意味着它自己提供了该设置。
        *
        * 因此，我们必须跳过适用于此设备但由其他设备提供的映射。
        */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pctldev <span class="token operator">&amp;&amp;</span> <span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token function">dev_name</span><span class="token punctuation">(</span>pctldev<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">,</span> map<span class="token operator">-&gt;</span>ctrl_dev_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">add_setting</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> pctldev<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*
        * 在这一点上，添加设置可能会导致：
        *
        * - 延迟，如果引脚控制设备尚不可用
        * - 失败，如果引脚控制设备尚不可用，
        * 并且该设置是一个独占设置。我们不能推迟它，因为
        * 该独占设置会在设备注册后立即生效。
        *
        * 如果返回的错误不是-EPROBE_DEFER，则我们将
        * 累积错误，以查看是否最终得到-EPROBE_DEFER，
        * 因为那是最糟糕的情况。
        */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span>EPROBE_DEFER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">pinctrl_free</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pinctrl_maps_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pinctrl_maps_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* 如果发生了除推迟以外的其他错误，则在此处返回*/</span>
        <span class="token function">pinctrl_free</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token function">kref_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>users<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* 将引脚控制句柄添加到全局列表*/</span>
    <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pinctrl_list_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>node<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pinctrl_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pinctrl_list_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> p<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>（1）第4 行-第9 行：函数声明了需要用到的变量和指针，其中struct pinctrl 类型的变量p用于表示创建的引脚控制器句柄，struct pinctrl 结构体用于表示引脚控制器。引脚控制器是硬件系统中管理和控制引脚（GPIO）的组件，它负责配置引脚的功能、电气属性等，该结构体定义在内核源码目录下的“drivers/pinctrl/core.h”文件中，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> node<span class="token punctuation">;</span> <span class="token comment">// 用于将引脚控制器添加到全局列表的链表节点</span>
    <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">;</span> <span class="token comment">// 关联的设备</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> states<span class="token punctuation">;</span> <span class="token comment">// 存储引脚配置状态的链表，用于跟踪不同的引脚配置状态</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_state</span> <span class="token operator">*</span>state<span class="token punctuation">;</span> <span class="token comment">// 当前应用的引脚配置状态</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> dt_maps<span class="token punctuation">;</span> <span class="token comment">// 存储设备树中定义的引脚映射信息的链表</span>
    <span class="token keyword">struct</span> <span class="token class-name">kref</span> users<span class="token punctuation">;</span> <span class="token comment">// 引脚控制器的引用计数，用于跟踪引脚控制器的引用数量</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>struct pinctrl_maps</code> 类型的变量<code>maps_node</code> 用于遍历引脚控制映射，引脚控制器映射描述了不同引脚控制器的功能和配置与实际硬件引脚之间的对应关系，该结构体定义在内核源码目录下的“<code>drivers/pinctrl/core.h</code>”文件中，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">pinctrl_maps</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> node<span class="token punctuation">;</span> <span class="token comment">// 引脚控制器映射链表节点，用于将该映射添加到全局列表</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl_map</span> <span class="token operator">*</span>maps<span class="token punctuation">;</span> <span class="token comment">// 指向引脚控制器映射数组的指针</span>
    <span class="token keyword">unsigned</span> num_maps<span class="token punctuation">;</span> <span class="token comment">// 引脚控制器映射数组中的映射数量</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其他结构体和变量已经讲解过了，这里就不再进行过多的赘述。<br>（2）第15-17 行：使用kzalloc 函数为p 分配内存，大小为sizeof(*p)，并将分配的内存清零。检查内存分配是否成功，如果失败则返回错误码-ENOMEM。<br>（3）第18 行：将dev 赋值给p-&gt;dev，表示引脚控制器与设备关联。<br>（3）第19-20 行：使用INIT_LIST_HEAD 宏初始化p-&gt;states 和p-&gt;dt_maps 字段，它们是链表头，用于存储引脚配置的状态和设备树映射。<br>（4）第22-26 行：调用pinctrl_dt_to_map 函数将设备树中定义的引脚映射信息转换为struct pinctrl_map 结构，并将其添加到p-&gt;dt_maps 链表中。如果转换过程中出现错误（返回值小于0），则释放之前分配的内存，并返回对应的错误码（关于create_pinctrl 函数的讲解在后面的章节会继续，这里要先跳转到他的子函数进行讲解）。</p>
<p>该函数定义在内核源码目录下的“<code>drivers/pinctrl/devicetree.c</code>”文件中，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">pinctrl_dt_to_map</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np <span class="token operator">=</span> p<span class="token operator">-&gt;</span>dev<span class="token operator">-&gt;</span>of_node<span class="token punctuation">;</span> <span class="token comment">// 获取引脚控制器关联设备的设备树节点</span>
    <span class="token keyword">int</span> state<span class="token punctuation">,</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">property</span> <span class="token operator">*</span>prop<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>statename<span class="token punctuation">;</span>
    <span class="token keyword">const</span> __be32 <span class="token operator">*</span>list<span class="token punctuation">;</span>
    <span class="token keyword">int</span> size<span class="token punctuation">,</span> config<span class="token punctuation">;</span>
    phandle phandle<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np_config<span class="token punctuation">;</span>
    
    <span class="token comment">/* 如果CONFIG_OF 启用，且p-&gt;dev 不是从设备树实例化而来*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>np<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">of_have_populated_dt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">dev_dbg</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"no of_node; not parsing pinctrl DT\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/* 节点内部存储属性名称的指针*/</span>
    <span class="token function">of_node_get</span><span class="token punctuation">(</span>np<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* 对于每个定义的状态ID */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>state <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">;</span> state<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* 获取pinctrl-* 属性*/</span>
        propname <span class="token operator">=</span> <span class="token function">kasprintf</span><span class="token punctuation">(</span>GFP_KERNEL<span class="token punctuation">,</span> <span class="token string">"pinctrl-%d"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
        prop <span class="token operator">=</span> <span class="token function">of_find_property</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> propname<span class="token punctuation">,</span> <span class="token operator">&amp;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">kfree</span><span class="token punctuation">(</span>propname<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">of_node_put</span><span class="token punctuation">(</span>np<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        list <span class="token operator">=</span> prop<span class="token operator">-&gt;</span>value<span class="token punctuation">;</span>
        size <span class="token operator">/=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* 判断pinctrl-names 属性是否命名了该状态*/</span>
        ret <span class="token operator">=</span> <span class="token function">of_property_read_string_index</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> <span class="token string">"pinctrl-names"</span><span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token operator">&amp;</span>statename<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*
        * 如果未命名，则statename 仅是整数状态ID。但是，为了避免动态分配和之后要释放的
        麻烦，
        * 可以直接将statename 指向属性名称的一部分。
        */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/* strlen("pinctrl-") == 8 */</span>
            statename <span class="token operator">=</span> prop<span class="token operator">-&gt;</span>name <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* 对于其中的每个引用的引脚配置节点*/</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>config <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> config <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> config<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            phandle <span class="token operator">=</span> <span class="token function">be32_to_cpup</span><span class="token punctuation">(</span>list<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">/* 查找引脚配置节点*/</span>
            np_config <span class="token operator">=</span> <span class="token function">of_find_node_by_phandle</span><span class="token punctuation">(</span>phandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>np_config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">dev_err</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"prop %s index %i invalid phandle\n"</span><span class="token punctuation">,</span> prop<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
                ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
                <span class="token keyword">goto</span> err<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">/* 解析节点*/</span>
            ret <span class="token operator">=</span> <span class="token function">dt_to_map_one_config</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> pctldev<span class="token punctuation">,</span> statename<span class="token punctuation">,</span> np_config<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">of_node_put</span><span class="token punctuation">(</span>np_config<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">goto</span> err<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/* 如果在设备树中没有条目，则生成一个虚拟状态表条目*/</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ret <span class="token operator">=</span> <span class="token function">dt_remember_dummy_state</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> statename<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">goto</span> err<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
err<span class="token operator">:</span>
    <span class="token function">pinctrl_dt_free_maps</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>（1）第3 行：获取与引脚控制器关联设备的设备树节点。<br>（2）第13-18 行：如果设备树节点为空，表示没有设备树信息可供解析。如果内核配置中启用了CONFIG_OF 选项，并且设备并非从设备树实例化，函数会打印一条调试信息并立即返回0。<br>（3）第21 行：增加设备树节点的引用计数，以确保在解析过程中节点不会被释放。<br>（4）第24-76 行：对于每个定义的状态ID，循环解析引脚控制器的映射信息具体会执行以下步骤：</p>
<ul>
<li>第26 行构造属性名称字符串propname，例如”pinctrl-0”、”pinctrl-1” 等等。</li>
<li>第27-35 行：使用of_find_property 函数获取设备树节点np 中的属性propname 的值，并得到属性值的大小size。如果属性不存在，则判断是否是第一个状态ID，如果是，则释放节点引用并返回-ENODEV 表示设备树节点中没有有效的pinctrl 描述。否则，跳出循环。</li>
<li>第36-37 行：将属性值转换为指针列表list，并计算列表的大小。</li>
<li>第40-49 行：如果设备树中的pinctrl-names 属性命名了该状态，则使用of_property_read_string_index 函数读取属性值，并将状态名称存储在statename 变量中。否则，将statename 指向属性名称的一部分，即去除”pinctrl-“ 前缀。</li>
<li>第51-76 行：对于每个引用的引脚配置节点，执行以下步骤：</li>
<li>第53 行：将list 指针指向的phandle 值转换为本地字节序。</li>
<li>第56 行-61 行：使用of_find_node_by_phandle 函数根据phandle 查找引脚配置节点，并将其存储在np_config 变量中。如果找不到引脚配置节点，则打印错误信息并返回-EINVAL。</li>
<li>第64 行：调用dt_to_map_one_config 函数，将引脚配置节点的信息解析为pinctrl 映射，并存储在pctldev 中。</li>
<li>第65 行：递减引脚配置节点的引用计数。</li>
<li>第70-75 行如果在设备树中没有条目，则生成一个虚拟状态表条目，以便后续处理。</li>
</ul>
<p>其中第64 行<code>dt_to_map_one_config</code> 函数需要特别注意，该函数会从设备树节点中解析出引脚控制器的映射表，并将其存储起来，该函数的具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">dt_to_map_one_config</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token operator">*</span>p<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>hog_pctldev<span class="token punctuation">,</span>
                                <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>statename<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np_config<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np_pctldev<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl_ops</span> <span class="token operator">*</span>ops<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_map</span> <span class="token operator">*</span>map<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> num_maps<span class="token punctuation">;</span>
    bool allow_default <span class="token operator">=</span> false<span class="token punctuation">;</span>
    
    <span class="token comment">/* 查找包含np_config 的引脚控制器*/</span>
    np_pctldev <span class="token operator">=</span> <span class="token function">of_node_get</span><span class="token punctuation">(</span>np_config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* 如果不允许默认配置，则读取pinctrl-use-default 属性*/</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>allow_default<span class="token punctuation">)</span>
        	allow_default <span class="token operator">=</span> <span class="token function">of_property_read_bool</span><span class="token punctuation">(</span>np_pctldev<span class="token punctuation">,</span><span class="token string">"pinctrl-use-default"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">/* 获取np_pctldev 的父节点*/</span>
        np_pctldev <span class="token operator">=</span> <span class="token function">of_get_next_parent</span><span class="token punctuation">(</span>np_pctldev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">/* 如果没有父节点或者父节点是根节点，则释放np_pctldev 引用并返回*/</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>np_pctldev <span class="token operator">||</span> <span class="token function">of_node_is_root</span><span class="token punctuation">(</span>np_pctldev<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">of_node_put</span><span class="token punctuation">(</span>np_pctldev<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">/* 检查是否延迟探测驱动程序状态*/</span>
            ret <span class="token operator">=</span> <span class="token function">driver_deferred_probe_check_state</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">/* 如果启用了模块并且不允许默认配置，并且返回值是-ENODEV，则延迟探测*/</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ENABLED</span><span class="token punctuation">(</span>CONFIG_MODULES<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>allow_default <span class="token operator">&amp;&amp;</span> ret <span class="token operator">==</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">)</span>
                ret <span class="token operator">=</span> <span class="token operator">-</span>EPROBE_DEFER<span class="token punctuation">;</span>
            <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">/* 如果正在创建一个hog，可以使用传递的pctldev */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hog_pctldev <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>np_pctldev <span class="token operator">==</span> p<span class="token operator">-&gt;</span>dev<span class="token operator">-&gt;</span>of_node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pctldev <span class="token operator">=</span> hog_pctldev<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">/* 通过np_pctldev 获取pinctrl_dev 结构体*/</span>
        pctldev <span class="token operator">=</span> <span class="token function">get_pinctrl_dev_from_of_node</span><span class="token punctuation">(</span>np_pctldev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">/* 如果获取到了pinctrl_dev 结构体，则跳出循环*/</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pctldev<span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        
        <span class="token comment">/* 不要推迟探测hogs（循环） */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>np_pctldev <span class="token operator">==</span> p<span class="token operator">-&gt;</span>dev<span class="token operator">-&gt;</span>of_node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">of_node_put</span><span class="token punctuation">(</span>np_pctldev<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">of_node_put</span><span class="token punctuation">(</span>np_pctldev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/*
    * 调用pinctrl 驱动程序解析设备树节点，并生成映射表条目
    */</span>
    ops <span class="token operator">=</span> pctldev<span class="token operator">-&gt;</span>desc<span class="token operator">-&gt;</span>pctlops<span class="token punctuation">;</span>
    
    <span class="token comment">/* 检查pinctrl 驱动程序是否支持设备树*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ops<span class="token operator">-&gt;</span>dt_node_to_map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dev_err</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"pctldev %s doesn't support DT\n"</span><span class="token punctuation">,</span>
        <span class="token function">dev_name</span><span class="token punctuation">(</span>pctldev<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/* 调用pinctrl 驱动程序的dt_node_to_map 方法*/</span>
    ret <span class="token operator">=</span> ops<span class="token operator">-&gt;</span><span class="token function">dt_node_to_map</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">,</span> np_config<span class="token punctuation">,</span> <span class="token operator">&amp;</span>map<span class="token punctuation">,</span> <span class="token operator">&amp;</span>num_maps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    
    <span class="token comment">/* 将映射表块存储起来以供后续使用*/</span>
    <span class="token keyword">return</span> <span class="token function">dt_remember_or_free_map</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> statename<span class="token punctuation">,</span> pctldev<span class="token punctuation">,</span> map<span class="token punctuation">,</span> num_maps<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>第15-51 行：通过循环查找包含指定设备树节点<code>np_config</code> 的引脚控制器。在循环中，会获取当前节点的父节点，并判断是否满足终止条件。如果找到了引脚控制器，将其赋值给变量pctldev，否则返回错误码。</li>
<li>第53-62 行：检查引脚控制器是否支持设备树操作，即是否实现了<code>dt_node_to_map</code> 方法。如果不支持，返回错误码。</li>
<li>第63-67 行：调用引脚控制器的<code>dt_node_to_map</code> 方法，将设备树节点<code>np_config</code> 转换为映射表条目。该方法会解析设备树节点，并根据节点信息生成映射表条目。具体的转换过程由各个引脚控制器的驱动程序实现。</li>
<li>第69 行：将生成的映射表条目存储起来，以供后续使用。存储的操作由函数<code>dt_remember_or_free_map</code> 完成。<br>至此，关于<code>pinctrl_bind_pins</code> 函数的第一阶段分析就完成了，在<code>pinctrl_bind_pins</code> 函数的第一阶段详细讲解了设备树节点转换为<code>pinctrl_map</code> 的流程，在下一小节将对<code>pinctrl_bind_pins</code>函数做进一步分析。</li>
</ul>
<h3 id="124-3-pinctrl-bind-pins-函数分析2"><a href="#124-3-pinctrl-bind-pins-函数分析2" class="headerlink" title="124.3 pinctrl_bind_pins 函数分析2"></a>124.3 pinctrl_bind_pins 函数分析2</h3><p>上一小节最后讲解的dt_to_map_one_config 函数用于从设备树节点中解析出引脚控制器的映射表并存储起来，而存储的操作由函数dt_remember_or_free_map 完成，该函数的具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">dt_remember_or_free_map</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>statename<span class="token punctuation">,</span>
                           <span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_map</span> <span class="token operator">*</span>map<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> num_maps<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_dt_map</span> <span class="token operator">*</span>dt_map<span class="token punctuation">;</span>
    
    <span class="token comment">/* 初始化公共映射表条目字段*/</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_maps<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>devname<span class="token punctuation">;</span>
        <span class="token comment">/* 复制设备名称*/</span>
        devname <span class="token operator">=</span> <span class="token function">kstrdup_const</span><span class="token punctuation">(</span><span class="token function">dev_name</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>devname<span class="token punctuation">)</span>
            <span class="token keyword">goto</span> err_free_map<span class="token punctuation">;</span>
        <span class="token comment">/* 设置映射表条目的设备名称、状态名称和控制器设备名称*/</span>
        map<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>dev_name <span class="token operator">=</span> devname<span class="token punctuation">;</span>
        map<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name <span class="token operator">=</span> statename<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pctldev<span class="token punctuation">)</span>
            map<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ctrl_dev_name <span class="token operator">=</span> <span class="token function">dev_name</span><span class="token punctuation">(</span>pctldev<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/* 记录转换后的映射表条目*/</span>
    dt_map <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>dt_map<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dt_map<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> err_free_map<span class="token punctuation">;</span>
    dt_map<span class="token operator">-&gt;</span>pctldev <span class="token operator">=</span> pctldev<span class="token punctuation">;</span>
    dt_map<span class="token operator">-&gt;</span>map <span class="token operator">=</span> map<span class="token punctuation">;</span>
    dt_map<span class="token operator">-&gt;</span>num_maps <span class="token operator">=</span> num_maps<span class="token punctuation">;</span>
    <span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dt_map<span class="token operator">-&gt;</span>node<span class="token punctuation">,</span> <span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>dt_maps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* 注册映射表条目*/</span>
    <span class="token keyword">return</span> <span class="token function">pinctrl_register_mappings</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> num_maps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
err_free_map<span class="token operator">:</span>
    <span class="token comment">/* 释放映射表条目内存*/</span>
    <span class="token function">dt_free_map</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">,</span> map<span class="token punctuation">,</span> num_maps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>函数传递参数：</p>
<ul>
<li>p：指向struct pinctrl 结构体的指针，表示引脚控制器的上下文。</li>
<li>statename：指向状态名称的指针，表示要设置的状态的名称。</li>
<li>pctldev：指向struct pinctrl_dev 结构体的指针，表示引脚控制器设备。</li>
<li>map：指向struct pinctrl_map 结构体数组的指针，表示解析得到的映射表条目。</li>
<li>num_maps：表示映射表条目的数量。</li>
</ul>
<p>（1）第9-22 行：通过循环遍历映射表条目数组，为每个条目初始化公共字段。<br>首先，通过kstrdup_const 函数复制引脚控制器设备的名称，并将返回的指针赋值给devname。<br>然后，将设备名称、状态名称和控制器设备名称分别赋值给映射表条目的对应字段。</p>
<p>（2）第25-32 行：分配并初始化一个struct pinctrl_dt_map 结构体，用于存储映射表的相关信息，并将其添加到<code>p-&gt;dt_maps</code> 链表的尾部。</p>
<ul>
<li>使用kzalloc 分配内存空间，并将返回的指针赋值给dt_map。</li>
<li>将传入的pctldev、map 和num_maps 分别赋值给dt_map 的对应字段。</li>
<li>使用list_add_tail 函数将dt_map 添加到p-&gt;dt_maps 链表中。</li>
</ul>
<p><code>struct pinctrl_dt_map</code> 结构体结构体的具体内容如下所示</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dt_map</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> node<span class="token punctuation">;</span><span class="token comment">//用于将映射表结构体添加到pinctrl 的dt_maps 链表中</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">;</span><span class="token comment">// 引脚控制器设备</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_map</span> <span class="token operator">*</span>map<span class="token punctuation">;</span><span class="token comment">// 映射表条目数组</span>
    <span class="token keyword">unsigned</span> num_maps<span class="token punctuation">;</span><span class="token comment">//映射表条目数量</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>（3）第35 行：用<code>pinctrl_register_mappings</code> 函数注册映射表条目。该函数将映射表条目注册到pinctrl 子系统，以便后续可以通过相关接口进行引脚配置和管理。<br>接下来跳转到<code>pinctrl_register_mappings</code> 函数，该函数定义在内核源码目录下的”<code>drivers/pinctrl/core.c</code>“文件中，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/**
* pinctrl_register_mappings - 注册引脚控制器映射表
*
* @maps: 指向映射表条目数组的指针
* @num_maps: 映射表条目数量
*
* 返回值：0 表示注册成功，负值表示注册失败
*/</span>
<span class="token keyword">int</span> <span class="token function">pinctrl_register_mappings</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl_map</span> <span class="token operator">*</span>maps<span class="token punctuation">,</span><span class="token keyword">unsigned</span> num_maps<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_maps</span> <span class="token operator">*</span>maps_node<span class="token punctuation">;</span>
    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"add %u pinctrl maps\n"</span><span class="token punctuation">,</span> num_maps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* 首先对新映射表进行合法性检查*/</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_maps<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 检查设备名称是否存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>maps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>dev_name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"failed to register map %s (%d): no device given\n"</span><span class="token punctuation">,</span>maps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 检查映射表名称是否存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>maps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"failed to register map %d: no map name given\n"</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 对于引脚映射类型和配置映射类型，检查引脚控制设备名称是否存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>maps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">!=</span> PIN_MAP_TYPE_DUMMY_STATE <span class="token operator">&amp;&amp;</span><span class="token operator">!</span>maps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ctrl_dev_name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"failed to register map %s (%d): no pin control device given\n"</span><span class="token punctuation">,</span>maps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>maps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> PIN_MAP_TYPE_DUMMY_STATE<span class="token operator">:</span>
                <span class="token comment">// 对于虚拟状态映射类型，不进行验证</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> PIN_MAP_TYPE_MUX_GROUP<span class="token operator">:</span>
                <span class="token comment">// 对于复用组映射类型，进行引脚复用映射验证</span>
                ret <span class="token operator">=</span> <span class="token function">pinmux_validate_map</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>maps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> PIN_MAP_TYPE_CONFIGS_PIN<span class="token operator">:</span>
            <span class="token keyword">case</span> PIN_MAP_TYPE_CONFIGS_GROUP<span class="token operator">:</span>
                <span class="token comment">// 对于配置映射类型，进行引脚配置映射验证</span>
                ret <span class="token operator">=</span> <span class="token function">pinconf_validate_map</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>maps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token comment">// 对于无效的映射类型，返回错误</span>
                <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"failed to register map %s (%d): invalid type given\n"</span><span class="token punctuation">,</span>maps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 分配映射表节点内存</span>
    maps_node <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>maps_node<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>maps_node<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
    
    <span class="token comment">// 设置映射表节点的映射表和映射表数量</span>
    maps_node<span class="token operator">-&gt;</span>maps <span class="token operator">=</span> maps<span class="token punctuation">;</span>
    maps_node<span class="token operator">-&gt;</span>num_maps <span class="token operator">=</span> num_maps<span class="token punctuation">;</span>
    
    <span class="token comment">// 加锁并将映射表节点插入映射表链表末尾</span>
    <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pinctrl_maps_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>maps_node<span class="token operator">-&gt;</span>node<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pinctrl_maps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pinctrl_maps_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>函数的参数为maps 和num_maps，其中maps 是指向映射表条目数组的指针，num_maps是映射表条目的数量。</p>
<p>（1）第18-64 行：进行一些合法性检查。对于每一个映射表条目，会进行以下的检查操作：</p>
<ul>
<li><p>第20-24 行：检查设备名称是否存在</p>
</li>
<li><p>第26-31 行：检查映射表名称是否存在，如果不存在则返回一个错误码。</p>
</li>
<li><p>第33-39 行：对于引脚映射类型和配置映射类型，检查引脚控制设备名称是否存在，如果不存在则返回一个错误码。</p>
</li>
<li><p>第41-63 行：根据映射表的类型做对应的验证操作：</p>
<p>​	如果类型是PIN_MAP_TYPE_DUMMY_STATE，表示是虚拟状态映射类型，不进行验证。<br>​	如果类型是PIN_MAP_TYPE_MUX_GROUP，表示是复用组映射类型，需要进行引脚复用映射的验证。<br>​	如果类型是PIN_MAP_TYPE_CONFIGS_PIN 或PIN_MAP_TYPE_CONFIGS_GROUP，表示是配置映射类型，	需要进行引脚配置映射的验证。<br>​	如果类型不是以上这些有效的类型，则返回一个错误码。</p>
</li>
</ul>
<p>（2）第66-73 行：函数会分配映射表节点的内存，并将映射表和映射表数量设置到映射表节点中。<br>（3）第75-78 行：函数会获取一个互斥锁，将映射表节点插入到映射表链表的末尾，并释放互斥锁。</p>
<p>pinctrl_register_mappings 函数的作用是注册一个引脚控制器的映射表，进行了一些参数合法性检查和验证，并将映射表节点插入到映射表链表中。<br>到这里关于pinctrl_bind_pins 函数的第二阶段讲解就完成了，在该阶段大多都是关于赋值的操作并将节点加入到链表中， 但分析到这里我们仍旧没有找到<code>struct pinctrl_state*default_state</code> 和<code>pinctrl_map</code> 结构体是在什么地方进行的绑定，所以在下个章节我们将继续分析124.2 小节中create_pinctrl 函数接下来的部分。</p>
<h2 id="第125-章add-setting-函数分析"><a href="#第125-章add-setting-函数分析" class="headerlink" title="第125 章add_setting 函数分析"></a>第125 章add_setting 函数分析</h2><p>这里继续讲解在上一章中没有讲解完成的<code>create_pinctrl</code> 函数，该函数的具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token operator">*</span><span class="token function">create_pinctrl</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>devname<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_maps</span> <span class="token operator">*</span>maps_node<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl_map</span> <span class="token operator">*</span>map<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    
    <span class="token comment">/*
    * 为每个映射创建状态cookie 持有者struct pinctrl。
    * 这是当使用pinctrl_get() 请求引脚控制句柄时消费者将获得的对象。
    */</span>
    p <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span><span class="token operator">-</span>ENOMEM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    p<span class="token operator">-&gt;</span>dev <span class="token operator">=</span> dev<span class="token punctuation">;</span>
    <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>states<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>dt_maps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    ret <span class="token operator">=</span> <span class="token function">pinctrl_dt_to_map</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> pctldev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">kfree</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    devname <span class="token operator">=</span> <span class="token function">dev_name</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pinctrl_maps_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* 遍历引脚控制映射以定位正确的映射*/</span>
    <span class="token function">for_each_maps</span><span class="token punctuation">(</span>maps_node<span class="token punctuation">,</span> i<span class="token punctuation">,</span> map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* 映射必须适用于此设备*/</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>map<span class="token operator">-&gt;</span>dev_name<span class="token punctuation">,</span> devname<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token comment">/*
        * 如果pctldev 不为空，我们正在声明它的独占使用权，
        * 这意味着它自己提供了该设置。
        *
        * 因此，我们必须跳过适用于此设备但由其他设备提供的映射。
        */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pctldev <span class="token operator">&amp;&amp;</span> <span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token function">dev_name</span><span class="token punctuation">(</span>pctldev<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">,</span> map<span class="token operator">-&gt;</span>ctrl_dev_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">add_setting</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> pctldev<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*
        * 在这一点上，添加设置可能会导致：
        *
        * - 延迟，如果引脚控制设备尚不可用
        * - 失败，如果引脚控制设备尚不可用，
        * 并且该设置是一个独占设置。我们不能推迟它，因为
        * 该独占设置会在设备注册后立即生效。
        *
        * 如果返回的错误不是-EPROBE_DEFER，则我们将
        * 累积错误，以查看是否最终得到-EPROBE_DEFER，
        * 因为那是最糟糕的情况。
        */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span>EPROBE_DEFER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">pinctrl_free</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pinctrl_maps_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pinctrl_maps_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* 如果发生了除推迟以外的其他错误，则在此处返回*/</span>
        <span class="token function">pinctrl_free</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">kref_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>users<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* 将引脚控制句柄添加到全局列表*/</span>
    <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pinctrl_list_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>node<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pinctrl_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pinctrl_list_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> p<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在上一章节，关于<code>create_pinctrl</code> 函数我们分析到了第22 行的<code>pinctrl_dt_to_map</code> 函数，但我们还并没有找到<code>dev_pin_info</code> 结构体和map 是在什么时候进行的绑定，所以我们继续向下分析，在第32 行使用<code>for_each_maps</code> 宏定义对引脚控制映射进行了遍历，该宏定义定义在内核源码目录下的“<code>drivers/pinctrl/core.h</code>”文件中，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 宏定义：用于遍历映射表链表中的每个映射表条目</span>
<span class="token comment">// _maps_node_: 遍历时使用的映射表节点指针</span>
<span class="token comment">// _i_: 遍历时使用的计数器变量</span>
<span class="token comment">// _map_: 遍历时使用的映射表条目指针</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">for_each_maps</span><span class="token expression"><span class="token punctuation">(</span>_maps_node_<span class="token punctuation">,</span> _i_<span class="token punctuation">,</span> _map_<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token function">list_for_each_entry</span><span class="token punctuation">(</span>_maps_node_<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pinctrl_maps<span class="token punctuation">,</span> node<span class="token punctuation">)</span> \ </span><span class="token comment">// 遍历映射表链表中的每个节点</span></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>_i_ <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> _map_ <span class="token operator">=</span> <span class="token operator">&amp;</span>_maps_node_<span class="token operator">-&gt;</span>maps<span class="token punctuation">[</span>_i_<span class="token punctuation">]</span><span class="token punctuation">;</span> \ <span class="token comment">// 初始化计数器和映射表条目指针</span>
            _i_ <span class="token operator">&lt;</span> _maps_node_<span class="token operator">-&gt;</span>num_maps<span class="token punctuation">;</span> \ <span class="token comment">// 循环条件：计数器小于当前节点的映射表数量</span>
            _i_<span class="token operator">++</span><span class="token punctuation">,</span> _map_ <span class="token operator">=</span> <span class="token operator">&amp;</span>_maps_node_<span class="token operator">-&gt;</span>maps<span class="token punctuation">[</span>_i_<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 每次循环增加计数器并更新映射表条目指针</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在遍历过程中，首先会检查映射的设备名称是否与当前设备的名称匹配，如果不匹配则跳过。当检查pctldev 不为空且映射是为pctldev 提供的，则跳过该映射。<br>检查完成之后调用<code>add_setting</code> 函数将映射添加到引脚控制器中，这里的add_setting 就是本章节要讲解的重点，该函数的具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">add_setting</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span>
                       <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl_map</span> <span class="token operator">*</span>map<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_state</span> <span class="token operator">*</span>state<span class="token punctuation">;</span> <span class="token comment">// 状态对象指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_setting</span> <span class="token operator">*</span>setting<span class="token punctuation">;</span> <span class="token comment">// 设置对象指针</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    
    <span class="token comment">// 查找状态对象，如果不存在则创建新的状态对象</span>
    state <span class="token operator">=</span> <span class="token function">find_state</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> map<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">)</span>
        state <span class="token operator">=</span> <span class="token function">create_state</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> map<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 如果映射类型为虚拟状态映射类型，直接返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token operator">-&gt;</span>type <span class="token operator">==</span> PIN_MAP_TYPE_DUMMY_STATE<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 分配设置对象的内存空间</span>
    setting <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>setting<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>setting<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>

    setting<span class="token operator">-&gt;</span>type <span class="token operator">=</span> map<span class="token operator">-&gt;</span>type<span class="token punctuation">;</span> <span class="token comment">// 设置设置对象的映射类型</span>
    
    <span class="token comment">// 设置设置对象的引脚控制设备</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pctldev<span class="token punctuation">)</span>
        setting<span class="token operator">-&gt;</span>pctldev <span class="token operator">=</span> pctldev<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        setting<span class="token operator">-&gt;</span>pctldev <span class="token operator">=</span> <span class="token function">get_pinctrl_dev_from_devname</span><span class="token punctuation">(</span>map<span class="token operator">-&gt;</span>ctrl_dev_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>setting<span class="token operator">-&gt;</span>pctldev<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">kfree</span><span class="token punctuation">(</span>setting<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果引脚控制设备不存在，返回错误</span>
        <span class="token comment">// 注意：不推迟探测hogs（循环依赖）</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>map<span class="token operator">-&gt;</span>ctrl_dev_name<span class="token punctuation">,</span> map<span class="token operator">-&gt;</span>dev_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">;</span>
        <span class="token comment">/*
        * 好吧，我们假设驱动程序目前不存在，
        * 让我们将获取此pinctrl 句柄推迟到以后...
        */</span>
        <span class="token function">dev_info</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"unknown pinctrl device %s in map entry, deferring probe"</span><span class="token punctuation">,</span>
                 map<span class="token operator">-&gt;</span>ctrl_dev_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EPROBE_DEFER<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 设置设置对象的设备名称</span>
    setting<span class="token operator">-&gt;</span>dev_name <span class="token operator">=</span> map<span class="token operator">-&gt;</span>dev_name<span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>map<span class="token operator">-&gt;</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> PIN_MAP_TYPE_MUX_GROUP<span class="token operator">:</span>
            <span class="token comment">// 对于复用组映射类型，执行引脚复用映射到设置对象的转换</span>
            ret <span class="token operator">=</span> <span class="token function">pinmux_map_to_setting</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> setting<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
            
        <span class="token keyword">case</span> PIN_MAP_TYPE_CONFIGS_PIN<span class="token operator">:</span>
        <span class="token keyword">case</span> PIN_MAP_TYPE_CONFIGS_GROUP<span class="token operator">:</span>
            <span class="token comment">// 对于配置映射类型，执行引脚配置映射到设置对象的转换</span>
            ret <span class="token operator">=</span> <span class="token function">pinconf_map_to_setting</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> setting<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
            
        <span class="token keyword">default</span><span class="token operator">:</span>
            ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">kfree</span><span class="token punctuation">(</span>setting<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 将设置对象插入状态对象的设置链表末尾</span>
    <span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>setting<span class="token operator">-&gt;</span>node<span class="token punctuation">,</span> <span class="token operator">&amp;</span>state<span class="token operator">-&gt;</span>settings<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>（1）第4-5 行： 分别定义了一个struct pinctrl_state * 类型的状态对象指针和<code>structpinctrl_setting *</code> 的设置对象指针， <code>struct pinctrl_state</code> 结构体定义在内核源码目录下的“drivers/pinctrl/core.h”文件中，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">pinctrl_state</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> node<span class="token punctuation">;</span> <span class="token comment">// 链表节点，用于将状态对象连接到引脚控制器对象的状态链表</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span> <span class="token comment">// 状态对象的名称字符串指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> settings<span class="token punctuation">;</span> <span class="token comment">// 设置对象链表，包含该状态的所有设置对象</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>而struct pinctrl_setting 结构体定义在内核源码目录下的“drivers/pinctrl/core.h”文件中，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">pinctrl_setting</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> node<span class="token punctuation">;</span> <span class="token comment">// 链表节点，用于将设置对象连接到状态对象的设置链表</span>
    <span class="token keyword">enum</span> <span class="token class-name">pinctrl_map_type</span> type<span class="token punctuation">;</span> <span class="token comment">// 映射类型，表示设置对象的类型</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">;</span> <span class="token comment">// 引脚控制设备对象指针</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>dev_name<span class="token punctuation">;</span> <span class="token comment">// 设备名称字符串指针</span>
    
    <span class="token keyword">union</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">pinctrl_setting_mux</span> mux<span class="token punctuation">;</span> <span class="token comment">// 复用组映射类型的数据结构</span>
        <span class="token keyword">struct</span> <span class="token class-name">pinctrl_setting_configs</span> configs<span class="token punctuation">;</span> <span class="token comment">// 配置映射类型的数据结构</span>
    <span class="token punctuation">}</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>（2）第8-13 行：根据映射表条目的名称，使用<code>find_state</code> 函数在引脚控制器对象中查找对应的状态对象，在此之前我们并没有设置状态对象，所以会进入到第二个if 判断，使用<code>create_state</code> 函数创建新的状态对象。<code>create_state</code> 函数内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl_state</span> <span class="token operator">*</span><span class="token function">create_state</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token operator">*</span>p<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_state</span> <span class="token operator">*</span>state<span class="token punctuation">;</span>
    
    <span class="token comment">// 为pinctrl_state 结构体分配内存</span>
    state <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>state<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">)</span>
        <span class="token comment">// 内存分配失败，返回错误指针</span>
        <span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span><span class="token operator">-</span>ENOMEM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 设置状态的名称</span>
    state<span class="token operator">-&gt;</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    
    <span class="token comment">// 初始化状态的设置列表</span>
    <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>state<span class="token operator">-&gt;</span>settings<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 将状态添加到pinctrl 的状态链表中</span>
    <span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>state<span class="token operator">-&gt;</span>node<span class="token punctuation">,</span> <span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>states<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> state<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>（3）第15-17 行：如果映射类型为虚拟状态映射类型（PIN_MAP_TYPE_DUMMY_STATE），直接返回成功。</li>
<li>（4）第19-22 行：分配一个设置对象的内存空间。</li>
<li>（5）第24 行：设置对象的映射类型为映射表条目中定义的类型。</li>
<li>（6）第26-56 行：根据情况设置设置对象的引脚控制设备：<ul>
<li>如果pctldev 参数为非空，则将其设置为设置对象的引脚控制设备。</li>
<li>如果pctldev 参数为空，则根据映射表条目中的ctrl_dev_name，使用<code>get_pinctrl_dev_from_devname</code> 函数获取引脚控制设备对象，并将其设置为设置对象的引脚控制设备。</li>
<li>如果获取的引脚控制设备对象为空，说明引脚控制设备不存在，释放设置对象的内存空间并返回错误。如果<code>ctrl_dev_name</code> 与<code>dev_name</code> 相同，表示映射表条目中的设备名称与控制设备名称相同，返回错误码<code>-ENODEV</code>。如果不相同，表示引脚控制设备目前不存在，打印一条信息并返回错误码<code>-EPROBE_DEFER</code>，表示推迟探测引脚控制设备。</li>
</ul>
</li>
<li>（7）第48 行：设置设置对象的设备名称为映射表条目中的dev_name。</li>
<li>（8）第50-63 行：根据设置对象的映射类型执行相应的映射转换操作：<ul>
<li>对于复用组映射类型（PIN_MAP_TYPE_MUX_GROUP），调用pinmux_map_to_setting 函数执行引脚复用映射到设置对象的转换。</li>
<li>对于配置映射类型（PIN_MAP_TYPE_CONFIGS_PIN 或PIN_MAP_TYPE_CONFIGS_GROUP），调用pinconf_map_to_setting 函数执行引脚配置映射到设置对象的转换。对于其他映射类型，返回错误码-EINVAL。</li>
</ul>
</li>
<li>（9）第64 行：如果映射转换操作失败（返回值小于0），释放设置对象的内存空间并返回错误码。</li>
<li>（10）第70 行：将设置对象插入状态对象的设置链表末尾。</li>
</ul>
<p>接下来对第50-63 行中用到的<code>pinmux_map_to_setting</code> 函数和<code>pinconf_map_to_setting</code> 函数进行详细的讲解， <code>pinmux_map_to_setting</code> 函数定义在内核源码目录下的“<code>drivers/pinctrl/pinmux.c</code>”文件中，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/**
* pinmux_map_to_setting - 将引脚映射转换为设置对象
*
* @map: 引脚映射结构指针
* @setting: 引脚设置结构指针
*
* 返回值：0 表示转换成功，负值表示转换失败
*/</span>
<span class="token keyword">int</span> <span class="token function">pinmux_map_to_setting</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl_map</span> <span class="token operator">*</span>map<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_setting</span> <span class="token operator">*</span>setting<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev <span class="token operator">=</span> setting<span class="token operator">-&gt;</span>pctldev<span class="token punctuation">;</span> <span class="token comment">// 获取引脚控制设备指针</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pinmux_ops</span> <span class="token operator">*</span>pmxops <span class="token operator">=</span> pctldev<span class="token operator">-&gt;</span>desc<span class="token operator">-&gt;</span>pmxops<span class="token punctuation">;</span> <span class="token comment">// 获取引脚复用操作指针</span>
    <span class="token keyword">char</span> <span class="token keyword">const</span> <span class="token operator">*</span> <span class="token keyword">const</span> <span class="token operator">*</span>groups<span class="token punctuation">;</span> <span class="token comment">// 引脚复用组数组</span>
    <span class="token keyword">unsigned</span> num_groups<span class="token punctuation">;</span> <span class="token comment">// 引脚复用组数量</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>group<span class="token punctuation">;</span> <span class="token comment">// 引脚复用组名称</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pmxops<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dev_err</span><span class="token punctuation">(</span>pctldev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"does not support mux function\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 将复用函数名称转换为选择器</span>
    ret <span class="token operator">=</span> <span class="token function">pinmux_func_name_to_selector</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">,</span> map<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>mux<span class="token punctuation">.</span>function<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dev_err</span><span class="token punctuation">(</span>pctldev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"invalid function %s in map table\n"</span><span class="token punctuation">,</span>
        map<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>mux<span class="token punctuation">.</span>function<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    setting<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>mux<span class="token punctuation">.</span>func <span class="token operator">=</span> ret<span class="token punctuation">;</span> <span class="token comment">// 设置设置对象的复用函数选择器</span>
    <span class="token comment">// 查询函数对应的复用组信息</span>
    ret <span class="token operator">=</span> pmxops<span class="token operator">-&gt;</span><span class="token function">get_function_groups</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">,</span> setting<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>mux<span class="token punctuation">.</span>func<span class="token punctuation">,</span> <span class="token operator">&amp;</span>groups<span class="token punctuation">,</span> <span class="token operator">&amp;</span>num_groups<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dev_err</span><span class="token punctuation">(</span>pctldev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"can't query groups for function %s\n"</span><span class="token punctuation">,</span>
        map<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>mux<span class="token punctuation">.</span>function<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>num_groups<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dev_err</span><span class="token punctuation">(</span>pctldev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span><span class="token string">"function %s can't be selected on any group\n"</span><span class="token punctuation">,</span> map<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>mux<span class="token punctuation">.</span>function<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>mux<span class="token punctuation">.</span>group<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        group <span class="token operator">=</span> map<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>mux<span class="token punctuation">.</span>group<span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">match_string</span><span class="token punctuation">(</span>groups<span class="token punctuation">,</span> num_groups<span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">dev_err</span><span class="token punctuation">(</span>pctldev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span><span class="token string">"invalid group \"%s\" for function \"%s\"\n"</span><span class="token punctuation">,</span>
                    map<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>mux<span class="token punctuation">.</span>function<span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        group <span class="token operator">=</span> groups<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 获取复用组的选择器</span>
    ret <span class="token operator">=</span> <span class="token function">pinctrl_get_group_selector</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dev_err</span><span class="token punctuation">(</span>pctldev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"invalid group %s in map table\n"</span><span class="token punctuation">,</span>map<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>mux<span class="token punctuation">.</span>group<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    setting<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>mux<span class="token punctuation">.</span>group <span class="token operator">=</span> ret<span class="token punctuation">;</span> <span class="token comment">// 设置设置对象的复用组选择器</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该函数的作用是将引脚映射转换为设置对象。<br>（1）第19-22 行：检查引脚控制设备是否支持引脚复用操作，如果不支持，则返回错误。<br>（2）第24-31 行：将映射表中的复用函数名称转换为复用函数的选择器，并将其保存在设置对象的data.mux.func 字段中。<br>（3）第33-46 行：通过调用引脚复用操作对象的get_function_groups 函数查询复用函数对应的复用组信息，获取复用组的名称数组和数量，并将它们保存在groups 和num_groups 变量中。如果没有任何复用组可供选择，则返回错误。<br>（4）第47-58 行：根据映射表中指定的复用组名称或者选择第一个复用组名称，并在复用组数组中查找对应的索引。<br>（5）第60-67 行：通过调用引脚控制设备对象的pinctrl_get_group_selector 函数获取复用组的选择器，并将它保存在设置对象的data.mux.group</p>
<p><code>pinconf_map_to_setting</code> 函数定义在内核源码目录下的“<code>drivers/pinctrl/pinconf.c</code>”文件中，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/**
* pinconf_map_to_setting - 将引脚配置映射转换为设置对象
*
* @map: 引脚映射结构指针
* @setting: 引脚设置结构指针
*
* 返回值：0 表示转换成功，负值表示转换失败
*/</span>
<span class="token keyword">int</span> <span class="token function">pinconf_map_to_setting</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl_map</span> <span class="token operator">*</span>map<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl_setting</span> <span class="token operator">*</span>setting<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev <span class="token operator">=</span> setting<span class="token operator">-&gt;</span>pctldev<span class="token punctuation">;</span> <span class="token comment">// 获取引脚控制设备指针</span>
    <span class="token keyword">int</span> pin<span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>setting<span class="token operator">-&gt;</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> PIN_MAP_TYPE_CONFIGS_PIN<span class="token operator">:</span> <span class="token comment">// 针对单个引脚的配置</span>
            pin <span class="token operator">=</span> <span class="token function">pin_get_from_name</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">,</span> map<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>configs<span class="token punctuation">.</span>group_or_pin<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通过引脚名称获取引脚号</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pin <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">dev_err</span><span class="token punctuation">(</span>pctldev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"could not map pin config for \"%s\""</span><span class="token punctuation">,</span>
                        map<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>configs<span class="token punctuation">.</span>group_or_pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> pin<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            setting<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>configs<span class="token punctuation">.</span>group_or_pin <span class="token operator">=</span> pin<span class="token punctuation">;</span> <span class="token comment">// 设置设置对象的引脚号</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
            
        <span class="token keyword">case</span> PIN_MAP_TYPE_CONFIGS_GROUP<span class="token operator">:</span> <span class="token comment">// 针对引脚组的配置</span>
            pin <span class="token operator">=</span> <span class="token function">pinctrl_get_group_selector</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">,</span> 
                                          map<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>configs<span class="token punctuation">.</span>group_or_pin<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取引脚组的选择器</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pin <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">dev_err</span><span class="token punctuation">(</span>pctldev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"could not map pin config for \"%s\""</span><span class="token punctuation">,</span>
                        map<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>configs<span class="token punctuation">.</span>group_or_pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> pin<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            setting<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>configs<span class="token punctuation">.</span>group_or_pin <span class="token operator">=</span> pin<span class="token punctuation">;</span> <span class="token comment">// 设置设置对象的引脚组选择器</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
            
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    setting<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>configs<span class="token punctuation">.</span>num_configs <span class="token operator">=</span> map<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>configs<span class="token punctuation">.</span>num_configs<span class="token punctuation">;</span> <span class="token comment">// 设置设置对象的配置数量</span>
    setting<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>configs<span class="token punctuation">.</span>configs <span class="token operator">=</span> map<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>configs<span class="token punctuation">.</span>configs<span class="token punctuation">;</span> <span class="token comment">// 设置设置对象的配置指针</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该函数的作用是将引脚配置映射转换为设置对象。</p>
<ul>
<li>（1）第15-38 行：根据设置对象的类型进行不同的处理：<ul>
<li>对于针对单个引脚的配置，通过调用pin_get_from_name 函数，根据映射表中的引脚名<br>称获取引脚号，并将其设置到设置对象的data.configs.group_or_pin 字段中。如果获取引脚号<br>失败，则返回错误。</li>
<li>对于针对引脚组的配置，它通过调用pinctrl_get_group_selector 函数，根据映射表中的<br>引脚组名称获取引脚组的选择器，并将其设置到设置对象的data.configs.group_or_pin 字段中。</li>
<li>如果获取引脚组选择器失败，则返回错误。</li>
</ul>
</li>
<li>（2）第40-42 行：设置设置对象的配置数量和配置指针，分别从映射表中获取。完成转换<br>后，函数返回0 表示转换成功。</li>
</ul>
<p>至此，关于<code>add_setting</code> 函数的讲解就完成了，<code>add_setting</code> 函数的最终目的就是将传入的<code>const struct pinctrl_map *map</code> 的参数值传入到<code>struct pinctrl_setting</code> 类型的变量中，从而进一步提取<code>pinctrl_map</code> 结构体类型变量中的内容。</p>
<h2 id="第126-章通过pinctrl-状态设置引脚复用实验"><a href="#第126-章通过pinctrl-状态设置引脚复用实验" class="headerlink" title="第126 章通过pinctrl 状态设置引脚复用实验"></a>第126 章通过pinctrl 状态设置引脚复用实验</h2><p>在上一个小节中讲解了<code>add_setting</code> 函数，关于他的上层函数<code>create_pinctrl</code> 也就讲解完成了，然后继续分析<code>pinctrl_bind_pins</code> 函数，<code>pinctrl_bind_pins</code> 函数内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">pinctrl_bind_pins</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    
    <span class="token comment">// 检查设备是否重用了节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>of_node_reused<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 为设备的引脚分配内存空间</span>
    dev<span class="token operator">-&gt;</span>pins <span class="token operator">=</span> <span class="token function">devm_kzalloc</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dev<span class="token operator">-&gt;</span>pins<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
    
    <span class="token comment">// 获取设备的pinctrl 句柄</span>
    dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>p <span class="token operator">=</span> <span class="token function">devm_pinctrl_get</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dev_dbg</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"没有pinctrl 句柄\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup_alloc<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 查找设备的默认pinctrl 状态</span>
    dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>default_state <span class="token operator">=</span> <span class="token function">pinctrl_lookup_state</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>p<span class="token punctuation">,</span> PINCTRL_STATE_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>default_state<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dev_dbg</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"没有默认的pinctrl 状态\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup_get<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 查找设备的初始化pinctrl 状态</span>
    dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>init_state <span class="token operator">=</span> <span class="token function">pinctrl_lookup_state</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>p<span class="token punctuation">,</span> PINCTRL_STATE_INIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>init_state<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* 不提供此状态是完全合法的*/</span>
        <span class="token function">dev_dbg</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"没有初始化的pinctrl 状态\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 选择默认的pinctrl 状态</span>
        ret <span class="token operator">=</span> <span class="token function">pinctrl_select_state</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>p<span class="token punctuation">,</span> dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>default_state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 选择初始化的pinctrl 状态</span>
        ret <span class="token operator">=</span> <span class="token function">pinctrl_select_state</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>p<span class="token punctuation">,</span> dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>init_state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dev_dbg</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"无法激活初始的pinctrl 状态\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> cleanup_get<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_PM</span></span>
    <span class="token comment">/*
    * 如果启用了电源管理，我们还会寻找可选的睡眠和空闲的引脚状态，其语义在
    * &lt;linux/pinctrl/pinctrl-state.h&gt; 中定义
    */</span>
    dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>sleep_state <span class="token operator">=</span> <span class="token function">pinctrl_lookup_state</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>p<span class="token punctuation">,</span> PINCTRL_STATE_SLEEP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>sleep_state<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">/* 不提供此状态是完全合法的*/</span>
        <span class="token function">dev_dbg</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"没有睡眠的pinctrl 状态\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>idle_state <span class="token operator">=</span> <span class="token function">pinctrl_lookup_state</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>p<span class="token punctuation">,</span> PINCTRL_STATE_IDLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>idle_state<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">/* 不提供此状态是完全合法的*/</span>
        <span class="token function">dev_dbg</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"没有空闲的pinctrl 状态\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token comment">/*
    * 如果对于此设备没有找到pinctrl 句柄或默认状态，
    * 让我们明确释放设备中的引脚容器，因为保留它没有意义。
    */</span>
    cleanup_get<span class="token operator">:</span>
        <span class="token function">devm_pinctrl_put</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cleanup_alloc<span class="token operator">:</span>
        <span class="token function">devm_kfree</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> dev<span class="token operator">-&gt;</span>pins<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dev<span class="token operator">-&gt;</span>pins <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token comment">/* 返回延迟*/</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span>EPROBE_DEFER<span class="token punctuation">)</span>
            <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    
        <span class="token comment">/* 返回严重错误*/</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">)</span>
            <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    
        <span class="token comment">/* 我们忽略诸如-ENOENT 的错误，表示没有pinctrl 状态*/</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>前面的小节都只是对<code>pinctrl_bind_pins</code> 函数的第15 行获取设备的pinctrl 句柄所使用的<code>devm_pinctrl_get</code> 函数进行的讲解，接下来将继续对后面重要的内容进行讲解。<br>（1）第22-28 行：查找设备的默认pinctrl 状态。使用<code>pinctrl_lookup_state</code> 函数通过<code>dev-&gt;pins-&gt;p</code> 和<code>PINCTRL_STATE_DEFAULT</code> 参数查找设备的默认pinctrl 状态，并将其赋值给<code>dev-&gt;pins-&gt;default_state</code>。如果查找失败，函数会打印一条调试信息，并将返回值设置为0，表示继续执行。<br>第23 行调用了<code>pinctrl_lookup_state</code> 函数来查找设备的pinctrl 状态，该函数定义在内核源码目录下的“<code>drivers/pinctrl/core.c</code>”文件中，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">pinctrl_state</span> <span class="token operator">*</span><span class="token function">pinctrl_lookup_state</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token operator">*</span>p<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_state</span> <span class="token operator">*</span>state<span class="token punctuation">;</span>
    <span class="token comment">// 在状态链表中查找指定名称的状态对象</span>
    state <span class="token operator">=</span> <span class="token function">find_state</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pinctrl_dummy_state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/* 创建虚拟状态*/</span>
            <span class="token function">dev_dbg</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"使用pinctrl 虚拟状态(%s)\n"</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 如果找不到指定的状态对象，并且存在虚拟状态，则创建一个虚拟状态对象</span>
            state <span class="token operator">=</span> <span class="token function">create_state</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span>
            <span class="token comment">// 如果找不到指定的状态对象，并且不存在虚拟状态，则返回错误指针-ENODEV</span>
            state <span class="token operator">=</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span><span class="token operator">-</span>ENODEV<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> state<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>（2）第30-41 行：查找设备的初始化pinctrl 状态。使用<code>pinctrl_lookup_state</code> 函数通过<code>dev-&gt;pins-&gt;p</code> 和<code>PINCTRL_STATE_INIT</code> 参数查找设备的初始化pinctrl 状态，并将其赋值给<code>dev-&gt;pins-&gt;init_state</code>。如果查找失败，函数会打印一条调试信息。如果找不到初始化状态，会选择默认的pinctrl 状态，并将返回值设置为<code>pinctrl_select_state</code> 函数的返回值。</li>
<li>（3）第48-56 行：如果配置了电源管理（CONFIG_PM 宏定义），则会继续执行以下步骤。<br>首先，查找设备的睡眠pinctrl 状态。使用<code>pinctrl_lookup_state</code> 函数通过<code>dev-&gt;pins-&gt;p</code> 和<code>PINCTRL_STATE_SLEEP</code> 参数查找设备的睡眠pinctrl 状态，并将其赋值给<code>dev-&gt;pins-&gt;sleep_state</code>。如果查找失败，函数会打印一条调试信息。</li>
<li>（4）第58-64 行：查找设备的空闲pinctrl 状态。使用pinctrl_lookup_state 函数通过dev-&gt;pins-&gt;p 和<code>PINCTRL_STATE_IDLE</code> 参数查找设备的空闲pinctrl 状态，并将其赋值给<code>dev-&gt;pins-&gt;idle_state</code>。如果查找失败，函数会打印一条调试信息。函数返回0，表示引脚绑定成功。<ul>
<li>第37 行和第40 行会使用<code>pinctrl_select_state</code> 选择并切换到指定的<code>pinctrl_state</code>（引脚控制状态），该函数定义在内核源码目录下的“<code>drivers/pinctrl/core.c</code>”文件中，具体内容如下所示：</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">pinctrl_select_state</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl_state</span> <span class="token operator">*</span>state<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 如果当前状态已经是要选择的状态，则无需进行任何操作，直接返回0 表示成功</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>state <span class="token operator">==</span> state<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 调用pinctrl_commit_state 函数来应用并切换到新的状态</span>
    <span class="token keyword">return</span> <span class="token function">pinctrl_commit_state</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第8 行的返回值中又调用的pinctrl_commit_state 函数应用并切换到新的状态，该函数的具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">pinctrl_commit_state</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl_state</span> <span class="token operator">*</span>state<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_setting</span> <span class="token operator">*</span>setting<span class="token punctuation">,</span> <span class="token operator">*</span>setting2<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_state</span> <span class="token operator">*</span>old_state <span class="token operator">=</span> p<span class="token operator">-&gt;</span>state<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/*
        * 对于旧状态中的每个引脚复用设置，取消SW 记录的该引脚组的复用所有者。
        * 任何仍由新状态拥有的引脚组将在下面循环中的pinmux_enable_setting() 调用中重新获取。
        */</span>
        <span class="token function">list_for_each_entry</span><span class="token punctuation">(</span>setting<span class="token punctuation">,</span> <span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>state<span class="token operator">-&gt;</span>settings<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>setting<span class="token operator">-&gt;</span>type <span class="token operator">!=</span> PIN_MAP_TYPE_MUX_GROUP<span class="token punctuation">)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token function">pinmux_disable_setting</span><span class="token punctuation">(</span>setting<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    p<span class="token operator">-&gt;</span>state <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* 应用新状态的所有设置*/</span>
    <span class="token function">list_for_each_entry</span><span class="token punctuation">(</span>setting<span class="token punctuation">,</span> <span class="token operator">&amp;</span>state<span class="token operator">-&gt;</span>settings<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>setting<span class="token operator">-&gt;</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> PIN_MAP_TYPE_MUX_GROUP<span class="token operator">:</span>
                ret <span class="token operator">=</span> <span class="token function">pinmux_enable_setting</span><span class="token punctuation">(</span>setting<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token keyword">case</span> PIN_MAP_TYPE_CONFIGS_PIN<span class="token operator">:</span>
            <span class="token keyword">case</span> PIN_MAP_TYPE_CONFIGS_GROUP<span class="token operator">:</span>
                ret <span class="token operator">=</span> <span class="token function">pinconf_apply_setting</span><span class="token punctuation">(</span>setting<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token keyword">default</span><span class="token operator">:</span>
                ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果应用设置失败，则回滚新状态的设置</span>
            <span class="token keyword">goto</span> unapply_new_state<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    p<span class="token operator">-&gt;</span>state <span class="token operator">=</span> state<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
unapply_new_state<span class="token operator">:</span>
    <span class="token comment">// 回滚新状态的设置</span>
    <span class="token function">list_for_each_entry_safe</span><span class="token punctuation">(</span>setting<span class="token punctuation">,</span> setting2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>state<span class="token operator">-&gt;</span>settings<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>setting<span class="token operator">-&gt;</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> PIN_MAP_TYPE_MUX_GROUP<span class="token operator">:</span>
            <span class="token function">pinmux_disable_setting</span><span class="token punctuation">(</span>setting<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token keyword">case</span> PIN_MAP_TYPE_CONFIGS_PIN<span class="token operator">:</span>
            <span class="token keyword">case</span> PIN_MAP_TYPE_CONFIGS_GROUP<span class="token operator">:</span>
            <span class="token function">pinconf_remove_setting</span><span class="token punctuation">(</span>setting<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 回滚完成后，将状态恢复为旧状态</span>
    p<span class="token operator">-&gt;</span>state <span class="token operator">=</span> old_state<span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>（1）第4 行：保存当前的状态对象到变量old_state 中。</li>
<li>（2）第7-18 行：检查是否存在旧的状态，如果存在则取消记录在软件中的旧状态中每个引脚复用设置的复用所有者。这样做是为了确保任何仍由新状态拥有的引脚组在后面的循环中重新获取（通过pinmux_enable_setting()函数调用）。</li>
<li>（3）第20 行：将当前的状态设置为NULL，以便在应用新状态时可以正确处理。</li>
<li>（4）第22-41 行：遍历新状态的所有设置，并根据设置的类型执行相应的操作：<ul>
<li>对于引脚复用设置（PIN_MAP_TYPE_MUX_GROUP），调用pinmux_enable_setting()函数来启用该设置。</li>
<li>对于引脚配置设置（PIN_MAP_TYPE_CONFIGS_PIN 或PIN_MAP_TYPE_CONFIGS_GROUP），调用pinconf_apply_setting()函数来应用该设置。</li>
<li>对于其他类型的设置，将返回一个错误码（-EINVAL）。</li>
<li>如果应用设置失败，则跳转到标签unapply_new_state，执行回滚操作。</li>
</ul>
</li>
</ul>
<p>最后对52 行的<code>pinmux_enable_setting</code> 函数和56 行的<code>pinconf_apply_setting()</code>函数进行讲解，<code>pinmux_enable_setting</code> 函数定义在内核源码目录下的“<code>drivers/pinctrl/pinmux.c</code>”文件中，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">pinmux_enable_setting</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl_setting</span> <span class="token operator">*</span>setting<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 获取相关结构体指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev <span class="token operator">=</span> setting<span class="token operator">-&gt;</span>pctldev<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl_ops</span> <span class="token operator">*</span>pctlops <span class="token operator">=</span> pctldev<span class="token operator">-&gt;</span>desc<span class="token operator">-&gt;</span>pctlops<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pinmux_ops</span> <span class="token operator">*</span>ops <span class="token operator">=</span> pctldev<span class="token operator">-&gt;</span>desc<span class="token operator">-&gt;</span>pmxops<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token operator">*</span>pins <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> num_pins <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">pin_desc</span> <span class="token operator">*</span>desc<span class="token punctuation">;</span>
    
    <span class="token comment">// 如果pctlops-&gt;get_group_pins 函数存在，则调用该函数获取组中的引脚信息</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pctlops<span class="token operator">-&gt;</span>get_group_pins<span class="token punctuation">)</span>
        ret <span class="token operator">=</span> pctlops<span class="token operator">-&gt;</span><span class="token function">get_group_pins</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">,</span> setting<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>mux<span class="token punctuation">.</span>group<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pins<span class="token punctuation">,</span> <span class="token operator">&amp;</span>num_pins<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>gname<span class="token punctuation">;</span>
        <span class="token comment">// 错误只影响调试数据，因此只发出警告</span>
        gname <span class="token operator">=</span> pctlops<span class="token operator">-&gt;</span><span class="token function">get_group_name</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">,</span>setting<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>mux<span class="token punctuation">.</span>group<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">dev_warn</span><span class="token punctuation">(</span>pctldev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"could not get pins for group %s\n"</span><span class="token punctuation">,</span> gname<span class="token punctuation">)</span><span class="token punctuation">;</span>
        num_pins <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 逐个申请组中的引脚</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_pins<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ret <span class="token operator">=</span> <span class="token function">pin_request</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">,</span> pins<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> setting<span class="token operator">-&gt;</span>dev_name<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>gname<span class="token punctuation">;</span>
            <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pname<span class="token punctuation">;</span>
            desc <span class="token operator">=</span> <span class="token function">pin_desc_get</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">,</span> pins<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pname <span class="token operator">=</span> desc <span class="token operator">?</span> desc<span class="token operator">-&gt;</span>name <span class="token operator">:</span> <span class="token string">"non-existing"</span><span class="token punctuation">;</span>
            gname <span class="token operator">=</span> pctlops<span class="token operator">-&gt;</span><span class="token function">get_group_name</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">,</span> setting<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>mux<span class="token punctuation">.</span>group<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">dev_err</span><span class="token punctuation">(</span>pctldev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"could not request pin %d (%s) from group %s on device %s\n"</span><span class="token punctuation">,</span>
                    pins<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> pname<span class="token punctuation">,</span> gname<span class="token punctuation">,</span> <span class="token function">pinctrl_dev_get_name</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> err_pin_request<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 分配引脚后，编码复用设置</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_pins<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        desc <span class="token operator">=</span> <span class="token function">pin_desc_get</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">,</span> pins<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>desc <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">dev_warn</span><span class="token punctuation">(</span>pctldev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"could not get pin desc for pin %d\n"</span><span class="token punctuation">,</span> pins<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        desc<span class="token operator">-&gt;</span>mux_setting <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>setting<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>mux<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 调用ops-&gt;set_mux 函数设置复用</span>
    ret <span class="token operator">=</span> ops<span class="token operator">-&gt;</span><span class="token function">set_mux</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">,</span> setting<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>mux<span class="token punctuation">.</span>func<span class="token punctuation">,</span> setting<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>mux<span class="token punctuation">.</span>group<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> err_set_mux<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
err_set_mux<span class="token operator">:</span>
    <span class="token comment">// 复用设置失败，清除复用设置</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_pins<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        desc <span class="token operator">=</span> <span class="token function">pin_desc_get</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">,</span> pins<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>desc<span class="token punctuation">)</span>
            desc<span class="token operator">-&gt;</span>mux_setting <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
err_pin_request<span class="token operator">:</span>
    <span class="token comment">// 在错误发生时释放已申请的引脚</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">pin_free</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">,</span> pins<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该函数用于启用引脚复用设置。<br>（1）第13-28 行：调用pctlops-&gt;get_group_pins 函数获取指定组中的引脚信息，如果函数存在，则调用该函数，并将引脚信息存储在pins 和num_pins 变量中。如果获取引脚信息失败，发出警告并将num_pins 设置为0。<br>（2）第30-48 行：使用pin_request 函数申请引脚，并传入引脚控制器设备、引脚编号、设备名称和其他参数。如果申请引脚失败，发出错误信息并跳转到错误处理步骤。<br>（3）第50-60 行：分配引脚后，使用pin_desc_get 函数获取引脚描述符，并将复用设置指针指向引脚复用信息。<br>（4）第62-64 行：调用ops-&gt;set_mux 函数设置引脚复用，传入引脚控制器设备、复用功能和组信息，以便设置引脚复用。<br>（5）第66 行：如果引脚复用设置失败，跳转到错误处理步骤。<br>pinconf_apply_setting()函数定义在内核源码目录下的“drivers/pinctrl/pinconf.c”文件中，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">pinconf_apply_setting</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl_setting</span> <span class="token operator">*</span>setting<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 获取相关结构体指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev <span class="token operator">=</span> setting<span class="token operator">-&gt;</span>pctldev<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pinconf_ops</span> <span class="token operator">*</span>ops <span class="token operator">=</span> pctldev<span class="token operator">-&gt;</span>desc<span class="token operator">-&gt;</span>confops<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    
    <span class="token comment">// 检查是否存在pinconf 操作函数集</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ops<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dev_err</span><span class="token punctuation">(</span>pctldev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"missing confops\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 根据设置类型选择相应的操作</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>setting<span class="token operator">-&gt;</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> PIN_MAP_TYPE_CONFIGS_PIN<span class="token operator">:</span>
            <span class="token comment">// 检查是否存在pin_config_set 操作函数</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ops<span class="token operator">-&gt;</span>pin_config_set<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">dev_err</span><span class="token punctuation">(</span>pctldev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"missing pin_config_set op\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 调用pin_config_set 函数设置单个引脚的配置</span>
            ret <span class="token operator">=</span> ops<span class="token operator">-&gt;</span><span class="token function">pin_config_set</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">,</span>
            setting<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>configs<span class="token punctuation">.</span>group_or_pin<span class="token punctuation">,</span>
            setting<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>configs<span class="token punctuation">.</span>configs<span class="token punctuation">,</span>
            setting<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>configs<span class="token punctuation">.</span>num_configs<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">dev_err</span><span class="token punctuation">(</span>pctldev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"pin_config_set op failed for pin %d\n"</span><span class="token punctuation">,</span> 
                        setting<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>configs<span class="token punctuation">.</span>group_or_pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">case</span> PIN_MAP_TYPE_CONFIGS_GROUP<span class="token operator">:</span>
            <span class="token comment">// 检查是否存在pin_config_group_set 操作函数</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ops<span class="token operator">-&gt;</span>pin_config_group_set<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">dev_err</span><span class="token punctuation">(</span>pctldev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"missing pin_config_group_set op\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 调用pin_config_group_set 函数设置引脚组的配置</span>
            ret <span class="token operator">=</span> ops<span class="token operator">-&gt;</span><span class="token function">pin_config_group_set</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">,</span>
            setting<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>configs<span class="token punctuation">.</span>group_or_pin<span class="token punctuation">,</span>
            setting<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>configs<span class="token punctuation">.</span>configs<span class="token punctuation">,</span>
            setting<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>configs<span class="token punctuation">.</span>num_configs<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">dev_err</span><span class="token punctuation">(</span>pctldev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"pin_config_group_set op failed for group %d\n"</span><span class="token punctuation">,</span>  
                        setting<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>configs<span class="token punctuation">.</span>group_or_pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该函数用于应用引脚配置设置。<br>（1）第8-12 行：检查是否存在引脚配置操作函数集，如果不存在，则返回错误码-EINVAL。<br>（2）第14-59：根据设置类型进行相应的处理：</p>
<ul>
<li>如果设置类型为<code>PIN_MAP_TYPE_CONFIGS_PIN</code>，表示对单个引脚进行配置设置。然后检查是否存在<code>pin_config_set</code> 操作函数，如果存在则调用<code>pin_config_set</code> 函数设置单个引脚的配置。如果设置失败，则返回相应的错误码。</li>
<li>如果设置类型为<code>PIN_MAP_TYPE_CONFIGS_GROUP</code>，表示对引脚组进行配置设置，然后检查是否存在<code>pin_config_group_set</code> 操作函数，如果存在则调用<code>pin_config_group_set</code> 函数设置引脚组的配置。如果设置失败，则返回相应的错误码。</li>
<li>如果设置类型不是上述两种类型，则返回错误码<code>-EINVAL</code>。</li>
</ul>
<p>至此，关于<code>pinctrl_bind_pins</code> 函数的重要内容就讲解完成了，通过<code>pinctrl_bind_pins</code> 函数实现了为给定的设备绑定引脚，并在绑定过程中选择和设置适当的pinctrl 状态，在124.1 小节最后提出的<code>struct pinctrl_state *default_state</code> 跟<code>pinctrl_map</code> 结构体是什么时候建立起联系的问题也就解决了。</p>
<p>到这里关于pinctrl 子系统第二阶段的讲解也就完成了，为了帮助大家整合讲解过的知识点，作者绘制了以下思维导图：<br>注：该思维导图的存放路径为<code>iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\05_思维导图\02_pinctrl 阶段2.jpg</code></p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201041315.png" alt="image-20240920104134876"></p>
<p>大家可以根据该思维导图，对上面章节的内容进行梳理，从而真正理解pinctrl 子系统框架。</p>
<h2 id="第127-章猜想验证"><a href="#第127-章猜想验证" class="headerlink" title="第127 章猜想验证"></a>第127 章猜想验证</h2><p>经过了前面章节的学习，我们已经对pinctrl 子系统中有了一定的了解，下面就来解决我们在120.2 小节中提出的问题。</p>
<p>首先对问题进行一下复述，假如我们要配置一个LED 外设，该LED 需要使用一个管脚来进行亮灭的控制，那这个控制引脚需要复用成GPIO 之后才能完成相应的功能，那pinctrl 子系统是什么时候对该引脚进行的复用呢？</p>
<p>首先我们可以提出两种猜想，第一个猜想是在加载LED 驱动的时候进行的pinctrl 引脚复用，第二种猜想是在加载pinctrl 驱动的时候完成的引脚复用。下面对这两种猜想进行验证。</p>
<p><strong>1.猜想1 验证</strong></p>
<p>第一个猜想是在加载LED 驱动的时候进行的pinctrl 引脚复用，这就符合我们124 章、125章、126 章所讲解的内容。当LED 灯的设备树和驱动匹配之后，就会进入驱动中编写的probe函数， 在此之前会执行“ drivers/base/dd.c ” 文件中的really probe 函数中的子函数pinctrl_bind_pins，该函数会为给定的设备绑定引脚，并在绑定过程中选择和设置适当的pinctrl状态。具体的绑定细节可以去前面的章节中查找。</p>
<p><strong>2.猜想2 验证</strong></p>
<p>第二种猜想是在加载pinctrl 驱动的时候完成的引脚复用，因为pinctrl 子系统也是符合设备模型的规范， 也会执行相应的probe 函数， 所以同样的加在pinctrl 驱动时也会执行“drivers/base/dd.c”文件中的really probe 函数中的子函数pinctrl_bind_pins，那这时会进行pinctrl 管脚的复用设置吗，接下来我们对此进行深入的分析。</p>
<p>在pinctrl 的probe 函数执行之前，会调用pinctrl_bind_pins 函数，根据124.2 小节中讲解到的内容可以知道，根据函数的嵌套，首先会调用的create_pinctrl 函数创建struct pinctrl 类型的引脚控制器，create_pinctrl 函数内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token operator">*</span><span class="token function">create_pinctrl</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>devname<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_maps</span> <span class="token operator">*</span>maps_node<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl_map</span> <span class="token operator">*</span>map<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    
    <span class="token comment">/*
    * 为每个映射创建状态cookie 持有者struct pinctrl。
    * 这是当使用pinctrl_get() 请求引脚控制句柄时消费者将获得的对象。
    */</span>
    p <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span><span class="token operator">-</span>ENOMEM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    p<span class="token operator">-&gt;</span>dev <span class="token operator">=</span> dev<span class="token punctuation">;</span>
    <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>states<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>dt_maps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    ret <span class="token operator">=</span> <span class="token function">pinctrl_dt_to_map</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> pctldev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">kfree</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    devname <span class="token operator">=</span> <span class="token function">dev_name</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pinctrl_maps_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* 遍历引脚控制映射以定位正确的映射*/</span>
    <span class="token function">for_each_maps</span><span class="token punctuation">(</span>maps_node<span class="token punctuation">,</span> i<span class="token punctuation">,</span> map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* 映射必须适用于此设备*/</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>map<span class="token operator">-&gt;</span>dev_name<span class="token punctuation">,</span> devname<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token comment">/*
        * 如果pctldev 不为空，我们正在声明它的独占使用权，
        * 这意味着它自己提供了该设置。
        *
        * 因此，我们必须跳过适用于此设备但由其他设备提供的映射。
        */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pctldev <span class="token operator">&amp;&amp;</span> <span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token function">dev_name</span><span class="token punctuation">(</span>pctldev<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">,</span> map<span class="token operator">-&gt;</span>ctrl_dev_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">add_setting</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> pctldev<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*
        * 在这一点上，添加设置可能会导致：
        *
        * - 延迟，如果引脚控制设备尚不可用
        * - 失败，如果引脚控制设备尚不可用，
        * 并且该设置是一个独占设置。我们不能推迟它，因为
        * 该独占设置会在设备注册后立即生效。
        *
        * 如果返回的错误不是-EPROBE_DEFER，则我们将
        * 累积错误，以查看是否最终得到-EPROBE_DEFER，
        * 因为那是最糟糕的情况。
        */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span>EPROBE_DEFER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">pinctrl_free</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pinctrl_maps_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pinctrl_maps_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* 如果发生了除推迟以外的其他错误，则在此处返回*/</span>
        <span class="token function">pinctrl_free</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token function">kref_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>users<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* 将引脚控制句柄添加到全局列表*/</span>
    <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pinctrl_list_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>node<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pinctrl_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pinctrl_list_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> p<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在第22 行会调用<code>pinctrl_dt_to_map</code> 函数将设备树中定义的引脚映射信息转换为<code>struct pinctrl_map</code> 结构，并将其添加到<code>p-&gt;dt_maps</code> 链表中。该函数定义在内核源码目录下的“<code>drivers/pinctrl/devicetree.c</code>”文件中，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">pinctrl_dt_to_map</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np <span class="token operator">=</span> p<span class="token operator">-&gt;</span>dev<span class="token operator">-&gt;</span>of_node<span class="token punctuation">;</span> <span class="token comment">// 获取引脚控制器关联设备的设备树节点</span>
    <span class="token keyword">int</span> state<span class="token punctuation">,</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">property</span> <span class="token operator">*</span>prop<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>statename<span class="token punctuation">;</span>
    <span class="token keyword">const</span> __be32 <span class="token operator">*</span>list<span class="token punctuation">;</span>
    <span class="token keyword">int</span> size<span class="token punctuation">,</span> config<span class="token punctuation">;</span>
    phandle phandle<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np_config<span class="token punctuation">;</span>
    
    <span class="token comment">/* 如果CONFIG_OF 启用，且p-&gt;dev 不是从设备树实例化而来*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>np<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">of_have_populated_dt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">dev_dbg</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"no of_node; not parsing pinctrl DT\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/* 节点内部存储属性名称的指针*/</span>
    <span class="token function">of_node_get</span><span class="token punctuation">(</span>np<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* 对于每个定义的状态ID */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>state <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">;</span> state<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* 获取pinctrl-* 属性*/</span>
        propname <span class="token operator">=</span> <span class="token function">kasprintf</span><span class="token punctuation">(</span>GFP_KERNEL<span class="token punctuation">,</span> <span class="token string">"pinctrl-%d"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
        prop <span class="token operator">=</span> <span class="token function">of_find_property</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> propname<span class="token punctuation">,</span> <span class="token operator">&amp;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">kfree</span><span class="token punctuation">(</span>propname<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">of_node_put</span><span class="token punctuation">(</span>np<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        list <span class="token operator">=</span> prop<span class="token operator">-&gt;</span>value<span class="token punctuation">;</span>
        size <span class="token operator">/=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">/* 判断pinctrl-names 属性是否命名了该状态*/</span>
        ret <span class="token operator">=</span> <span class="token function">of_property_read_string_index</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> <span class="token string">"pinctrl-names"</span><span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token operator">&amp;</span>statename<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*
        * 如果未命名，则statename 仅是整数状态ID。但是，为了避免动态分配和之后要释放的
        麻烦，
        * 可以直接将statename 指向属性名称的一部分。
        */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/* strlen("pinctrl-") == 8 */</span>
            statename <span class="token operator">=</span> prop<span class="token operator">-&gt;</span>name <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">/* 对于其中的每个引用的引脚配置节点*/</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>config <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> config <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> config<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            phandle <span class="token operator">=</span> <span class="token function">be32_to_cpup</span><span class="token punctuation">(</span>list<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">/* 查找引脚配置节点*/</span>
            np_config <span class="token operator">=</span> <span class="token function">of_find_node_by_phandle</span><span class="token punctuation">(</span>phandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>np_config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">dev_err</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"prop %s index %i invalid phandle\n"</span><span class="token punctuation">,</span> prop<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
                ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
                <span class="token keyword">goto</span> err<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
            <span class="token comment">/* 解析节点*/</span>
            ret <span class="token operator">=</span> <span class="token function">dt_to_map_one_config</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> pctldev<span class="token punctuation">,</span> statename<span class="token punctuation">,</span> np_config<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">of_node_put</span><span class="token punctuation">(</span>np_config<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">goto</span> err<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">/* 如果在设备树中没有条目，则生成一个虚拟状态表条目*/</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ret <span class="token operator">=</span> <span class="token function">dt_remember_dummy_state</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> statename<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">goto</span> err<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    err<span class="token operator">:</span>
    <span class="token function">pinctrl_dt_free_maps</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里传递过来的是pinctrl 的设备树节点，在24-76 行的for 循环中会获取pinctrl-* 属性，而在pinctrl 节点中并没有该属性，pinctrl-* 属性是在一系列的设备节点中添加的，所以会在这里返回错误，同样的错误会一层层的向上级函数传递，最终导致pinctrl_bind_pins 函数返回错误，从而不能设置引脚的复用，所以猜想2 是不正确的。</p>
<p>在121 章中也讲解了瑞芯微的pinctrl 的probe 函数，在该函数中有一个这样的调用关系:</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">rockchip pinctrl_probe
    rockchip_pinctrl_registér
        devm_pinctrl_register
            pinctrl_register
                pinctrl_enable
                    pinctrl_claim_hogs
                        create_pinctrl<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>从上面的调用关系可以得到pinctrl 的probe 函数最后也会调用<code>create_pinctrl</code> 来创建<code>struct pinctrl</code> 类型的引脚控制器，从而实现pinctrl 引脚复用设置，同样的这是的设置也是不成功的，<br><code>pinctrl_claim_hogs</code> 函数定义在内核源码目录下的“<code>drivers/pinctrl/core.c</code>”文件中，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">pinctrl_claim_hogs</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    pctldev<span class="token operator">-&gt;</span>p <span class="token operator">=</span> <span class="token function">create_pinctrl</span><span class="token punctuation">(</span>pctldev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> pctldev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PTR_ERR</span><span class="token punctuation">(</span>pctldev<span class="token operator">-&gt;</span>p<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dev_dbg</span><span class="token punctuation">(</span>pctldev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"no hogs found\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>pctldev<span class="token operator">-&gt;</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dev_err</span><span class="token punctuation">(</span>pctldev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"error claiming hogs: %li\n"</span><span class="token punctuation">,</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>pctldev<span class="token operator">-&gt;</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>pctldev<span class="token operator">-&gt;</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    pctldev<span class="token operator">-&gt;</span>hog_default <span class="token operator">=</span> <span class="token function">pinctrl_lookup_state</span><span class="token punctuation">(</span>pctldev<span class="token operator">-&gt;</span>p<span class="token punctuation">,</span> PINCTRL_STATE_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>pctldev<span class="token operator">-&gt;</span>hog_default<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dev_dbg</span><span class="token punctuation">(</span>pctldev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"failed to lookup the default state\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pinctrl_select_state</span><span class="token punctuation">(</span>pctldev<span class="token operator">-&gt;</span>p<span class="token punctuation">,</span>pctldev<span class="token operator">-&gt;</span>hog_default<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">dev_err</span><span class="token punctuation">(</span>pctldev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span><span class="token string">"failed to select default state\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    pctldev<span class="token operator">-&gt;</span>hog_sleep <span class="token operator">=</span> <span class="token function">pinctrl_lookup_state</span><span class="token punctuation">(</span>pctldev<span class="token operator">-&gt;</span>p<span class="token punctuation">,</span> PINCTRL_STATE_SLEEP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>pctldev<span class="token operator">-&gt;</span>hog_sleep<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">dev_dbg</span><span class="token punctuation">(</span>pctldev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"failed to lookup the sleep state\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该函数和<code>pinctrl_bind_pins</code> 函数内容相似，所以也会在第二行的<code>create_pinctrl</code> 函数返回错误，所以也就无法执行后面的pinctrl 状态的选择和设置了，所以猜想2 不成立。</p>
<p>至此，关于pinctrl 的相关知识和疑问就都讲解和解答完成了。</p>
<h1 id="第十二篇GPIO-子系统"><a href="#第十二篇GPIO-子系统" class="headerlink" title="第十二篇GPIO 子系统"></a>第十二篇GPIO 子系统</h1><h3 id="128-1-什么是GPIO"><a href="#128-1-什么是GPIO" class="headerlink" title="128.1 什么是GPIO"></a>128.1 什么是GPIO</h3><p><strong>GPIO</strong> 是干什么的呢？从字面意思来看，<strong>GPIO=General-Purpose Input/Output（通用输入输出）</strong>，是一种软件运行期间能够动态配置和控制的通用引脚。通用，就是说它是万金油，干什么都行。输入输出，<strong>就是说既能当输入口使用，又能当输出口使用</strong>。端口，就是元器件上的一个引脚。</p>
<p><strong>所有的GPIO 在上电后的初始状态都是输入模式，可以通过软件设为上拉或下拉，也可以输入中断信号，驱动强度都是可编程的</strong>。</p>
<p>我们学linux 、单片机的第一个操作硬件就是点亮第一个led 灯，也就是控制GPIO 的高低电平。在单片机上我们控制一个GPIO 非常的简单，直接操作引脚就可以了。虽然linux 听着比较高大上，但是控制一个GPIO 是非常容易的。我们甚至不用去写驱动，直接命令操作就可以了，因为linux 系统本身有好多成熟的驱动框架，使用这些框架的好处就是当我们更换平台的时候，比如换到RK3568 平台，我们应用程序可以几乎不用做任何改变，就可以直接在新的平台上运行。但是比如说我在stm32 单片机上写了一个控制GPIO 的程序，我现在想把它移植到51 单片机的话，这个移植过程是比较麻烦的，但是在linux 上对于GPIO 设备，甚至可以不用写程序，可以直接在命令行操作。</p>
<p>GPIO 的实际应用举例，比如按键输入，当按下按键的时候，GPIO 引脚的状态会发生变化，可以通过读取GPIO 引脚的状态来检测按键事件，并进行相应的处理。原理图如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201102573.png" alt="image-20240920110214432"></p>
<p>控制led 灯，GPIO 可以控制LED 的状态，通过设备GPIO 引脚的输出状态，可以控制LED的亮灭，实现指示灯，状态指示等功能。原理图如下所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201102815.png" alt="image-20240920110233675"></p>
<h3 id="128-2-GPIO-引脚分布"><a href="#128-2-GPIO-引脚分布" class="headerlink" title="128.2 GPIO 引脚分布"></a>128.2 GPIO 引脚分布</h3><p>RK3568 有5 组GPIO：GPIO0 到GPIO4。每组GPIO 又以A0 到A7，B0 到B7，C0 到C7，D0 到D7，作为区分的编号。所以RK3568 上的GPIO 是不是应该有<code>5*4*8=160</code> 个呢？但是为什么在数据手册中有152 个GPIO 呢？如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201103699.png" alt="image-20240920110319532"></p>
<p>实际上RK3568 一共有152 个GPIO ， 其中GPIO0_D2 ， GPIO0_D7 ， GPIO2_C7 ，GPIO4_D3~GPIO4_D7 是没有的，所以是152 个GPIO。</p>
<h3 id="128-3-GPIO-电气属性"><a href="#128-3-GPIO-电气属性" class="headerlink" title="128.3 GPIO 电气属性"></a>128.3 GPIO 电气属性</h3><p>我们以RK3568 为例，以具体CPU 的数据手册为准。RK3568 上的GPIO 可以设置为3.3V，也可以设置为1.8V。在实际编程时，高电平（3.3V 或1.8V）用1 表示，低电平用0 表示。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201105756.png" alt="image-20240920110552601"></p>
<p>那么我们如何确定RK3568 的GPIO 电平是3.3V 还是1.8V 呢？具体操作方法如下所示：</p>
<ul>
<li>1 首先打开RK3568 的底板原理图，在底板原理图上查找使用的引脚，查找到引脚对应到核心板连接器上的网络标号。</li>
<li>2 然后打开RK3568 的核心板原理图，在核心板原理图上查找在上一步骤中找到的引脚网络标号，如下图所示，查找到引脚对应的GPIO 和引脚所连接的电源域。</li>
</ul>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201106657.png" alt="image-20240920110647445"></p>
<ul>
<li>3 然后查找对应的电源域，如下图所示，对应的电压值就是GPIO 引脚的电压。</li>
</ul>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201107739.png" alt="image-20240920110713589"></p>
<h3 id="128-4-GPIO-电气特性"><a href="#128-4-GPIO-电气特性" class="headerlink" title="128.4 GPIO 电气特性"></a>128.4 GPIO 电气特性</h3><p>我们以RK3568 为例，打开RK3568 的数据手册，在GPIO 章节中如下所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201107233.png" alt="image-20240920110730077"></p>
<p>GPIO 是可编程的GPIO，GPIO 除了IO 电平，还有驱动强度，上拉和下拉，这些概念解释如下：</p>
<ul>
<li><strong>驱动强度（Drive Strength）</strong>：GPIO 的驱动强度决定了它可以提供的输出电流。通过软件配置，您可以选择合适的驱动强度，以确保GPIO 能够驱动所连接的外部设备或电路。</li>
<li><strong>上拉（Pull-up）和下拉（Pull-down</strong>）：GPIO 引脚可以通过上拉或下拉电阻来确定其默认电平状态。通过软件配置，您可以选择启用上拉或下拉电阻，以确保GPIO 在未连接外部设备时保持稳定的默认状态。</li>
<li><strong>中断（Interrupt）</strong>：通过软件配置，您可以启用GPIO 中断功能，以便在GPIO 状态发生变化时及时获得通知。这对于实现事件驱动的应用程序非常有用，可以通过中断来处理GPIO触发的事件。</li>
<li><strong>多功能引脚（Multipurpose Pins）</strong>：一些GPIO 引脚可能具有多种功能，可以通过软件配置来选择不同的功能。例如，一个GPIO 引脚可以配置为数字输入、数字输出、PWM 输出等。</li>
</ul>
<p>在设备树pinctl 节点，可以对上述功能进行配置，如下所示：</p>
<img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201109641.png" alt="image-20240920110958486" style="zoom:80%;">

<p>节点中描述了引脚的配置，比如说<code>&lt;1 RK_PD5 1 &amp;pcfg_pull_up_drv_level_2&gt;</code>描述的是<code>GPIO1_D5</code> 引脚，复用模式为模式1（复用模式可以查看RK3568 的参考手册），GPIO 引脚的上拉驱动强度为2。</p>
<h2 id="第129-章GPIO-控制和操作实验"><a href="#第129-章GPIO-控制和操作实验" class="headerlink" title="第129 章GPIO 控制和操作实验"></a>第129 章GPIO 控制和操作实验</h2><p>GPIO 软件编程方式有多种，可以写驱动程序调用GPIO 函数操作GPIO，也可以直接通过操作寄存器的方式操作GPIO，还可以通过sysfs 方式实现对GPIO 的控制。本章节我们来学习使用sysfs 方式实现对GPIO 的控制。</p>
<h3 id="129-1-使用命令通过sysfs-文件系统控制GPIO"><a href="#129-1-使用命令通过sysfs-文件系统控制GPIO" class="headerlink" title="129.1 使用命令通过sysfs 文件系统控制GPIO"></a>129.1 使用命令通过sysfs 文件系统控制GPIO</h3><h4 id="129-1-1-内核配置"><a href="#129-1-1-内核配置" class="headerlink" title="129.1.1 内核配置"></a>129.1.1 内核配置</h4><p>使用sysfs 方式控制gpio，首先需要底层驱动的支持，需要在<code>make menuconfig</code> 图形化配置界面中加入以下配置：<br>    Device Drivers<br>        -&gt;GPIO Support<br>            -&gt;/sys/class/gpio/xxxx</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201112945.png" alt="image-20240920111251794"></p>
<h4 id="129-1-2-GPIO-编号计算"><a href="#129-1-2-GPIO-编号计算" class="headerlink" title="129.1.2 GPIO 编号计算"></a>129.1.2 GPIO 编号计算</h4><p>iTOP-RK3568 有5 组GPIO bank：GPIO0<del>GPIO4，每组又以A0</del>A7, B0<del>B7, C0</del>C7, D0~D7 作为编号区分,常用以下公式计算引脚：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">GPIO pin 脚计算公式：pin <span class="token operator">=</span> bank <span class="token operator">*</span> <span class="token number">32</span> <span class="token operator">+</span> number 	<span class="token comment">//bank 为组号，number 为小组编号</span>
GPIO 小组编号计算公式：number <span class="token operator">=</span> group <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">+</span> X<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>引脚编号= 控制寄存器的寄存器基数+ 控制引脚寄存器位数。在rk3568 中，<br>GPIO_number 的计算方法为： <code>n*32 + (K-A)*8 + x</code>; 括号里面的A、B、C、D 分别代表数值0、1、2、3， 在计算时候分别对应即可。<br>下面演示LED9 用户LED 灯的GPIO0_PB7 pin 脚计算方法：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">bank <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//GPIO0_B7=&gt; 0, bank ∈ [0,4]</span>
group <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//GPIO0_B7 =&gt; 1, group ∈ {(A=0), (B=1), (C=2), (D=3)}</span>
X <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span> <span class="token comment">//GPIO4_D7 =&gt; 5, X ∈ [0,7]</span>
number <span class="token operator">=</span> group <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">+</span> X <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">7</span> <span class="token operator">=</span><span class="token number">15</span>
pin <span class="token operator">=</span> bank<span class="token operator">*</span><span class="token number">32</span> <span class="token operator">+</span> number<span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">*</span> <span class="token number">32</span> <span class="token operator">+</span> <span class="token number">15</span> <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="129-1-3-使用sysfs-控制接口控制GPIO"><a href="#129-1-3-使用sysfs-控制接口控制GPIO" class="headerlink" title="129.1.3 使用sysfs 控制接口控制GPIO"></a>129.1.3 使用sysfs 控制接口控制GPIO</h4><p>sysfs 控制接口为<code>/sys/class/gpio/export 和/sys/class/gpio/unexport</code>。如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201117429.png" alt="image-20240920111729287"></p>
<p>/sys/class/gpio/export 用于将GPIO 控制从内核空间导出到用户空间。<code>/sys/class/gpio/unexport</code> 用于取消GPIO 控制从内核空间到用户空间的导出。export 和unexport，他们都是只写的。GpiochipX 代表GPIO 控制器。</p>
<p><strong><code>export</code><strong>：用于将指定编号的GPIO 引脚导出。</strong>在使用GPIO 引脚之前，需要将其导出，导出成功之后才能使用它</strong>。注意export 文件是只写文件，不能读取，将一个指定的编号写入到export 文件中即可将对应的GPIO 引脚导出，以<code>GPIO0_PB7</code> 为例（pin 计算值为15）使用export 文件进行导出(如果没有更换本章开始部分的内核设备树镜像，会导出不成功)，导出成功如下图所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token number">15</span> <span class="token operator">&gt;</span> <span class="token builtin class-name">export</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201119389.png" alt="image-20240920111913241"></p>
<p>会发现在<code>/sys/class/gpio</code> 目录下生成了一个名为gpio15 的文件夹（gpioX，X 表示对应的编号），该文件夹就是导出来的GPIO 引脚对应的文件夹，用于管理、控制该GPIO 引脚。</p>
<p>**<code>unexport</code>**：将导出的GPIO 引脚删除。当使用完GPIO 引脚之后，需要将导出的引脚删除，同样该文件也是只写文件、不可读，使用unexport 文件进行删除GPIO0_PB7，删除成功如下图所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token number">15</span> <span class="token operator">&gt;</span> unexport<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201120879.png" alt="image-20240920112029733"></p>
<p>可以看到之前生成的gpio15 文件夹就会消失！<br>需要注意的是，并不是所有GPIO 引脚都可以成功导出，如果对应的GPIO 已经被导出或者在内核中被使用了，那便无法成功导出，导出失败如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201121413.png" alt="image-20240920112148270"></p>
<p>出现上图报错的原因是该GPIO 已经被其他GPIO 使用，需要在内核中找到使用GPIO 的驱动，并取消该驱动才可以正常使用GPIO。在使用GPIO15 时，需要取消Linux 内核源码中LED 灯的配置，如下所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201122683.png" alt="image-20240920112201536"></p>
<p>再次使用以下命令导出GPIO0_PB7 引脚，导出成功之后进入gpio15 文件夹如下图所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token number">15</span> <span class="token operator">&gt;</span> <span class="token builtin class-name">export</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201122931.png" alt="image-20240920112240786"></p>
<p>可以看到gpio15 文件夹下分别有active_low、device、direction、edge、power、subsystem、uevent、value 八个文件，需要关心的文件是<code>active_low</code>、<code>direction</code>、<code>edge</code> 以及<code>value</code> 这四个属性文件，接下来分别介绍这四个属性文件的作用：</p>
<p>**<code>direction</code>**：配置GPIO 引脚为输入或输出模式。该文件可读、可写，读表示查看GPIO 当前是输入还是输出模式，写表示将GPIO 配置为输入或输出模式；读取或写入操作可取的值为”out”（输出模式）和”in”（输入模式）。</p>
<p>在“/sys/class/gpio/gpio15”目录下使用cat 命令查看direction 输入输出模式，如下图所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> direction<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201123867.png" alt="image-20240920112359717"></p>
<p>默认状态下的输入输出状态为“in”,由于direction 为可读可写，可以使用以下命令将模式配置为输出，配置完成如下图所示</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> out <span class="token operator">&gt;</span> direction
<span class="token function">cat</span> direction<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201124789.png" alt="image-20240920112427642"></p>
<p>**<code>active_low</code>**：用于控制极性得属性文件，可读可写，默认情况下为0，使用cat 命令进行文件内容的查看，如下图所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> active_low<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201130866.png" alt="image-20240920113026722"></p>
<p>当active_low 等于0 时， value 值若为1 则引脚输出高电平，value 值若为0 则引脚输出低电平。当active_low 等于1 时，value 值若为0 则引脚输出高电平，value 值若为1 则引脚输出低电平。</p>
<p>**<code>edge</code>**：控制中断的触发模式，该文件可读可写。在配置GPIO 引脚的中断触发模式之前，需将其设置为输入模式，四种触发模式的设置如下所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">非中断引脚：echo <span class="token string">"none"</span> <span class="token operator">&gt;</span> edge
上升沿触发：echo <span class="token string">"rising"</span> <span class="token operator">&gt;</span> edge
下降沿触发：echo <span class="token string">"falling"</span> <span class="token operator">&gt;</span> edge
边沿触发： <span class="token builtin class-name">echo</span> <span class="token string">"both"</span> <span class="token operator">&gt;</span> edge<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong><code>value</code></strong>: 设置高低电平，如果我们要把这个管脚设置成高电平，我们只需要给value 设置成1即可，反之，则设置成0。使用命令</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token number">1</span> <span class="token operator">&gt;</span> value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>反之，把GPIO 设置成低电平，使用命令</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token number">0</span> <span class="token operator">&gt;</span> value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201133332.png" alt="image-20240920113329177"></p>
<h3 id="129-2-使用C-程序通过sysfs-文件系统控制GPIO"><a href="#129-2-使用C-程序通过sysfs-文件系统控制GPIO" class="headerlink" title="129.2 使用C 程序通过sysfs 文件系统控制GPIO"></a>129.2 使用C 程序通过sysfs 文件系统控制GPIO</h3><h4 id="129-2-1-控制GPIO-输出实验"><a href="#129-2-1-控制GPIO-输出实验" class="headerlink" title="129.2.1 控制GPIO 输出实验"></a>129.2.1 控制GPIO 输出实验</h4><p>本小节代码在配套资料“<code>iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568 开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\82_gpioctrl01</code>”目录下。<br>实验要求：<br>通过GPIO 输出应用程序控制GPIO 口输出高低电平，以此来控制LED 灯的亮灭。</p>
<p>实验步骤：<br>首先进入ubuntu 的终端界面输入以下命令来创建gpioctrl.c 文件，如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201134641.png" alt="image-20240920113413495"></p>
<p>然后向该文件中添加以下内容：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token keyword">int</span> fd<span class="token punctuation">;</span>                   <span class="token comment">// 文件描述符</span>
<span class="token keyword">int</span> ret<span class="token punctuation">;</span>                  <span class="token comment">// 返回值</span>
<span class="token keyword">char</span> gpio_path<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token comment">// GPIO路径</span>
<span class="token keyword">int</span> len<span class="token punctuation">;</span>                  <span class="token comment">// 字符串长度</span>

<span class="token comment">// 导出GPIO引脚</span>
<span class="token keyword">int</span> <span class="token function">gpio_export</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/sys/class/gpio/export"</span><span class="token punctuation">,</span> O_WRONLY<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打开export文件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"open /sys/class/gpio/export error \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打开文件失败</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取参数字符串的长度</span>
    ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将参数字符串写入文件，导出GPIO引脚</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"write /sys/class/gpio/export error \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 写入文件失败</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭文件</span>
<span class="token punctuation">}</span>

<span class="token comment">// 取消导出GPIO引脚</span>
<span class="token keyword">int</span> <span class="token function">gpio_unexport</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/sys/class/gpio/unexport"</span><span class="token punctuation">,</span> O_WRONLY<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打开unexport文件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"open /sys/class/gpio/unexport error \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打开文件失败</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取参数字符串的长度</span>
    ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将参数字符串写入文件，取消导出GPIO引脚</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"write /sys/class/gpio/unexport error \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 写入文件失败</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭文件</span>
<span class="token punctuation">}</span>

<span class="token comment">// 控制GPIO引脚的属性</span>
<span class="token keyword">int</span> <span class="token function">gpio_ctrl</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>val<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> file_path<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 文件路径</span>
    <span class="token function">sprintf</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">"%s/%s"</span><span class="token punctuation">,</span> gpio_path<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 构建文件路径，格式为“gpio_path/arg”</span>
    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> O_WRONLY<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打开文件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"open file_path error \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打开文件失败</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取参数字符串的长度</span>
    ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> val<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将参数字符串写入文件，控制GPIO引脚的属性</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"write file_path error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 写入文件失败</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭文件</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 主函数</span>
<span class="token punctuation">{</span>
    <span class="token function">sprintf</span><span class="token punctuation">(</span>gpio_path<span class="token punctuation">,</span> <span class="token string">"/sys/class/gpio/gpio%s"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 构建GPIO路径，格式为“/sys/class/gpio/gpio引脚号”</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">access</span><span class="token punctuation">(</span>gpio_path<span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 检查GPIO路径是否存在</span>
    <span class="token punctuation">{</span>
        <span class="token function">gpio_export</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 不存在则导出GPIO引脚</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token function">gpio_unexport</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 存在则取消导出GPIO引脚</span>
    <span class="token punctuation">}</span>

    <span class="token function">gpio_ctrl</span><span class="token punctuation">(</span><span class="token string">"direction"</span><span class="token punctuation">,</span> <span class="token string">"out"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 配置GPIO为输出模式</span>
    <span class="token function">gpio_ctrl</span><span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 控制GPIO输出高低电平</span>

    <span class="token function">gpio_unexport</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 最后取消导出GPIO引脚</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 返回0表示程序正常退出</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>保存退出之后，使用以下命令设置交叉编译器环境，并对gpioctrl.c 进行交叉编译，编译完成如下图所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span>/usr/local/arm64/gcc-linaro-6.3.1-2017.05-x86_64_aarch64-linux-gnu/bin:<span class="token environment constant">$PATH</span> 
aarch64-linux-gnu-gcc gpioctrl.c <span class="token parameter variable">-o</span> gpioctrl<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201138707.png" alt="image-20240920113821557"></p>
<p>最后将交叉编译生成的gpioctrl 文件拷贝到开发板目录下运行即可，如下所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201138269.png" alt="image-20240920113833124"></p>
<p>输入“./gpioctrl 15 1”命令LED 灯点亮，输入“./gpioctrl 15 0”命令LED 灯熄灭。到此，实验结束。</p>
<h4 id="129-2-2-控制GPIO-输入实验"><a href="#129-2-2-控制GPIO-输入实验" class="headerlink" title="129.2.2 控制GPIO 输入实验"></a>129.2.2 控制GPIO 输入实验</h4><p>本小节代码在配套资料“<code>iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568 开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\83_gpioctrl02</code>”目录下。</p>
<p>实验要求：<br>通过GPIO 输入应用程序读取GPIO 口的输入电平。<br>实验硬件连接：<br>使用迅为iTOP-RK3568 开发板，使用导线连接开发板背面的引脚GPIO1_B2,另一端连接到电源或者GND。<br>实验步骤：<br>首先进入ubuntu 的终端界面输入以下命令来创建gpioctrl.c 文件，如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201139583.png" alt="image-20240920113916432"></p>
<p>然后向该文件中添加以下内容：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token keyword">int</span> fd<span class="token punctuation">;</span>              <span class="token comment">// 文件描述符</span>
<span class="token keyword">int</span> ret<span class="token punctuation">;</span>             <span class="token comment">// 返回值</span>
<span class="token keyword">char</span> gpio_path<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// GPIO路径</span>
<span class="token keyword">int</span> len<span class="token punctuation">;</span>             <span class="token comment">// 字符串长度</span>
<span class="token keyword">char</span> file_path<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 文件路径</span>
<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>         <span class="token comment">// 用于读取 GPIO 值的缓冲区</span>

<span class="token comment">// 导出 GPIO 引脚</span>
<span class="token keyword">int</span> <span class="token function">gpio_export</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/sys/class/gpio/export"</span><span class="token punctuation">,</span> O_WRONLY<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打开 export 文件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"open /sys/class/gpio/export error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打开文件失败</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// 获取参数字符串的长度</span>
    ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将参数字符串写入文件，导出 GPIO 引脚</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"write /sys/class/gpio/export error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 写入文件失败</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭文件</span>
<span class="token punctuation">}</span>

<span class="token comment">// 取消导出 GPIO 引脚</span>
<span class="token keyword">int</span> <span class="token function">gpio_unexport</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/sys/class/gpio/unexport"</span><span class="token punctuation">,</span> O_WRONLY<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打开 unexport 文件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"open /sys/class/gpio/unexport error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打开文件失败</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// 获取参数字符串的长度</span>
    ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将参数字符串写入文件，取消导出 GPIO 引脚</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"write /sys/class/gpio/unexport error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 写入文件失败</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭文件</span>
<span class="token punctuation">}</span>

<span class="token comment">// 控制 GPIO 引脚的属性</span>
<span class="token keyword">int</span> <span class="token function">gpio_ctrl</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>val<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">sprintf</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">"%s/%s"</span><span class="token punctuation">,</span> gpio_path<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 构建文件路径，格式为 "gpio_path/arg"</span>
    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> O_WRONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">// 打开文件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"open file_path error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打开文件失败</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// 获取参数字符串的长度</span>
    ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> val<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将参数字符串写入文件，控制 GPIO 引脚的属性</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"write file_path error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 写入文件失败</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭文件</span>
<span class="token punctuation">}</span>

<span class="token comment">// 读取 GPIO 引脚的值</span>
<span class="token keyword">int</span> <span class="token function">gpio_read_value</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">sprintf</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">"%s/%s"</span><span class="token punctuation">,</span> gpio_path<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 构建文件路径，格式为 "gpio_path/arg"</span>
    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">// 打开文件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"open file_path error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打开文件失败</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ret <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 读取文件内容到缓冲区</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"The value is high\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// GPIO 引脚值为高电平</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"The value is low\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// GPIO 引脚值为低电平</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭文件</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 主函数</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> value<span class="token punctuation">;</span>
    <span class="token function">sprintf</span><span class="token punctuation">(</span>gpio_path<span class="token punctuation">,</span> <span class="token string">"/sys/class/gpio/gpio%s"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 构建 GPIO 路径，格式为 "/sys/class/gpio/gpio引脚号"</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">access</span><span class="token punctuation">(</span>gpio_path<span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">)</span>                           <span class="token comment">// 检查 GPIO 路径是否存在</span>
    <span class="token punctuation">{</span>
        <span class="token function">gpio_export</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 不存在则导出 GPIO 引脚</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token function">gpio_unexport</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 存在则取消导出 GPIO 引脚</span>
    <span class="token punctuation">}</span>

    <span class="token function">gpio_ctrl</span><span class="token punctuation">(</span><span class="token string">"direction"</span><span class="token punctuation">,</span> <span class="token string">"in"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 配置 GPIO 为输入模式</span>
    
    value <span class="token operator">=</span> <span class="token function">gpio_read_value</span><span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 读取 GPIO 引脚的值</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"The value is %d\n"</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打印读取的 GPIO 引脚的值</span>
    <span class="token function">gpio_unexport</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// 最后取消导出 GPIO 引脚</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 返回 0 表示程序正常退出</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>保存退出之后，使用以下命令设置交叉编译器环境，并对gpioctrl.c 进行交叉编译，编译完成如下图所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span>/usr/local/arm64/gcc-linaro-6.3.1-2017.05-x86_64_aarch64-linux-gnu/bin:<span class="token environment constant">$PATH</span>
aarch64-linux-gnu-gcc gpioctrl.c <span class="token parameter variable">-o</span> gpioctrl<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201140726.png" alt="image-20240920114050576"></p>
<p>最后将交叉编译生成的gpioctrl 文件拷贝到开发板目录下运行即可。<br>为了测试输入高电平的状况，作者使用了杜邦线将开发板背面的3.3V 接到了<code>GPIO1_PB2 pin</code> 脚上，然后再次使用以下命令来进行状态的检测，如下图所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">chmod</span> <span class="token number">777</span> gpioctrl
./gpioctrl <span class="token number">42</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201141074.png" alt="image-20240920114139926"></p>
<p>可以看到GPIO1_PB2 pin 脚打印的value 值为高，所以gpio 的状态打印正确。同理，我们将<code>GPIO1_PB2 pin</code> 脚接到<code>GND</code>，再次运行程序，如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201142801.png" alt="image-20240920114203652"></p>
<p>可以看到GPIO1_PB2 pin 脚打印的value 值为0，所以gpio 的状态打印正确。至此GPIO 输入应用程序在开发板的测试就完成了。</p>
<h3 id="129-3-使用C-程序通过sysfs-文件系统使用GPIO-中断"><a href="#129-3-使用C-程序通过sysfs-文件系统使用GPIO-中断" class="headerlink" title="129.3 使用C 程序通过sysfs 文件系统使用GPIO 中断"></a>129.3 使用C 程序通过sysfs 文件系统使用GPIO 中断</h3><p>本小节代码在配套资料“<code>iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568 开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\84_gpioctrl03</code>”目录下。<br>实验要求：<br>通过GPIO 的输入中断程序，将中断触发方式设置为边沿触发，每当触发中断会打印value的值。</p>
<h4 id="129-3-1-编写应用程序"><a href="#129-3-1-编写应用程序" class="headerlink" title="129.3.1 编写应用程序"></a>129.3.1 编写应用程序</h4><p>实验步骤：<br>首先进入到ubuntu 的终端界面输入以下命令来创建gpioctrl.c 文件，如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201143427.png" alt="image-20240920114345272"></p>
<p>然后向该文件中添加以下内容：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;poll.h&gt;</span></span>

<span class="token keyword">int</span> fd<span class="token punctuation">;</span>              <span class="token comment">// 文件描述符</span>
<span class="token keyword">int</span> ret<span class="token punctuation">;</span>             <span class="token comment">// 返回值</span>
<span class="token keyword">char</span> gpio_path<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// GPIO路径</span>
<span class="token keyword">int</span> len<span class="token punctuation">;</span>             <span class="token comment">// 字符串长度</span>
<span class="token keyword">char</span> file_path<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 文件路径</span>
<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>         <span class="token comment">// 缓冲区</span>

<span class="token keyword">struct</span> <span class="token class-name">pollfd</span> fds<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// poll结构体数组</span>

<span class="token comment">// 导出GPIO引脚</span>
<span class="token keyword">int</span> <span class="token function">gpio_export</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/sys/class/gpio/export"</span><span class="token punctuation">,</span> O_WRONLY<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打开export文件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"open /sys/class/gpio/export error \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打开文件失败</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// 获取字符串长度</span>
    ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 写入引脚号到export文件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"write /sys/class/gpio/export error \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 写入失败</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭文件</span>
<span class="token punctuation">}</span>

<span class="token comment">// 取消导出GPIO引脚</span>
<span class="token keyword">int</span> <span class="token function">gpio_unexport</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/sys/class/gpio/unexport"</span><span class="token punctuation">,</span> O_WRONLY<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打开unexport文件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"open /sys/class/gpio/unexport error \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打开文件失败</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 获取字符串长度</span>
    ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 写入引脚号到unexport文件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"write /sys/class/gpio/unexport error \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 写入失败</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭文件</span>
<span class="token punctuation">}</span>

<span class="token comment">// 控制GPIO引脚的属性</span>
<span class="token keyword">int</span> <span class="token function">gpio_ctrl</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>val<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">sprintf</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">"%s/%s"</span><span class="token punctuation">,</span> gpio_path<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 构建属性文件的路径</span>
    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> O_WRONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">// 打开属性文件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"open file_path error \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打开文件失败</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// 获取字符串长度</span>
    ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> val<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 写入属性值到属性文件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"write file_path error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 写入失败</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭文件</span>
<span class="token punctuation">}</span>

<span class="token comment">// 监听GPIO引脚的中断事件</span>
<span class="token keyword">int</span> <span class="token function">gpio_interrupt</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">sprintf</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">"%s/%s"</span><span class="token punctuation">,</span> gpio_path<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 构建文件路径</span>
    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">// 打开文件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"open file_path error \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打开文件失败</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>fds<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>fds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 清空poll结构体数组</span>
    fds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> fd<span class="token punctuation">;</span>                      <span class="token comment">// 设置poll结构体的文件描述符</span>
    fds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">=</span> POLLPRI<span class="token punctuation">;</span>             <span class="token comment">// 设置poll结构体的事件类型为POLLPRI，表示有紧急数据可读</span>

    <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 读取文件内容，清除中断事件</span>

    ret <span class="token operator">=</span> <span class="token function">poll</span><span class="token punctuation">(</span>fds<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用poll函数等待中断事件发生，阻塞直到事件发生</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"poll error \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用poll失败或超时</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLPRI<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">lseek</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_SET</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 重新定位文件指针到文件开头</span>
        <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 读取文件内容，获取中断事件的值</span>
        buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"value is %s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出中断事件的值</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 读取GPIO引脚的值</span>
<span class="token keyword">int</span> <span class="token function">gpio_read_value</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">sprintf</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">"%s/%s"</span><span class="token punctuation">,</span> gpio_path<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 构建文件路径</span>
   fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> O_WRONLY<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打开文件，以只写模式打开是一个错误，应该使用只读模式</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"open file_path error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打开文件失败</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ret <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 读取文件内容，获取引脚的值</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"The value is high\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 引脚值为高电平</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"The value is low\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 引脚值为低电平</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 这里应该返回读取到的引脚值（0或1），而不是返回固定的-1</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭文件（这行代码无法执行到，应该放在read之前）</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 主函数</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> value<span class="token punctuation">;</span>
    <span class="token function">sprintf</span><span class="token punctuation">(</span>gpio_path<span class="token punctuation">,</span> <span class="token string">"/sys/class/gpio/gpio%s"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 构建GPIO路径</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">access</span><span class="token punctuation">(</span>gpio_path<span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">)</span>                            <span class="token comment">// 检查GPIO路径是否存在</span>
    <span class="token punctuation">{</span>
        <span class="token function">gpio_export</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 不存在则导出GPIO引脚</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token function">gpio_unexport</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 存在则取消导出GPIO引脚</span>
    <span class="token punctuation">}</span>

    <span class="token function">gpio_ctrl</span><span class="token punctuation">(</span><span class="token string">"direction"</span><span class="token punctuation">,</span> <span class="token string">"in"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置GPIO引脚为输入模式</span>
    <span class="token function">gpio_ctrl</span><span class="token punctuation">(</span><span class="token string">"edge"</span><span class="token punctuation">,</span> <span class="token string">"both"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 设置GPIO引脚的中断触发方式为上升沿和下降沿</span>
    <span class="token function">gpio_interrupt</span><span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 监听GPIO引脚的中断事件</span>

    <span class="token function">gpio_unexport</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 最后取消导出GPIO引脚</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 返回0表示程序正常退出</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>保存退出之后，使用以下命令设置交叉编译器环境，并对gpioctrl.c 进行交叉编译，编译完成如下图所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span>/usr/local/arm64/gcc-linaro-6.3.1-2017.05-x86_64_aarch64-linux-gnu/bin:<span class="token environment constant">$PATH</span>
aarch64-linux-gnu-gcc <span class="token parameter variable">-o</span> demo64_interrupt demo64_interrupt.c<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201145411.png" alt="image-20240920114542255"></p>
<p>最后将交叉编译生成的gpioctrl 文件拷贝到开发板目录下即可。</p>
<h4 id="129-3-2-开发板测试"><a href="#129-3-2-开发板测试" class="headerlink" title="129.3.2 开发板测试"></a>129.3.2 开发板测试</h4><p>我们使用导线一端连接开发板背面的GPIO1_B2,然后输入以下命令运行程序。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./gpioctrl <span class="token number">42</span><span class="token operator">&amp;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>由于中断并没有被触发，所以程序会阻塞，等待中断的进行，然后使用杜邦线的另一端将GPIO 底座的3.3V 接到GPIO1_PB2 pin 脚，进行中断的测试，如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201147991.png" alt="image-20240920114729836"></p>
<p>可以看到中断就被触发了，相应的字符串也被打印了。<br>至此GPIO 输入中断应用程序在开发板的测试就完成了。</p>
<h3 id="129-4-使用IO-命令操作寄存器控制GPIO"><a href="#129-4-使用IO-命令操作寄存器控制GPIO" class="headerlink" title="129.4 使用IO 命令操作寄存器控制GPIO"></a>129.4 使用IO 命令操作寄存器控制GPIO</h3><h4 id="129-4-1-IO-命令"><a href="#129-4-1-IO-命令" class="headerlink" title="129.4.1 IO 命令"></a>129.4.1 IO 命令</h4><p>“io” 命令是一个用于Linux 系统的命令行工具，用于读取和写入指定I/O 端口的值。它主要用于与硬件设备进行低级别的交互和调试，在内核阶段读写寄存器。</p>
<p>该命令的语法如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">io <span class="token punctuation">[</span>选项<span class="token punctuation">]</span> <span class="token punctuation">[</span>地址<span class="token punctuation">]</span> <span class="token punctuation">[</span>操作<span class="token punctuation">]</span> <span class="token punctuation">[</span>数据<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>其中，选项可以是以下之一：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">-b：以字节为单位进行I/O 操作（默认为字）。
-w：以字为单位进行I/O 操作。
-l：以双字为单位进行I/O 操作。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>地址是要读取或写入的I/O 端口的十六进制值。<br>操作可以是以下之一：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">r：读取I/O 端口的值。
w：写入数据到I/O 端口。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>数据是要写入I/O 端口的十六进制值。</p>
<p>以下是一些使用<code>io</code> 命令的示例：</p>
<ol>
<li>读取I/O 端口的值：</li>
</ol>
  <pre class="line-numbers language-none"><code class="language-none">io -b -r 0x80<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>  这将以字节为单位读取I/O 端口0x80 的值，并将其显示在终端上。<br>2. 向I/O 端口写入数据：</p>
  <pre class="line-numbers language-none"><code class="language-none">io -b -w 0x80 0xAB<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>  这将向I/O 端口0x80 写入十六进制值0xAB。<br>3. 以字为单位进行读取：</p>
  <pre class="line-numbers language-none"><code class="language-none">io -w -r 0x1000<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>  这将以字为单位读取I/O 端口0x1000 的值<br>4. 以双字为单位进行写入：</p>
  <pre class="line-numbers language-none"><code class="language-none">io -l -w 0x2000 0xDEADBEEF<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>  这将以双字为单位向I/O 端口0x2000 写入十六进制值0xDEADBEEF。</p>
<h4 id="129-4-2-LED-引脚寄存器查找"><a href="#129-4-2-LED-引脚寄存器查找" class="headerlink" title="129.4.2 LED 引脚寄存器查找"></a>129.4.2 LED 引脚寄存器查找</h4><p>我们查询到了控制LED 灯的GPIO 为<code>GPIO0_B7</code>。在接下来的实验中需要对GPIO 进行配置，一般情况下需要对GPIO 的复用寄存器，方向寄存器，数据寄存器进行配置。接下来我们打开RK3568 的参考手册part1 查找这几个寄存器的地址。</p>
<h5 id="129-4-2-1-查找复用寄存器"><a href="#129-4-2-1-查找复用寄存器" class="headerlink" title="129.4.2.1 查找复用寄存器"></a>129.4.2.1 查找复用寄存器</h5><p>打开参考手册part1 的第三章，GPIOB 的复用寄存器的偏移地址如下（图129-22）所示：</p>
<p><img src="./images/loading.gif" data-original="C:\Users\geyan\AppData\Roaming\Typora\typora-user-images\image-20240920115302055.png" alt="image-20240920115302055"></p>
<p>搜索gpio0b7，如下图（图129-23）所示，<code>gpio0b7_sel</code> 在<code>PMU_GRF_GPIO0B_IOMUX_H</code>上，所以偏移地址为<code>0x000C</code>。gpio0b7 可以通过控制<code>[14:12]</code>位来选择复用为哪个功能，我们要控制led 灯，所以功能要复用为gpio。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201154601.png" alt="image-20240920115405416"></p>
<p>复用寄存器的基地址如下图(图129-24)所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201154441.png" alt="image-20240920115430262"></p>
<p>所以**<code>复用寄存器地址=基地址+偏移地址=0xFDC2000C</code>** 。使用io 命令查看此寄存器的地址：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">io <span class="token parameter variable">-r</span> <span class="token parameter variable">-4</span> 0xFDC2000C<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201155957.png" alt="image-20240920115502791"></p>
<p>如上图(图129-25)所示，寄存器值为00000001，[14:12]位为000，如下图（图129-26）所示，所以默认设置的为gpio 功能。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201155520.png" alt="image-20240920115520348"></p>
<h5 id="129-4-2-2-查找方向寄存器"><a href="#129-4-2-2-查找方向寄存器" class="headerlink" title="129.4.2.2 查找方向寄存器"></a>129.4.2.2 查找方向寄存器</h5><p>打开参考手册part1 的第16 章节，数据寄存器的偏移地址如下图（图129-24）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201155939.png" alt="image-20240920115557743"></p>
<p>GPIO 有四组GPIO，分别是<code>GPIOA，GPIOB，GPIOC，GPIOD</code>。每组又以<code>A0~A7, B0~B7,C0~C7, D0~D7</code> 作为编号区分。GPIO0B7 在<code>GPIO_SWPORT_DDR_L</code> 上所以，方向寄存器的偏移地址为<code>0x0008</code>。接着查看<code>GPIO_SWPORT_DDR_L</code> 寄存器的具体描述，如下图（图129-25）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201157063.png"></p>
<p>如上图（图129-25）所示，<code>[31:16]</code>位属性是WO，也就是只可写入。这<code>[31:16]</code>位是写标志位，是低16 位的写使能。如果低16 位中某一位要设置输入输入输出，则对应高位写标志也应该设置为1。<code>[15：0]</code> 是数据方向控制寄存器低位，如果要设置某个GPIO 为输出，则对应位置1，如果要设置某个GPIO 为输入，则对应位置0。那么GPIO0 B7 ，我们要设置第15 位为输入还是输出，那么对应的[31:16]位写使能也要置1。</p>
<p>打开参考手册part1 的1.1 小节Address Mapping。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201158484.png" alt="image-20240920115852297"></p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201159488.png" alt="image-20240920115900301"></p>
<p>如上图（图129-27）所示，GPIO0 的基地址为<code>0xFDD60000</code>。<code>方向寄存器的地址=基地址+偏移地址=0xFDD60000+0x0008=0xFDD60008</code><br>然后使用IO 命令查看该寄存器的值，如下（图129-28）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201200398.png" alt="image-20240920120018233"></p>
<p>如下图（图129-29）所示，第15 位默认为1，设置<code>GPIO0_B7</code> 为输出。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201201575.png" alt="image-20240920120121408"></p>
<h5 id="129-4-2-3-查找数据寄存器"><a href="#129-4-2-3-查找数据寄存器" class="headerlink" title="129.4.2.3 查找数据寄存器"></a>129.4.2.3 查找数据寄存器</h5><p>打开参考手册part1 的1.1 小节Address Mapping。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201352886.png" alt="image-20240920135250695"></p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201352235.png" alt="image-20240920135258053"></p>
<p>如上图（图18-13）所示，GPIO0 的基地址为<code>0xFDD60000</code>。<br>数据寄存器的偏移地址如下（图129-32）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201353734.png" alt="image-20240920135317561"></p>
<p>所以<code>数据寄存器的地址为基地址+偏移地址=0xFDD60000</code>。使用IO 命令查看地址的值，如下（图129-33）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201353948.png" alt="image-20240920135336787"></p>
<p>我们来看一下这个数据寄存器的描述，如下图（图129-34）所示，</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201353096.png" alt="image-20240920135348907"></p>
<p>分析上图的方法和在分析方向寄存器的方法同理，由上图可知，如果要控制第15 位为高电平（置1），需要设置31 位为1，那么点亮灯，需要向数据寄存器写入<code>0x8000c040</code>，如下图（图129-35）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201354304.png" alt="image-20240920135415132"></p>
<p>如果要灭灯，需要设置第15 位为0 ，第31 位为1，那么向数据寄存器中写入<code>0x80004040</code>，如下图（图129-36）所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201354978.png" alt="image-20240920135437807"></p>
<p><strong>总结</strong></p>
<ul>
<li>复用关系寄存器的基地址为0xFDC20000 ，偏移地址为000C ，所以<code>要操作的地址为基地址+偏移地址=0xFDC2000C</code></li>
<li>GPIO 的基地址为0xFDD60000，偏移地址为0x0008，所以<code>方向寄存器要操作的地址为基地址+偏移地址=0xFDD60008</code>，我们要给方向寄存器写入0x80000044 设置为输出。</li>
<li>GPIO 的基地址为0xFDD60000，偏移地址为0x0000，所以<code>数据寄存器要操作的地址为基地址+偏移地址=0xFDD60000</code></li>
<li>默认的数据寄存器的值：0x8000c040 亮灯，0x80004040 灭灯</li>
</ul>
<h4 id="129-4-3-IO-命令点灯测试"><a href="#129-4-3-IO-命令点灯测试" class="headerlink" title="129.4.3 IO 命令点灯测试"></a>129.4.3 IO 命令点灯测试</h4><p>默认GPIO0_B7 是GPIO 模式，然后输入以下命令将方向寄存器设置为输出。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">io <span class="token parameter variable">-w</span> <span class="token parameter variable">-4</span> 0xFDD60008 0x80008044<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>接下来设置GPIO 是输出高电平还是低电平，首先查看数据寄存器的值，输入以下命令：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">io <span class="token parameter variable">-r</span> <span class="token parameter variable">-4</span> 0xFDD60000<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201359657.png" alt="image-20240920135924068"></p>
<p>给数据寄存器写入0x80008040 输出高电平，灯亮。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">io <span class="token parameter variable">-w</span> <span class="token parameter variable">-4</span> 0xFDD60000 0x8000c040<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>给数据寄存器写入0x80008040 输出高电平，灯灭。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">io <span class="token parameter variable">-w</span> <span class="token parameter variable">-4</span> 0xFDD60000 0x80004040<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="129-5-通过mem-设备控制GPIO"><a href="#129-5-通过mem-设备控制GPIO" class="headerlink" title="129.5 通过mem 设备控制GPIO"></a>129.5 通过mem 设备控制GPIO</h3><p>在上一节中，我们学习了如何通过输入输出命令（IO）来控制LED 灯的GPIO 寄存器，实现了简单的点灯效果。这种方法通过访问设备文件来直接读写寄存器，实现了对硬件的低级控制。</p>
<p>然而，在某些情况下，我们可能无法直接使用IO 命令来访问GPIO 寄存器，或者希望使用更高级的抽象来控制硬件。这时，可以使用/dev/mem 设备来操作物理内存，以实现对GPIO寄存器的访问。</p>
<p>通过打开/dev/mem 设备文件，并将其映射到用户空间的内存中，我们可以直接读写物理内存地址，从而实现对GPIO 寄存器的控制。这种方法相对于IO 命令更加灵活，可以使用更高级的编程语言（如C/C++）来编写控制逻辑。</p>
<p>在本小节中，我们将继续使用C 语言，并通过/dev/mem 设备来控制GPIO 寄存器，实现LED 灯的点灯效果。通过使用/dev/mem 设备进行GPIO 控制，我们可以更加灵活地操作硬件，并且能够使用更高级的编程语言和工具来进行开发和调试。接下来，让我们开始学习如何使用/dev/mem 设备来控制GPIO，进一步扩展我们的硬件控制能力。</p>
<h4 id="129-5-1-Linux-系统用户态访问内核态方式"><a href="#129-5-1-Linux-系统用户态访问内核态方式" class="headerlink" title="129.5.1 Linux 系统用户态访问内核态方式"></a>129.5.1 Linux 系统用户态访问内核态方式</h4><p>在Linux 系统中，用户态可以通过多种方式访问内核态，包括：</p>
<ol>
<li><strong>通过read/write/ioctl</strong>：使用这种方式，用户态程序可以通过读写文件描述符或使用ioctl 系统调用与内核进行通信。例如，可以通过读写特定文件描述符来控制设备或获取设备状态。</li>
<li><strong>通过sysfs 虚拟文件系统</strong>：sysfs 是一种以文件的形式表示设备和内核信息的虚拟文件系统。通过在sysfs 中的特定路径下读写文件，用户态程序可以与内核进行交互，例如控制GPIO 引脚或获取系统信息。</li>
<li><strong>通过内存映射</strong>：内存映射是将用户空间的一段内存区域映射到内核空间的一种机制。通过内存映射，用户态程序可以直接修改内存区域的内容，从而与内核进行通信。这种方式可以实现高效的数据传输和共享。</li>
<li><strong>通过Netlink</strong>：Netlink 是Linux 内核提供的一种通信机制，用于用户态程序与内核之间的双向通信。通过创建Netlink 套接字，用户态程序可以与内核进行交互，发送请求、接收事件通知等。这种方式适用于需要与内核进行复杂交互的场景，例如配置系统参数或发送命令。</li>
</ol>
<p>这些方法提供了不同的方式和接口，用户态程序可以根据具体需求选择适合的方法与内核进行通信。</p>
<h4 id="129-5-2-x2F-dev-x2F-mem-设备"><a href="#129-5-2-x2F-dev-x2F-mem-设备" class="headerlink" title="129.5.2 /dev/mem 设备"></a>129.5.2 /dev/mem 设备</h4><p>/dev/mem 是Linux 系统中的一个虚拟设备，通常与mmap 结合使用，可以将设备的物理内存映射到用户态，以实现用户空间对内核态的直接访问。无论是标准Linux 系统还是嵌入式Linux 系统，都支持使用/dev/mem 设备。</p>
<p>然而，直接访问内核空间是一项潜在危险的操作，因此只有root 用户才能访问/dev/mem设备。此外有些系统可能需要单独启动/dev/mem 设备的功能。配置启动/dev/mem 设备方法如下所示：</p>
<p>在Linux 源码内核中配置以下选项。</p>
<pre class="line-numbers language-none"><code class="language-none">Device Drivers ---&gt;
    Character devices---&gt;
        [*] /dev/mem virtual device support<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201403589.png" alt="image-20240920140331407"></p>
<p>在上一小节中，我们讲解了IO 命令，IO 命令实际上就是基于/dev/mem 设备实现的。如果Linux 内核源码没有配置支持/dev/mem，IO 命令是不能使用的。</p>
<h4 id="129-5-3-x2F-dev-x2F-mem-设备的使用方法。"><a href="#129-5-3-x2F-dev-x2F-mem-设备的使用方法。" class="headerlink" title="129.5.3 /dev/mem 设备的使用方法。"></a>129.5.3 /dev/mem 设备的使用方法。</h4><p><strong>使用/dev/mem 设备需要具有root 权限，并且谨慎操作，因为直接访问内核空间是一项潜在的危险操作</strong>。以下是使用/dev/mem 设备的基本步骤：</p>
<p><strong>步骤一：</strong></p>
<p>使用open 函数打开”/dev/mem”文件描述符，并指定访问权限和阻塞方式。访问权限可以是只读（<code>O_RDONLY</code>）、只写（<code>O_WRONLY</code>）或读写（<code>O_RDWR</code>）阻塞方式或非阻塞（<code>O_NDELAY</code>）。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/mem"</span><span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_NDELAY<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 读写权限，非阻塞*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>请注意，这里使用<code>O_RDWR</code> 表示读写权限，并使用<code>O_NDELAY</code> 表示非阻塞方式。你可以根据实际需求选择适当的访问权限和阻塞方式。</p>
<p><strong>步骤二：</strong></p>
<p>使用mmap 函数将需要访问的物理地址与”/dev/mem”文件描述符建立映射。mmap 函数将返回一个指向映射内存区域的指针。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">char</span> <span class="token operator">*</span>mmap_addr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
mmap_addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> MMAP_SIZE<span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span> MAP_SHARED<span class="token punctuation">,</span> fd<span class="token punctuation">,</span>MMAP_ADDR<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>在这里，使用mmap 函数将物理内存地址映射到<code>mmap_addr</code> 指针所指向的内存区域。<code>MMAP_SIZE</code> 表示映射的大小，<code>PROT_READ | PROT_WRITE</code> 表示访问权限为读写，<code>MAP_SHARED</code>表示共享映射，fd 是之前打开的<code>/dev/mem</code> 文件描述符，<code>MMAP_ADDR</code> 是要映射的物理地址。</p>
<p><strong>步骤三：</strong></p>
<p>对映射的地址进行访问，即对寄存器进行读写操作。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span>mmap_addr <span class="token operator">=</span> <span class="token number">0xff</span><span class="token punctuation">;</span> <span class="token comment">// 写地址</span>
a <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span>mmap_addr<span class="token punctuation">;</span> <span class="token comment">// 读地址</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>在这里，使用指针操作对mmap_addr 指向的地址进行读写操作。<code>*(int *)mmap_addr</code> 表示将<code>mmap_addr</code> 解释为int 类型的指针，对于写操作，将<code>0xff</code> 写入该地址；对于读操作，将地址的值读取到变量a 中。</p>
<p>通过上述三个步骤，我们可以使用/dev/mem 设备。接下来我们来了解下mmap 函数。</p>
<h4 id="129-5-4-mmap-函数"><a href="#129-5-4-mmap-函数" class="headerlink" title="129.5.4 mmap 函数"></a>129.5.4 mmap 函数</h4><p>mmap 函数解释如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">函数原型：
    <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> start<span class="token punctuation">,</span><span class="token class-name">size_t</span> length<span class="token punctuation">,</span><span class="token keyword">int</span> prot<span class="token punctuation">,</span><span class="token keyword">int</span> flags<span class="token punctuation">,</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span><span class="token class-name">off_t</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>

函数参数：
    start<span class="token operator">:</span> 指定文件应被映射到进程空间的起始地址，一般被指定为一个空指针，选择起始地址的任务留给内核来完成。映射成功之后，函数返回值为最后文件映射到进程空间的地址，进程可直接操作起始地址为该值的有效地址。
    length<span class="token operator">:</span> 是映射到调用进程地址空间的字节数。
    prot<span class="token operator">:</span> 参数指定共享内存的访问权限。可取如下几个值的或。<span class="token function">PROT_READ</span><span class="token punctuation">(</span>映射区域可读<span class="token punctuation">)</span>、<span class="token function">PROT_EXEC</span><span class="token punctuation">(</span>映射区域可执行<span class="token punctuation">)</span>、<span class="token function">PROT_WRITE</span><span class="token punctuation">(</span>映射区域可写<span class="token punctuation">)</span>、<span class="token function">PROT_NONE</span><span class="token punctuation">(</span>映射区域不可访问<span class="token punctuation">)</span>。
    flags<span class="token operator">:</span> 由以下几个常值指定，MAP_SHARED，MAP_PRIVATE，MAP_FIXED，其中MAP_SHARED，MAP_PRIVATE 必选其一，MAP_FIXED 不推荐使用。
    fd<span class="token operator">:</span> 有效的文件描述符。一般是由<span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span>函数返回。
    offset<span class="token operator">:</span> 文件映射的偏移量，offset 的大小必须是页的整数倍，如果设备为<span class="token number">0</span> 代表从文件最前方开始映射。
        
函数返回值：
    成功执行时，<span class="token function">mmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>返回被映射区的指针，失败时，<span class="token function">mmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>返回<span class="token operator">-</span><span class="token number">1.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="129-5-5-LED-灯实验"><a href="#129-5-5-LED-灯实验" class="headerlink" title="129.5.5 LED 灯实验"></a>129.5.5 LED 灯实验</h4><p>本小节代码在配套资料“<code>iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568 开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\85_gpioctrl04</code>”目录下。</p>
<p>实验要求：<br>通过编写mem 设备控制GPIO（LED 灯）的应用程序实现LED 灯闪烁的效果。</p>
<p>实验硬件连接：<br>使用迅为iTOP-RK3568 开发板上的用户灯LED9。</p>
<p>实验步骤：<br>首先进入ubuntu 的终端界面输入以下命令来创建gpioctrl.c 文件，如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201409955.png" alt="image-20240920140928783"></p>
<p>然后向该文件中添加以下内容：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO_REG_BASE</span> <span class="token expression"><span class="token number">0xFDD60000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO_SWPORT_DDR_L_OFFSET</span> <span class="token expression"><span class="token number">0x0008</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO_SWPORT_DR_L_OFFSET</span> <span class="token expression"><span class="token number">0x0000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SIZE_MAP</span> <span class="token expression"><span class="token number">0x1000</span></span></span>

<span class="token comment">// 打开LED灯</span>
<span class="token keyword">void</span> <span class="token function">LED_ON</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>base<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 设置LED灯的方向为输出</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>base <span class="token operator">+</span> GPIO_SWPORT_DDR_L_OFFSET<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0x80008044</span><span class="token punctuation">;</span>
    <span class="token comment">// 将LED灯打开</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>base <span class="token operator">+</span> GPIO_SWPORT_DR_L_OFFSET<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0x80008040</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 关闭LED灯</span>
<span class="token keyword">void</span> <span class="token function">LED_OFF</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>base<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 设置LED灯的方向为输出</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>base <span class="token operator">+</span> GPIO_SWPORT_DDR_L_OFFSET<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0x80008044</span><span class="token punctuation">;</span>
    <span class="token comment">// 将LED灯关闭</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>base <span class="token operator">+</span> GPIO_SWPORT_DR_L_OFFSET<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0x80000040</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>map_base<span class="token punctuation">;</span>

    <span class="token comment">// 打开/dev/mem设备</span>
    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/mem"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"open /dev/mem error \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 将物理地址映射到用户空间</span>
    map_base <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> SIZE_MAP<span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span> MAP_SHARED<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> GPIO_REG_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map_base <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"map_base error \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 打开LED灯</span>
        <span class="token function">LED_ON</span><span class="token punctuation">(</span>map_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 等待1秒</span>
        <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 关闭LED灯</span>
        <span class="token function">LED_OFF</span><span class="token punctuation">(</span>map_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 等待1秒</span>
        <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 解除映射</span>
    <span class="token function">munmap</span><span class="token punctuation">(</span>map_base<span class="token punctuation">,</span> SIZE_MAP<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 关闭文件描述符</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 返回0表示程序正常退出</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>保存退出之后，使用以下命令设置交叉编译器环境，并对gpioctrl.c 进行交叉编译，编译完<br>成如下图所示：</p>
<pre class="line-numbers language-none"><code class="language-none">export PATH=/usr/local/arm64/gcc-linaro-6.3.1-2017.05-x86_64_aarch64-linux-gnu/bin:$PATH
aarch64-linux-gnu-gcc gpioctrl.c -o gpioctrl<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201417492.png" alt="image-20240920141725317"></p>
<p>最后将交叉编译生成的gpioctrl 文件拷贝到开发板目录下运行即可。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">chmod</span> <span class="token number">777</span> gpioctrl
./gpioctrl <span class="token number">15</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201417591.png" alt="image-20240920141744420"></p>
<p>程序运行之后，开发板上的用户灯LED 实现了闪烁的效果。</p>
<h2 id="第130-章GPIO-的调试方法"><a href="#第130-章GPIO-的调试方法" class="headerlink" title="第130 章GPIO 的调试方法"></a>第130 章GPIO 的调试方法</h2><p>GPIO 的调试方法除了使用IO 命令去查看寄存器，还可以使用其他方法进行GPIO 的调试。</p>
<h3 id="130-1-方法一"><a href="#130-1-方法一" class="headerlink" title="130.1 方法一"></a>130.1 方法一</h3><p>debugfs 是Linux 内核提供的一个调试文件系统，可以用于查看和调试内核中的各种信息，包括GPIO 的使用情况。通过挂载debugfs 文件系统，并查看<code>/sys/kernel/debug/</code>目录下的相关文件，可以获取GPIO 的状态，配置和其他调试信息。如下图所示，我们进入<code>/sys/kernel/debug/</code>目录下。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201420898.png" alt="image-20240920142027707"></p>
<p>如果上图目录<code>/sys/kernel/debug</code> 目录下没有文件，需要在Linux 内核源码配置debugfs，如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201422334.png" alt="image-20240920142211144"></p>
<p>配置好之后，重新编译内核源码，烧写内核镜像。<br>如果没有debugfs，可以使用以下命令进行挂载:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mount</span> <span class="token parameter variable">-t</span> debugfs none /sys/kernel/debug/<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果有debugfs，可以使用以下命令查看GPIO 的信息。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> /sys/kernel/debug/gpio<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201422316.png" alt="image-20240920142234093"></p>
<h3 id="130-2-方法二"><a href="#130-2-方法二" class="headerlink" title="130.2 方法二"></a>130.2 方法二</h3><p>当你进入<code>/sys/kernel/debug/pinctrl</code> 目录时，你可以获取有关GPIO 控制器的调试信息。在该目录下，通常会有以下文件和目录：</p>
<ol>
<li><code>/sys/kernel/debug/pinctrl/*/pinmux-pins</code>：这些文件列出了每个GPIO 引脚的引脚复用配置。<br>你可以查看每个引脚的功能模式、引脚复用选择以及其他相关的配置信息。我们进入到<code>/sys/kernel/debug/pinctrl/pinctrl-rockchip-pinctrl/</code>下面，输入“<code>cat pinmux-pins</code>”，如下图所示：</li>
</ol>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201423136.png" alt="image-20240920142327934"></p>
<ol start="2">
<li><code>/sys/kernel/debug/pinctrl/*/pins</code>：这些文件列出了GPIO 的引脚编号，可以查看GPIO 编号。<br>我们进入到<code>/sys/kernel/debug/pinctrl/pinctrl-rockchip-pinctrl/</code>下面，输入“<code>cat pins</code>”，如下图所示：</li>
</ol>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201423738.png" alt="image-20240920142357551"></p>
<ol start="3">
<li><code>/sys/kernel/debug/pinctrl/*/gpio-ranges</code>：这些文件列出了每个GPIO 控制器支持的GPIO 范围。<br>你可以查看GPIO 编号的范围和对应的控制器名称。我们进入到<code>/sys/kernel/debug/pinctrl/pinctrl-rockchip-pinctrl/</code>下面，输入“<code>cat gpio-ranges</code>”，如下图所示：</li>
</ol>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201424002.png" alt="image-20240920142430771"></p>
<ol start="4">
<li><code>/sys/kernel/debug/pinctrl/*/pinmux-functions</code>：这些文件列出了每个功能模式的名称以及与之关联的GPIO 引脚。你可以查看各个功能模式的名称和对应的引脚列表。我们进入到<code>/sys/kernel/debug/pinctrl/pinctrl-rockchip-pinctrl/</code>下面，输入“<code>cat pinmux-functions</code>”，如下图所示：</li>
</ol>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201425666.png" alt="image-20240920142502459"></p>
<ol start="5">
<li><code>/sys/kernel/debug/pinctrl/*/pingroups</code>：该路径提供有关用于配置和控制系统上的GPIO 引脚的引脚组的信息。我们进入到<code>/sys/kernel/debug/pinctrl/pinctrl-rockchip-pinctrl/</code>下面，输入“<code>cat pingroups</code>”，如下图所示：</li>
</ol>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201425117.png" alt="image-20240920142550936"></p>
<ol start="6">
<li><code>/sys/kernel/debug/pinctrl/*/pinconf-pins</code>：这些文件包含了GPIO 引脚的配置信息，如输入/输出模式、上拉/下拉设置等。你可以查看和修改GPIO 的电气属性，以便进行GPIO 的调试和配置。我们进入到<code>/sys/kernel/debug/pinctrl/pinctrl-rockchip-pinctrl/</code>下面，输入“<code>cat pinconf-pins</code>”，如下图所示：</li>
</ol>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409201426607.png" alt="image-20240920142625338"></p>
<p>在这些文件和目录中，你可以浏览GPIO 控制器和引脚的相关信息，包括功能模式、复用配置、范围和配置参数等。这些信息可以帮助你了解GPIO 的当前状态和配置，并进行相应的调试和修改。</p>
<h2 id="第131-章GPIO-子系统API-函数的引入"><a href="#第131-章GPIO-子系统API-函数的引入" class="headerlink" title="第131 章GPIO 子系统API 函数的引入"></a>第131 章GPIO 子系统API 函数的引入</h2><p>事实上，在前面中断课程中，已经简单接触到了GPIO 子系统中的API 函数，其中用来获取gpio 中断编号的gpio_to_irq 函数就属于GPIO 子系统中的API 函数，在本章节中将对GPIO子系统进行简单的介绍。</p>
<p>在目前的Linux 内核主线中，GPIO（通用输入/输出）子系统存在两个版本，这里将两个版本区分为新版本和旧版本。新版本GPIO 子系统接口是基于描述符（descriptor-based）来实现的，而旧版本的GPIO 子系统接口是基于整数（integer-based）来实现的，在Linux 内核中为了保持向下的兼容性，旧版本的接口在最新的内核版本中仍然得到支持，而随着时间的推移，新版本的GPIO 子系统接口会越来越完善，最终完全取代旧版本，所以在本课程中主要讲解新版本的GPIO 子系统接口。</p>
<p>新的GPIO 子系统接口需要与与设备树（Device Tree）结合使用。使用设备树和新的GPIO接口可以更加灵活地配置和管理系统中的GPIO 资源，提供了更好的可扩展性和可移植性。所以如果没有设备树，就无法使用新的GPIO 接口。</p>
<p>那要如何对新旧GPIO 子系统接口进行区分呢，一个明显的区别是新的GPIO 子系统接口使用了以”<code>gpiod_</code>“作为前缀的函数命名约定，而旧的GPIO 子系统接口使用了以”<code>gpio_</code>“作为前缀的函数命名约定。</p>
<p>一些区分新旧GPIO 子系统接口的示例如下所示：</p>
<p>新的GPIO 子系统接口示例如下所示：</p>
<pre class="line-numbers language-none"><code class="language-none">gpiod_set_value()
gpiod_direction_input()
gpiod_direction_output()
gpiod_get_value()
gpiod_request()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>旧的GPIO 子系统接口示例：</p>
<pre class="line-numbers language-none"><code class="language-none">gpio_set_value()
gpio_direction_input()
gpio_direction_output()
gpio_get_value()
gpio_request()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面也提到了新的GPIO 子系统接口是基于描述符（descriptor-based）来实现的，由<code>struct gpio_desc</code> 结构体来表示，该结构体定义在内核源码的“<code>drivers/gpio/gpiolib.h</code>”目录下。具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">gpio_desc</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">gpio_device</span> gdev<span class="token punctuation">;</span> <span class="token comment">// GPIO 设备结构体</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">;</span> <span class="token comment">// 标志位，用于表示不同的属性</span>
    
    <span class="token comment">/* 标志位符号对应的位号*/</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLAG_REQUESTED</span> <span class="token expression"><span class="token number">0</span> </span><span class="token comment">// GPIO 已请求</span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLAG_IS_OUT</span> <span class="token expression"><span class="token number">1</span> </span><span class="token comment">// GPIO 用作输出</span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLAG_EXPORT</span> <span class="token expression"><span class="token number">2</span> </span><span class="token comment">// 受sysfs_lock 保护的导出标志</span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLAG_SYSFS</span> <span class="token expression"><span class="token number">3</span> </span><span class="token comment">// 通过/sys/class/gpio/control 导出的标志</span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLAG_ACTIVE_LOW</span> <span class="token expression"><span class="token number">6</span> </span><span class="token comment">// GPIO 值为低电平时激活</span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLAG_OPEN_DRAIN</span> <span class="token expression"><span class="token number">7</span> </span><span class="token comment">// GPIO 为开漏类型</span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLAG_OPEN_SOURCE</span> <span class="token expression"><span class="token number">8</span> </span><span class="token comment">// GPIO 为开源类型</span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLAG_USED_AS_IRQ</span> <span class="token expression"><span class="token number">9</span> </span><span class="token comment">// GPIO 连接到中断请求（IRQ）</span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLAG_IS_HOGGED</span> <span class="token expression"><span class="token number">11</span> </span><span class="token comment">// GPIO 被独占占用</span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLAG_TRANSITORY</span> <span class="token expression"><span class="token number">12</span> </span><span class="token comment">// GPIO 在休眠或复位时可能失去值</span></span>
    
    <span class="token comment">/* 连接标签*/</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>label<span class="token punctuation">;</span> <span class="token comment">// GPIO 的名称</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span> <span class="token comment">// GPIO 的名称</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>（1）struct gpio_device gdev 是一个struct gpio_device 类型的字段，用于表示GPIO 设备的相关信息。struct gpio_device 结构体通常包含设备的底层硬件控制器等信息。<br>（2）unsigned long flags:用于表示GPIO 的标志位，以表示不同的属性。通过使用位操作，每个标志位可以单独设置或清除。<br>（3）第5-14 行用于表示不同标志位的符号常量，与flags 字段中的位号相对应。例如，在flags 字段中的第0 位表示FLAG_REQUESTED，第1 位表示FLAG_IS_OUT，以此类推<br>（4）const char *label: 这是一个指向字符串的指针，表示GPIO 的标签或名称。<br>（5）const char *name: 这是一个指向字符串的指针，表示GPIO 的名称。</p>
<p>上面需要重点关注的是然后struct gpio_device 结构体，该结构体同样定义在内核源码的“drivers/gpio/gpiolib.h”目录下，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">gpio_device</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> id<span class="token punctuation">;</span> <span class="token comment">// GPIO 设备ID</span>
    <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">;</span> <span class="token comment">// 对应的设备结构体指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">cdev</span> chrdev<span class="token punctuation">;</span> <span class="token comment">// 字符设备结构体</span>
    <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>mockdev<span class="token punctuation">;</span> <span class="token comment">// 模拟设备结构体指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>owner<span class="token punctuation">;</span> <span class="token comment">// 拥有该GPIO 设备的内核模块指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">gpio_chip</span> <span class="token operator">*</span>chip<span class="token punctuation">;</span> <span class="token comment">// 对应的GPIO 芯片结构体指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">gpio_desc</span> <span class="token operator">*</span>descs<span class="token punctuation">;</span> <span class="token comment">// GPIO 描述符数组指针</span>
    <span class="token keyword">int</span> base<span class="token punctuation">;</span> <span class="token comment">// GPIO 编号的起始值</span>
    u16 ngpio<span class="token punctuation">;</span> <span class="token comment">// GPIO 的数量</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>label<span class="token punctuation">;</span> <span class="token comment">// GPIO 设备的标签</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">;</span> <span class="token comment">// 与GPIO 设备相关的数据指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> list<span class="token punctuation">;</span> <span class="token comment">// 用于将GPIO 设备结构体连接到链表中</span>
    
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_PINCTRL</span></span>
    <span class="token comment">/*
    * 如果启用了CONFIG_PINCTRL 选项，GPIO 控制器可以选择描述它们在SoC 中服务的实际引脚范围。
    * 此信息将由pinctrl 子系统用于配置相应的GPIO 引脚。
    */</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> pin_ranges<span class="token punctuation">;</span> <span class="token comment">// 描述GPIO 控制器引脚范围的链表</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该结构体是用来描述GPIO 设备的数据结构，关于该结构体的参数介绍如下所示：<br>（1）int id:整型字段，表示GPIO 设备的ID。每个GPIO 设备可以有一个唯一的ID。<br>（2）struct device *dev:指向struct device 的指针，表示与GPIO 设备相关联的设备结构体。<br>（3）struct cdev chrdev: 字符设备结构体，用于实现GPIO 设备的字符设备接口。<br>（4）struct device *mockdev: 指向struct device 的指针，用于表示GPIO 设备的模拟设备结构体。<br>（5）struct module *owner: 指向拥有该GPIO 设备的内核模块的指针。<br>（6）struct gpio_chip *chip: 指向struct gpio_chip 的指针，表示与GPIO 设备关联的GPIO 芯片（GPIO 控制器）结构体。<br>（7）struct gpio_desc *descs: 指向struct gpio_desc 数组的指针，表示与GPIO 设备关联的GPIO 描述符。每个GPIO 描述符用于描述GPIO 的属性和状态。<br>（8）int base: 表示GPIO 编号的起始值。<br>（9）u16 ngpio: 16 位无符号整型字段，表示GPIO 的数量。<br>（10）const char *label: 指向字符串的指针，表示GPIO 设备的标签或名称。<br>（11）void *data: 指向与GPIO 设备相关的数据的指针，用于存储和访问与GPIO 设备相关的自定义数据。<br>（12）struct list_head list: 将GPIO 设备结构体连接到链表中的字段，用于管理多个GPIO 设备的列表。</p>
<p>（13）struct list_head pin_ranges (仅在启用CONFIG_PINCTRL 选项时存在): 用于描述GPIO 控制器引脚范围的链表。如果配置了GPIO 控制器的引脚范围，该链表将包含描述每个范围的元素。</p>
<p>在上面一系列的参数中，要重点关注的是<code>struct gpio_chip *chip</code> 这一结构体，表示与GPIO 设备关联的GPIO 芯片（GPIO 控制器）结构体，该结构体定义在内核源码目录下的“<code>include/linux/gpio/driver.h</code>”文件中，具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">gpio_chip</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>label<span class="token punctuation">;</span> <span class="token comment">// GPIO 芯片标签</span>
    <span class="token keyword">struct</span> <span class="token class-name">gpio_device</span> gpiodev<span class="token punctuation">;</span> <span class="token comment">// GPIO 设备</span>
    <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>parent<span class="token punctuation">;</span> <span class="token comment">// 父设备指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>owner<span class="token punctuation">;</span> <span class="token comment">// 拥有者模块指针</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>request<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gpio_chip</span> <span class="token operator">*</span>chip<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 请求GPIO</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>free<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gpio_chip</span> <span class="token operator">*</span>chip<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 释放GPIO</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>get_direction<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gpio_chip</span> <span class="token operator">*</span>chip<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取GPIO 方向</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>direction_input<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gpio_chip</span> <span class="token operator">*</span>chip<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置GPIO 为输入</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>direction_output<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gpio_chip</span> <span class="token operator">*</span>chip<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置GPIO 为输出</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>get<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gpio_chip</span> chip<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取GPIO 值</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>get_multiple<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gpio_chip</span> chip<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>mask<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>bits<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取多个GPIO 的    值</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gpio_chip</span> chip<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置GPIO 值</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>set_multiple<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gpio_chip</span> chip<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> mask<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>bits<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置多个GPIO    的值</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>set_config<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gpio_chip</span> <span class="token operator">*</span>chip<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> offset<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置GPIO 配置</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>to_irq<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gpio_chip</span> chip<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将GPIO 转换为中断</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>dbg_show<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">seq_file</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">gpio_chip</span> chip<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 在调试信息中显示GPIO</span>
    <span class="token keyword">int</span> base<span class="token punctuation">;</span> <span class="token comment">// GPIO 编号的基准值</span>
    u16 ngpio<span class="token punctuation">;</span> <span class="token comment">// GPIO 的数量</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token operator">*</span>names<span class="token punctuation">;</span> <span class="token comment">// GPIO 的名称数组</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>struct gpio_chip *chip 这一结构体用于描述GPIO 芯片的属性和操作函数，可以通过函数指针调用相应的函数来请求、释放、设置、获取GPIO 的状态和数值等操作，从而实现对GPIO 的控制和管理，需要注意的是这个结构体中的一系列函数都不需要我们来填充，这些工作都是由芯片原厂工程师来完成的，我们只需要学会新gpio 子系统相应API 函数的使用即可。</p>
<p>在接下来的章节中将对常用的新gpio 子系统API 函数进行讲解。</p>
<h2 id="第132-章获取单个gpio-描述实验"><a href="#第132-章获取单个gpio-描述实验" class="headerlink" title="第132 章获取单个gpio 描述实验"></a>第132 章获取单个gpio 描述实验</h2><p>本章节将对新gpio 子系统中获取单个gpio 描述的api 接口进行讲解。</p>
<h3 id="132-1-函数介绍"><a href="#132-1-函数介绍" class="headerlink" title="132.1 函数介绍"></a>132.1 函数介绍</h3><p><strong>（1）获取GPIO 描述符gpiod_get</strong></p>
<p><code>struct gpio_desc *gpiod_get</code> 是Linux 内核中用于获取GPIO 描述符的函数。下面是对该函数的详细介绍：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">函数原型：
    <span class="token keyword">struct</span> <span class="token class-name">gpio_desc</span> <span class="token operator">*</span>__must_check <span class="token function">gpiod_get</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>con_id<span class="token punctuation">,</span><span class="token keyword">enum</span> <span class="token class-name">gpiod_flags</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
头文件：
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/gpio/consumer.h&gt;</span></span>
参数：
    dev：指向设备结构体的指针，表示与GPIO 相关联的设备。
    con_id：连接标识符（connection identifier），用于标识所需的GPIO 连接。通常由设备树（Device Tree）或其他设备描述信息定义
    flags：GPIO 描述符的选项标志，用于指定GPIO 的属性和操作模式。以下是一些常用的选项标志（<span class="token keyword">enum</span> <span class="token class-name">gpiod_flags</span>）：
        GPIOD_INPUT：将GPIO 配置为输入模式。
        GPIOD_OUTPUT：将GPIO 配置为输出模式。
        GPIOD_ACTIVE_LOW：指示GPIO 的默认电平为低电平（激活低电平）。
        GPIOD_OPEN_DRAIN：将GPIO 配置为开漏输出模式。
        GPIOD_OPEN_SOURCE：将GPIO 配置为开源输出模式。
函数功能：
    获取与给定设备和连接标识符（con_id）相关联的GPIO 描述符。
返回值：
    如果成功获取到GPIO 描述符，则返回指向<span class="token keyword">struct</span> <span class="token class-name">gpio_desc</span> 的指针；如果获取失败，则返回<span class="token constant">NULL</span>。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在Linux 内核中还有另外三个同样是获取GPIO 描述符资源的函数，三个函数内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">gpio_desc</span> <span class="token operator">*</span><span class="token function">gpiod_get_index</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>con_id<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> idx<span class="token punctuation">,</span> <span class="token keyword">enum</span> <span class="token class-name">gpiod_flags</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">gpio_desc</span> <span class="token operator">*</span><span class="token function">gpiod_get_optional</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>con_id<span class="token punctuation">,</span> <span class="token keyword">enum</span> <span class="token class-name">gpiod_flags</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">gpio_desc</span> <span class="token operator">*</span><span class="token function">gpiod_get_index_optional</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>con_id<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> index<span class="token punctuation">,</span> <span class="token keyword">enum</span> <span class="token class-name">gpiod_flags</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>相较于上面介绍的gpiod_get 函数，下面的三个函数可能会多一个index 参数和optional的函数后缀，其中index 表示GPIO 的索引值，当设备树的GPIO 属性值包含多个GPIO 引脚描述时， 使用index 来表示每个GPIO 引脚的唯一标识。而带optional() 后缀的函数与不带optional 后缀的函数在功能上是相同的，都用于获取GPIO 描述符，两者的区别在于返回值的不同：</p>
<p>使用带optional() 的函数时，如果获取失败，返回值为NULL。<br>使用不带optional 的函数时，如果获取失败，返回值是一个特殊的结构表示获取GPIO 描述符失败。</p>
<p><strong>（2）释放GPIO 描述符gpiod_put</strong></p>
<p><code>gpiod_put()</code> 函数是Linux 内核中用于释放GPIO 描述符资源的函数。下面是对该函数的详细介绍：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//函数原型：</span>
    <span class="token keyword">void</span> <span class="token function">gpiod_put</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gpio_desc</span> <span class="token operator">*</span>desc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//头文件：</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/gpio/consumer.h&gt;</span></span>
<span class="token comment">//参数：</span>
    desc：指向要释放的GPIO 描述符的指针。
<span class="token comment">//功能：</span>
    <span class="token function">gpiod_put</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 函数用于释放之前通过<span class="token function">gpiod_get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 或类似函数获取的GPIO 描述符。
<span class="token comment">//返回值：</span>
    无返回值。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="132-2-设备树的修改"><a href="#132-2-设备树的修改" class="headerlink" title="132.2 设备树的修改"></a>132.2 设备树的修改</h3><p>本小节修改好的设备树以及编译好的boot.img 镜像存放路径为：<code>iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568 开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\86_gpioctrl05\01_内核镜像</code>。</p>
<p>在131 章也提到了新版本的gpio 子系统api 接口要与设备树结合才能使用，所以需要在设备树中将用于获取GPIO 描述符的引脚复用为GPIO 模式。为了让教程更贴近于实战，这里选择RK3568 开发板背面20Pin GPIO 座子的1 号引脚，右边对应的丝印为I2C3_SDA_M0，这里的丝印表示该引脚可以复用为I2C3 的SDA 功能，而在当前的设备树源码中这个引脚是没有任何复用的，该引脚的具体位置如下所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409231129815.png" alt="image-20240923112900196"></p>
<p>在前面pinctrl 的章节中已经学习了如何将一个管脚复用为GPIO，首先我们需要确定该引脚的GPIO 编号，来到RK3568 开发板的底板原理图，找到J39 GPIO 底座，如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409231129379.png" alt="image-20240923112924218"></p>
<p>可以看到1 号管脚的网络标号为I2C3_SDA_M0，然后打开核心板原理图，根据这个网络标号进行搜索，查找到的核心板内容如下所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409231129191.png" alt="image-20240923112939024"></p>
<p>左侧为该引脚的一些复用功能，箭头指向的部分为接下来要用到的GPIO 引脚编号<code>GPIO1_A0</code>，然后对设备树进行内容的添加，从而将该引脚复用为GPIO 的功能。</p>
<p>首先根据上图中的复用功能查看设备树中是否已经对该引脚进行了复用，在确保该引脚无任何复用之后，对rk3568-evb1-ddr4-v10.dtsi 设备树进行内容的添加，在根节点的结尾添加以下内容：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">my_gpio<span class="token operator">:</span>gpiol_a0 <span class="token punctuation">{</span>
    compatible <span class="token operator">=</span> <span class="token string">"mygpio"</span><span class="token punctuation">;</span>
    my<span class="token operator">-</span>gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio1 RK_PA0 GPIO_ACTIVE_HIGH<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>
    pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>mygpio_ctrl<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>compatible: 用于指定设备的兼容性字符串，与驱动程序中的值相匹配。<br>my-gpios: 指定了与该设备相关联的GPIO。&amp;gpiol 表示GPIO 控制器的句柄（handle），RK_PA0 是与该GPIO 相关的资源描述符（resource specifier），GPIO_ACTIVE_HIGH 表示GPIO 的默认电平为高电平。<br>pinctrl-names 和pinctrl-0: 用于指定引脚控制器（pinctrl）的配置。pinctrl-names 表示引脚控制器配置的名称，这里为”default”。pinctrl-0 指定了与该配置相关联的引脚控制器句柄，这里为&amp;mygpio_ctrl。<br>添加完成如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409231141859.png" alt="image-20240923114109716"></p>
<p>然后找到pinctrl 节点，在节点尾部添加以下内容，</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">mygpio <span class="token punctuation">{</span>
    mygpio_ctrl<span class="token operator">:</span> my<span class="token operator">-</span>gpio<span class="token operator">-</span>ctrl <span class="token punctuation">{</span>
        rockchip<span class="token punctuation">,</span>pins <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span> RK_PA0 RK_FUNC_GPIO <span class="token operator">&amp;</span>pcfg_pull_none<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在第三行的内容中，1 表示引脚索引，RK_PA0 表示资源描述符，用于标识与该引脚相关联的物理资源，表示引脚所属的功能组，<code>RK _FUNC_GPI0</code> 表示将引脚的功能设置为GPIO，<code>&amp;pcfg_pull_none</code> 表示引脚配置为无上下拉。</p>
<p>添加完成如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409231145018.png" alt="image-20240923114514878"></p>
<p>至此，关于设备树相关的修改就完成了，保存退出之后，编译内核，然后将生成的boot.img镜像烧写到开发板上即可。</p>
<p>132.3 驱动程序的编写<br>本实验对应的网盘路径为：<code>iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\86_gpioctrl05\02_module</code>。<br>编写完成的gpio_api.c 代码如下所示:</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/platform_device.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mod_devicetable.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/gpio/consumer.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">gpio_desc</span> <span class="token operator">*</span>mygpio1<span class="token punctuation">;</span>  <span class="token comment">// GPIO 描述符指针</span>
<span class="token keyword">struct</span> <span class="token class-name">gpio_desc</span> <span class="token operator">*</span>mygpio2<span class="token punctuation">;</span>  <span class="token comment">// GPIO 描述符指针</span>
<span class="token keyword">int</span> num<span class="token punctuation">;</span>  <span class="token comment">// GPIO 编号</span>

<span class="token comment">//平台设备初始化函数</span>
<span class="token comment">// 平台设备初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">my_platform_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"This is my_platform_probe\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取可选的GPIO描述符</span>
    mygpio1 <span class="token operator">=</span> <span class="token function">gpiod_get_optional</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"my"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mygpio1 <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"gpiod_get_optional error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    num <span class="token operator">=</span> <span class="token function">desc_to_gpio</span><span class="token punctuation">(</span>mygpio1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"num is %d\n"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 释放GPIO描述符</span>
    <span class="token function">gpiod_put</span><span class="token punctuation">(</span>mygpio1<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取指定索引的GPIO描述符</span>
    mygpio2 <span class="token operator">=</span> <span class="token function">gpiod_get_index</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"my"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>mygpio2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"gpiod_get_index error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    num <span class="token operator">=</span> <span class="token function">desc_to_gpio</span><span class="token punctuation">(</span>mygpio2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"num is %d\n"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 平台设备的移除函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">my_platform_remove</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"my_platform_remove: Removing platform device\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 清理设备特定的操作</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> of_match_table_id<span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">{</span><span class="token punctuation">.</span>compatible<span class="token operator">=</span><span class="token string">"mygpio"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义平台驱动结构体</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">platform_driver</span> my_platform_driver <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>probe <span class="token operator">=</span> my_platform_probe<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>remove <span class="token operator">=</span> my_platform_remove<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>driver <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"my_platform_device"</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
		<span class="token punctuation">.</span>of_match_table <span class="token operator">=</span>  of_match_table_id<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 模块初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">my_platform_driver_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    <span class="token comment">// 注册平台驱动</span>
    ret <span class="token operator">=</span> <span class="token function">platform_driver_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_platform_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"Failed to register platform driver\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"my_platform_driver: Platform driver initialized\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 模块退出函数</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">my_platform_driver_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 注销平台驱动</span>
	<span class="token function">gpiod_put</span><span class="token punctuation">(</span>mygpio2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">platform_driver_unregister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_platform_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"my_platform_driver: Platform driver exited\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>my_platform_driver_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>my_platform_driver_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"topeet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="132-4-运行测试"><a href="#132-4-运行测试" class="headerlink" title="132.4 运行测试"></a>132.4 运行测试</h3><h4 id="132-4-1-编译驱动程序"><a href="#132-4-1-编译驱动程序" class="headerlink" title="132.4.1 编译驱动程序"></a>132.4.1 编译驱动程序</h4><p>在上一小节中的gpio_api.c 代码同一目录下创建Makefile 文件，Makefile 文件内容如下所示：然后使用命令“make”进行驱动的编译，编译完生成gpio_api.ko 目标文件，至此驱动模块就编译成功了。</p>
<h4 id="132-4-2-运行测试"><a href="#132-4-2-运行测试" class="headerlink" title="132.4.2 运行测试"></a>132.4.2 运行测试</h4><p>首先需要确保当前开发板使用的内核镜像是我们在132.2 小节中修改设备树后编译生成的镜像，然后启动开发板，使用以下命令进行驱动的加载，如下图（图132-9）所示：</p>
<pre class="line-numbers language-none"><code class="language-none">insmod gpio_api.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409231150171.png" alt="image-20240923115010015"></p>
<p>可以看到两个跟gpio 的打印，打印出来获取到的gpio 引脚号为32，在前面的章节中也学习过了GPIO 引脚编号的计算公式，GPIO1_A0 对应32 号，然后使用以下命令进行驱动的卸载，<br>如下图所示：</p>
<pre class="line-numbers language-none"><code class="language-none">rmmod gpio_api.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409231150844.png" alt="image-20240923115036695"></p>
<p>至此，获取单个gpio 描述实验就完成了。</p>
<h2 id="第133-章GPIO-操作函数实验"><a href="#第133-章GPIO-操作函数实验" class="headerlink" title="第133 章GPIO 操作函数实验"></a>第133 章GPIO 操作函数实验</h2><p>从本章节将对新gpio 子系统中操作GPIO 的相关api 接口函数进行讲解。</p>
<h3 id="133-1-函数介绍"><a href="#133-1-函数介绍" class="headerlink" title="133.1 函数介绍"></a>133.1 函数介绍</h3><p><strong>1 获取GPIO 的方向函数：</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">（<span class="token number">1</span>）函数原型：
    <span class="token keyword">int</span> <span class="token function">gpiod_get_direction</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gpio_desc</span> <span class="token operator">*</span>desc<span class="token punctuation">)</span><span class="token punctuation">;</span>
（<span class="token number">2</span>）头文件：
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/gpio/consumer.h&gt;</span></span>
（<span class="token number">3</span>）参数：
    desc：指向GPIO 描述符的指针。
（<span class="token number">4</span>）函数功能：
    gpiod_get_direction 函数用于获取GPIO 的方向，即判断GPIO 是输入还是输出。
（<span class="token number">5</span>）返回值：
    返回值为整型，表示GPIO 的方向。如果成功获取到GPIO 方向，返回值为 GPIO_LINE_DIRECTION_IN（<span class="token number">0</span>）表示输入，或GPIO_LINE_DIRECTION_OUT（<span class="token number">1</span>）表示输出。如果获取失败，返回值为负数，表示错误码。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该函数的作用是获取给定GPIO 描述符所代表的GPIO 的方向。通过该函数，可以确定GPIO是配置为输入还是输出。返回值可以用于进一步判断和处理GPIO 的方向相关逻辑。</p>
<p><strong>2 配置GPIO 的方向函数：</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">（<span class="token number">1</span>）函数原型：
    <span class="token keyword">int</span> <span class="token function">gpiod_direction_input</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gpio_desc</span> <span class="token operator">*</span>desc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token function">gpiod_direction_output</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gpio_desc</span> <span class="token operator">*</span>desc<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
（<span class="token number">2</span>）头文件：
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/gpio/consumer.h&gt;</span></span>
（<span class="token number">3</span>）参数：
    desc：指向GPIO 描述符的指针。
    value（仅适用于gpiod_direction_output）：初始输出值，可以是<span class="token number">0</span> 或<span class="token number">1</span>。
（<span class="token number">4</span>）函数功能：
    gpiod_direction_input 函数用于配置GPIO 的方向为输入。
    gpiod_direction_output 函数用于配置GPIO 的方向为输出，并可指定初始输出值。
（<span class="token number">5</span>）返回值：
    返回值为整型，表示配置GPIO 方向的结果。
    如果成功配置GPIO 方向，返回值为<span class="token number">0</span>。
    如果配置失败，返回值为负数，表示错误码。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这两个函数用于配置GPIO 的方向。gpiod_direction_input 将给定的GPIO 描述符所代表的GPIO 配置为输入模式。而<code>gpiod_direction_output</code> 将GPIO 配置为输出模式，并可以指定初始输出值。</p>
<p><strong>3 读取GPIO 的电平状态函数：</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">（<span class="token number">1</span>）函数原型：
    <span class="token keyword">int</span> <span class="token function">gpiod_get_value</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">gpio_desc</span> <span class="token operator">*</span>desc<span class="token punctuation">)</span><span class="token punctuation">;</span>
（<span class="token number">2</span>）头文件：
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/gpio/consumer.h&gt;</span></span>
（<span class="token number">3</span>）参数：
    desc：指向GPIO 描述符的指针。
（<span class="token number">4</span>）函数功能：
    gpiod_get_value 函数用于读取GPIO 的电平状态。
（<span class="token number">5</span>）返回值：
    返回值为整型，表示GPIO 的电平状态。
    如果成功读取到GPIO 的电平状态，返回值为<span class="token number">0</span> 或<span class="token number">1</span>，分别表示低电平和高电平。
    如果读取失败，返回值为负数，表示错误码。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该函数用于读取给定GPIO 描述符所代表的GPIO 的电平状态。通过调用该函数，可以获取GPIO 当前的电平状态，以便进一步处理和判断GPIO 的状态。</p>
<p><strong>4 设置GPIO 的电平状态函数：</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">（<span class="token number">1</span>）函数原型：
    <span class="token keyword">void</span> <span class="token function">gpiod_set_value</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gpio_desc</span> <span class="token operator">*</span>desc<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
（<span class="token number">2</span>）头文件：
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/gpio/consumer.h&gt;</span></span>
（<span class="token number">3</span>）参数：
    desc：指向GPIO 描述符的指针。
    value：要设置的GPIO 的电平状态，可以是<span class="token number">0</span> 或<span class="token number">1</span>。
（<span class="token number">4</span>）函数功能：
    gpiod_set_value 函数用于设置GPIO 的电平状态。
（<span class="token number">5</span>）返回值：无（<span class="token keyword">void</span>）
    该函数用于设置给定GPIO 描述符所代表的GPIO 的电平状态。通过调用该函数，您可以将GPIO设置为特定的电平状态，以便控制外部设备或执行其他相关操作。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>value 参数表示要设置的GPIO 的电平状态，可以是0 或1。当value 为0 时，表示设置GPIO 为低电平；当value 为1 时，表示设置GPIO 为高电平。<br>该函数没有返回值，因为它只是执行设置操作而不需要返回任何结果。</p>
<p>在使用该函数之前，需要确保GPIO 已经被正确地配置为输出模式。</p>
<p><strong>5 将GPIO 描述符转换为中断编号函数：</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">（<span class="token number">1</span>）函数原型：
    <span class="token keyword">int</span> <span class="token function">gpiod_to_irq</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">gpio_desc</span> <span class="token operator">*</span>desc<span class="token punctuation">)</span><span class="token punctuation">;</span>
（<span class="token number">2</span>）头文件：
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/gpio/consumer.h&gt;</span></span>
（<span class="token number">3</span>）参数：
    desc：指向GPIO 描述符的指针。
（<span class="token number">4</span>）函数功能：
    gpiod_to_irq 函数用于将GPIO 描述符转换为中断号。
（<span class="token number">5</span>）返回值：
    返回值为整型，表示中断号。
    如果成功将GPIO 描述符转换为中断号，返回值为大于等于<span class="token number">0</span> 的中断号。
    如果转换失败，返回值为负数，表示错误码。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该函数用于将给定GPIO 描述符所代表的GPIO 转换为对应的中断号。</p>
<h3 id="133-2-驱动程序的编写"><a href="#133-2-驱动程序的编写" class="headerlink" title="133.2 驱动程序的编写"></a>133.2 驱动程序的编写</h3><p>本实验对应的网盘路径为：<code>iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\87_gpioctrl06</code>。<br>编写完成的gpio_api.c 代码如下所示，添加的代码已加粗表示。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/platform_device.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mod_devicetable.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/gpio/consumer.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">gpio_desc</span> <span class="token operator">*</span>mygpio1<span class="token punctuation">;</span>  <span class="token comment">// GPIO 描述符指针</span>
<span class="token keyword">struct</span> <span class="token class-name">gpio_desc</span> <span class="token operator">*</span>mygpio2<span class="token punctuation">;</span>  <span class="token comment">// GPIO 描述符指针</span>
<span class="token keyword">int</span> num<span class="token punctuation">;</span>  <span class="token comment">// GPIO 编号</span>

<span class="token comment">//平台设备初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">my_platform_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"This is mydriver_probe\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    mygpio1 <span class="token operator">=</span> <span class="token function">gpiod_get_optional</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"my"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mygpio1 <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"gpiod_get_optional error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    num <span class="token operator">=</span> <span class="token function">desc_to_gpio</span><span class="token punctuation">(</span>mygpio1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"num is %d\n"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">gpiod_put</span><span class="token punctuation">(</span>mygpio1<span class="token punctuation">)</span><span class="token punctuation">;</span>

    mygpio2 <span class="token operator">=</span> <span class="token function">gpiod_get_index</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"my"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>mygpio2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"gpiod_get_index error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    num <span class="token operator">=</span> <span class="token function">desc_to_gpio</span><span class="token punctuation">(</span>mygpio2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"num is %d\n"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 平台设备的移除函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">my_platform_remove</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"my_platform_remove: Removing platform device\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 清理设备特定的操作</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> of_match_table_id<span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">{</span><span class="token punctuation">.</span>compatible<span class="token operator">=</span><span class="token string">"mygpio"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义平台驱动结构体</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">platform_driver</span> my_platform_driver <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>probe <span class="token operator">=</span> my_platform_probe<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>remove <span class="token operator">=</span> my_platform_remove<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>driver <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"my_platform_device"</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
		<span class="token punctuation">.</span>of_match_table <span class="token operator">=</span>  of_match_table_id<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 模块初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">my_platform_driver_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    <span class="token comment">// 注册平台驱动</span>
    ret <span class="token operator">=</span> <span class="token function">platform_driver_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_platform_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"Failed to register platform driver\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"my_platform_driver: Platform driver initialized\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 模块退出函数</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">my_platform_driver_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 注销平台驱动</span>
	<span class="token function">gpiod_put</span><span class="token punctuation">(</span>mygpio2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">platform_driver_unregister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_platform_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"my_platform_driver: Platform driver exited\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>my_platform_driver_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>my_platform_driver_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"topeet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="133-3-运行测试"><a href="#133-3-运行测试" class="headerlink" title="133.3 运行测试"></a>133.3 运行测试</h3><h4 id="133-3-1-编译驱动程序"><a href="#133-3-1-编译驱动程序" class="headerlink" title="133.3.1 编译驱动程序"></a>133.3.1 编译驱动程序</h4><p>对于Makefile 的内容注释已在上图添加，保存退出之后，来到存放gpio_api.c 和Makefile文件目录下，如下图（图133-1）所示：然后使用命令“make”进行驱动的编译，编译完生成gpio_api.ko 目标文件，至此驱动模块就编译成功了。</p>
<h4 id="133-3-2-运行测试"><a href="#133-3-2-运行测试" class="headerlink" title="133.3.2 运行测试"></a>133.3.2 运行测试</h4><p>首先需要确保当前开发板使用的内核镜像是我们在132.2 小节中修改设备树后编译生成的镜像，然后启动开发板，使用以下命令进行驱动的加载，如下图（图133-4）所示：</p>
<pre class="line-numbers language-none"><code class="language-none">insmod gpio_api.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409231403086.png" alt="image-20240923140343926"></p>
<p>在驱动程序中首先会将GPIO 的方向设置为输出，并且设置为了高电平，所以上面的第一个打印IO 口方向为输出，而由于已经设置为了高电平，所以第二个打印1 表示引脚为高电平，第三个打印的值为113，表示gpio 转换的中断号，然后使用以下命令进行驱动的卸载，如下图所示：</p>
<pre class="line-numbers language-none"><code class="language-none">rmmod gpio_api.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409231404580.png" alt="image-20240923140404426"></p>
<p>至此，GPIO 操作函数实验就完成了。</p>
<h2 id="第134-章三级节点操作函数实验"><a href="#第134-章三级节点操作函数实验" class="headerlink" title="第134 章三级节点操作函数实验"></a>第134 章三级节点操作函数实验</h2><p>在上一个章节中讲解了新版本GPIO 子系统中的GPIO 操作实验，而在进行操作之前首先要获取相应的gpio 描述，在前面的示例中获取的都是二级节点的GPIO 描述，那如果我们要如何获取下面led1 和led2 两个三级节点的gpio 描述呢？</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">my_gpio<span class="token operator">:</span>gpio1_a0 <span class="token punctuation">{</span>
    compatible <span class="token operator">=</span> <span class="token string">"mygpio"</span><span class="token punctuation">;</span>
    led1<span class="token punctuation">{</span>
        my<span class="token operator">-</span>gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio1 RK_PA0 GPIO_ACTIVE_HIGH<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio1 RK_PB1 GPIO_ACTIVE_HIGH<span class="token operator">&gt;</span><span class="token punctuation">;</span>
        pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>
        pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>mygpio_ctrl<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    led2<span class="token punctuation">{</span>
        my<span class="token operator">-</span>gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio1 RK_PB0 GPIO_ACTIVE_HIGH<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果仍旧使用gpiod_get 来获取gpio 描述会发现是获取不成功呢，获取三级节点的GPIO描述要使用什么函数呢，带着疑问，让我们进入本章节的学习吧。</p>
<h3 id="134-1-函数介绍"><a href="#134-1-函数介绍" class="headerlink" title="134.1 函数介绍"></a>134.1 函数介绍</h3><p><strong>1 计算子节点数量</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">函数原型
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">device_get_child_node_count</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
头文件
    <span class="token operator">&lt;</span>linux<span class="token operator">/</span>device<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>。
参数：
    <span class="token keyword">struct</span> <span class="token class-name">device</span> 类型的指针dev，表示要计算子节点数量的设备节点<span class="token punctuation">;</span>。
函数功能：
    用于计算给定设备节点dev 的子节点数量。
返回值：
    如果成功获取子节点数量，返回一个大于<span class="token number">0</span> 的无符号整数，表示设备节点的子节点数量。如果获取失败，返回值为<span class="token number">0</span>。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该函数的功能是通过给定设备节点dev 来计算其子节点的数量。它可以用于在设备驱动程序中了解设备节点的层级结构，以及设备节点下子节点的数量。</p>
<p><strong>2 获取指定节点的GPIO 结构描述</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">（<span class="token number">1</span>）函数原型：
    <span class="token keyword">struct</span> <span class="token class-name">gpio_desc</span> <span class="token operator">*</span><span class="token function">fwnode_get_named_gpiod</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">fwnode_handle</span> <span class="token operator">*</span>fwnode<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">,</span> 
                                             <span class="token keyword">int</span> index<span class="token punctuation">,</span> <span class="token keyword">enum</span> <span class="token class-name">gpiod_flags</span> dflags<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>label<span class="token punctuation">)</span><span class="token punctuation">;</span>
（<span class="token number">2</span>）头文件：
    <span class="token operator">&lt;</span>linux<span class="token operator">/</span>gpio<span class="token operator">/</span>consumer<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>。
（<span class="token number">3</span>）参数：
    fwnode：指向<span class="token keyword">struct</span> <span class="token class-name">fwnode_handle</span> 的指针，表示要获取GPIO 的节点对象地址。
    propname：属性名，指定要获取的GPIO 的属性名称。
    index：索引值，用于指定要获取的GPIO 在属性中的索引，用于GPIO 属性值包含多个GPIO 引脚描述时。
    dflags：获得到GPIO 后的初始化配置，可以使用以下枚举值：
        GPIOD_ASIS：不进行初始化。
        GPIOD_IN：初始化为输入模式。
        GPIOD_OUT_LOW：初始化为输出模式，输出低电平。
        GPIOD_OUT_HIGH：初始化为输出模式，输出高电平。
        label：标签，用于标识GPIO 的描述。
（<span class="token number">4</span>）函数功能：
    该函数通过指定节点的对象地址获取子节点中的GPIO 结构描述。
（<span class="token number">5</span>）返回值：
    返回一个指向<span class="token keyword">struct</span> <span class="token class-name">gpio_desc</span> 的指针，表示获取到的GPIO 结构描述。如果获取失败，返回值为<span class="token constant">NULL</span>。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该函数的功能是通过给定的节点对象地址fwnode，获取指定属性名propname 中的GPIO结构描述。可以通过index 参数指定在属性中的索引。获取到的GPIO 结构描述可以用于后续的GPIO 操作。函数还可以根据dflags 参数指定GPIO 的初始化配置，例如设置为输入或输出模式，并指定输出的默认电平。label 参数用于提供GPIO 的描述标签。函数返回获取到的GPIO结构描述指针，如果获取失败，则返回NULL。</p>
<p><strong>3 获取下一个子节点对象地址</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">函数原型：
    <span class="token keyword">struct</span> <span class="token class-name">fwnode_handle</span> <span class="token operator">*</span><span class="token function">device_get_next_child_node</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">fwnode_handle</span> <span class="token operator">*</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
头文件：
    <span class="token operator">&lt;</span>linux<span class="token operator">/</span>device<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>。
参数：
    dev：指向<span class="token keyword">struct</span> <span class="token class-name">device</span> 的指针，表示父设备节点。
    child：指向<span class="token keyword">struct</span> <span class="token class-name">fwnode_handle</span> 的指针，表示当前子设备节点。
函数功能：
    用于获取给定父设备节点dev 的下一个子设备节点。
返回值：
    返回一个指向<span class="token keyword">struct</span> <span class="token class-name">fwnode_handle</span> 的指针，表示下一个子设备节点。
    如果没有下一个子设备节点，返回值为<span class="token constant">NULL</span>。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该函数的功能是在给定的父设备节点dev 下获取当前子设备节点child 的下一个子设备节点。通过调用这个函数，可以遍历父设备节点的所有子设备节点。函数返回下一个子设备节点的struct fwnode_handle 指针，如果没有下一个子设备节点，则返回NULL。这个函数在设备驱动程序开发中常用于遍历设备树中的设备节点。</p>
<h3 id="134-2-设备树的修改"><a href="#134-2-设备树的修改" class="headerlink" title="134.2 设备树的修改"></a>134.2 设备树的修改</h3><p>本小节修改好的设备树以及编译好的boot.img 镜像存放路径为：<code>iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568 开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\88_gpioctrl07\01_内核镜像</code>。<br>由于本章节要获取到三级节点的GPIO 描述，所以要对<code>rk3568-evb1-ddr4-v10.dtsi</code> 设备树进行内容的修改，将根节点中的gpiol_a0 修改为以下内容：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">my_gpio<span class="token operator">:</span>gpio1_a0 <span class="token punctuation">{</span>
    compatible <span class="token operator">=</span> <span class="token string">"mygpio"</span><span class="token punctuation">;</span>
    led1<span class="token punctuation">{</span>
        my<span class="token operator">-</span>gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio1 RK_PA0 GPIO_ACTIVE_HIGH<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio1 RK_PB1 GPIO_ACTIVE_HIGH<span class="token operator">&gt;</span><span class="token punctuation">;</span>
        pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>
        pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>mygpio_ctrl<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    led2<span class="token punctuation">{</span>
        my<span class="token operator">-</span>gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio1 RK_PB0 GPIO_ACTIVE_HIGH<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>添加完成如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409231414693.png" alt="image-20240923141449523"></p>
<p>至此，关于设备树相关的修改就完成了，保存退出之后，编译内核，然后将生成的boot.img镜像烧写到开发板上即可。</p>
<h3 id="134-3-驱动程序的编写"><a href="#134-3-驱动程序的编写" class="headerlink" title="134.3 驱动程序的编写"></a>134.3 驱动程序的编写</h3><p>本实验对应的网盘路径为：<code>iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\88_gpioctrl07\02_module</code>。<br>编写完成的gpio_api.c 代码如下所示:</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/platform_device.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mod_devicetable.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/gpio/consumer.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/gpio.h&gt;</span></span>

<span class="token keyword">unsigned</span> <span class="token keyword">int</span> count<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">fwnode_handle</span> <span class="token operator">*</span>child_fw <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">gpio_desc</span> <span class="token operator">*</span>led<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">// 平台设备初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">my_platform_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"This is my_platform_probe\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 获取父设备节点的子设备节点数量</span>
    count <span class="token operator">=</span> <span class="token function">device_get_child_node_count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"count is %d\n"</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取下一个子设备节点</span>
        child_fw <span class="token operator">=</span> <span class="token function">device_get_next_child_node</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> child_fw<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>child_fw<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 获取子设备节点中名为 "my-gpios" 的 GPIO 描述</span>
            led<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">fwnode_get_named_gpiod</span><span class="token punctuation">(</span>child_fw<span class="token punctuation">,</span> <span class="token string">"my-gpios"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"LED"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// 将 GPIO 描述转换为 GPIO 号</span>
        num <span class="token operator">=</span> <span class="token function">desc_to_gpio</span><span class="token punctuation">(</span>led<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"num is %d\n"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 平台设备的移除函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">my_platform_remove</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"my_platform_remove: Removing platform device\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 清理设备特定的操作</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> of_match_table_id<span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">{</span><span class="token punctuation">.</span>compatible<span class="token operator">=</span><span class="token string">"mygpio"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义平台驱动结构体</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">platform_driver</span> my_platform_driver <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>probe <span class="token operator">=</span> my_platform_probe<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>remove <span class="token operator">=</span> my_platform_remove<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>driver <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"my_platform_device"</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
		<span class="token punctuation">.</span>of_match_table <span class="token operator">=</span>  of_match_table_id<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 模块初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">my_platform_driver_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    <span class="token comment">// 注册平台驱动</span>
    ret <span class="token operator">=</span> <span class="token function">platform_driver_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_platform_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"Failed to register platform driver\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"my_platform_driver: Platform driver initialized\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 模块退出函数</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">my_platform_driver_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 注销平台驱动</span>
    <span class="token function">platform_driver_unregister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_platform_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"my_platform_driver: Platform driver exited\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>my_platform_driver_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>my_platform_driver_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"topeet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="134-4-运行测试"><a href="#134-4-运行测试" class="headerlink" title="134.4 运行测试"></a>134.4 运行测试</h3><h4 id="134-4-1-编译驱动程序"><a href="#134-4-1-编译驱动程序" class="headerlink" title="134.4.1 编译驱动程序"></a>134.4.1 编译驱动程序</h4><p>在上一小节中的gpio_api.c 代码同一目录下创建Makefile 文件，Makefile 文件内容如下所示：然后使用命令“make”进行驱动的编译，编译完生成gpio_api.ko 目标文件，至此驱动模块就编译成功了。</p>
<h4 id="134-4-2-运行测试"><a href="#134-4-2-运行测试" class="headerlink" title="134.4.2 运行测试"></a>134.4.2 运行测试</h4><p>首先需要确保当前开发板使用的内核镜像是我们在134.2 小节中修改设备树后编译生成的镜像，然后启动开发板，使用以下命令进行驱动的加载，如下图（图134-5）所示：</p>
<pre class="line-numbers language-none"><code class="language-none">insmod gpio_api.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409231420319.png" alt="image-20240923142051160"></p>
<p>首先打印出了子节点的数量为2，也就是led1 和led2，接下来的两个num 值分别为32 和40，分别对应两个节点的第一个GPIO 属性的引脚编号，前面也学习过了换算相关的知识，gpio1RK_PA0 和gpio1 RK_PB0 分贝对应32 和40，匹配正确，然后使用以下命令进行驱动的卸载，<br>如下图所示：</p>
<pre class="line-numbers language-none"><code class="language-none">rmmod gpio_api.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409231421976.png" alt="image-20240923142112814"></p>
<p>至此，三级节点操作函数实验就完成了。</p>
<h2 id="第135-章GPIO-子系统与pinctrl-子系统相结合实验"><a href="#第135-章GPIO-子系统与pinctrl-子系统相结合实验" class="headerlink" title="第135 章GPIO 子系统与pinctrl 子系统相结合实验"></a>第135 章GPIO 子系统与pinctrl 子系统相结合实验</h2><p>在上一章中我们讲解了三级节点的操作函数，关于新版本的GPIO 子系统接口api 函数的讲解就完成了，而为了加深大家的认知，在本章节将进行GPIO 子系统与pinctrl 子系统相结合的实验，实验的设备树示例如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">my_gpio<span class="token operator">:</span>gpio1_a0 <span class="token punctuation">{</span>
    compatible <span class="token operator">=</span> <span class="token string">"mygpio"</span><span class="token punctuation">;</span>
    my<span class="token operator">-</span>gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio1 RK_PA0 GPIO_ACTIVE_HIGH<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"myled1"</span><span class="token punctuation">;</span>
    pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>mygpio_ctrl<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在第四行中的pinctrl-names 参数并不是default，这就需要用到我们前面pinctrl 子系统中的知识来查找并设置相应的pinctrl 状态了，所以再第一节中我们将会重新学习一下pinctrl 的一些相关函数。</p>
<h3 id="135-1-函数介绍"><a href="#135-1-函数介绍" class="headerlink" title="135.1 函数介绍"></a>135.1 函数介绍</h3><p><strong>（1）获取设备对应的pinctrl 结构体指针函数</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">函数原型：
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl</span><span class="token operator">*</span> <span class="token function">pinctrl_get</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
头文件：
    <span class="token operator">&lt;</span>linux<span class="token operator">/</span>pinctrl<span class="token operator">/</span>pinctrl<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>。
参数：
    函数接受一个指向<span class="token keyword">struct</span> <span class="token class-name">device</span> 的指针dev，表示设备对象。
函数功能：
    用于获取与给定设备对象dev 相关联的pinctrl（引脚控制器）实例。
返回值：
    返回一个指向<span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> 的指针，表示获取到的pinctrl 实例。
    如果获取失败或者设备对象不支持pinctrl，则返回<span class="token constant">NULL</span>。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该函数的功能是根据给定的设备对象dev 获取与其相关联的pinctrl 实例。pinctrl 是Linux内核中用于管理和控制引脚的框架。通过调用该函数，可以获得设备对象所使用的pinctrl 实例，以便进行引脚配置和控制操作。</p>
<p><strong>（2）释放pinctrl 指针函数</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">函数原型：
    <span class="token keyword">void</span> <span class="token function">pinctrl_put</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
头文件：
    <span class="token operator">&lt;</span>linux<span class="token operator">/</span>pinctrl<span class="token operator">/</span>pinctrl<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>。
参数：
    函数接受一个指向<span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> 的指针p，表示要释放的pinctrl 实例。
函数功能：
    该函数用于释放由<span class="token function">pinctrl_get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 函数获得的pinctrl 实例，以释放相关资源。
返回值：
    无返回值。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该函数的功能是释放由pinctrl_get() 函数获得的pinctrl 实例，以释放相关资源。在使用完pinctrl 实例后，调用该函数可以确保正确释放相关资源，避免内存泄漏。</p>
<p><strong>（3）查找pinctrl 状态函数</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">函数原型：
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_state</span> <span class="token operator">*</span><span class="token function">pinctrl_lookup_state</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
头文件：
    <span class="token operator">&lt;</span>linux<span class="token operator">/</span>pinctrl<span class="token operator">/</span>pinctrl<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>。
参数：
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token operator">*</span>p：指向pinctrl 实例的指针，表示要进行状态查找的pinctrl。
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name：指向状态名称的字符串指针，表示要查找的状态名称。
函数功能：
    用于在给定的pinctrl 实例中查找指定名称的pinctrl 状态。
返回值：
    函数返回一个指向<span class="token keyword">struct</span> <span class="token class-name">pinctrl_state</span> 的指针，表示找到的pinctrl 状态。如果未找到或发生错误，则返回<span class="token constant">NULL</span>。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该函数的功能是在给定的pinctrl 实例p 中查找指定名称的pinctrl 状态。pinctrl 状态是与引脚相关的配置和控制状态，例如引脚模式、电气属性等。</p>
<p><strong>（4）设置pinctrl 状态到硬件</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">函数原型：
    <span class="token keyword">int</span> <span class="token function">pinctrl_select_state</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl_state</span> <span class="token operator">*</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
头文件：
    <span class="token operator">&lt;</span>linux<span class="token operator">/</span>pinctrl<span class="token operator">/</span>pinctrl<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>。
参数：
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token operator">*</span>p：指向pinctrl 实例的指针，表示要进行状态设置的pinctrl。
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_state</span> <span class="token operator">*</span>s：指向pinctrl 状态的指针，表示要设置的目标状态。
函数功能：
    用于将指定的pinctrl 状态设置到硬件上。
返回值：
    返回一个整数值，表示操作的结果。如果设置成功，则返回<span class="token number">0</span>；否则返回负数错误码。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该函数的功能是将指定的pinctrl 状态s 设置到硬件上。pinctrl 状态是与引脚相关的配置和控制状态，例如引脚模式、电气属性等。</p>
<h3 id="135-2-设备树的修改"><a href="#135-2-设备树的修改" class="headerlink" title="135.2 设备树的修改"></a>135.2 设备树的修改</h3><p>本小节修改好的设备树以及编译好的boot.img 镜像存放路径为：<code>iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568 开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\88_gpioctrl07\01_内核镜像</code>。</p>
<p>由于本章节要使用上pinctrl 子系统相关的接口来查找并设置相应的pinctrl 状态，所以要对<code>rk3568-evb1-ddr4-v10.dtsi</code> 设备树进行内容的修改，将根节点中的gpiol_a0 修改为以下内容：</p>
<pre class="line-numbers language-none"><code class="language-none">my_gpio:gpio1_a0 {
    compatible = "mygpio";
    my-gpios = &lt;&amp;gpio1 RK_PA0 GPIO_ACTIVE_HIGH&gt;;
    pinctrl-names = "myled1";
    pinctrl-0 = &lt;&amp;mygpio_ctrl&gt;;
};<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>添加完成如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409231433348.png" alt="image-20240923143314182"></p>
<p>至此，关于设备树相关的修改就完成了，保存退出之后，编译内核，然后将生成的boot.img镜像烧写到开发板上即可。</p>
<h3 id="135-3-驱动程序的编写"><a href="#135-3-驱动程序的编写" class="headerlink" title="135.3 驱动程序的编写"></a>135.3 驱动程序的编写</h3><p>本实验对应的网盘路径为：<code>iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\89_gpioctrl07\02_module</code>。<br>编写完成的gpio_api.c 代码如下所示:</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/platform_device.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mod_devicetable.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/gpio/consumer.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/gpio.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token operator">*</span>led_pinctrl<span class="token punctuation">;</span> <span class="token comment">// pinctrl 实例指针</span>
<span class="token keyword">struct</span> <span class="token class-name">pinctrl_state</span> <span class="token operator">*</span>led_state<span class="token punctuation">;</span><span class="token comment">// pinctrl 状态指针</span>
<span class="token keyword">int</span> ret<span class="token punctuation">;</span>
<span class="token comment">//平台设备初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">my_platform_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"This is mydriver_probe\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    led_pinctrl <span class="token operator">=</span> <span class="token function">pinctrl_get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 获取 pinctrl 实例</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>led_pinctrl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"pinctrl_get is error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    led_state <span class="token operator">=</span> <span class="token function">pinctrl_lookup_state</span><span class="token punctuation">(</span>led_pinctrl<span class="token punctuation">,</span> <span class="token string">"myled1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 查找状态</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>led_state<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"pinctrl_lookup_state is error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    ret <span class="token operator">=</span> <span class="token function">pinctrl_select_state</span><span class="token punctuation">(</span>led_pinctrl<span class="token punctuation">,</span> led_state<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 设置状态到硬件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"pinctrl_select_state is error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 平台设备的移除函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">my_platform_remove</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"my_platform_remove: Removing platform device\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 清理设备特定的操作</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> of_match_table_id<span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">{</span><span class="token punctuation">.</span>compatible<span class="token operator">=</span><span class="token string">"mygpio"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义平台驱动结构体</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">platform_driver</span> my_platform_driver <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>probe <span class="token operator">=</span> my_platform_probe<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>remove <span class="token operator">=</span> my_platform_remove<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>driver <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"my_platform_device"</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
		<span class="token punctuation">.</span>of_match_table <span class="token operator">=</span>  of_match_table_id<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 模块初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">my_platform_driver_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    <span class="token comment">// 注册平台驱动</span>
    ret <span class="token operator">=</span> <span class="token function">platform_driver_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_platform_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"Failed to register platform driver\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"my_platform_driver: Platform driver initialized\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 模块退出函数</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">my_platform_driver_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 注销平台驱动</span>
    <span class="token function">platform_driver_unregister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_platform_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"my_platform_driver: Platform driver exited\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>my_platform_driver_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>my_platform_driver_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"topeet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="135-4-运行测试"><a href="#135-4-运行测试" class="headerlink" title="135.4 运行测试"></a>135.4 运行测试</h3><h4 id="135-4-1-编译驱动程序"><a href="#135-4-1-编译驱动程序" class="headerlink" title="135.4.1 编译驱动程序"></a>135.4.1 编译驱动程序</h4><p>在上一小节中的gpio_api.c 代码同一目录下创建Makefile 文件，Makefile 文件内容如下所示：然后使用命令“make”进行驱动的编译，编译完生成gpio_api.ko 目标文件，至此驱动模块就编译成功了。</p>
<h4 id="135-4-2-运行测试"><a href="#135-4-2-运行测试" class="headerlink" title="135.4.2 运行测试"></a>135.4.2 运行测试</h4><p>首先需要确保当前开发板使用的内核镜像是我们在135.2 小节中修改设备树后编译生成的镜像，然后启动开发板，首先使用以下命令查看gpio1 RK_PA0 引脚的复用功能，如下图所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> /sys/kernel/debug/pinctrl/pinctrl-rockchip-pinctrl/pinmux-pins <span class="token operator">|</span> <span class="token function">grep</span> <span class="token number">32</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409231435259.png" alt="image-20240923143529085"></p>
<p>可以看到在没有加载驱动之前，gpio1 RK_PA0 引脚是没有进行复用的，然后使用以下命令进行驱动的加载，如下图（图135-6）所示：</p>
<pre class="line-numbers language-none"><code class="language-none">insmod gpio_api.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409231435698.png" alt="image-20240923143547535"></p>
<p>然后重新使用使用以下命令查看<code>gpio1 RK_PA0</code> 引脚的复用功能，如下图所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> /sys/kernel/debug/pinctrl/pinctrl-rockchip-pinctrl/pinmux-pins <span class="token operator">|</span> <span class="token function">grep</span> <span class="token number">32</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409231436087.png" alt="image-20240923143616909"></p>
<p>根据打印信息可以得到gpio1 RK_PA0 已经被设置为了GPIO 功能，功能和引脚组正是我们在pinctrl 节点中添加的信息，证明已经成功使用了添加的pinctrl-names 状态，然后使用以下命令进行驱动的卸载，如下图所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">rmmod gpio_api.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409231436134.png" alt="image-20240923143640964"></p>
<p>至此，GPIO 子系统与pinctrl 子系统相结合实验实验就完成了。</p>
<h2 id="第136-章实战-实现动态切换引脚复用功能"><a href="#第136-章实战-实现动态切换引脚复用功能" class="headerlink" title="第136 章实战:实现动态切换引脚复用功能"></a>第136 章实战:实现动态切换引脚复用功能</h2><p>再上一个小节中完成了GPIO 子系统与pinctrl 子系统相结合实验，在本章节中将更进一步，实现引脚动态切换引脚复用功能。</p>
<p>这里仍旧使用RK3568 底板背面的20 pin GPIO 底座的1 号管脚来完成本章节要进行的动态切换引脚复用的功能，该引脚的核心板原理图内容如下所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409231437114.png" alt="image-20240923143708910"></p>
<p>左侧为该引脚的一些其他复用功能，在前面的章节中复用的都是GPIO 功能，而本章节中将实现I2C3_SDA 和GPIO 两个复用功能的动态切换。</p>
<h3 id="136-1-设备树的修改"><a href="#136-1-设备树的修改" class="headerlink" title="136.1 设备树的修改"></a>136.1 设备树的修改</h3><p>本小节修改好的设备树以及编译好的boot.img 镜像存放路径为：<code>iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568 开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\90_gpioctrl09\01_内核镜像</code>。<br>首先根据上图中的复用功能查看设备树中是否已经对该引脚进行了复用，在确保该引脚无任何复用之后，<code>rk3568-evb1-ddr4-v10.dtsi</code> 设备树进行内容的添加，将根节点中的<code>gpiol_a0</code> 修改为以下内容：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">my_gpio<span class="token operator">:</span>gpio1_a0 <span class="token punctuation">{</span>
    compatible <span class="token operator">=</span> <span class="token string">"mygpio"</span><span class="token punctuation">;</span>
    my<span class="token operator">-</span>gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio1 RK_PA0 GPIO_ACTIVE_HIGH<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"mygpio_func1"</span><span class="token punctuation">,</span> <span class="token string">"mygpio_func2"</span><span class="token punctuation">;</span>
    pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>mygpio_ctrl<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    pinctrl<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>i2c3_sda<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>pinctrl-names 表示引脚控制器配置的名称，这里有两个值，分别对应复用1 和复用2。<br>pinctrl-0 指定了与该配置相关联的引脚控制器句柄，这里为&amp;mygpio_ctrl，表示复用为gpio功能。</p>
<p>pinctrl-1 指定了与该配置相关联的引脚控制器句柄，这里为&amp;i2c3_sda，表示复用为i2c3_sda 功能。</p>
<p>添加完成如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409231438278.png" alt="image-20240923143832105"></p>
<p>然后找到pinctrl 节点，在节点尾部进行修改和添加，具体内容如下所示：</p>
<pre class="line-numbers language-none"><code class="language-none">mygpio_func1 {
    mygpio_ctrl: my-gpio-ctrl {
        rockchip,pins = &lt;1 RK_PA0 RK_FUNC_GPIO &amp;pcfg_pull_none&gt;;
    };
};
mygpio_func2 {
    i2c3_sda: i2c3_sda {
        rockchip,pins = &lt;1 RK_PA0 1 &amp;pcfg_pull_none&gt;;
    };
};<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>修改添加完成如下图所示：</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409231440329.png" alt="image-20240923144003152"></p>
<p>至此，关于设备树相关的修改就完成了，保存退出之后，编译内核，然后将生成的boot.img镜像烧写到开发板上即可。</p>
<h3 id="136-2-驱动程序的编写"><a href="#136-2-驱动程序的编写" class="headerlink" title="136.2 驱动程序的编写"></a>136.2 驱动程序的编写</h3><p>本实验对应的网盘路径为：<code>iTOP-RK3568 开发板【底板V1.7 版本】\03_【iTOP-RK3568开发板】指南教程\02_Linux 驱动配套资料\04_Linux 驱动例程\90_gpioctrl09\02_module</code>。<br>编写完成的gpio_api.c 代码如下所示:</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/platform_device.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mod_devicetable.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/gpio/consumer.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/gpio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/device.h&gt;</span></span>
<span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token operator">*</span>gpio_pinctrl<span class="token punctuation">;</span>          <span class="token comment">// GPIO pinctrl 实例指针</span>
<span class="token keyword">struct</span> <span class="token class-name">pinctrl_state</span> <span class="token operator">*</span>func1_state<span class="token punctuation">;</span>     <span class="token comment">// 功能1状态</span>
<span class="token keyword">struct</span> <span class="token class-name">pinctrl_state</span> <span class="token operator">*</span>func2_state<span class="token punctuation">;</span>     <span class="token comment">// 功能2状态</span>
<span class="token keyword">int</span> ret<span class="token punctuation">;</span>

<span class="token class-name">ssize_t</span> <span class="token function">selectmux_store</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">device_attribute</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> select<span class="token punctuation">;</span>
    select <span class="token operator">=</span> <span class="token function">simple_strtoul</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>select <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pinctrl_select_state</span><span class="token punctuation">(</span>gpio_pinctrl<span class="token punctuation">,</span> func1_state<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 选择功能1状态</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>select <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pinctrl_select_state</span><span class="token punctuation">(</span>gpio_pinctrl<span class="token punctuation">,</span> func2_state<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 选择功能2状态</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">DEVICE_ATTR_WO</span><span class="token punctuation">(</span>selectmux<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 定义可写的设备属性 selectmux</span>

<span class="token keyword">int</span> <span class="token function">pinctrl_get_and_lookstate</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    gpio_pinctrl <span class="token operator">=</span> <span class="token function">pinctrl_get</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 获取GPIO pinctrl实例</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>gpio_pinctrl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"pinctrl_get is error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    func1_state <span class="token operator">=</span> <span class="token function">pinctrl_lookup_state</span><span class="token punctuation">(</span>gpio_pinctrl<span class="token punctuation">,</span> <span class="token string">"mygpio_func1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 查找功能1状态</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>func1_state<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"pinctrl_lookup_state is error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    func2_state <span class="token operator">=</span> <span class="token function">pinctrl_lookup_state</span><span class="token punctuation">(</span>gpio_pinctrl<span class="token punctuation">,</span> <span class="token string">"mygpio_func2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 查找功能2状态</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>func2_state<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"pinctrl_lookup_state is error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 平台设备初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">my_platform_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"This is mydriver_probe\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pinctrl_get_and_lookstate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 获取并查找GPIO pinctrl实例和状态</span>
    <span class="token function">device_create_file</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dev_attr_selectmux<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 在设备上创建属性文件</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 平台设备的移除函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">my_platform_remove</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"my_platform_remove: Removing platform device\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 清理设备特定的操作</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> of_match_table_id<span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">{</span><span class="token punctuation">.</span>compatible<span class="token operator">=</span><span class="token string">"mygpio"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义平台驱动结构体</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">platform_driver</span> my_platform_driver <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>probe <span class="token operator">=</span> my_platform_probe<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>remove <span class="token operator">=</span> my_platform_remove<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>driver <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"my_platform_device"</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
		<span class="token punctuation">.</span>of_match_table <span class="token operator">=</span>  of_match_table_id<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 模块初始化函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">my_platform_driver_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    <span class="token comment">// 注册平台驱动</span>
    ret <span class="token operator">=</span> <span class="token function">platform_driver_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_platform_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"Failed to register platform driver\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"my_platform_driver: Platform driver initialized\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 模块退出函数</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">my_platform_driver_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 注销平台驱动</span>
    <span class="token function">platform_driver_unregister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_platform_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"my_platform_driver: Platform driver exited\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>my_platform_driver_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>my_platform_driver_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"topeet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="136-3-运行测试"><a href="#136-3-运行测试" class="headerlink" title="136.3 运行测试"></a>136.3 运行测试</h3><h4 id="136-3-1-编译驱动程序"><a href="#136-3-1-编译驱动程序" class="headerlink" title="136.3.1 编译驱动程序"></a>136.3.1 编译驱动程序</h4><p>在上一小节中的gpio_api.c 代码同一目录下创建Makefile 文件，Makefile 文件内容如下所示：然后使用命令“make”进行驱动的编译，编译完生成gpio_api.ko 目标文件，至此驱动模块就编译成功了。</p>
<h4 id="136-3-2-运行测试"><a href="#136-3-2-运行测试" class="headerlink" title="136.3.2 运行测试"></a>136.3.2 运行测试</h4><p>首先需要确保当前开发板使用的内核镜像是我们在135.2 小节中修改设备树后编译生成的镜像，然后启动开发板，首先使用以下命令查看gpio1 RK_PA0 引脚的复用功能，如下图所示：</p>
<pre class="line-numbers language-none"><code class="language-none">cat /sys/kernel/debug/pinctrl/pinctrl-rockchip-pinctrl/pinmux-pins | grep 32<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409231444241.png" alt="image-20240923144451054"></p>
<p>可以看到在没有加载驱动之前，gpio1 RK_PA0 引脚是没有进行复用的，然后使用以下命令进行驱动的加载，如下图（图54-5）所示：</p>
<pre class="line-numbers language-none"><code class="language-none">insmod gpio_api.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409231445847.png" alt="image-20240923144509674"></p>
<p>然后使用以下命令进入/sys/devices/platform/gpio1_a0/目录，其中的selectmux 文件就是用来动态修改服用关系的，如下图所示：</p>
<pre class="line-numbers language-none"><code class="language-none">cd /sys/devices/platform/gpio1_a0/<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409231445894.png" alt="image-20240923144540706"></p>
<p>当向selectmux 文件写入0 时表示选择功能2，也就是将该引脚复用为I2C3_SDA，当向selectmux 文件写入1 时表示选择功能1，也就是将该引脚复用为GPIO，这里我们先输入以下命令向selectmux 文件写入1，验证GPIO 的复用</p>
<pre class="line-numbers language-none"><code class="language-none">echo 1 &gt; selectmux<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409231446112.png" alt="image-20240923144615934"></p>
<p>然后重新使用使用以下命令查看gpio1 RK_PA0 引脚的复用功能，如下图所示：</p>
<pre class="line-numbers language-none"><code class="language-none">cat /sys/kernel/debug/pinctrl/pinctrl-rockchip-pinctrl/pinmux-pins | grep 32<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409231446689.png" alt="image-20240923144630499"></p>
<p>根据打印信息可以得到gpio1 RK_PA0 已经被设置为了GPIO 功能，然后输入以下命令向selectmux 文件写入0，验证I2C3_SDA 的复用</p>
<pre class="line-numbers language-none"><code class="language-none">echo 0 &gt; selectmux<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409231446758.png" alt="image-20240923144659578"></p>
<p>然后重新使用使用以下命令查看gpio1 RK_PA0 引脚的复用功能，如下图所示：</p>
<pre class="line-numbers language-none"><code class="language-none">cat /sys/kernel/debug/pinctrl/pinctrl-rockchip-pinctrl/pinmux-pins | grep 32<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409231447180.png" alt="image-20240923144717985"></p>
<p>根据打印信息可以得到gpio1 RK_PA0 已经被复用为了I2C3_SDA 功能，最后使用以下命令进行驱动的卸载，如下图所示：</p>
<pre class="line-numbers language-none"><code class="language-none">rmmod gpio_api.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202409231447518.png" alt="image-20240923144735343"></p>
<p>至此，实现动态切换引脚复用功能实战就完成了。</p>
<h1 id="第十三篇输入子系统"><a href="#第十三篇输入子系统" class="headerlink" title="第十三篇输入子系统"></a>第十三篇输入子系统</h1>
                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">葛杨文</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://gitee.com/ge-yangwen/geyangwen.gitee.io/2024/082158785.html">https://gitee.com/ge-yangwen/geyangwen.gitee.io/2024/082158785.html</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">葛杨文</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Android%E9%A9%B1%E5%8A%A8/">
                                    <span class="chip bg-color">Android驱动</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="./images/loading.gif" data-original="https://blog-accelerated.oss-cn-hangzhou.aliyuncs.com/source/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="./images/loading.gif" data-original="https://blog-accelerated.oss-cn-hangzhou.aliyuncs.com/source/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: '2GHAwHTGn8XLUAd7QB3o7e4c-gzGzoHsz',
        appKey: '4EmLXaoemlw5MQWjAC60IbU8',
        notify: '' === 'true',
        verify: '' === 'true',
        visitor: '' === 'true',
        avatar: 'monsterid',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '昵称填写qq可以显示qq头像和昵称哦~'
    });
</script>

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2024/09249568.html">
                    <div class="card-image">
                        
                        
                        <img src="./images/loading.gif" data-original="https://blog-accelerated.oss-cn-hangzhou.aliyuncs.com/source/medias/featureimages/13.jpg" class="responsive-img" alt="Android驱动的系统笔记3">
                        
                        <span class="card-title">Android驱动的系统笔记3</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2024-09-24
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Android/" class="post-category">
                                    Android
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android%E9%A9%B1%E5%8A%A8/">
                        <span class="chip bg-color">Android驱动</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2024/080957409.html">
                    <div class="card-image">
                        
                        
                        <img src="./images/loading.gif" data-original="https://blog-accelerated.oss-cn-hangzhou.aliyuncs.com/source/medias/featureimages/11.jpg" class="responsive-img" alt="Android驱动的系统笔记1">
                        
                        <span class="card-title">Android驱动的系统笔记1</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2024-08-09
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Android/" class="post-category">
                                    Android
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android%E9%A9%B1%E5%8A%A8/">
                        <span class="chip bg-color">Android驱动</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h1,h2, h3, h4,h5'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1,h2, h3, h4,h5').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2022-2024</span>
            
            <span id="year">2022</span>
            <a href="/about" target="_blank">葛杨文</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">696.5k</span>&nbsp;字
            
            
            
            
            
            <!-- 修改不蒜子初始化计数 -->
                  
                <span id="busuanzi_container_site_pv" style='display:none'></span>
                    <i class="fa fa-heart-o"></i>
                    本站总访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>
            
            
            
            
                <span id="busuanzi_container_site_uv" style='display:none'></span>
                    人次,&nbsp;访客数 <span id="busuanzi_value_site_uv" class="white-color"></span> 人.
                
                                    
            <br>
            <!-- 增加建站时间（下面这句话） -->
            <span id="sitetime"></span>

            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/Geyangwen" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:3057318483@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=3057318483" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 3057318483" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







</div>
    </div>
</footer>

<div class="progress-bar"></div>

<!-- 增加建站时间 -->
<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */
        var t1 = Date.UTC(2022, 10, 25, 00, 00, 00); //北京时间2018-2-13 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "小破站已运行 " +diffYears+" 年 "+diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
    }/*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
</script>

<!-- 修改不蒜子初始化计数 -->
<script>
    $(document).ready(function () {

        var int = setInterval(fixCount, 50);  // 50ms周期检测函数
        var pvcountOffset = 80000;  // 初始化首次数据
        var uvcountOffset = 20000;

        function fixCount() {
            if (document.getElementById("busuanzi_container_site_pv").style.display != "none") {
                $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + pvcountOffset);
                clearInterval(int);
            }
            if ($("#busuanzi_container_site_pv").css("display") != "none") {
                $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + uvcountOffset); // 加上初始数据 
                clearInterval(int); // 停止检测
            }
        }
    });
</script>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    
        <!-- 添加死鬼你来了的小顽皮 -->
    <script type="text/javascript">
        var OriginTitile = document.title,
            st;
        document.addEventListener("visibilitychange", function () {
            document.hidden ? (document.title = "客官别走呀！", clearTimeout(st)) : (document.title =
                "(๑•̀ㅂ•́)死鬼你来了", st = setTimeout(function () {
                    document.title = OriginTitile
                }, 3e3))
        })
    </script>
    <!-- 樱花特效 -->
    <!-- <script type="text/javascript">
        //只在桌面版网页启用特效
        var windowWidth = $(window).width();
        if (windowWidth > 768) {
            document.write('<script type="text/javascript" src="/js/sakura.js"><\/script>');
        }
    </script> -->
    

    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="/libs/background/canvas-nest.js"></script>
    

    

    
    <script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async="async"></script>
    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/miku.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script>
        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(r){r.imageLazyLoadSetting.processImages=t;var e=r.imageLazyLoadSetting.isSPA,c=(r.imageLazyLoadSetting.preloadRatio,n());function n(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(){e&&(c=n());for(var t,o=0;o<c.length;o++)0<=(t=(t=c[o]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(r.innerHeight+240||document.documentElement.clientHeight+240)&&function(){var t,e,n,a,i=c[o];e=function(){c=c.filter(function(t){return i!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(i)},(t=i).hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(n=new Image,a=t.getAttribute("data-original"),n.onload=function(){t.src=a,t.removeAttribute("data-original"),e&&e()},t.src!==a&&(n.src=a))}()}function a(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",a),r.addEventListener("resize",a),r.addEventListener("orientationchange",a)}(this);</script></body>

</html>
