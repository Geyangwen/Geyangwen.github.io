<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="标签: Android, 小文同学">
    <meta name="description" content="你的征途是星辰大海，怎么能被眼前的挫折打败。">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>标签: Android | 小文同学</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="小文同学" type="application/atom+xml">
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="./images/loading.gif" data-original="https://blog-accelerated.oss-cn-hangzhou.aliyuncs.com/source/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">小文同学</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">

      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a target="_blank" rel="noopener" href="https://www.kugou.com/">
          
          <i class="fas fa-music" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>酷狗音乐</span>
        </a>
      </li>
      
      <li>
        <a target="_blank" rel="noopener" href="https://search.bilibili.com/">
          
          <i class="fas fa-film" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>哔哩哔哩</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="./images/loading.gif" data-original="https://blog-accelerated.oss-cn-hangzhou.aliyuncs.com/source/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">小文同学</div>
        <div class="logo-desc">
            
            你的征途是星辰大海，怎么能被眼前的挫折打败。
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-address-book"></i>
			
			友情链接
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a target="_blank" rel="noopener" href="https://www.kugou.com/ " style="margin-left:75px">
				  
				   <i class="fa fas fa-music" style="position: absolute;left:50px" ></i>
			      
		          <span>酷狗音乐</span>
                  </a>
                </li>
              
                <li>

                  <a target="_blank" rel="noopener" href="https://search.bilibili.com/ " style="margin-left:75px">
				  
				   <i class="fa fas fa-film" style="position: absolute;left:50px" ></i>
			      
		          <span>哔哩哔哩</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/Geyangwen/Geyangwen.github.io" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/Geyangwen/Geyangwen.github.io" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('https://blog-accelerated.oss-cn-hangzhou.aliyuncs.com/source/medias/featureimages/19.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Android驱动基础知识</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android%E9%A9%B1%E5%8A%A8/">
                                <span class="chip bg-color">Android驱动</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Android/" class="post-category">
                                Android
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2024-07-15
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    44.2k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    185 分
                </div>
                

                
                    <span id="busuanzi_container_site_pv" style='display:none'></span>
                    <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                    <span id="busuanzi_value_page_pv" ></span>
            
            
            
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <blockquote>
<p>注意：本网站所有内容为自己学习期间记录的笔记，很多都是原作者那边摘抄过来的，不作商业用途也不插播广告。（如有侵权，请联系我删除，15909440083）</p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/afb9c46a5154">作者：Gao秋</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_33462950/article/details/108547111">Gyang</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_49851451/article/details/123944431">git常用命令，作者：少糖加水</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Br42187n3/?p=25&amp;share_source=copy_web&amp;vd_source=ea594901aecf92a5e624ffc8cdbd1ca1">【2024最新Linux驱动开发教程】 </a></p>
</blockquote>
<h1 id="一、Android驱动开发基础知识"><a href="#一、Android驱动开发基础知识" class="headerlink" title="一、Android驱动开发基础知识"></a>一、Android驱动开发基础知识</h1><h2 id="1-adb-常用好用的几个命令"><a href="#1-adb-常用好用的几个命令" class="headerlink" title="1. adb 常用好用的几个命令"></a>1. adb 常用好用的几个命令</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">1</span>、adb devices						 <span class="token comment"># (----比较常用----)查看设备列表0000</span>
查看电脑已连接Android 设备列表，多行显示表示连接多个Android设备，每行前面的字符串表示Android设备的SN号

<span class="token number">2</span>、adb  get-state 					 <span class="token comment"># 获取连接状态 device offline unkown</span>

<span class="token number">3</span>、adb <span class="token function">install</span> <span class="token parameter variable">-r</span> APK路径 			<span class="token comment">#  安装应用(----比较常用----)</span>
<span class="token comment"># apk文件所在的文件路径，包括apk,如D:/hello.apk,注意需要打开的cmd路径不要带有中文，否则，部分电脑可能会提示安装失败</span>

<span class="token number">4</span>、adb uninstall 应用包名，应用卸载   查看自己安装的包名，adb uninstall <span class="token parameter variable">-k</span> hello.apk 下载应用，但保留缓存数据

<span class="token number">5</span>、adb connect 设备ip地址，			<span class="token comment"># 如果电脑与设备在同一局域网内，Android设备的连接ip 地址，可连接成功</span>

<span class="token number">6</span>、adb <span class="token function">install</span> <span class="token parameter variable">-r</span>  APK路径 安装应用

<span class="token number">7</span>、adb push 电脑上的文件 路径 sdcard/  将电脑的文件输入到手机上
	如文件D:/hello.apk，    adb push D:/hello.apk  /sdcard、hello.apk
	
<span class="token number">8</span>、adb pull  /sdcard/文件路径 指定的pc目录，将文件拷贝到pc，<span class="token comment"># 文件保存的路径直接与cmd打开的路径相同(----比较常用----)</span>

<span class="token number">9</span>、adb <span class="token function">reboot</span> 或加参数-p设备进行重启

<span class="token number">10</span>、adb shell pm <span class="token function">clear</span> 包名 清除应用数据<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">11</span>、adb shell am force-stop 包名 关闭应用

<span class="token number">12</span>、adb shell screencap /sdcard/screen.png  截屏幕

<span class="token number">13</span>、adb shell screenrecord /sdcard/hello.mp4 屏幕视频录制，测试时可使用

<span class="token number">14</span>、adb logcat 抓取日志
<span class="token comment"># 如果要过滤日志，可通过adb logcat | findstr "输入过滤的内容"</span>

<span class="token number">15</span>、adb shell wm size 查看屏幕大小

<span class="token number">16</span>、 adb shell getprop查看配置信息
<span class="token comment"># 如：adb shell getprop ro.build.version.sdk 查看api版本</span>

<span class="token number">17</span>、adb shell input keyevent <span class="token number">4</span> 相当于返回键，返回上一页

<span class="token number">18</span>、adb shell <span class="token function">df</span> 查看手机存储信息

<span class="token number">19</span>、adb shell  pm disable-user com.android.launcher3 禁用系统应用

<span class="token number">20</span>、 adb shell pm <span class="token builtin class-name">enable</span> com.android.launcher3 启用系统 ，需要root权限<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">21</span>、adb start-server <span class="token operator">|</span> kill-server //启动或关闭adb服务进程

<span class="token number">22</span>、adb shell <span class="token function">cat</span> /sys/class/net/wlan0/address   //获取mac地址

<span class="token number">23</span>、adb shell monkey <span class="token parameter variable">-p</span> 包名 <span class="token parameter variable">--throttle</span> <span class="token number">100</span> --ignore-crashes --ignore-timeouts --ignore-security-exceptions --ignore-native-crashes --monitor-native-crashes <span class="token parameter variable">-v</span> <span class="token parameter variable">-v</span> <span class="token parameter variable">-v</span> –s <span class="token number">1540475754297</span> <span class="token number">100</span>  monkey测试

<span class="token number">24</span>、adb shell <span class="token function">ls</span> /system/bin  查看当前设备可以使用的所有命令

<span class="token number">25</span>、adb shell input text <span class="token string">"www.baidu.com"</span>，在编辑的文本框中输入编辑文字

<span class="token number">26</span>、adb shell svc wifi <span class="token builtin class-name">enable</span> <span class="token operator">|</span> disable   打开或关闭wifi

<span class="token number">27</span>、adb shell svc data <span class="token builtin class-name">enable</span> <span class="token operator">|</span>disable 打开或关闭移动网络

<span class="token number">28</span>、adb shell input swipe <span class="token number">760</span> <span class="token number">500</span> <span class="token number">600</span> <span class="token number">320</span> 点击屏幕，根据实际坐标点击

<span class="token number">29</span>、adb shell <span class="token function">mkdir</span>   /sdcard/创建目录

<span class="token number">30</span>、cat /proc/cpuinfo // 查看CPU信息，如果要看内存，则cat/proc/meminfo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">31</span>、cat /data/misc/wifi/*.conf 查看wifi密码，需要root权限

<span class="token number">32</span>、 <span class="token function">mount</span> <span class="token parameter variable">-o</span> remount,rw / 当root权限之后，仍提示file system <span class="token builtin class-name">read</span> only时，先执行adb root ,接着执行adb remount, <span class="token function">mount</span> <span class="token parameter variable">-o</span> remount,rw / 然后执行该指令

<span class="token number">33</span>、<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>setprop service.adb.tcp.port <span class="token number">5555</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>stop adbd <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>start adbd 使用wifi连接失败时，

<span class="token number">34</span>、adb shell dumpsys activity <span class="token operator">|</span> findstr “mFocus” 获取当前的activity 

<span class="token number">35</span>、adb shell settings put global policy_control <span class="token assign-left variable">immersive.full</span><span class="token operator">=</span>*

<span class="token number">36</span>、仅隐藏状态栏：adb shell settings put global policy_control <span class="token assign-left variable">immersive.status</span><span class="token operator">=</span>*

<span class="token number">37</span>、仅隐藏虚拟键：adb shell settings put global policy_control <span class="token assign-left variable">immersive.navigation</span><span class="token operator">=</span>*

<span class="token number">38</span>、恢复：adb shell settings put global policy_control null

<span class="token number">39</span>、完全隐藏  adb shell wm overscan <span class="token number">0,0</span>,0,0

<span class="token number">40</span>、旋转屏幕 adb shell content insert <span class="token parameter variable">--uri</span> content://settings/system <span class="token parameter variable">--bind</span> name:s:user_rotation <span class="token parameter variable">--bind</span> value:i:1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">41</span>、设置输入法  adb shell ime <span class="token builtin class-name">enable</span>  com.iflytek.inputmethod/.FlyIME
    adb shell ime <span class="token builtin class-name">set</span> com.iflytek.inputmethod/.FlyIME

<span class="token number">42</span>、Android tcp抓包  tcpdump <span class="token parameter variable">-C</span> <span class="token number">10</span> <span class="token parameter variable">-i</span> any <span class="token parameter variable">-w</span> /sdcard/capture.pcap
    <span class="token parameter variable">-C</span> <span class="token number">10</span> 是指单个文件10MB
    <span class="token parameter variable">-i</span> any 是所有端口
    <span class="token parameter variable">-w</span> xxx 是存储路径

<span class="token number">43</span>、制作的bootanimation 压缩，注意需要将图片至于part0上，使用时在新建目录：mkdir makeLogo
放入文件：desc.txt文件和part0文件,part0存放的全是图片
执行指令：zip <span class="token parameter variable">-r</span> <span class="token parameter variable">-X</span> <span class="token parameter variable">-Z</span> store bootanimation part*/* desc.txt
导出  bootanimatio.zip

<span class="token number">44</span>、dumpsys iponesubinfo
<span class="token function">service</span> call iphonesubinfo <span class="token number">1</span> //查看iccid

<span class="token number">11</span>、adb shell pm list packages <span class="token parameter variable">-3</span> 		<span class="token comment"># 查看第三方安装的应用包名，卸载应用前，一般可通过该指令查看包名</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p><strong>1 重启</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb <span class="token function">reboot</span>					   <span class="token comment"># 正常重启						</span>
adb <span class="token function">reboot</span> bootloader			<span class="token comment"># 重启到 bootloader (刷机模式)		用fastboot命令开始针对某个分区刷机</span>
adb <span class="token function">reboot</span> recovery				<span class="token comment"># 重启到 recovery (恢复模式)		   </span>
adb <span class="token function">reboot</span> edl				    <span class="token comment"># 进入9008模式整机刷机		</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>2 安装APK</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb <span class="token function">install</span> xxx.apk				<span class="token comment"># 安装</span>
adb <span class="token function">install</span> <span class="token parameter variable">-r</span> xxx.apk			<span class="token comment"># 覆盖安装(保留缓存和数据)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><strong>3 抓NTC数据</strong></p>
<pre class="line-numbers language-none"><code class="language-none">adb root
adb shell 
cd sdcard
sh batteryCheck &amp;
导出log：adb pull /sdcard/power_info C:\Users\dell\Desktop\battery_log"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>bat.sh</code>是丘工编好的批处理,     先把<code>bat.sh</code>放到sdcard根目录:<code>adb push C:\Users\dell\Desktop\APK\batteryCheck.sh /sdcard</code></p>
<p>注意：不能带中文的文件夹路径     加&amp;表示后台运行</p>
<p><strong>4 Nibiru软件抓log</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell setprop persist.nibiru.logcat.flag <span class="token number">0</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>Nibiru的3D软件默认没有打开log，需要手动打开</p>
<p> <strong>5 设置永不休眠</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell 
settings put system screen_off_timeout <span class="token number">999999999</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><strong>6 Nibiru软件查看渠道号</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell getprop ro.build.version.vr.level<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>7 Nibiru  3D软件获取root权限</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell setprop nibiru.root.allowed <span class="token number">1</span>
adb root
adb diasble-verity
adb <span class="token function">reboot</span>
adb shell setprop nibiru.root.allowed <span class="token number">1</span>
adb root
adb remount<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> <strong>8 获取SN号</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell
getprop ro.serialno <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><strong>9 抓FPS</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell dumpsys SurfaceFlinger<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>10 检查电池</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell dumpsys battery<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<p> <strong>11 VR901  截图命令</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell <span class="token string">"setprop debug.atw.capture 1"</span>
adb pull /sdcard/disp-1.bmp d:<span class="token punctuation">\</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>数字1是截图文件的命名，多次导出每次数字要不一样，而且导出时需要选择对应的数字</p>
<p><strong>12 导出系统APP的adb  命令</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb root
adb remount
adb shell
<span class="token builtin class-name">cd</span> data
<span class="token builtin class-name">cd</span> app
<span class="token function">ls</span>
<span class="token builtin class-name">cd</span> 包名（例如：com.ktcp.vidio-1）
<span class="token function">ls</span>
<span class="token builtin class-name">exit</span>
adb pull /data/app/com.ktcp.video-1/base.apk D:/123
adb shell dumpsys SurfaceFlinger<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> <strong>13 adb 关机指令</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell <span class="token function">reboot</span> <span class="token parameter variable">-p</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>14 adb服务</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb start-server		<span class="token comment"># 开启服务 </span>
adb kill-server			<span class="token comment"># 关闭服务</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><strong>15 查看系统当前内存使用情况</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell <span class="token function">cat</span> /proc/meminfo<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p> <strong>16 删除文件</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell
<span class="token function">rm</span> <span class="token parameter variable">-rf</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell
<span class="token builtin class-name">cd</span> /sdcard/
<span class="token function">ls</span>
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> testreport.txt（文件名）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>17 打印log</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb logcat					<span class="token comment"># 上层log：</span>
adb shell <span class="token function">dmesg</span>				<span class="token comment"># 底层log：</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><strong>18 push文件</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb root
adb remount
adb push<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><code>adb push "D:\temporary\test tool\4K生态微观50mbps.mp4" /sdcard/</code>     将D:\temporary\test tool\目录下的4K生态微观50mbps.mp4文件推送至设备本地/sdcard/根目录</p>
<p><strong>19 从设备本地pull文件</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb root
adb remount
adb pull<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><code>adb pull /sdcard/emdoor/testreport.txt C:\Users\dell\Desktop\0522</code>     将设备本地/sdcard/emdoor/目录下的testreport.txt文件拉取到C:\Users\dell\Desktop\0522目录下</p>
<p> <strong>20 2D截图</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell screencap <span class="token parameter variable">-p</span> 
adb shell screencap <span class="token parameter variable">-p</span> /sdcard/screen.png  <span class="token comment">#（保存路径）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<p><strong>21 3D截图</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell /system/bin/screencap <span class="token parameter variable">-p</span> 
adb pull /sdcard/screenshot.png F:<span class="token punctuation">\</span><span class="token punctuation">\</span>mvp

adb shell /system/bin/screencap <span class="token parameter variable">-p</span> /sdcard/screenshot.png		  <span class="token comment">#（保存路径）</span>
adb pull /sdcard/screenshot.png F:<span class="token punctuation">\</span><span class="token punctuation">\</span>mvp							<span class="token comment">#（电脑保存路径）"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>22 录屏</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell screenrecord 
adb shell screenrecord /sdcard/demo.mp4 	<span class="token comment">#（保存路径）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p> <strong>23 连接WIFI  adb，不占用usb口</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb tcpip <span class="token number">5555</span>				<span class="token comment"># PC端和安卓端连接同一个WIFI地址，cmd输入</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>打开Vysor设置IP连接（连接成功之前不能拔掉连接线，或者使用adb命令：<code>adb connect 设备IP</code>）</p>
<p>注意：首先必须测试机连接电脑，先用<code>adb  tcpip 5555</code>打开5555端口，然后再用<code>adb connect 设备IP</code>即可</p>
<p><strong>24 查看ufs内存</strong>	</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell
<span class="token function">df</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><strong>25 PC连接多台设备时指定某台设备</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb devices 
adb <span class="token parameter variable">-s</span> （加要连接设备名称，加要执行的命令）

adb devices （获取设备名称）
<span class="token number">14121578</span>
adb <span class="token parameter variable">-s</span> <span class="token number">14121578</span> shell<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>26 替换开机动画</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb root
adb remount
adb push C:<span class="token punctuation">\</span>Users<span class="token punctuation">\</span>dell<span class="token punctuation">\</span>Desktop<span class="token punctuation">\</span>bootanimation<span class="token punctuation">\</span>bootanimation.zip /system/media/"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>bootanimation是在动画文件界面压缩，选择ZIP格式，存储方式</p>
<p> <strong>27 查看屏幕分辨率</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell wm size<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>28 抓实时电压</strong>	</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell
<span class="token operator">&gt;</span> <span class="token keyword">while</span> <span class="token boolean">true</span>
<span class="token operator">&gt;</span> <span class="token keyword">do</span>
<span class="token operator">&gt;</span> dumpsys battery<span class="token operator">|</span><span class="token function">grep</span> voltage
<span class="token operator">&gt;</span> <span class="token function">sleep</span> <span class="token number">1</span>
<span class="token operator">&gt;</span> <span class="token keyword">done</span><span class="token string">"xxxxxxxxxx "</span>adb shell<span class="token operator">&gt;</span> <span class="token keyword">while</span> true<span class="token operator">&gt;</span> do<span class="token operator">&gt;</span> dumpsys battery<span class="token operator">|</span><span class="token function">grep</span> voltage<span class="token operator">&gt;</span> <span class="token function">sleep</span> <span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span> done"adb shelldf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>进入adb  shell     进入死循环     获取电池信息|greg 电压/电流/温度等     PS:如果需要同时抓几组参数，就多打一行指令     每秒抓一次数据     done代表以上命令输入完成</p>
<p>电压：voltage     百分比：level     温度：temperature</p>
<p><strong>29 查看主板SN</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb root
adb shell <span class="token function">cat</span> /mnt/vendor/persist/snPcba.bin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><strong>30 刷modem-  fastboot命令</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb <span class="token function">reboot</span> bootloader
fastboot flash modem +modem文件路径
fastboot <span class="token function">reboot</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<p> <strong>31 刷boot</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb <span class="token function">reboot</span> bootloader
fastboot flash boot C:<span class="token punctuation">\</span>Users<span class="token punctuation">\</span>dell<span class="token punctuation">\</span>Desktop<span class="token punctuation">\</span>boot.img
fastboot <span class="token function">reboot</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><strong>32 抓log，保存在内部存储</strong>	</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb logcat <span class="token parameter variable">-v</span> <span class="token function">time</span> <span class="token operator">&gt;</span> D:<span class="token punctuation">\</span>Logcat<span class="token punctuation">\</span>logcat.log<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p> <strong>33  查WiFi  MAC</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell
<span class="token function">cat</span> /sys/class/net/wlan0/address<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><strong>34 查系统 RTC</strong>	</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">while</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token keyword">do</span>
<span class="token function">date</span>
<span class="token function">sleep</span> <span class="token number">1</span>
<span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> **35 获得当前界面的在哪个Activity **</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell dumpsys activity <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"mFocus"</span>
adb shell dumpsys activity <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"ResumedActivity"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><strong>36 adb打印出错信息</strong>	</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb logcat *:E<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p> **37 查看一个进程的内存变化 **</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell dumpsys meminfo com.android.dialer<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>38 dumpsys这个工具可以查看当前设备系统服务信息</strong>	</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell dumpsys power
adb shell dumpsys battery
adb shell dumpsys activity <span class="token function">top</span> <span class="token operator">|</span> findstr ACTIVITY <span class="token comment">#查看顶部activity</span>
adb shell dumpsys SurfaceFlinger<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p> **39 根据进程号PID，反查进程信息 **</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell <span class="token function">ps</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token number">1490</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>40 查看某个进程的权限申请</strong>	</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell appops get com.android.dialer<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>





<p> <strong>41 查看一个应用进程的包清单配置信息</strong>	</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell dumpsys package com.android.dialer<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>42 查看APK签名命令：</strong>	</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">keytool <span class="token parameter variable">-printcert</span> <span class="token parameter variable">-v</span> <span class="token parameter variable">-file</span> CERT.RSA<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol>
<li>keytool为java命令行工具，位于jdk或jre的bin目录.     </li>
<li>用压缩工具打开APK在META-INF目录可找到CERT.RSA文件。</li>
</ol>
<p> <strong>43  查看中断异常</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell <span class="token function">cat</span> /proc/interrupts
<span class="token number">150236</span> mt-eint <span class="token number">1</span> home
<span class="token number">0</span> mt-eint <span class="token number">2</span> ALS-eint
<span class="token number">22</span> mt-eint <span class="token number">3</span> FINGERPRINT-eint
<span class="token number">0</span> mt-eint <span class="token number">6</span> accdet-eint
<span class="token number">5924</span> mt-eint <span class="token number">10</span> TOUCH_PANEL-eint
<span class="token number">199</span> mt-eint <span class="token number">206</span> pmic-eint<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>操作复现问题后，adb  shell查看中断, 红色字体在增加，代表有频繁中断发生</p>
<p><strong>44 怎么用adb命令录制视频</strong>	</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell screenrecord /sdcard/file.mp4			<span class="token comment"># 录制视频：</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p> <strong>45 怎么用adb清除应用缓存和数据</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell pm <span class="token function">clear</span> com.android.dialer<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>46 怎么根据进程名查看应用的安装目录</strong>	</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell pm path com.android.dialer<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p> **47 怎么获取当前手机屏幕分辨率 **</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#手机分辨率越高，内存占用这块会更多，对于低内存手机来讲影响较大。</span>
adb shell wm size
Physical size: 1080x1920 
adb shell dumpsys window displays
<span class="token assign-left variable">init</span><span class="token operator">=</span>1080x1920 480dpi <span class="token assign-left variable">cur</span><span class="token operator">=</span>1080x1920 <span class="token assign-left variable">app</span><span class="token operator">=</span>1080x1920 <span class="token assign-left variable">rng</span><span class="token operator">=</span>1080x1008-1920x1848"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>48 句柄泄露，查看句柄数目变化</strong>	</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 操作几次看看前后文件句柄变化主要是哪些</span>
adb shell
<span class="token function">ps</span> <span class="token operator">|</span> <span class="token function">grep</span> com.android.dialer <span class="token punctuation">(</span>查询某进程pid<span class="token punctuation">)</span>
<span class="token function">ls</span> <span class="token parameter variable">-a</span> <span class="token parameter variable">-l</span> /proc/pid/fd <span class="token punctuation">(</span>pid对应应用进程号， 句柄变化<span class="token punctuation">)</span>
<span class="token function">ps</span> <span class="token parameter variable">-t</span> <span class="token operator">|</span> <span class="token function">grep</span> pid <span class="token punctuation">(</span>pid对应应用进程号，HandlerThread变化<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> **49 怎么删掉数据库值 **</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell settings delete system button_enable_float_incoming_bar_key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>50 查看运行内存相关信息</strong>	</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell dumpsys meminfo<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<p> **51 屏幕刷新率 **</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell
dumpsys SurfaceFlinger <span class="token operator">|</span> <span class="token function">grep</span> refresh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>低配置手机上内存是主要瓶颈之一，当剩余内存在100MB以下时，整体性能会相对较差；</p>
<p><strong>52 adb快速重启手机</strong>	</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell <span class="token string">"stop &amp;&amp; start"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p> **53 全日志抓取到文件 **</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb logcat <span class="token parameter variable">-b</span> main <span class="token parameter variable">-b</span> system <span class="token parameter variable">-b</span> radio <span class="token parameter variable">-b</span> events <span class="token parameter variable">-v</span> <span class="token function">time</span> <span class="token operator">&gt;</span>d:/all.log
adb logcat <span class="token parameter variable">-b</span> all <span class="token operator">&gt;</span>d:/all.log	 <span class="token punctuation">(</span>all含义 <span class="token builtin class-name">:</span> main,system,events,radio,crash,kernel<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><strong>54 查看当前任务栈列表</strong>	</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell am stack list<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>55 启动Activity</strong>	</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb shell am stack list<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h2 id="2-adb环境配置"><a href="#2-adb环境配置" class="headerlink" title="2. adb环境配置"></a>2. adb环境配置</h2><p>首先到官网下载 <a target="_blank" rel="noopener" href="https://apkinstaller.com/">Downloads - ADB Shell</a>，下载后解压，下面以windows为例，对adb环境进行配置，解压后文件保存到D盘D:\adb（要找到adb.exe的那个路径）</p>
<p>进入计算机，右击此电脑 -&gt; 属性 -&gt; 高级系统设置 -&gt; 环境变量 -&gt;  Path -&gt; 在里面添加就好了，点击高级系统设置之后，</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202407180954063.png" alt="202407180943355"></p>
<h2 id="3-fastboot及刷机的相关命令"><a href="#3-fastboot及刷机的相关命令" class="headerlink" title="3. fastboot及刷机的相关命令"></a>3. fastboot及刷机的相关命令</h2><p><strong>3.1 刷modem</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb <span class="token function">reboot</span> bootloader
fastboot flash modem +modem文件路径
fastboot <span class="token function">reboot</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p> <strong>3.2 刷boot</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb <span class="token function">reboot</span> bootloader
fastboot flash boot C:<span class="token punctuation">\</span>Users<span class="token punctuation">\</span>dell<span class="token punctuation">\</span>Desktop<span class="token punctuation">\</span>boot.img
fastboot <span class="token function">reboot</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><strong>3.3 刷单个分区操作</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb <span class="token function">reboot</span> bootloader							<span class="token comment">#进入刷机模式</span>
fastboot  flash modem NON-HLOS.bin	<span class="token comment"># 这个是文件的路径，已经在当下的目录可以直接输入，不在当前目录可以拖拽，会显示绝对路径</span>
fastboot  flash modem_b NON-HLOS.bin
fastboot flash xbl xbl.elf
fastboot flash xbl_a xbl.elf
fastboot flash xbl_b xbl.elf
fastboot flash dtbo_a dtbo.img
fastboot flash dtbo_b dtbo.img
fastboot flash boot_a boot.img
fastboot flash boot_b boot.img
fastboot flash xbl_config_a xbl_config.elf
fastboot flash xbl_config_b xbl_config.elf
fastboot flash abl_a abl.elf
fastboot flash abl_b abl.elf
fastboot flash imagefv imagefv.elf
fastboot <span class="token function">reboot</span>									<span class="token comment">#刷完之后要重启</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>3.4 刷整个系统</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb <span class="token function">reboot</span> edl								    <span class="token comment"># 进入9008模式整机刷机模式</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>在QEIL软件中可以进行整机刷新。点击download后就等待刷机成功，它自己会重新启动</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202407180955964.png" alt="863b4aca-df24-479c-b601-0466e45c573a"></p>
<h2 id="4-git常用命令"><a href="#4-git常用命令" class="headerlink" title="4. git常用命令"></a>4. git常用命令</h2><p><strong>一、git安装后-指定名称和邮箱</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">git</span> config <span class="token parameter variable">--global</span> user.name <span class="token string">"Your Name"</span>
$ <span class="token function">git</span> config <span class="token parameter variable">--global</span> user.email <span class="token string">"email@example.com"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><strong>二、创建版本库</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">mkdir</span> learngit	//创建
$ <span class="token builtin class-name">cd</span> learngit	//使用
$ <span class="token builtin class-name">pwd</span>	//查看当前目录
$ <span class="token function">git</span> init	//初始化，生成.git文件<span class="token punctuation">(</span>若该文件隐藏，则使用ls -ah<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>*<strong>三、把文件添加add和提交commit到版本库</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">git</span> <span class="token function">add</span> test.txt	//添加
$ <span class="token function">git</span> <span class="token function">add</span> <span class="token builtin class-name">.</span>	//添加该目录下的所有文件
$ <span class="token function">git</span> commit <span class="token parameter variable">-m</span> <span class="token string">"wrote a test file"</span>	//提交
$ <span class="token function">git</span> commit <span class="token parameter variable">-m</span> <span class="token string">"add 3 files."</span>		//一次性提交多个文件<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>注意：必须在当前版本库和当前目录下<br>*<strong>四、版本控制</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">git</span> log	//查看提交历史记录，从最近到最远，可以看到3次
$ <span class="token function">git</span> log <span class="token parameter variable">--pretty</span><span class="token operator">=</span>oneline	//加参，简洁查看
$ <span class="token function">git</span> reflog	//查看每一次修改历史
$ <span class="token function">cat</span> test.txt	//查看文件内容
$ <span class="token function">git</span> status	//查看工作区中文件当前状态
$ <span class="token function">git</span> reset <span class="token parameter variable">--hard</span> HEAD^（HEAD~100）（commit id）	//回退版本
$ <span class="token function">git</span> checkout -- test.txt	//丢弃工作区的修改，即撤销修改
$ <span class="token function">git</span> reset HEAD test.txt	//丢弃暂存区的修改（若已提交，则回退）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>五、删除文件</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">rm</span> test.txt
//直接删除
$ <span class="token function">git</span> <span class="token function">rm</span> test.txt
$ <span class="token function">git</span> commit <span class="token parameter variable">-m</span> <span class="token string">"remove test.txt"</span>
//删错了，恢复
$ <span class="token function">git</span> checkout -- test.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>*<strong>六、远程仓库</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ ssh-keygen <span class="token parameter variable">-t</span> rsa <span class="token parameter variable">-C</span> <span class="token string">"youremail@example.com"</span>	//创建SSH Key
$ <span class="token function">git</span> remote <span class="token function">add</span> origin git@github.com:Daisy/AKgit.git	//关联
$ <span class="token function">git</span> push <span class="token parameter variable">-u</span> origin master	//将本地内容推送到远程仓库（第一次）
$ <span class="token function">git</span> push origin master	//将本地内容推送到远程仓库（之后）
$ <span class="token function">git</span> remote <span class="token parameter variable">-v</span>        //查看远程仓库信息
$ <span class="token function">git</span> remote <span class="token function">rm</span> origin	//删除远程仓库（解绑）
$ <span class="token function">git</span> clone git@github.com: Daisy/AKgit.git	//克隆远程仓库
//克隆之后使用和查看
$ <span class="token builtin class-name">cd</span> gitskills
$ <span class="token function">ls</span>
$ <span class="token function">git</span> remote	//查看远程库的信息
$ <span class="token function">git</span> remote <span class="token parameter variable">-v</span>	//查看远程库的详细信息<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>*<strong>七、多人协作</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">git</span> checkout <span class="token parameter variable">-b</span> dev	//创建并切换到分支dev
<span class="token comment"># 创建并切换到分支dev，同上</span>
$ <span class="token function">git</span> branch dev	//创建
$ <span class="token function">git</span> checkout dev	//切换
<span class="token comment"># 新版本</span>
$ <span class="token function">git</span> switch <span class="token parameter variable">-c</span> dev	//创建并切换到分支dev
$ <span class="token function">git</span> switch master	//直接切换分支
$ <span class="token function">git</span> branch		//查看当前分支
$ <span class="token function">git</span> merge dev	（--no-ff）<span class="token punctuation">(</span>-m<span class="token punctuation">)</span>//合并，把dev分支的工作成果合并到master分支上
$ <span class="token function">git</span> branch <span class="token parameter variable">-d</span> dev	//删除dev分支 

$ <span class="token function">git</span> stash	//将现场储藏起来
$ <span class="token function">git</span> stash list	//查看储存的工作现场
<span class="token comment"># 恢复和删除</span>
$ <span class="token function">git</span> stash apply
$ <span class="token function">git</span> stash drop
<span class="token comment"># 恢复并删除</span>
$ <span class="token function">git</span> stash pop
$ <span class="token function">git</span> cherry-pick 4c805e2	//复制修改

$ <span class="token function">git</span> push origin master（dev）	//推送分支
$ <span class="token function">git</span> checkout <span class="token parameter variable">-b</span> dev origin/dev	//创建远程origin的dev分支到本地
$ <span class="token function">git</span> pull	//抓取分支（解决冲突）
$ <span class="token function">git</span> branch --set-upstream-to<span class="token operator">=</span>origin/dev dev//指定本地与远程dev的链接
$ <span class="token function">git</span> rebase	//把本地未push的分叉提交历史整理成直线<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>八、标签管理</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">git</span> tag v1.0	//打标签
$ <span class="token function">git</span> tag <span class="token parameter variable">-a</span> v0.1 <span class="token parameter variable">-m</span> <span class="token string">"version 0.1 released"</span> 1094adb //指定标签名和说明文字
$ <span class="token function">git</span> tag	//查看所有标签
<span class="token comment"># 若是忘记打，则查找历史提交commit id ，再打上</span>
$ <span class="token function">git</span> log <span class="token parameter variable">--pretty</span><span class="token operator">=</span>oneline --abbrev-commit
$ <span class="token function">git</span> tag v0.9 f52c633
$ <span class="token function">git</span> show v0.9		//查看标签详细信息
$ <span class="token function">git</span> tag <span class="token parameter variable">-d</span> v0.1	//删除标签
$ <span class="token function">git</span> push origin v1.0	//推送标签到远程
$ <span class="token function">git</span> push origin –tags	//一次性推送全部本地标签
<span class="token comment"># 删除标签，（若已推送到远程，先从本地删除，从远程删除）</span>
$ <span class="token function">git</span> tag <span class="token parameter variable">-d</span> v0.9
$ <span class="token function">git</span> push origin :refs/tags/v0.9 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>九、自定义git</strong></p>
<p>$ git config –global color.ui true	//让git显示颜色</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">//忽略特殊文件
//.gitignore文件
<span class="token comment"># Windows:</span>
Thumbs.db
ehthumbs.db
Desktop.ini
<span class="token comment"># Python:</span>
*.py<span class="token punctuation">[</span>cod<span class="token punctuation">]</span>
*.so
*.egg
*.egg-info
dist
build
<span class="token comment"># My configurations:</span>
db.ini
deploy_key_rsa
//把该文件也提交到git
$ <span class="token function">git</span> <span class="token function">add</span> <span class="token parameter variable">-f</span> App.class		//强制添加被忽略的特殊文件
$ <span class="token function">git</span> check-ignore <span class="token parameter variable">-v</span> App.class	//检查哪个规则出错
<span class="token comment"># 排除所有.开头的隐藏文件:</span>
.*
<span class="token comment"># 排除所有.class文件:</span>
*.class
<span class="token comment"># 不排除.gitignore和App.class:</span>
<span class="token operator">!</span>.gitignore
<span class="token operator">!</span>App.class

$ <span class="token function">git</span> config <span class="token parameter variable">--global</span> alias.st status	//配置别名
$ <span class="token function">git</span> config <span class="token parameter variable">--global</span> alias.unstage <span class="token string">'reset HEAD'</span>  //配置操作别名
$ <span class="token function">git</span> config <span class="token parameter variable">--global</span> alias.last <span class="token string">'log -1'</span>	//显示最后一次提交信息
$ <span class="token function">git</span> last	//显示最近一次的提交
<span class="token variable">$git</span> config <span class="token parameter variable">--global</span> alias.lg <span class="token string">"log --color --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)&lt;%an&gt;%Creset' --abbrev-commit"</span>  //颜色
$ <span class="token function">cat</span> .git/config //查看每个仓库的git配置文件
$ <span class="token function">cat</span> .gitconfig  //查看当前用户的git配置文件<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>十、关于log</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> log <span class="token builtin class-name">.</span>						<span class="token comment"># 查看当前目录下的文件或者目录提交历史</span>
<span class="token function">git</span> log							<span class="token comment"># 查看整个仓库下的文件或者目录提交历史</span>
<span class="token function">git</span> log <span class="token parameter variable">--oneline</span>				 <span class="token comment"># 非常高效快速的浏览提交历史，前面是哈希值</span>
<span class="token function">git</span> show 5a3c8b1623（哈希值）				<span class="token comment"># 直接查看某个提交的情况，</span>
<span class="token function">git</span> show 5a3c8b1623 <span class="token parameter variable">--stat</span>					<span class="token comment"># 直接查看某个提交的情况，大概改了哪些文件</span>
<span class="token function">git</span> log <span class="token parameter variable">--all</span> <span class="token parameter variable">--graph</span>						<span class="token comment"># 以分支的形式查看</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="5-UART、SPI、I2C等通信协议总结"><a href="#5-UART、SPI、I2C等通信协议总结" class="headerlink" title="5. UART、SPI、I2C等通信协议总结"></a>5. UART、SPI、I2C等通信协议总结</h2><p>该小节的原文链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_70435858/article/details/126123622">https://blog.csdn.net/m0_70435858/article/details/126123622</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Mr_Guan/article/details/133324610">https://blog.csdn.net/Mr_Guan/article/details/133324610</a></p>
<p><strong>波特率</strong>是发送二进制数据位的速率，即每秒传输二进制位的数量。两个单片机要保持通信一定要保持一致的波特率。</p>
<h3 id="一、并行和串行"><a href="#一、并行和串行" class="headerlink" title="一、并行和串行"></a>一、并行和串行</h3><ul>
<li><p>1.<strong>并行通讯</strong>：同一时刻，可以传输多个bit位的信号，有多少个信号位就需要多少根信号线。</p>
<ul>
<li>并行通讯的效率高，但是对信号线路要求也很高，一般应用于快速设备之间采用并行通信，譬如CPU 与存储设备、存储器与存储器、主机与打印机等都采用并行通讯。</li>
<li>就像下面的例子，允许多个小汽车同时通过公路</li>
</ul>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202407221715270.png" alt="image-20240722171529197"></p>
</li>
<li><p>2.<strong>串行通讯</strong>：同一时刻，只能传输一个bit位的信号，只需要一根信号线。</p>
<ul>
<li>串行通讯效率较低，但是对信号线路要求低，抗干扰能力强，同时成本也相对较低，一般用于与计算机与外部设备，或者长距离的数据传输。</li>
<li>就像下面的例子，串行就是要后面的小汽车必须等第一辆车通过才能通过</li>
</ul>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202407221714424.png" alt="image-20240722171406360"></p>
</li>
</ul>
<h3 id="二、异步和同步"><a href="#二、异步和同步" class="headerlink" title="二、异步和同步"></a>二、异步和同步</h3><ul>
<li><p><strong>同步通信</strong>是一种连续串行传送数据的通信方式，一次通信只传送一帧信息。收发双方时钟同步。</p>
</li>
<li><p><strong>异步通信</strong>在发送字符时，所发送的字符之间的时间间隔可以是任意的。收发双方时钟不同步。</p>
</li>
<li><p><strong>同步通信与异步通信区别</strong>：</p>
<ul>
<li><strong>同步通信</strong>要求接收端时钟频率和发送端<strong>时钟频率一致</strong>，发送端发送连续的比特流；<strong>异步通信</strong>时不要求接收端时钟和发送端时钟同步发送端发送完一个字节后，可经过任意长的时间间隔再发送下一个字节。</li>
<li>同步通信效率高；异步通信效率较低。</li>
<li>同步通信较复杂，双方时钟的允许误差较小；异步通信简单，双方时钟可允许一定误差。</li>
<li>同步通信可用于点对多点；异步通信只适用于点对点。</li>
</ul>
</li>
</ul>
<h3 id="三、全双工和半双工"><a href="#三、全双工和半双工" class="headerlink" title="三、全双工和半双工"></a>三、全双工和半双工</h3><p><strong>全双工通信</strong>：称为双向同时通信，即通信的双方可以同时发送和接收信息的信息交互方式。<br><strong>半双工通信</strong>：指数据可以沿两个方向传送，但同一时刻一个半双工总线结构信道只允许单方向传送，因此又被称为双向交替通信。<br><strong>单工通信</strong>：是指消息只能单方向传输的工作方式，只能有一个方向的通信而没有反方向的交互。（发送端-&gt;接收端，不能反向）</p>
<img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202407221737526.png" alt="image-20240722173730462" style="zoom:50%;">

<h3 id="四、UART协议（全双工、速度慢）"><a href="#四、UART协议（全双工、速度慢）" class="headerlink" title="四、UART协议（全双工、速度慢）"></a>四、UART协议（全双工、速度慢）</h3><h4 id="1-UART简介"><a href="#1-UART简介" class="headerlink" title="1.UART简介"></a>1.UART简介</h4><p>UART的全称是<strong>通用异步收发器</strong>（Universal Asynchronous Receiver/Transmitter），是一种通用的串行、异步通信总线，该总线有两条数据线，可以实现<strong>全双工的发送和接收</strong>在嵌入式系统中常用于主机与辅助设备之间的通信。</p>
<h4 id="2-UART接口"><a href="#2-UART接口" class="headerlink" title="2.UART接口"></a>2.UART接口</h4><ul>
<li>TXD:发送数据；</li>
<li>RXD：接收数据；</li>
<li>CTS：清除发送、允许发送；</li>
<li>RTS：请求发送。</li>
</ul>
<p>RTS/CTS协议即请求发送/允许发送协议，相当于一种握手协议，主要用来解决”隐藏终端”问题。”隐藏终端”是指，基站A向基站B发送信息，基站C未侦测到A也向B发送，故A和C同时将信号发送至B，引起信号冲突，最终导致发送至B的信号都丢失了。”隐藏终端”多发生在大型单元中（一般在室外环境），这将带来效率损失，并且需要错误恢复机制。当需要传送大容量文件时，尤其需要杜绝“隐藏终端”现象的发生。IEEE802.11提供了如下解决方案。在参数配置中，若使用RTS/CTS协议，同时设置传送上限字节数，一旦待传送的数据大于此上限值时，即启动RTS/CTS握手协议：首先，A向B发送RTS信号，表明A要向B发送若干数据，B收到RTS后，向所有基站发出CTS信号，表明已准备就绪，A可以发送，其余基站暂时“按兵不动”，然后，A向B发送数据，最后，B接收完数据后，即向所有基站广播ACK确认帧，这样，所有基站又重新可以平等侦听、竞争信道了。</p>
<h4 id="3-UART帧格式"><a href="#3-UART帧格式" class="headerlink" title="3.UART帧格式"></a>3.UART帧格式</h4><ul>
<li>空闲位：数据线在空闲的时候，数据线的状态为高电平；</li>
<li>起始位：表示一次通信的开始；（1位）</li>
<li>数据位：串口协议规定，<strong>先发低位、后发高位</strong>；可以发送5-8位数据；</li>
<li>校验位：校验数据的正确性，若数据位1的个数为偶数，则检验位为1，否则为0；检验位只能发现错误，但不能纠错。</li>
<li>停止位：表示一次通信的结束，数据线的状态为高电平。（1位）</li>
</ul>
<img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202407221744925.png" alt="image-20240722174417824" style="zoom:50%;">

<h4 id="4-应用场景"><a href="#4-应用场景" class="headerlink" title="4.应用场景"></a>4.应用场景</h4><p>多用于<strong>板间通信</strong>，比如单片机和计算机，如RS-232、USB、MCU等。</p>
<img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202407221750575.png" alt="image-20240722175027419" style="zoom: 33%;">

<h4 id="5-UART的缺点"><a href="#5-UART的缺点" class="headerlink" title="5.UART的缺点"></a>5.UART的缺点</h4><ul>
<li><strong>（1）电气接口不统一</strong><ul>
<li>UART只是对信号的时序进行了定义，而未定义接口的电气特性;</li>
<li>UART通信时一般直接使用处理器使用的电平，即TTL电平，但不同的处理器使用的电平存在差异，所以不同的处理器使用UART通信时一般不能直接相连;</li>
<li>UART没有规定不同器件连接时连接器的标准，所以不同器件间通过UART通信时连接很不方便。</li>
</ul>
</li>
<li><strong>（2）抗干扰能力差</strong><ul>
<li>UART一般直接使用TTL信号来表示0和1，但TTL信号的抗干扰能力较差，数据在传输过程中很容易出错。</li>
</ul>
</li>
<li><strong>（3）通信距离极短</strong><ul>
<li>因为TTL信号的抗干扰能力较差，所以其通信距离也很短，一船只能用于一个电路板上的两个不芯片之间的通信。</li>
</ul>
</li>
</ul>
<h3 id="五、I2C协议（半双工、速度中等）"><a href="#五、I2C协议（半双工、速度中等）" class="headerlink" title="五、I2C协议（半双工、速度中等）"></a>五、I2C协议（半双工、速度中等）</h3><p>PHILIPS公司开发的一种<strong>两线式、串行、半双工同步通信总线</strong>，可以挂载多个参与通信的器件，常用于<strong>板内通信</strong>，比如单片机与外围芯片之间短距离、低速的信号传输	</p>
<p>在 CPU 与被控 IC 之间、IC 与 IC 之间进行双向传送，高速 IIC 总线一般可达 400kbps 以上。IIC是为了与低速设备通信而发明的，所以IIC的传输速率比不上SPI</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202407231130262.png" alt="2e184aaa54594bf3ab44a3a5e1112075"></p>
<p>所有接到I2C总线设备上的串行数据SDA都接到总线的SDA上，各设备的时钟线SCL接到总线的SCL上。I2C总线上的每个设备都自己一个唯一的地址，来确保不同设备之间访问的准确性。</p>
<h4 id="1-I2C物理层特点"><a href="#1-I2C物理层特点" class="headerlink" title="1.I2C物理层特点"></a>1.I2C物理层特点</h4><ul>
<li>（1）它是一个支持设备的总线。<strong>“总线”</strong>指多个设备共用的信号线。在一个 I2C 通讯总线中，可连接多个I2C通讯设备，支持多个通讯主机及多个通讯从机。</li>
<li>（2）一个I2C总线只使用两条总线线路，**一条双向串行数据线(SDA) ，一条串行时钟线(SCL)**。数据线即用来表示数据，时钟线用于数据收发同步。</li>
<li>（3）每一个连接总线的设备都有一个<strong>7位的独立地址</strong>，主机可以通过这个地址进行选择连接总线的设备与之通信。</li>
<li>（4）总线通过上拉电阻接到电源。当I2C设备空闲时，会输出高阻态，而当所有设备都空闲，都输出高阻态时，由上拉电阻把总线拉成高电平。</li>
<li>（5）多个主机同时使用总线时，为了防止多个设备发送数据冲突，会利用仲裁方式决定由哪个设备占用总线。</li>
<li>（6）具有三种传输模式：标准模式传输速率为100kbit/s，快速模式为400kbit/s，快速模式为1Mbit/s，高速模式下可达3.4Mbit/s，但目前大多I2C设备尚不支持高速模式。</li>
<li>（7）连接到相同总线的 IC 数量受到总线的最大电容 400pF限制。</li>
</ul>
<p>IIC的一个优点是它支持多主控(multimastering)， 其中任何一个能够进行发送和接收的设备都可以成为主总线。一个主控能够控制信号的传输和时钟频率。当然，在任何时间点上只能有一个主控。支持不同速率的通讯速度，标准速度(最高速度100kHZ),快速(最高400kHZ)。</p>
<p>SCL和SDA都需要接上拉电阻 (大小由速度和容性负载决定一般在3.3K-10K之间) 保证数据的稳定性，减少干扰。</p>
<p>寻址</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202407231116349.png" alt="image-20240723111555101"></p>
<p>发数据</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202407231122564.png" alt="image-20240723112208413"></p>
<h4 id="2-字节格式"><a href="#2-字节格式" class="headerlink" title="2.字节格式"></a>2.字节格式</h4><p><strong>SDA数据线上的每个字节必须是8位</strong>，每次传输的字节数量没有限制。<strong>每个字节后必须跟一个响应位（ACK）</strong>。首先传输的数据是最高位（MSB)，SDA上的数据必须在SCL高电平周期时保持稳定，数据的高低电平翻转变化发生在SCL低电平时期。</p>
<h4 id="3-7-bit寻址数据传输"><a href="#3-7-bit寻址数据传输" class="headerlink" title="3. 7-bit寻址数据传输"></a>3. 7-bit寻址数据传输</h4><p>常见的传输方向及格式有如下两种：</p>
<ul>
<li>（1）主机写数据——从机接收，传输方向不变<ul>
<li>要进行数据写入从机，首先主机发送START条件+从机地址+R/W=0(写操作，设置为0)，从机读取到该地址后回应ACK，主机将继续发送需要操作的寄存器地址，从机继续回应ACK，表示从机准备完毕。之后主机发送寄存器的数据（可能是1byte也可能是多个byte），每个byte从机都会回应ACK，发送完成后，主机发送STOP命令，将总线释放，完成写操作。如下图示意：</li>
</ul>
</li>
<li>（2）主机读数据-从机发送，传输方向改变<ul>
<li>读数据与写数据相似，但读数据会多几个步骤。要想从从机读取数据，首先要知道从机地址以及寄存器地址，这两部需要进行读操作来实现，和写操作一致。读操作完成后，主机发送重复开始+从机地址+R/W=1(读操作，设置为1)，从机返回ACK，此时主机释放SDA线转由从机控制，主机读取SDA总线进行数据接收，每发送1 byte数据，主机会响应ACK表示还需要再接收数据。当主机接收完想要的数据后，主机将会返回NACK，告诉从机释放SDA总线，随后主机发送STOP命令，将总线释放，完成读操作。如下图示意：</li>
</ul>
</li>
</ul>
<h4 id="4-IIC常见问题"><a href="#4-IIC常见问题" class="headerlink" title="4.IIC常见问题"></a>4.IIC常见问题</h4><p><strong>（1）为什么Open-Drain开漏输出需要上拉电阻</strong></p>
<p>​    开漏Pin不连接外部的上拉电阻，则只能输出低电平。当输出电平为低时，N沟道MOS管是导通的，这样在Vcc和GND之间有一个持续的电流流过上拉电阻R和三极管Q1。这会影响整个系统的功耗。采用较大值的上拉电阻可以减小电流。但是大的阻值会使输出信号的上升时间变慢。即上拉电阻R pull-up的阻值 决定了逻辑电平转换的沿的速度。阻值越大，速度越低功耗越小。反之亦然。</p>
<p><strong>（2）为什么IIC需要漏极开路</strong></p>
<p><strong>防止短路</strong><br>        如果不设为开漏，而设为推挽，几个设备连在同一条总线上，这时某一设备的某个IO输出高电平，另有一台设备的某一个IO输出低电平，这时你会发现这两个IO的VCC和GND短路了；但是开漏就不会有这个问题。</p>
<p><strong>增强端口扇出能力、降低功耗</strong><br>  IC为增强端口扇出能力而设计为漏极开路样式，使用时将该端口设为低电平有效的灌电流模式，能得到最大输出电流同时IC功耗最低。此类端口当输出高电平则需要外接上拉电阻。</p>
<p><strong>利用“线与”判断总线占用状态</strong><br>  可以将多个开漏输出的Pin脚，连接到一条线上，形成“与逻辑”关系,即“线与”功能，任意一个变低后，开漏线上的逻辑就为0了。这也是I2C，SMBus等总线判断总线占用状态的原理。<br>如果总线上的一个A设备将SDA拉高，这时总线上另一个B设备已将SDA拉低，这时由于1&amp;0=0，所以A设备检查SDA的时候会发现不是高电平而是低电平，这就表明总线上已经有其他设备占用总线了，A只好放弃，如果检测是高电平那就可以使用。</p>
<p><strong>增加驱动能力</strong><br>        如果在漏极drain_output接上拉电阻，则可以进行电平转换，且驱动能力较强。<br>利用外部电路的驱动能力，减少IC内部的驱动。当IC内部MOSFET导通时，驱动电流是从外部的VCC流经R pull-up ，MOSFET到GND。IC内部仅需很下的栅极驱动电流。</p>
<p><strong>控制输出高电平大小</strong><br>        可以利用改变上拉电源的电压，改变传输电平。<br><strong>（3）软件IIC和硬件IIC的区别</strong></p>
<p>软件IIC：软件IIC通信指的是用单片机的两个I/O端口模拟出来的IIC，用软件控制管脚状态以模拟I2C通信波形，软件模拟寄存器的工作方式。</p>
<p>硬件IIC：一块硬件电路，硬件I2C对应芯片上的I2C外设，有相应I2C驱动电路，其所使用的I2C管脚也是专用的，硬件（固件）I2C是直接调用内部寄存器进行配置。</p>
<p>硬件I2C的效率要远高于软件的，而软件I2C由于不受管脚限制，接口比较灵活。</p>
<h4 id="5-12C通信一般流程与软件模拟I2C协议"><a href="#5-12C通信一般流程与软件模拟I2C协议" class="headerlink" title="5.12C通信一般流程与软件模拟I2C协议"></a>5.12C通信一般流程与软件模拟I2C协议</h4><ul>
<li>主机发送起始位并进行从机寻址</li>
<li>得到应答后主机开始发送/读取数据位</li>
<li>数据发送/读取完成主机发送停止位结束此次通信</li>
</ul>
<p><strong>软件模式I2C协议</strong></p>
<p>实验目的</p>
<p>STM32作为主机向从机EEPROM存储器写入256个字节的数据<br>STM32作为主机向从机EEPROM存储器读取写入的256个字节的数据</p>
<p>读写成功亮绿灯，读写失败亮红灯</p>
<p>实验原理</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202407231358930.png" alt="61adc6161e3ff927ef13c791ad28d8ee"></p>
<p><strong>软件模式I2C由我们CPU来控制引脚产生I2C时序，所以我们随便选引脚都可以，不过你选择的引脚肯定要连接到通信的EEPROM的SCL,SDA引脚上。这里是用了PC12,PC11充当主机STM32SCL，SDA引脚。</strong></p>
<p><strong>主机产生起始信号</strong></p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202407231359310.png" alt="8bb2632fad2554a2d6bb8282364be13d"></p>
<p><strong>主机产生停止信号</strong></p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202407231359509.png" alt="d1477f39105680213a067d3a2dbb324d"></p>
<p><strong>主机产生应答信号或非应答信号</strong></p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202407231359140.png" alt="d89ca2888a7eab2fba91d8d6a02088e4"></p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202407231359249.png" alt="38a8f5e6563ec9ad3cb9f6d1568bc185"></p>
<p><strong>等待从机EEPROM应答</strong></p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202407231400193.png" alt="539b5331516a43156e65ec65a94b26b4"></p>
<p><strong>主机发送一个字节给从机</strong></p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202407231400949.png" alt="a426e4da5ae62647f3818f44616ef5f8"></p>
<p><strong>主机向EEPROM接收一个字节</strong></p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202407231400625.png" alt="95cd35cebf49d6a0f0348a55803001d9"></p>
<p><strong>value应该初始化为0</strong></p>
<p>i2c_gpio.h</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_I2C_GPIO_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_I2C_GPIO_H</span></span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EEPROM_I2C_WR</span>	<span class="token expression"><span class="token number">0</span>		</span><span class="token comment">/* 写控制bit */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EEPROM_I2C_RD</span>	<span class="token expression"><span class="token number">1</span>		</span><span class="token comment">/* 读控制bit */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EEPROM_GPIO_PORT_I2C</span>         <span class="token expression">GPIOB</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EEPROM_RCC_I2C_PORT</span>          <span class="token expression">RCC_APB2Periph_GPIOB</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EEPROM_I2C_SCL_PIN</span>           <span class="token expression">GPIO_Pin_6</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EEPROM_I2C_SDA_PIN</span>           <span class="token expression">GPIO_Pin_7</span></span>

<span class="token comment">/*当 STM32 的 GPIO 配置成开漏输出模式时，它仍然可以通过读取
GPIO 的输入数据寄存器获取外部对引脚的输入电平，也就是说它同时具有浮空输入模式的
功能*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">EEPROM_I2C_SCL_1</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>  EEPROM_GPIO_PORT_I2C<span class="token operator">-&gt;</span>BSRR <span class="token operator">|=</span> EEPROM_I2C_SCL_PIN		</span><span class="token comment">/* SCL = 1 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">EEPROM_I2C_SCL_0</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>  EEPROM_GPIO_PORT_I2C<span class="token operator">-&gt;</span>BRR  <span class="token operator">|=</span> EEPROM_I2C_SCL_PIN		</span><span class="token comment">/* SCL = 0 */</span></span>
	
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">EEPROM_I2C_SDA_1</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>  EEPROM_GPIO_PORT_I2C<span class="token operator">-&gt;</span>BSRR <span class="token operator">|=</span> EEPROM_I2C_SDA_PIN		</span><span class="token comment">/* SDA = 1 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">EEPROM_I2C_SDA_0</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>  EEPROM_GPIO_PORT_I2C<span class="token operator">-&gt;</span>BRR  <span class="token operator">|=</span> EEPROM_I2C_SDA_PIN		</span><span class="token comment">/* SDA = 0 */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">EEPROM_I2C_SDA_READ</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token punctuation">(</span>EEPROM_GPIO_PORT_I2C<span class="token operator">-&gt;</span>IDR <span class="token operator">&amp;</span> EEPROM_I2C_SDA_PIN<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span> <span class="token punctuation">)</span>	</span><span class="token comment">/* 读SDA口线状态 */</span></span>


<span class="token keyword">void</span> <span class="token function">i2c_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">i2c_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">i2c_Ack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">i2c_NAcK</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> <span class="token function">i2c_WaitAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">i2c_SendByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> <span class="token function">i2c_ReadByte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> <span class="token function">i2c_CheckDevice</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> Address<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  <span class="token comment">/* _I2C_GPIO_H */</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>i2c_gpio.c</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"i2c_gpio.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span>  <span class="token string">"stm32f10x.h"</span></span>

<span class="token keyword">void</span> <span class="token function">I2c_gpio_config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	GPIO_InitTypeDef  GPIO_InitStructure<span class="token punctuation">;</span>
	<span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>EEPROM_RCC_I2C_PORT<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_Out_OD<span class="token punctuation">;</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> EEPROM_I2C_SCL_PIN <span class="token operator">|</span> EEPROM_I2C_SDA_PIN<span class="token punctuation">;</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span>
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>EEPROM_GPIO_PORT_I2C<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">/* 给一个停止信号, 复位I2C总线上的所有设备到待机模式 */</span>
	<span class="token function">i2c_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">i2c_Delay</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token class-name">uint8_t</span> i<span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> <span class="token function">i2c_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">EEPROM_I2C_SCL_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">EEPROM_I2C_SDA_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">i2c_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">EEPROM_I2C_SDA_0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">i2c_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">EEPROM_I2C_SCL_0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">i2c_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">i2c_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">EEPROM_I2C_SDA_0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">EEPROM_I2C_SCL_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">i2c_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">EEPROM_I2C_SDA_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">i2c_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">i2c_Ack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">EEPROM_I2C_SCL_0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">i2c_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">EEPROM_I2C_SDA_0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">i2c_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">EEPROM_I2C_SCL_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">i2c_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">EEPROM_I2C_SCL_0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">i2c_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">EEPROM_I2C_SDA_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">i2c_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">i2c_NAcK</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">EEPROM_I2C_SDA_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">i2c_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">EEPROM_I2C_SCL_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">i2c_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">EEPROM_I2C_SCL_0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">i2c_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">i2c_WaitAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token class-name">uint8_t</span> ret<span class="token punctuation">;</span>
	<span class="token function">EEPROM_I2C_SDA_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">EEPROM_I2C_SCL_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">i2c_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">EEPROM_I2C_SDA_READ</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		ret<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
		ret<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">EEPROM_I2C_SCL_0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">i2c_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> ret<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
	

<span class="token keyword">void</span> <span class="token function">i2c_SendByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token class-name">uint8_t</span> i<span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> data<span class="token operator">&amp;</span><span class="token number">0x80</span> <span class="token punctuation">)</span>
	 <span class="token punctuation">{</span>
		  <span class="token function">EEPROM_I2C_SDA_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token punctuation">}</span>
	 <span class="token keyword">else</span>
	 <span class="token punctuation">{</span>
		  <span class="token function">EEPROM_I2C_SDA_0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token punctuation">}</span>
	 <span class="token function">i2c_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token function">EEPROM_I2C_SCL_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token function">i2c_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token function">EEPROM_I2C_SCL_0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token function">i2c_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token keyword">if</span><span class="token punctuation">(</span> i<span class="token operator">==</span><span class="token number">7</span> <span class="token punctuation">)</span>
	 <span class="token punctuation">{</span>
		 <span class="token function">EEPROM_I2C_SDA_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		 <span class="token function">i2c_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token punctuation">}</span>
	 data<span class="token operator">=</span>data<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
<span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">i2c_ReadByte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token class-name">uint8_t</span> value<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token class-name">uint8_t</span> i<span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		value<span class="token operator">=</span>value<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token function">EEPROM_I2C_SCL_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token function">i2c_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">EEPROM_I2C_SDA_READ</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
	  <span class="token punctuation">{</span>
	 	  value<span class="token operator">++</span><span class="token punctuation">;</span>
	  <span class="token punctuation">}</span>
	  <span class="token function">EEPROM_I2C_SCL_0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token function">i2c_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">i2c_CheckDevice</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> Address<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token class-name">uint8_t</span> ucACK<span class="token punctuation">;</span>
	<span class="token function">I2c_gpio_config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">i2c_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">i2c_SendByte</span><span class="token punctuation">(</span>Address<span class="token operator">|</span>EEPROM_I2C_WR<span class="token punctuation">)</span><span class="token punctuation">;</span>
	ucACK<span class="token operator">=</span><span class="token function">i2c_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">i2c_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> ucACK<span class="token punctuation">;</span>	
	
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>i2c_ee.h</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_I2C_EE_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_I2C_EE_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EEPROM_DEV_ADDR</span>			<span class="token expression"><span class="token number">0xA0</span>		</span><span class="token comment">/* 24xx02的设备地址 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EEPROM_PAGE_SIZE</span>		  <span class="token expression"><span class="token number">8</span>			  </span><span class="token comment">/* 24xx02的页面大小 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EEPROM_SIZE</span>				  <span class="token expression"><span class="token number">256</span>			  </span><span class="token comment">/* 24xx02总容量 */</span></span>

<span class="token class-name">uint8_t</span> <span class="token function">ee_Checkok</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span>  <span class="token function">ee_ReadByte</span><span class="token punctuation">(</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>pReaddata<span class="token punctuation">,</span><span class="token class-name">uint16_t</span> Address<span class="token punctuation">,</span><span class="token class-name">uint16_t</span> num <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span>  <span class="token function">ee_WriteByte</span><span class="token punctuation">(</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>Writepdata<span class="token punctuation">,</span><span class="token class-name">uint16_t</span> Address<span class="token punctuation">,</span><span class="token class-name">uint16_t</span> num <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> <span class="token function">ee_WaitStandby</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> <span class="token function">ee_WriteBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>_pWriteBuf<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> _usAddress<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> _usSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> <span class="token function">ee_ReadBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>_pReadBuf<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> _usAddress<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> _usSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> <span class="token function">ee_Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  <span class="token comment">/* _I2C_EE_H*/</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>i2c_ee.c</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"i2c_ee.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"i2c_gpio.h"</span></span>

<span class="token comment">//检测EEPORM是否忙碌</span>
<span class="token class-name">uint8_t</span> <span class="token function">ee_Checkok</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">i2c_CheckDevice</span><span class="token punctuation">(</span>EEPROM_DEV_ADDR<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
    <span class="token function">i2c_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
 	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>	
<span class="token comment">//检测EEPROM写入数完成</span>
<span class="token class-name">uint8_t</span> <span class="token function">ee_WaitStandby</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token class-name">uint32_t</span> wait_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">i2c_CheckDevice</span><span class="token punctuation">(</span>EEPROM_DEV_ADDR<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token comment">//若检测超过次数，退出循环</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>wait_count<span class="token operator">++</span><span class="token operator">&gt;</span><span class="token number">0xFFFF</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token comment">//等待超时</span>
			<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//等待完成</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">//向EEPROM写入多个字节</span>
<span class="token class-name">uint8_t</span> <span class="token function">ee_WriteBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>_pWriteBuf<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> _usAddress<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> _usSize<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token class-name">uint16_t</span> i<span class="token punctuation">,</span>m<span class="token punctuation">;</span>
	<span class="token class-name">uint16_t</span> addr<span class="token punctuation">;</span>
	addr<span class="token operator">=</span>_usAddress<span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>_usSize<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		  <span class="token comment">//当第一次或者地址对齐到8就要重新发起起始信号和EEPROM地址</span>
		  <span class="token comment">//为了解决8地址对齐问题</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>addr <span class="token operator">%</span> EEPROM_PAGE_SIZE<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span> <span class="token punctuation">)</span>
			<span class="token punctuation">{</span>
				 <span class="token comment">//循环发送起始信号和EEPROM地址的原因是为了等待上一次写入的一页数据\
				写入完成</span>
				 <span class="token keyword">for</span><span class="token punctuation">(</span>m<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>m<span class="token operator">&lt;</span><span class="token number">1000</span><span class="token punctuation">;</span>m<span class="token operator">++</span><span class="token punctuation">)</span>
				 <span class="token punctuation">{</span>
					 <span class="token comment">//发送起始地址</span>
					 <span class="token function">i2c_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					 <span class="token comment">//发送设备写地址</span>
					 <span class="token function">i2c_SendByte</span><span class="token punctuation">(</span>EEPROM_DEV_ADDR<span class="token operator">|</span>EEPROM_I2C_WR<span class="token punctuation">)</span><span class="token punctuation">;</span>
					 <span class="token comment">//等待从机应答</span>
					 <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">i2c_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span> <span class="token punctuation">)</span>
					 <span class="token punctuation">{</span>
						<span class="token keyword">break</span><span class="token punctuation">;</span>
					 <span class="token punctuation">}</span>
				 <span class="token punctuation">}</span> 
				  <span class="token comment">//若等待的1000次从机还未应答，等待超时</span>
				  <span class="token keyword">if</span><span class="token punctuation">(</span> m<span class="token operator">==</span><span class="token number">1000</span> <span class="token punctuation">)</span>
			  	<span class="token punctuation">{</span>
					<span class="token keyword">goto</span> cmd_fail<span class="token punctuation">;</span>
			   	<span class="token punctuation">}</span>	
				<span class="token comment">//EEPROM应答后发送EEPROM的内部存储器地址</span>
				<span class="token function">i2c_SendByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">//等待从机应答</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">i2c_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span> <span class="token punctuation">)</span>
				<span class="token punctuation">{</span>
					<span class="token keyword">goto</span> cmd_fail<span class="token punctuation">;</span>
					
				<span class="token punctuation">}</span>	
			<span class="token punctuation">}</span>
		 <span class="token comment">//发送数据</span>
		 <span class="token function">i2c_SendByte</span><span class="token punctuation">(</span>_pWriteBuf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		 <span class="token comment">//等待应答</span>
	   <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">i2c_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span> <span class="token punctuation">)</span>
	   <span class="token punctuation">{</span>
		  <span class="token keyword">goto</span> cmd_fail<span class="token punctuation">;</span>			
     <span class="token punctuation">}</span>
		 <span class="token comment">//写入地址加1</span>
		 addr<span class="token operator">++</span><span class="token punctuation">;</span>		
	<span class="token punctuation">}</span>
	
	<span class="token function">i2c_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	
	cmd_fail<span class="token operator">:</span>
	<span class="token function">i2c_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token class-name">uint8_t</span> <span class="token function">ee_ReadBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>_pReadBuf<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> _usAddress<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> _usSize<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token class-name">uint16_t</span> i<span class="token punctuation">;</span>
	
	  <span class="token function">i2c_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">i2c_SendByte</span><span class="token punctuation">(</span>EEPROM_DEV_ADDR<span class="token operator">|</span>EEPROM_I2C_WR<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">i2c_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span> <span class="token punctuation">)</span>
	 <span class="token punctuation">{</span>
			 <span class="token keyword">goto</span> cmd_fail<span class="token punctuation">;</span>		
	  <span class="token punctuation">}</span>
		<span class="token function">i2c_SendByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span>_usAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">i2c_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span> <span class="token punctuation">)</span>
	 <span class="token punctuation">{</span>
			  <span class="token keyword">goto</span> cmd_fail<span class="token punctuation">;</span>
	  <span class="token punctuation">}</span>
		<span class="token function">i2c_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">i2c_SendByte</span><span class="token punctuation">(</span>EEPROM_DEV_ADDR<span class="token operator">|</span>EEPROM_I2C_RD<span class="token punctuation">)</span><span class="token punctuation">;</span>
		 <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">i2c_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span> <span class="token punctuation">)</span>
		 <span class="token punctuation">{</span>
				  <span class="token keyword">goto</span> cmd_fail<span class="token punctuation">;</span>				
	   <span class="token punctuation">}</span>
	 <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>_usSize<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>	
		_pReadBuf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">i2c_ReadByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">/* 每读完1个字节后，需要发送Ack， 最后一个字节不需要Ack，发Nack */</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">!=</span> _usSize <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
<span class="token comment">//			i2c_NAcK();	/* 最后1个字节读完后，CPU产生NACK信号(驱动SDA = 1) */</span>
			<span class="token function">i2c_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">/* 中间字节读完后，CPU产生ACK信号(驱动SDA = 0) */</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{</span>
			<span class="token function">i2c_NAcK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">/* 最后1个字节读完后，CPU产生NACK信号(驱动SDA = 1) */</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token function">i2c_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	
	cmd_fail<span class="token operator">:</span>
	<span class="token function">i2c_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">ee_Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
  <span class="token class-name">uint16_t</span> i<span class="token punctuation">;</span>
	<span class="token class-name">uint8_t</span> write_buf<span class="token punctuation">[</span>EEPROM_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token class-name">uint8_t</span> read_buf<span class="token punctuation">[</span>EEPROM_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
  
<span class="token comment">/*-----------------------------------------------------------------------------------*/</span>  
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">i2c_CheckDevice</span><span class="token punctuation">(</span>EEPROM_DEV_ADDR<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token comment">/* 没有检测到EEPROM */</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"没有检测到串行EEPROM!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token comment">/*------------------------------------------------------------------------------------*/</span>  
  <span class="token comment">/* 填充测试缓冲区 */</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> EEPROM_SIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>		
		write_buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token comment">/*------------------------------------------------------------------------------------*/</span>  
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ee_WriteBytes</span><span class="token punctuation">(</span>write_buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> EEPROM_SIZE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"写EEPROM出错！\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>		
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"写EEPROM成功！\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>  

<span class="token comment">/*-----------------------------------------------------------------------------------*/</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ee_ReadBytes</span><span class="token punctuation">(</span>read_buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> EEPROM_SIZE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"EEPROM出错！\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>		
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"EEPROM成功，数据如下：\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token comment">/*-----------------------------------------------------------------------------------*/</span>  
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> EEPROM_SIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>read_buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> write_buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"0x%02X "</span><span class="token punctuation">,</span> read_buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"错误:EEPROM读出与写入的数据不一致"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">" %02X"</span><span class="token punctuation">,</span> read_buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">&amp;</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">15</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
		<span class="token punctuation">}</span>		
	<span class="token punctuation">}</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"EEPROM读写测试成功\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>main</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"led.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span>  <span class="token string">"usart.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span>  <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"i2c_ee.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"i2c_gpio.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SOFT_DELAY</span> <span class="token expression"><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">0x0FFFFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>

<span class="token keyword">void</span> <span class="token function">Delay</span><span class="token punctuation">(</span>__IO u32 nCount<span class="token punctuation">)</span><span class="token punctuation">;</span> 


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>	

	<span class="token comment">/* LED 端口初始化 */</span>
	<span class="token function">LED_GPIO_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	

  <span class="token comment">/*初始化USART 配置模式为 115200 8-N-1，中断接收*/</span>
  <span class="token function">USART_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"EEPROM 软件模拟i2c测试例程 \r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		
	 
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">ee_Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
  	<span class="token punctuation">{</span>
			<span class="token function">LED_G</span><span class="token punctuation">(</span>NO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
      <span class="token function">LED_R</span><span class="token punctuation">(</span>NO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	 
<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>  
<span class="token punctuation">}</span>
	
  <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Delay</span><span class="token punctuation">(</span>__IO <span class="token class-name">uint32_t</span> nCount<span class="token punctuation">)</span>	 <span class="token comment">//简单的延时函数</span>
<span class="token punctuation">{</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span> nCount <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span> nCount<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="六、SPI协议（全双工、速度快）"><a href="#六、SPI协议（全双工、速度快）" class="headerlink" title="六、SPI协议（全双工、速度快）"></a>六、SPI协议（全双工、速度快）</h3><h4 id="1-SPI简介"><a href="#1-SPI简介" class="headerlink" title="1.SPI简介"></a>1.SPI简介</h4><p>SPI是串行外设接口，也是一种单片机外设芯片串行扩展接口，是一种高速、全双工、同步通信总线，所以可以在同一时间发送和接收数据，SPI没有定义速度限制，通常能达到甚至超过10M/bps。</p>
<p>SPI有主、从两种模式，通常由一个主模块和一个或多个从模块组成（SPI不支持多主机），主模块选择一个从模块进行同步通信，从而完成数据的交换。提供时钟的为主设备（Master），接收时钟的设备为从设备（Slave），SPI接口的读写操作，都是由主设备发起，当存在多个从设备时，通过各自的片选信号进行管理。</p>
<ul>
<li>MISO：Master input slave output 主机输入，从机输出（数据来自从机）；</li>
<li>MOSI：Master output slave input 主机输出，从机输入（数据来自主机）；</li>
<li>SCLK ：Serial Clock 串行时钟信号，由主机产生发送给从机；</li>
<li>SS：Slave Select 片选信号，由主机发送，以控制与哪个从机通信，通常是低电平有效信号。</li>
</ul>
<p>SPI主设备和从设备都有一个串行移位寄存器，主设备通过向它的SPI串行寄存器写入一个字节来发起一次传输。</p>
<h4 id="2-SPI数据通信的流程"><a href="#2-SPI数据通信的流程" class="headerlink" title="2.SPI数据通信的流程"></a>2.SPI数据通信的流程</h4><ul>
<li>1、主设备发起信号，将CS/SS拉低，启动通信。</li>
<li>2、主设备通过发送时钟信号，来告诉从设备进行写数据或者读数据操作（采集时机可能是时钟信号的上升沿（从低到高）或下降沿（从高到低），因为SPI有四种模式，后面会讲到），它将立即读取数据线上的信号，这样就得到了一位数据（1bit）。</li>
<li>3、主机（Master）将要发送的数据写到发送数据缓存区（Menory），缓存区经过移位寄存器（缓存长度不一定，看单片机配置），串行移位寄存器通过MOSI信号线将字节一位一位的移出去传送给从机，同时MISO接口接收到的数据经过移位寄存器一位一位的移到接收缓存区。</li>
<li>4、从机（Slave）也将自己的串行移位寄存器（缓存长度不一定，看单片机配置）中的内容通过MISO信号线返回给主机。同时通过MOSI信号线接收主机发送的数据，这样，两个移位寄存器中的内容就被交换。</li>
</ul>
<p>SPI只有主模式和从模式之分，没有读和写的说法，外设的写操作和读操作是同步完成的。若只进行写操作，主机只需忽略接收到的字节（虚拟数据）；反之，若主机要读取从机的一个字节，就必须发送一个空字节来引发从机的传输。也就是说，你发一个数据必然会收到一个数据；你要收一个数据必须也要先发一个数据。</p>
<h4 id="3-SPI时钟特点"><a href="#3-SPI时钟特点" class="headerlink" title="3.SPI时钟特点"></a>3.SPI时钟特点</h4><p>主要包括：时钟速率、时钟极性和时钟相位三方面。</p>
<p><strong>时钟速率</strong></p>
<p>SPI总线上的主设备必须在通信开始时候配置并生成相应的时钟信号。从理论上讲，只要实际可行，时钟速率就可以是你想要的任何速率，当然这个速率受限于每个系统能提供多大的系统时钟频率，以及最大的SPI传输速率。</p>
<p><strong>时钟极性</strong></p>
<p>根据硬件制造商的命名规则不同，时钟极性通常写为CKP或CPOL。时钟极性和相位共同决定读取数据的方式，比如信号上升沿读取数据还是信号下降沿读取数据。</p>
<p>CKP可以配置为1或0。可以根据需要将时钟的默认状态（IDLE）设置为高或低。极性反转可以通过简单的逻辑逆变器实现</p>
<ul>
<li>CKP = 0：时钟空闲IDLE为低电平 0；</li>
<li>CKP = 1：时钟空闲IDLE为高电平1。</li>
</ul>
<p><strong>时钟相位</strong></p>
<p>根据硬件制造商的不同，时钟相位通常写为CKE或CPHA。顾名思义，时钟相位/边沿，也就是采集数据时是在时钟信号的具体相位或者边沿；</p>
<ul>
<li>CKE = 0：在时钟信号SCK的第一个跳变沿采样；</li>
<li>CKE = 1：在时钟信号SCK的第二个跳变沿采样。</li>
</ul>
<h4 id="4-SPI四种MODE"><a href="#4-SPI四种MODE" class="headerlink" title="4.SPI四种MODE"></a>4.SPI四种MODE</h4><p>除了配置串行时钟速率（频率）外，SPI主设备还需要配置时钟极性和时钟相位。</p>
<p><strong>时钟极性 CKP/Clock Polarit</strong></p>
<p>根据硬件制造商的命名规则不同，时钟极性通常写为CKP或CPOL。时钟极性和相位共同决定读取数据的方式，比如信号上升沿读取数据还是信号下降沿读取数据；</p>
<p>CKP可以配置为1或0。这意味着您可以根据需要将时钟的默认状态（IDLE）设置为高或低。极性反转可以通过简单的逻辑逆变器实现。您必须参考设备的数据手册才能正确设置CKP和CKE。CKP = 0：时钟空闲IDLE为低电平 0；<br>CKP = 1：时钟空闲IDLE为高电平1；</p>
<p><strong>时钟相位 CKE /Clock Phase (Edge)</strong></p>
<p>除配置串行时钟速率和极性外，SPI主设备还应配置时钟相位（或边沿）。根据硬件制造商的不同，时钟相位通常写为CKE或CPHA；</p>
<p>顾名思义，时钟相位/边沿，也就是采集数据时是在时钟信号的具体相位或者边沿；</p>
<ul>
<li>CKE = 0：在时钟信号SCK的第一个跳变沿采样；</li>
<li>CKE = 1：在时钟信号SCK的第二个跳变沿采样；</li>
</ul>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202407231204625.png" alt="d5e56155435a4edeb89f38a268cba3cf-1"></p>
<p>此处附上一组软件模拟SPI 通信传输数据的代码</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//SPI发送数据，val为要发送的数据</span>
<span class="token keyword">void</span> <span class="token function">SPI_Send</span><span class="token punctuation">(</span>u8 val<span class="token punctuation">)</span>  
<span class="token punctuation">{</span> 
 
	u8 recv_data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//将接受数据清零方便直接或运算接受数据</span>
	
	SCK <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//时钟线拉低</span>
 
	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token comment">//传输数据，先发高位</span>
	<span class="token punctuation">{</span>
		<span class="token comment">//准备数据</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>val  <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token operator">-</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//通过1左移7位然后相与,判断数据最高位是1还是0</span>
		<span class="token punctuation">{</span>
			MOSI <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//数据为1</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{</span>
			MOSI <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//数据为0</span>
		<span class="token punctuation">}</span>
		<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		SCK <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//时钟线拉高准备接收数据</span>
		<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
		<span class="token comment">//高电平区间接收数据，此处不重要但必须有</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>MISO <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>	<span class="token comment">//收到的为1</span>
		<span class="token punctuation">{</span>
			recv_data <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token operator">-</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将数据位通过或运算保存。先保持高位</span>
		<span class="token punctuation">}</span>
		SCK <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//时钟线拉低</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
 
<span class="token comment">//SPI接收数据</span>
u8 <span class="token function">SPI_Receive</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>  
<span class="token punctuation">{</span> 
	u8 recv_data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	
<span class="token comment">//	u8 val = 0x00;</span>
	
	RC522_SCK <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token comment">//发送数据，此处不重要但必须有</span>
	<span class="token punctuation">{</span>
		<span class="token comment">//准备数据</span>
<span class="token comment">//		if(val  &amp; (1&lt;&lt;(7-i))) //1</span>
<span class="token comment">//		{</span>
<span class="token comment">//			MOSI = 1; //数据为1</span>
<span class="token comment">//		}</span>
<span class="token comment">//		else</span>
<span class="token comment">//		{</span>
<span class="token comment">//			MOSI = 0; //数据为0</span>
<span class="token comment">//		}</span>
		
        MOSI <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//输出线清零</span>
		<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		SCK <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//时钟线拉高准备接收数据</span>
		<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
		<span class="token comment">//高电平区间接收数据</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>MISO <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>	<span class="token comment">//收到的为1</span>
		<span class="token punctuation">{</span>
			recv_data <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token operator">-</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将数据位通过或运算保存。先保持高位</span>
		<span class="token punctuation">}</span>
 
		SCK <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> recv_data<span class="token punctuation">;</span> <span class="token comment">//返回接收到的数据</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="5-数据传输流程代码"><a href="#5-数据传输流程代码" class="headerlink" title="5.数据传输流程代码"></a>5.数据传输流程代码</h4><p>首先主机和从机都选择同一传输模式。然后主机片选拉低，选中从机。接着在时钟的驱动下， MOSI发送数据，同时MISO读取接收数据。最后完成传输，取消片选。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"> <span class="token comment">/*
* 函数名： void SPI_WriteByte(uint8_t data)
* 输入参数： data -&gt; 要写的数据
* 输出参数：无  
* 返回值：无
* 函数作用：模拟 SPI 写一个字节
*/</span> SPI写<span class="token number">1</span> Byte，循环<span class="token number">8</span>次，每次发送<span class="token number">1</span> Bit；
<span class="token keyword">void</span> <span class="token function">SPI_WriteByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span>  <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
    <span class="token class-name">uint8_t</span> temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        temp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token operator">&amp;</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">//将data最高位保存到temp；</span>
        data <span class="token operator">=</span> data<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">;</span>                   <span class="token comment">//data左移一位，将次高位变为最高位，用于下次取最高位；</span>
        <span class="token function">SPI_CLK</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//CPOL=0              //拉低时钟，即空闲时钟为低电平， CPOL=0；</span>
        <span class="token function">SPI_MOSI</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">//根据temp值，设置MOSI引脚的电平；</span>
        <span class="token function">SPI_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment">//简单延时，可以定时器或延时函数实现</span>
        <span class="token function">SPI_CLK</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//CPHA=0  //拉高时钟， W25Q64只支持SPI模式0或1，即会在时钟上升沿采样MOSI数据；</span>
        <span class="token function">SPI_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
     <span class="token punctuation">}</span>
     <span class="token function">SPI_CLK</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                          <span class="token comment">//最后SPI发送完后，拉低时钟，进入空闲状态；</span>
<span class="token punctuation">}</span>
 
<span class="token comment">/*
* 函数名： uint8_t SPI_ReadByte(void)
* 输入参数：
* 输出参数：无
* 返回值：读到的数据
* 函数作用：模拟 SPI 读一个字节
*/</span>  SPI读<span class="token number">1</span> Byte，循环<span class="token number">8</span>次，每次接收<span class="token number">1</span> Bit；  
<span class="token class-name">uint8_t</span> <span class="token function">SPI_ReadByte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> read_data <span class="token operator">=</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        read_data <span class="token operator">=</span> read_data <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">//“腾空” read_data最低位，8次循环后，read_data将高位在前；  </span>
        <span class="token function">SPI_CLK</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">//拉低时钟，即空闲时钟为低电平；  </span>
        <span class="token function">SPI_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">SPI_CLK</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">SPI_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SPI_MISO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
           read_data <span class="token operator">=</span> read_data <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">SPI_CLK</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//最后SPI读取完后，拉低时钟，进入空闲状态  </span>
    <span class="token keyword">return</span> read_data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>前面提到SPI传输可以看作一个虚拟的环形拓扑结构，即输入和输出同时进行。在前面“ SPI_WriteByte()”函数里，发送了1 Byte，也应该接收1 Byte，只是代码中忽略了接收引脚MISO的状态； 在前面“ SPI_ReadByte()”函数里，接收了1 Byte，也应该发送1 Byte，只是代码中忽略了发送引脚MOSI的内容。有些场景， SPI需要同时读写，因此还需要编写SPI同时读写函数。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
* 函数名： uint8_t SPI_WriteReadByte(uint8_t data)
* 输入参数： data -&gt; 要写的一个字节数据
* 输出参数：无
* 返回值：读到的数据
* 函数作用：模拟 SPI 读写一个字节
SPI读和写1 Byte，循环8次，每次发送和接收1 Bit；  */</span>
<span class="token class-name">uint8_t</span> <span class="token function">SPI_WriteReadByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> read_data <span class="token operator">=</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        temp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token operator">&amp;</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//将data最高位保存到temp；  </span>
        data <span class="token operator">=</span> data<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">;</span>                  <span class="token comment">//data左移一位，将次高位变为最高位，用于下次取最高位；  </span>
        read_data <span class="token operator">=</span> read_data<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token comment">//“腾空” read_data最低位，8次循环后，read_data将高位在前；  </span>
        <span class="token function">SPI_CLK</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">SPI_MOSI</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">SPI_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">SPI_CLK</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">SPI_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SPI_MISO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>             <span class="token comment">//读取MISO上的数据，保存到当前read_data最低位；  </span>
            read_data <span class="token operator">=</span> read_data <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">SPI_CLK</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> read_data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="6-SPI优缺点"><a href="#6-SPI优缺点" class="headerlink" title="6.SPI优缺点"></a>6.SPI优缺点</h4><p><strong>优点：</strong></p>
<ul>
<li>无起始位和停止位，因此数据位可以连续传输而不会被中断；</li>
<li>没有像I2C这样复杂的从设备寻址系统；</li>
<li>数据传输速率比I2C更高（几乎快两倍）；</li>
<li>分离的MISO和MOSI信号线，因此可以同时发送和接收数据；</li>
<li>极其灵活的数据传输，不限于8位，它可以是任意大小的字；</li>
<li>非常简单的硬件结构。从站不需要唯一地址（与I2C不同）。从机使用主机时钟，不需要精密时钟振荡器/晶振（与UART不同）。不需要收发器（与CAN不同）。</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>使用四根信号线（I2C和UART使用两根信号线）；</li>
<li>无法确认是否已成功接收数据（I2C拥有此功能）；</li>
<li>没有任何形式的错误检查，如UART中的奇偶校验位；</li>
<li>只允许一个主设备；</li>
<li>没有硬件从机应答信号（主机可能在不知情的情况下无处发送）；</li>
<li>没有定义硬件级别的错误检查协议；</li>
<li>与RS-232和CAN总线相比，只能支持非常短的距离。</li>
</ul>
<h3 id="七、三种通讯方式区别"><a href="#七、三种通讯方式区别" class="headerlink" title="七、三种通讯方式区别"></a>七、三种通讯方式区别</h3><p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202407231408067.png" alt="623c99072ef941b1adadc101d0c0b8cf"></p>
<ul>
<li>SPI（Serial Peripheral Interface）是一种同步的串行通信协议，需要4根线：MISO、MOSI、SCLK和CS。SPI通信速度快，但只能在短距离内通信，且只能支持单主设备和多从设备的通信方式。</li>
<li>IIC（Inter-Integrated Circuit）是一种同步的串行通信协议，需要2根线：SCL和SDA。IIC通信速度较慢，但可以在长距离内通信，且可以支持多主设备和多从设备的通信方式。</li>
<li>UART（Universal Asynchronous Receiver/Transmitter）是一种异步的串行通信协议，需要2根线：TX和RX。UART通信速度较慢，但可以在长距离内通信，且可以支持点对点的通信方式。</li>
</ul>
<h2 id="6-设备树相关知识"><a href="#6-设备树相关知识" class="headerlink" title="6.设备树相关知识"></a>6.设备树相关知识</h2><p>原文链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_44814825/article/details/129107911">拉依达的嵌入式小屋</a></p>
<p>原文链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/2301_76655007/article/details/137589606">嵌功尽弃</a></p>
<h3 id="6-1-设备树的定义"><a href="#6-1-设备树的定义" class="headerlink" title="6.1 设备树的定义"></a>6.1 设备树的定义</h3><p><code>Device Tree</code>是一种描述硬件的数据结构，以便于操作系统的内核可以管理和使用这些硬件，包括CPU或CPU，内存，总线和其他一些外设。</p>
<p>Linux内核从3.x版本之后开始支持使用设备树，可以实现驱动代码与设备的硬件信息相互的隔离，减少了代码中的耦合性</p>
<ul>
<li>引入设备树之前：一些与硬件设备相关的具体信息都要写在驱动代码中，如果外设发生相应的变化，那么驱动代码就需要改动。</li>
<li>引入设备树之后：通过设备树对硬件信息的抽象，驱动代码只要负责处理逻辑，而关于设备的具体信息存放到设备树文件中。如果只是硬件接口信息的变化而没有驱动逻辑的变化，开发者只需要修改设备树文件信息，不需要改写驱动代码。</li>
</ul>
<p>描述设备树的文件叫做 DTS(Device Tree Source) ，这个 DTS 文件采用树形结构描述板级设备，也就是开发板上的设备信息，比如 CPU 数量、 内存基地址、 IIC 接口上接了哪些设备、 SPI 接口上接了哪些设备等等，如图</p>
<img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202407291409965.png" alt="9bd28993f265d7533e642b701e2a19b6" style="zoom: 80%;">

<p>树的主干就是系统总线，IIC 控制器、 GPIO 控制器、 SPI 控制器等都是接 到系统主线上的分支。 IIC 控制器有分为 IIC1 和 IIC2 两种，其中 IIC1 上接了 FT5206 和 AT24C02 这两个 IIC 设备， IIC2 上只接了 MPU6050 这个设备。 DTS 文件的主要功能就是按照图所示的结构来描述板子上的设备信息， DTS 文件描述设备信息是有相应的语法规则要求的。 </p>
<h3 id="6-2-DTS、DTB和DTC"><a href="#6-2-DTS、DTB和DTC" class="headerlink" title="6.2 DTS、DTB和DTC"></a>6.2 DTS、DTB和DTC</h3><p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202407291414570.png" alt="08ccae554e82fb18fc2b2e1cc12d1af0"></p>
<ul>
<li>DTS<ul>
<li>设备树源码文件，硬件的相应信息都会写在.dts为后缀的文件中，每一款硬件可以单独写一份xxxx.dts</li>
</ul>
</li>
<li>DTSI<ul>
<li>对于一些相同的dts配置可以抽象到dtsi文件中，然后可以用include的方式到dts文件中</li>
<li>同一芯片可以做一个dtsi，不同的板子不同的dts，然后include同一dtsi</li>
<li>对于同一个节点的设置情况，dts中的配置会覆盖dtsi中的配置</li>
</ul>
</li>
<li>DTC<ul>
<li>dtc是编译dts的工具</li>
</ul>
</li>
<li>DTB<ul>
<li>dts经过dtc编译之后会得到dtb文件，设备树的二进制执行文件</li>
<li>dtb通过Bootloader引导程序加载到内核。</li>
</ul>
</li>
</ul>
<p>通过make dtbs编译所有的dts文件。如果要编译指定的dtbs</p>
<pre class="line-numbers language-none"><code class="language-none">make xxx.dtb<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h3 id="6-3-设备树框架"><a href="#6-3-设备树框架" class="headerlink" title="6.3 设备树框架"></a>6.3 设备树框架</h3><h4 id="6-3-1-dtsi-头文件"><a href="#6-3-1-dtsi-头文件" class="headerlink" title="6.3.1 dtsi 头文件"></a>6.3.1 dtsi 头文件</h4><p>设备树也有头文件，扩展名为<code>.dtsi</code>。可以将一款SOC的其他所有设备/平台的共有的信息提出来，作为一个通用的.dtsi文件。 在<code>.dts</code> 设备树文件中，可以通过 “ <code>#include</code> ”来引用 <code>.h</code> 、 <code>.dtsi</code> 和 <code>.dts</code> 文件。只是，我们在编写设备树头文件的时候最好选择 <code>.dtsi</code> 后 缀。    一般.dtsi 文件用于描述 SOC 的内部外设信息，比如 CPU 架构、主频、外设寄存器地址范围，比如 UART 、 IIC 等等。</p>
<ul>
<li>1)后缀名一般为dts和dtsi，可以被include，甚至可以include那些C语言的头文件</li>
<li>2)dtsi一般写soc共性部分，而dts一般写目标单板特性部分，所以一般dts包含并重写部分dtsi</li>
<li>3)注释用/* */，注意#开头的不是注释</li>
<li>4)分号是段落块之间的分隔符，丹和[]是段落块的封装符号，和C语言语言类似</li>
<li>5)/dts-v1/节点，表示dts的版本号，目前都是v1</li>
<li>6)/{}是根节点root node，理论上只应该有一个根节点，有说法dtc会合并所有<code>root node</code>为同一个</li>
<li>7)dts是树状的多节点组织，基本单元是node，除root外其他node都有parent，还可以有child</li>
</ul>
<h4 id="6-3-2-设备节点格式"><a href="#6-3-2-设备节点格式" class="headerlink" title="6.3.2 设备节点格式"></a>6.3.2 设备节点格式</h4><p>设备树是采用树形结构来描述板子上的设备信息的文件，<strong>每个设备都是一个节点，叫做设备节点</strong>，</p>
<p>每个节点都通过一些属性信息来描述节点信息，<strong>属性就是键—值对</strong>。</p>
<p><strong>(1)格式定义</strong></p>
<pre class="line-numbers language-none"><code class="language-none">[label:] &lt;node-name&gt;[@&lt;unit-address&gt;]{
	[property]
	[child nodes]
	[child nodes]
	. . .
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>(2)格式解读</strong></p>
<ul>
<li>[ ]: 表示该项可以省略，&lt;&gt;表示不可省略</li>
<li>[label] :标签，为了方便访问节点，后面可以直接通过&amp;label来访问该节点。 </li>
<li>node-name: 节点名称。根节点的名称必须是</li>
<li>[@unit-address]: 地址，如cpu node就是0、1这种，reg node就是0x12010000这种。设备的地址或寄存器首地址，若某个节点没有地址或者寄存器，可以省略</li>
</ul>
<p><strong>(3)设备树源码中常用的几种数据形式</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token number">1.</span>字符串<span class="token operator">:</span>  compatible <span class="token operator">=</span> <span class="token string">"arm,cortex-a7"</span><span class="token punctuation">;</span>设置 compatible 属性的值为字符串“arm<span class="token punctuation">,</span>cortex<span class="token operator">-</span>a7”
<span class="token number">2.32</span>位无符号整数：reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span> 设置reg属性的值为<span class="token number">0</span><span class="token punctuation">,</span>   reg 的值也可以设置为一组值，比如： reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span> <span class="token number">0x123456</span> <span class="token number">100</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">3.</span>字符串列表：字符串和字符串之间采用“<span class="token punctuation">,</span>”隔开
compatible <span class="token operator">=</span> <span class="token string">"fsl,imx6ull-gpmi-nand"</span><span class="token punctuation">,</span> <span class="token string">"fsl, imx6ul-gpmi-nand"</span><span class="token punctuation">;</span>
设置属性 compatible 的值为“fsl<span class="token punctuation">,</span>imx6ull<span class="token operator">-</span>gpmi<span class="token operator">-</span>nand”和“fsl<span class="token punctuation">,</span> imx6ul<span class="token operator">-</span>gpmi<span class="token operator">-</span>nand”。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>属性</p>
<ul>
<li><p><code>compatible</code>属性（兼容属性）<br><code>cpp "manufacturer,model" manufacturer：厂商名称 model：模块对应的驱动名字</code><br>例：<br>imx6ull-alientekemmc.dts 中 sound 节点是 音频设备节点，采用的欧胜(WOLFSON)出品的 WM8960， sound 节点的 compatible 属性值如下：<br><code>cpp compatible = "fsl,imx6ul-evk-wm8960","fsl,imx-audio-wm8960";</code><br>属性值有两个，分别为<code>“fsl,imx6ul-evk-wm8960”</code>和“<code>fsl,imx-audio-wm8960”</code>，其中“fsl”表示厂商是飞思卡尔，“imx6ul-evk-wm8960”和“imx-audio-wm8960”表示驱动模块名字。</p>
<p>sound这个设备<strong>首先使用第一个兼容值在 Linux 内核里面查找</strong>，看看能不能找到与之匹配的驱动文件，<strong>如果没有找到的话就使用第二个兼容值查</strong>。	</p>
<p>一般驱动程序文件会有一个 <strong>OF 匹配表</strong>，此 OF 匹配表<strong>保存着一些 compatible 值</strong>，如果<strong>设备节点的 compatible 属性值和 OF 匹配表中的任何一个值相等</strong>，那么就表示<strong>设备可以使用这个驱动</strong>。</p>
<p><strong>在根节点来说，Linux 内核会通过根节点的 <code>compoatible</code> 属性查看是否支持此设备</strong>，如果支持的话设备就会启动 Linux 内核。如果不支持的话那么这个设备就没法启动 Linux 内核。</p>
</li>
<li><p><code>model</code>属性<br>model 属性值是一个字符串，一般 model 属性描述设备模块信息。比如名字什么的，比如： <code>model = "wm8960-audio";</code> </p>
</li>
<li><p><code>status</code>属性<br>status 属性和设备状态有关的， status 属性值是字符串，描述设备的状态信息。</p>
<table>
<thead>
<tr>
<th>值</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>“okay</td>
<td>表明设备是可操作的</td>
</tr>
<tr>
<td>“disabled”</td>
<td>表明设备当前是不可操作的，但是在未来可以变为可操作的，比如热插拔设备插入以后</td>
</tr>
<tr>
<td>“fail”</td>
<td>表明设备不可操作，设备检测到了一系列的错误，而且设备也不大可能变得可操作</td>
</tr>
<tr>
<td>“fail-sss</td>
<td>含义和“fail”相同，sss 部分是检测到的错误内容</td>
</tr>
</tbody></table>
</li>
<li><p><code>#address-cells</code> 和<code>#size-cells</code> 属性</p>
<p>用于描述子节点的地址信息,reg属性的address 和 length的字长。</p>
<ul>
<li><code>#address-cells</code> 属性值决定了子节点 <code>reg</code> 属性中地址信息所占用的字长(32 位)，</li>
<li><code>#size-cells</code> 属性值决定了子节点 <code>reg</code> 属性中长度信息所占的字长(32 位)。</li>
<li>子节点的地址信息描述来自于父节点的<code>#address-cells</code> 和<code>#size-cells</code>的值，而不是该节点本身的值（当前节点的信息是描述子节点的，自己的信息在父节点里）</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//每个“address length”组合表示一个地址范围，</span>
<span class="token comment">//其中 address 是起始地址， length 是地址长度，</span>
<span class="token comment">//#address-cells 表明 address 这个数据所占用的字长，</span>
<span class="token comment">// #size-cells 表明 length 这个数据所占用的字长.</span>
reg <span class="token operator">=</span> <span class="token operator">&lt;</span>address1 length1 address2 length2 address3 length3……<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>



</li>
<li><p><code>reg</code>属性<br>reg 属性一般用于<strong>描述设备地址空间资源信息</strong>，一般都是某个外设的寄存器地址范围信息, reg 属性的值一般是(address， length)对.</p>
<p>例</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">uart1<span class="token operator">:</span> serial@<span class="token number">02020000</span> <span class="token punctuation">{</span>
    compatible <span class="token operator">=</span> <span class="token string">"fsl,imx6ul-uart"</span><span class="token punctuation">,</span>
        <span class="token string">"fsl,imx6q-uart"</span><span class="token punctuation">,</span> <span class="token string">"fsl,imx21-uart"</span><span class="token punctuation">;</span>
    reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x02020000</span> <span class="token number">0x4000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span>GIC_SPI <span class="token number">26</span> IRQ_TYPE_LEVEL_HIGH<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    clocks <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>clks IMX6UL_CLK_UART1_IPG<span class="token operator">&gt;</span><span class="token punctuation">,</span>
        <span class="token operator">&lt;</span><span class="token operator">&amp;</span>clks IMX6UL_CLK_UART1_SERIAL<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    clock<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"ipg"</span><span class="token punctuation">,</span> <span class="token string">"per"</span><span class="token punctuation">;</span>
    status <span class="token operator">=</span> <span class="token string">"disabled"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>uart1</code> 的父节点 <code>aips1: aips-bus@02000000</code> 设置了#address-cells = &lt;1&gt;、 #sizecells = &lt;1&gt;，因此 reg 属性中address=0x02020000， length=0x4000。都是字长为1.</p>
</li>
<li><p><code>ranges</code>属性</p>
<ul>
<li>ranges属性值可以为<strong>空</strong>或者**按照( child-bus-address , parent-bus-address , length )**格式编写的数字</li>
<li>ranges 是一个<strong>地址映射/转换表</strong>， ranges 属性每个项目由<strong>子地址、父地址和地址空间长度</strong>这三部分组成。</li>
<li>如果 ranges 属性值为<strong>空值</strong>，说明<strong>子地址空间和父地址空间完全相同，不需要进行地址转换</strong>。</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">child<span class="token operator">-</span>bus<span class="token operator">-</span>address：子总线地址空间的物理地址，由父节点的#address<span class="token operator">-</span>cells 确定此物理地址所占用的字长
parent<span class="token operator">-</span>bus<span class="token operator">-</span>address： 父总线地址空间的物理地址，同样由父节点的#address<span class="token operator">-</span>cells 确定此物理地址所占用的字长
length： 子地址空间的长度，由父节点的#size<span class="token operator">-</span>cells 确定此地址长度所占用的字长<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>


</li>
<li><p><code>name</code> 属性<br>    name 属性值为字符串， name 属性用于记录节点名字， name 属性已经被弃用，不推荐使用 name 属性，一些老的设备树文件可能会使用此属性。</p>
</li>
<li><p><code>device_type</code> 属性<br>    <code>device_type</code> 属性值为字符串， IEEE 1275 会用到此属性，用于描述设备的 FCode ，但是设备树没有 FCode ，所以此属性也被抛弃了。此属性只能用于 cpu 节点或者 memory 节点。 imx6ull.dtsi 的 cpu0 节点用到了此属性，内容如下所示：</p>
</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">cpu0<span class="token operator">:</span> cpu@<span class="token number">0</span> <span class="token punctuation">{</span>
	compatible <span class="token operator">=</span> <span class="token string">"arm,cortex-a7"</span><span class="token punctuation">;</span>
	device_type <span class="token operator">=</span> <span class="token string">"cpu"</span><span class="token punctuation">;</span>
	reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<ul>
<li><p>特殊节点</p>
<p>在根节点“/”中有两个特殊的子节点： <code>aliases</code> 和 <code>chosen</code></p>
<ol>
<li><p><code>aliases</code></p>
<p> aliases {<br> can0 = &amp;flexcan1;<br> can1 = &amp;flexcan2;<br> …<br> usbphy0 = &amp;usbphy1;<br> usbphy1 = &amp;usbphy2;<br> };</p>
</li>
</ol>
<p>​	<code>aliases</code> 节点的主要功能就是定义别名，定义别名的目的就是为了方便访问节点。</p>
<p>​	但是，一般会在<strong>节点命名的时候会加上 label</strong>，然后通过&amp;label来访问节点。</p>
<ol start="2">
<li><code>chosen</code><br>chosen 不是一个真实的设备， <code>chosen</code> 节点主要是为了 uboot 向 Linux 内核传递数据(bootargs 参数)。</li>
</ol>
</li>
</ul>
<h3 id="6-4-OF操作函数"><a href="#6-4-OF操作函数" class="headerlink" title="6.4 OF操作函数"></a>6.4 OF操作函数</h3><p>Linux 内核提供了<strong>一系列的函数来获取设备树中的节点或者属性信息</strong>，这一系列的函数都有一个<strong>统一的前缀“of_” (称为OF 函数）</strong></p>
<h4 id="6-4-1-查找节点"><a href="#6-4-1-查找节点" class="headerlink" title="6.4.1 查找节点"></a>6.4.1 查找节点</h4><p>Linux 内核使用 <code>device_node</code> 结构体来描述一个节点：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span> 					<span class="token comment">/* 节点名字 */</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>type<span class="token punctuation">;</span> 					<span class="token comment">/* 设备类型 */</span>
    phandle phandle<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>full_name<span class="token punctuation">;</span> 				<span class="token comment">/* 节点全名 */</span>
    <span class="token keyword">struct</span> <span class="token class-name">fwnode_handle</span> fwnode<span class="token punctuation">;</span>

    <span class="token keyword">struct</span> <span class="token class-name">property</span> <span class="token operator">*</span>properties<span class="token punctuation">;</span> 		<span class="token comment">/* 属性 */</span>
    <span class="token keyword">struct</span> <span class="token class-name">property</span> <span class="token operator">*</span>deadprops<span class="token punctuation">;</span> 		<span class="token comment">/* removed 属性 */</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>parent<span class="token punctuation">;</span> 		<span class="token comment">/* 父节点 */</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>child<span class="token punctuation">;</span> 			<span class="token comment">/* 子节点
    ...
}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<ul>
<li><strong>通过节点名字查找指定的节点：<code>of_find_node_by_name</code></strong></li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span><span class="token function">of_find_node_by_name</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>from<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>​	from：开始查找的节点，如果为 NULL 表示从根节点开始查找整个设备树。<br>​	name：要查找的节点名字。<br>​	返回值： 找到的节点，如果为 NULL 表示查找失败。</p>
<ul>
<li><strong>通过 <code>device_type</code> 属性查找指定的节点：<code>of_find_node_by_type</code></strong></li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span><span class="token function">of_find_node_by_type</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>from<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>type<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>​	from：开始查找的节点，如果为 NULL 表示从根节点开始查找整个设备树。<br>​	type：要查找的节点对应的 type 字符串， device_type 属性值。<br>​	返回值： 找到的节点，如果为 NULL 表示查找失败</p>
<ul>
<li><strong>通过<code>device_type</code> 和 <code>compatible</code>两个属性查找指定的节点：<code>of_find_compatible_node</code></strong></li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span><span class="token function">of_find_compatible_node</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>from<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>type<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>compatible<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>​	from：开始查找的节点，如果为 NULL 表示从根节点开始查找整个设备树。<br>​	type：要查找的节点对应的 type 字符串，device_type 属性值，可以为 NULL<br>​	compatible： 要查找的节点所对应的 compatible 属性列表。<br>​	返回值： 找到的节点，如果为 NULL 表示查找失败</p>
<ul>
<li><strong>通过 <code>of_device_id</code> 匹配表来查找指定的节点：<code>of_find_matching_node_and_match</code></strong></li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span><span class="token function">of_find_matching_node_and_match</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>from<span class="token punctuation">,</span>
                                            <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> <span class="token operator">*</span>matches<span class="token punctuation">,</span>
                                            <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> <span class="token operator">*</span><span class="token operator">*</span>match<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>​	from：开始查找的节点，如果为 NULL 表示从根节点开始查找整个设备树。<br>​	matches： of_device_id 匹配表，在此匹配表里面查找节点。<br>​	match： 找到的匹配的 of_device_id。<br>​	返回值： 找到的节点，如果为 NULL 表示查找失败</p>
<ul>
<li><strong>通过路径来查找指定的节点：<code>of_find_node_by_path</code></strong></li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">inline</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span><span class="token function">of_find_node_by_path</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>​	path：设备树节点中绝对路径的节点名，可以使用节点的别名<br>​	返回值： 找到的节点，如果为 NULL 表示查找失败</p>
<h4 id="6-4-2-获取属性值"><a href="#6-4-2-获取属性值" class="headerlink" title="6.4.2 获取属性值"></a>6.4.2 获取属性值</h4><p>Linux 内核中使用结构体 property 表示属性</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">property</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span> <span class="token comment">/* 属性名字 */</span>
    <span class="token keyword">int</span> length<span class="token punctuation">;</span> <span class="token comment">/* 属性长度 */</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>value<span class="token punctuation">;</span> <span class="token comment">/* 属性值 */</span>
    <span class="token keyword">struct</span> <span class="token class-name">property</span> <span class="token operator">*</span>next<span class="token punctuation">;</span> <span class="token comment">/* 下一个属性 */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> _flags<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> unique_id<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">bin_attribute</span> attr<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<ul>
<li><strong>查找指定的属性：<code>of_find_property</code></strong></li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">property <span class="token operator">*</span><span class="token function">of_find_property</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>lenp<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>​	np：设备节点。<br>​	name： 属性名字。<br>​	lenp：属性值的字节数，一般为NULL<br>​	返回值： 找到的属性。</p>
<ul>
<li><strong>获取属性中元素的数量(数组)：<code>of_property_count_elems_of_size</code></strong></li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">of_property_count_elems_of_size</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span>
                                    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname
                                    <span class="token keyword">int</span> elem_size<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>​	np：设备节点。<br>​	proname： 需要统计元素数量的属性名字。<br>​	elem_size：元素长度。<br>​	返回值： 得到的属性元素数量</p>
<ul>
<li><strong>从属性中获取指定标号的 u32 类型数据值:<code>of_property_read_u32_index</code></strong></li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">of_property_read_u32_index</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">,</span> u32 index<span class="token punctuation">,</span> u32 <span class="token operator">*</span>out_value<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>​	np：设备节点。<br>​	proname： 要读取的属性名字。<br>​	index：要读取的值标号。<br>​	out_value：读取到的值<br>​	返回值： 0 读取成功;<br>​			负值: 读取失败，<br>​				-EINVAL 表示属性不存在<br>​				-ENODATA 表示没有要读取的数据，<br>​				-EOVERFLOW 表示属性值列表太小</p>
<ul>
<li><strong>读取属性中 u8、 u16、 u32 和 u64 类型的数组数据</strong></li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">of_property_read_u8_array
of_property_read_u16_array 
of_property_read_u32_array 
of_property_read_u64_array 
<span class="token keyword">int</span> <span class="token function">of_property_read_u8_array</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">,</span> u8 <span class="token operator">*</span>out_values<span class="token punctuation">,</span> <span class="token class-name">size_t</span> sz<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>​	np：设备节点。<br>​	proname： 要读取的属性名字。<br>​	out_value：读取到的数组值，分别为 u8、 u16、 u32 和 u64。<br>​	sz： 要读取的数组元素数量。<br>​	返回值： 0：读取成功;<br>​		负值: 读取失败<br>​			-EINVAL 表示属性不存在<br>​			-ENODATA 表示没有要读取的数据<br>​			-EOVERFLOW 表示属性值列表太小</p>
<ul>
<li><strong>读取属性中字符串值：<code>of_property_read_string</code></strong></li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">of_property_read_string</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>out_string<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>​	np：设备节点。<br>​	proname： 要读取的属性名字。<br>​	out_string：读取到的字符串值。<br>​	返回值： 0，读取成功，负值，读取失败</p>
<ul>
<li><strong>获取 <code>#address-cells</code> 属性值：<code>of_n_addr_cells</code> ，获取 <code>#size-cells</code> 属性值：<code>of_size_cells</code> 。</strong></li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">of_n_addr_cells</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">)</span>
<span class="token keyword">int</span> <span class="token function">of_n_size_cells</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>​	np：设备节点。<br>​	返回值： 获取到的#address-cells 属性值。<br>​	返回值： 获取到的#size-cells 属性值。</p>
<ul>
<li><strong>内存映射<code>of_iomap</code></strong></li>
</ul>
<p><code>of_iomap</code> 函数用于直接内存映射，前面通过 <code>ioremap</code> 函数来完成物理地址到虚拟地址的映射，采用设备树以后就可以直接通过 <code>of_iomap</code> 函数来获取内存地址所对应的虚拟地址。这样就不用再去先获取reg属性值，再用属性值映射内存。</p>
<p><code>of_iomap</code> 函数本质上也是将 reg 属性中地址信息转换为虚拟地址，如果 reg 属性有多段的话，可以通过 index 参数指定要完成内存映射的是哪一段， <code>of_iomap</code> 函数原型如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> __iomem <span class="token operator">*</span><span class="token function">of_iomap</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span>  <span class="token keyword">int</span> index<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>​	np：设备节点。<br>​	index： reg 属性中要完成内存映射的段，如果 reg 属性只有一段的话 index 就设置为 0。<br>​	返回值： 经过内存映射后的虚拟内存首地址，如果为 NULL 的话表示内存映射失败。</p>
<p>例如：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">1</span></span></span>
	<span class="token comment">/* 1、寄存器地址映射 */</span>
	IMX6U_CCM_CCGR1 <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>regdata<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> regdata<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	SW_MUX_GPIO1_IO03 <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>regdata<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> regdata<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	SW_PAD_GPIO1_IO03 <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>regdata<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> regdata<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	GPIO1_DR <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>regdata<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> regdata<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	GPIO1_GDIR <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>regdata<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> regdata<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span>   <span class="token comment">//第一对：起始地址+大小 --&gt;映射 这样就不用获取reg的值</span></span>
	IMX6U_CCM_CCGR1 <span class="token operator">=</span> <span class="token function">of_iomap</span><span class="token punctuation">(</span>dtsled<span class="token punctuation">.</span>nd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	SW_MUX_GPIO1_IO03 <span class="token operator">=</span> <span class="token function">of_iomap</span><span class="token punctuation">(</span>dtsled<span class="token punctuation">.</span>nd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	SW_PAD_GPIO1_IO03 <span class="token operator">=</span> <span class="token function">of_iomap</span><span class="token punctuation">(</span>dtsled<span class="token punctuation">.</span>nd<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	GPIO1_DR <span class="token operator">=</span> <span class="token function">of_iomap</span><span class="token punctuation">(</span>dtsled<span class="token punctuation">.</span>nd<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	GPIO1_GDIR <span class="token operator">=</span> <span class="token function">of_iomap</span><span class="token punctuation">(</span>dtsled<span class="token punctuation">.</span>nd<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<ul>
<li><strong><code>of</code> 函数在 <code>led_init()</code> 中应用</strong></li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> ret<span class="token punctuation">;</span>
u32 regdate<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>str<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">property</span> <span class="token operator">*</span>proper<span class="token punctuation">;</span>
<span class="token comment">/* 1 、获取设备节点： */</span>
dtb_led<span class="token punctuation">.</span>nd <span class="token operator">=</span> <span class="token function">of_find_node_by_path</span><span class="token punctuation">(</span><span class="token string">"/songwei_led"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>dtb_led<span class="token punctuation">.</span>nd <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"songwei_led node can not found!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span><span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"songwei_led node has been found!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 2 、获取 compatible  属性内容 */</span>
proper <span class="token operator">=</span> <span class="token function">of_find_property</span><span class="token punctuation">(</span>dtb_led<span class="token punctuation">.</span>nd <span class="token punctuation">,</span><span class="token string">"compatible"</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>proper <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"compatible property find failed\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
<span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"compatible = %s\r\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>proper<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 3 、获取 status  属性内容 */</span>
ret <span class="token operator">=</span> <span class="token function">of_property_read_string</span><span class="token punctuation">(</span>dtb_led<span class="token punctuation">.</span>nd<span class="token punctuation">,</span> <span class="token string">"status"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"status read failed!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"status = %s\r\n"</span><span class="token punctuation">,</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 4 、获取 reg  属性内容 */</span>
ret <span class="token operator">=</span> <span class="token function">of_property_read_u32_array</span><span class="token punctuation">(</span>dtb_led<span class="token punctuation">.</span>nd<span class="token punctuation">,</span> <span class="token string">"reg"</span><span class="token punctuation">,</span> regdate<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"reg property read failed!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token punctuation">{</span>
    u8 i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"reg data:\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%#X "</span><span class="token punctuation">,</span> regdate<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="7-GPIO子系统"><a href="#7-GPIO子系统" class="headerlink" title="7.GPIO子系统"></a>7.GPIO子系统</h2><p>GPIO 是 “General Purpose Input/Output” 的缩写，中文意为通用输入/输出。GPIO 是一种在数字电子电路中常见的接口，允许数字设备（如微控制器、处理器、FPGA 等）与外部世界进行通信和交互。</p>
<p>每个 GPIO 引脚通常可以在输入和输出之间切换。作为输入时，GPIO 引脚可以接收来自外部设备或电路的电平信号，例如开关、传感器等。作为输出时，GPIO 引脚可以发送电平信号到外部设备或电路，例如驱动 LED、控制继电器等。</p>
<p>当使用 pinctrl 子系统将引脚的复用设置为 GPIO，可以使用 <strong>GPIO 子系统来操作GPIO</strong></p>
<h3 id="7-1-GPIO子系统工作内容"><a href="#7-1-GPIO子系统工作内容" class="headerlink" title="7.1 GPIO子系统工作内容"></a>7.1 GPIO子系统工作内容</h3><p>通过 GPIO 子系统功能要实现：</p>
<ul>
<li>引脚功能的配置（设置为 GPIO，GPIO 的方向， 输入输出模式，读取/设置 GPIO 的值）</li>
<li>实现软硬件的分离（分离出硬件差异， 有厂商提供的底层支持； 软件分层。 驱动只需要调用接口 API 即可操作 GPIO）</li>
<li>iommu 内存管理（直接调用宏即可操作 GPIO）</li>
</ul>
<p><strong>按键输入</strong>：左边是接地，右边有那个按键按下的话，哪个GPIO的端口就能接收到低电平信号</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202407311054337.png" alt="image-20240731105411230"></p>
<p>按键输出：控制LED灯，当GPIO输出高电平就可以点亮这个LED。</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202407311057877.png" alt="image-20240731105757711"></p>
<h3 id="7-2-GPIO子系统设备树设置"><a href="#7-2-GPIO子系统设备树设置" class="headerlink" title="7.2 GPIO子系统设备树设置"></a>7.2 GPIO子系统设备树设置</h3><p>在具体设备节点中添加GPIO信息</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">gpioled <span class="token punctuation">{</span>
		<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
		<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
		compatible <span class="token operator">=</span> <span class="token string">"songwei-gpioled"</span><span class="token punctuation">;</span>
		pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>
		pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>pinctrl_led<span class="token operator">&gt;</span><span class="token punctuation">;</span>
		<span class="token comment">//gpio信息</span>
		led<span class="token operator">-</span>gpio <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio1 <span class="token number">3</span> GPIO_ACTIVE_LOW<span class="token operator">&gt;</span><span class="token punctuation">;</span>
		status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>led-gpio 属性指定了 LED 灯所使用的 GPIO，在这里就是 GPIO1 的 IO03，低电平有效。</li>
<li>稍后编写驱动程序的时候会获取 led-gpio 属性的内容来得到 GPIO 编号，因为 gpio 子系统的 API 操作函数需要 GPIO 编号</li>
</ul>
<h3 id="7-3-API函数-gpio是旧的函数，gpiod是新的函数"><a href="#7-3-API函数-gpio是旧的函数，gpiod是新的函数" class="headerlink" title="7.3 API函数(gpio是旧的函数，gpiod是新的函数)"></a>7.3 API函数(gpio是旧的函数，gpiod是新的函数)</h3><ol start="0">
<li><code>gpio_is_valid</code>检测GPIO引脚是否有效函数：</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/gpio.h&gt;</span>			<span class="token comment">//GPIO的标准接口函数包含头文件</span></span>
bool <span class="token function">gpio_is_valid</span><span class="token punctuation">(</span><span class="token keyword">int</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// int number：GPIO编号</span>
<span class="token comment">// 返回值：有效返回true，无效返回false。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<ol>
<li><code>gpio_request</code> 函数用于申请一个 <code>GPIO</code> 管脚，在使用一个 <code>GPIO</code> 之前一定要使用 <code>gpio_request</code>进行申请。</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">gpio_request</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> gpio<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>label<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">gpio_request_array</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">gpio</span> <span class="token operator">*</span>array<span class="token punctuation">,</span> <span class="token class-name">size_t</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//申请多个GPIO资源函数：</span>
<span class="token comment">// const struct gpio *array ：所要申请的GPIOID</span>
<span class="token comment">// size_t num ：申请的GPIO资源个数</span>
<span class="token comment">// 返回值：成功返回0，失败返回一个负的错误码。</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>gpio：要申请的 gpio 标号，使用 <code>of_get_named_gpio</code> 函数从设备树获取指定 GPIO 属性信息，此函数会返回这个 GPIO 的标号</p>
</li>
<li><p>label：给 gpio 设置个名字。</p>
</li>
<li><p>返回值： 0，申请成功；其他值，申请失败。</p>
</li>
</ul>
<ol start="2">
<li><code>gpio_free</code>如果不使用某个 GPIO ，需要调用 <code>gpio_free</code> 函数进行释放。</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">gpio_free</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> gpio<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// gpio：要释放的 gpio 标号。</span>
<span class="token keyword">void</span> <span class="token function">gpio_free_array</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">gpio</span> <span class="token operator">*</span>array<span class="token punctuation">,</span> <span class="token class-name">size_t</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//释放多个GPIO资源函数：</span>
<span class="token comment">// const struct gpio *array ：所要释放的GPIOID</span>
<span class="token comment">// size_t num ：释放的GPIO资源个数</span>
<span class="token comment">// 返回值：无返回值。</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<ol start="3">
<li><code>gpio_direction_input</code>设置某个 GPIO 为输入</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">gpio_direction_input</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> gpio<span class="token punctuation">)</span> <span class="token comment">//gpio：要设置为输入的 GPIO 标号。</span>
<span class="token comment">// unsigned gpio：GPIO对应的"ID"</span>
<span class="token comment">// 返回值：成功返回0，失败返回一个负的错误码。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<ol start="4">
<li><code>gpio_direction_output</code>设置某个 GPIO 为输出，并且设置默认输出值。</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">gpio_direction_output</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> gpio<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>gpio：要设置为输出的 GPIO 标号”ID”。</li>
<li>value： GPIO 默认输出值。初始电平，0为低电平，1为高电平</li>
<li>返回值： 0，设置成功；负值，设置失败</li>
</ul>
<ol start="5">
<li><code>gpio_get_value</code>获取某个 GPIO 的值(0 或 1)  （原子操作）</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">gpio_get_value</span> <span class="token expression">__gpio_get_value</span></span>
<span class="token keyword">int</span> <span class="token function">__gpio_get_value</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> gpio<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li><p>gpio：要获取的 GPIO 标号”ID”。</p>
</li>
<li><p>返回值： 非负值，得到的 GPIO 值(0表示低电平，非零整数表示高电平)；负值，获取失败</p>
</li>
</ul>
<ol start="6">
<li><code>gpio_set_value</code> 设置某个 GPIO 的值  （原子操作）</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">gpio_set_value</span> <span class="token expression">__gpio_set_value</span></span>
<span class="token keyword">void</span> <span class="token function">__gpio_set_value</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> gpio<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li><p>gpio：要设置的 GPIO 标号。</p>
</li>
<li><p>value： 要设置的值，设置GPIO口的高低电平</p>
</li>
<li><p>返回值：无返回值</p>
</li>
</ul>
<p>以上两种函数均属原子操作，能作用于中断程序<br>以下两种函数，在队列中等待访问引脚，可能会进入睡眠，不能作用于中断</p>
<p>访问必须通过消息总线比如I2C或者SPI，这些需要在队列中访问。</p>
<ol start="7">
<li><code>gpio_get_value_cansleep</code>通过消息总线获取GPIO的输入值函数</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">gpio_get_value_cansleep</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> gpio<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// GPIO对应的"ID"</span>
<span class="token comment">// 返回值：成功返回非负数（0表示低电平，非零整数表示高电平），失败返回一个负的错误码。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<ol start="8">
<li><code>gpio_set_value_cansleep</code>通过消息总线获设置GPIO的输出值函数</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">gpio_set_value_cansleep</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> gpio<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// unsigned gpio：GPIO对应的"ID"</span>
<span class="token comment">// int value：设置GPIO口的高低电平</span>
<span class="token comment">// 返回值：无返回值</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<ol start="9">
<li><code>gpiod_cansleep</code>检测引脚是否需要通过消息总线访问函数</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">gpiod_cansleep</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> gpio<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// unsigned gpio：GPIO对应的"ID"</span>
<span class="token comment">// 返回值: 返回0表示需要通过消息总线访问，否则返回负数</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<ol start="10">
<li><code>gpio_to_irq</code>将GPIO设置为中断口函数</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">gpio_to_irq</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> gpio<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// unsigned gpio：GPIO对应的"ID"</span>
<span class="token comment">// 返回值：request_irq()使用的中断号</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<ol start="11">
<li><code>gpio_export</code>导出GPIO端口到用户空间函数</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">gpio_export</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> gpio<span class="token punctuation">,</span>bool direction_may_change<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// unsigned gpio：GPIO对应的"ID"</span>
<span class="token comment">// direction_may_change：表示用户程序是否允许修改gpio的方向，如果可以则该参数为真</span>
<span class="token comment">// 返回值：成功返回0。</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<ol start="12">
<li><code>gpio_unexport</code>撤销GPIO的导出函数</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">gpio_unexport</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> gpio<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// unsigned gpio：GPIO对应的"ID"</span>
<span class="token comment">// 返回值：无返回值</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>




<h3 id="7-4-GPIO相关OF函数"><a href="#7-4-GPIO相关OF函数" class="headerlink" title="7.4 GPIO相关OF函数"></a>7.4 GPIO相关OF函数</h3><ol>
<li><code>of_gpio_named_count</code><br>获取设备树某个属性里面定义了几个GPIO 信息。</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">of_gpio_named_count</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>np：设备节点。</li>
<li>propname：要统计的 GPIO 属性。</li>
<li>返回值： 正值，统计到的 GPIO 数量；负值，失败</li>
</ul>
<ol start="2">
<li><code>of_gpio_count</code><br>此函数统计的是gpios属性的 GPIO 数量，而 of_gpio_named_count 函数可以统计任意属性的GPIO 信息</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">of_gpio_count</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>np：设备节点。</li>
<li>返回值： 正值，统计到的 GPIO 数量；负值，失败</li>
</ul>
<ol start="3">
<li><code>of_get_named_gpio</code><br>获取 GPIO 编号，在Linux 内核中关于 GPIO 的 API 函数都要使用 GPIO 编号，此函数会将设备树中类似<code>&lt;&amp;gpio5 7 GPIO_ACTIVE_LOW&gt;</code>的属性信息转换为对应的 GPIO 编号。</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">of_get_named_gpio</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>np：设备节点。</li>
<li>propname：包含要获取 GPIO 信息的属性名。</li>
<li>index： GPIO 索引，因为一个属性里面可能包含多个 GPIO，此参数指定要获取哪个 GPIO的编号，如果只有一个 GPIO 信息的话此参数为 0。</li>
<li>返回值： 正值，获取到的 GPIO 编号；负值，失败。</li>
</ul>
<h3 id="7-5-pinctrl和gpio子系统使用程序框架"><a href="#7-5-pinctrl和gpio子系统使用程序框架" class="headerlink" title="7.5 pinctrl和gpio子系统使用程序框架"></a>7.5 <code>pinctrl</code>和<code>gpio</code>子系统使用程序框架</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">/* 1 、获取设备节点：alphaled */</span>
gpio_led<span class="token punctuation">.</span>nd <span class="token operator">=</span> <span class="token function">of_find_node_by_path</span><span class="token punctuation">(</span><span class="token string">"/gpioled"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>gpio_led<span class="token punctuation">.</span>nd <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"songwei_led node can not found!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">else</span>
<span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"songwei_led node has been found!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 2、 获取设备树中的 gpio 属性，得到 LED 所使用的 LED 编号 */</span>
gpio_led<span class="token punctuation">.</span>led_gpio <span class="token operator">=</span> <span class="token function">of_get_named_gpio</span><span class="token punctuation">(</span>gpio_led<span class="token punctuation">.</span>nd<span class="token punctuation">,</span><span class="token string">"led-gpio"</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>gpio_led<span class="token punctuation">.</span>led_gpio <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"can't get led-gpio"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"led-gpio num = %d\r\n"</span><span class="token punctuation">,</span> gpio_led<span class="token punctuation">.</span>led_gpio<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* 3、设置 GPIO1_IO03 为输出，并且输出高电平，默认关闭 LED 灯 */</span>
ret <span class="token operator">=</span> <span class="token function">gpio_direction_output</span><span class="token punctuation">(</span>gpio_led<span class="token punctuation">.</span>led_gpio<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"can't set gpio!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="8-sys系统节点的创建与使用"><a href="#8-sys系统节点的创建与使用" class="headerlink" title="8.sys系统节点的创建与使用"></a>8.sys系统节点的创建与使用</h2><p><code>sysfs</code>属性节点可以实现用户空间与硬件交互，如设置管教电平，设置寄存器值等，控制驱动的具体功能。</p>
<p>sysfs是一种基于ram文件系统和proc一样。Sysfs文件系统是一个类似于proc文件系统的特殊文件系统，用于将系统中的设备组织成层次结构，并向用户模式程序提供详细的内核数据结构信息。</p>
<h3 id="8-1-sys创建节点函数接口"><a href="#8-1-sys创建节点函数接口" class="headerlink" title="8.1 sys创建节点函数接口"></a>8.1 sys创建节点函数接口</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">sysfs_create_file</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">attribute</span> <span class="token operator">*</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 作用：通过kobject创建sysfs节点</span>
<span class="token comment">// 参数：	  @kobj：kobject结构指针</span>
<span class="token comment">//  		@attr：设备属性描述符</span>
<span class="token comment">// 返回值：成功返回0，否则返回负数</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">device_create_file</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_attribute</span> <span class="token operator">*</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 作用：创建sysfs节点    // 创建读写字符串的节点：</span>
<span class="token comment">// 参数：@dev：设备</span>
<span class="token comment">//  	@attr：设备属性描述符</span>
<span class="token comment">// 返回值：成功返回0，否则返回负数</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span><span class="token function">device_create</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span>class<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>parent<span class="token punctuation">,</span> <span class="token class-name">dev_t</span> devt<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>drvdata<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>fmt<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 作用：创建设备并将其注册到系统</span>
<span class="token comment">// 参数：@class：class结构体指针</span>
<span class="token comment">//  	@parent：设备节点父节点</span>
 <span class="token comment">// 	@devt：设备号</span>
 <span class="token comment">// 	@drvdata：设备的私有数据</span>
<span class="token comment">//  	@fmt：sys/class/节点下的设备名</span>
<span class="token comment">// 返回值：struct device结构体类型的指针</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span><span class="token function">class_create</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 作用：创建class结构体</span>
<span class="token comment">// 参数：@owner：指向要"拥有"此结构类的模块的指针</span>
<span class="token comment">//  	@name：指向此类名称的字符串的指针。</span>
<span class="token comment">// 返回值：struct class结构类型的指针</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">kobject_put</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 作用：递减kobj内核对象的引用计数 当为0的时候调用在kobject_init()中传入的kobj_type{}结构中包含的kobj释放函数</span>
<span class="token comment">// 参数：@kobj：递减的内核对象</span>
<span class="token comment">// 返回值：递减引用计数，如果为0，则调用 kobject_cleanup()。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">sysfs_create_group</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">attribute_group</span> <span class="token operator">*</span>grp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 作用：为kobject目录创建一个属性组</span>
<span class="token comment">// 参数：@kobj：需要创建属性组的kobject</span>
<span class="token comment">//  @grp：属性组</span>
<span class="token comment">// 返回值：成功时返回 0，失败时返回错误代码。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>下面的 Linux sysfs使用方法随笔引用<a target="_blank" rel="noopener" href="https://blog.csdn.net/weihua1643/article/details/124686118">丨可乐猫丨</a></p>
<h3 id="8-2-概述"><a href="#8-2-概述" class="headerlink" title="8.2 概述"></a>8.2 概述</h3><p>Linux 2.6以后的内核引入了sysfs文件系统， sysfs被看成是与proc、 devfs和devpty同类别的文件系统，该文件系统是一个虚拟的文件系统， 它可以产生一个包括所有系统硬件的层级视图， 与提供进程和状态信息的proc文件系统十分类似。</p>
<p>sysfs把连接在系统上的设备和总线组织成为一个分级的文件， 它们可以由用户空间存取， 向用户空间导出内核数据结构以及它们的属性。 sysfs的一个目的就是展示设备驱动模型中各组件的层次关系， 其顶级目录包括block、 bus、 dev、 devices、 class、 fs、 kernel、 power和firmware等。</p>
<h3 id="8-3-目录结构"><a href="#8-3-目录结构" class="headerlink" title="8.3 目录结构"></a>8.3 目录结构</h3><p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408011952991.png" alt="image-20240801195239791"></p>
<h3 id="8-4-创建sysfs节点"><a href="#8-4-创建sysfs节点" class="headerlink" title="8.4 创建sysfs节点"></a>8.4 创建sysfs节点</h3><p>创建读写字符串的节点：<code>device_create_file</code></p>
<p>这里涉及一个结构体：<br> <strong><code>device_attribute</code></strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">device_attribute</span> <span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">attribute</span>        attr<span class="token punctuation">;</span>
	<span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>show<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">device_attribute</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>store<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">device_attribute</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">DEVICE_ATTR</span><span class="token expression"><span class="token punctuation">(</span>_name<span class="token punctuation">,</span> _mode<span class="token punctuation">,</span> _show<span class="token punctuation">,</span> _store<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token keyword">struct</span> <span class="token class-name">device_attribute</span> dev_attr_</span><span class="token punctuation">##</span><span class="token expression">_name <span class="token operator">=</span> <span class="token function">__ATTR</span><span class="token punctuation">(</span>_name<span class="token punctuation">,</span> _mode<span class="token punctuation">,</span> _show<span class="token punctuation">,</span> _store<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">DEVICE_ATTR_RW</span><span class="token expression"><span class="token punctuation">(</span>_name<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token keyword">struct</span> <span class="token class-name">device_attribute</span> dev_attr_</span><span class="token punctuation">##</span><span class="token expression">_name <span class="token operator">=</span> <span class="token function">__ATTR_RW</span><span class="token punctuation">(</span>_name<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">DEVICE_ATTR_RO</span><span class="token expression"><span class="token punctuation">(</span>_name<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token keyword">struct</span> <span class="token class-name">device_attribute</span> dev_attr_</span><span class="token punctuation">##</span><span class="token expression">_name <span class="token operator">=</span> <span class="token function">__ATTR_RO</span><span class="token punctuation">(</span>_name<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">DEVICE_ATTR_WO</span><span class="token expression"><span class="token punctuation">(</span>_name<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token keyword">struct</span> <span class="token class-name">device_attribute</span> dev_attr_</span><span class="token punctuation">##</span><span class="token expression">_name <span class="token operator">=</span> <span class="token function">__ATTR_WO</span><span class="token punctuation">(</span>_name<span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>以一个可以进行字符串读写的AA节点为例：<br> 在代码中需要如下定义：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">DEVICE_ATTR_RW（AA<span class="token punctuation">)</span> 
#这样就已经定义好了名为 dev_attr_AA 的结构体对象
#同时也定义好了两个方法名称：<span class="token function">AA_show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>和<span class="token function">AA_store</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>在probe函数中调用创建函数：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">device_create_file</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dev_attr_AA<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后实现AA_show()和AA_store()实体</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">vmute_show</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">device_attribute</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> value<span class="token punctuation">;</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token keyword">return</span> <span class="token function">scnprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> PAGE_SIZE<span class="token punctuation">,</span> <span class="token string">"%d\n"</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">vmute_store</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">device_attribute</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>有几点注意项：<br>1.show()方法应该总是使用snprintf 进行返回<br>2.store()方法应该返回实际使用的字节数<br>3.show()和store()方法出错时返回相应的错误码<br>4.show()和store()方法都是同步通信<br>5.节点的缓冲区总是为1页，为PAGE_SIZE个字节，PAGE_SIZE=4096</p>
<p>创建读写bin类型的节点：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">#函数原型
<span class="token keyword">int</span> __must_check <span class="token function">device_create_bin_file</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">bin_attribute</span> <span class="token operator">*</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
#因为是__must_check，所以该函数的返回值必须进行判定<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>这里涉及一个结构体：</p>
<p><strong><code>bin_attribute</code></strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">bin_attribute</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">attribute</span>        attr<span class="token punctuation">;</span>
		<span class="token class-name">size_t</span>                  size<span class="token punctuation">;</span>
		<span class="token keyword">void</span>                    <span class="token operator">*</span>private<span class="token punctuation">;</span>		
		<span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>read<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">bin_attribute</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		
		<span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>write<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">bin_attribute</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		
		<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>mmap<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">bin_attribute</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">vm_area_struct</span> <span class="token operator">*</span>vma<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>	

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">BIN_ATTR</span><span class="token expression"><span class="token punctuation">(</span>_name<span class="token punctuation">,</span> _mode<span class="token punctuation">,</span> _read<span class="token punctuation">,</span> _write<span class="token punctuation">,</span> _size<span class="token punctuation">)</span> <span class="token keyword">struct</span> <span class="token class-name">bin_attribute</span> bin_attr_</span><span class="token punctuation">##</span><span class="token expression">_name <span class="token operator">=</span> <span class="token function">__BIN_ATTR</span><span class="token punctuation">(</span>_name<span class="token punctuation">,</span> _mode<span class="token punctuation">,</span> _read<span class="token punctuation">,</span> _write<span class="token punctuation">,</span> _size<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">BIN_ATTR_RO</span><span class="token expression"><span class="token punctuation">(</span>_name<span class="token punctuation">,</span> _size<span class="token punctuation">)</span> <span class="token keyword">struct</span> <span class="token class-name">bin_attribute</span> bin_attr_</span><span class="token punctuation">##</span><span class="token expression">_name <span class="token operator">=</span> <span class="token function">__BIN_ATTR_RO</span><span class="token punctuation">(</span>_name<span class="token punctuation">,</span> _size<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">BIN_ATTR_WO</span><span class="token expression"><span class="token punctuation">(</span>_name<span class="token punctuation">,</span> _size<span class="token punctuation">)</span> <span class="token keyword">struct</span> <span class="token class-name">bin_attribute</span> bin_attr_</span><span class="token punctuation">##</span><span class="token expression">_name <span class="token operator">=</span> <span class="token function">__BIN_ATTR_WO</span><span class="token punctuation">(</span>_name<span class="token punctuation">,</span> _size<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">BIN_ATTR_RW</span><span class="token expression"><span class="token punctuation">(</span>_name<span class="token punctuation">,</span> _size<span class="token punctuation">)</span> <span class="token keyword">struct</span> <span class="token class-name">bin_attribute</span> bin_attr_</span><span class="token punctuation">##</span><span class="token expression">_name <span class="token operator">=</span> <span class="token function">__BIN_ATTR_RW</span><span class="token punctuation">(</span>_name<span class="token punctuation">,</span> _size<span class="token punctuation">)</span> </span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>以一个可以进行二进制读写的BB节点为例：<br> 在代码中需要如下定义：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">BIN_ATTR_RW（BB， <span class="token number">0x400</span><span class="token punctuation">)</span> 
#这样就已经定义好了名为 bin_attr_BB 的结构体对象
#同时也定义好了两个方法名称：<span class="token function">BB_read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>和<span class="token function">BB_write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>在probe函数中调用创建函数：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">err <span class="token operator">=</span> <span class="token function">device_create_bin_file</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bin_attr_BB<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>然后实现<code>BB_read()</code>和<code>BB_write()</code>实体</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">BB_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span>
							<span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">bin_attribute</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span>
							<span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> offset<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">BB_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span>
							<span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">bin_attribute</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span>
							<span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> offset<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>sysfs_notify</code> 如果内核想主动上报状态，可以使用sysfs_notify方法</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">#函数原型
<span class="token keyword">void</span> <span class="token function">sysfs_notify</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>kobj<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>dir<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>直接唤醒该字符串</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">sysfs_notify</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>client<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>kobj<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"AA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>/sys/module中的parameter</p>
<p>可以用如下方式向模块中传入参数,例：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> bool xx<span class="token punctuation">;</span>
#将模块外传进来的参数yy映射到代码中的xx变量，代码中使用xx进行操作
<span class="token function">module_param_named</span><span class="token punctuation">(</span>yy<span class="token punctuation">,</span> xx<span class="token punctuation">,</span> bool<span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		
#这句是对yy参数的描述，在#<span class="token operator">:</span>modinfo mm<span class="token punctuation">.</span>ko时，会打印出来，用来描述参数的作用等
<span class="token function">MODULE_PARM_DESC</span><span class="token punctuation">(</span>yy<span class="token punctuation">,</span> <span class="token string">"Force Off"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="8-5-用户空间使用sysfs节点"><a href="#8-5-用户空间使用sysfs节点" class="headerlink" title="8.5 用户空间使用sysfs节点"></a>8.5 用户空间使用sysfs节点</h3><p>比如：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">#第一种
cat  AA			#会调用 <span class="token function">AA_show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 方法
echo <span class="token string">"xxx"</span> <span class="token operator">&gt;</span> AA		#会调用 <span class="token function">AA_store</span><span class="token punctuation">(</span><span class="token punctuation">)</span>方法

#第二种
<span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"BB"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">offset</span> <span class="token expression"><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> size <span class="token operator">=</span> <span class="token number">1</span></span></span>
ret <span class="token operator">=</span> <span class="token function">pread</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> readbuf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		#会调用 <span class="token function">BB_read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>方法，ret返回读取到的个数，readbuf中是读取到的值
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">offset</span> <span class="token expression"><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> size <span class="token operator">=</span> <span class="token number">1</span></span></span>
ret <span class="token operator">=</span> <span class="token function">pwrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> writebuf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		#会调用 <span class="token function">BB_write</span><span class="token punctuation">(</span><span class="token punctuation">)</span>方法，ret返回写入的个数，writebuf中是待写入的值

#第三种
<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	err <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> pEvent<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	#sysfs_notify会唤醒epoll
	<span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		ret <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> read_value<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	#会调用 <span class="token function">AA_show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> writebuf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>writebuf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> #会调用 <span class="token function">AA_store</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="8-6-sysfs节点创建原理"><a href="#8-6-sysfs节点创建原理" class="headerlink" title="8.6 sysfs节点创建原理"></a>8.6 sysfs节点创建原理</h3><p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202408012003525.png" alt="105a481f3f6f801eb440d206751e35e7"></p>
<h1 id="二、linux驱动学习"><a href="#二、linux驱动学习" class="headerlink" title="二、linux驱动学习"></a>二、linux驱动学习</h1><h2 id="第00章-Linux设备模型的基本概念"><a href="#第00章-Linux设备模型的基本概念" class="headerlink" title="第00章 Linux设备模型的基本概念"></a>第00章 Linux设备模型的基本概念</h2><h3 id="Bus-Class-Device和Device-Driver的概念"><a href="#Bus-Class-Device和Device-Driver的概念" class="headerlink" title="Bus, Class, Device和Device Driver的概念"></a>Bus, Class, Device和Device Driver的概念</h3><p>下图是嵌入式系统常见的硬件拓扑的一个示例： 引用来自<a target="_blank" rel="noopener" href="http://www.wowotech.net/device_model/13.html">蜗窝科技</a></p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202407301150822.gif" alt="e960493a2c0e405ae9b2fefaf869334220140227080147"></p>
<p>硬件拓扑描述Linux设备模型中四个重要概念中三个：Bus，Class和Device（第四个为Device Driver，后面会说）。</p>
<ul>
<li>Bus（总线）：Linux认为（可以参考include/linux/device.h中struct  bus_type的注释），总线是CPU和一个或多个设备之间信息交互的通道。而为了方便设备模型的抽象，所有的设备都应连接到总线上（无论是CPU内部总线、虚拟的总线还是“platform Bus”）。</li>
<li>Class（分类）：在Linux设备模型中，Class的概念非常类似面向对象程序设计中的Class（类），它主要是集合具有相似功能或属性的设备，这样就可以抽象出一套可以在多个设备之间共用的数据结构和接口函数。因而从属于相同Class的设备的驱动程序，就不再需要重复定义这些公共资源，直接从Class中继承即可。</li>
<li>Device（设备）：抽象系统中所有的硬件设备，描述它的名字、属性、从属的Bus、从属的Class等信息。</li>
<li>Device Driver（驱动）：Linux设备模型用Driver抽象硬件设备的驱动程序，它包含设备初始化、电源管理相关的接口实现。而Linux内核中的驱动开发，基本都围绕该抽象进行（实现所规定的接口函数）。</li>
</ul>
<h2 id="第01章-Linux内核模块"><a href="#第01章-Linux内核模块" class="headerlink" title="第01章 Linux内核模块"></a>第01章 Linux内核模块</h2><h3 id="1-1-Linux内核模块简介"><a href="#1-1-Linux内核模块简介" class="headerlink" title="1.1 Linux内核模块简介"></a>1.1 Linux内核模块简介</h3><h4 id="1-什么是内核模块"><a href="#1-什么是内核模块" class="headerlink" title="1.什么是内核模块"></a>1.什么是内核模块</h4><p>Linux 模块是一种可加载内核模块，可以在运行时动态地插入和删除，扩展 Linux 内的功能和特性。以下是几个 Linux 模块的特性:</p>
<ul>
<li>1.动态加载:Linux 模块可以在运行时动态地加载和卸载，而无需重新编译内核或重启系统。这使得开发人员可以更快速地开发和测试<br>新的内核功能。</li>
<li>2.代码独立:Linux 模块的代码是独立的，与内核的其余部分分开编译。这意味着即使一个模块崩溃了，也不会影响内核的其余部分。</li>
<li>3,模块参数:Linux 模块可以带有一些参数，这些参数可以在加载模块时由用户指定。这些参数允许用户在不改变内核源代码的情况下修改模块的行为。</li>
<li>4.模块依赖:Linux 模块可以依赖其他模块，这些模块必须在当前模块之前加载，这使得开发人员可以更容易地管理和维护模块之间的依赖关系。</li>
<li>5.模块版本:Linux 模块有一个版本号，这个版本号可以与内核版本号进行比较，以确保模块与内核兼容</li>
</ul>
<p>linux 模提供了一种录活，高效的方来扩展 nux 内核的特性，使得开发人员可以更读地开发和测计的内核功能，并以在不影响系统稳定性的情况下动态地加载和卸载模块。</p>
<h4 id="2-内核模块与应用程序区别"><a href="#2-内核模块与应用程序区别" class="headerlink" title="2.内核模块与应用程序区别"></a>2.内核模块与应用程序区别</h4><p>内核模块用于扩展和定制操作系统的核心功能.</p>
<ul>
<li>运行在内核空间，具有更高的权限和更广泛的访问权限</li>
<li>运行在用户空间，应用程序则是为了满足用户需求而设计的，受到操作系统的保护</li>
</ul>
<img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202407181614019.png" alt="image-20240718161420945" style="zoom:67%;">

<h3 id="1-2-模块加载和卸载"><a href="#1-2-模块加载和卸载" class="headerlink" title="1.2 模块加载和卸载"></a>1.2 模块加载和卸载</h3><h4 id="1-模块开发头文件"><a href="#1-模块开发头文件" class="headerlink" title="1.模块开发头文件"></a>1.模块开发头文件</h4><p>模块开发必不可少的3个头文件</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;linux/kerne1.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;linux/init.h&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>模块文件名是以 <code>*.ko</code>文件结束</p>
<h4 id="2-安装模块-insmod"><a href="#2-安装模块-insmod" class="headerlink" title="2.安装模块 insmod"></a>2.安装模块 insmod</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">su</span> 						<span class="token comment"># 必须先获得root权限</span>
insmod *.ko
insmod hello.ko<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>会执行当前目录下的<code>*.ko</code> 文件内的<code>init_module(linux2.4内核)</code>函数，如果<code>*.ko</code> 文件内没有<code>init _module</code>，就会找<code>module_init(linux2.6以后)</code>函数，执行函数内部的功能，进行驱动的加载。</p>
<h4 id="3-查看模块信息-dmesg"><a href="#3-查看模块信息-dmesg" class="headerlink" title="3.查看模块信息 dmesg"></a>3.查看模块信息 dmesg</h4><p>显示安装/卸载信息 <code>dmesg</code>显示后不清除，<code>dmesg -c</code> 显示后清除信息。</p>
<h4 id="4-卸载模块-rmmod"><a href="#4-卸载模块-rmmod" class="headerlink" title="4.卸载模块 rmmod"></a>4.卸载模块 rmmod</h4><p>rmmod 模块去除<code>*.ko</code>之前的名称</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">rmmod hello<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>会执行当前目录下的<code>*.ko</code>文件，会行文件内的<code>cleanup_module(llinux2.4内核)</code>函数，如果<code>*.ko</code>文件内没有<code>cleanup_module</code>会找<br><code>module_exit(linux2.6以后)</code>函数，执行函数内部的功能，进行驱动的卸载</p>
<h4 id="5-查看模块-Ismod"><a href="#5-查看模块-Ismod" class="headerlink" title="5.查看模块 Ismod"></a>5.查看模块 Ismod</h4><p><code>lsmod</code> 显示系统中所有的已经安装的模块信息。<br><code>lsmod | grep 名称</code> 用来显示特定模块信息。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">lsmod
lsmod <span class="token operator">|</span> <span class="token function">grep</span> hello<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="6-static关键字"><a href="#6-static关键字" class="headerlink" title="6.static关键字"></a>6.static关键字</h4><p><code>static</code> 修饰函数时和全局变量时，这个函数只能在本文件中使用，不能被其他文件调用，防止函数名重名。<br><code>static</code> 修饰局部变量时，这个变量放到静态区，放到程序的<code>data</code>段内，默认值为0。</p>
<p><strong>7.<code>__init</code> 和<code>__exit</code> 宏的理解</strong></p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_init</span>    <span class="token expression"><span class="token function">__section</span><span class="token punctuation">(</span><span class="token punctuation">.</span>init<span class="token punctuation">.</span>text<span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果用_init 关键字修饰时，在连接时，会把这段代码放到<code>.init.text</code> ，这个段内放的是各个驱动的加载函数部分。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__exit</span>  <span class="token expression"><span class="token function">__section</span><span class="token punctuation">(</span><span class="token punctuation">.</span>exit<span class="token punctuation">.</span>text<span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果用<code>_exit</code>关键字修饰时，在连接时，会把这段代码放到<code>.exit.text</code>，这个段内放的是各个驱动的卸载函数部分</p>
<ul>
<li><code>.init.text</code><ul>
<li>静态编译：<code>obj-y </code>   静态编译: 编程内核固定的一部分，不可拆卸。<br>动态编译：<code>obi-m</code> : 动态编译，编程模块，动态编译: 可拆可卸</li>
<li>静态编译内核时:驱动加载时,会把,<code>.init.text</code>段内的所有加载函数执行一遍，在执行后，系统会把这段内存释放掉，驱动加载代码只执行一次</li>
<li>动态编译(*.KO)内核时: 这个功能没有意义</li>
</ul>
</li>
<li><code>.exit.text</code> <ul>
<li>静态编译内核时：直接把这段代码不编译进内核，这段代码就会扔掉，因为静态编译不会卸载模块</li>
<li>动态编译(*.KO)内核时: 这个功能没有意义</li>
</ul>
</li>
</ul>
<h4 id="8-通用许可"><a href="#8-通用许可" class="headerlink" title="8.通用许可"></a>8.通用许可</h4><p>通用许可 <code>MODULE_LICENSE("Dual BSD/GPL")</code></p>
<h4 id="9-实例1——最简单模块"><a href="#9-实例1——最简单模块" class="headerlink" title="9.实例1——最简单模块"></a>9.实例1——最简单模块</h4><p>前提环境得安装了gcc</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">rpm</span> <span class="token parameter variable">-q</span> gcc							<span class="token comment"># 首先可以看看有没有 gcc</span>
<span class="token function">sudo</span> <span class="token function">apt</span> update
<span class="token function">apt</span> list <span class="token parameter variable">--upgradable</span>

<span class="token comment"># 安装gcc,这里我们实际上安装的是"build-essential"，它包含了 GNU 编辑器集合，GNU 调试器，和其他编译软件所必需的开发库和工具。下面这个命令将会安装一系列软件包，包括gcc，g++，和make。</span>
<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> build-essential
gcc <span class="token parameter variable">--version</span> 						<span class="token comment"># 首先可以看看有没有 gcc</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>最简单模块文件</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//hello.c文件</span>
<span class="token comment">/* Linux内核模块程序示例 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span> <span class="token comment">/* 包含模块所需的头文件 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span> <span class="token comment">/* 包含向内核打印日志的函数 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span>   <span class="token comment">/* 包含模块初始化和清理函数的头文件 */</span></span>

<span class="token comment">/* 初始化模块时调用的函数 */</span>
<span class="token comment">/* 该函数没有输入参数和返回值 */</span>
<span class="token keyword">int</span> <span class="token function">init_module</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">/* 向内核日志打印消息，表示模块已加载 */</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"Hello, world!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* 成功加载模块，返回0 */</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 清理模块时调用的函数 */</span>
<span class="token comment">/* 该函数没有输入参数和返回值 */</span>
<span class="token keyword">void</span> <span class="token function">cleanup_module</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">/* 向内核日志打印消息，表示模块正在卸载 */</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"Goodbye, world!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*或者用下面的代码替换上面的*/</span>
<span class="token keyword">int</span> __init <span class="token function">init_module</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"Hello, world!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> __exit <span class="token function">cleanup_module</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"Goodbye, world!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-Makefile" data-language="Makefile"><code class="language-Makefile"># Makefile文件
$(warning KERNELRELEASE=$(KERNELRELEASE))
ifeq ($(KERNELRELEASE),)

KERNELDIR ?= /lib/modules/$(shell uname -r)/build
PWD := $(shell pwd)

modules:
	$(MAKE) -C $(KERNELDIR) M=$(PWD) modules

modules_install:
	$(MAKE) -C $(KERNELDIR) M=$(PWD) modules_install

clean:
	rm -rfv *.o *~ core .depend .*.cmd *.ko *.mod.c *.mod .tmp_versions Module* modules*

.PHONY: modules modules_install clean

else
	obj-m:=hello.o

endif<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="10-查看模块内信息-modinfo"><a href="#10-查看模块内信息-modinfo" class="headerlink" title="10.查看模块内信息 modinfo"></a>10.查看模块内信息 modinfo</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">modinfo *.ko
modinfo hello.ko<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>例如:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">filename:       /home/linux/work/01-driver/hello.ko
license:        Dual BSD/GPL
srcversion:     1CCA9D77406976EC4260817
depends:        
retpoline:      Y
name:           hello
vermagic:       <span class="token number">5.4</span>.0-150-generic SMP mod_unload modversions <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="11-模块作者"><a href="#11-模块作者" class="headerlink" title="11.模块作者"></a>11.模块作者</h4><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"GeYangwen"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>					<span class="token comment">//添加到头文件的下面就可以显示作者信息</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="12-模块描述"><a href="#12-模块描述" class="headerlink" title="12.模块描述"></a>12.模块描述</h4><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">MODULE_DESCRIPTION</span><span class="token punctuation">(</span><span class="token string">"A simple Module"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//添加描述信息</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="13-内核模块的程序结构"><a href="#13-内核模块的程序结构" class="headerlink" title="13.内核模块的程序结构"></a>13.内核模块的程序结构</h4><ul>
<li>模块加载函数 (必须)</li>
<li>模块卸载函数 (必须)</li>
<li>模块许可证声明 (必须)</li>
<li>模块参数 (可选)</li>
<li>模块导出符号(可选)</li>
<li>模块作者等信息声明 (可选）</li>
</ul>
<h4 id="14-动态加载模块-modprobe"><a href="#14-动态加载模块-modprobe" class="headerlink" title="14.动态加载模块 modprobe"></a>14.动态加载模块 <code>modprobe</code></h4><p><code>modprobe</code> 和 <code>insmod</code> 都是 <code>Linux</code> 内核模块相关的命令行工具，但它们的功能有所不同。<br><code>modprobe</code> 用于动态加载和卸载内核模块，并自动解析和加载依赖的模块<br>而 <code>insmod</code> 则是一个更底层的工具，它用于手动加内核模块。与 <code>modprobe</code> 不同的是，<code>insmod</code> 不会自动解析和加载依赖的模块，也不<br>会配置模块参数。因此，通常需要手动加载所有依赖的模块，并手动设置模块参数才能保证模块正常工作。<br>由于 <code>insmod</code> 不会自动解析和加载依赖的模块，因此在加载模块之前，必须确保所有依赖的模块都已经加载并处于正确的状态.<br>如果依赖的模块没有被加载或者版本不兼容，可能会导致模块加载失败或产生其他问题。</p>
<h4 id="15-模块Makefile"><a href="#15-模块Makefile" class="headerlink" title="15.模块Makefile"></a>15.模块Makefile</h4><p>Makefile组成如下:</p>
<pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile"><span class="token comment"># Makefile</span>
<span class="token comment"># 使用$(warning)函数输出变量KERNELRELEASE的值</span>
<span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">warning</span> KERNELRELEASE<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>KERNELRELEASE<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 判断条件，如果KERNELRELEASE为空，则执行以下代码块</span>
<span class="token keyword">ifeq</span> <span class="token punctuation">(</span><span class="token variable">$</span><span class="token punctuation">(</span>KERNELRELEASE<span class="token punctuation">)</span>,<span class="token punctuation">)</span>

<span class="token comment"># 定义变量KERNELDIR，如果未定义，则默认值为/lib/modules/当前内核版本/build</span>
<span class="token comment"># 使用$(shell)函数获取当前内核版本</span>
KERNELDIR <span class="token operator">?=</span> /lib/modules/<span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">shell</span> uname -r<span class="token punctuation">)</span>/build
<span class="token comment"># 使用$(shell)函数获取当前目录路径</span>
PWD <span class="token operator">:=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">shell</span> pwd<span class="token punctuation">)</span>

<span class="token comment"># 定义目标modules，通过$(MAKE)命令在$(KERNELDIR)目录下编译当前目录下的模块</span>
<span class="token target symbol">modules</span><span class="token punctuation">:</span>
	<span class="token variable">$</span><span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> -C <span class="token variable">$</span><span class="token punctuation">(</span>KERNELDIR<span class="token punctuation">)</span> M<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PWD<span class="token punctuation">)</span> modules
<span class="token comment"># 清理编译过程中生成的临时文件和目标文件</span>
	rm -rfv *.o *~ core .depend .*.cmd *.mod.c *.mod .tmp_versions Module* modules*

<span class="token comment"># 定义目标modules_install，通过$(MAKE)命令在$(KERNELDIR)目录下安装当前目录下的模块</span>
<span class="token target symbol">modules_install</span><span class="token punctuation">:</span>
	<span class="token variable">$</span><span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> -C <span class="token variable">$</span><span class="token punctuation">(</span>KERNELDIR<span class="token punctuation">)</span> M<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PWD<span class="token punctuation">)</span> modules_install

<span class="token comment"># 定义目标clean，用于清理编译过程中生成的临时文件和目标文件</span>
<span class="token target symbol">clean</span><span class="token punctuation">:</span>
	rm -rfv *.o *~ core .depend .*.cmd *.ko *.mod.c *.mod .tmp_versions Module* modules*

<span class="token comment"># 定义伪目标.PHONY，用于标识以下目标为伪目标，即使文件系统中存在同名文件，也不会被认为是该目标的产物</span>
<span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> modules modules_install clean

<span class="token comment"># 条件语句之外的代码块，用于定义obj-m变量，指向当前目录下的hello.o模块文件</span>
<span class="token keyword">else</span>
	obj-m<span class="token operator">:=</span>hello.o

<span class="token keyword">endif</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@ubuntu:/home/linux/work/01-driver<span class="token comment"># make</span>

<span class="token comment"># 第一次</span>
Makefile:3: <span class="token assign-left variable">KERNELRELEASE</span><span class="token operator">=</span>
<span class="token function">make</span> <span class="token parameter variable">-C</span> /lib/modules/5.4.0-150-generic/build <span class="token assign-left variable">M</span><span class="token operator">=</span>/home/linux/work/01-driver modules
make<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: 进入目录“/usr/src/linux-headers-5.4.0-150-generic”

<span class="token comment"># 第二次</span>
/home/linux/work/01-driver/Makefile:3: <span class="token assign-left variable">KERNELRELEASE</span><span class="token operator">=</span><span class="token number">5.4</span>.0-150-generic
  CC <span class="token punctuation">[</span>M<span class="token punctuation">]</span>  /home/linux/work/01-driver/hello.o						<span class="token comment"># 这个把.c文件编程.o文件</span>
  
<span class="token comment"># 第三次</span>
/home/linux/work/01-driver/Makefile:3: <span class="token assign-left variable">KERNELRELEASE</span><span class="token operator">=</span><span class="token number">5.4</span>.0-150-generic
  Building modules, stage <span class="token number">2</span>.
  MODPOST <span class="token number">1</span> modules
  CC <span class="token punctuation">[</span>M<span class="token punctuation">]</span>  /home/linux/work/01-driver/hello.mod.o
  LD <span class="token punctuation">[</span>M<span class="token punctuation">]</span>  /home/linux/work/01-driver/hello.ko
make<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: 离开目录“/usr/src/linux-headers-5.4.0-150-generic”
<span class="token comment"># 清理编译过程中生成的临时文件和目标文件</span>
<span class="token function">rm</span> <span class="token parameter variable">-rfv</span> *.o *~ core .depend .*.cmd *.mod.c *.mod .tmp_versions Module* modules*
已删除<span class="token string">'hello.mod.o'</span>
已删除<span class="token string">'hello.o'</span>
已删除<span class="token string">'.hello.ko.cmd'</span>
已删除<span class="token string">'.hello.mod.cmd'</span>
已删除<span class="token string">'.hello.mod.o.cmd'</span>
已删除<span class="token string">'.hello.o.cmd'</span>
已删除<span class="token string">'hello.mod.c'</span>
已删除<span class="token string">'hello.mod'</span>
已删除<span class="token string">'Module.symvers'</span>
已删除<span class="token string">'modules.order'</span>

ll /lib/modules/5.4.0-150-generic/build			<span class="token comment"># 这个是软连接</span>
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">40</span> <span class="token number">5</span>月  <span class="token number">19</span>  <span class="token number">2023</span> /lib/modules/5.4.0-150-generic/build -<span class="token operator">&gt;</span> /usr/src/linux-headers-5.4.0-150-generic/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Makefile运行过程分析，<br>这个Makefile一共执行了3次</p>
<ul>
<li>第1次执行Makefile</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 在当前目录下输入make 后，会执行当前目录下的Makefile</span>
<span class="token comment"># 第一次执行Makefile</span>
<span class="token variable"><span class="token variable">$(</span>warning <span class="token assign-left variable">KERNELRELEASE</span><span class="token operator">=</span>S<span class="token punctuation">(</span>KERNELRELEASE<span class="token punctuation">)</span><span class="token variable">)</span></span>		<span class="token comment">#打印变量内的值</span>
<span class="token comment"># 因为没有没有赋值，KERNELRELEASE =空</span>
<span class="token comment"># MakefiTe:1: KERNELRELEASE=</span>

<span class="token comment"># 条件为真</span>
ifeq <span class="token punctuation">(</span><span class="token variable"><span class="token variable">$(</span>KERNELRELEASE<span class="token variable">)</span></span>,<span class="token punctuation">)</span>	
KERNELDIR ?<span class="token operator">=</span> /lib/modules/<span class="token variable"><span class="token variable">$(</span>she11 <span class="token function">uname</span> <span class="token parameter variable">-r</span><span class="token variable">)</span></span>/build		<span class="token comment"># (本地开发) 等于</span>
<span class="token comment"># /lib/modules/5.4.0-150-generic/build 这个目录存放的是编译内核必须的一些头文件和库</span>

<span class="token environment constant">PWD</span> :<span class="token operator">=</span> /home/1inux/1inux-driver/01-day/02-char-module_init
<span class="token comment"># 在输入make后默认会执行第一个目标，第一目标:modules:</span>
<span class="token comment"># 进而执行: S(MAKE) -C $(KERNELDIR) M=S(PWD) modules</span>
<span class="token comment"># $(MAKE) = make</span>
<span class="token comment"># make -c : 进入子目录(/lib/modules/5.4.0-150-generic/build) 下,去执行子目录下的Makefile</span>
<span class="token comment"># M =$(PWD) :/home/linux/work/01-driver   # 这个是我们所在的路径</span>
<span class="token comment"># modules : 告诉内核我要编译模块</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>第2次执行Makefile</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 第二次: 执行子目录下的Makefile后，会再次调用当前目录下的Makefile</span>
<span class="token comment"># 在执行子目录(/lib/modules/5.4.0-150-generic/build)下的Makefile后，会对KERNELRELEASE 进行赋值KERNELRELEASE=5.4.0-150-generic</span>
<span class="token comment"># ifeq(S(KERNELRELEASE)，条件为假</span>
<span class="token comment"># 执行e1se分支</span>
<span class="token comment"># obj-m := hello.o(obj-m 表示的要编译成模块所依赖的*.o文件)(动态编译)</span>
<span class="token comment"># obj-y :静态编译</span>
<span class="token comment"># 执行后会把hello.c编译程hello.o文件</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>第3次执行Makefile</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 执行后会把hello.o编译为hello.ko文件</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h4 id="16-实例2——模块安装与卸载"><a href="#16-实例2——模块安装与卸载" class="headerlink" title="16.实例2——模块安装与卸载"></a>16.实例2——模块安装与卸载</h4><p>实现模块的安装与卸载<br><code>module_init()</code>使用<br><code>module_exit()</code>使用<br>源文件和源代码</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span> </span>

<span class="token comment">/* 
 * 设置模块的许可协议。
 * 设置模块的作者信息。
 * 设置模块的描述信息。
 */</span>
<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"Dual BSD/GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"GeYangwen"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_DESCRIPTION</span><span class="token punctuation">(</span><span class="token string">"A simple Hello world module"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> __init <span class="token function">hello_int</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"Hello, world!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> __exit <span class="token function">hello_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"Goodbye, world!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>hello_int<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>hello_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>程序解释</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">oot@ubuntu:/home/linux/work/02-driver<span class="token comment"># insmod hello.ko </span>
root@ubuntu:/home/linux/work/02-driver<span class="token comment"># ls</span>
hello.c  hello.ko  Makefile
root@ubuntu:/home/linux/work/02-driver<span class="token comment"># dmesg</span>
<span class="token punctuation">[</span><span class="token number">13230.030136</span><span class="token punctuation">]</span> Hello, world<span class="token operator">!</span>
root@ubuntu:/home/linux/work/02-driver<span class="token comment"># lsmod | grep hello</span>
hello                  <span class="token number">16384</span>  <span class="token number">0</span>
root@ubuntu:/home/linux/work/02-driver<span class="token comment"># rmmod hello</span>
root@ubuntu:/home/linux/work/02-driver<span class="token comment"># dmesg</span>
<span class="token punctuation">[</span><span class="token number">13230.030136</span><span class="token punctuation">]</span> Hello, world<span class="token operator">!</span>
<span class="token punctuation">[</span><span class="token number">13293.781785</span><span class="token punctuation">]</span> Goodbye, world<span class="token operator">!</span>
root@ubuntu:/home/linux/work/02-driver<span class="token comment"># lsmod | grep hello</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>insmod hello.ko</code> 会执行<code>module_init</code>函数，进而去执行<code>hello_init</code>函数，最后执行<code>printk(KERN_INFO "Hello, world!\n");</code><br><code>rmmod hello</code> 会执行<code>module_exit</code>函数，进而去执行<code>hello_exit</code>函数，最后执行<code>printk(KERN_INFO "Goodbye, world!\n");</code></p>
<h3 id="1-3-模块参数"><a href="#1-3-模块参数" class="headerlink" title="1.3 模块参数"></a>1.3 模块参数</h3><p>模块参数是指内核模块中可以被用户动态设置的变量。内核模块需要根据不同的应用场景和用户需求来进行定制和配置。这时就需要一些参数来进行调整设置。<br>如果需要在内核模块中支持参数，需要使用<code>module_param()</code>宏进行注册。这个宏接受三个参数:<strong>参数名、参数类型和权限</strong></p>
<h4 id="1-module-param-注册模块参数"><a href="#1-module-param-注册模块参数" class="headerlink" title="1.module_param 注册模块参数"></a>1.<code>module_param</code> 注册模块参数</h4><ul>
<li>函数原型</li>
</ul>
<p>	</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
convenience many standard types are provided but
you can create your own by defining those variables.

standard types are:
byte, short, ushort, int, uint, long, ulong
charp: a character pointer
boo1: a boo1, values 0/1, y/n, Y/N.
invboo1: the above, only sense-reversed (N = true)
*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">module_param</span><span class="token expression"><span class="token punctuation">(</span>name<span class="token punctuation">,</span>type<span class="token punctuation">,</span>perm<span class="token punctuation">)</span></span></span>
<span class="token function">module_param_named</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>name<span class="token punctuation">,</span>type<span class="token punctuation">,</span>perm<span class="token punctuation">)</span>	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>函数功能<ul>
<li>注册一个模块参数</li>
</ul>
</li>
<li>函数参数<ul>
<li>name:变量的名称</li>
<li>type:变量的类型可以是 <code>short</code> <code>int</code> <code>long</code> <code>charp</code> <code>uint</code> <code>ushort</code> <code>ulong</code> <code>bool</code> <code>invbool</code></li>
<li>perm:权限，表示变量的权限（一般的权限是 SIRUGO 是用户、组、其它用户都可以读，但是不可以写）</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S_IRUGO</span>	<span class="token expression"><span class="token punctuation">(</span>S_IRUSR <span class="token operator">|</span> S_IRGRP <span class="token operator">|</span> S_IROTH<span class="token punctuation">)</span>				</span><span class="token comment">// 这是用户| 所在组| 其他   的权限</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h4 id="2-MODULE-PARAM-DESC参数描述"><a href="#2-MODULE-PARAM-DESC参数描述" class="headerlink" title="2.MODULE_PARAM_DESC参数描述"></a>2.<code>MODULE_PARAM_DESC</code>参数描述</h4><ul>
<li><p>函数原型</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">MODULE_PARM_DESC</span><span class="token expression"><span class="token punctuation">(</span>_parm，desc<span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>函数功能</p>
<ul>
<li>参数描述</li>
</ul>
</li>
<li><p>函数参数I</p>
<ul>
<li>_parm:表示参数的名称</li>
<li>desc:表示参数的描述</li>
</ul>
</li>
</ul>
<p>例如如:</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// short类型:			</span>
<span class="token function">module_param</span><span class="token punctuation">(</span>myshort<span class="token punctuation">,</span> <span class="token keyword">short</span><span class="token punctuation">,</span> S_IRUGO<span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//注册一个参数</span>
<span class="token function">MODULE_PARM_DESC</span><span class="token punctuation">(</span>myshort<span class="token punctuation">,</span> <span class="token string">"A short integer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 运行时:</span>
insmod hello<span class="token punctuation">.</span>ko myshort<span class="token operator">=</span><span class="token number">100</span>

<span class="token comment">// int 类型:</span>
<span class="token function">module_param</span><span class="token punctuation">(</span>myint<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> S_IRUGO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_PARM_DESC</span><span class="token punctuation">(</span>myint<span class="token punctuation">,</span> <span class="token string">"An int integer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 运行时:</span>
insmod hello<span class="token punctuation">.</span>ko myint<span class="token operator">=</span><span class="token number">100</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="3-module-param-array传递数组"><a href="#3-module-param-array传递数组" class="headerlink" title="3.module_param_array传递数组"></a>3.<code>module_param_array</code>传递数组</h4><ul>
<li><p>函数原型</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">module_param_array</span><span class="token expression"><span class="token punctuation">(</span>name，type，nump，perm<span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>函数功能</p>
<ul>
<li>传入一个数组</li>
</ul>
</li>
<li><p>函数参数</p>
<ul>
<li><p>name:传入的数组名称</p>
</li>
<li><p>type: 数组的类型</p>
</li>
<li><p>nump:数组成员个数的指针</p>
</li>
<li><p>perm:权限，表示变量的权限<br>一般的权限是 S_IRUGO ，用户、组、其它用户都可以读，但是不可以写</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">S_IRUGO</span><span class="token expression"><span class="token punctuation">(</span>S_IRUSR<span class="token operator">|</span>S_IRGRP<span class="token operator">|</span>S_IROTH<span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ul>
</li>
</ul>
<p><strong>案例</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* hello.c*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span> </span>

<span class="token comment">/* 
 * 设置模块的许可协议。
 * 设置模块的作者信息。
 * 设置模块的描述信息。
 */</span>
<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"Dual BSD/GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"GeYangwen"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_DESCRIPTION</span><span class="token punctuation">(</span><span class="token string">"A simple Hello world module"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">short</span> myshort <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> myint <span class="token operator">=</span> <span class="token number">4200</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">long</span> mylong <span class="token operator">=</span> <span class="token number">1000000</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">char</span> <span class="token operator">*</span>mycharp <span class="token operator">=</span> <span class="token string">"a char pointer"</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> myint_array<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>myint_array<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">module_param</span><span class="token punctuation">(</span>myshort<span class="token punctuation">,</span> <span class="token keyword">short</span><span class="token punctuation">,</span> S_IRUGO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_PARM_DESC</span><span class="token punctuation">(</span>myshort<span class="token punctuation">,</span> <span class="token string">"A short integer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">module_param</span><span class="token punctuation">(</span>myint<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> S_IRUGO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_PARM_DESC</span><span class="token punctuation">(</span>myint<span class="token punctuation">,</span> <span class="token string">"An int integer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">module_param</span><span class="token punctuation">(</span>mylong<span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token punctuation">,</span> S_IRUGO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_PARM_DESC</span><span class="token punctuation">(</span>mylong<span class="token punctuation">,</span> <span class="token string">"A long integer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">module_param</span><span class="token punctuation">(</span>mycharp<span class="token punctuation">,</span> charp<span class="token punctuation">,</span> S_IRUGO<span class="token punctuation">)</span><span class="token punctuation">;</span>						<span class="token comment">//传参字符串</span>
<span class="token function">MODULE_PARM_DESC</span><span class="token punctuation">(</span>mycharp<span class="token punctuation">,</span> <span class="token string">"A charp integer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">module_param_array</span><span class="token punctuation">(</span>myint_array<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>num<span class="token punctuation">,</span> S_IRUGO<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//传参数组</span>
<span class="token function">MODULE_PARM_DESC</span><span class="token punctuation">(</span>myint_array<span class="token punctuation">,</span> <span class="token string">"A myint_array integer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">hello_int</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"hello, driver install sucessed!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> i<span class="token punctuation">;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"myshort = %d\n"</span><span class="token punctuation">,</span>myshort<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"myint = %d\n"</span><span class="token punctuation">,</span>myint<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"mylong = %ld\n"</span><span class="token punctuation">,</span>mylong<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"mycharp = %s\n"</span><span class="token punctuation">,</span>mycharp<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"myint_array[%d] = %d\n"</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span>myint_array<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">hello_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"hello, driver uninstall sucessed!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>hello_int<span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//宏函数做关联</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>hello_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>加载命令如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">su</span>
<span class="token function">dmesg</span> <span class="token parameter variable">-c</span>
<span class="token function">dmesg</span> <span class="token parameter variable">-c</span>
insmod hello.ko		<span class="token comment">#直接加载</span>
<span class="token function">dmesg</span>
rmmod hello
<span class="token function">dmesg</span> <span class="token parameter variable">-c</span>
<span class="token function">dmesg</span> <span class="token parameter variable">-c</span>

insmod hello.ko <span class="token assign-left variable">myshort</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">myint</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">mylong</span><span class="token operator">=</span><span class="token number">3</span> <span class="token assign-left variable">mycharp</span><span class="token operator">=</span><span class="token string">"Geyangwen"</span> <span class="token assign-left variable">myint_array</span><span class="token operator">=</span><span class="token number">1,2</span>,3,4		<span class="token comment">#带参数加载</span>
<span class="token function">dmesg</span>
rmmod hello
<span class="token function">dmesg</span> <span class="token parameter variable">-c</span>
<span class="token function">dmesg</span> <span class="token parameter variable">-c</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="1-4-导出符号"><a href="#1-4-导出符号" class="headerlink" title="1.4 导出符号"></a>1.4 导出符号</h3><p>在Linux 内核中，导出符号是指将函数、变量或常量等代码标记为可由其他模块使用的符号。如果一个模块中定义了一个函数或变量，并希望其他模块能够调用或引用它，那么就需要将该符号导出。</p>
<p>在内核中，通过 <code>EXPORT_SYMBOL</code> 或 <code>EXPORT_SYMBOL_GPL</code> 宏来实现符号导出。这两个宏的定义如下</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">EXPORT_SYMBOL</span><span class="token punctuation">(</span>symbol_name<span class="token punctuation">)</span><span class="token operator">:</span>
<span class="token keyword">void</span> <span class="token function">EXPORT_SYMBOL_GPL</span><span class="token punctuation">(</span>symbo1_name<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>其中，<code>symbol_name</code> 是要导出的符号名称，其类型可以是<strong>函数、变量或常量</strong>等.</p>
<p>相比而言，<code>EXPORT_SYMBOL_GPL</code> 宏只允 <code>GPL</code>协议的模块使用该符号。这是因为许多内核开发人员认为，只有遵循 GPL协议的模块才应该使用内核中的某些符号，以确保内核的代码质量和安全性。</p>
<p><strong>需要注意的是，在内核开发中，不建议随意导出符号</strong>，因为这可能会对内核的安全性和稳定性造成不利影响。只有在必要的情况下才应该将符号导出。<br>另外，导出符号的过程也需要仔细考虑，以确保导出的符号不会被误用或滥用。</p>
<h2 id="第02章-Linux字符设备驱动"><a href="#第02章-Linux字符设备驱动" class="headerlink" title="第02章 Linux字符设备驱动"></a>第02章 Linux字符设备驱动</h2><h3 id="2-1-设备驱动介绍"><a href="#2-1-设备驱动介绍" class="headerlink" title="2.1 设备驱动介绍"></a>2.1 设备驱动介绍</h3><h4 id="1-设备驱动分类"><a href="#1-设备驱动分类" class="headerlink" title="1.设备驱动分类"></a>1.设备驱动分类</h4><p>设备驱动可以分为下面三类</p>
<ul>
<li>字符设备驱动</li>
<li>块设备驱动(简单地理解就是储存类的设备)</li>
<li>网络设备驱动</li>
</ul>
<h4 id="2-设备驱动在内核中的结构"><a href="#2-设备驱动在内核中的结构" class="headerlink" title="2.设备驱动在内核中的结构"></a>2.设备驱动在内核中的结构</h4><p>。视图1</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202407221053663.png" alt="image-20240722105304506"></p>
<ul>
<li>视图2</li>
</ul>
<p>​	<img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202407221053166.png" alt="image-20240722105345028"></p>
<h3 id="2-2-字符设备驱动原理"><a href="#2-2-字符设备驱动原理" class="headerlink" title="2.2 字符设备驱动原理"></a>2.2 字符设备驱动原理</h3><h4 id="1-设备号理解"><a href="#1-设备号理解" class="headerlink" title="1.设备号理解"></a>1.设备号理解</h4><ul>
<li><p>包括主设备号和次设备号</p>
</li>
<li><p>主设备号: 表示是哪一类的驱驱动 usb、adc、led、uart。</p>
</li>
<li><p>通过 <code>cat /proc/devices</code> 显示系统设备号。</p>
</li>
<li><p>字符设备和块设备的设备号是独立的</p>
</li>
<li><p>次设备号 用来表示这一类设备中的哪一个设备，用这些命令可以查看 <code>ls /dev/tty</code> ,<code>ls /dev/tty* -l</code></p>
</li>
<li><p>```shell<br>crw-rw-rw- 1 root  tty     5,  0 7月  22 10:20 /dev/tty			# 5表示主设备号，0表示次设备号<br>crw–w—- 1 root  tty     4,  0 7月  22 09:14 /dev/tty0<br>crw–w—- 1 linux tty     4,  1 7月  22 09:14 /dev/tty1<br>crw–w—- 1 root  tty     4, 10 7月  22 09:14 /dev/tty10<br>crw–w—- 1 root  tty     4, 11 7月  22 09:14 /dev/tty11<br>crw–w—- 1 root  tty     4, 12 7月  22 09:14 /dev/tty12</p>
<pre class="line-numbers language-none"><code class="language-none">
- 设备号内核用一个变量来表示 `dev_t(u32)`来表示一个设备号       u32表示无符号的32位的变量

- 高20为来表示主设备号 低12为表示次设备号
  主设备号: 表示范围 0~ (1M-1)
  次设备号: 表示范围 0~ (4096-1)

- 可以使用一个宏函数去生成一个设备号

```c
#define MINORBITS 20
#define MKDEV(ma,mi)   (((ma) &lt;&lt; MINORBITS)|(mi))		//ma表示住设备号，mi表示次设备号， 主设备号左移20位与上次设备号
dev_t devno = MKDEV(500,0)		//生成一个设备号	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<h4 id="2-register-chrdev-region静态申请设备号"><a href="#2-register-chrdev-region静态申请设备号" class="headerlink" title="2.register_chrdev_region静态申请设备号"></a>2.<code>register_chrdev_region</code>静态申请设备号</h4><p>。函数原型</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;linux/fs.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">register_chrdev_region</span><span class="token punctuation">(</span><span class="token class-name">dev_t</span> from<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> count<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li><p>函数功能</p>
<ul>
<li>静态申请一个范围内的设备号</li>
</ul>
</li>
<li><p>函数参数</p>
<ul>
<li><p>form:从哪一个设备号开始向内核去申请设备号，向内核去申请一个或多个设备号</p>
<ul>
<li><p>如果这个设备号内核没有占用，可以申请到。	</p>
</li>
<li><p>否则申请失败。</p>
</li>
</ul>
</li>
<li><p>count:表示要申请设备的个数</p>
</li>
<li><p>name:要申请设备号的名称<br>函数返回值:<br>成功返回0，失败返回负数（错误码）</p>
</li>
</ul>
</li>
</ul>
<p>例如：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> ret<span class="token punctuation">;</span>
<span class="token class-name">dev_t</span> devno <span class="token operator">=</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>hello_major<span class="token punctuation">,</span> hello_minor<span class="token punctuation">)</span><span class="token punctuation">;</span>
ret <span class="token operator">=</span> <span class="token function">register_chrdev_region</span><span class="token punctuation">(</span>devno<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"hello, can't get major %d\n"</span><span class="token punctuation">,</span> hello_major<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>使用命令去查看申请到的设备号 <code>cat /proc/devices</code></p>
<h4 id="3-alloc-chrdev-region动态申请设备号"><a href="#3-alloc-chrdev-region动态申请设备号" class="headerlink" title="3.alloc_chrdev_region动态申请设备号"></a>3.<code>alloc_chrdev_region</code>动态申请设备号</h4><p>函数原型</p>
<p>函数原型</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;linux/fs.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">alloc_chrdev_region</span><span class="token punctuation">(</span><span class="token class-name">dev_t</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> baseminor<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> count<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>函数功能<ul>
<li>动态申请设备号 I</li>
<li>随机分配一个设备号，一个可用的设备号</li>
</ul>
</li>
<li>函数参数<ul>
<li>dev: 设备号变量的指针</li>
<li>baseminor:次设备号开始于那一个数字</li>
<li>count:需要的多少个设备</li>
<li>name: 要申请设备的名称</li>
</ul>
</li>
<li>函数返回值:<br>成功返回0，失败负数</li>
</ul>
<h4 id="4-unregister-chrdev-region注销设备号"><a href="#4-unregister-chrdev-region注销设备号" class="headerlink" title="4.unregister_chrdev_region注销设备号"></a>4.<code>unregister_chrdev_region</code>注销设备号</h4><p>函数原型</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;linux/fs.h&gt;</span></span>
<span class="token keyword">void</span> <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span><span class="token class-name">dev_t</span> from<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>函数功能<ul>
<li>注销设备号</li>
</ul>
</li>
<li>函数参数<ul>
<li>form:要释放的设备号</li>
<li>count: 要释放几个设备号</li>
</ul>
</li>
<li>函数返回值:<ul>
<li>无返回值</li>
</ul>
</li>
</ul>
<h4 id="补充-tags-索引搜索系统"><a href="#补充-tags-索引搜索系统" class="headerlink" title="补充 tags 索引搜索系统"></a>补充 tags 索引搜索系统</h4><p>在内核源码路径下使用命令生成索引</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">make</span> tags<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>在内核源码的顶层目录下查找索引</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vi</span> <span class="token parameter variable">-t</span> 函数名/结构体名/变量名
<span class="token function">vi</span> <span class="token parameter variable">-t</span> MKDEV
<span class="token function">vi</span> <span class="token parameter variable">-t</span> unregister_chrdev_region<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>可以找到函数的定义和结果体定义</p>
<ul>
<li>可以使用<code>ctrl +]</code>进行函数跟踪或查找系统所有定义</li>
<li>使用<code>ctrl + t</code> 返回上一级目录</li>
</ul>
<h4 id="5-cdev-init字符设备初始化"><a href="#5-cdev-init字符设备初始化" class="headerlink" title="5.cdev_init字符设备初始化"></a>5.<code>cdev_init</code>字符设备初始化</h4><ul>
<li>函数原型  cdev——char devices</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;linux/cdev.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">cdev</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">kobject</span> kobj<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>owner<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> <span class="token operator">*</span>ops<span class="token punctuation">;</span>       <span class="token comment">/* 这些函数定义了字符设备的具体行为，如读、写、打开、关闭等操作 */</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> list<span class="token punctuation">;</span>                  <span class="token comment">/* list用于将cdev结构体实例链接到一个列表中 */</span>
    <span class="token class-name">dev_t</span> dev<span class="token punctuation">;</span>                               <span class="token comment">/* dev存储了字符设备的设备号 */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> count<span class="token punctuation">;</span>                      <span class="token comment">/* count用于记录引用这个字符设备的次数。当count为0时，表示没有进程正在使用这个设备，可以进行安全的删除操作 */</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">cdev</span> <span class="token operator">*</span>cdev<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> <span class="token operator">*</span>fops<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>函数功能</p>
<ul>
<li><code>cdev_init()</code>初始化一个<code>cdev</code>结构体，把<code>cdev</code>这个结构体和<code>file_operations</code>结构体进行关联</li>
</ul>
</li>
<li><p>函数参数</p>
<ul>
<li>cdev: 要初始化的<code>cdev</code>结构体指</li>
<li>fops: 要初始化的<code>file_operations</code>结构体指针</li>
</ul>
</li>
<li><p>函数返回值:<br>无返回值</p>
</li>
<li><p>例如:</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">cdev<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token operator">:</span> 		<span class="token comment">// 表示的是指向本模块的指针</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">THIS_MODULE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token operator">&amp;</span>__this_module<span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li>
</ul>
<h4 id="6-file-operations结构体"><a href="#6-file-operations结构体" class="headerlink" title="6.file_operations结构体"></a>6.<code>file_operations</code>结构体</h4><p><code>file_operations</code>结构体是字符设备驱动所支持的文件操作</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">file_operations</span> <span class="token punctuation">{</span> 
    <span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>owner<span class="token punctuation">;</span><span class="token comment">//拥有该结构的模块的指针，一般为THIS_MODULES </span>
    <span class="token class-name">loff_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>llseek<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//用来修改文件当前的读写位置 </span>
    <span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>read<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//从设备中同步读取数据 </span>
    <span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>write<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//向设备发送数据</span>
    <span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>aio_read<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kiocb</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">iovec</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化一个异步的读取操作 </span>
    <span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>aio_write<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kiocb</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">iovec</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化一个异步的写入操作 </span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>readdir<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">filldir_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//仅用于读取目录，对于设备文件，该字段为NULL </span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>poll<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">poll_table_struct</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//轮询函数，判断目前是否可以进行非阻塞的读写或写入</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>ioctl<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//执行设备I/O控制命令 </span>
    <span class="token keyword">long</span> <span class="token punctuation">(</span><span class="token operator">*</span>unlocked_ioctl<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//不使用BLK文件系统，将使用此种函数指针代替ioctl </span>
    <span class="token keyword">long</span> <span class="token punctuation">(</span><span class="token operator">*</span>compat_ioctl<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//在64位系统上，32位的ioctl调用将使用此函数指针代替 </span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>mmap<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">vm_area_struct</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//用于请求将设备内存映射到进程地址空间</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>open<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//打开 </span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>flush<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">fl_owner_t</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>release<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//关闭 </span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fsync<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">dentry</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span> datasync<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//刷新待处理的数据 </span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>aio_fsync<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kiocb</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span> datasync<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//异步刷新待处理的数据 </span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fasync<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//通知设备FASYNC标志发生变化 </span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>lock<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file_lock</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>sendpage<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">page</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token punctuation">(</span><span class="token operator">*</span>get_unmapped_area<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>check_flags<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>flock<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file_lock</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>splice_write<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pipe_inode_info</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>splice_read<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">pipe_inode_info</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>setlease<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file_lock</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>用户进程利用在对设备文件进行诸如read/write操作的时候，<strong>系统调用通过设备文件的主设备号找到相应的设备驱动程序，然后读取这个数据结构相应的函数指针，接着把控制权交给该函数，这是Linux的设备驱动程序工作的基本原理。</strong></p>
<p>例如：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">cdev</span> cdev<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">file_operations</span> hello_fops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS MODULE
<span class="token punctuation">}</span>

<span class="token comment">//表示的是指向本模块的指针</span>
<span class="token comment">//cdev.owner = THIS_MODULE</span>
<span class="token comment">//#define THIS_MODULE (&amp;__this_module)</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">char_reg_setup_cdev</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> error<span class="token punctuation">,</span> devno <span class="token operator">=</span> <span class="token function">MKDEV</span> <span class="token punctuation">(</span>he11o_major<span class="token punctuation">,</span> he11o_minor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">cdev_init</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>cdev，<span class="token operator">&amp;</span>hello_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//把上面定义的两个结构体关联到一起，我用我的指针保存你的地址</span>
    cdev<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">;</span>
    cdev<span class="token punctuation">.</span>ops <span class="token operator">=</span> <span class="token operator">&amp;</span>hello_fops<span class="token punctuation">;</span>
    error <span class="token operator">=</span> <span class="token function">cdev_add</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>cdev<span class="token punctuation">,</span> devno <span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">printk</span> <span class="token punctuation">(</span>KERN_NOTICE <span class="token string">"Error %d adding char_reg_setup_cdev"</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="7-cdev-add字符设备添加到内核链表内"><a href="#7-cdev-add字符设备添加到内核链表内" class="headerlink" title="7.cdev_add字符设备添加到内核链表内"></a>7.<code>cdev_add</code>字符设备添加到内核链表内</h4><ul>
<li>函数原型</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;linux/cdev.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">cdev</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token class-name">dev_t</span> dev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> count<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>函数功能<ul>
<li>字符设备添加到内核链表内</li>
</ul>
</li>
<li>函数参数<ul>
<li>cdev: 要初始化的结构体指针</li>
<li>fops: 要初始化的结构体指针</li>
</ul>
</li>
<li>函数返回值:<ul>
<li>成功返回0；</li>
<li>失败返回负数的错误码</li>
</ul>
</li>
</ul>
<h4 id="8-cdev-del从系统链表中删除一个设备"><a href="#8-cdev-del从系统链表中删除一个设备" class="headerlink" title="8.cdev_del从系统链表中删除一个设备"></a>8.<code>cdev_del</code>从系统链表中删除一个设备</h4><ul>
<li><p>函数原型</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;linux/cdev.h&gt;</span></span>
<span class="token keyword">void</span> <span class="token function">cdev_de1</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">cdev</span> <span class="token operator">*</span>p<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>


</li>
<li><p>函数功能</p>
<ul>
<li>从系统链表中删除一个字符设备</li>
</ul>
</li>
<li><p>函数参数</p>
<ul>
<li>cdev: 要删除的结构体指针</li>
</ul>
</li>
<li><p>函数返回值:</p>
<ul>
<li>返回值</li>
</ul>
</li>
</ul>
<h4 id="9-mknod-手动创建设备节点"><a href="#9-mknod-手动创建设备节点" class="headerlink" title="9.mknod 手动创建设备节点"></a>9.<code>mknod</code> 手动创建设备节点</h4><ul>
<li><p>创建设备文件，把设备号和文件进行关联</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mknod</span> /dev/hello c <span class="token number">500</span> <span class="token number">0</span>
crw-r--r-- <span class="token number">1</span> root root <span class="token number">250</span>，0 <span class="token number">7</span>月 <span class="token number">30</span> <span class="token number">16</span>:46 /dev/hello<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li>
</ul>
<h4 id="10-实例3——字符设备实现"><a href="#10-实例3——字符设备实现" class="headerlink" title="10.实例3——字符设备实现"></a>10.实例3——字符设备实现</h4><p>字符设备实现，对设备进行打开与关闭操作<br>源文件</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*hello.c*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h&gt;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h&gt;</span> </span>

<span class="token comment">/* 
 * 设置模块的许可协议。
 * 设置模块的作者信息。
 * 设置模块的描述信息。
 */</span>
<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"Dual BSD/GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"GeYangwen"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_DESCRIPTION</span><span class="token punctuation">(</span><span class="token string">"A simple Hello world module"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> hello_major <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> hello_minor <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">hello_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"hello_driver打开成功!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">hello_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"hello_driver关闭成功!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token class-name">cdev</span> cdev <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE						<span class="token comment">//表示的是指向本模块的指针</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">file_operations</span> hello_fops <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>open <span class="token operator">=</span> hello_open<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>release <span class="token operator">=</span> hello_release
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">hello_int</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>
	<span class="token class-name">dev_t</span> devno <span class="token operator">=</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>hello_major<span class="token punctuation">,</span> hello_minor<span class="token punctuation">)</span><span class="token punctuation">;</span>
	ret <span class="token operator">=</span> <span class="token function">register_chrdev_region</span><span class="token punctuation">(</span>devno<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"错误：设备号申请失败： %d\n"</span><span class="token punctuation">,</span> hello_major<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cdev<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">cdev</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 使用memset()函数初始化cdev结构体</span>
	<span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cdev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hello_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>
	ret <span class="token operator">=</span> <span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cdev<span class="token punctuation">,</span> devno<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">/* 向内核链表添加一个cdev结构体 */</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"错误：添加cdev失败\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"hello_driver installed sucessed!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">hello_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">dev_t</span> devno <span class="token operator">=</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>hello_major<span class="token punctuation">,</span> hello_minor<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">cdev_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cdev<span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">/* 从内核链表中删除指定的cdev */</span>
	<span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>devno<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"hello_driver uninstall sucessed!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>hello_int<span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//宏函数做关联</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>hello_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*main.c*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/hello"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fd = %d\n"</span><span class="token punctuation">,</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile"><span class="token comment"># Makefile</span>
<span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">warning</span> KERNELRELEASE<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>KERNELRELEASE<span class="token punctuation">)</span><span class="token punctuation">)</span>		<span class="token comment"># 使用$(warning)函数输出变量KERNELRELEASE的值</span>

<span class="token keyword">ifeq</span> <span class="token punctuation">(</span><span class="token variable">$</span><span class="token punctuation">(</span>KERNELRELEASE<span class="token punctuation">)</span>,<span class="token punctuation">)</span>	<span class="token comment"># 判断条件，如果KERNELRELEASE为空，则执行以下代码块</span>

<span class="token comment"># 定义变量KERNELDIR，如果未定义，则默认值为/lib/modules/当前内核版本/build</span>
<span class="token comment"># 使用$(shell)函数获取当前内核版本</span>
KERNELDIR <span class="token operator">?=</span> /lib/modules/<span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">shell</span> uname -r<span class="token punctuation">)</span>/build
<span class="token comment"># 使用$(shell)函数获取当前目录路径</span>
PWD <span class="token operator">:=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">shell</span> pwd<span class="token punctuation">)</span>

<span class="token comment"># 定义目标modules，通过$(MAKE)命令在$(KERNELDIR)目录下编译当前目录下的模块</span>
<span class="token target symbol">modules</span><span class="token punctuation">:</span>
	<span class="token variable">$</span><span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> -C <span class="token variable">$</span><span class="token punctuation">(</span>KERNELDIR<span class="token punctuation">)</span> M<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PWD<span class="token punctuation">)</span> modules
<span class="token comment"># 清理编译过程中生成的临时文件和目标文件</span>
	gcc main.c -o main
	rm -rfv *.o *~ core .depend .*.cmd *.mod.c *.mod .tmp_versions Module* modules*

<span class="token comment"># 定义目标modules_install，通过$(MAKE)命令在$(KERNELDIR)目录下安装当前目录下的模块</span>
<span class="token target symbol">modules_install</span><span class="token punctuation">:</span>
	<span class="token variable">$</span><span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> -C <span class="token variable">$</span><span class="token punctuation">(</span>KERNELDIR<span class="token punctuation">)</span> M<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PWD<span class="token punctuation">)</span> modules_install

<span class="token comment"># 定义目标clean，用于清理编译过程中生成的临时文件和目标文件</span>
<span class="token target symbol">clean</span><span class="token punctuation">:</span>
	rm -rfv *.o *~ core .depend .*.cmd *.ko *.mod.c *.mod .tmp_versions Module* modules*
	rm -rfv main

<span class="token comment"># 定义伪目标.PHONY，用于标识以下目标为伪目标，即使文件系统中存在同名文件，也不会被认为是该目标的产物</span>
<span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> modules modules_install clean

<span class="token comment"># 条件语句之外的代码块，用于定义obj-m变量，指向当前目录下的hello.o模块文件</span>
<span class="token keyword">else</span>
	obj-m<span class="token operator">:=</span>hello.o

<span class="token keyword">endif</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 执行的步骤</span>
<span class="token function">make</span>
<span class="token function">dmesg</span> <span class="token parameter variable">-c</span>
insmod hello.ko 
<span class="token function">dmesg</span> 
<span class="token function">cat</span> /proc/devices <span class="token operator">|</span> <span class="token function">grep</span> hello
<span class="token comment"># 500 hello</span>
lsmod <span class="token operator">|</span> <span class="token function">grep</span> hello
<span class="token comment"># hello                  16384  0</span>
<span class="token function">mknod</span> /dev/hello c <span class="token number">500</span> <span class="token number">0</span>				<span class="token comment"># 创建一个设备，让它和500 0这个设备号关联起来</span>
<span class="token function">ls</span> <span class="token parameter variable">-l</span> /dev/hello 
crw-r--r-- <span class="token number">1</span> root root <span class="token number">500</span>, <span class="token number">0</span> <span class="token number">7</span>月  <span class="token number">23</span> <span class="token number">16</span>:41 /dev/hello
./main
<span class="token function">dmesg</span>
rmmod hello
<span class="token function">dmesg</span> 
<span class="token function">rm</span> <span class="token parameter variable">-rfv</span> /dev/hello 
已删除<span class="token string">'/dev/hello'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="11-字符设备驱动调用原理"><a href="#11-字符设备驱动调用原理" class="headerlink" title="11.字符设备驱动调用原理"></a>11.字符设备驱动调用原理</h4><p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202407231649798.png" alt="image-20240723164959660"></p>
<p>1.在驱动程序中,首先要创建一个<code>cdev</code>结构</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">cdev</span><span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">kobject</span> kobj<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>owner<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> <span class="token operator">*</span>ops<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> list<span class="token punctuation">;</span>
    <span class="token class-name">dev_t</span> dev<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 可以手动创建一个cdev结构体加上cdev_init,也可以使用cdev_al1oc函数去创建</span>
<span class="token keyword">struct</span> <span class="token class-name">cdev</span> my_cdev<span class="token punctuation">;</span>
<span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_cdev，<span class="token operator">&amp;</span>fops<span class="token punctuation">)</span><span class="token punctuation">;</span>
my_cdev<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token operator">:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>2.静态创建结构体后有要对结构体进行初始化，使用<code>cdev_init</code>函数进行，<code>cdev_init</code>有两个参数</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">cdev</span> <span class="token operator">*</span>cdev<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> <span class="token operator">*</span>fops<span class="token punctuation">)</span><span class="token punctuation">{</span>	
    <span class="token function">memset</span><span class="token punctuation">(</span>cdev，<span class="token number">0</span>，<span class="token keyword">sizeof</span> <span class="token operator">*</span>cdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cdev<span class="token operator">-&gt;</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">kobject_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cdev<span class="token operator">-&gt;</span>kobj，<span class="token operator">&amp;</span>ktype_cdev_default<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cdev<span class="token operator">-&gt;</span>ops <span class="token operator">=</span> fops<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//把结构体清除为0,然后赋了一个 cdev-&gt;ops 的值,因此cdev-&gt;ops 指向ops结构体</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>3.使用<code>cdev_add</code>把设备好加入到<code>cdev</code>组成的链表当中。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">cdev</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token class-name">dev_t</span> dev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> count<span class="token punctuation">)</span><span class="token punctuation">{</span>
    p<span class="token operator">-&gt;</span>dev <span class="token operator">=</span> dev<span class="token punctuation">;</span>
    p<span class="token operator">-&gt;</span>count <span class="token operator">=</span> count<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">kobj_map</span><span class="token punctuation">(</span>cdev_map<span class="token punctuation">,</span> dev<span class="token punctuation">,</span> count， <span class="token constant">NULL</span><span class="token punctuation">,</span> exact_match<span class="token punctuation">,</span> exact_lock， p<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//往链表里面插入节点</span>
<span class="token punctuation">}</span>
<span class="token comment">// 把设备号加入到cdev结构体中,因此cdev结构体中的成员ops指向驱动当中的ops结构体,dev成员是保存的设备号</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>4.mknod 时会在内核中创建一个inode的结构体,这里只写inode重要的成员信息</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">inode</span> f<span class="token punctuation">{</span>
    <span class="token class-name">dev_t</span> i_rdev<span class="token punctuation">;</span><span class="token comment">//该成员表示设备文件的inode结构，它包含了真正的设备编号。</span>
    
    <span class="token comment">// 该成员表示字符设备的内核的 内部结构。当inode指向一个字符设备文件时，该成员包含了指向struct cdev结构的</span>
    <span class="token comment">// 其中cdev结构是字符设备结构体。</span>
    <span class="token keyword">struct</span> <span class="token class-name">cdev</span> <span class="token operator">*</span>i_cdev<span class="token punctuation">;</span>
    
<span class="token punctuation">}</span>

<span class="token comment">//执行mknod时会对这个结构体进行赋值，怎么赋值的呢?</span>
<span class="token comment">//首先会对i_rdev 这个成员赋值，会对成员赋值为相应的设备号。</span>
<span class="token comment">//然后对i_cdev这个指针赋值，这个是通过查询系统的cdev链表实现的,根据主设备号和次设备号找到cdev这个结构</span>
<span class="token comment">//因此i_cdev= &amp;cdev.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>5.应用程序调用 <code>open("/dev/hello")</code>这个函数时</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
应用程序调用 open("/dev/he11o")这个函数时,内核会调用sys_open,继续向下调用
chrdev_open(struct inode * inode, struct file * filp)
内核会在调用open函数时创建struct fie 结构体,并且会对fe结构体的成员f_op赋值为驱动中的file_operatior结构体(通过设备号可以找到inode结构体,inode结构体中有i_cdev指针,指向系统的cdev的结构体,cdev的成员ops指向驱动的file_operation成员hel1o_ops),应用程序调用open,驱动中也会调用fie_operation的open函数,故系统正确的调用应用程序调用open后,对于驱动来说,filep-&gt;f_op = hel1o_ops,最终会调用驱动的open函数
*/</span>

<span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">path</span> f_path<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> operations <span class="token operator">*</span>f_op<span class="token punctuation">;</span>
    <span class="token class-name">spinlock_t</span> 		f_lock<span class="token punctuation">;</span>
    <span class="token class-name">atomic_long_t</span> 	f_count<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">inode</span> 	<span class="token operator">*</span>f_inode<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-3-字符设备读写数据"><a href="#2-3-字符设备读写数据" class="headerlink" title="2.3 字符设备读写数据"></a>2.3 字符设备读写数据</h3><h4 id="1-file-operations的read接口"><a href="#1-file-operations的read接口" class="headerlink" title="1.file_operations的read接口"></a>1.<code>file_operations</code>的<code>read</code>接口</h4><ul>
<li>函数原型</li>
</ul>
<p>	</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;linux/uaccess.h&gt;</span></span>
<span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>read<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filep<span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>to<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>off<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//从设备中同步读取数据 </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>函数功能<ul>
<li>把驱动中的数据复制到应用程序内</li>
</ul>
</li>
<li>函数参数<ul>
<li>filep: 指向内核创建的file结构体指针</li>
<li>to: 要向用户空间发送数据的指针，应用程序的地址<ul>
<li>__user: 表示应用程序的地址</li>
</ul>
</li>
<li>count: 用户空间要读取的字节数</li>
<li>off :文件指针的偏移量</li>
</ul>
</li>
<li>函数返回值<ul>
<li>成功返回：发送到应用程序的字节数</li>
<li>失败返回：负数</li>
</ul>
</li>
</ul>
<h4 id="2-copy-to-user"><a href="#2-copy-to-user" class="headerlink" title="2. copy_to_user"></a>2. <code>copy_to_user</code></h4><ul>
<li>函数原型</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;linux/uaccess.h&gt;</span></span>
<span class="token keyword">extern</span> <span class="token keyword">inline</span> <span class="token keyword">long</span> <span class="token function">copy_to_user</span><span class="token punctuation">(</span><span class="token keyword">void</span> __user <span class="token operator">*</span>to<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>from<span class="token punctuation">,</span> <span class="token keyword">long</span> n<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">__copy_tofrom_user</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__force <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>to<span class="token punctuation">,</span> from<span class="token punctuation">,</span> n<span class="token punctuation">,</span> to<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>函数功能<br>把驱动中的数据复制到应用程序内</li>
<li>函数参数<br>。 to:数据的目的，应用程序的地址<br>。 from: 数据的源，驱动的地址<br>。n:数据的大小</li>
<li>函数返回值<br>成功返回：0<br>失败返回：负数</li>
</ul>
<h4 id="3-file-operations的write接口"><a href="#3-file-operations的write接口" class="headerlink" title="3.file_operations的write接口"></a>3.<code>file_operations</code>的<code>write</code>接口</h4><ul>
<li>函数原型</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;linux/uaccess.h&gt;</span></span>
<span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>write<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>from<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>off<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>函数功能<ul>
<li>把应用程序内的数据写入到驱动内</li>
</ul>
</li>
<li>函数参数<ul>
<li>filep: 指向内核创建的file结构体指针</li>
<li>from :要接受用户空间发给内核空间数据的指针，应用程序的地址</li>
<li>count:用户空间要写的字节数</li>
<li>off: 文件指针的偏移量</li>
</ul>
</li>
<li>函数返回值<ul>
<li>成功返回写入到驱动的字节数</li>
<li>失败返回负数</li>
</ul>
</li>
</ul>
<h4 id="4-copy-from-user"><a href="#4-copy-from-user" class="headerlink" title="4.copy_from_user"></a>4.<code>copy_from_user</code></h4><ul>
<li>函数原型</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;linux/uaccess.h&gt;</span></span>
<span class="token keyword">extern</span> <span class="token keyword">inline</span> <span class="token keyword">long</span> <span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>to<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> __user <span class="token operator">*</span>from<span class="token punctuation">,</span> <span class="token keyword">long</span> n<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">__copy_tofrom_user</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> <span class="token punctuation">(</span>__force <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>from<span class="token punctuation">,</span> n<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>函数功能<ul>
<li>把应用程序中的数据复制到驱动内</li>
</ul>
</li>
<li>函数参数<ul>
<li>to: 数据的目的，驱动中的地址</li>
<li>from: 数据的源，应用程序的地址</li>
<li>n:数据的大小</li>
</ul>
</li>
<li>函数返回值:<ul>
<li>成功返回写入到驱动中的字节数</li>
<li>失败返回负数</li>
</ul>
</li>
</ul>
<h4 id="5-实例4——字符设备的读写"><a href="#5-实例4——字符设备的读写" class="headerlink" title="5.实例4——字符设备的读写"></a>5.实例4——字符设备的读写</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*hello.c*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h&gt;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h&gt;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/uaccess.h&gt;</span></span>

<span class="token keyword">int</span> hello_major <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> hello_minor <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> dribuf<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">hello_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"hello_driver打开成功!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">hello_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"hello_driver关闭成功!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">hello_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">ssize_t</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	ret <span class="token operator">=</span> <span class="token function">copy_to_user</span><span class="token punctuation">(</span>usrbuf<span class="token punctuation">,</span> dribuf<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"错误：应用程序读取驱动内的数据失败\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span><span class="token punctuation">{</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"应用程序读取驱动内的数据成功, 读取了%ld bytes\n"</span><span class="token punctuation">,</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">hello_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">ssize_t</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	ret <span class="token operator">=</span> <span class="token function">copy_from_user</span><span class="token punctuation">(</span>dribuf<span class="token punctuation">,</span> usrbuf<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"错误：应用程序写给驱动数据失败\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span><span class="token punctuation">{</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"应用程序写给驱动数据成功, 用户把数据写进驱动程序了，写了%ld bytes\n"</span><span class="token punctuation">,</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token class-name">cdev</span> cdev <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE						<span class="token comment">//表示的是指向本模块的指针</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">file_operations</span> hello_fops <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>open <span class="token operator">=</span> hello_open<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>release <span class="token operator">=</span> hello_release<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>read <span class="token operator">=</span> hello_read<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>write <span class="token operator">=</span> hello_write<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">hello_int</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>
	<span class="token class-name">dev_t</span> devno <span class="token operator">=</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>hello_major<span class="token punctuation">,</span> hello_minor<span class="token punctuation">)</span><span class="token punctuation">;</span>
	ret <span class="token operator">=</span> <span class="token function">register_chrdev_region</span><span class="token punctuation">(</span>devno<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"错误：设备号申请失败： %d\n"</span><span class="token punctuation">,</span> hello_major<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cdev<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">cdev</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 使用memset()函数初始化cdev结构体</span>
	<span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cdev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hello_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>
	ret <span class="token operator">=</span> <span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cdev<span class="token punctuation">,</span> devno<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">/* 向内核链表添加一个cdev结构体 */</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"错误：添加cdev失败\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"hello_driver installed sucessed!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">hello_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">dev_t</span> devno <span class="token operator">=</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>hello_major<span class="token punctuation">,</span> hello_minor<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">cdev_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cdev<span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">/* 从内核链表中删除指定的cdev */</span>
	<span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>devno<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"hello_driver uninstall sucessed!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>hello_int<span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//宏函数做关联</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>hello_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* 
 * 设置模块的许可协议。
 * 设置模块的作者信息。
 * 设置模块的描述信息。
 */</span>
<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"Dual BSD/GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"GeYangwen"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_DESCRIPTION</span><span class="token punctuation">(</span><span class="token string">"A simple Hello world module"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*main.c*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"hello world"</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/hello"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fd = %d\n"</span><span class="token punctuation">,</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token char">'0'</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token operator">/</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                          <span class="token comment">//留一个'\0'</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token operator">/</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"write"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token operator">/</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                          <span class="token comment">//清空buf内的东西</span>

    ret <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token operator">/</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"buf = %s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>makefile文件继续沿用上面的案列</p>
<p>以下是相关的命令调试</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">dmesg</span> <span class="token parameter variable">-c</span>
<span class="token function">make</span>
insmod hello.ko 
<span class="token function">dmesg</span> 
<span class="token function">cat</span> /proc/devices <span class="token operator">|</span> <span class="token function">grep</span> hello
lsmod <span class="token operator">|</span> <span class="token function">grep</span> hello
ll /dev/hello 

./main
fd <span class="token operator">=</span> <span class="token number">3</span>
buf <span class="token operator">=</span> 00000000000

<span class="token function">dmesg</span>
<span class="token punctuation">[</span> <span class="token number">4734.210647</span><span class="token punctuation">]</span> hello_driver installed sucessed<span class="token operator">!</span>
<span class="token punctuation">[</span> <span class="token number">4819.517357</span><span class="token punctuation">]</span> hello_driver打开成功<span class="token operator">!</span>
<span class="token punctuation">[</span> <span class="token number">4819.517447</span><span class="token punctuation">]</span> 应用程序写给驱动数据成功, 用户把数据写进驱动程序了，写了12 bytes
<span class="token punctuation">[</span> <span class="token number">4819.517448</span><span class="token punctuation">]</span> 应用程序读取驱动内的数据成功, 读取了12 bytes
<span class="token punctuation">[</span> <span class="token number">4819.517452</span><span class="token punctuation">]</span> hello_driver关闭成功<span class="token operator">!</span>

ll /dev/hello 
rmmod hello
<span class="token function">dmesg</span>
<span class="token function">dmesg</span> <span class="token parameter variable">-c</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-4-字符设备的控制"><a href="#2-4-字符设备的控制" class="headerlink" title="2.4 字符设备的控制"></a>2.4 字符设备的控制</h3><h4 id="1-ioctl-控制设备"><a href="#1-ioctl-控制设备" class="headerlink" title="1.ioctl 控制设备"></a>1.<code>ioctl</code> 控制设备</h4><ul>
<li>函数原型</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h&gt;</span>										<span class="token comment">//这是应用层的</span></span>
<span class="token keyword">int</span> <span class="token function">ioct1</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> request<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>函数功能<ul>
<li>给设备发送控制命令，是linux的系统调用函数</li>
</ul>
</li>
<li>函数参数<ul>
<li>fd:要操作的文件描述符</li>
<li>request:要发送的命令</li>
</ul>
</li>
<li>函数返回值:<ul>
<li>成功返回: 0</li>
<li>失败返回 :-1</li>
</ul>
</li>
</ul>
<h4 id="2-file-operations的unlocked-ioctl接口"><a href="#2-file-operations的unlocked-ioctl接口" class="headerlink" title="2. file_operations的unlocked_ioctl接口"></a>2. <code>file_operations</code>的<code>unlocked_ioctl</code>接口</h4><ul>
<li>函数原型</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;linux/fs.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;asm/ioct1.h&gt;</span></span>
<span class="token keyword">long</span> <span class="token punctuation">(</span><span class="token operator">*</span>unlocked_ioctl<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span> fd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li>函数功能<ul>
<li>应用程序调用<code>ioctl</code>， 则驱动调用<code>unlocked_ioctl</code>接口函数</li>
</ul>
</li>
<li>函数参数<ul>
<li><code>fd</code>:要操作的文件描述符</li>
<li><code>cmd</code>:应用程序要发送的命令</li>
<li><code>arg</code>: <code>ioct1</code>传递的第三个参数（可变的）</li>
</ul>
</li>
<li>函数返回值:<ul>
<li>成功返回 : 0</li>
<li>失败返回 : 负数的错误码</li>
</ul>
</li>
</ul>
<h4 id="3-ioctl命令定义格式"><a href="#3-ioctl命令定义格式" class="headerlink" title="3.ioctl命令定义格式"></a>3.<code>ioctl</code>命令定义格式</h4><ul>
<li>函数原型</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">_IO</span><span class="token expression"><span class="token punctuation">(</span>type<span class="token punctuation">,</span>nr<span class="token punctuation">)</span> 			<span class="token function">_IOC</span><span class="token punctuation">(</span>_IOC_NONE<span class="token punctuation">,</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>nr<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">_IOR</span><span class="token expression"><span class="token punctuation">(</span>type<span class="token punctuation">,</span>nr<span class="token punctuation">,</span>size<span class="token punctuation">)</span>  	<span class="token function">_IOC</span><span class="token punctuation">(</span>_IOC_READ<span class="token punctuation">,</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>nr<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">_IOW</span><span class="token expression"><span class="token punctuation">(</span>type<span class="token punctuation">,</span>nr<span class="token punctuation">,</span>size<span class="token punctuation">)</span>  	<span class="token function">_IOC</span><span class="token punctuation">(</span>_IOC_WRITE<span class="token punctuation">,</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>nr<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">_IOWR</span><span class="token expression"><span class="token punctuation">(</span>type<span class="token punctuation">,</span>nr<span class="token punctuation">,</span>size<span class="token punctuation">)</span> 	<span class="token function">_IOC</span><span class="token punctuation">(</span>_IOC_READ <span class="token operator">|</span> _IOC_WRITE<span class="token punctuation">,</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>nr<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

设备类型			序列号				方向				数据尺寸
type				nr				  IO				size
<span class="token number">8</span> bit				<span class="token number">8</span> bit			  <span class="token number">2</span> bit				<span class="token number">8</span><span class="token operator">~</span><span class="token number">14</span> bit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>函数功能<ul>
<li>驱动中和应用程序中关于ioctl的命令定义格式</li>
</ul>
</li>
<li>函数参数<ul>
<li>type : 表示类型，是命令的类别(组)，这个数的表示范围是<code>0x0 ~ 0xff</code></li>
<li>nr :这一组命令的第几个，led控制的方式如<code>ledon</code>,<code>ledoff</code></li>
<li>size : 读写的数据</li>
<li>IO:读设备还是写设备<ul>
<li>_IO : 只控制设备，不读写设备</li>
<li>_IOR : 读设备，读取1个字节的数据</li>
<li>_lOW : 写设备，写1个字节的数据</li>
<li>_IOWR : 读写设备，读写1个字节的数据</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>例如，定义1个命令</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LEDON</span> <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span></span><span class="token char">'A'</span><span class="token expression"><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LEDOFF</span> <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span></span><span class="token char">'A'</span><span class="token expression"><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LEDSET</span> <span class="token expression"><span class="token function">_IOW</span><span class="token punctuation">(</span></span><span class="token char">'A'</span><span class="token expression"><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="4-案例5——控制设备"><a href="#4-案例5——控制设备" class="headerlink" title="4.案例5——控制设备"></a>4.案例5——控制设备</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*main.c*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h&gt;</span>	</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LEDON</span> 	 <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span></span><span class="token char">'L'</span><span class="token expression"><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LEDOFF</span>	 <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span></span><span class="token char">'L'</span><span class="token expression"><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LEDSET</span>	 <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span></span><span class="token char">'L'</span><span class="token expression"><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/hello"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fd = %d\n"</span><span class="token punctuation">,</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> LEDON<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"ioctl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ioctl LEDON\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> LEDOFF<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"ioctl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ioctl LEDOFF\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> LEDSET<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"ioctl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ioctl LEDSET\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*hello.c*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h&gt;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h&gt;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/uaccess.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/ioctl.h&gt;</span>	</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LEDON</span> 	 <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span></span><span class="token char">'L'</span><span class="token expression"><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LEDOFF</span>	 <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span></span><span class="token char">'L'</span><span class="token expression"><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LEDSET</span>	 <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span></span><span class="token char">'L'</span><span class="token expression"><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span></span></span>

<span class="token keyword">int</span> hello_major <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> hello_minor <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> dribuf<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">hello_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"hello_driver打开成功!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">hello_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"hello_driver关闭成功!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">hello_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">ssize_t</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	ret <span class="token operator">=</span> <span class="token function">copy_to_user</span><span class="token punctuation">(</span>usrbuf<span class="token punctuation">,</span> dribuf<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"错误：应用程序读取驱动内的数据失败\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span><span class="token punctuation">{</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"应用程序读取驱动内的数据成功, 读取了%ld bytes\n"</span><span class="token punctuation">,</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">hello_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">ssize_t</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	ret <span class="token operator">=</span> <span class="token function">copy_from_user</span><span class="token punctuation">(</span>dribuf<span class="token punctuation">,</span> usrbuf<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"错误：应用程序写给驱动数据失败\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span><span class="token punctuation">{</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"应用程序写给驱动数据成功, 用户把数据写进驱动程序了，写了%ld bytes\n"</span><span class="token punctuation">,</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">hello_unlocked_ioctl</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">long</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"cmd = %d\n"</span><span class="token punctuation">,</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"LEDON =  %d\n"</span><span class="token punctuation">,</span>LEDON<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"LEDOFF = %d\n"</span><span class="token punctuation">,</span>LEDOFF<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"LEDSET = %d\n"</span><span class="token punctuation">,</span>LEDSET<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"arg = %ld\n"</span><span class="token punctuation">,</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">switch</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">case</span> LEDON<span class="token operator">:</span>
			<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"hello_driver ioctl LEDON\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> LEDOFF<span class="token operator">:</span>
			<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"hello_driver ioctl LEDOFF\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> LEDSET<span class="token operator">:</span>
			<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"hello_driver ioctl LEDSET\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">default</span><span class="token operator">:</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token class-name">cdev</span> cdev <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE						<span class="token comment">//表示的是指向本模块的指针</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">file_operations</span> hello_fops <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>open <span class="token operator">=</span> hello_open<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>release <span class="token operator">=</span> hello_release<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>read <span class="token operator">=</span> hello_read<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>write <span class="token operator">=</span> hello_write<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>unlocked_ioctl <span class="token operator">=</span> hello_unlocked_ioctl<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">hello_int</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>
	<span class="token class-name">dev_t</span> devno <span class="token operator">=</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>hello_major<span class="token punctuation">,</span> hello_minor<span class="token punctuation">)</span><span class="token punctuation">;</span>
	ret <span class="token operator">=</span> <span class="token function">register_chrdev_region</span><span class="token punctuation">(</span>devno<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"错误：设备号申请失败： %d\n"</span><span class="token punctuation">,</span> hello_major<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cdev<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">cdev</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 使用memset()函数初始化cdev结构体</span>
	<span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cdev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hello_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>
	ret <span class="token operator">=</span> <span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cdev<span class="token punctuation">,</span> devno<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">/* 向内核链表添加一个cdev结构体 */</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"错误：添加cdev失败\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"hello_driver installed sucessed!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">hello_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">dev_t</span> devno <span class="token operator">=</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>hello_major<span class="token punctuation">,</span> hello_minor<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">cdev_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cdev<span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">/* 从内核链表中删除指定的cdev */</span>
	<span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>devno<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"hello_driver uninstall sucessed!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>hello_int<span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//宏函数做关联</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>hello_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* 
 * 设置模块的许可协议。
 * 设置模块的作者信息。
 * 设置模块的描述信息。
 */</span>
<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"Dual BSD/GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"GeYangwen"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_DESCRIPTION</span><span class="token punctuation">(</span><span class="token string">"A simple Hello world module"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>makefile文件继续沿用上面的案列</p>
<p>以下是相关的命令调试</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">make</span>
insmod hello.ko 
<span class="token function">cat</span> /proc/devices 
<span class="token function">cat</span> /proc/devices <span class="token operator">|</span><span class="token function">grep</span> hello
lsmod <span class="token operator">|</span> <span class="token function">grep</span> hello
ll /dev/hello 
./main
<span class="token function">dmesg</span> 
rmmod hello
<span class="token function">dmesg</span> <span class="token parameter variable">-c</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-5字符设备新方法"><a href="#2-5字符设备新方法" class="headerlink" title="2.5字符设备新方法"></a>2.5字符设备新方法</h3><h4 id="1-字符设备注册方法-register-chrdev"><a href="#1-字符设备注册方法-register-chrdev" class="headerlink" title="1.字符设备注册方法 register_chrdev"></a>1.字符设备注册方法 <code>register_chrdev</code></h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//函数所在文件路径/include/linux/fs.h</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h&gt;</span> </span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">int</span> <span class="token function">register_chrdev</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> major<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> <span class="token operator">*</span>fops<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">__register_chrdev</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> fops<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>函数作用	<ul>
<li>向内核注册某字符设备的 file_operations</li>
<li><code>register_chrdev</code> = <code>register_chrdev_region</code> + <code>cdev_init</code> + <code>cdev_add</code></li>
</ul>
</li>
<li>返回值	<ul>
<li>major如果设置为0，则返回自动分配的主设备号；</li>
<li>如果设置为指定的主设备号，成功则返回值为0，失败返回负数。</li>
</ul>
</li>
<li>参数说明	<ul>
<li>major，表示当前设备的主设备号，范围是1~254，这个范围应该不准 也可设置500。可以自己指定，也可以设置为0让内核自动分配。犹如学号。</li>
<li>name，表示当前设备的驱动名称，犹如名字。</li>
<li>fops，是file_operations结构体指针。</li>
<li>inline修饰符说明</li>
</ul>
</li>
</ul>
<p>	</p>
<h4 id="2-字符设备注销方法-unregister-chrdev"><a href="#2-字符设备注销方法-unregister-chrdev" class="headerlink" title="2.字符设备注销方法 unregister_chrdev"></a>2.字符设备注销方法 <code>unregister_chrdev</code></h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*字符设备注销的函数原型*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h&gt;</span> </span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">unregister_chrdev</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> major<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/*major:主设备号，Limnux下每个设备都有一个设备号，设备号分为主设备号和次设备号两部分。
name:设备名字，指向一串字符串。
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>函数功能<ul>
<li>从系统中注销一个字符设备</li>
<li><code>unregister_chrdev</code> =<code>unregister_chrdev_region</code> + <code>cdev_del</code></li>
</ul>
</li>
<li>函数参数<ul>
<li>major:主设备号</li>
<li>name:设备的名称</li>
</ul>
</li>
<li>函数返回值:<ul>
<li>成功返回: 0</li>
<li>失败返回 :负的错误码</li>
</ul>
</li>
</ul>
<h3 id="2-6-多文件与多模块编译"><a href="#2-6-多文件与多模块编译" class="headerlink" title="2.6 多文件与多模块编译"></a>2.6 多文件与多模块编译</h3><h4 id="1-多文件编译"><a href="#1-多文件编译" class="headerlink" title="1.多文件编译"></a>1.多文件编译</h4><pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile">obj-m <span class="token operator">:=</span> hello.o
hello-objs <span class="token operator">:=</span> hello1.o hello2.o<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<h4 id="2-实例06——-多文件编译"><a href="#2-实例06——-多文件编译" class="headerlink" title="2.实例06—— 多文件编译"></a>2.实例06—— 多文件编译</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*hello1.c*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h&gt;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h&gt;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/uaccess.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/ioctl.h&gt;</span>	</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LEDON</span> 	 <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span></span><span class="token char">'L'</span><span class="token expression"><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LEDOFF</span>	 <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span></span><span class="token char">'L'</span><span class="token expression"><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LEDSET</span>	 <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span></span><span class="token char">'L'</span><span class="token expression"><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span></span></span>

<span class="token keyword">int</span> hello_major <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>
<span class="token comment">// int hello_minor = 0;</span>
<span class="token keyword">char</span> dribuf<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//引入外部函数</span>
<span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">display</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">hello_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">display</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"hello_driver打开成功!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">hello_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"hello_driver关闭成功!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">hello_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">ssize_t</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	ret <span class="token operator">=</span> <span class="token function">copy_to_user</span><span class="token punctuation">(</span>usrbuf<span class="token punctuation">,</span> dribuf<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"错误：应用程序读取驱动内的数据失败\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span><span class="token punctuation">{</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"应用程序读取驱动内的数据成功, 读取了%ld bytes\n"</span><span class="token punctuation">,</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">hello_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">ssize_t</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	ret <span class="token operator">=</span> <span class="token function">copy_from_user</span><span class="token punctuation">(</span>dribuf<span class="token punctuation">,</span> usrbuf<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"错误：应用程序写给驱动数据失败\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span><span class="token punctuation">{</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"应用程序写给驱动数据成功, 用户把数据写进驱动程序了，写了%ld bytes\n"</span><span class="token punctuation">,</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">hello_unlocked_ioctl</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">long</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"cmd = %d\n"</span><span class="token punctuation">,</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"LEDON =  %d\n"</span><span class="token punctuation">,</span>LEDON<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"LEDOFF = %d\n"</span><span class="token punctuation">,</span>LEDOFF<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"LEDSET = %d\n"</span><span class="token punctuation">,</span>LEDSET<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"arg = %ld\n"</span><span class="token punctuation">,</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">switch</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">case</span> LEDON<span class="token operator">:</span>
			<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"hello_driver ioctl LEDON\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> LEDOFF<span class="token operator">:</span>
			<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"hello_driver ioctl LEDOFF\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> LEDSET<span class="token operator">:</span>
			<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"hello_driver ioctl LEDSET\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">default</span><span class="token operator">:</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token class-name">cdev</span> cdev <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE						<span class="token comment">//表示的是指向本模块的指针</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">file_operations</span> hello_fops <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>open <span class="token operator">=</span> hello_open<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>release <span class="token operator">=</span> hello_release<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>read <span class="token operator">=</span> hello_read<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>write <span class="token operator">=</span> hello_write<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>unlocked_ioctl <span class="token operator">=</span> hello_unlocked_ioctl<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">hello_int</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span></span>
	<span class="token class-name">dev_t</span> devno <span class="token operator">=</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>hello_major<span class="token punctuation">,</span> hello_minor<span class="token punctuation">)</span><span class="token punctuation">;</span>
	ret <span class="token operator">=</span> <span class="token function">register_chrdev_region</span><span class="token punctuation">(</span>devno<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"错误：设备号申请失败： %d\n"</span><span class="token punctuation">,</span> hello_major<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cdev<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">cdev</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 使用memset()函数初始化cdev结构体</span>
	<span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cdev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hello_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>
	ret <span class="token operator">=</span> <span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cdev<span class="token punctuation">,</span> devno<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">/* 向内核链表添加一个cdev结构体 */</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"错误：添加cdev失败\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	ret <span class="token operator">=</span> <span class="token function">register_chrdev</span><span class="token punctuation">(</span>hello_major<span class="token punctuation">,</span><span class="token string">"hello"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>hello_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"错误：注册字符设备失败\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"hello_driver installed sucessed!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">hello_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span></span>
	<span class="token class-name">dev_t</span> devno <span class="token operator">=</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>hello_major<span class="token punctuation">,</span> hello_minor<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">cdev_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cdev<span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">/* 从内核链表中删除指定的cdev */</span>
	<span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>devno<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token function">unregister_chrdev</span><span class="token punctuation">(</span>hello_major<span class="token punctuation">,</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"hello_driver uninstall sucessed!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>hello_int<span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//宏函数做关联</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>hello_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* 
 * 设置模块的许可协议。
 * 设置模块的作者信息。
 * 设置模块的描述信息。
 */</span>
<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"Dual BSD/GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"GeYangwen"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_DESCRIPTION</span><span class="token punctuation">(</span><span class="token string">"A simple Hello world module"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*hello2.c*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span> </span>
<span class="token keyword">void</span> <span class="token function">display</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"hello_driver:display\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile"><span class="token comment"># Makefile</span>
<span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">warning</span> KERNELRELEASE<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>KERNELRELEASE<span class="token punctuation">)</span><span class="token punctuation">)</span>		
<span class="token keyword">ifeq</span> <span class="token punctuation">(</span><span class="token variable">$</span><span class="token punctuation">(</span>KERNELRELEASE<span class="token punctuation">)</span>,<span class="token punctuation">)</span>	
KERNELDIR <span class="token operator">?=</span> /lib/modules/<span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">shell</span> uname -r<span class="token punctuation">)</span>/build
PWD <span class="token operator">:=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">shell</span> pwd<span class="token punctuation">)</span>
<span class="token target symbol">modules</span><span class="token punctuation">:</span>
	<span class="token variable">$</span><span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> -C <span class="token variable">$</span><span class="token punctuation">(</span>KERNELDIR<span class="token punctuation">)</span> M<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PWD<span class="token punctuation">)</span> modules
	gcc main.c -o main
	rm -rfv *.o *~ core .depend .*.cmd *.mod.c *.mod .tmp_versions Module* modules*

<span class="token target symbol">modules_install</span><span class="token punctuation">:</span>
	<span class="token variable">$</span><span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> -C <span class="token variable">$</span><span class="token punctuation">(</span>KERNELDIR<span class="token punctuation">)</span> M<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PWD<span class="token punctuation">)</span> modules_install

<span class="token target symbol">clean</span><span class="token punctuation">:</span>
	rm -rfv *.o *~ core .depend .*.cmd *.ko *.mod.c *.mod .tmp_versions Module* modules*
	rm -rfv main

<span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> modules modules_install clean

<span class="token keyword">else</span>
	obj-m <span class="token operator">:=</span> hello.o
	hello-objs <span class="token operator">:=</span> hello1.o hello2.o
<span class="token keyword">endif</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="3-实例07——-多模块编译"><a href="#3-实例07——-多模块编译" class="headerlink" title="3.实例07—— 多模块编译"></a>3.实例07—— 多模块编译</h4><p>多模块就是多驱动，可以编译出来好几个驱动，这个案例就是复制一下<code>hello.c</code>文件修改为<code>char.c</code>,然后再Makefile文件中修改下面的目标值，这样就可以生成两个驱动文件</p>
<pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile">obj-m <span class="token operator">+=</span> hello.o
obj-m <span class="token operator">+=</span> char.o<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202407241656520.png" alt="image-20240724165640294"></p>
<h3 id="2-7-cdev、misc及device的联系和区别"><a href="#2-7-cdev、misc及device的联系和区别" class="headerlink" title="2.7 cdev、misc及device的联系和区别"></a>2.7 cdev、misc及device的联系和区别</h3><p>引用：<a target="_blank" rel="noopener" href="https://blog.csdn.net/leochen_career/article/details/78540916">leochen_career</a></p>
<h4 id="2-7-1从-x2F-dev目录说起"><a href="#2-7-1从-x2F-dev目录说起" class="headerlink" title="2.7.1从/dev目录说起"></a>2.7.1从/dev目录说起</h4><p>从事Linux嵌入式驱动开发的人，都很熟悉下面的一些基础知识</p>
<ul>
<li>比如对于一个char类型的设备，我想对其进行<code>read</code> <code>wirte</code> 和<code>ioctl</code>操作，那么我们通常会在内核驱动中实现一个<code>file_operations</code>结构体，然后分配主次设备号，调用<code>cdev_add</code>函数进行注册。从/proc/devices下面找到注册的设备的主次设备号，在用<code>mknod /dev/char_dev c major minor</code> 命令行创建设备节点。在用户空间<code>open /dev/char_dev</code>这个设备，然后进行各种操作。</li>
<li>OK，字符设备模型就这么简单，很多ABC教程都是一个类似的实现。</li>
<li>然后我们去看内核代码时，突然一脸懵逼。。。怎么内核代码里很多常用的驱动的实现不是这个样子的？没看到有<code>file_operations</code>结构体，我怎么使用这些驱动？看到了<code>/dev</code>目录下有需要的<code>char</code>设备，可是怎么使用呢？我还是习惯用<code>/dev</code>的形式，那我该怎么办？</li>
</ul>
<h4 id="2-7-2-Linux驱动模型的一个重要分界线"><a href="#2-7-2-Linux驱动模型的一个重要分界线" class="headerlink" title="2.7.2 Linux驱动模型的一个重要分界线"></a>2.7.2 Linux驱动模型的一个重要分界线</h4><p>linux2.6版本以前，普遍的用法就像我上面说的一样。但是linux2.6版本以后，引用了<strong>Linux设备驱动模型</strong>，开始使用了<strong>基于sysfs的文件系统</strong>，让我们不是太明白的那些Linux内核驱动了。   也就是说，我们熟悉的那套驱动模式是2.6版本以前的（当然这是基础，肯定要会的）   我们不熟悉的驱动模型是2.6版本以后的。 </p>
<h4 id="2-7-3-cdev、misc以及device"><a href="#2-7-3-cdev、misc以及device" class="headerlink" title="2.7.3 cdev、misc以及device"></a>2.7.3 cdev、misc以及device</h4><p><strong>cdev和device的区别和联系</strong> </p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span>  <span class="token class-name">cdev</span> <span class="token punctuation">{</span>
     <span class="token keyword">struct</span>  <span class="token class-name">kobject</span> kobj<span class="token punctuation">;</span>
     <span class="token keyword">struct</span>  <span class="token class-name">module</span> <span class="token operator">*</span>owner<span class="token punctuation">;</span>
     <span class="token keyword">const</span>   <span class="token keyword">struct</span>  <span class="token class-name">file_operations</span> <span class="token operator">*</span>ops<span class="token punctuation">;</span>
     <span class="token keyword">struct</span>  <span class="token class-name">list_head</span> list<span class="token punctuation">;</span>
     <span class="token class-name">dev_t</span>  dev<span class="token punctuation">;</span>
     <span class="token keyword">unsigned</span>  <span class="token keyword">int</span>  count<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
 
<span class="token keyword">struct</span>  <span class="token class-name">device</span> <span class="token punctuation">{</span>
     <span class="token keyword">struct</span>  <span class="token class-name">device</span>      <span class="token operator">*</span>parent<span class="token punctuation">;</span>
     <span class="token keyword">struct</span>  <span class="token class-name">device_private</span>  <span class="token operator">*</span>p<span class="token punctuation">;</span>
     <span class="token keyword">struct</span>  <span class="token class-name">kobject</span> kobj<span class="token punctuation">;</span>
     <span class="token keyword">const</span>   <span class="token keyword">char</span>      <span class="token operator">*</span>init_name<span class="token punctuation">;</span>  		<span class="token comment">/* initial name of the device */</span>
     <span class="token keyword">struct</span>  <span class="token class-name">device_driver</span> <span class="token operator">*</span>driver<span class="token punctuation">;</span> 		<span class="token comment">/* which driver has allocated this device */</span>
     <span class="token keyword">void</span>         <span class="token operator">*</span> driver_data <span class="token punctuation">;</span>   		<span class="token comment">/* Driver data, set and get with dev_set/get_drvdata */</span>
     <span class="token class-name">dev_t</span>            devt<span class="token punctuation">;</span>   				<span class="token comment">/* dev_t, creates the sysfs "dev" */</span>
     u32         id<span class="token punctuation">;</span> 						<span class="token comment">/* device instance */</span>
     <span class="token keyword">void</span>     <span class="token punctuation">(</span><span class="token operator">*</span>release<span class="token punctuation">)</span><span class="token punctuation">(</span> <span class="token keyword">struct</span>  <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>通过看这两个结构体发现，其实<code>cdev</code>和<code>device</code>之间没啥直接的联系，只有一个 <code>dev_t</code> 和<code>kobject</code> 是相同的。 <code>dev_t</code> 这个是联系两者的一个纽带了 。通常可以这么理解： <code>cdev</code>是传统驱动的设备核心数据结构，<code>device</code>是linux设备驱动模型中的核心数据结构。<br>要注册一个<code>device</code>设备，需要调用核心函数<code>device_register()</code>（或者说是<code>device_add()</code>函数） ； 要注册一个<code>cdev</code>设备，需要调用核心函数<code>register_chrdev()(</code>或者说是<code>cdev_add()</code>函数)</p>
<p><strong>miscdevice和device的区别和联系</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">miscdevice</span>  <span class="token punctuation">{</span>
    <span class="token keyword">int</span> minor<span class="token punctuation">;</span>                              <span class="token comment">// 次设备号</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>                       <span class="token comment">//名字 </span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> <span class="token operator">*</span>fops<span class="token punctuation">;</span> 	<span class="token comment">// file_operations 结构体指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> list<span class="token punctuation">;</span>                  <span class="token comment">// 作为一个链表节点挂接到misc设备维护的一个链表头上去misc_list</span>
    <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>parent<span class="token punctuation">;</span>                  <span class="token comment">// 次设备的父设备</span>
    <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>this_device<span class="token punctuation">;</span>            	<span class="token comment">// 本设备的device 结构体指针</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">attribute_group</span> <span class="token operator">*</span><span class="token operator">*</span>groups<span class="token punctuation">;</span>	<span class="token comment">//用于定义设备属性的指针数组。属性组定义了设备的属性，例如 sysfs 上的属性。</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>nodename<span class="token punctuation">;</span>          <span class="token comment">//杂项设备节点的名称，通常与 name 字段相同。此字段用于在 /sys 文件系统中创建设备节点。</span>
    <span class="token class-name">mode_t</span> mode<span class="token punctuation">;</span>						<span class="token comment">// 设备节点的权限模式，指定了用户对设备节点的访问权限。</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>从定义可以看出，<code>miscdevice</code>是 <code>device</code>的子类，是从<code>device</code>派生出来的结构体，也是属于<code>device</code>范畴的，也就是该类设备会统一在<code>/sys</code>目录下进行管理了。 </p>
<p><strong><code>miscdevice</code>和<code>cdev</code>的区别和联系</strong><br>通过上面的数据结构可以看到，两者都有一个<code>file_operations</code>和 <code>dev_t</code>（<code>misdevice</code>由于主设备号固定，所以结构体里只有一个<code>minor</code>）。<strong>从数据结构上看，<code>miscdevice</code>是<code>device</code>和<code>cdev</code>的结合。</strong></p>
<h4 id="2-7-4-device-register-—理解上面三者关系的关键函数"><a href="#2-7-4-device-register-—理解上面三者关系的关键函数" class="headerlink" title="2.7.4 device_register()—理解上面三者关系的关键函数"></a>2.7.4 device_register()—理解上面三者关系的关键函数</h4><p><strong><code>device_register()</code>—&gt;<code>device_add()</code></strong>,然后会调用两个关键函数<br><strong><code>device_create_file()</code></strong> —-将相关信息添加到/sys文件系统中<br><strong><code>devtmpfs_create_node()</code></strong> —-将相关信息添加到<code>/devtmpfs</code>文件系统中<br>第一个调用不做详细解析，因为devices本来就是/sys文件系统中的重要概念<br>关键是**<code>devtmpfs_create_node()</code>**<br>先了解下Devtmpfs 的概念</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">Devtmpfs lets the kernel create a tmpfs very early at kernel initialization <span class="token punctuation">,</span>  before any driver core device  is  registered <span class="token punctuation">.</span>  Every device with a major <span class="token operator">/</span> minor will have a device node created  in  this tmpfs instance <span class="token punctuation">.</span>  After the rootfs  is  mounted by the kernel <span class="token punctuation">,</span>  the populated tmpfs  is  mounted at  <span class="token operator">/</span> dev <span class="token punctuation">.</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><code>devtmpfs_create_node()</code>函数的核心是调用了内核的 <code>vfs_mknod()</code>函数，这样就在<code>devtmpfs</code>系统中创建了一个设备节点，当<code>devtmpfs</code>被内核<code>mount</code>到<code>/dev</code>目录下时，该设备节点就存在于<code>/dev</code>目录下，比如<code>/dev/char_dev</code>之类的。<br><code>vfs_mknod()</code>函数中会调用一个<code>init_special_inode()</code>,该函数实现如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span>  <span class="token function">init_special_inode</span><span class="token punctuation">(</span> <span class="token keyword">struct</span>  <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token class-name">umode_t</span> mode<span class="token punctuation">,</span> <span class="token class-name">dev_t</span> rdev<span class="token punctuation">)</span><span class="token punctuation">{</span>
     inode<span class="token operator">-&gt;</span>i_mode <span class="token operator">=</span> mode<span class="token punctuation">;</span>
     <span class="token keyword">if</span>  <span class="token punctuation">(</span><span class="token function">S_ISCHR</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         inode<span class="token operator">-&gt;</span>i_fop <span class="token operator">=</span> <span class="token operator">&amp;</span>def_chr_fops<span class="token punctuation">;</span>
         inode<span class="token operator">-&gt;</span>i_rdev <span class="token operator">=</span> rdev<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>  <span class="token keyword">else</span>   <span class="token keyword">if</span>  <span class="token punctuation">(</span><span class="token function">S_ISBLK</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         inode<span class="token operator">-&gt;</span>i_fop <span class="token operator">=</span> <span class="token operator">&amp;</span>def_blk_fops<span class="token punctuation">;</span>
         inode<span class="token operator">-&gt;</span>i_rdev <span class="token operator">=</span> rdev<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>  <span class="token keyword">else</span>   <span class="token keyword">if</span>  <span class="token punctuation">(</span><span class="token function">S_ISFIFO</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span><span class="token punctuation">)</span>
         inode<span class="token operator">-&gt;</span>i_fop <span class="token operator">=</span> <span class="token operator">&amp;</span>pipefifo_fops<span class="token punctuation">;</span>
     <span class="token keyword">else</span>   <span class="token keyword">if</span>  <span class="token punctuation">(</span><span class="token function">S_ISSOCK</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token punctuation">;</span>   <span class="token comment">/* leave it no_open_fops */</span>
     <span class="token keyword">else</span>
         <span class="token function">printk</span><span class="token punctuation">(</span>KERN_DEBUG  <span class="token string">"init_special_inode: bogus i_mode (%o) forinode %s:%lu\n"</span> <span class="token punctuation">,</span> mode<span class="token punctuation">,</span> inode<span class="token operator">-&gt;</span>i_sb<span class="token operator">-&gt;</span>s_id<span class="token punctuation">,</span> inode<span class="token operator">-&gt;</span>i_ino<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*
  * Dummy default file-operations: the only thing this does
  * is contain the open that then fills in the correct operations
  * depending on the special file...
  */</span>
<span class="token keyword">const</span>   <span class="token keyword">struct</span>   <span class="token class-name">file_operations</span>  def_chr_fops <span class="token operator">=</span> <span class="token punctuation">{</span>
     <span class="token punctuation">.</span>open <span class="token operator">=</span>  chrdev_open <span class="token punctuation">,</span>
     <span class="token punctuation">.</span>llseek <span class="token operator">=</span> noop_llseek<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果<code>node</code>是一个<code>char</code>设备，会给<code>i_fop</code> 赋值一个默认的<code>def_chr_fops</code>，也就是说对该<code>node</code>节点，有一个默认的操作。在<code>open</code>一个字符设备文件时，最终总会调用<code>chrdev_open</code>，然后调用各个<code>char</code>设备自己的<code>file_operations</code> 定义的<code>open</code>函数。 </p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span>   <span class="token keyword">int</span>  <span class="token function">chrdev_open</span><span class="token punctuation">(</span> <span class="token keyword">struct</span>  <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span>  <span class="token keyword">struct</span>  <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span><span class="token punctuation">{</span>
  ret <span class="token operator">=</span> <span class="token operator">-</span>ENXIO<span class="token punctuation">;</span>
     fops <span class="token operator">=</span> <span class="token function">fops_get</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">if</span>  <span class="token punctuation">(</span><span class="token operator">!</span>fops<span class="token punctuation">)</span>
         <span class="token keyword">goto</span>  out_cdev_put<span class="token punctuation">;</span>
 
     <span class="token function">replace_fops</span> <span class="token punctuation">(</span>filp<span class="token punctuation">,</span> fops<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">if</span>  <span class="token punctuation">(</span>filp<span class="token operator">-&gt;</span>f_op<span class="token operator">-&gt;</span>open<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         ret <span class="token operator">=</span> filp<span class="token operator">-&gt;</span>f_op<span class="token operator">-&gt;</span> <span class="token function">open</span> <span class="token punctuation">(</span>inode<span class="token punctuation">,</span> filp<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span>  <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
             <span class="token keyword">goto</span>  out_cdev_put<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
     <span class="token keyword">return</span>  <span class="token number">0</span><span class="token punctuation">;</span>
  out_cdev_put<span class="token operator">:</span>
     <span class="token function">cdev_put</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span>  ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  上面分析的核心意思是：<code>device_register()</code>函数除了注册在<code>/sys</code>下面外，还做了一件重要的事情，通过 <code>devtmpfs_create_node()</code>  在<code>/dev</code>目录下创建了一个设备节点<code>(inode)</code>，这个设备节点有一个默认的<code>file_operations</code>操作。</p>
<h4 id="2-7-5-misc杂项设备简介"><a href="#2-7-5-misc杂项设备简介" class="headerlink" title="2.7.5 misc杂项设备简介"></a>2.7.5 <code>misc</code>杂项设备简介</h4><p>引用：<a target="_blank" rel="noopener" href="https://blog.csdn.net/iriczhao/article/details/138586309">iriczhao</a></p>
<p>Linux 内核中的杂项设备（Miscellaneous Devices）是一种通用的设备类型，用于表示那些不适合其他设备类型的设备。这些设备通常是不规则的，没有标准的通信协议或接口。杂项设备提供了一种灵活的机制，允许我们将不同类型的设备注册为杂项设备，并通过统一的接口在用户空间访问它们。</p>
<p>在Linux 中，把无法归类的五花八门的设备定义成杂项设备。相较于字符设备，杂项设备有以下两个优点:</p>
<ul>
<li>(1)节省主设备号:<strong>杂项设备的主设备号固定为10</strong>，而<strong>字符设备不管是动态分配还是静态分配设备号，都会消耗一个主设备号</strong>，进而造成了主设备号浪费。当<strong>系统中注册了多个misc 设备驱动时，只需使用子设备号进行区分即可</strong>。</li>
<li>(2)<strong>使用简单</strong>：当使用普通的字符设备驱动时，如果开发人员需要导出操作接口给用户空间，就需要注册对应的字符驱动，并创建字符设备class 从而自动在/dev 下生成设备节点，而misc驱动只需要将基本信息通过结构体传递给相应处理函数即可。</li>
</ul>
<p>在驱动中使用miscdevice 结构体描述misc 设备， 该结构体定义在“ 内核源码/include/linux/miscdevice.h”文件中（在下面的实验代码中需要加入该头文件的引用），具体内容如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">miscdevice</span>  <span class="token punctuation">{</span>
    <span class="token keyword">int</span> minor<span class="token punctuation">;</span>                              <span class="token comment">// 次设备号</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>                       <span class="token comment">//名字 </span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> <span class="token operator">*</span>fops<span class="token punctuation">;</span> 	<span class="token comment">// file_operations 结构体指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> list<span class="token punctuation">;</span>                  <span class="token comment">// 作为一个链表节点挂接到misc设备维护的一个链表头上去misc_list</span>
    <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>parent<span class="token punctuation">;</span>                  <span class="token comment">// 次设备的父设备</span>
    <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>this_device<span class="token punctuation">;</span>            	<span class="token comment">// 本设备的device 结构体指针</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">attribute_group</span> <span class="token operator">*</span><span class="token operator">*</span>groups<span class="token punctuation">;</span>	<span class="token comment">//用于定义设备属性的指针数组。属性组定义了设备的属性，例如 sysfs 上的属性。</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>nodename<span class="token punctuation">;</span>          <span class="token comment">//杂项设备节点的名称，通常与 name 字段相同。此字段用于在 /sys 文件系统中创建设备节点。</span>
    <span class="token class-name">mode_t</span> mode<span class="token punctuation">;</span>						<span class="token comment">// 设备节点的权限模式，指定了用户对设备节点的访问权限。</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>struct miscdevice</code> 提供了一种将设备注册为杂项设备的机制，并指定了设备的名称、操作以及其他相关属性。杂项设备在 /dev 目录下创建，但是它们的名字与其驱动程序关联，而不是与设备类型直接关联。因此，同一类型的设备可能具有不同的名称，取决于它们所使用的驱动程序。</p>
<p><strong>杂项设备API</strong></p>
<p>在内核中，关于杂项设备提供的驱动API较少，仅包含两个API。</p>
<p><strong>注册杂项设备</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">misc_register</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">miscdevice</span> <span class="token operator">*</span>misc<span class="token punctuation">)</span>			<span class="token comment">//struct miscdevice *misc：杂项设备结构</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>该函数用于向内核注册一个杂项设备。如果次设备号设置为 <code>MISC_DYNAMIC_MINOR</code>，则会分配一个次设备号，并将其放置在结构体的 minor 字段中。对于其他情况，使用请求的次设备号。</p>
<p>传递的结构体被链接到内核中，并且在注销之前可能不会被销毁。默认情况下，对设备的 <code>open()</code> 系统调用会将 <code>file-&gt;private_data</code> 设置为指向该结构体。驱动程序不需要在 fops 中包含 open 函数。</p>
<p>成功时返回零，失败时返回负的 errno 代码。</p>
<p><strong>注销杂项设备</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">misc_deregister</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">miscdevice</span> <span class="token operator">*</span>misc<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>该函数用于注销之前使用 <code>misc_register()</code> 成功注册的杂项设备。</p>
<p><strong>杂项设备初始化</strong></p>
<p>在Linux内核中都会支持杂项设备，在内核启动过程中，会调用<code>misc_init()</code>完成杂项设备相关的初始化操作：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">misc_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">int</span> err<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_PROC_FS</span></span>
	<span class="token function">proc_create</span><span class="token punctuation">(</span><span class="token string">"misc"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>misc_proc_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	misc_class <span class="token operator">=</span> <span class="token function">class_create</span><span class="token punctuation">(</span>THIS_MODULE<span class="token punctuation">,</span> <span class="token string">"misc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	err <span class="token operator">=</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>misc_class<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>misc_class<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">goto</span> fail_remove<span class="token punctuation">;</span>

	err <span class="token operator">=</span> <span class="token operator">-</span>EIO<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">register_chrdev</span><span class="token punctuation">(</span>MISC_MAJOR<span class="token punctuation">,</span><span class="token string">"misc"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>misc_fops<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">goto</span> fail_printk<span class="token punctuation">;</span>
	misc_class<span class="token operator">-&gt;</span>devnode <span class="token operator">=</span> misc_devnode<span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

fail_printk<span class="token operator">:</span>
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"unable to get major %d for misc devices\n"</span><span class="token punctuation">,</span> MISC_MAJOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">class_destroy</span><span class="token punctuation">(</span>misc_class<span class="token punctuation">)</span><span class="token punctuation">;</span>
fail_remove<span class="token operator">:</span>
	<span class="token function">remove_proc_entry</span><span class="token punctuation">(</span><span class="token string">"misc"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">subsys_initcall</span><span class="token punctuation">(</span>misc_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上述代码主要完成以下三个操作：</p>
<ul>
<li>使用<code>proc_create()</code>创建一个名为 “misc” 的 proc 文件，使用指定的文件操作 <code>misc_proc_fops</code>。</li>
<li>使用<code>class_create()</code>创建一个名为 “misc” 的设备类。</li>
<li><code>register_chrdev()</code>注册字符设备</li>
</ul>
<p>上述代码的目的是初始化杂项设备，包括创建 proc 文件、创建设备类、注册字符设备等。</p>
<p><strong>杂项设备示例</strong></p>
<p>我们通常通过以下步骤来创建和注册杂项设备：</p>
<ul>
<li>1、定义和初始化 <code>miscdevice</code> 结构。</li>
<li>2、调用 <code>misc_register()</code> 函数注册杂项设备。</li>
<li>3、在驱动模块的退出函数中调用 <code>misc_deregister()</code> 函数注销杂项设备。</li>
</ul>
<p>例如下例代码：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span>		  <span class="token comment">//初始化头文件</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span>	  <span class="token comment">//最基本的文件，支持动态添加和卸载模块。</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/miscdevice.h&gt;</span> <span class="token comment">//注册杂项设备头文件</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h&gt;</span>		  <span class="token comment">//注册设备节点的文件结构体</span></span>

<span class="token keyword">struct</span> <span class="token class-name">file_operations</span> misc_fops <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token comment">// 文件操作集</span>
	<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE <span class="token comment">////将owner 字段指向本模块，可以避免在模块的操作正在被使用时卸载该模</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">miscdevice</span> misc_dev <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token comment">// 杂项设备结构体</span>
	<span class="token punctuation">.</span>minor <span class="token operator">=</span> MISC_DYNAMIC_MINOR<span class="token punctuation">,</span> 		<span class="token comment">// 动态申请的次设备号</span>
	<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"hello"</span><span class="token punctuation">,</span>				 	<span class="token comment">// 杂项设备名字是hello</span>
	<span class="token punctuation">.</span>fops <span class="token operator">=</span> <span class="token operator">&amp;</span>misc_fops<span class="token punctuation">,</span>			 		<span class="token comment">// 文件操作集</span>
	<span class="token punctuation">.</span>nodename <span class="token operator">=</span> <span class="token string">"hello_dev"</span><span class="token punctuation">,</span>			<span class="token comment">// 设备节点名字</span>
	<span class="token punctuation">.</span>mode <span class="token operator">=</span> <span class="token number">0666</span>						<span class="token comment">// 设备节点权限</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">misc_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>
	ret <span class="token operator">=</span> <span class="token function">misc_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>misc_dev<span class="token punctuation">)</span><span class="token punctuation">;</span> 			<span class="token comment">// 在初始化函数中注册杂项设备</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"misc registe is error \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 	<span class="token comment">// 打印注册杂项设备失败</span>
	<span class="token punctuation">}</span>
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"misc registe is succeed \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 		<span class="token comment">// 打印注册杂项设备成功</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">misc_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">misc_deregister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>misc_dev<span class="token punctuation">)</span><span class="token punctuation">;</span> 				<span class="token comment">// 在卸载函数中注销杂项设备</span>
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">" misc goodbye! \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">module_init</span><span class="token punctuation">(</span>misc_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>misc_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"topeet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>运行测试</strong></p>
<p>将编译生成的驱动模块<code>hello.ko</code> 拷贝到开发板上，输入以下命令加载驱动模块。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">insmod hello.ko <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>可以看到驱动加载之后，打印“<code>misc registe is succeed</code>”,说明misc 驱动注册成功。输入以下命令查看加载的驱动模块，驱动加载成功如下（图13-5）所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">lsmod <span class="token operator">|</span> <span class="token function">grep</span> hello
hello                  <span class="token number">16384</span>  <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>然后来到<code>/sys/class/misc</code> 目录下，可以看到名为“test”的文件夹已经被创建了，在<code>/sys/class/misc</code> 目录下有<code>misc</code> 类的所有设备，每个注册的杂项设备对应一个文件夹目录，如下所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ls</span> /sys/class/misc/
agpgart  cpu_dma_latency  ecryptfs  hello  hw_random     mcelog  rfkill    tun      uinput  vga_arbiter  vsock
autofs   device-mapper    fuse      hpet   loop-control  psaux   snapshot  udmabuf  vfio    vmci

<span class="token builtin class-name">cd</span> /sys/class/misc/hello
<span class="token function">ls</span>
dev  power  subsystem  uevent<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>驱动加载成功之后会生成<code>/dev/hello_dev</code> 设备驱动文件,这个是通过<code>.nodename = "hello_dev",</code>设置的，输入以下命令查看杂项设备的主次设备号。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ll /dev/hello_dev
crw-rw-rw- <span class="token number">1</span> root root <span class="token number">10</span>, <span class="token number">57</span> <span class="token number">8</span>月   <span class="token number">2</span> 09:35 /dev/hello_devl<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>从上图可以看出，<code>/dev/hello_dev</code>这个杂项设备的主设备号为10，次设备号为57，最后可以使用以下命令对驱动进行卸载，卸载完成如下所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">rmmod hello
lsmod <span class="token operator">|</span> <span class="token function">grep</span> hello
<span class="token function">dmesg</span> 
<span class="token punctuation">[</span> <span class="token number">1489.104972</span><span class="token punctuation">]</span> misc registe is succeed 
<span class="token punctuation">[</span> <span class="token number">2114.187939</span><span class="token punctuation">]</span>  misc goodbye<span class="token operator">!</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<p><strong>杂项设备和字符设备</strong></p>
<p>在 Linux 内核中，杂项设备（<code>misc device</code>）和字符设备（<code>character device</code>）是两种不同类型的设备。在内核中的实现和使用方式略有不同。</p>
<ul>
<li><p>杂项设备（<code>Miscellaneous Devices</code>）：</p>
<ul>
<li>杂项设备是一种比较通用的设备类型，用于表示不适合其他设备类型的设备。</li>
<li>这些设备通常是不规则的，没有标准的通信协议或接口。</li>
<li>杂项设备在 <code>/dev</code> 目录下创建，但是它们的名字与其驱动程序关联，而不是与设备类型直接关联。</li>
<li>在内核中，杂项设备通过 <code>miscdevice</code> 结构来表示，该结构包含了设备的名称、设备号、文件操作等信息。</li>
<li>创建和注册杂项设备通常涉及使用 <code>misc_register()</code> 和 <code>misc_deregister()</code> 等函数。</li>
</ul>
</li>
<li><p>字符设备（<code>Character Devices</code>）：</p>
<ul>
<li>字符设备是一种基本的设备类型，用于处理以字符为单位的数据流。</li>
<li>这些设备通常是顺序访问的，没有固定的大小或边界。</li>
<li>字符设备在 <code>/dev</code> 目录下创建，并且其名称直接与设备类型相关联。</li>
<li>在内核中，字符设备通过 <code>cdev</code> 结构来表示，该结构包含了设备的文件操作等信息。</li>
<li>创建和注册字符设备通常涉及使用 <code>cdev_add()</code> 和 <code>cdev_del()</code> 等函数。</li>
</ul>
</li>
</ul>
<p>总的来说，杂项设备适用于那些不符合标准设备模型的设备，而字符设备则适用于以字符流形式进行通信的设备。在编写内核驱动程序时，我们可以根据设备的特性选择适当的设备类型。</p>
<h2 id="第03章-Linux内核的并发机制"><a href="#第03章-Linux内核的并发机制" class="headerlink" title="第03章 Linux内核的并发机制"></a>第03章 Linux内核的并发机制</h2><h3 id="3-1-并发控制的概念"><a href="#3-1-并发控制的概念" class="headerlink" title="3.1 并发控制的概念"></a>3.1 并发控制的概念</h3><h4 id="1-并发控制的概念"><a href="#1-并发控制的概念" class="headerlink" title="1.并发控制的概念"></a>1.并发控制的概念</h4><p><strong>并发</strong>(concurrency)指的是多个执行单元同时、并行被执行，而<strong>并发的执行单元对共享资源(硬件资源和软件上的全局变量、静态变量等)<strong>的访问则很容易导致</strong>竞态</strong> (race conditions)</p>
<h4 id="2-竞态发生的情况"><a href="#2-竞态发生的情况" class="headerlink" title="2.竞态发生的情况"></a>2.竞态发生的情况</h4><p>对称多处理器 (SMP) 的多个CPU</p>
<img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202407241707545.png" alt="image-20240724170746468" style="zoom:50%;">

<ul>
<li>单CPU内进程与抢占它的进程<ul>
<li>Linux 2.6内核支持抢占调度，一个进程在内核执行的时候可能被另一高优先级进程打新</li>
</ul>
</li>
<li>中断与进程之间<ul>
<li>中断可以打断正在执行的进程，如果中断处理程序访问进程正在访问的资源，则竞态也会发生</li>
</ul>
</li>
</ul>
<h4 id="3-解决竞态问题的方法"><a href="#3-解决竞态问题的方法" class="headerlink" title="3.解决竞态问题的方法"></a>3.解决竞态问题的方法</h4><p>保证对共享资源的互斥访问，所谓<strong>互斥访问</strong>是指一个执行单元在访问共享资源的时候，其他的执行单元被禁止访问<br>访问共享资源的代码区域称为<strong>临界区</strong> (critical sections) ，<strong>临界区需要被以某种互斥机制加以保护</strong>。</p>
<h4 id="4-互斥机制"><a href="#4-互斥机制" class="headerlink" title="4.互斥机制"></a>4.互斥机制</h4><ul>
<li>中断屏蔽</li>
<li>原子量，不能被拆分的操作，比如运算过程不能被拆分</li>
<li>自旋锁</li>
<li>信号量 多值信号量</li>
<li>互斥锁（互斥体，也称二值信号量）</li>
</ul>
<h3 id="3-2-中断屏蔽"><a href="#3-2-中断屏蔽" class="headerlink" title="3.2 中断屏蔽"></a>3.2 中断屏蔽</h3><p>在Linux 中，屏蔽中断是指禁止处理器响应特定类型的硬件中断信号。屏蔽中断可以用于控制处理器对来自硬件设备的中断请求的响应</p>
<p>在 Linux 中，你可以使用以下方法来屏蔽中断:</p>
<ul>
<li>1.<strong>屏蔽特定中断线</strong>: Linux 内核提供了一组函数来操作 CPU 的中断控制器，例如<code>disable_irg()</code>和<code>enable_irq()</code>。你可以使用这些函数来屏蔽或恢复特定的硬件中断线。</li>
<li>2.<strong>屏蔽所有中断</strong>: Linux 内核还提供了 <code>local_irg_disable()</code> 和 <code>local_irq_enable()</code> 函数，用于完全屏蔽所有中断信号。当你调用 <code>local_irg_disable()</code> 函数时，处理器将不再响应任何中断请求，而是将所有中断信号置于屏蔽状态。相应地，当你调用 <code>local_irq_enable()</code> 函数时，处理器将恢复对中断请求的响应.</li>
</ul>
<p>屏蔽中断可能会导致系统出现一些问题，例如延迟或不可预测的行为。在屏蔽中断之前，你应该仔细考虑并确保这是你需要的操作</p>
<p>屏蔽中断是一个高级操作，通常在编写驱动程序中使用。对于一般用户和应用程序开发者来说，直接屏蔽中断通常不是必需的。</p>
<p>例如:</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token number">1</span>ocal_irq_disable<span class="token punctuation">(</span><span class="token punctuation">)</span>				<span class="token comment">/*屏蔽中断*/</span>
critical section				<span class="token comment">/*临界区*/</span>
<span class="token function">local_irq_enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>				<span class="token comment">/*开中断*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="3-3-原子量"><a href="#3-3-原子量" class="headerlink" title="3.3 原子量"></a>3.3 原子量</h3><h4 id="1-原子量概念"><a href="#1-原子量概念" class="headerlink" title="1.原子量概念"></a>1.原子量概念</h4><ul>
<li>在 Linux 内核中，原子操作被广泛应用于多线程或多进程环境下对共享资源的访问和修改;</li>
<li>Linux 内核提供了一些原子操作函数，这些函数能够保证在执行期间不会被中断或并发操作所打断.;</li>
<li>原子量可以分为整型原子量和位原子量;</li>
</ul>
<h4 id="2-整型原子量"><a href="#2-整型原子量" class="headerlink" title="2.整型原子量"></a>2.整型原子量</h4><p>包含头文件</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/atomic.h&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>定义原子量<br>Linux 内核中的原子变量使用 <code>atomic_t</code> 类型来表示</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">atomic_t</span> v<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>设置原子变量的值</p>
<pre class="line-numbers language-none"><code class="language-none">void atomilc_set(atomic_t *v，int i); // 设置原子变量的值为i<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>例如:</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">atomic_t</span> v <span class="token operator">=</span> <span class="token function">ATOMIC_INIT</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 定义原子变量v并初始化为0</span>
<span class="token function">atomic_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">;</span><span class="token comment">// 设置原子变量的值为1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>


<p>获取原子变量的值</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">atomic_read</span><span class="token punctuation">(</span><span class="token class-name">atomic_t</span> <span class="token operator">*</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 返回原子变量的值</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<p>原子变量加/减</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">atomic_add</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token class-name">atomic_t</span> <span class="token operator">*</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 原子变量增加i</span>
<span class="token keyword">void</span> <span class="token function">atomic_sub</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token class-name">atomic_t</span> <span class="token operator">*</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 原子变量减少i</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>原子变量自增/自减</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">atomic_inc</span><span class="token punctuation">(</span><span class="token class-name">atomic_t</span> <span class="token operator">*</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 原子变量增加1</span>
<span class="token keyword">void</span> <span class="token function">atomic_dec</span><span class="token punctuation">(</span>atomic t <span class="token operator">*</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 原子变量减少1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>操作并测试</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">atomic_inc_and_test</span><span class="token punctuation">(</span><span class="token class-name">atomic_t</span> <span class="token operator">*</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">atomic_dec_and_test</span><span class="token punctuation">(</span><span class="token class-name">atomic_t</span> <span class="token operator">*</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">atomic_sub_and_test</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token class-name">atomic_t</span> <span class="token operator">*</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>上述操作对原子变量执行自增、自减和减操作后 (注意没有加) 测试其是否为0，为0返回true，否则返回fals</p>
<p>操作并返回</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">atomic_add_return</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token class-name">atomic_t</span> <span class="token operator">*</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">atomic_sub_return</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token class-name">atomic_t</span> <span class="token operator">*</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">atomic_inc_return</span><span class="token punctuation">(</span><span class="token class-name">atomic_t</span> <span class="token operator">*</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">atomic_dec_return</span><span class="token punctuation">(</span><span class="token class-name">atomic_t</span> <span class="token operator">*</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>上述操作对原子变量进行加/减和自增/自减操作，并返回新的值</p>
<h4 id="3-实例09-整型原子量"><a href="#3-实例09-整型原子量" class="headerlink" title="3.实例09 整型原子量"></a>3.实例09 整型原子量</h4><p>使用原子量实现设备只能被一个进程打开<br>源文件<br>源代码<br>运行结果</p>
<h3 id="3-3-自旋锁"><a href="#3-3-自旋锁" class="headerlink" title="3.3 自旋锁"></a>3.3 自旋锁</h3><h4 id="1-自旋锁概念"><a href="#1-自旋锁概念" class="headerlink" title="1.自旋锁概念"></a>1.自旋锁概念</h4><p>Linux 中的自旋锁是一种保护共享资源的同步机制。自旋锁的目的是防止多个线程同时访问共享资源，从而导致数据不一致或其他问题.</p>
<p>自旋锁的特点是在获取锁的时候，如果锁已经被其他线程持有，则当前线程会一直”自旋”，也就是循环等待，直到锁被释放为止。这种方<br>式比较适用于短时间内多个线程竞争同一个锁的情况，因为自旋等待的时间比较短，不会造成线程的长时间阻塞。</p>
<p>自旋锁不会睡眠，信号量会睡眠</p>
<ul>
<li>包含头文件</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/spinlock.h&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>定义自旋锁</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">spinlock_t</span> lock<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>初始化自旋锁</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">spin_lock_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>获得自旋锁</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">spin_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果能够立即获得锁，它就马上返回，否则，它将自旋在那里</p>
<ul>
<li>尝试获得自旋锁</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">spin_trylock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>该宏尝试获得自旋锁lock，如果能立即获得锁，它获得锁并返回真，否则立即返回假</p>
<p>。释放自旋锁</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>自旋锁注意事项<ul>
<li>自旋锁实际上是忙等锁</li>
<li>自旋锁可能导致系统死锁，一段代码在自己获得了锁之后,自己又想第二次获得这个锁时(这个锁没有被释放时)</li>
<li>自旋锁锁定期间不能调用可能引起进程调度的函数，如果系统要多个进程要获得自旋锁,如果在自旋锁中睡眠，会照成其它讲程会一直的忙等待，cpu的使用率会下降</li>
</ul>
</li>
<li>什么情况会引发系统调度<ul>
<li>每隔一个固定的时间间隔，任务状态会刷新一次，linux默认定义这个频率200HZ，也就是5ms刷新一次。</li>
<li>在执行到睡眠函数时，会引发系统的一次调度</li>
</ul>
</li>
</ul>
<h4 id="2-实例10——自旋锁"><a href="#2-实例10——自旋锁" class="headerlink" title="2.实例10——自旋锁"></a>2.实例10——自旋锁</h4><h4 id="3-读写自旋锁"><a href="#3-读写自旋锁" class="headerlink" title="3.读写自旋锁"></a>3.读写自旋锁</h4><p>定义和初始化读写自旋锁</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">rwlock_t</span> my_rwlock<span class="token punctuation">;</span>
<span class="token class-name">rwlock_t</span> my_rwlock <span class="token operator">=</span> RW_LOCK_UNLOCKED<span class="token punctuation">;</span>		<span class="token comment">// 静态初始化</span>
<span class="token function">rwlock_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_rwlock<span class="token punctuation">)</span><span class="token punctuation">;</span>				   <span class="token comment">// 动态初始化</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>


<p>读锁定</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">read_Tock</span><span class="token punctuation">(</span><span class="token class-name">rwlock_t</span> <span class="token operator">*</span>Tock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">read_lock_irqsave</span><span class="token punctuation">(</span><span class="token class-name">rwlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">read_1ock_irq</span><span class="token punctuation">(</span><span class="token class-name">rwlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">read_Tock_bh</span><span class="token punctuation">(</span><span class="token class-name">rwlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>读解锁</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">read_unlock</span><span class="token punctuation">(</span>rwlock t <span class="token operator">*</span><span class="token number">1</span>ock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">read_unlock_irqrestore</span><span class="token punctuation">(</span><span class="token class-name">rwlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">read_unlock_irq</span><span class="token punctuation">(</span><span class="token class-name">rwlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">read_unlock_bh</span><span class="token punctuation">(</span><span class="token class-name">rwlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>写锁定</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">write_lock</span><span class="token punctuation">(</span><span class="token class-name">rwlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">write_lock_irqsave</span><span class="token punctuation">(</span><span class="token class-name">rwlock_t</span> <span class="token operator">*</span>lock， <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">write_lock_irq</span><span class="token punctuation">(</span><span class="token class-name">rwlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">write_lock_bh</span><span class="token punctuation">(</span><span class="token class-name">rwlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">write_trylock</span><span class="token punctuation">(</span><span class="token class-name">rwlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token operator">:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>写解锁</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">write_un1ock</span><span class="token punctuation">(</span><span class="token class-name">rwlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">write_unlock_irqrestore</span><span class="token punctuation">(</span><span class="token class-name">rwlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">write_unlock_irq</span><span class="token punctuation">(</span><span class="token class-name">rwlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">write_unlock_bh</span><span class="token punctuation">(</span><span class="token class-name">rwlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>读写自旋锁使用</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">rwlock_t</span> lock<span class="token punctuation">;</span>				<span class="token comment">/* 定义rwlock */</span>
<span class="token function">rwlock_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">/* 初始化rwlock*/</span>

<span class="token comment">/* 读时获取锁*/</span>
<span class="token function">read_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 临界资源*/</span>
<span class="token function">read_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*写时获取锁*/</span>
<span class="token function">write_lock_irqsave</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*临界资源*/</span>
<span class="token function">write_unlock_irqrestore</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">,</span> fags<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="4-顺序锁"><a href="#4-顺序锁" class="headerlink" title="4.顺序锁"></a>4.顺序锁</h4><p>写顺序锁操作</p>
<ul>
<li>获得顺序锁</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">write_seqlock</span><span class="token punctuation">(</span><span class="token class-name">seqlock_t</span> <span class="token operator">*</span>s1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">write_tryseqlock</span><span class="token punctuation">(</span><span class="token class-name">seqlock_t</span> <span class="token operator">*</span>s1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">write_seglock_irqsave</span><span class="token punctuation">(</span>lock，flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">write_seqlock_irq</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">write_seqlock_bh</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>释放顺序锁</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">write_sequnlock</span><span class="token punctuation">(</span><span class="token class-name">seqlock_t</span> <span class="token operator">*</span>s1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">write_sequnlock_irqrestore</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span>
<span class="token function">write_sequnlock_irq</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token function">write_sequnlock_bh</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>读顺序锁操作</p>
<ul>
<li>读开始</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token function">read_seqbegin</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">seqlock_t</span> <span class="token operator">*</span>s1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">read_seqbegin_irqsave</span><span class="token punctuation">(</span>lock，flags<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>判断是否需要重读</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">read_seqretry</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">seqlock_t</span> <span class="token operator">*</span>s1<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> iv<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">read_seqretry_irqrestore</span><span class="token punctuation">(</span>lock，iv，flags<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<h3 id="3-4-信号量"><a href="#3-4-信号量" class="headerlink" title="3.4 信号量"></a>3.4 信号量</h3><h4 id="1-信号量概念"><a href="#1-信号量概念" class="headerlink" title="1.信号量概念"></a>1.信号量概念</h4><p>内核区动中使用互斥体的典型场景是对设备进行独占性访问，避免多个线程同时访问设备导致竞争和冲突。通过在关键代码段前后加锁和<br>解锁操作，可以确保只有一个线程可以执行关键代码段</p>
<p>信号量分为多值信号量和二值信号量，二值信号量就是互斥体 (互斥锁)</p>
<ul>
<li><p>包含头文件</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/semaphore.h&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>定义信号量</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">semaphore</span> sem<span class="token operator">:</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>初始化信号量</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">sema_init</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">semaphore</span> <span class="token operator">*</span>sem<span class="token punctuation">,</span> <span class="token keyword">int</span> va1<span class="token punctuation">)</span> <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>信号量的获取</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 获取信号量，如果可以获取，函数直接返回</span>
<span class="token comment">// 如果不能获取则进程进入睡眠，进入阻塞，等待被唤醒后，继续执行</span>
<span class="token comment">// 睡眠与唤醒的机制</span>
<span class="token keyword">void</span> <span class="token function">down</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">semaphore</span> <span class="token operator">*</span> sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">down_interruptible</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">semaphore</span> <span class="token operator">*</span> sem<span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">// 睡眠时可以中断</span>
<span class="token keyword">int</span> <span class="token function">down_trylock</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">semaphore</span> <span class="token operator">*</span> sem<span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">// 尝试获得信号量</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>信号量的释放</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">up</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">semaphore</span> <span class="token operator">*</span> sem<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ul>
<h4 id="2-实例11——信号量"><a href="#2-实例11——信号量" class="headerlink" title="2.实例11——信号量"></a>2.实例11——信号量</h4><p>使用信号量保存临界资源<br>源文件</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">semaphore</span> sem<span class="token punctuation">;</span>

<span class="token function">sema_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sem<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>

<span class="token function">down</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">// 用这个也可以 down_interruptible(&amp;sem);   获得信号量，信号量的值减1 ，P操作</span>
<span class="token comment">/*邻接资源*/</span>
<span class="token function">up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">// 释放信号量 V操作，信号量的值加1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-5-互斥体"><a href="#3-5-互斥体" class="headerlink" title="3.5 互斥体"></a>3.5 互斥体</h3><h4 id="1-互斥体概念"><a href="#1-互斥体概念" class="headerlink" title="1.互斥体概念"></a>1.互斥体概念</h4><p>互斥体是一种二进制信号量，用于保护共享资源，使得只有一个线程可以访问临界区。当一个线程获取了与斥体后，其他线程无法获取该<br>互斥体，只能等待互斥体被释放。</p>
<p>驱动中使用互斥体的典型场景是对设备进行独占性访问，避免多个线程同时访问设备导致竞争和冲突。通过在关键代码段前后加锁和解锁<br>操作，可以确保只有一个线程可以执行关键代码段。</p>
<p>互斥锁是睡眠与唤醒的机制，得不到睡眠，被唤醒后继续执行获得锁</p>
<ul>
<li><p>包含头文件</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mutex.h&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


</li>
<li><p>初始化</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">mutex</span> my_mutex<span class="token punctuation">;</span>
<span class="token function">mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>


</li>
<li><p>获取互斥体</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mutex</span> <span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">mutex_trylock</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mutex</span> <span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//有返回值  得到锁返回真1 反之返回0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>释放互斥体</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> __sched <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mutex</span> <span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>例如，<code>mutex</code>的使用方法</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">mutex</span> mutex		<span class="token comment">/* 定义mutex */</span>
<span class="token function">mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">/* 初始化mutex */</span>
<span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">/* 获取mutex 		只能被一个进程获取 ，另外一个进程需要等待	*/</span>
<span class="token comment">/* 临界资源 */</span>
<span class="token function">mutex_un1ock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">/* 释放mutex */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<h4 id="2-实例12——互斥体"><a href="#2-实例12——互斥体" class="headerlink" title="2.实例12——互斥体"></a>2.实例12——互斥体</h4><p>使用互斥体实现设备只能被一个进程打开<br>源文件</p>
<p>源代码</p>
<p>运行结果</p>
<h2 id="第04章-Linux内核的IO模型"><a href="#第04章-Linux内核的IO模型" class="headerlink" title="第04章 Linux内核的IO模型"></a>第04章 Linux内核的IO模型</h2><h3 id="4-1-IO模型介绍"><a href="#4-1-IO模型介绍" class="headerlink" title="4.1 IO模型介绍"></a>4.1 IO模型介绍</h3><p>在Linux 中，IO 模型用于描述应用程序与输入输出设备之间的数据传输方式和机制。Linux 提供了多种IO 模型，常见的包括阻塞式IO、<br>非阻塞式IO 、IO 复用 (select/poll/epoll) 、信号驱动IO  和异步IO 。</p>
<ol>
<li>阻塞式IO (Blocking IO ):在阻塞式IO 中，当应用程序发起一个IO 操作时，它会一直等待直到操完成。在这个过程中，应用程<br>序的执行将被阻塞。只有当数据准备好并成功传输后，IO 操作才会返回。</li>
<li>非阻塞式IO (Non-blocking IO : 在非阻塞式IO 中，应用程序在发起一个IO操作后，立即返回并继续执行其他任务，而不必等待<br>操作完成。如果数据没有准备好或无法立即传输，IO操作将返回一个错误码，应用程序可以通过轮询来检查数据是否准备好。</li>
<li>IO复用 (IO Multiplxing) :IO 复用使用 selet，poll或 epoll等机制来同时监听多人IO事件应用程可以将多个文件描待符注册到一个IO复用对象中，并通过阻塞等待该对象上的任何事件发生。一旦有事件发生，应用程序就可以处理该事件，而不必阻塞等待。</li>
<li>信号驱动IO(Signal-driven IO) : 信号动IO 使用信号机制来通知应用程序IO事件的发生。应用程序通过调用 <code>sigaction</code> 函数来注册一个信号处理函数，并在接收到指定信号后进行相应的处理操作。</li>
<li>异步IO(Asynchronous IO): 异步IO 中，应用程序发起一个IO操作后，可以立即返回并继续执行其他任务。当数据准备好并传输完成时，操作系统会通知应用程序，应用程序可以通过回调函数来处理完成的IO事件。</li>
</ol>
<p>每种IO 模型都有其适用的场景和特点。在选择IO模型时，需要考虑应用程序的需求、性能要求以及平台支持等因素</p>
<h3 id="4-2-等待队列-waitqueue"><a href="#4-2-等待队列-waitqueue" class="headerlink" title="4.2 等待队列 waitqueue"></a>4.2 等待队列 waitqueue</h3><h4 id="1-等待队列概念"><a href="#1-等待队列概念" class="headerlink" title="1.等待队列概念"></a>1.等待队列概念</h4><p>等待队列 以队列为基础数据结构，与进程调度机制紧密结合，能够用于实现内核中的异步事件通知机制，也可以用来同步对系统资源的访问 (如信号量)</p>
<p>包含头文件</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/wait.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/sched.h&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>等待队列的定义</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">__wait_queue_head</span><span class="token punctuation">{</span>
    <span class="token class-name">spinlock_t</span> lock<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> task_1ist<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">__wait_queue_head</span> <span class="token class-name">wait_queue_head_t</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>定义等待队列头</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">wait_queue_head_t</span> wq<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>初始化等待队列头</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">init_waitqueue_head</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wq<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>等待事件发生(睡眠)</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
wait_event - sleep until a condition gets true
@wq: the waitqueue to wait on
@condition: a C expression for the event to wait for int flag = 0 ;
*/</span>

<span class="token comment">// 传递等待队列的结构体，而不传递结构体地址</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">wait_event</span><span class="token expression"><span class="token punctuation">(</span>queue，condition<span class="token punctuation">)</span></span></span>

<span class="token function">wait_event_interruptible</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> condition<span class="token punctuation">)</span>
<span class="token function">wait_event_timeout</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> condition<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span>
<span class="token function">wait_event_interruptible_timeout</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> condition<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>例如:</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">wait_event</span><span class="token punctuation">(</span>wq<span class="token punctuation">,</span><span class="token punctuation">(</span>flag <span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 返回:如果condition表达为真，这个函数成功返回</span>
<span class="token comment">// 如果condition表达为假，这个函数在此睡眠     过一段时间后，使用wake_up唤醒了等待队列，再次condition的结果</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>。唤醒等待队列</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">wake_up</span><span class="token punctuation">(</span><span class="token class-name">wait_queue_head_t</span> <span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">wake_up_interruptible</span><span class="token punctuation">(</span><span class="token class-name">wait_queue_head_t</span> queue<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>。直接睡眠(不判断条件的睡眠)</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">sleep_on</span><span class="token punctuation">(</span><span class="token class-name">wait_queue_head_t</span> <span class="token operator">*</span>q <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">interruptible_sleep_on</span><span class="token punctuation">(</span><span class="token class-name">wait_queue_head_t</span> <span class="token operator">*</span>q <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="4-3-Linux内核阻塞IO"><a href="#4-3-Linux内核阻塞IO" class="headerlink" title="4.3 Linux内核阻塞IO"></a>4.3 Linux内核阻塞IO</h3><h4 id="1阻塞IO概念"><a href="#1阻塞IO概念" class="headerlink" title="1阻塞IO概念"></a>1阻塞IO概念</h4><p><strong>阻塞操作</strong>指在执行设备操作时，若不能获得资源则进程睡眠。当满足可操作的条件后，内核唤醒进程继续执行。</p>
<h4 id="2-实例13-阻塞IO"><a href="#2-实例13-阻塞IO" class="headerlink" title="2.实例13 阻塞IO"></a>2.实例13 阻塞IO</h4><p>使用等待队列实现设备读阻塞</p>
<p>源文件和源代码</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*hello.c*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/uaccess.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/ioctl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/spinlock.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/semaphore.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/atomic.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mutex.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/wait.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/sched.h&gt;</span></span>

<span class="token keyword">int</span> hello_major <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_BUF_COUNT</span> <span class="token expression"><span class="token number">128</span></span></span>
<span class="token keyword">char</span> dribuf<span class="token punctuation">[</span>MAX_BUF_COUNT<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">atomic_t</span> v<span class="token punctuation">;</span>					  <span class="token comment">// 原子变量</span>
<span class="token class-name">spinlock_t</span> lock<span class="token punctuation">;</span>			  <span class="token comment">// 自旋锁</span>
<span class="token keyword">struct</span> <span class="token class-name">semaphore</span> sem<span class="token punctuation">;</span>		  <span class="token comment">// 信号量</span>
<span class="token keyword">struct</span> <span class="token class-name">mutex</span> mutex<span class="token punctuation">;</span>			  <span class="token comment">// 互斥锁</span>
<span class="token class-name">wait_queue_head_t</span> wait_queue<span class="token punctuation">;</span> <span class="token comment">// 等待队列的头</span>

<span class="token comment">// 设置一个标志位，表示设备的使用情况</span>
<span class="token comment">// busy_flag == 0:not busy</span>
<span class="token comment">// busy_flag &gt; 0:busy</span>
<span class="token keyword">int</span> busy_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> dribuf_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>		<span class="token comment">//表示dribuf中的字节数，dribuf_len==0 ，表示没数据</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">hello_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"hello_driver打开成功!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">hello_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"hello_driver关闭成功!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">hello_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token class-name">ssize_t</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>dribuf_len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">// dribuf_len == 0 表示驱动中没有数据</span>
		<span class="token comment">// dribuf_len != 0 表示驱动中有数据</span>
		<span class="token comment">// 此时 (dribuf_len != 0) 条件为假,wait_event interruptible 进入睡眠状态，造成进程读阻塞</span>
		<span class="token comment">// 有讲程向驱动中写入了数据，此时dribuf_len != 0  (dribuf len != 0)条件为真，函数返回</span>
		<span class="token function">wait_event_interruptible</span><span class="token punctuation">(</span>wait_queue<span class="token punctuation">,</span> <span class="token punctuation">(</span>dribuf_len<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">down_interruptible</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">// 睡眠时可以中断  P操作，信号量的值减1</span>
	ret <span class="token operator">=</span> <span class="token function">copy_to_user</span><span class="token punctuation">(</span>usrbuf<span class="token punctuation">,</span> dribuf<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"错误：应用程序读取驱动内的数据失败\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"应用程序读取驱动内的数据成功, 读取了%ld bytes\n"</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>						<span class="token comment">// 释放信号量 V操作，信号量的值加1</span>
	dribuf_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	ret <span class="token operator">=</span> count<span class="token punctuation">;</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">hello_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token class-name">ssize_t</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>count <span class="token operator">&gt;</span> MAX_BUF_COUNT<span class="token punctuation">)</span><span class="token punctuation">{</span>
		count <span class="token operator">=</span> MAX_BUF_COUNT<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">down_interruptible</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">// 睡眠时可以中断  P操作，信号量的值减1</span>
	ret <span class="token operator">=</span> <span class="token function">copy_from_user</span><span class="token punctuation">(</span>dribuf<span class="token punctuation">,</span> usrbuf<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"错误：应用程序写给驱动数据失败\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"应用程序写给驱动数据成功, 用户把数据写进驱动程序了，写了%ld bytes\n"</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>						<span class="token comment">// 释放信号量 V操作，信号量的值加1</span>
	dribuf_len <span class="token operator">=</span> count<span class="token punctuation">;</span>				<span class="token comment">// 应用数据写给驱动的数据量</span>
	<span class="token function">wake_up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wait_queue<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	ret <span class="token operator">=</span> count<span class="token punctuation">;</span>

	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">hello_unlocked_ioctl</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">long</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token class-name">cdev</span> cdev <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE <span class="token comment">// 表示的是指向本模块的指针</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">file_operations</span> hello_fops <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>open <span class="token operator">=</span> hello_open<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>release <span class="token operator">=</span> hello_release<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>read <span class="token operator">=</span> hello_read<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>write <span class="token operator">=</span> hello_write<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>unlocked_ioctl <span class="token operator">=</span> hello_unlocked_ioctl<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">hello_int</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>
	ret <span class="token operator">=</span> <span class="token function">register_chrdev</span><span class="token punctuation">(</span>hello_major<span class="token punctuation">,</span> <span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>hello_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"错误：注册字符设备失败\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">atomic_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	   <span class="token comment">// 初始化原子变量为0,表示没有资源有效</span>
	<span class="token function">spin_lock_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化自旋锁,初始化后锁的状态是开的</span>
	<span class="token function">sema_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sem<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>	<span class="token comment">// 初始化信号量，初始化后信号量的状态是1</span>
	<span class="token function">init_waitqueue_head</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wait_queue<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"hello_driver installed sucessed!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">hello_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">unregister_chrdev</span><span class="token punctuation">(</span>hello_major<span class="token punctuation">,</span> <span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"hello_driver uninstall sucessed!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>hello_int<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 宏函数做关联</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>hello_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * 设置模块的许可协议。
 * 设置模块的作者信息。
 * 设置模块的描述信息。
 */</span>
<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"Dual BSD/GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"GeYangwen"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_DESCRIPTION</span><span class="token punctuation">(</span><span class="token string">"A simple Hello world module"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*test_read.c*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h&gt;</span>	</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_BUF_COUNT</span> <span class="token expression"><span class="token number">128</span></span></span>
<span class="token keyword">char</span> buf<span class="token punctuation">[</span>MAX_BUF_COUNT<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/hello"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fd = %d\n"</span><span class="token punctuation">,</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> MAX_BUF_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"read %d bytes, data = %s\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// getchar();</span>

    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*test_write.c*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h&gt;</span>	</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_BUF_COUNT</span> <span class="token expression"><span class="token number">128</span></span></span>
<span class="token keyword">char</span> buf<span class="token punctuation">[</span>MAX_BUF_COUNT<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/hello"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fd = %d\n"</span><span class="token punctuation">,</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// memset(buf, 0, MAX_BUF_COUNT);                           //清空buf内的东西</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"hello world\0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"write"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MAX_BUF_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span>                          <span class="token comment">//清空buf内的东西</span>

    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile"><span class="token comment"># Makefile</span>
<span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">warning</span> KERNELRELEASE<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>KERNELRELEASE<span class="token punctuation">)</span><span class="token punctuation">)</span>		

<span class="token keyword">ifeq</span> <span class="token punctuation">(</span><span class="token variable">$</span><span class="token punctuation">(</span>KERNELRELEASE<span class="token punctuation">)</span>,<span class="token punctuation">)</span>

KERNELDIR <span class="token operator">?=</span> /lib/modules/<span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">shell</span> uname -r<span class="token punctuation">)</span>/build

PWD <span class="token operator">:=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">shell</span> pwd<span class="token punctuation">)</span>

<span class="token target symbol">modules</span><span class="token punctuation">:</span>
	<span class="token variable">$</span><span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> -C <span class="token variable">$</span><span class="token punctuation">(</span>KERNELDIR<span class="token punctuation">)</span> M<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PWD<span class="token punctuation">)</span> modules

	gcc test_write.c -o test_write
	gcc test_read.c -o test_read
	rm -rfv *.o *~ core .depend .*.cmd *.mod.c *.mod .tmp_versions Module* modules*

<span class="token target symbol">modules_install</span><span class="token punctuation">:</span>
	<span class="token variable">$</span><span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> -C <span class="token variable">$</span><span class="token punctuation">(</span>KERNELDIR<span class="token punctuation">)</span> M<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PWD<span class="token punctuation">)</span> modules_install

<span class="token target symbol">clean</span><span class="token punctuation">:</span>
	rm -rfv *.o *~ core .depend .*.cmd *.ko *.mod.c *.mod .tmp_versions Module* modules*
	rm -rfv test_write test_read

<span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> modules modules_install clean

<span class="token keyword">else</span>
	obj-m <span class="token operator">+=</span> hello.o

<span class="token keyword">endif</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>运行结果</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202407261121735.png" alt="image-20240726112136526"></p>
<h3 id="4-4-Linux内核非阻塞IO"><a href="#4-4-Linux内核非阻塞IO" class="headerlink" title="4.4 Linux内核非阻塞IO"></a>4.4 Linux内核非阻塞IO</h3><h4 id="1-非阻塞IO概念"><a href="#1-非阻塞IO概念" class="headerlink" title="1.非阻塞IO概念"></a>1.非阻塞IO概念</h4><p><strong>非阻塞操作</strong> 指进程在不能进行设备操作时并不睡眠而是立刻返回结果</p>
<p>设置非阻塞属性 <code>O_NONBLOCK</code><br>应用层打开文件时，要设置一个属性</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/he11o"</span><span class="token punctuation">,</span>O_RDWR <span class="token operator">|</span> O_NONBLOCK <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>应用层会把宏的值赋值给file结构体的成员<code>f_flags</code><br>要在驱动中，判断这个标志位</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span><span class="token punctuation">(</span>filep <span class="token operator">-&gt;</span>f_flags <span class="token operator">&amp;</span> O_NONBLOCK<span class="token punctuation">)</span>	<span class="token keyword">return</span> <span class="token operator">-</span>EAGAIN<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h4 id="2-实例14-非阻塞I0"><a href="#2-实例14-非阻塞I0" class="headerlink" title="2.实例14 非阻塞I0"></a>2.实例14 非阻塞I0</h4><p>使用<code>O_NONBLOCK</code>实现设备读非阻塞<br>源文件</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*hello.c*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/uaccess.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/ioctl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/spinlock.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/semaphore.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/atomic.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mutex.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/wait.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/sched.h&gt;</span></span>

<span class="token keyword">int</span> hello_major <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_BUF_COUNT</span> <span class="token expression"><span class="token number">128</span></span></span>
<span class="token keyword">char</span> dribuf<span class="token punctuation">[</span>MAX_BUF_COUNT<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">atomic_t</span> v<span class="token punctuation">;</span>					  <span class="token comment">// 原子变量</span>
<span class="token class-name">spinlock_t</span> lock<span class="token punctuation">;</span>			  <span class="token comment">// 自旋锁</span>
<span class="token keyword">struct</span> <span class="token class-name">semaphore</span> sem<span class="token punctuation">;</span>		  <span class="token comment">// 信号量</span>
<span class="token keyword">struct</span> <span class="token class-name">mutex</span> mutex<span class="token punctuation">;</span>			  <span class="token comment">// 互斥锁</span>
<span class="token class-name">wait_queue_head_t</span> wait_queue<span class="token punctuation">;</span> <span class="token comment">// 等待队列的头</span>

<span class="token comment">// 设置一个标志位，表示设备的使用情况</span>
<span class="token comment">// busy_flag == 0:not busy</span>
<span class="token comment">// busy_flag &gt; 0:busy</span>
<span class="token keyword">int</span> busy_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> dribuf_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>		<span class="token comment">//表示dribuf中的字节数，dribuf_len==0 ，表示没数据</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">hello_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"hello_driver打开成功!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">hello_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"hello_driver关闭成功!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">hello_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token class-name">ssize_t</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>dribuf_len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

		<span class="token keyword">if</span><span class="token punctuation">(</span>filp<span class="token operator">-&gt;</span>f_flags <span class="token operator">&amp;</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">// 判断应用程序是否使用了O_NONBLOCK 标志</span>
			<span class="token keyword">return</span> <span class="token operator">-</span>EAGAIN<span class="token punctuation">;</span> <span class="token comment">// 非阻塞模式下，如果驱动中没有数据，则返回-EAGAIN</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// dribuf_len == 0 表示驱动中没有数据</span>
		<span class="token comment">// dribuf_len != 0 表示驱动中有数据</span>
		<span class="token comment">// 此时 (dribuf_len != 0) 条件为假,wait_event interruptible 进入睡眠状态，造成进程读阻塞</span>
		<span class="token comment">// 有讲程向驱动中写入了数据，此时dribuf_len != 0  (dribuf len != 0)条件为真，函数返回</span>
		<span class="token function">wait_event_interruptible</span><span class="token punctuation">(</span>wait_queue<span class="token punctuation">,</span> <span class="token punctuation">(</span>dribuf_len<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span>count <span class="token operator">&gt;</span> dribuf_len<span class="token punctuation">)</span><span class="token punctuation">{</span>
		count <span class="token operator">=</span> dribuf_len<span class="token punctuation">;</span>
		<span class="token comment">// count =  strlen(dribuf);			//有错</span>
	<span class="token punctuation">}</span>
	<span class="token function">down_interruptible</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">// 睡眠时可以中断  P操作，信号量的值减1</span>
	ret <span class="token operator">=</span> <span class="token function">copy_to_user</span><span class="token punctuation">(</span>usrbuf<span class="token punctuation">,</span> dribuf<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"错误：应用程序读取驱动内的数据失败\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"应用程序读取驱动内的数据成功, 读取了%ld bytes\n"</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>						<span class="token comment">// 释放信号量 V操作，信号量的值加1</span>
	dribuf_len <span class="token operator">-=</span> count<span class="token punctuation">;</span>			<span class="token comment">// 驱动减少的字节数</span>
	ret <span class="token operator">=</span> count<span class="token punctuation">;</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">hello_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>usrbuf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token class-name">ssize_t</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>count <span class="token operator">&gt;</span> MAX_BUF_COUNT<span class="token punctuation">)</span><span class="token punctuation">{</span>
		count <span class="token operator">=</span> MAX_BUF_COUNT<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">down_interruptible</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">// 睡眠时可以中断  P操作，信号量的值减1</span>
	ret <span class="token operator">=</span> <span class="token function">copy_from_user</span><span class="token punctuation">(</span>dribuf<span class="token punctuation">,</span> usrbuf<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"错误：应用程序写给驱动数据失败\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"应用程序写给驱动数据成功, 用户把数据写进驱动程序了，写了%ld bytes\n"</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>						<span class="token comment">// 释放信号量 V操作，信号量的值加1</span>
	dribuf_len <span class="token operator">=</span> count<span class="token punctuation">;</span>				<span class="token comment">// 应用数据写给驱动的数据量</span>
	<span class="token function">wake_up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wait_queue<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	ret <span class="token operator">=</span> count<span class="token punctuation">;</span>

	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">hello_unlocked_ioctl</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">long</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token class-name">cdev</span> cdev <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE <span class="token comment">// 表示的是指向本模块的指针</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">file_operations</span> hello_fops <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>open <span class="token operator">=</span> hello_open<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>release <span class="token operator">=</span> hello_release<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>read <span class="token operator">=</span> hello_read<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>write <span class="token operator">=</span> hello_write<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>unlocked_ioctl <span class="token operator">=</span> hello_unlocked_ioctl<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">hello_int</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>
	ret <span class="token operator">=</span> <span class="token function">register_chrdev</span><span class="token punctuation">(</span>hello_major<span class="token punctuation">,</span> <span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>hello_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"错误：注册字符设备失败\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">atomic_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	   <span class="token comment">// 初始化原子变量为0,表示没有资源有效</span>
	<span class="token function">spin_lock_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化自旋锁,初始化后锁的状态是开的</span>
	<span class="token function">sema_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sem<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>	<span class="token comment">// 初始化信号量，初始化后信号量的状态是1</span>
	<span class="token function">init_waitqueue_head</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wait_queue<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"hello_driver installed sucessed!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">hello_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">unregister_chrdev</span><span class="token punctuation">(</span>hello_major<span class="token punctuation">,</span> <span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"hello_driver uninstall sucessed!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>hello_int<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 宏函数做关联</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>hello_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * 设置模块的许可协议。
 * 设置模块的作者信息。
 * 设置模块的描述信息。
 */</span>
<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"Dual BSD/GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"GeYangwen"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_DESCRIPTION</span><span class="token punctuation">(</span><span class="token string">"A simple Hello world module"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*test_read.c*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h&gt;</span>	</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_BUF_COUNT</span> <span class="token expression"><span class="token number">128</span></span></span>
<span class="token keyword">char</span> buf<span class="token punctuation">[</span>MAX_BUF_COUNT<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/hello"</span><span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fd = %d\n"</span><span class="token punctuation">,</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> MAX_BUF_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"read %d bytes, data = %s\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// getchar();</span>

    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*test_write.c*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h&gt;</span>	</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_BUF_COUNT</span> <span class="token expression"><span class="token number">128</span></span></span>
<span class="token keyword">char</span> buf<span class="token punctuation">[</span>MAX_BUF_COUNT<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/hello"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fd = %d\n"</span><span class="token punctuation">,</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// memset(buf, 0, MAX_BUF_COUNT);                           //清空buf内的东西</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"hello world\0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"write"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MAX_BUF_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span>                          <span class="token comment">//清空buf内的东西</span>

    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>







<p>运行结果</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@ubuntu:/home/linux/work/14-nonblocking<span class="token comment"># ./test_read </span>
fd <span class="token operator">=</span> <span class="token number">3</span>
read: Resource temporarily unavailable
root@ubuntu:/home/linux/work/14-nonblocking<span class="token comment"># ./test_write </span>
fd <span class="token operator">=</span> <span class="token number">3</span>
root@ubuntu:/home/linux/work/14-nonblocking<span class="token comment"># ./test_read </span>
fd <span class="token operator">=</span> <span class="token number">3</span>
<span class="token builtin class-name">read</span> <span class="token number">11</span> bytes, data <span class="token operator">=</span> hello world
root@ubuntu:/home/linux/work/14-nonblocking<span class="token comment"># rmmod hello</span>
root@ubuntu:/home/linux/work/14-nonblocking<span class="token comment"># dmesg </span>
<span class="token punctuation">[</span> <span class="token number">9516.139380</span><span class="token punctuation">]</span> hello_driver installed sucessed<span class="token operator">!</span>
<span class="token punctuation">[</span> <span class="token number">9523.698601</span><span class="token punctuation">]</span> hello_driver打开成功<span class="token operator">!</span>
<span class="token punctuation">[</span> <span class="token number">9523.698742</span><span class="token punctuation">]</span> hello_driver关闭成功<span class="token operator">!</span>
<span class="token punctuation">[</span> <span class="token number">9529.340597</span><span class="token punctuation">]</span> hello_driver打开成功<span class="token operator">!</span>
<span class="token punctuation">[</span> <span class="token number">9529.340679</span><span class="token punctuation">]</span> 应用程序写给驱动数据成功, 用户把数据写进驱动程序了，写了11 bytes
<span class="token punctuation">[</span> <span class="token number">9529.340681</span><span class="token punctuation">]</span> hello_driver关闭成功<span class="token operator">!</span>
<span class="token punctuation">[</span> <span class="token number">9532.396614</span><span class="token punctuation">]</span> hello_driver打开成功<span class="token operator">!</span>
<span class="token punctuation">[</span> <span class="token number">9532.396695</span><span class="token punctuation">]</span> 应用程序读取驱动内的数据成功, 读取了11 bytes
<span class="token punctuation">[</span> <span class="token number">9532.396699</span><span class="token punctuation">]</span> hello_driver关闭成功<span class="token operator">!</span>
<span class="token punctuation">[</span> <span class="token number">9539.604237</span><span class="token punctuation">]</span> hello_driver uninstall sucessed<span class="token operator">!</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="4-5-Linux内核的多路复用IO"><a href="#4-5-Linux内核的多路复用IO" class="headerlink" title="4.5 Linux内核的多路复用IO"></a>4.5 Linux内核的多路复用IO</h3><h4 id="1多路复用IO概念"><a href="#1多路复用IO概念" class="headerlink" title="1多路复用IO概念"></a>1多路复用IO概念</h4><p>在 Linux 内核中，多路复用(Multiplexing)是一种机制，允许进程同时监视和等待多个文件描述符的事件。它是实现高效IO的关键技<br>术之一，常见的多路复用机制有select、poll、epoll。</p>
<ol>
<li>select :<br> seect 是最古老的多路复用机制之一，在早期UNIX系统上广泛使用。它使用三个位图参数来表示要监视的文件描述符集合，并等<br> 待其中任意一个文件描述符就绪。但<code>select</code>存在一些性能问题，它需要遍历整个文件描述符集合以找到就绪的文件描述符。</li>
<li>poll :<br> poll是对 <code>select</code> 的改进，它使用一个包含文件描述符和事件的结构体数组来表示要监视的文件描述符集合，并等待其中任意一人<br> 文件描述符就绪。相比于 <code>select</code> ，<code>poll</code>不需要遍历整个文件描述符集合，因此性能更好。</li>
<li>epoll :<br> <code>epoll</code> 是 Linux 内核提供的高性能多路复用机制。与 <code>select</code> 和 <code>poll</code>不的是，<code>epoll</code>中的文件描述符集合是由内核来管理的<br> 而不是用户空间。这使得 <code>epoll</code> 在大规模并发场景下具有更高的性能和可扩展性</li>
</ol>
<h4 id="2-应用层的select"><a href="#2-应用层的select" class="headerlink" title="2.应用层的select"></a>2.应用层的<code>select</code></h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// sizeof(fd_set) = 128 1024</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/select.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token keyword">int</span> nfds<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>readfds<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>writefds<span class="token punctuation">,</span>fd_set <span class="token operator">*</span>exceptfds<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">timeval</span> <span class="token operator">*</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">-</span> 参数：
        <span class="token operator">-</span> nfds <span class="token operator">:</span> 委托内核检测的最大文件描述符的值 <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token operator">-</span> readfds <span class="token operator">:</span> 要检测的文件描述符的读的集合，委托内核检测哪些文件描述符的读的属性
            <span class="token operator">-</span> 一般检测读操作
            <span class="token operator">-</span> 对应的是对方发送过来的数据，因为读是被动的接收数据，检测的就是读缓冲区
            <span class="token operator">-</span> 是一个传入传出参数
        <span class="token operator">-</span> writefds <span class="token operator">:</span> 要检测的文件描述符的写的集合，委托内核检测哪些文件描述符的写的属性
        	<span class="token operator">-</span> 委托内核检测写缓冲区是不是还可以写数据（写缓冲区不满的就可以写）
        <span class="token operator">-</span> exceptfds <span class="token operator">:</span> 检测发生异常的文件描述符的集合
        <span class="token operator">-</span> timeout <span class="token operator">:</span> 设置的超时时间
            <span class="token keyword">struct</span> <span class="token class-name">timeval</span> <span class="token punctuation">{</span>
                <span class="token keyword">long</span> tv_sec<span class="token punctuation">;</span> <span class="token comment">/* seconds */</span>
                <span class="token keyword">long</span> tv_usec<span class="token punctuation">;</span> <span class="token comment">/* microseconds */</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token operator">-</span> <span class="token constant">NULL</span> <span class="token operator">:</span> 永久阻塞，直到检测到了文件描述符有变化
            <span class="token operator">-</span> tv_sec <span class="token operator">=</span> <span class="token number">0</span> tv_usec <span class="token operator">=</span> <span class="token number">0</span>， 不阻塞
            <span class="token operator">-</span> tv_sec <span class="token operator">&gt;</span> <span class="token number">0</span> tv_usec <span class="token operator">&gt;</span> <span class="token number">0</span>， 阻塞对应的时间
                
        <span class="token operator">-</span> 返回值 <span class="token operator">:</span>
            <span class="token operator">-</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">:</span> 失败
            <span class="token operator">-</span> <span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">:</span> 检测的集合中有n个文件描述符发生了变化
                
<span class="token comment">// 将参数文件描述符fd对应的标志位设置为0</span>
<span class="token keyword">void</span> <span class="token function">FD_CLR</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 判断fd对应的标志位是0还是1， 返回值 ： fd对应的标志位的值，0返回0， 1返回1</span>
<span class="token keyword">int</span> <span class="token function">FD_ISSET</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 将参数文件描述符fd 对应的标志位，设置为1</span>
<span class="token keyword">void</span> <span class="token function">FD_SET</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// fd_set一共有1024 bit, 全部初始化为0</span>
<span class="token keyword">void</span> <span class="token function">FD_ZERO</span><span class="token punctuation">(</span>fd_set <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="3-驱动层调用poll函数"><a href="#3-驱动层调用poll函数" class="headerlink" title="3.驱动层调用poll函数"></a>3.驱动层调用poll函数</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">xxx_poll</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> poll_table <span class="token operator">*</span>pollt<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> mask <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">poll_wait</span><span class="token punctuation">(</span>filp，<span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>r_wait，pollt<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//加读等待队列头</span>
    <span class="token function">poll_wait</span><span class="token punctuation">(</span>filp，<span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>w_wait，pollt<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//加写等待队列头</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//可读</span>
    	mask<span class="token operator">|=</span> POLLIN POLLRDNORM<span class="token punctuation">;</span> <span class="token comment">/*标示数据可获得*/</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//可写</span>
    	mask<span class="token operator">|=</span> POLLOUT POLLWRNORM<span class="token punctuation">;</span> <span class="token operator">/</span>标示数据可写入<span class="token operator">*</span><span class="token operator">/</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> mask<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>例如:</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">mypoll</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filep<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">poll_table_struct</span> <span class="token operator">*</span> pollt<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> mask <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">po11_wait</span><span class="token punctuation">(</span>filep<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wq<span class="token punctuation">,</span> pollt<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 把等待队列加入到可读的轮寻表中去</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// buffer 内是有数据可读</span>
        mask <span class="token operator">|=</span> POLLIN <span class="token operator">|</span> POLLRDNORM<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    <span class="token keyword">return</span> mask<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="4-poll-wait-函数的功能"><a href="#4-poll-wait-函数的功能" class="headerlink" title="4.poll_wait 函数的功能"></a>4.<code>poll_wait</code> 函数的功能</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/poll.h&gt;</span></span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">poll_wait</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span> filp<span class="token punctuation">,</span> <span class="token class-name">wait_queue_head_t</span> <span class="token operator">*</span> wait_address<span class="token punctuation">,</span> poll_table <span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>把等待队列加入到监控集合中去</p>
<h3 id="4-6-Linux内核信号驱动的I-x2F-0"><a href="#4-6-Linux内核信号驱动的I-x2F-0" class="headerlink" title="4.6 Linux内核信号驱动的I/0"></a>4.6 Linux内核信号驱动的I/0</h3><h4 id="1-信号驱动I-x2F-O概念"><a href="#1-信号驱动I-x2F-O概念" class="headerlink" title="1.信号驱动I/O概念"></a>1.信号驱动I/O概念</h4><p>异步通知的意思是:一旦设备就绪，则主动通知应用程序，这样应用程序根本就不需要查询设备状态，这一点非常类似于硬件上中断的概<br>念，比较准确的称谓是信号驱动的异步IO</p>
<p>包含头文件</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>。异步队列定义</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">fasync_struct</span><span class="token punctuation">{</span>
    <span class="token class-name">spinlock_t</span> fa_lock<span class="token punctuation">;</span>
    <span class="token keyword">int</span> magic<span class="token punctuation">;</span>
	<span class="token keyword">int</span>	fa_fd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">fasync_struct</span> <span class="token operator">*</span>fa_next<span class="token punctuation">;</span> 		<span class="token comment">/* singly linked list */</span>
    <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>fa_file<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">rcu_head</span> fa_rcu<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>。定义一个异步队列的指针</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">fasync_struct</span> <span class="token operator">*</span>async_queue<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="2-生成异步队列-fasync-helper"><a href="#2-生成异步队列-fasync-helper" class="headerlink" title="2.生成异步队列 fasync_helper"></a>2.生成异步队列 <code>fasync_helper</code></h4><p>函数原型</p>
<pre class="line-numbers language-none"><code class="language-none">int fasync_helper(int fd, struct file * filp, int on, struct fasync_struct **fapp)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li><p>函数功能</p>
<ul>
<li>用于帮助实现异步通知机制。它在文件描述符上注册/取消异步通知，并在异步事件发生时触发相应的操作.</li>
</ul>
</li>
<li><p>函数参数</p>
<ul>
<li><p>fd :文件表述符，应用程序传递</p>
</li>
<li><p>filep: 指向file结构体的指针</p>
</li>
<li><p>on:</p>
<ul>
<li>为真时,表示要安装这个异步队列</li>
<li>为假时,表示要卸载这个异步队列</li>
</ul>
</li>
<li><p>fapp: 异步队列的指针的地址 ，传递一级指针的地址。</p>
</li>
</ul>
</li>
<li><p>函数返回值:</p>
<ul>
<li>成功返回:0</li>
<li>失败返回 : 负的错误码</li>
</ul>
</li>
</ul>
<h4 id="3-发送信号-kill-fasync"><a href="#3-发送信号-kill-fasync" class="headerlink" title="3.发送信号 kill_fasync()"></a>3.发送信号 <code>kill_fasync()</code></h4><p>函数原型</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">kill_fasync</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">fasync_struct</span> <span class="token operator">*</span><span class="token operator">*</span>fp<span class="token punctuation">,</span> <span class="token keyword">int</span> sig<span class="token punctuation">,</span> <span class="token keyword">int</span> band<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>函数功能<ul>
<li>资源可以获得时发送信号</li>
</ul>
</li>
<li>函数参数<ul>
<li>fp: 异步队列的指针，一级指针地址</li>
<li>sig:发送的型号， 这个信号是 <code>SIGIO</code></li>
<li>band :<ul>
<li>POLL_IN</li>
<li>POLL_OUT</li>
</ul>
</li>
</ul>
</li>
<li>函数返回值: 无</li>
</ul>
<p>例如:</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">kill_fasync</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>async_queue<span class="token punctuation">,</span>SIGIO<span class="token punctuation">,</span>POLL_IN<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="4-实现信号驱动IO流程"><a href="#4-实现信号驱动IO流程" class="headerlink" title="4.实现信号驱动IO流程"></a>4.实现信号驱动IO流程</h4><p>1.应用程序要设置信号捕捉函数</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"num = %d n"</span><span class="token punctuation">,</span>num<span class="token punctuation">)</span> <span class="token punctuation">;</span>
    <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"buf=%s\n"</span><span class="token punctuation">,</span>buf<span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">signal</span><span class="token punctuation">(</span>SIGIO<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>2.对file结构体的成员<code>f_owner</code>赋值，把<code>file</code>结构体的<code>f_owner</code>与pid进行捆绑</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">
<span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>F_SETOWN<span class="token punctuation">,</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 	<span class="token comment">// f_owner = getpid();</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>3.应用程序调用fcntl函数，设置FASYNC标志，在驱动中生成异步队列</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> flag <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>F_GETFL<span class="token punctuation">)</span><span class="token punctuation">;</span>
flag <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>F_SETFL <span class="token punctuation">,</span>flag<span class="token operator">|</span>FASYNC<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//启用异步标志</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>驱动会调用一次<code>fasync</code><br>4.驱动中会调用 <code>fasync</code>，在驱动<code>fasync</code>函数中，生成一个异步队列</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">myfasync</span> <span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filep<span class="token punctuation">,</span> <span class="token keyword">int</span> on<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"fd = %d\n"</span><span class="token punctuation">,</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"on = %d\n"</span><span class="token punctuation">,</span>on<span class="token punctuation">)</span> <span class="token punctuation">;</span>
    <span class="token function">fasync_helper</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>filep <span class="token punctuation">,</span>on <span class="token punctuation">,</span><span class="token operator">&amp;</span>async_queue<span class="token punctuation">)</span> <span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>5.等待资源可以获得是发送信号</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">kill_fasync</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>async_queue<span class="token punctuation">,</span>SIGIO<span class="token punctuation">,</span>POLL_IN<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="5-实例16——信号驱动异步IO"><a href="#5-实例16——信号驱动异步IO" class="headerlink" title="5.实例16——信号驱动异步IO"></a>5.实例16——信号驱动异步IO</h4><p>使用<code>kill_fasync</code>实现设备的信号驱动IO</p>
<p>源文件</p>
<h2 id="第05章-Linux内核的中断机制"><a href="#第05章-Linux内核的中断机制" class="headerlink" title="第05章 Linux内核的中断机制"></a>第05章 Linux内核的中断机制</h2><h3 id="5-1-Linux内核中断系统"><a href="#5-1-Linux内核中断系统" class="headerlink" title="5.1 Linux内核中断系统"></a>5.1 Linux内核中断系统</h3><h4 id="1-中断概述"><a href="#1-中断概述" class="headerlink" title="1.中断概述"></a>1.中断概述</h4><p>中断是指在CPU正常运行期间，由于内外部事件或由程序预先安排的事件引起的CPU暂时停止正在运行的程序，转而为该内部或外部事件或预先安排的事件服务的程序中去，服务完毕后再返回去继续运行被暂时中断的程序。</p>
<h4 id="2-Linux中断类型"><a href="#2-Linux中断类型" class="headerlink" title="2.Linux中断类型"></a>2.Linux中断类型</h4><p>Linux 中断系统支持多种不同类型的中断，其中包括</p>
<ol>
<li>IRQ 中断:最常见的中断类型，用于处理硬件设备产生的中断请求。IRQ 中断被广泛应用于各种设备，例如网络卡、键盘、鼠标等，</li>
<li>NMI 中断:非屏蔽中断，通常用于处理硬件故和系统异常情况。与RQ 中断不同，NMI 中断无法被蔽或禁止。</li>
<li>软中断:由软件产生的中断事件，通常用于在内核空间中触发一个函数或任务。软中断是一种快速目可靠的方式，用于在内核空间中<br>执行某些操作，例如更新内核状态、清除缓存等。</li>
<li>时钟中断:由硬件定时器产生的中断事件，用于实现时间片轮转和调度等功能。时钟中断是操作系统中最重要的中断之一，它能够保<br>证系统的时间精度、稳定性和可靠性。</li>
<li>系统调用:也称为软中断，用于触发用户空间程序和内核空间之间的交互，系统调用通常是通过软中断指令实现的.</li>
<li>异常中断:由 CPU 发生的异常事件，例如除零、页错误、非法指令等。通常会导致系统崩溃或进入死循环，需要谨慎处理.</li>
</ol>
<h4 id="3-Linux中断数据处理结构"><a href="#3-Linux中断数据处理结构" class="headerlink" title="3.Linux中断数据处理结构"></a>3.Linux中断数据处理结构</h4><p>中断处理流程图</p>
<p><img src="./images/loading.gif" data-original="https://geyangwen-images.oss-cn-hangzhou.aliyuncs.com/2024/Android/202407261648083.png" alt="image-20240726164845970"></p>
<p>Linux 中断数据处理的结构主要由以下几个组成部分:</p>
<ol>
<li><p>中断描述符表(interrupt Descriptor Table，IDT): DT 是一个存储中断向量和中断门描述符的表。每个中断都有一个唯一的中断向量，用于标识该中断。中断向量是一个索引值，用于在DT 中查找相应的中断门描述符。中断门描述符包含了中断服务程序的入口地址、特权级别、中断类型等信息。</p>
<p>和stm32的中断向量表类似。</p>
</li>
<li><p>中断服务程序(lnterrupt Service Routine，ISR): 中断服务程序是用于处理特定中断的函数或代码块。当系统发生中断时，CPU 会根据中断向量从IDT 中获取对应的中断门描述符，并跳转到中断服务程序的入口地址执行。中断服务程序负责处理中断事件，例如遗取设备状态、更新数据、发送通知等。</p>
</li>
<li><p>中断控制器(lnterrupt (ontroller) : 中断控制器是硬件设备，用于管理和分发中断请求。它可以处理来自多个设备的中断请求，并将其传递给 CPU，在Linux中，常见的中断控制器包括 GIC Generic lnterrupt Controller) 和APIC (Advanced Programmable Interrupt Controller)</p>
</li>
<li><p>中断外理程序(lnterrupt Handler) :中新外理程房是内核中用于外理中断的代码。它负责协调和管理中断事件的处理过程。当中事件发生时，中断处理程序会进行必要的初始化和上下文切换，并调用相应的中断服务程序来处理中断事件。</p>
</li>
<li><p>中断上下文 (lnterrut ontext) :中断上下文是指在中新事件发生时，CPU 保存的当前执行现场和寄存器值。中断处理程序需要使用中断上下文来恢复中断前的执行状态，并在中断处理完成后正确返回到中断发生的地方。</p>
</li>
</ol>
<h3 id="5-2-Linux内核中断接口函数"><a href="#5-2-Linux内核中断接口函数" class="headerlink" title="5.2 Linux内核中断接口函数"></a>5.2 Linux内核中断接口函数</h3><h4 id="1-request-irq-注册IRQ号"><a href="#1-request-irq-注册IRQ号" class="headerlink" title="1.request_irq 注册IRQ号"></a>1.request_irq 注册IRQ号</h4><p>函数原型</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">inc</span><span class="token expression">Tude<span class="token operator">&lt;</span>linux<span class="token operator">/</span>interrupt<span class="token punctuation">.</span>h<span class="token operator">&gt;</span></span></span>
<span class="token keyword">typedef</span> <span class="token class-name">irgreturn_t</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token class-name">irq_handler_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">int</span> __must_check <span class="token function">request_irg</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> irq<span class="token punctuation">,</span> <span class="token class-name">irq_handler_t</span> handler<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name，<span class="token keyword">void</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>函数功能</p>
<ul>
<li>向内核注册一个irq中断号</li>
</ul>
</li>
<li><p>函数参数</p>
<ul>
<li><p>irg: 要申请的中断号</p>
</li>
<li><p>handler: 中断理函数</p>
</li>
<li><p>flags: 中断的标志位</p>
<ul>
<li><p>中断触发方式</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRQF_TRIGGER_NONE</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRQF_TRIGGER_RISING</span> <span class="token expression"><span class="token number">0x0000001</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRQF_TRIGGER_FALLING</span> <span class="token expression"><span class="token number">0x00000002</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRQF_TRIGGER_HIGH</span> <span class="token expression"><span class="token number">0x00000004</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRQF_TRIGGER_LOW</span> <span class="token expression"><span class="token number">0x00000008</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>中断标志</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRQF_SHARED</span>			<span class="token expression"><span class="token number">0x00000080</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRQF_PROBE_SHARED</span>	<span class="token expression"><span class="token number">0x00000100</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span><span class="token expression">_IRQF_TIMER			<span class="token number">0x00000200</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRQF_PERCPU</span>			<span class="token expression"><span class="token number">0x00000400</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRQF_NOBALANCING</span>	<span class="token expression"><span class="token number">0x00000800</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRQF_IRQPOLL</span>		<span class="token expression"><span class="token number">0x00001000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRQF_ONESHOT</span>		<span class="token expression"><span class="token number">0x00002000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRQF_NO_SUISPEND</span>	<span class="token expression"><span class="token number">0x00004000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRQF_FORCE_RESUME</span>	<span class="token expression"><span class="token number">0x00008000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRQF_NO_THREAD</span>		<span class="token expression"><span class="token number">0x00010000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRQF_EARLY_RESUME</span>	<span class="token expression"><span class="token number">0x00020000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRQF_COND_SUSPEND</span>	<span class="token expression"><span class="token number">0x00040000</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>​	name: 中断号的名称，和设备号类似。</p>
<ul>
<li>dev : 给中断函数传递参数</li>
</ul>
</li>
<li><p>函数返回值<br>成功返回 0</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="2-free-irq-释放IRQ号"><a href="#2-free-irq-释放IRQ号" class="headerlink" title="2.free_irq 释放IRQ号"></a>2.free_irq 释放IRQ号</h4><p>函数原型</p>
<pre class="line-numbers language-none"><code class="language-none">#include&lt;Tinux/interrupt.h&gt;
const void *free_irq(unsigned int irq，void * devid);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>函数功能<ul>
<li>从内核中注销一个irq中断号。</li>
</ul>
</li>
<li>函数参数<ul>
<li>irq: 要注销的中断号</li>
<li>devid :<br>如果是共享中断，需要传递共享中断的参数<br>如果不是共享中断，这里传参为NULL即可.</li>
</ul>
</li>
<li>函数返回值:<ul>
<li>无返回值</li>
</ul>
</li>
</ul>
<p>注:IRQ线资源非常宝贵，我们在使用时必须先注册，不使用时必须释放IRQ资源</p>
<h4 id="3-查看系统的中断号"><a href="#3-查看系统的中断号" class="headerlink" title="3.查看系统的中断号"></a>3.查看系统的中断号</h4><pre class="line-numbers language-none"><code class="language-none">cat /proc/interrupts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>例如:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">         CPU0       CPU1       CPU2       CPU3       
 <span class="token number">0</span>:          <span class="token number">6</span>          <span class="token number">0</span>          <span class="token number">0</span>          <span class="token number">0</span>   IO-APIC    <span class="token number">2</span>-edge      timer
 <span class="token number">1</span>:         <span class="token number">37</span>          <span class="token number">0</span>          <span class="token number">0</span>          <span class="token number">0</span>   IO-APIC    <span class="token number">1</span>-edge      i8042
 <span class="token number">8</span>:          <span class="token number">0</span>          <span class="token number">1</span>          <span class="token number">0</span>          <span class="token number">0</span>   IO-APIC    <span class="token number">8</span>-edge      rtc0
 <span class="token number">9</span>:          <span class="token number">0</span>          <span class="token number">0</span>          <span class="token number">0</span>          <span class="token number">0</span>   IO-APIC    <span class="token number">9</span>-fasteoi   acpi
<span class="token number">12</span>:       <span class="token number">1436</span>          <span class="token number">0</span>          <span class="token number">0</span>         <span class="token number">16</span>   IO-APIC   <span class="token number">12</span>-edge      i8042
<span class="token number">14</span>:          <span class="token number">0</span>          <span class="token number">0</span>          <span class="token number">0</span>          <span class="token number">0</span>   IO-APIC   <span class="token number">14</span>-edge      ata_piix
<span class="token number">15</span>:          <span class="token number">0</span>          <span class="token number">0</span>          <span class="token number">0</span>          <span class="token number">0</span>   IO-APIC   <span class="token number">15</span>-edge      ata_piix
<span class="token number">16</span>:          <span class="token number">0</span>       <span class="token number">1693</span>          <span class="token number">0</span>        <span class="token number">233</span>   IO-APIC   <span class="token number">16</span>-fasteoi   vmwgfx, snd_ens1371
<span class="token number">17</span>:      <span class="token number">50329</span>          <span class="token number">0</span>          <span class="token number">0</span>          <span class="token number">0</span>   IO-APIC   <span class="token number">17</span>-fasteoi   ehci_hcd:usb1, ioc0
<span class="token number">18</span>:          <span class="token number">0</span>         <span class="token number">43</span>          <span class="token number">0</span>          <span class="token number">0</span>   IO-APIC   <span class="token number">18</span>-fasteoi   uhci_hcd:usb2
<span class="token number">19</span>:          <span class="token number">0</span>          <span class="token number">0</span>        <span class="token number">141</span>     <span class="token number">363744</span>   IO-APIC   <span class="token number">19</span>-fasteoi   ens33
<span class="token number">24</span>:          <span class="token number">0</span>          <span class="token number">0</span>          <span class="token number">0</span>          <span class="token number">0</span>   PCI-MSI <span class="token number">344064</span>-edge      PCIe PME, pciehp
<span class="token number">25</span>:          <span class="token number">0</span>          <span class="token number">0</span>          <span class="token number">0</span>          <span class="token number">0</span>   PCI-MSI <span class="token number">346112</span>-edge      PCIe PME, pciehp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="4-中断使能与禁止"><a href="#4-中断使能与禁止" class="headerlink" title="4.中断使能与禁止"></a>4.中断使能与禁止</h4><p>激活当前CPU中断</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">local_irq_enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>。禁止当前CPU中断</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">local_irq_disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>激活指定中断线</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">enable_irq</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> irq<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>禁止指定中断线</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">disable_irg</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> irg<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h4 id="5-中断处理函数的注意事项"><a href="#5-中断处理函数的注意事项" class="headerlink" title="5.中断处理函数的注意事项"></a>5.中断处理函数的注意事项</h4><ul>
<li>cpu在向量响应irg中断时，默认不在响应系统的其他中断，因此中断响应必须快</li>
<li>中断处理函数中不能调用引起睡眠的函数，例如: read，accept，connect。</li>
<li>中断处理函数中不能调用 和用户空间交换数据的函数(copy_from_user/copy_to_user)，耗时时间久。</li>
<li>不能调用schedule()，会引发系统的调度，让任务刷新，可能会让进程挂载</li>
<li>实现中断处理有一个原则，就是尽可能快地处理并返回。</li>
</ul>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">葛杨文</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://gitee.com/ge-yangwen/geyangwen.gitee.io/2024/071558324.html">https://gitee.com/ge-yangwen/geyangwen.gitee.io/2024/071558324.html</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">葛杨文</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Android%E9%A9%B1%E5%8A%A8/">
                                    <span class="chip bg-color">Android驱动</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="./images/loading.gif" data-original="https://blog-accelerated.oss-cn-hangzhou.aliyuncs.com/source/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="./images/loading.gif" data-original="https://blog-accelerated.oss-cn-hangzhou.aliyuncs.com/source/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: '2GHAwHTGn8XLUAd7QB3o7e4c-gzGzoHsz',
        appKey: '4EmLXaoemlw5MQWjAC60IbU8',
        notify: '' === 'true',
        verify: '' === 'true',
        visitor: '' === 'true',
        avatar: 'monsterid',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '昵称填写qq可以显示qq头像和昵称哦~'
    });
</script>

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2024/080957409.html">
                    <div class="card-image">
                        
                        
                        <img src="./images/loading.gif" data-original="https://blog-accelerated.oss-cn-hangzhou.aliyuncs.com/source/medias/featureimages/11.jpg" class="responsive-img" alt="Android驱动的系统笔记1">
                        
                        <span class="card-title">Android驱动的系统笔记1</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2024-08-09
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Android/" class="post-category">
                                    Android
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android%E9%A9%B1%E5%8A%A8/">
                        <span class="chip bg-color">Android驱动</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2024/041355771.html">
                    <div class="card-image">
                        
                        
                        <img src="./images/loading.gif" data-original="https://blog-accelerated.oss-cn-hangzhou.aliyuncs.com/source/medias/featureimages/2.jpg" class="responsive-img" alt="Arduino学习笔记">
                        
                        <span class="card-title">Arduino学习笔记</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2024-04-13
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Arduino/" class="post-category">
                                    Arduino
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Arduino/">
                        <span class="chip bg-color">Arduino</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h1,h2, h3, h4,h5'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1,h2, h3, h4,h5').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2022-2024</span>
            
            <span id="year">2022</span>
            <a href="/about" target="_blank">葛杨文</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">492.4k</span>&nbsp;字
            
            
            
            
            
            <!-- 修改不蒜子初始化计数 -->
                  
                <span id="busuanzi_container_site_pv" style='display:none'></span>
                    <i class="fa fa-heart-o"></i>
                    本站总访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>
            
            
            
            
                <span id="busuanzi_container_site_uv" style='display:none'></span>
                    人次,&nbsp;访客数 <span id="busuanzi_value_site_uv" class="white-color"></span> 人.
                
                                    
            <br>
            <!-- 增加建站时间（下面这句话） -->
            <span id="sitetime"></span>

            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/Geyangwen" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:3057318483@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=3057318483" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 3057318483" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







</div>
    </div>
</footer>

<div class="progress-bar"></div>

<!-- 增加建站时间 -->
<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */
        var t1 = Date.UTC(2022, 10, 25, 00, 00, 00); //北京时间2018-2-13 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "小破站已运行 " +diffYears+" 年 "+diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
    }/*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
</script>

<!-- 修改不蒜子初始化计数 -->
<script>
    $(document).ready(function () {

        var int = setInterval(fixCount, 50);  // 50ms周期检测函数
        var pvcountOffset = 80000;  // 初始化首次数据
        var uvcountOffset = 20000;

        function fixCount() {
            if (document.getElementById("busuanzi_container_site_pv").style.display != "none") {
                $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + pvcountOffset);
                clearInterval(int);
            }
            if ($("#busuanzi_container_site_pv").css("display") != "none") {
                $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + uvcountOffset); // 加上初始数据 
                clearInterval(int); // 停止检测
            }
        }
    });
</script>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    
        <!-- 添加死鬼你来了的小顽皮 -->
    <script type="text/javascript">
        var OriginTitile = document.title,
            st;
        document.addEventListener("visibilitychange", function () {
            document.hidden ? (document.title = "客官别走呀！", clearTimeout(st)) : (document.title =
                "(๑•̀ㅂ•́)死鬼你来了", st = setTimeout(function () {
                    document.title = OriginTitile
                }, 3e3))
        })
    </script>
    <!-- 樱花特效 -->
    <!-- <script type="text/javascript">
        //只在桌面版网页启用特效
        var windowWidth = $(window).width();
        if (windowWidth > 768) {
            document.write('<script type="text/javascript" src="/js/sakura.js"><\/script>');
        }
    </script> -->
    

    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="/libs/background/canvas-nest.js"></script>
    

    

    
    <script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async="async"></script>
    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    


        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(r){r.imageLazyLoadSetting.processImages=t;var e=r.imageLazyLoadSetting.isSPA,c=(r.imageLazyLoadSetting.preloadRatio,n());function n(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(){e&&(c=n());for(var t,o=0;o<c.length;o++)0<=(t=(t=c[o]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(r.innerHeight+240||document.documentElement.clientHeight+240)&&function(){var t,e,n,a,i=c[o];e=function(){c=c.filter(function(t){return i!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(i)},(t=i).hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(n=new Image,a=t.getAttribute("data-original"),n.onload=function(){t.src=a,t.removeAttribute("data-original"),e&&e()},t.src!==a&&(n.src=a))}()}function a(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",a),r.addEventListener("resize",a),r.addEventListener("orientationchange",a)}(this);</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/miku.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>

</html>
